npm warn Unknown project config "puppeteer_skip_download". This will stop working in the next major version of npm.

> ezbuildr@1.0.0 test
> cross-env VITEST_INTEGRATION=true vitest run --coverage


[1m[46m RUN [49m[22m [36mv4.0.16 [39m[90mC:/Users/scoot/poll/VaultLogic[39m
      [2mCoverage enabled with [22m[33mv8[39m

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w8
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w8,public

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w8 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w8%2Cpublic

{"level":30,"time":1768511791501,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w6
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w6,public

{"level":30,"time":1768511791544,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w6 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w6%2Cpublic

{"level":30,"time":1768511791554,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511791599,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w9
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w9,public

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w9 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w9%2Cpublic

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w8, public

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w6, public

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w8
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w6
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w140.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w140.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w140.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w140.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w9, public

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w10
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w10,public

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w9
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w10 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w10%2Cpublic

{"level":30,"time":1768511792110,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w11
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w11,public

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w6.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w8.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w6.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511792163,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w11 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w11%2Cpublic

{"level":30,"time":1768511792170,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w8.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511792221,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w13
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w13,public

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w12
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w12,public

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w13 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w13%2Cpublic

{"level":30,"time":1768511792469,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w12 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w12%2Cpublic

{"level":30,"time":1768511792483,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511792519,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w10, public

{"level":30,"time":1768511792537,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w11, public

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w10
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w11
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w9.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w9.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w9.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w9.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w13, public

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w12, public

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w13
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w12
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w10.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w11.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w10.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w10.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w11.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w10.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511792995,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768511792999,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w11.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511793005,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768511793013,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768511793014,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w11.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511793020,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768511793020,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w5
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w5,public

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w7
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w7,public

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w0
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0,public

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w4
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w4,public

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w3,public

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w1
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w1,public

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w2
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w2,public

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w5 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w5%2Cpublic

{"level":30,"time":1768511793542,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w7 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w7%2Cpublic

{"level":30,"time":1768511793553,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w0 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0%2Cpublic

{"level":30,"time":1768511793559,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w4 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w4%2Cpublic

{"level":30,"time":1768511793560,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w1 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w1%2Cpublic

{"level":30,"time":1768511793561,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w3 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w3%2Cpublic

{"level":30,"time":1768511793562,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w2 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w2%2Cpublic

{"level":30,"time":1768511793568,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511793571,"env":"test","workflowId":"260afe6d-16e3-49da-be88-03779a78c51a","userId":"0d911e46-2705-43c7-9c3d-efa2acbe1a0b","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":50,"time":1768511793583,"env":"test","module":"auth","err":{"type":"TypeError","message":"Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')","stack":"TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')\n    at getTableColumns (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/utils.js:109:15)\n    at PgSelectBuilder.from (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/query-builders/select.js:62:16)\n    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)\n    at SystemStatsRepository.incrementUsersCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:103:16)\n    at UserRepository.upsert (C:/Users/scoot/poll/VaultLogic/server/repositories/UserRepository.ts:95:37)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:69:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"userId":"google-user-123","msg":"Failed to upsert user during authentication"}
{"level":30,"time":1768511793592,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768511793586,"env":"test","module":"auth","err":{"type":"Error","message":"Failed to create or update user account","stack":"Error: Failed to create or update user account\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:73:11)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"msg":"Google authentication failed"}
{"level":30,"time":1768511793602,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511793609,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511793610,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511793611,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511793611,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511793619,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768511793670,"env":"test","module":"ai-workflow-edit-routes","error":{"query":"select \"id\", \"scope\", \"system_prompt\", \"updated_by\", \"created_at\", \"updated_at\" from \"ai_settings\" \"aiSettings\" where \"aiSettings\".\"scope\" = $1 limit $2","params":["global",1],"cause":{"length":178,"name":"error","severity":"ERROR","code":"42703","hint":"Perhaps you meant to reference the column \"aiSettings.updated_at\".","position":"54","file":"parse_relation.c","line":"3723","routine":"errorMissingColumn"}},"workflowId":"260afe6d-16e3-49da-be88-03779a78c51a","msg":"AI model call failed"}
{"level":50,"time":1768511793784,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:168:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
{"level":50,"time":1768511793784,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:168:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google authentication failed"}
{"level":40,"time":1768511793839,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768511793839,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:158:23"},"msg":"Google token verification failed"}
{"level":50,"time":1768511793839,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:158:23"},"msg":"Google authentication failed"}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w5, public

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w7, public

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w3, public

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w0, public

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w4, public

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w1, public

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w2, public

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w5
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w7
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w3
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w0
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w1
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w4
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w12.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w13.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w12.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w2
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w12.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w13.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w12.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w12.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w13.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w12.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w12.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w13.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w12.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w12.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w13.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w12.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w12.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w13.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w12.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w12.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w13.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w12.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w13.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w13.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w13.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w13.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w13.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w13.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w13.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511794178,"env":"test","workflowId":"7bddc251-66cf-4c29-98af-14887a5169c3","userId":"0d911e46-2705-43c7-9c3d-efa2acbe1a0b","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":30,"time":1768511794241,"env":"test","module":"auth","email":"existing@example.com","msg":"OAuth2 login successful"}
{"level":50,"time":1768511794271,"env":"test","module":"ai-workflow-edit-routes","error":{"query":"select \"id\", \"scope\", \"system_prompt\", \"updated_by\", \"created_at\", \"updated_at\" from \"ai_settings\" \"aiSettings\" where \"aiSettings\".\"scope\" = $1 limit $2","params":["global",1],"cause":{"length":178,"name":"error","severity":"ERROR","code":"42703","hint":"Perhaps you meant to reference the column \"aiSettings.updated_at\".","position":"54","file":"parse_relation.c","line":"3723","routine":"errorMissingColumn"}},"workflowId":"7bddc251-66cf-4c29-98af-14887a5169c3","msg":"AI model call failed"}
{"level":30,"time":1768511794651,"env":"test","module":"auth","email":"refresh@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1768511794715,"env":"test","module":"user-credentials-repository","userId":"NMhYN9IbevJXRJ1u3afbF","msg":"User credentials created"}
{"level":30,"time":1768511794722,"env":"test","module":"user-credentials-repository","userId":"DU-6rCLPBivoKdeKamwx9","msg":"User credentials created"}
{"level":30,"time":1768511794724,"env":"test","workflowId":"1e8aec97-5fa7-4f81-8696-5cceecf356fe","userId":"0d911e46-2705-43c7-9c3d-efa2acbe1a0b","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w14
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w14,public

{"level":30,"time":1768511794753,"env":"test","module":"user-credentials-repository","userId":"7177468c-5cb0-4a91-90c5-a36113576fb6","msg":"User credentials created"}
{"level":30,"time":1768511794785,"env":"test","module":"user-credentials-repository","userId":"8e9882e0-baa0-4b9d-b29e-9dabca60584f","msg":"User credentials created"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould complete full MFA setup flow
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511794795,"env":"test","module":"auth-service","tokenHash":"6ac59ce3b73052907deb9fb22662603bcef0fe926634a5a2597031a744e486f9","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w14 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w14%2Cpublic

{"level":30,"time":1768511794800,"env":"test","msg":"DB: initializing... Local"}
{"level":50,"time":1768511794827,"env":"test","module":"ai-workflow-edit-routes","error":{"query":"select \"id\", \"scope\", \"system_prompt\", \"updated_by\", \"created_at\", \"updated_at\" from \"ai_settings\" \"aiSettings\" where \"aiSettings\".\"scope\" = $1 limit $2","params":["global",1],"cause":{"length":178,"name":"error","severity":"ERROR","code":"42703","hint":"Perhaps you meant to reference the column \"aiSettings.updated_at\".","position":"54","file":"parse_relation.c","line":"3723","routine":"errorMissingColumn"}},"workflowId":"1e8aec97-5fa7-4f81-8696-5cceecf356fe","msg":"AI model call failed"}
{"level":30,"time":1768511794840,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511794853,"env":"test","module":"email-queue","jobId":"cab7596b-5d9a-4404-a5bc-122ac0876cb8","to":"test-1768511794339-etrl4f@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for c64556a696d4b3ffa35631754ff81911

{"level":30,"time":1768511794887,"env":"test","module":"email-queue","jobId":"ad4fa7da-dc81-4402-ad3f-5c7ec6934a84","to":"test-1768511794366-d5wapi@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768511794902,"env":"test","module":"auth-routes","userId":"7177468c-5cb0-4a91-90c5-a36113576fb6","email":"test-1768511794339-etrl4f@example.com","msg":"User registered"}
{"level":30,"time":1768511794923,"env":"test","module":"auth-routes","userId":"DU-6rCLPBivoKdeKamwx9","sessionCount":2,"msg":"Listed active sessions"}
{"level":30,"time":1768511794939,"env":"test","module":"auth-routes","userId":"8e9882e0-baa0-4b9d-b29e-9dabca60584f","email":"test-1768511794366-d5wapi@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mComplete Registration ‚Üí Login Flow[2m > [22m[2mshould complete registration, verify email, then login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511795049,"env":"test","module":"auth","email":"idtoken@example.com","msg":"OAuth2 login successful"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w14, public

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w14
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768511795260,"env":"test","module":"auth-routes","userId":"861cda51f4e43b3faeb9ae50748d477b","msg":"User logged in successfully"}
{"level":30,"time":1768511795270,"env":"test","module":"user-credentials-repository","userId":"vBldB2Q88eDc1q0ilzbm1","msg":"User credentials created"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w7.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w1.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w2.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w4.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w0.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w5.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w7.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511795290,"env":"test","module":"auth-routes","userId":"7e17f551cdfa46fbb59ecee593fa87d7","msg":"User logged in successfully"}
{"level":50,"time":1768511795309,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["861cda51f4e43b3faeb9ae50748d477b","login_success","security","861cda51f4e43b3faeb9ae50748d477b","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:35.261Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-15T21:16:35.261Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"861cda51f4e43b3faeb9ae50748d477b","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 861cda51f4e43b3faeb9ae50748d477b,login_success,security,861cda51f4e43b3faeb9ae50748d477b,{"metadata":{"timestamp":"2026-01-15T21:16:35.261Z"}},::ffff:127.0.0.1,Mozilla/5.0 (Windows NT 10.0; Win64; x64),2026-01-15T21:16:35.261Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'861cda51f4e43b3faeb9ae50748d477b'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'861cda51f4e43b3faeb9ae50748d477b'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:35.261Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [32m'Mozilla/5.0 (Windows NT 10.0; Win64; x64)'[39m,
    [32m'2026-01-15T21:16:35.261Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768511795321,"env":"test","workflowId":"bec47b8d-a23e-4e2e-b33b-f17bda8d30bc","userId":"0d911e46-2705-43c7-9c3d-efa2acbe1a0b","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":50,"time":1768511795309,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["861cda51f4e43b3faeb9ae50748d477b","login_success","security","861cda51f4e43b3faeb9ae50748d477b","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:35.261Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-15T21:16:35.261Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w1.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768511795332,"env":"test","module":"auth-routes","userId":"8e9882e0-baa0-4b9d-b29e-9dabca60584f","email":"test-1768511794366-d5wapi@example.com","msg":"Login blocked: email not verified"}
{"level":50,"time":1768511795336,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["7e17f551cdfa46fbb59ecee593fa87d7","login_success","security","7e17f551cdfa46fbb59ecee593fa87d7","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:35.290Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:35.290Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"7e17f551cdfa46fbb59ecee593fa87d7","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mComplete Registration ‚Üí Login Flow[2m > [22m[2mshould complete registration, verify email, then login
[22m[39mLogin Failed DEBUG: EmailNotVerifiedError: Please verify your email before logging in. Check your inbox for the verification link.
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:90:11)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_006'[39m,
  statusCode: [33m403[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768511795332,"env":"test","module":"auth-routes","error":{"name":"EmailNotVerifiedError","code":"AUTH_006","statusCode":403,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould complete full MFA setup flow
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 7e17f551cdfa46fbb59ecee593fa87d7,login_success,security,7e17f551cdfa46fbb59ecee593fa87d7,{"metadata":{"timestamp":"2026-01-15T21:16:35.290Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:35.290Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'7e17f551cdfa46fbb59ecee593fa87d7'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'7e17f551cdfa46fbb59ecee593fa87d7'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:35.290Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:35.290Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511795336,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["7e17f551cdfa46fbb59ecee593fa87d7","login_success","security","7e17f551cdfa46fbb59ecee593fa87d7","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:35.290Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:35.290Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768511795358,"env":"test","module":"user-credentials-repository","userId":"AM_AwXaxhCAUb9DfWRSJt","msg":"User credentials created"}
{"level":30,"time":1768511795375,"env":"test","module":"auth-routes","userId":"vBldB2Q88eDc1q0ilzbm1","sessionCount":1,"msg":"Listed active sessions"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w2.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mComplete Registration ‚Üí Login Flow[2m > [22m[2mshould complete registration, verify email, then login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511795408,"env":"test","module":"auth-service","tokenHash":"67e5657596fcec3c7b981225f30996e9df857ddcde888f7af50c54745cf62faf","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":50,"time":1768511795430,"env":"test","module":"ai-workflow-edit-routes","error":{"query":"select \"id\", \"scope\", \"system_prompt\", \"updated_by\", \"created_at\", \"updated_at\" from \"ai_settings\" \"aiSettings\" where \"aiSettings\".\"scope\" = $1 limit $2","params":["global",1],"cause":{"length":178,"name":"error","severity":"ERROR","code":"42703","hint":"Perhaps you meant to reference the column \"aiSettings.updated_at\".","position":"54","file":"parse_relation.c","line":"3723","routine":"errorMissingColumn"}},"workflowId":"bec47b8d-a23e-4e2e-b33b-f17bda8d30bc","msg":"AI model call failed"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w4.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511795449,"env":"test","module":"auth","email":"minimal@example.com","msg":"OAuth2 login successful"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w0.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511795494,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511795495,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/integration/variableSafety.test.ts [2m([22m[2m4 tests[22m[2m | [22m[31m4 failed[39m[2m)[22m[33m 3452[2mms[22m[39m
[31m     [31m√ó[31m REPRO: ScriptEngine fails to resolve alias 'input_variable' when aliasMap is NOT provided[39m[32m 222[2mms[22m[39m
[31m     [31m√ó[31m ScriptEngine resolves alias 'input_variable' when aliasMap is provided[39m[33m 480[2mms[22m[39m
[31m     [31m√ó[31m REPRO: BlockRunner fails to resolve alias in CreateRecordConfig[39m[33m 491[2mms[22m[39m
[31m     [31m√ó[31m BlockRunner logic resolves alias with aliasMap[39m[33m 500[2mms[22m[39m
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768511795554,"env":"test","module":"auth","err":{"type":"Error","message":"Token verification failed","stack":"Error: Token verification failed\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:428:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w5.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":40,"time":1768511795607,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768511795607,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
{"level":30,"time":1768511795632,"env":"test","module":"auth-routes","userId":"c64556a696d4b3ffa35631754ff81911","msg":"Login requires MFA verification"}
{"level":50,"time":1768511795654,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token payload","stack":"Error: Invalid token payload\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:88:26)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
{"level":30,"time":1768511795713,"env":"test","module":"user-credentials-repository","userId":"LKADEeepwpFwEku8Eg0cE","msg":"User credentials created"}
{"level":30,"time":1768511795715,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511795716,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768511795740,"env":"test","module":"mfa-service","userId":"c64556a696d4b3ffa35631754ff81911","msg":"TOTP verification successful"}
 [31m‚ùØ[39m tests/integration/auth/oauth2.google.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 3656[2mms[22m[39m
[31m       [31m√ó[31m should successfully authenticate with valid Google ID token[39m[32m 276[2mms[22m[39m
       [32m‚úì[39m should return 400 when ID token is missing[32m 67[2mms[22m[39m
       [32m‚úì[39m should return 403 when Origin header is invalid[32m 54[2mms[22m[39m
       [32m‚úì[39m should return 401 when Google token verification fails[32m 57[2mms[22m[39m
       [32m‚úì[39m should return 401 when email is not verified by Google[32m 55[2mms[22m[39m
       [33m[2m‚úì[22m[39m should update existing user on subsequent logins [33m 451[2mms[22m[39m
       [33m[2m‚úì[22m[39m should create refresh token record in database [33m 411[2mms[22m[39m
       [33m[2m‚úì[22m[39m should support both "token" and "idToken" fields [33m 347[2mms[22m[39m
       [32m‚úì[39m should respect rate limiting[32m 47[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle missing profile information gracefully [33m 353[2mms[22m[39m
       [32m‚úì[39m should verify valid Google ID token[32m 46[2mms[22m[39m
       [32m‚úì[39m should throw error when token verification fails[32m 58[2mms[22m[39m
       [32m‚úì[39m should throw error when email is not verified[32m 52[2mms[22m[39m
       [32m‚úì[39m should throw error when payload is null[32m 47[2mms[22m[39m
{"level":30,"time":1768511795796,"env":"test","module":"auth-routes","userId":"c64556a696d4b3ffa35631754ff81911","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768511795813,"env":"test","module":"auth-routes","userId":"LKADEeepwpFwEku8Eg0cE","sessionCount":0,"msg":"Listed active sessions"}
{"level":30,"time":1768511795877,"env":"test","module":"auth-routes","userId":"8e9882e0-baa0-4b9d-b29e-9dabca60584f","msg":"User logged in successfully"}
{"level":30,"time":1768511795883,"env":"test","workflowId":"bcd04d71-16a4-40f8-9c04-697f6d8f6816","userId":"0d911e46-2705-43c7-9c3d-efa2acbe1a0b","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":50,"time":1768511795926,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["8e9882e0-baa0-4b9d-b29e-9dabca60584f","login_success","security","8e9882e0-baa0-4b9d-b29e-9dabca60584f","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:35.878Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:35.878Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"8e9882e0-baa0-4b9d-b29e-9dabca60584f","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mComplete Registration ‚Üí Login Flow[2m > [22m[2mshould complete registration, verify email, then login
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 8e9882e0-baa0-4b9d-b29e-9dabca60584f,login_success,security,8e9882e0-baa0-4b9d-b29e-9dabca60584f,{"metadata":{"timestamp":"2026-01-15T21:16:35.878Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:35.878Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'8e9882e0-baa0-4b9d-b29e-9dabca60584f'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'8e9882e0-baa0-4b9d-b29e-9dabca60584f'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:35.878Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:35.878Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511795926,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["8e9882e0-baa0-4b9d-b29e-9dabca60584f","login_success","security","8e9882e0-baa0-4b9d-b29e-9dabca60584f","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:35.878Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:35.878Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768511795940,"env":"test","module":"user-credentials-repository","userId":"f746ea9e-cd67-4006-b8a9-3e0c86e67ca6","msg":"User credentials created"}
{"level":30,"time":1768511795965,"env":"test","module":"auth-routes","userId":"c64556a696d4b3ffa35631754ff81911","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":50,"time":1768511795983,"env":"test","module":"ai-workflow-edit-routes","error":{"query":"select \"id\", \"scope\", \"system_prompt\", \"updated_by\", \"created_at\", \"updated_at\" from \"ai_settings\" \"aiSettings\" where \"aiSettings\".\"scope\" = $1 limit $2","params":["global",1],"cause":{"length":178,"name":"error","severity":"ERROR","code":"42703","hint":"Perhaps you meant to reference the column \"aiSettings.updated_at\".","position":"54","file":"parse_relation.c","line":"3723","routine":"errorMissingColumn"}},"workflowId":"bcd04d71-16a4-40f8-9c04-697f6d8f6816","msg":"AI model call failed"}
{"level":30,"time":1768511796027,"env":"test","module":"user-credentials-repository","userId":"FG2FEDI1e68R7pv4WD_wZ","msg":"User credentials created"}
{"level":30,"time":1768511796048,"env":"test","module":"email-queue","jobId":"5a127f10-9b6b-4568-9514-28601b6794ae","to":"test-1768511795565-qtka6r@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768511796101,"env":"test","module":"auth-routes","userId":"f746ea9e-cd67-4006-b8a9-3e0c86e67ca6","email":"test-1768511795565-qtka6r@example.com","msg":"User registered"}
{"level":30,"time":1768511796102,"env":"test","module":"auth-routes","userId":"861cda51f4e43b3faeb9ae50748d477b","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

{"level":30,"time":1768511796139,"env":"test","module":"user-credentials-repository","userId":"o6EQWckM1kGtfj4aha4jz","msg":"User credentials created"}
{"level":50,"time":1768511796151,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["861cda51f4e43b3faeb9ae50748d477b","login_success","security","861cda51f4e43b3faeb9ae50748d477b","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:36.103Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (iPhone; CPU iPhone OS 14_0)","2026-01-15T21:16:36.103Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"861cda51f4e43b3faeb9ae50748d477b","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 861cda51f4e43b3faeb9ae50748d477b,login_success,security,861cda51f4e43b3faeb9ae50748d477b,{"metadata":{"timestamp":"2026-01-15T21:16:36.103Z"}},::ffff:127.0.0.1,Mozilla/5.0 (iPhone; CPU iPhone OS 14_0),2026-01-15T21:16:36.103Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'861cda51f4e43b3faeb9ae50748d477b'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'861cda51f4e43b3faeb9ae50748d477b'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:36.103Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [32m'Mozilla/5.0 (iPhone; CPU iPhone OS 14_0)'[39m,
    [32m'2026-01-15T21:16:36.103Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511796152,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["861cda51f4e43b3faeb9ae50748d477b","login_success","security","861cda51f4e43b3faeb9ae50748d477b","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:36.103Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (iPhone; CPU iPhone OS 14_0)","2026-01-15T21:16:36.103Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511796240,"env":"test","module":"auth-routes","userId":"o6EQWckM1kGtfj4aha4jz","sessionCount":0,"msg":"Listed active sessions"}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511796405,"env":"test","module":"user-credentials-repository","userId":"Ylo1f0wKsn_Qm_-dAyB2U","msg":"User credentials created"}
{"level":30,"time":1768511796430,"env":"test","workflowId":"183e1525-48cb-457e-9c80-74edb693ec70","userId":"0d911e46-2705-43c7-9c3d-efa2acbe1a0b","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":30,"time":1768511796460,"env":"test","module":"auth-service","tokenHash":"2fe6f7ff0fa9bd1ee1eb2b4de4567a52a13546270f31f9607e884393806b0e0c","plainTokenLen":19,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768511796510,"env":"test","module":"auth-service","tokenHash":"2fe6f7ff0fa9bd1ee1eb2b4de4567a52a13546270f31f9607e884393806b0e0c","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":50,"time":1768511796524,"env":"test","module":"ai-workflow-edit-routes","error":{"query":"select \"id\", \"scope\", \"system_prompt\", \"updated_by\", \"created_at\", \"updated_at\" from \"ai_settings\" \"aiSettings\" where \"aiSettings\".\"scope\" = $1 limit $2","params":["global",1],"cause":{"length":178,"name":"error","severity":"ERROR","code":"42703","hint":"Perhaps you meant to reference the column \"aiSettings.updated_at\".","position":"54","file":"parse_relation.c","line":"3723","routine":"errorMissingColumn"}},"workflowId":"183e1525-48cb-457e-9c80-74edb693ec70","msg":"AI model call failed"}
{"level":30,"time":1768511796572,"env":"test","module":"user-credentials-repository","userId":"htmF42lTyHSepBPmdm99v","msg":"User credentials created"}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould reject invalid TOTP code during setup
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511796724,"env":"test","module":"auth-routes","userId":"htmF42lTyHSepBPmdm99v","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768511796923,"env":"test","module":"auth-service","allTokensCount":5332,"sampleToken":"2b484d683e217a5794883c3321285a69f23da26d5e0f749725f993d77b121982","msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768511796938,"env":"test","module":"auth-routes","userId":"861cda51f4e43b3faeb9ae50748d477b","msg":"User logged in successfully"}
{"level":50,"time":1768511796985,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["861cda51f4e43b3faeb9ae50748d477b","login_success","security","861cda51f4e43b3faeb9ae50748d477b","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:36.938Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)","2026-01-15T21:16:36.938Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"861cda51f4e43b3faeb9ae50748d477b","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 861cda51f4e43b3faeb9ae50748d477b,login_success,security,861cda51f4e43b3faeb9ae50748d477b,{"metadata":{"timestamp":"2026-01-15T21:16:36.938Z"}},::ffff:127.0.0.1,Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7),2026-01-15T21:16:36.938Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'861cda51f4e43b3faeb9ae50748d477b'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'861cda51f4e43b3faeb9ae50748d477b'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:36.938Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [32m'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)'[39m,
    [32m'2026-01-15T21:16:36.938Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511796985,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["861cda51f4e43b3faeb9ae50748d477b","login_success","security","861cda51f4e43b3faeb9ae50748d477b","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:36.938Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)","2026-01-15T21:16:36.938Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768511796991,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w15
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w15,public

{"level":30,"time":1768511797058,"env":"test","module":"user-credentials-repository","userId":"-OaDMt1Lc7Wb92x4LvWUM","msg":"User credentials created"}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w15 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w15%2Cpublic

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w16
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w16,public

{"level":30,"time":1768511797063,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511797095,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w16 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w16%2Cpublic

{"level":30,"time":1768511797110,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511797114,"env":"test","module":"auth-routes","userId":"dc7f31f431b4df7e9f9ec6147bac9655","msg":"User logged in successfully"}
{"level":30,"time":1768511797131,"env":"test","workflowId":"86456c08-5ddd-4143-b2b8-155c1bad0f6b","userId":"0d911e46-2705-43c7-9c3d-efa2acbe1a0b","sectionsCount":1,"stepsCount":1,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39m[TEST UTILS] MFA Secret verified for 353413571566a2f6e95a4734ca545c97

{"level":30,"time":1768511797145,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511797156,"env":"test","module":"auth-routes","userId":"-OaDMt1Lc7Wb92x4LvWUM","sessionCount":1,"msg":"Listed active sessions"}
{"level":50,"time":1768511797164,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["dc7f31f431b4df7e9f9ec6147bac9655","login_success","security","dc7f31f431b4df7e9f9ec6147bac9655","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:37.114Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:37.114Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"dc7f31f431b4df7e9f9ec6147bac9655","eventType":"login_success","msg":"Failed to log security event"}
{"level":30,"time":1768511797164,"env":"test","module":"user-credentials-repository","userId":"da639141-1f55-4759-b199-caa5efb8a3c7","msg":"User credentials created"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould reject invalid TOTP code during setup
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: dc7f31f431b4df7e9f9ec6147bac9655,login_success,security,dc7f31f431b4df7e9f9ec6147bac9655,{"metadata":{"timestamp":"2026-01-15T21:16:37.114Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:37.114Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'dc7f31f431b4df7e9f9ec6147bac9655'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'dc7f31f431b4df7e9f9ec6147bac9655'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:37.114Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:37.114Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511797164,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["dc7f31f431b4df7e9f9ec6147bac9655","login_success","security","dc7f31f431b4df7e9f9ec6147bac9655","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:37.114Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:37.114Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768511797170,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768511797175,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768511797227,"env":"test","module":"ai-workflow-edit-routes","error":{"query":"select \"id\", \"scope\", \"system_prompt\", \"updated_by\", \"created_at\", \"updated_at\" from \"ai_settings\" \"aiSettings\" where \"aiSettings\".\"scope\" = $1 limit $2","params":["global",1],"cause":{"length":178,"name":"error","severity":"ERROR","code":"42703","hint":"Perhaps you meant to reference the column \"aiSettings.updated_at\".","position":"54","file":"parse_relation.c","line":"3723","routine":"errorMissingColumn"}},"workflowId":"86456c08-5ddd-4143-b2b8-155c1bad0f6b","msg":"AI model call failed"}
{"level":30,"time":1768511797228,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511797229,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511797256,"env":"test","module":"user-credentials-repository","userId":"77_Maz02cq1fJGF08f2vF","msg":"User credentials created"}
{"level":30,"time":1768511797263,"env":"test","module":"email-queue","jobId":"d8629657-18d4-4d2a-b9c8-17a66a76799b","to":"test-1768511796780-p3b5ps@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768511797312,"env":"test","module":"auth-routes","userId":"da639141-1f55-4759-b199-caa5efb8a3c7","email":"test-1768511796780-p3b5ps@example.com","msg":"User registered"}
{"level":30,"time":1768511797354,"env":"test","module":"auth-service","tokenHash":"719d4f34fd9de961e8180db389d381f3f2fb25ec3f7287005acb16280bd0a506","plainTokenLen":17,"msg":"DEBUG: rotateRefreshToken called"}
 [31m‚ùØ[39m tests/integration/dataBlocks.test.ts [2m([22m[2m2 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 2831[2mms[22m[39m
[31m     [31m√ó[31m should write data to DataVault via WriteBlock[39m[32m 108[2mms[22m[39m
[31m     [31m√ó[31m should query data from DataVault via QueryBlock and use in Logic[39m[33m 346[2mms[22m[39m
{"level":40,"time":1768511797403,"env":"test","module":"auth-service","tokenHash":"719d4f34fd9de961e8180db389d381f3f2fb25ec3f7287005acb16280bd0a506","msg":"Security: Unknown refresh token used (Not Found in DB)"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w15, public

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w15
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768511797520,"env":"test","module":"user-credentials-repository","userId":"tIHShMDRjbi-hV2XSfu3b","msg":"User credentials created"}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w16, public

{"level":50,"time":1768511797526,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w14.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w14.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w16
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768511797609,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511797609,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mDEBUG: Existing functions: []

{"level":50,"time":1768511797626,"env":"test","module":"auth-routes","email":"test-1768511796829-cinuhi@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
 [31m‚ùØ[39m tests/integration/ai/workflowEdit.test.ts [2m([22m[2m8 tests[22m[2m | [22m[31m7 failed[39m[2m)[22m[33m 5878[2mms[22m[39m
[31m     [31m√ó[31m should create draft version on successful AI edit[39m[33m 616[2mms[22m[39m
[31m     [31m√ó[31m should enforce draft mode (revert active workflow to draft)[39m[33m 593[2mms[22m[39m
[31m     [31m√ó[31m should not create version when no changes detected (checksum match)[39m[33m 556[2mms[22m[39m
     [32m‚úì[39m should reject unauthorized access[32m 56[2mms[22m[39m
[31m     [31m√ó[31m should reject unsafe DataVault operations[39m[33m 547[2mms[22m[39m
[31m     [31m√ó[31m should handle multi-operation edits with tempId resolution[39m[33m 554[2mms[22m[39m
[31m     [31m√ó[31m should create BEFORE and AFTER snapshots[39m[33m 541[2mms[22m[39m
[31m     [31m√ó[31m should rollback on validation failure[39m[33m 703[2mms[22m[39m
{"level":30,"time":1768511797674,"env":"test","module":"auth-service","allTokensCount":5337,"sampleToken":"2b484d683e217a5794883c3321285a69f23da26d5e0f749725f993d77b121982","msg":"DEBUG: Tokens in DB"}
{"level":50,"time":1768511797737,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould login with valid credentials
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768511797869,"env":"test","module":"user-credentials-repository","userId":"4zd7MoKflz5ryd5me8LZB","msg":"User credentials created"}
{"level":30,"time":1768511797908,"env":"test","module":"auth-routes","userId":"353413571566a2f6e95a4734ca545c97","msg":"Login requires MFA verification"}
{"level":30,"time":1768511798016,"env":"test","module":"mfa-service","userId":"353413571566a2f6e95a4734ca545c97","msg":"TOTP verification successful"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

{"level":30,"time":1768511798023,"env":"test","module":"user-credentials-repository","userId":"c7_Lg5aQ9lY1tF2XBNB0z","msg":"User credentials created"}
{"level":30,"time":1768511798061,"env":"test","module":"auth-routes","userId":"4zd7MoKflz5ryd5me8LZB","sessionId":"d16d64b6-b269-4fc4-b75f-f047331b0439","msg":"Session revoked"}
{"level":30,"time":1768511798067,"env":"test","module":"auth-routes","userId":"353413571566a2f6e95a4734ca545c97","msg":"MFA login successful"}
{"level":30,"time":1768511798123,"env":"test","module":"auth-service","tokenHash":"78f6e90e0da8ae0db514bde39532489677d3c17897cb35e8adc689c3c0a7641a","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":50,"time":1768511798125,"env":"test","module":"auth-routes","email":"test-1768511796829-cinuhi@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":40,"time":1768511798172,"env":"test","module":"auth-service","userId":"c7_Lg5aQ9lY1tF2XBNB0z","tokenHash":"78f6e90e0da8ae0db514bde39532489677d3c17897cb35e8adc689c3c0a7641a","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":50,"time":1768511798219,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":30,"time":1768511798220,"env":"test","module":"auth-routes","userId":"d955395cc80aeb235e872307b38448be","msg":"User logged in successfully"}
{"level":30,"time":1768511798231,"env":"test","module":"auth-routes","userId":"353413571566a2f6e95a4734ca545c97","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768511798271,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["d955395cc80aeb235e872307b38448be","login_success","security","d955395cc80aeb235e872307b38448be","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:38.221Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:38.221Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"d955395cc80aeb235e872307b38448be","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould login with valid credentials
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: d955395cc80aeb235e872307b38448be,login_success,security,d955395cc80aeb235e872307b38448be,{"metadata":{"timestamp":"2026-01-15T21:16:38.221Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:38.221Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'd955395cc80aeb235e872307b38448be'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'd955395cc80aeb235e872307b38448be'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:38.221Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:38.221Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511798271,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["d955395cc80aeb235e872307b38448be","login_success","security","d955395cc80aeb235e872307b38448be","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:38.221Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:38.221Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould mark current session correctly
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511798467,"env":"test","module":"user-credentials-repository","userId":"z-lxBjWuQZRh32qntkSSN","msg":"User credentials created"}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w18
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w18,public

{"level":30,"time":1768511798555,"env":"test","module":"user-credentials-repository","userId":"m6WzV9M1wjRDnW3iaQDMt","msg":"User credentials created"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould not allow MFA setup if already enabled
[22m[39m[TEST UTILS] MFA Secret verified for 19bb28ee892ef2b2cfa5bde8618bda51

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w18 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w18%2Cpublic

{"level":50,"time":1768511798618,"env":"test","module":"auth-routes","email":"test-1768511796829-cinuhi@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511798628,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768511798629,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768511798664,"env":"test","module":"auth-service","tokenHash":"0f8cdefde55225727d3a28f57d638a6b94696be79ac7ed085a6f1fbe89e12f72","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
 [31m‚ùØ[39m tests/integration/workflow_versioning.test.ts [2m([22m[2m3 tests[22m[2m | [22m[33m3 skipped[39m[2m)[22m[33m 1943[2mms[22m[39m
     [2m[90m‚Üì[39m[22m should diff two versions correctly
     [2m[90m‚Üì[39m[22m should create a version and populate changelog
     [2m[90m‚Üì[39m[22m should track execution lineage via snapshot
{"level":40,"time":1768511798714,"env":"test","module":"auth-service","tokenHash":"0f8cdefde55225727d3a28f57d638a6b94696be79ac7ed085a6f1fbe89e12f72","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":50,"time":1768511798720,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511798780,"env":"test","module":"auth-routes","userId":"5237ac581e13eb330d02c09deba56462","msg":"User logged in successfully"}
{"level":30,"time":1768511798810,"env":"test","module":"user-credentials-repository","userId":"ftpPsAkFycR4hStR5u-zD","msg":"User credentials created"}
{"level":50,"time":1768511798831,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["5237ac581e13eb330d02c09deba56462","login_success","security","5237ac581e13eb330d02c09deba56462","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:38.780Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:38.780Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"5237ac581e13eb330d02c09deba56462","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould mark current session correctly
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 5237ac581e13eb330d02c09deba56462,login_success,security,5237ac581e13eb330d02c09deba56462,{"metadata":{"timestamp":"2026-01-15T21:16:38.780Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:38.780Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'5237ac581e13eb330d02c09deba56462'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'5237ac581e13eb330d02c09deba56462'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:38.780Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:38.780Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511798831,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["5237ac581e13eb330d02c09deba56462","login_success","security","5237ac581e13eb330d02c09deba56462","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:38.780Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:38.780Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould mark current session correctly
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould not allow MFA setup if already enabled
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w17
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w17,public

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w17 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w17%2Cpublic

{"level":30,"time":1768511798953,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511799005,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

{"level":30,"time":1768511799102,"env":"test","module":"auth-service","allTokensCount":5336,"sampleToken":"2b484d683e217a5794883c3321285a69f23da26d5e0f749725f993d77b121982","msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768511799123,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511799124,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768511799140,"env":"test","module":"auth-routes","email":"test-1768511796829-cinuhi@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
 [31m‚ùØ[39m tests/integration/externalSends.test.ts [2m([22m[2m2 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 2491[2mms[22m[39m
[31m     [31m√ó[31m PREVIEW MODE: Should simulate send and NOT call fetch[39m[32m 60[2mms[22m[39m
[31m     [31m√ó[31m LIVE MODE: Should call fetch with mapped payload[39m[33m 343[2mms[22m[39m
{"level":50,"time":1768511799244,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511799276,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511799320,"env":"test","module":"user-credentials-repository","userId":"-fsBnIKFkZUJoDq6HGCJT","msg":"User credentials created"}
{"level":30,"time":1768511799323,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for 4d0fecb8e73a70660e3bd8a877b028c0

{"level":30,"time":1768511799362,"env":"test","module":"auth-routes","userId":"19bb28ee892ef2b2cfa5bde8618bda51","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w17, public

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w17
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768511799436,"env":"test","module":"user-credentials-repository","userId":"GVKdGyEHICGQdpKGEFYuQ","msg":"User credentials created"}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w15.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w16.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w15.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511799490,"env":"test","module":"auth-service","tokenHash":"2385102e5b08447713e1f4abf3efcb9f48f914e376c1912a7db3492261b1df49","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w16.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for invalid password
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768511799631,"env":"test","module":"auth-routes","email":"test-1768511796829-cinuhi@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768511799655,"env":"test","module":"auth-routes","userId":"5237ac581e13eb330d02c09deba56462","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w18, public

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768511799700,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["5237ac581e13eb330d02c09deba56462","login_success","security","5237ac581e13eb330d02c09deba56462","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:39.655Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:39.655Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"5237ac581e13eb330d02c09deba56462","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould mark current session correctly
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 5237ac581e13eb330d02c09deba56462,login_success,security,5237ac581e13eb330d02c09deba56462,{"metadata":{"timestamp":"2026-01-15T21:16:39.655Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:39.655Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'5237ac581e13eb330d02c09deba56462'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'5237ac581e13eb330d02c09deba56462'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:39.655Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:39.655Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511799700,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["5237ac581e13eb330d02c09deba56462","login_success","security","5237ac581e13eb330d02c09deba56462","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:39.655Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:39.655Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768511799708,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w18
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w17.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w17.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":40,"time":1768511799817,"env":"test","module":"account-lockout","userId":"8126dfc365034425d4e486a54a6f2f05","email":"test-1768511796829-cinuhi@example.com","lockedUntil":"2026-01-15T21:31:39.769Z","msg":"Account locked due to too many failed attempts"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768511799818,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511799839,"env":"test","module":"user-credentials-repository","userId":"0Wjvdc0BOHTTpBxRarLA3","msg":"User credentials created"}
{"level":50,"time":1768511799842,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768511799919,"env":"test","module":"auth-routes","userId":"8126dfc365034425d4e486a54a6f2f05","email":"test-1768511796829-cinuhi@example.com","msg":"Login blocked: account locked"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: AccountLockedError: Account is locked until 2026-01-15T21:31:39.769Z
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:62:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_005'[39m,
  statusCode: [33m423[39m,
  isOperational: [33mtrue[39m,
  lockedUntil: [35m2026-01-15T21:31:39.769Z[39m,
  remainingMinutes: [33m15[39m
}

{"level":50,"time":1768511799919,"env":"test","module":"auth-routes","error":{"name":"AccountLockedError","code":"AUTH_005","statusCode":423,"isOperational":true,"lockedUntil":"2026-01-15T21:31:39.769Z","remainingMinutes":15},"msg":"Login failed"}
{"level":50,"time":1768511799967,"env":"test","module":"auth-routes","email":"test-1768511799211-5pwga@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":50,"time":1768511800041,"env":"test","module":"workflow-patch-service","error":{},"op":{"op":"datavault.createTable","databaseId":"db-123","name":"Submissions","columns":[{"name":"email","type":"text"},{"name":"submitted_at","type":"date"}]},"msg":"Failed to apply operation"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":50,"time":1768511800049,"env":"test","module":"workflow-patch-service","error":{},"op":{"op":"step.create","sectionRef":"temp-section-1","type":"short_text","title":"Field 1","alias":"field1"},"msg":"Failed to apply operation"}
{"level":50,"time":1768511800054,"env":"test","module":"workflow-patch-service","error":{},"op":{"op":"document.bindFields","id":"template-123","bindings":{"client_name":"nonExistentAlias"}},"msg":"Failed to apply operation"}
{"level":30,"time":1768511800058,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768511800058,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768511800070,"env":"test","module":"user-credentials-repository","userId":"p5fMU9R0guH5NOk-v5-Nq","msg":"User credentials created"}
{"level":50,"time":1768511800074,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for invalid password
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

 [31m‚ùØ[39m tests/unit/services/WorkflowPatchService.test.ts [2m([22m[2m21 tests[22m[2m | [22m[31m3 failed[39m[2m)[22m[33m 1897[2mms[22m[39m
       [32m‚úì[39m should resolve section tempId to real UUID when creating step[32m 9[2mms[22m[39m
       [32m‚úì[39m should handle multi-level tempId references[32m 1[2mms[22m[39m
       [32m‚úì[39m should reject duplicate step alias on create[32m 1[2mms[22m[39m
       [32m‚úì[39m should allow same alias on update of same step[32m 0[2mms[22m[39m
       [32m‚úì[39m should reject duplicate alias on update to different step[32m 0[2mms[22m[39m
       [32m‚úì[39m should reject completely unknown operation[32m 1[2mms[22m[39m
       [32m‚úì[39m should reject malformed operation (missing required fields)[32m 1[2mms[22m[39m
       [32m‚úì[39m should reject unsafe DataVault operations (dropTable)[32m 1[2mms[22m[39m
       [32m‚úì[39m should reject unsafe DataVault operations (dropColumn)[32m 1[2mms[22m[39m
       [32m‚úì[39m should reject unsafe DataVault operations (deleteRows)[32m 0[2mms[22m[39m
       [32m‚úì[39m should reject unsafe DataVault operations (updateRowData)[32m 0[2mms[22m[39m
[31m       [31m√ó[31m should allow safe DataVault operations (createTable, addColumns)[39m[32m 8[2mms[22m[39m
       [32m‚úì[39m should rollback all ops if any op fails[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should clear tempId mappings between batch calls[39m[32m 1[2mms[22m[39m
       [32m‚úì[39m should create visibility rule on step[32m 1[2mms[22m[39m
       [32m‚úì[39m should parse complex condition expressions[32m 1[2mms[22m[39m
       [32m‚úì[39m should attach document to workflow (document.add)[32m 1[2mms[22m[39m
       [32m‚úì[39m should bind document fields to workflow variables (document.bindFields)[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should reject binding to non-existent step alias[39m[32m 1[2mms[22m[39m
       [32m‚úì[39m should create DataVault table with columns (datavault.createTable)[32m 1[2mms[22m[39m
       [32m‚úì[39m should create writeback mapping (datavault.createWritebackMapping)[32m 1[2mms[22m[39m
{"level":30,"time":1768511800088,"env":"test","module":"auth-routes","userId":"4d0fecb8e73a70660e3bd8a877b028c0","msg":"Login requires MFA verification"}
{"level":30,"time":1768511800127,"env":"test","module":"auth-service","tokenHash":"0d30b84787ea904c549c5120cc964dc9ced40121e3f777278a9ca57f1fc6be2d","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768511800128,"env":"test","module":"auth-service","tokenHash":"0d30b84787ea904c549c5120cc964dc9ced40121e3f777278a9ca57f1fc6be2d","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768511800177,"env":"test","module":"user-credentials-repository","userId":"2blkiQyJZRiWOThIBR6z_","msg":"User credentials created"}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w19
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w19,public

{"level":30,"time":1768511800189,"env":"test","module":"mfa-service","userId":"4d0fecb8e73a70660e3bd8a877b028c0","msg":"TOTP verification successful"}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w19 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w19%2Cpublic

{"level":30,"time":1768511800228,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511800241,"env":"test","module":"auth-routes","userId":"4d0fecb8e73a70660e3bd8a877b028c0","msg":"MFA login successful"}
{"level":30,"time":1768511800268,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould generate unique backup codes
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768511800401,"env":"test","module":"auth-routes","userId":"4d0fecb8e73a70660e3bd8a877b028c0","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":40,"time":1768511800465,"env":"test","module":"auth-service","userId":"p5fMU9R0guH5NOk-v5-Nq","tokenHash":"0d30b84787ea904c549c5120cc964dc9ced40121e3f777278a9ca57f1fc6be2d","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w19, public

{"level":30,"time":1768511800632,"env":"test","module":"auth-routes","userId":"2blkiQyJZRiWOThIBR6z_","msg":"All other sessions revoked"}
{"level":30,"time":1768511800659,"env":"test","module":"auth-routes","userId":"4d0fecb8e73a70660e3bd8a877b028c0","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Trusted device expiry updated"}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w19
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for non-existent user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768511800680,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["2blkiQyJZRiWOThIBR6z_","all_sessions_revoked","security","2blkiQyJZRiWOThIBR6z_",null,"::ffff:127.0.0.1",null,"2026-01-15T21:16:40.633Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"2blkiQyJZRiWOThIBR6z_","eventType":"all_sessions_revoked","msg":"Failed to log security event"}
{"level":50,"time":1768511800681,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["2blkiQyJZRiWOThIBR6z_","all_sessions_revoked","security","2blkiQyJZRiWOThIBR6z_",null,"::ffff:127.0.0.1",null,"2026-01-15T21:16:40.633Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Error revoking all sessions"}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w18.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w18.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768511800723,"env":"test","module":"auth-routes","email":"nonexistent@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":30,"time":1768511800807,"env":"test","module":"auth-routes","userId":"75edde291791999ed9fdfb6d39d60943","msg":"User logged in successfully"}
{"level":50,"time":1768511800825,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for non-existent user
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768511800856,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["75edde291791999ed9fdfb6d39d60943","login_success","security","75edde291791999ed9fdfb6d39d60943","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:40.807Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:40.807Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"75edde291791999ed9fdfb6d39d60943","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould generate unique backup codes
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 75edde291791999ed9fdfb6d39d60943,login_success,security,75edde291791999ed9fdfb6d39d60943,{"metadata":{"timestamp":"2026-01-15T21:16:40.807Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:40.807Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'75edde291791999ed9fdfb6d39d60943'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'75edde291791999ed9fdfb6d39d60943'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:40.807Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:40.807Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511800856,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["75edde291791999ed9fdfb6d39d60943","login_success","security","75edde291791999ed9fdfb6d39d60943","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:40.807Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:40.807Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768511800863,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768511800868,"env":"test","module":"user-credentials-repository","userId":"mQrbtJbRTJS0m6apF-Bav","msg":"User credentials created"}
{"level":30,"time":1768511800917,"env":"test","module":"auth-service","tokenHash":"e79c0cfdb52cf5100e0dc2d02647922fb86b3f9b3e01702d1ec5b629cb702689","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould exclude revoked sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511801030,"env":"test","module":"user-credentials-repository","userId":"j3lsStCPmPBW3Iky-onbZ","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511801212,"env":"test","module":"user-credentials-repository","userId":"50dc6f85-008e-48fd-8e1a-e5019e0bddbf","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511801252,"env":"test","module":"auth-routes","userId":"j3lsStCPmPBW3Iky-onbZ","msg":"All other sessions revoked"}
{"level":50,"time":1768511801297,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["j3lsStCPmPBW3Iky-onbZ","all_sessions_revoked","security","j3lsStCPmPBW3Iky-onbZ",null,"::ffff:127.0.0.1",null,"2026-01-15T21:16:41.253Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"j3lsStCPmPBW3Iky-onbZ","eventType":"all_sessions_revoked","msg":"Failed to log security event"}
{"level":50,"time":1768511801298,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["j3lsStCPmPBW3Iky-onbZ","all_sessions_revoked","security","j3lsStCPmPBW3Iky-onbZ",null,"::ffff:127.0.0.1",null,"2026-01-15T21:16:41.253Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Error revoking all sessions"}
{"level":50,"time":1768511801311,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768511801314,"env":"test","module":"email-queue","jobId":"2f347b0f-0015-4519-9e44-12f6b4b1af80","to":"test-1768511800828-eztvcd@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w20
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w20,public

{"level":30,"time":1768511801362,"env":"test","module":"auth-routes","userId":"50dc6f85-008e-48fd-8e1a-e5019e0bddbf","email":"test-1768511800828-eztvcd@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 403 for unverified email
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w20 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w20%2Cpublic

{"level":30,"time":1768511801374,"env":"test","msg":"DB: initializing... Local"}
{"level":40,"time":1768511801407,"env":"test","msg":"Failed to parse legacy string condition: \"trigger == \", defaulting to visible"}
{"level":40,"time":1768511801407,"env":"test","msg":"Failed to parse legacy string condition: \"trigger == \", defaulting to visible"}
{"level":30,"time":1768511801412,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511801441,"env":"test","module":"user-credentials-repository","userId":"GdNIiCUb14caIw9avS_SK","msg":"User credentials created"}
{"level":50,"time":1768511801457,"env":"test","module":"auth-routes","email":"test-1768511800688-0zo3e@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768511801491,"env":"test","module":"auth-routes","userId":"3184ff3f5cc5a60bd1d2a158ff28bfe6","msg":"User logged in successfully"}
{"level":30,"time":1768511801492,"env":"test","module":"auth-service","tokenHash":"c7ccbf079233540138b96369ac704b3b0a8c12d7233c073565ca6099a24f49bc","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":50,"time":1768511801541,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["3184ff3f5cc5a60bd1d2a158ff28bfe6","login_success","security","3184ff3f5cc5a60bd1d2a158ff28bfe6","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:41.491Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:41.491Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"3184ff3f5cc5a60bd1d2a158ff28bfe6","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould exclude revoked sessions
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 3184ff3f5cc5a60bd1d2a158ff28bfe6,login_success,security,3184ff3f5cc5a60bd1d2a158ff28bfe6,{"metadata":{"timestamp":"2026-01-15T21:16:41.491Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:41.491Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'3184ff3f5cc5a60bd1d2a158ff28bfe6'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'3184ff3f5cc5a60bd1d2a158ff28bfe6'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:41.491Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:41.491Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511801541,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["3184ff3f5cc5a60bd1d2a158ff28bfe6","login_success","security","3184ff3f5cc5a60bd1d2a158ff28bfe6","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:41.491Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:41.491Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould exclude revoked sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768511801559,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts[2m > [22m[2mDataVault Autonumber Integration Tests
[22m[39mError cleaning up table: Error: Table not found
    at DatavaultTablesService.verifyTenantOwnership (C:/Users/scoot/poll/VaultLogic/server/services/DatavaultTablesService.ts:152:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at DatavaultTablesService.deleteTable (C:/Users/scoot/poll/VaultLogic/server/services/DatavaultTablesService.ts:290:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/datavault.autonumber.test.ts:91:9

{"level":30,"time":1768511801566,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511801567,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/integration/datavault.autonumber.test.ts [2m([22m[2m5 tests[22m[2m | [22m[31m5 failed[39m[2m)[22m[33m 9891[2mms[22m[39m
[31m     [31m√ó[31m should generate basic autonumber without prefix[39m[33m 352[2mms[22m[39m
[31m     [31m√ó[31m should generate autonumber with prefix[39m[33m 359[2mms[22m[39m
[31m     [31m√ó[31m should generate autonumber with yearly reset format[39m[33m 343[2mms[22m[39m
[31m     [31m√ó[31m should be atomic and prevent race conditions[39m[33m 352[2mms[22m[39m
[31m     [31m√ó[31m should prevent manual updates to autonumber values[39m[33m 336[2mms[22m[39m
{"level":30,"time":1768511801646,"env":"test","module":"user-credentials-repository","userId":"L-jXbxW5AQAu3rXzn2bxa","msg":"User credentials created"}
{"level":40,"time":1768511801742,"env":"test","module":"auth-routes","userId":"50dc6f85-008e-48fd-8e1a-e5019e0bddbf","email":"test-1768511800828-eztvcd@example.com","msg":"Login blocked: email not verified"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 403 for unverified email
[22m[39mLogin Failed DEBUG: EmailNotVerifiedError: Please verify your email before logging in. Check your inbox for the verification link.
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:90:11)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_006'[39m,
  statusCode: [33m403[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768511801743,"env":"test","module":"auth-routes","error":{"name":"EmailNotVerifiedError","code":"AUTH_006","statusCode":403,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w20, public

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39m[TEST UTILS] MFA Secret verified for 2abcebab6109ab4f8b88eb8a948fee3d

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w20
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768511801837,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511801837,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w19.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w19.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [31m‚ùØ[39m tests/integration/regression-REG-1.test.ts [2m([22m[2m8 tests[22m[2m | [22m[31m5 failed[39m[2m)[22m[33m 3310[2mms[22m[39m
[31m       [31m√ó[31m should block Next when required visible question is empty[39m[32m 56[2mms[22m[39m
[31m       [31m√ó[31m should NOT block Next when required question is hidden[39m[33m 348[2mms[22m[39m
[31m       [31m√ó[31m should block when required becomes visible and is empty[39m[33m 343[2mms[22m[39m
[31m       [31m√ó[31m should skip hidden required page entirely[39m[33m 333[2mms[22m[39m
[31m       [31m√ó[31m should enforce required on visible page[39m[33m 351[2mms[22m[39m
       [32m‚úì[39m should evaluate visibility consistently across modes[32m 2[2mms[22m[39m
       [32m‚úì[39m should handle malformed visibility expression gracefully[32m 1[2mms[22m[39m
       [32m‚úì[39m should handle missing variable in visibility expression[32m 0[2mms[22m[39m
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w21
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w21,public

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w21 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w21%2Cpublic

{"level":30,"time":1768511801922,"env":"test","msg":"DB: initializing... Local"}
{"level":50,"time":1768511801961,"env":"test","module":"auth-routes","email":"test-1768511800688-0zo3e@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

{"level":30,"time":1768511801966,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511801998,"env":"test","module":"user-credentials-repository","userId":"VO76uxXCu3JvSBRivCxPM","msg":"User credentials created"}
{"level":50,"time":1768511802002,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768511802034,"env":"test","module":"user-credentials-repository","userId":"ovwgIS-rFn3oAM2AaySuO","msg":"User credentials created"}
{"level":50,"time":1768511802063,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511802085,"env":"test","module":"auth-service","tokenHash":"275839b2a5e83e23f325f25250be19b82819d1590ef020db372b1e0270118175","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould record failed login attempt
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould store hashed backup codes
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w21, public

{"level":30,"time":1768511802326,"env":"test","module":"auth-routes","userId":"3184ff3f5cc5a60bd1d2a158ff28bfe6","msg":"User logged in successfully"}
{"level":30,"time":1768511802335,"env":"test","module":"user-credentials-repository","userId":"ZOB3RqOogd-WduZwuPDmt","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w21
‚è© Schema reused, skipping migrations.

{"level":50,"time":1768511802371,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["3184ff3f5cc5a60bd1d2a158ff28bfe6","login_success","security","3184ff3f5cc5a60bd1d2a158ff28bfe6","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:42.326Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:42.326Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"3184ff3f5cc5a60bd1d2a158ff28bfe6","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould exclude revoked sessions
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 3184ff3f5cc5a60bd1d2a158ff28bfe6,login_success,security,3184ff3f5cc5a60bd1d2a158ff28bfe6,{"metadata":{"timestamp":"2026-01-15T21:16:42.326Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:42.326Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'3184ff3f5cc5a60bd1d2a158ff28bfe6'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'3184ff3f5cc5a60bd1d2a158ff28bfe6'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:42.326Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:42.326Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511802371,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["3184ff3f5cc5a60bd1d2a158ff28bfe6","login_success","security","3184ff3f5cc5a60bd1d2a158ff28bfe6","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:42.326Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:42.326Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w20.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w20.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511802442,"env":"test","module":"auth-routes","userId":"ZOB3RqOogd-WduZwuPDmt","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/analytics_service.test.ts[2m > [22m[2mAnalytics Service Integration
[22m[39mMANUAL PATCH: Applied FK fix for workflow_run_events AND workflow_run_metrics

{"level":50,"time":1768511802528,"env":"test","module":"auth-routes","email":"test-1768511801746-iek27o@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768511802566,"env":"test","module":"auth-routes","userId":"4f28544ce7db16d24fb2ae9c52c68819","msg":"User logged in successfully"}
{"level":30,"time":1768511802589,"env":"test","module":"auth-routes","userId":"2abcebab6109ab4f8b88eb8a948fee3d","msg":"Login requires MFA verification"}
{"level":50,"time":1768511802612,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["4f28544ce7db16d24fb2ae9c52c68819","login_success","security","4f28544ce7db16d24fb2ae9c52c68819","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:42.566Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:42.566Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"4f28544ce7db16d24fb2ae9c52c68819","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 4f28544ce7db16d24fb2ae9c52c68819,login_success,security,4f28544ce7db16d24fb2ae9c52c68819,{"metadata":{"timestamp":"2026-01-15T21:16:42.566Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:42.566Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'4f28544ce7db16d24fb2ae9c52c68819'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'4f28544ce7db16d24fb2ae9c52c68819'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:42.566Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:42.566Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511802613,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["4f28544ce7db16d24fb2ae9c52c68819","login_success","security","4f28544ce7db16d24fb2ae9c52c68819","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:42.566Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:42.566Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768511802619,"env":"test","module":"user-credentials-repository","userId":"YliG-NGSwy19uUdaamhEI","msg":"User credentials created"}
{"level":50,"time":1768511802645,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould record failed login attempt
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":30,"time":1768511802652,"env":"test","module":"auth-routes","userId":"aed7bebb61ea664eb1b381fc2625756c","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22m[2mOAuth2 Token Refresh Flow[2m > [22m[2mRefresh Token Lifecycle[2m > [22m[2mshould create refresh token on login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511802698,"env":"test","module":"mfa-service","userId":"2abcebab6109ab4f8b88eb8a948fee3d","msg":"TOTP verification successful"}
{"level":50,"time":1768511802703,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["aed7bebb61ea664eb1b381fc2625756c","login_success","security","aed7bebb61ea664eb1b381fc2625756c","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:42.652Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:42.652Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"aed7bebb61ea664eb1b381fc2625756c","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould store hashed backup codes
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: aed7bebb61ea664eb1b381fc2625756c,login_success,security,aed7bebb61ea664eb1b381fc2625756c,{"metadata":{"timestamp":"2026-01-15T21:16:42.652Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:42.652Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'aed7bebb61ea664eb1b381fc2625756c'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'aed7bebb61ea664eb1b381fc2625756c'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:42.652Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:42.652Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511802703,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["aed7bebb61ea664eb1b381fc2625756c","login_success","security","aed7bebb61ea664eb1b381fc2625756c","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:42.652Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:42.652Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768511802711,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768511802755,"env":"test","module":"auth-routes","userId":"2abcebab6109ab4f8b88eb8a948fee3d","msg":"MFA login successful"}
{"level":50,"time":1768511802772,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768511802845,"env":"test","module":"user-credentials-repository","userId":"e3zMpRDjQ-4Y-iluWiDtw","msg":"User credentials created"}
{"level":30,"time":1768511802913,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511802914,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768511802916,"env":"test","module":"auth-routes","userId":"2abcebab6109ab4f8b88eb8a948fee3d","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511802948,"env":"test","module":"auth-routes","userId":"e3zMpRDjQ-4Y-iluWiDtw","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Device marked as trusted"}
 [31m‚ùØ[39m tests/integration/auth/oauth2.callback.test.ts [2m([22m[2m16 tests[22m[2m | [22m[31m16 failed[39m[2m)[22m[33m 1414[2mms[22m[39m
[31m       [31m√ó[31m should initiate OAuth2 3-legged flow and generate authorization URL[39m[32m 7[2mms[22m[39m
[31m       [31m√ó[31m should include optional scope in authorization URL[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should validate valid OAuth2 state token[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should reject invalid OAuth2 state token[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should reject expired OAuth2 state token[39m[32m 0[2mms[22m[39m
[31m       [31m√ó[31m should clean up OAuth2 state after use[39m[32m 0[2mms[22m[39m
[31m       [31m√ó[31m should handle callback with missing state parameter[39m[32m 0[2mms[22m[39m
[31m       [31m√ó[31m should handle callback with missing code parameter[39m[32m 0[2mms[22m[39m
[31m       [31m√ó[31m should handle OAuth2 provider error responses[39m[32m 0[2mms[22m[39m
[31m       [31m√ó[31m should track OAuth2 connection status[39m[32m 0[2mms[22m[39m
[31m       [31m√ó[31m should store OAuth2 state in connection metadata[39m[32m 0[2mms[22m[39m
[31m       [31m√ó[31m should use cryptographically secure random state[39m[32m 0[2mms[22m[39m
[31m       [31m√ó[31m should prevent state reuse after validation[39m[32m 0[2mms[22m[39m
[31m       [31m√ó[31m should include PKCE support metadata in state record[39m[32m 0[2mms[22m[39m
[31m       [31m√ó[31m should validate redirect URI matches allowed URIs[39m[32m 0[2mms[22m[39m
[31m       [31m√ó[31m should encode redirect URI in authorization URL[39m[32m 0[2mms[22m[39m
 [31m‚ùØ[39m tests/unit/services/PdfQueueService.test.ts [2m([22m[2m15 tests[22m[2m | [22m[31m15 failed[39m[2m)[22m[33m 11701[2mms[22m[39m
[31m       [31m√ó[31m should enqueue a PDF conversion job[39m[33m 704[2mms[22m[39m
[31m       [31m√ó[31m should create output with empty storagePath initially[39m[33m 685[2mms[22m[39m
[31m       [31m√ó[31m should return job status for pending job[39m[33m 697[2mms[22m[39m
[31m       [31m√ó[31m should return null for non-existent job[39m[33m 692[2mms[22m[39m
[31m       [31m√ó[31m should parse attempt count from error field[39m[33m 699[2mms[22m[39m
[31m       [31m√ó[31m should convert DOCX to PDF immediately[39m[33m 698[2mms[22m[39m
[31m       [31m√ó[31m should handle conversion errors gracefully[39m[33m 702[2mms[22m[39m
[31m       [31m√ó[31m should start and stop service[39m[33m 711[2mms[22m[39m
[31m       [31m√ó[31m should not start if already running[39m[33m 694[2mms[22m[39m
[31m       [31m√ó[31m should handle stop when not running[39m[33m 713[2mms[22m[39m
[31m       [31m√ó[31m should process pending jobs when queue is processed[39m[33m 683[2mms[22m[39m
[31m       [31m√ó[31m should process multiple jobs in batch[39m[33m 705[2mms[22m[39m
[31m       [31m√ó[31m should handle missing DOCX output gracefully[39m[33m 709[2mms[22m[39m
[31m       [31m√ó[31m should support enqueue within transaction[39m[33m 705[2mms[22m[39m
[31m       [31m√ó[31m should support convertImmediate within transaction[39m[33m 697[2mms[22m[39m
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w22
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w22,public

{"level":30,"time":1768511803103,"env":"test","module":"auth-routes","userId":"e3zMpRDjQ-4Y-iluWiDtw","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Trusted device expiry updated"}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w22 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w22%2Cpublic

{"level":30,"time":1768511803110,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511803159,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511803224,"env":"test","module":"auth-routes","userId":"YliG-NGSwy19uUdaamhEI","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768511803275,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["YliG-NGSwy19uUdaamhEI","login_success","security","YliG-NGSwy19uUdaamhEI","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:43.225Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:43.225Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"YliG-NGSwy19uUdaamhEI","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22m[2mOAuth2 Token Refresh Flow[2m > [22m[2mRefresh Token Lifecycle[2m > [22m[2mshould create refresh token on login
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: YliG-NGSwy19uUdaamhEI,login_success,security,YliG-NGSwy19uUdaamhEI,{"metadata":{"timestamp":"2026-01-15T21:16:43.225Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:43.225Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'YliG-NGSwy19uUdaamhEI'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'YliG-NGSwy19uUdaamhEI'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:43.225Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:43.225Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511803275,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["YliG-NGSwy19uUdaamhEI","login_success","security","YliG-NGSwy19uUdaamhEI","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:43.225Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:43.225Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768511803402,"env":"test","module":"auth-routes","userId":"2abcebab6109ab4f8b88eb8a948fee3d","msg":"Login requires MFA verification"}
{"level":30,"time":1768511803473,"env":"test","module":"user-credentials-repository","userId":"5NS7io_rA8z5k6g3s-rA7","msg":"User credentials created"}
{"level":30,"time":1768511803505,"env":"test","module":"mfa-service","userId":"2abcebab6109ab4f8b88eb8a948fee3d","msg":"TOTP verification successful"}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w22, public

{"level":30,"time":1768511803552,"env":"test","module":"auth-routes","userId":"2abcebab6109ab4f8b88eb8a948fee3d","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w22
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768511803581,"env":"test","module":"auth-routes","userId":"5NS7io_rA8z5k6g3s-rA7","deviceCount":2,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w21.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w21.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511803630,"env":"test","module":"user-credentials-repository","userId":"Ym6vvR248ow6SZz14MTVw","msg":"User credentials created"}
{"level":30,"time":1768511803710,"env":"test","module":"auth-routes","userId":"2abcebab6109ab4f8b88eb8a948fee3d","deviceFingerprint":"091366faa1882b5c8dc1cba02126615a77a378274bbfd3375e821aa38bdd1b4f","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return requiresMfa=true for MFA-enabled users
[22m[39m[TEST UTILS] MFA Secret verified for 5741ae5eedade2816de679bd6a03e36e

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511803866,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768511803867,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/integration/analytics_preservation.test.ts [2m([22m[2m1 test[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 1196[2mms[22m[39m
[31m     [31m√ó[31m should preserve lifetime user count when a user is deleted[39m[32m 7[2mms[22m[39m
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould complete MFA setup and login with TOTP
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511803945,"env":"test","module":"user-credentials-repository","userId":"UXSTMgQ4VdaJ6EdF7FqnT","msg":"User credentials created"}
{"level":30,"time":1768511803984,"env":"test","module":"writeback-execution-service","runId":"e90ec721-706b-4b69-a6d9-8c559fce9beb","workflowId":"cb4d887d-72f4-423c-b863-0bd4dea3b017","msg":"Executing writeback mappings for completed run"}
{"level":30,"time":1768511804036,"env":"test","runId":"e90ec721-706b-4b69-a6d9-8c559fce9beb","service":"DocumentGenerationService","msg":"Starting document generation for run"}
{"level":30,"time":1768511804042,"env":"test","module":"auth-routes","userId":"UXSTMgQ4VdaJ6EdF7FqnT","deviceCount":0,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return requiresMfa=true for MFA-enabled users
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511804117,"env":"test","module":"user-credentials-repository","userId":"XHgxH5izdx4G7jxhbXl1G","msg":"User credentials created"}
{"level":40,"time":1768511804136,"env":"test","runId":"e90ec721-706b-4b69-a6d9-8c559fce9beb","service":"DocumentGenerationService","allSections":[],"runId":"e90ec721-706b-4b69-a6d9-8c559fce9beb","msg":"No Final Documents sections found, skipping generation. This might cause the frontend to hang."}
{"level":30,"time":1768511804137,"env":"test","runId":"e90ec721-706b-4b69-a6d9-8c559fce9beb","msg":"Documents generated successfully"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould require MFA for enabled users
[22m[39m[TEST UTILS] MFA Secret verified for 92683e893bb36749ceb4dfea1e786415

{"level":30,"time":1768511804220,"env":"test","module":"auth-routes","userId":"2abcebab6109ab4f8b88eb8a948fee3d","msg":"Login requires MFA verification"}
{"level":30,"time":1768511804274,"env":"test","module":"auth-routes","userId":"90a6c1707af485105781c484916c9cda","msg":"User logged in successfully"}
{"level":50,"time":1768511804325,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["90a6c1707af485105781c484916c9cda","login_success","security","90a6c1707af485105781c484916c9cda","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:44.274Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:44.274Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"90a6c1707af485105781c484916c9cda","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 90a6c1707af485105781c484916c9cda,login_success,security,90a6c1707af485105781c484916c9cda,{"metadata":{"timestamp":"2026-01-15T21:16:44.274Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:44.274Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'90a6c1707af485105781c484916c9cda'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'90a6c1707af485105781c484916c9cda'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:44.274Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:44.274Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511804325,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["90a6c1707af485105781c484916c9cda","login_success","security","90a6c1707af485105781c484916c9cda","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:44.274Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:44.274Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768511804325,"env":"test","module":"mfa-service","userId":"2abcebab6109ab4f8b88eb8a948fee3d","msg":"TOTP verification successful"}
[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511804379,"env":"test","module":"auth-routes","userId":"2abcebab6109ab4f8b88eb8a948fee3d","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768511804394,"env":"test","module":"user-credentials-repository","userId":"EQZGk0M0WBp7TRkP8ZiYv","msg":"User credentials created"}
{"level":30,"time":1768511804407,"env":"test","module":"auth-routes","userId":"b31139b2eefe91dab2cc3b7adc2103d4","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768511804452,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["b31139b2eefe91dab2cc3b7adc2103d4","login_success","security","b31139b2eefe91dab2cc3b7adc2103d4","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:44.407Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:44.407Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"b31139b2eefe91dab2cc3b7adc2103d4","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould complete MFA setup and login with TOTP
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: b31139b2eefe91dab2cc3b7adc2103d4,login_success,security,b31139b2eefe91dab2cc3b7adc2103d4,{"metadata":{"timestamp":"2026-01-15T21:16:44.407Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:44.407Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'b31139b2eefe91dab2cc3b7adc2103d4'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'b31139b2eefe91dab2cc3b7adc2103d4'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:44.407Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:44.407Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511804452,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["b31139b2eefe91dab2cc3b7adc2103d4","login_success","security","b31139b2eefe91dab2cc3b7adc2103d4","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:44.407Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:44.407Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768511804459,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould require MFA for enabled users
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511804484,"env":"test","module":"auth-routes","userId":"2abcebab6109ab4f8b88eb8a948fee3d","deviceCount":2,"msg":"Listed trusted devices"}
{"level":30,"time":1768511804517,"env":"test","module":"user-credentials-repository","userId":"TXydRAeXCXMdM3wDaIFuk","msg":"User credentials created"}
{"level":30,"time":1768511804549,"env":"test","module":"auth-routes","userId":"EQZGk0M0WBp7TRkP8ZiYv","deviceId":"34379392-c55b-4af7-90ab-c8e59811675d","msg":"Trusted device revoked"}
{"level":30,"time":1768511804569,"env":"test","module":"auth-routes","userId":"5741ae5eedade2816de679bd6a03e36e","msg":"Login requires MFA verification"}
[90mstderr[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":30,"time":1768511804921,"env":"test","module":"user-credentials-repository","userId":"1GKsGphYTJG8veulsS4Ye","msg":"User credentials created"}
{"level":30,"time":1768511804956,"env":"test","module":"auth-routes","userId":"92683e893bb36749ceb4dfea1e786415","msg":"Login requires MFA verification"}
{"level":30,"time":1768511805061,"env":"test","module":"user-credentials-repository","userId":"AZEGj9uOUg3wUBEJ9KWRf","msg":"User credentials created"}
{"level":30,"time":1768511805217,"env":"test","module":"auth-routes","userId":"90a6c1707af485105781c484916c9cda","msg":"User logged in successfully"}
{"level":50,"time":1768511805267,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["90a6c1707af485105781c484916c9cda","login_success","security","90a6c1707af485105781c484916c9cda","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:45.218Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:45.218Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"90a6c1707af485105781c484916c9cda","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 90a6c1707af485105781c484916c9cda,login_success,security,90a6c1707af485105781c484916c9cda,{"metadata":{"timestamp":"2026-01-15T21:16:45.218Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:45.218Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'90a6c1707af485105781c484916c9cda'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'90a6c1707af485105781c484916c9cda'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:45.218Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:45.218Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511805267,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["90a6c1707af485105781c484916c9cda","login_success","security","90a6c1707af485105781c484916c9cda","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:45.218Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:45.218Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768511805274,"env":"test","module":"user-credentials-repository","userId":"kVez5x8qozqZkyz9uonzM","msg":"User credentials created"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

{"level":30,"time":1768511805433,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511805434,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/integration/api.expression-validation.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstderr[2m | tests/integration/api.projects.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

 [32m‚úì[39m tests/unit/repositories/WorkflowTemplateRepository.test.ts [2m([22m[2m19 tests[22m[2m)[22m[33m 14366[2mms[22m[39m
       [33m[2m‚úì[22m[39m should create a workflow template mapping [33m 643[2mms[22m[39m
       [33m[2m‚úì[22m[39m should create non-primary mapping by default [33m 614[2mms[22m[39m
       [33m[2m‚úì[22m[39m should find all templates for a workflow version [33m 709[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return empty array for version with no templates [33m 625[2mms[22m[39m
       [33m[2m‚úì[22m[39m should order by createdAt desc (newest first) [33m 742[2mms[22m[39m
       [33m[2m‚úì[22m[39m should find mapping by workflow version and key [33m 647[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return undefined for non-existent key [33m 677[2mms[22m[39m
       [33m[2m‚úì[22m[39m should find primary template for workflow version [33m 718[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return undefined when no primary template exists [33m 689[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set a template as primary and unset others [33m 874[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle setting primary when none existed before [33m 861[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not delete mapping if workflow version does not match [33m 783[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return true if key exists in workflow version [33m 657[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return false if key does not exist [33m 606[2mms[22m[39m
       [33m[2m‚úì[22m[39m should exclude specified id when checking existence [33m 654[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return true if key exists on different mapping [33m 751[2mms[22m[39m
       [33m[2m‚úì[22m[39m should update mapping fields [33m 675[2mms[22m[39m
       [33m[2m‚úì[22m[39m should find mapping by id [33m 652[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return undefined for non-existent id [33m 599[2mms[22m[39m
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for 23d848d3701707e89f2283ec0d950594

{"level":30,"time":1768511805688,"env":"test","module":"user-credentials-repository","userId":"G_PTNTol_BdX2TiGUlAzm","msg":"User credentials created"}
{"level":30,"time":1768511805732,"env":"test","module":"user-credentials-repository","userId":"PiecIPIhz1eP0wixMdr9u","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould login with backup code when TOTP unavailable
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511805793,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511805794,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

 [32m‚úì[39m tests/integration/analytics_service.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 4835[2mms[22m[39m
     [33m[2m‚úì[22m[39m should generate events and metrics on run completion [33m 2933[2mms[22m[39m
{"level":50,"time":1768511805987,"env":"test","module":"auth-routes","email":"test-1768511805143-m06l5g@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould complete MFA login with valid TOTP
[22m[39m[TEST UTILS] MFA Secret verified for 65514c009427252c977c1b663c759c16

{"level":50,"time":1768511806084,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511806196,"env":"test","module":"auth-routes","userId":"90a6c1707af485105781c484916c9cda","msg":"User logged in successfully"}
{"level":30,"time":1768511806200,"env":"test","module":"user-credentials-repository","userId":"Ag731ZnRJR8bXM-i3VBtJ","msg":"User credentials created"}
{"level":50,"time":1768511806247,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["90a6c1707af485105781c484916c9cda","login_success","security","90a6c1707af485105781c484916c9cda","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:46.196Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:46.196Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"90a6c1707af485105781c484916c9cda","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 90a6c1707af485105781c484916c9cda,login_success,security,90a6c1707af485105781c484916c9cda,{"metadata":{"timestamp":"2026-01-15T21:16:46.196Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:46.196Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'90a6c1707af485105781c484916c9cda'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'90a6c1707af485105781c484916c9cda'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:46.196Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:46.196Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511806247,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["90a6c1707af485105781c484916c9cda","login_success","security","90a6c1707af485105781c484916c9cda","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:46.196Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:46.196Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768511806253,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768511806249,"env":"test","module":"auth-routes","userId":"e7e3aa07612b1b08dfd9a72250593b09","msg":"User logged in successfully"}
{"level":50,"time":1768511806300,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["e7e3aa07612b1b08dfd9a72250593b09","login_success","security","e7e3aa07612b1b08dfd9a72250593b09","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:46.250Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:46.250Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"e7e3aa07612b1b08dfd9a72250593b09","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould login with backup code when TOTP unavailable
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: e7e3aa07612b1b08dfd9a72250593b09,login_success,security,e7e3aa07612b1b08dfd9a72250593b09,{"metadata":{"timestamp":"2026-01-15T21:16:46.250Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:46.250Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'e7e3aa07612b1b08dfd9a72250593b09'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'e7e3aa07612b1b08dfd9a72250593b09'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:46.250Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:46.250Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511806300,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["e7e3aa07612b1b08dfd9a72250593b09","login_success","security","e7e3aa07612b1b08dfd9a72250593b09","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:46.250Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:46.250Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768511806307,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould complete MFA login with valid TOTP
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

{"level":30,"time":1768511806391,"env":"test","module":"auth-routes","userId":"23d848d3701707e89f2283ec0d950594","msg":"Login requires MFA verification"}
{"level":30,"time":1768511806407,"env":"test","module":"auth-service","tokenHash":"6bc19b277f4a22be40e50da05d340ef04ec9d45e61c2dc1c728ea37d08f0ca4d","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":50,"time":1768511806474,"env":"test","module":"auth-routes","email":"test-1768511805143-m06l5g@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768511806490,"env":"test","module":"mfa-service","userId":"23d848d3701707e89f2283ec0d950594","msg":"TOTP verification successful"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511806537,"env":"test","module":"auth-routes","userId":"23d848d3701707e89f2283ec0d950594","msg":"MFA login successful"}
[90mstderr[2m | tests/integration/api.runs.docx.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":50,"time":1768511806570,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511806652,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511806653,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768511806685,"env":"test","module":"auth-routes","userId":"23d848d3701707e89f2283ec0d950594","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
 [31m‚ùØ[39m tests/integration/auth/oauth2.sessions.test.ts [2m([22m[2m25 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 13540[2mms[22m[39m
       [33m[2m‚úì[22m[39m should list all active sessions for current user [33m 543[2mms[22m[39m
       [33m[2m‚úì[22m[39m should mark current session as current [33m 444[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return empty array when user has no active sessions [33m 439[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not include expired sessions [33m 426[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not include revoked sessions [33m 485[2mms[22m[39m
       [33m[2m‚úì[22m[39m should parse device name from user agent [33m 432[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 for unauthenticated request [33m 371[2mms[22m[39m
       [33m[2m‚úì[22m[39m should revoke a specific session [33m 587[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 404 for non-existent session [33m 355[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent revoking current session [33m 520[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent revoking another user's session [33m 520[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 for unauthenticated request [33m 330[2mms[22m[39m
[31m       [31m√ó[31m should revoke all sessions except current[39m[33m 852[2mms[22m[39m
[31m       [31m√ó[31m should revoke all trusted devices[39m[33m 604[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 400 when no active session found [33m 354[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 for unauthenticated request [33m 350[2mms[22m[39m
         [33m[2m‚úì[22m[39m should mark current device as trusted [33m 494[2mms[22m[39m
         [33m[2m‚úì[22m[39m should update existing trusted device expiry [33m 651[2mms[22m[39m
         [33m[2m‚úì[22m[39m should list all trusted devices [33m 436[2mms[22m[39m
         [33m[2m‚úì[22m[39m should not include revoked devices [33m 459[2mms[22m[39m
         [33m[2m‚úì[22m[39m should revoke a trusted device [33m 554[2mms[22m[39m
         [33m[2m‚úì[22m[39m should return 404 for non-existent device [33m 329[2mms[22m[39m
       [33m[2m‚úì[22m[39m should track IP address for sessions [33m 450[2mms[22m[39m
       [33m[2m‚úì[22m[39m should track user agent for sessions [33m 452[2mms[22m[39m
       [33m[2m‚úì[22m[39m should update lastUsedAt on token refresh [33m 821[2mms[22m[39m
{"level":30,"time":1768511806794,"env":"test","module":"auth-routes","userId":"23d848d3701707e89f2283ec0d950594","deviceCount":1,"msg":"Listed trusted devices"}
{"level":30,"time":1768511806858,"env":"test","module":"auth-routes","userId":"65514c009427252c977c1b663c759c16","msg":"Login requires MFA verification"}
{"level":30,"time":1768511806965,"env":"test","module":"mfa-service","userId":"65514c009427252c977c1b663c759c16","msg":"TOTP verification successful"}
{"level":50,"time":1768511806999,"env":"test","module":"auth-routes","email":"test-1768511805143-m06l5g@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768511807019,"env":"test","module":"auth-routes","userId":"65514c009427252c977c1b663c759c16","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768511807101,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":30,"time":1768511807101,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":30,"time":1768511807102,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

 [31m‚ùØ[39m tests/unit/services/WorkflowTemplateService.test.ts [2m([22m[2m21 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 15980[2mms[22m[39m
[31m       [31m√ó[31m should throw error if template belongs to different project[39m[33m 849[2mms[22m[39m
       [33m[2m‚úì[22m[39m should automatically unset other primaries when setting new primary [33m 1012[2mms[22m[39m
         [33m[2m‚úì[22m[39m should list all templates for workflow version [33m 768[2mms[22m[39m
         [33m[2m‚úì[22m[39m should return empty array for version with no templates [33m 521[2mms[22m[39m
         [33m[2m‚úì[22m[39m should get template mapping by id and version [33m 640[2mms[22m[39m
         [33m[2m‚úì[22m[39m should throw error if mapping not found [33m 510[2mms[22m[39m
         [33m[2m‚úì[22m[39m should get template by key [33m 651[2mms[22m[39m
         [33m[2m‚úì[22m[39m should throw error if key not found [33m 515[2mms[22m[39m
         [33m[2m‚úì[22m[39m should get primary template for workflow version [33m 771[2mms[22m[39m
         [33m[2m‚úì[22m[39m should return null when no primary template exists [33m 639[2mms[22m[39m
         [33m[2m‚úì[22m[39m should update mapping key [33m 706[2mms[22m[39m
         [33m[2m‚úì[22m[39m should update isPrimary flag [33m 796[2mms[22m[39m
         [33m[2m‚úì[22m[39m should throw error if new key already exists [33m 754[2mms[22m[39m
         [33m[2m‚úì[22m[39m should throw error if mapping not found [33m 515[2mms[22m[39m
         [33m[2m‚úì[22m[39m should unset other primaries when setting isPrimary to true [33m 1005[2mms[22m[39m
         [33m[2m‚úì[22m[39m should detach template from workflow version [33m 737[2mms[22m[39m
         [33m[2m‚úì[22m[39m should throw error if mapping not found [33m 515[2mms[22m[39m
         [33m[2m‚úì[22m[39m should set template as primary [33m 947[2mms[22m[39m
         [33m[2m‚úì[22m[39m should throw error if mapping not found [33m 496[2mms[22m[39m
         [33m[2m‚úì[22m[39m should support operations within a transaction [33m 732[2mms[22m[39m
         [33m[2m‚úì[22m[39m should rollback on transaction error [33m 744[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768511807379,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511807380,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/integration/collections.e2e.test.ts [2m([22m[2m22 tests[22m[2m | [22m[31m17 failed[39m[2m)[22m[33m 7591[2mms[22m[39m
       [32m‚úì[39m should create a collection[32m 109[2mms[22m[39m
       [32m‚úì[39m should list collections[32m 53[2mms[22m[39m
       [32m‚úì[39m should get a collection by ID[32m 49[2mms[22m[39m
       [32m‚úì[39m should update a collection[32m 103[2mms[22m[39m
[31m       [31m√ó[31m should create text field[39m[32m 159[2mms[22m[39m
[31m       [31m√ó[31m should create email field[39m[33m 448[2mms[22m[39m
[31m       [31m√ó[31m should create number field[39m[33m 466[2mms[22m[39m
[31m       [31m√ó[31m should create select field with options[39m[33m 433[2mms[22m[39m
[31m       [31m√ó[31m should create boolean field[39m[33m 449[2mms[22m[39m
[31m       [31m√ó[31m should list all fields[39m[33m 356[2mms[22m[39m
[31m       [31m√ó[31m should update field[39m[33m 336[2mms[22m[39m
[31m       [31m√ó[31m should create a record[39m[33m 413[2mms[22m[39m
[31m       [31m√ó[31m should create multiple records[39m[33m 396[2mms[22m[39m
[31m       [31m√ó[31m should list records with pagination[39m[33m 393[2mms[22m[39m
[31m       [31m√ó[31m should get a single record[39m[32m 45[2mms[22m[39m
[31m       [31m√ó[31m should update a record[39m[32m 49[2mms[22m[39m
[31m       [31m√ó[31m should find records by filters[39m[32m 102[2mms[22m[39m
[31m       [31m√ó[31m should delete a record[39m[32m 51[2mms[22m[39m
[31m       [31m√ó[31m should list collections with stats[39m[32m 102[2mms[22m[39m
       [33m[2m‚úì[22m[39m should enforce required fields [33m 409[2mms[22m[39m
[31m       [31m√ó[31m should validate field types[39m[33m 399[2mms[22m[39m
[31m       [31m√ó[31m should delete collection (cascade fields and records)[39m[33m 479[2mms[22m[39m
{"level":50,"time":1768511807527,"env":"test","module":"auth-routes","email":"test-1768511805143-m06l5g@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768511807619,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/api.runs.graph.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39m[TEST UTILS] MFA Secret verified for 43d247c884efa11443c931c8562bfd13

{"level":30,"time":1768511807977,"env":"test","module":"email-queue","jobId":"4f573d16-c894-4bb3-962c-9aeb4ab8eca7","to":"test-1768511807327-7aw5ja@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768511807977,"env":"test","module":"auth-service","email":"test-1768511807327-7aw5ja@example.com","msg":"Password reset email sent"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768511808054,"env":"test","module":"auth-routes","email":"test-1768511805143-m06l5g@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
[90mstderr[2m | tests/integration/api.snapshots.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould reject invalid TOTP during login
[22m[39m[TEST UTILS] MFA Secret verified for 34cf5b052825a54705f0e0fd0e2556cf

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768511808258,"env":"test","module":"account-lockout","userId":"b6bfc81f309f33d4031940a937ccb18e","email":"test-1768511805143-m06l5g@example.com","lockedUntil":"2026-01-15T21:31:48.198Z","msg":"Account locked due to too many failed attempts"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:84:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768511808259,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511808284,"env":"test","module":"email-queue","jobId":"d3906e62-29ca-4164-85e3-42bcea8ef200","to":"test-1768511807327-7aw5ja@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768511808284,"env":"test","module":"auth-service","email":"test-1768511807327-7aw5ja@example.com","msg":"Password reset email sent"}
[90mstderr[2m | tests/integration/api.workflows.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":40,"time":1768511808356,"env":"test","module":"auth-routes","userId":"b6bfc81f309f33d4031940a937ccb18e","email":"test-1768511805143-m06l5g@example.com","msg":"Login blocked: account locked"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mLogin Failed DEBUG: AccountLockedError: Account is locked until 2026-01-15T21:31:48.198Z
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:62:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_005'[39m,
  statusCode: [33m423[39m,
  isOperational: [33mtrue[39m,
  lockedUntil: [35m2026-01-15T21:31:48.198Z[39m,
  remainingMinutes: [33m15[39m
}

{"level":50,"time":1768511808357,"env":"test","module":"auth-routes","error":{"name":"AccountLockedError","code":"AUTH_005","statusCode":423,"isOperational":true,"lockedUntil":"2026-01-15T21:31:48.198Z","remainingMinutes":15},"msg":"Login failed"}
[90mstderr[2m | tests/integration/api.templates-runs.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511808470,"env":"test","module":"auth-routes","userId":"f4f8afe87e81e2ef22664109a8c64497","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould reject invalid TOTP during login
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

{"level":50,"time":1768511808517,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["f4f8afe87e81e2ef22664109a8c64497","login_success","security","f4f8afe87e81e2ef22664109a8c64497","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:48.470Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:48.470Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"f4f8afe87e81e2ef22664109a8c64497","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: f4f8afe87e81e2ef22664109a8c64497,login_success,security,f4f8afe87e81e2ef22664109a8c64497,{"metadata":{"timestamp":"2026-01-15T21:16:48.470Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:48.470Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'f4f8afe87e81e2ef22664109a8c64497'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'f4f8afe87e81e2ef22664109a8c64497'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:48.470Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:48.470Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511808517,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["f4f8afe87e81e2ef22664109a8c64497","login_success","security","f4f8afe87e81e2ef22664109a8c64497","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:48.470Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:48.470Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511808698,"env":"test","module":"user-credentials-repository","userId":"29804e5b5c03cf7c5f4522715e7dec26","msg":"User password updated"}
[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511808740,"env":"test","module":"auth-routes","userId":"43d247c884efa11443c931c8562bfd13","msg":"Login requires MFA verification"}
[90mstderr[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":30,"time":1768511808848,"env":"test","module":"mfa-service","userId":"43d247c884efa11443c931c8562bfd13","msg":"TOTP verification successful"}
{"level":50,"time":1768511808856,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["29804e5b5c03cf7c5f4522715e7dec26","password_reset","security","29804e5b5c03cf7c5f4522715e7dec26","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:48.800Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:48.800Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"29804e5b5c03cf7c5f4522715e7dec26","eventType":"password_reset","msg":"Failed to log security event"}
{"level":50,"time":1768511808856,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["29804e5b5c03cf7c5f4522715e7dec26","password_reset","security","29804e5b5c03cf7c5f4522715e7dec26","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:48.800Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:48.800Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Reset password error"}
{"level":30,"time":1768511808899,"env":"test","module":"auth-routes","userId":"43d247c884efa11443c931c8562bfd13","msg":"MFA login successful"}
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

{"level":30,"time":1768511808992,"env":"test","module":"auth-routes","userId":"34cf5b052825a54705f0e0fd0e2556cf","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768511809058,"env":"test","module":"auth-routes","userId":"43d247c884efa11443c931c8562bfd13","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":40,"time":1768511809102,"env":"test","module":"mfa-service","userId":"34cf5b052825a54705f0e0fd0e2556cf","msg":"TOTP verification failed"}
{"level":40,"time":1768511809102,"env":"test","module":"auth-routes","userId":"34cf5b052825a54705f0e0fd0e2556cf","msg":"MFA verification failed during login"}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511809217,"env":"test","module":"auth-routes","userId":"43d247c884efa11443c931c8562bfd13","deviceCount":0,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/logout[2m > [22m[2mshould logout and clear refresh token cookie
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511809372,"env":"test","module":"auth-routes","userId":"f4f8afe87e81e2ef22664109a8c64497","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

{"level":50,"time":1768511809424,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["f4f8afe87e81e2ef22664109a8c64497","login_success","security","f4f8afe87e81e2ef22664109a8c64497","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:49.372Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:49.372Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"f4f8afe87e81e2ef22664109a8c64497","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768511809424,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["f4f8afe87e81e2ef22664109a8c64497","login_success","security","f4f8afe87e81e2ef22664109a8c64497","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:49.372Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:49.372Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: f4f8afe87e81e2ef22664109a8c64497,login_success,security,f4f8afe87e81e2ef22664109a8c64497,{"metadata":{"timestamp":"2026-01-15T21:16:49.372Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:49.372Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'f4f8afe87e81e2ef22664109a8c64497'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'f4f8afe87e81e2ef22664109a8c64497'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:49.372Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:49.372Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/unit/api.ai.revise.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstderr[2m | tests/integration/datavault.permissions.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":30,"time":1768511809849,"env":"test","module":"auth-routes","userId":"64c8c984cbbda584af53fcf1decf1c16","msg":"User logged in successfully"}
{"level":50,"time":1768511809895,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["64c8c984cbbda584af53fcf1decf1c16","login_success","security","64c8c984cbbda584af53fcf1decf1c16","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:49.849Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:49.849Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"64c8c984cbbda584af53fcf1decf1c16","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/logout[2m > [22m[2mshould logout and clear refresh token cookie
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 64c8c984cbbda584af53fcf1decf1c16,login_success,security,64c8c984cbbda584af53fcf1decf1c16,{"metadata":{"timestamp":"2026-01-15T21:16:49.849Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:49.849Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'64c8c984cbbda584af53fcf1decf1c16'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'64c8c984cbbda584af53fcf1decf1c16'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:49.849Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:49.849Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511809895,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["64c8c984cbbda584af53fcf1decf1c16","login_success","security","64c8c984cbbda584af53fcf1decf1c16","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:49.849Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:49.849Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstderr[2m | tests/integration/intake.workflow.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould accept TOTP codes within 60-second window
[22m[39m[TEST UTILS] MFA Secret verified for 75d44ece10f6a05613f3f8c535537541

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mPassword Reset Flow[2m > [22m[2mshould invalidate all sessions after password reset
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511810266,"env":"test","module":"auth-routes","userId":"7d2ab1df07df2cfad8967d7cb49ba85c","msg":"User logged in successfully"}
{"level":50,"time":1768511810316,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["7d2ab1df07df2cfad8967d7cb49ba85c","login_success","security","7d2ab1df07df2cfad8967d7cb49ba85c","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:50.266Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:50.266Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"7d2ab1df07df2cfad8967d7cb49ba85c","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 7d2ab1df07df2cfad8967d7cb49ba85c,login_success,security,7d2ab1df07df2cfad8967d7cb49ba85c,{"metadata":{"timestamp":"2026-01-15T21:16:50.266Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:50.266Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'7d2ab1df07df2cfad8967d7cb49ba85c'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'7d2ab1df07df2cfad8967d7cb49ba85c'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:50.266Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:50.266Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511810316,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["7d2ab1df07df2cfad8967d7cb49ba85c","login_success","security","7d2ab1df07df2cfad8967d7cb49ba85c","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:50.266Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:50.266Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768511810322,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for 70d7421cb46efea1b3048fb017fd493b

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/unit/api.ai.logic.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstderr[2m | tests/unit/debug_import.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstderr[2m | tests/integration/js_helpers.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould accept TOTP codes within 60-second window
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511810753,"env":"test","module":"auth-routes","userId":"89f82cc7d21c4bca24059bdf96ef8cef","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

{"level":50,"time":1768511810800,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["89f82cc7d21c4bca24059bdf96ef8cef","login_success","security","89f82cc7d21c4bca24059bdf96ef8cef","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:50.753Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:50.753Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"89f82cc7d21c4bca24059bdf96ef8cef","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mPassword Reset Flow[2m > [22m[2mshould invalidate all sessions after password reset
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 89f82cc7d21c4bca24059bdf96ef8cef,login_success,security,89f82cc7d21c4bca24059bdf96ef8cef,{"metadata":{"timestamp":"2026-01-15T21:16:50.753Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:50.753Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'89f82cc7d21c4bca24059bdf96ef8cef'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'89f82cc7d21c4bca24059bdf96ef8cef'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:50.753Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:50.753Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511810800,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["89f82cc7d21c4bca24059bdf96ef8cef","login_success","security","89f82cc7d21c4bca24059bdf96ef8cef","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:50.753Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:50.753Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstderr[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768511811017,"env":"test","module":"auth-routes","userId":"75d44ece10f6a05613f3f8c535537541","msg":"Login requires MFA verification"}
{"level":30,"time":1768511811114,"env":"test","module":"mfa-service","userId":"75d44ece10f6a05613f3f8c535537541","msg":"TOTP verification successful"}
{"level":30,"time":1768511811121,"env":"test","module":"user-credentials-repository","userId":"2-N5nWZBmOf3-ANb45dV6","msg":"User credentials created"}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

{"level":30,"time":1768511811169,"env":"test","module":"auth-routes","userId":"75d44ece10f6a05613f3f8c535537541","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould accept TOTP codes within 60-second window
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511811239,"env":"test","module":"auth-routes","userId":"70d7421cb46efea1b3048fb017fd493b","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/refresh-token[2m > [22m[2mshould refresh access token with valid refresh token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511811309,"env":"test","module":"email-queue","jobId":"e42b6f46-d007-481c-8e85-e6ab319d210c","to":"test-1768511809752-ayt0od@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768511811309,"env":"test","module":"auth-service","email":"test-1768511809752-ayt0od@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768511811356,"env":"test","module":"mfa-service","userId":"70d7421cb46efea1b3048fb017fd493b","msg":"TOTP verification successful"}
{"level":30,"time":1768511811410,"env":"test","module":"auth-routes","userId":"70d7421cb46efea1b3048fb017fd493b","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511811561,"env":"test","module":"auth-routes","userId":"70d7421cb46efea1b3048fb017fd493b","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768511811628,"env":"test","module":"user-credentials-repository","userId":"VIF61B_kv35HW93w0s3z7","msg":"User credentials created"}
{"level":30,"time":1768511811673,"env":"test","module":"auth-routes","userId":"75d44ece10f6a05613f3f8c535537541","msg":"Login requires MFA verification"}
[90mstderr[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":30,"time":1768511811687,"env":"test","module":"auth-service","tokenHash":"f5bcc2938f9879c456b741ed727eb5baa46612c72c2f1283e7677c739c7583c1","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768511811715,"env":"test","module":"auth-routes","userId":"70d7421cb46efea1b3048fb017fd493b","deviceCount":0,"msg":"Listed trusted devices"}
{"level":30,"time":1768511811723,"env":"test","module":"user-credentials-repository","userId":"89f82cc7d21c4bca24059bdf96ef8cef","msg":"User password updated"}
{"level":30,"time":1768511811776,"env":"test","module":"mfa-service","userId":"75d44ece10f6a05613f3f8c535537541","msg":"TOTP verification successful"}
{"level":30,"time":1768511811807,"env":"test","module":"auth-routes","userId":"12b3c325cd5cdd2f2743926ab74c2a76","msg":"User logged in successfully"}
{"level":30,"time":1768511811827,"env":"test","module":"auth-routes","userId":"75d44ece10f6a05613f3f8c535537541","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768511811860,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["12b3c325cd5cdd2f2743926ab74c2a76","login_success","security","12b3c325cd5cdd2f2743926ab74c2a76","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:51.807Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:51.807Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"12b3c325cd5cdd2f2743926ab74c2a76","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/refresh-token[2m > [22m[2mshould refresh access token with valid refresh token
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 12b3c325cd5cdd2f2743926ab74c2a76,login_success,security,12b3c325cd5cdd2f2743926ab74c2a76,{"metadata":{"timestamp":"2026-01-15T21:16:51.807Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:51.807Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'12b3c325cd5cdd2f2743926ab74c2a76'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'12b3c325cd5cdd2f2743926ab74c2a76'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:51.807Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:51.807Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511811860,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["12b3c325cd5cdd2f2743926ab74c2a76","login_success","security","12b3c325cd5cdd2f2743926ab74c2a76","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:51.807Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:51.807Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768511811864,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768511811869,"env":"test","module":"auth-service","tokenHash":"f54a775c226b07d91f8d0bb5c7bc3871cc133d0411741bdf382361f63e268cb2","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":50,"time":1768511811872,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["89f82cc7d21c4bca24059bdf96ef8cef","password_reset","security","89f82cc7d21c4bca24059bdf96ef8cef","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:51.819Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:51.819Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"89f82cc7d21c4bca24059bdf96ef8cef","eventType":"password_reset","msg":"Failed to log security event"}
{"level":50,"time":1768511811873,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["89f82cc7d21c4bca24059bdf96ef8cef","password_reset","security","89f82cc7d21c4bca24059bdf96ef8cef","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:51.819Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:51.819Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Reset password error"}
{"level":50,"time":1768511811879,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768511811906,"env":"test","module":"auth-service","tokenHash":"f5bcc2938f9879c456b741ed727eb5baa46612c72c2f1283e7677c739c7583c1","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768511811956,"env":"test","module":"auth-service","userId":"VIF61B_kv35HW93w0s3z7","tokenHash":"f5bcc2938f9879c456b741ed727eb5baa46612c72c2f1283e7677c739c7583c1","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511812359,"env":"test","module":"user-credentials-repository","userId":"-3VMNOC7jVOlPcmDkYXrw","msg":"User credentials created"}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w43
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w43,public

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w43 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w43%2Cpublic

{"level":30,"time":1768511812546,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768511812595,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w45
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w45,public

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w45 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w45%2Cpublic

{"level":30,"time":1768511812736,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511812785,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":30,"time":1768511812804,"env":"test","module":"auth-routes","userId":"ed40b931c96b3b6caa29cd00524a7d5f","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould login with valid backup code
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511812843,"env":"test","module":"user-credentials-repository","userId":"pjJJ8jQEeB69Ra5gZStDk","msg":"User credentials created"}
{"level":50,"time":1768511812848,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["ed40b931c96b3b6caa29cd00524a7d5f","login_success","security","ed40b931c96b3b6caa29cd00524a7d5f","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:52.804Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:52.804Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"ed40b931c96b3b6caa29cd00524a7d5f","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould revoke specific session
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ed40b931c96b3b6caa29cd00524a7d5f,login_success,security,ed40b931c96b3b6caa29cd00524a7d5f,{"metadata":{"timestamp":"2026-01-15T21:16:52.804Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:52.804Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'ed40b931c96b3b6caa29cd00524a7d5f'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'ed40b931c96b3b6caa29cd00524a7d5f'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:52.804Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:52.804Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511812848,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["ed40b931c96b3b6caa29cd00524a7d5f","login_success","security","ed40b931c96b3b6caa29cd00524a7d5f","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:52.804Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:52.804Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for 36e77e0d67eb57eefbdf3023c557934a

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w44
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w44,public

{"level":30,"time":1768511812900,"env":"test","module":"auth-service","tokenHash":"542d80b3d4dc9f413eda8b7ec83705ca313d5dc2996516d51ffdd872d101c828","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w46
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w46,public

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w44 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w44%2Cpublic

{"level":30,"time":1768511812931,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w46 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w46%2Cpublic

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w43, public

{"level":30,"time":1768511812955,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511812981,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511812995,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w43
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w22.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w22.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w45, public

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w45
‚è© Schema reused, skipping migrations.

[90mstderr[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w43.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w43.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould rotate refresh token on each use
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511813311,"env":"test","module":"auth-routes","userId":"9fb2f9c7f72410ddc497c59e583e032d","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w46, public

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w44, public

{"level":50,"time":1768511813363,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["9fb2f9c7f72410ddc497c59e583e032d","login_success","security","9fb2f9c7f72410ddc497c59e583e032d","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:53.311Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:53.311Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"9fb2f9c7f72410ddc497c59e583e032d","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould login with valid backup code
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 9fb2f9c7f72410ddc497c59e583e032d,login_success,security,9fb2f9c7f72410ddc497c59e583e032d,{"metadata":{"timestamp":"2026-01-15T21:16:53.311Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:53.311Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'9fb2f9c7f72410ddc497c59e583e032d'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'9fb2f9c7f72410ddc497c59e583e032d'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:53.311Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:53.311Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511813363,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["9fb2f9c7f72410ddc497c59e583e032d","login_success","security","9fb2f9c7f72410ddc497c59e583e032d","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:53.311Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:53.311Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

{"level":50,"time":1768511813369,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/refresh-token[2m > [22m[2mshould rotate refresh token after use
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w46
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w44
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768511813431,"env":"test","module":"user-credentials-repository","userId":"SRQdyJDDkyPgExmLgRVtu","msg":"User credentials created"}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w45.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w45.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w45.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w45.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w47
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w47,public

{"level":30,"time":1768511813485,"env":"test","module":"auth-service","tokenHash":"4d998881f25286d0ea82f67657198d7bd8fdb92912a7e42cd96e5a0775aa2509","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w47 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w47%2Cpublic

{"level":30,"time":1768511813520,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511813564,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511813612,"env":"test","module":"auth-routes","userId":"36e77e0d67eb57eefbdf3023c557934a","msg":"Login requires MFA verification"}
{"level":30,"time":1768511813626,"env":"test","module":"auth-routes","userId":"ed40b931c96b3b6caa29cd00524a7d5f","msg":"User logged in successfully"}
{"level":50,"time":1768511813672,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["ed40b931c96b3b6caa29cd00524a7d5f","login_success","security","ed40b931c96b3b6caa29cd00524a7d5f","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:53.626Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:53.626Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"ed40b931c96b3b6caa29cd00524a7d5f","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould revoke specific session
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ed40b931c96b3b6caa29cd00524a7d5f,login_success,security,ed40b931c96b3b6caa29cd00524a7d5f,{"metadata":{"timestamp":"2026-01-15T21:16:53.626Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:53.626Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'ed40b931c96b3b6caa29cd00524a7d5f'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'ed40b931c96b3b6caa29cd00524a7d5f'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:53.626Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:53.626Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511813672,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["ed40b931c96b3b6caa29cd00524a7d5f","login_success","security","ed40b931c96b3b6caa29cd00524a7d5f","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:53.626Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:53.626Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768511813678,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768511813721,"env":"test","module":"mfa-service","userId":"36e77e0d67eb57eefbdf3023c557934a","msg":"TOTP verification successful"}
{"level":30,"time":1768511813763,"env":"test","module":"auth-routes","userId":"59e07deba53c3674be94bb2121bcf25f","msg":"User logged in successfully"}
{"level":30,"time":1768511813769,"env":"test","module":"auth-routes","userId":"36e77e0d67eb57eefbdf3023c557934a","msg":"MFA login successful"}
{"level":50,"time":1768511813809,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["59e07deba53c3674be94bb2121bcf25f","login_success","security","59e07deba53c3674be94bb2121bcf25f","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:53.763Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:53.763Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"59e07deba53c3674be94bb2121bcf25f","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould rotate refresh token on each use
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 59e07deba53c3674be94bb2121bcf25f,login_success,security,59e07deba53c3674be94bb2121bcf25f,{"metadata":{"timestamp":"2026-01-15T21:16:53.763Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:53.763Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'59e07deba53c3674be94bb2121bcf25f'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'59e07deba53c3674be94bb2121bcf25f'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:53.763Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:53.763Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511813809,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["59e07deba53c3674be94bb2121bcf25f","login_success","security","59e07deba53c3674be94bb2121bcf25f","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:53.763Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:53.763Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768511813816,"env":"test","module":"auth-service","tokenHash":"f854415c61b8bd8d70c25dca896c1702f6338b6d9e2fb9e14e52b30b246f10e0","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768511813835,"env":"test","module":"auth-routes","userId":"c245663e7963777adedb2d99a54c0e9c","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w48
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w48,public

{"level":50,"time":1768511813886,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["c245663e7963777adedb2d99a54c0e9c","login_success","security","c245663e7963777adedb2d99a54c0e9c","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:53.836Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:53.836Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"c245663e7963777adedb2d99a54c0e9c","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/refresh-token[2m > [22m[2mshould rotate refresh token after use
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: c245663e7963777adedb2d99a54c0e9c,login_success,security,c245663e7963777adedb2d99a54c0e9c,{"metadata":{"timestamp":"2026-01-15T21:16:53.836Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:53.836Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'c245663e7963777adedb2d99a54c0e9c'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'c245663e7963777adedb2d99a54c0e9c'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:53.836Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:53.836Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511813887,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["c245663e7963777adedb2d99a54c0e9c","login_success","security","c245663e7963777adedb2d99a54c0e9c","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:53.836Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:53.836Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768511813893,"env":"test","module":"auth-service","tokenHash":"87cd860c746edabb927e40c31ac5f32c7b05a89d893d17840cb753c503845a0d","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w48 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w48%2Cpublic

{"level":30,"time":1768511813901,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w47, public

{"level":30,"time":1768511813919,"env":"test","module":"auth-routes","userId":"36e77e0d67eb57eefbdf3023c557934a","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w49
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w49,public

{"level":30,"time":1768511813944,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w47
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w49 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w49%2Cpublic

[90mstderr[2m | tests/unit/services/AuthService.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): Error: [vitest] No "closeDatabase" export is defined on the "../../../server/db" mock. Did you forget to return it from "vi.mock"?
If you need to partially mock a module, you can use "importOriginal" helper inside:

    at VitestMocker.createError [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:311:17[90m)[39m
    at Object.get [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:384:16[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:144:34
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m {
  codeFrame: [32m'vi.mock(import("../../../server/db"), async (importOriginal) => {\n'[39m +
    [32m'  const actual = await importOriginal()\n'[39m +
    [32m'  return {\n'[39m +
    [32m'    ...actual,\n'[39m +
    [32m'    // your mocked methods\n'[39m +
    [32m'  }\n'[39m +
    [32m'})'[39m
}

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w44.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w46.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w44.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511814009,"env":"test","module":"user-credentials-repository","userId":"D5rFB0TSXNTeJqJIXiJwl","msg":"User credentials created"}
{"level":30,"time":1768511814027,"env":"test","module":"auth-routes","userId":"36e77e0d67eb57eefbdf3023c557934a","deviceCount":1,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w46.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511814064,"env":"test","module":"auth-service","tokenHash":"4d6a753f6c9ec8bfa61b9ad0a5a2d1de4bfeceb112902504a4b4f7307c419f2a","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould create placeholder user for non-existent email
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,2dc525b6-b931-40a8-8661-2caa539bb52f,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'2dc525b6-b931-40a8-8661-2caa539bb52f'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768511814180,"env":"test","module":"auth-routes","userId":"36e77e0d67eb57eefbdf3023c557934a","deviceId":"b0748191-24ec-4291-acd2-ab6b8a044261","msg":"Trusted device revoked"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mcreateOrganization[2m > [22m[2mshould create organization and auto-create admin membership
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,ac311171-f97b-4f55-bb3a-fdb0b668672e,{"after":{"name":"Test Org Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'ac311171-f97b-4f55-bb3a-fdb0b668672e'[39m,
    [32m'{"after":{"name":"Test Org Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:74:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w48, public

{"level":30,"time":1768511814317,"env":"test","module":"auth-service","tokenHash":"24d5cff4e17eff943c522efafd12332581d4e5f9b9474f0fc00dc1fca19bb83b","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,44993df4-1f41-42f6-b7ca-f7fa8994c381,organization.create,organization,8ebd9fa0-482d-4d6f-a180-1d88f3d04d5c,{"after":{"name":"Test Org Audit","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:58:17 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'44993df4-1f41-42f6-b7ca-f7fa8994c381'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'8ebd9fa0-482d-4d6f-a180-1d88f3d04d5c'[39m,
    [32m'{"after":{"name":"Test Org Audit","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:58:17 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768511814331,"env":"test","module":"auth-routes","userId":"36e77e0d67eb57eefbdf3023c557934a","deviceCount":0,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w48
‚è© Schema reused, skipping migrations.

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould transfer user-owned project to org
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,ca84b96f-008b-4d76-9876-bb4bc4993dd8,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'ca84b96f-008b-4d76-9876-bb4bc4993dd8'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w47.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w47.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511814393,"env":"test","module":"auth-service","tokenHash":"87cd860c746edabb927e40c31ac5f32c7b05a89d893d17840cb753c503845a0d","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768511814445,"env":"test","module":"auth-service","userId":"c245663e7963777adedb2d99a54c0e9c","tokenHash":"87cd860c746edabb927e40c31ac5f32c7b05a89d893d17840cb753c503845a0d","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768511814524,"env":"test","module":"auth-service","tokenHash":"41e27eac17060a62031d314a6f17ce4b511468fb82659f13e9a97697beeeb5d9","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #1: Project transfer cascades runs ownership[2m > [22m[2mshould cascade ownership to workflow runs when project is transferred
[22m[39mFailed to increment workflow stats: TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')
    at getTableColumns [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/utils.js:109:15[90m)[39m
    at PgSelectBuilder.from [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/query-builders/select.js:62:16[90m)[39m
    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)
    at SystemStatsRepository.incrementWorkflowsCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:118:16)
    at WorkflowRepository.create (C:/Users/scoot/poll/VaultLogic/server/repositories/WorkflowRepository.ts:30:35)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/services/WorkflowService.ts:123:24
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:124:24
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20

{"level":30,"time":1768511814594,"env":"test","module":"user-credentials-repository","userId":"SEnNsqTj8I3Wt2U240XbM","msg":"User credentials created"}
{"level":30,"time":1768511814631,"env":"test","module":"email-queue","jobId":"777c32a9-df7f-4a82-80e7-a6300031b7f5","to":"newuser_1768511812103@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

{"level":30,"time":1768511814644,"env":"test","module":"auth-service","tokenHash":"75be7df7a2088eb1db7c3f901fbadd30cd18b6260b8c094cc69eec420c017be0","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould transfer user-owned project to org
[22m[39mFailed to increment workflow stats: TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')
    at getTableColumns [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/utils.js:109:15[90m)[39m
    at PgSelectBuilder.from [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/query-builders/select.js:62:16[90m)[39m
    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)
    at SystemStatsRepository.incrementWorkflowsCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:118:16)
    at WorkflowRepository.create (C:/Users/scoot/poll/VaultLogic/server/repositories/WorkflowRepository.ts:30:35)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/services/WorkflowService.ts:123:24
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:97:30
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould create placeholder user for non-existent email
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,2dc525b6-b931-40a8-8661-2caa539bb52f,{"after":{"invitedEmail":"newuser_1768511812103@test.com","token":"6823a348d727748a4cd9a9d4c7d137493804ffd96b2c814032ee88d901bc2bcd"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'2dc525b6-b931-40a8-8661-2caa539bb52f'[39m,
    [32m'{"after":{"invitedEmail":"newuser_1768511812103@test.com","token":"6823a348d727748a4cd9a9d4c7d137493804ffd96b2c814032ee88d901bc2bcd"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:81:28
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould mark backup code as used
[22m[39m[TEST UTILS] MFA Secret verified for e2666a4dd143d42e4ebb2ecf2c2f1522

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking current session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511815026,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511815027,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/integration/auth/oauth2.token-refresh.test.ts [2m([22m[2m25 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 21914[2mms[22m[39m
       [33m[2m‚úì[22m[39m should refresh access token with valid refresh token [33m 643[2mms[22m[39m
       [33m[2m‚úì[22m[39m should rotate refresh token after use [33m 681[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 when refresh token is missing [33m 374[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 for invalid refresh token [33m 853[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 for expired refresh token [33m 742[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 for revoked refresh token [33m 546[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 when user is not found [33m 882[2mms[22m[39m
       [33m[2m‚úì[22m[39m should update refresh token metadata on rotation [33m 627[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle concurrent refresh token requests (token reuse detection) [33m 786[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set secure cookie in production [33m 600[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set proper cookie attributes [33m 580[2mms[22m[39m
       [33m[2m‚úì[22m[39m should include user role information in response [33m 592[2mms[22m[39m
[31m       [31m√ó[31m should create refresh token on login[39m[33m 1005[2mms[22m[39m
       [33m[2m‚úì[22m[39m should revoke refresh token on logout [33m 479[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle logout without refresh token gracefully [33m 394[2mms[22m[39m
       [33m[2m‚úì[22m[39m should support multiple active refresh tokens per user [33m 558[2mms[22m[39m
       [33m[2m‚úì[22m[39m should revoke all user tokens on password reset [33m 619[2mms[22m[39m
       [33m[2m‚úì[22m[39m should use cryptographically strong random tokens [33m 5386[2mms[22m[39m
       [33m[2m‚úì[22m[39m should hash refresh tokens before storing in database [33m 547[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent refresh token reuse after rotation [33m 725[2mms[22m[39m
       [33m[2m‚úì[22m[39m should validate token ownership [33m 507[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set HttpOnly flag to prevent XSS [33m 591[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set SameSite=Strict to prevent CSRF [33m 590[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set proper cookie path [33m 569[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set appropriate expiry (30 days) [33m 576[2mms[22m[39m
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w50
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w50,public

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w50 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w50%2Cpublic

{"level":30,"time":1768511815204,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mgetUserOrganizations[2m > [22m[2mshould return all organizations for user
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,37e2f23f-d933-4f0a-a9d0-433ea942b8ca,{"after":{"name":"User Org Test Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'37e2f23f-d933-4f0a-a9d0-433ea942b8ca'[39m,
    [32m'{"after":{"name":"User Org Test Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:100:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768511815241,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mComplete Organization Workflow[2m > [22m[2mStep 1: Create organization
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,47658add-bd9c-4c61-bc4c-91ab7e2d5630,organization.create,organization,8cf6dfcd-7752-4175-8e20-4b955a72c7f7,{"after":{"name":"Test Organization","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'47658add-bd9c-4c61-bc4c-91ab7e2d5630'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'8cf6dfcd-7752-4175-8e20-4b955a72c7f7'[39m,
    [32m'{"after":{"name":"Test Organization","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:92:19
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39m[TEST UTILS] MFA Secret verified for ac8ab7348f2abf750a3b684ad06536f8

{"level":30,"time":1768511815445,"env":"test","module":"auth-routes","userId":"4dedb34389de0e751275ee56eed7c2f7","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

{"level":50,"time":1768511815492,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["4dedb34389de0e751275ee56eed7c2f7","login_success","security","4dedb34389de0e751275ee56eed7c2f7","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:55.445Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:55.445Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"4dedb34389de0e751275ee56eed7c2f7","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking current session
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 4dedb34389de0e751275ee56eed7c2f7,login_success,security,4dedb34389de0e751275ee56eed7c2f7,{"metadata":{"timestamp":"2026-01-15T21:16:55.445Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:55.445Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'4dedb34389de0e751275ee56eed7c2f7'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'4dedb34389de0e751275ee56eed7c2f7'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:55.445Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:55.445Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511815492,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["4dedb34389de0e751275ee56eed7c2f7","login_success","security","4dedb34389de0e751275ee56eed7c2f7","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:55.445Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:55.445Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768511815498,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w50, public

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w50
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768511815674,"env":"test","module":"email-queue","jobId":"ff191794-a767-4c53-979a-9c7038c909d6","to":"test-1768511815099-md1ky@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768511815674,"env":"test","module":"auth-service","email":"test-1768511815099-md1ky@example.com","msg":"Password reset email sent"}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w48.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w48.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould detect and prevent refresh token reuse (token theft)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511815750,"env":"test","module":"email-queue","jobId":"5a70955d-5cc5-4335-ab5c-4e80e7226db4","to":"audit-user2@test.com","subject":"You've been invited to join Test Org Audit","msg":"Email added to queue"}
{"level":30,"time":1768511815838,"env":"test","module":"email-queue","jobId":"7e05cee8-5523-407a-882e-bbc53351ac17","to":"org-member@test.com","subject":"You've been invited to join Test Organization","msg":"Email added to queue"}
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #2: Invite acceptance race condition[2m > [22m[2mshould prevent double-acceptance via transaction
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,44993df4-1f41-42f6-b7ca-f7fa8994c381,organization.invite_send,organization,8ebd9fa0-482d-4d6f-a180-1d88f3d04d5c,{"after":{"invitedEmail":"audit-user2@test.com","token":"12bc22902e5449841699cfffb75194e2ca53f206a657606cf17448850a1f28cb"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'44993df4-1f41-42f6-b7ca-f7fa8994c381'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'8ebd9fa0-482d-4d6f-a180-1d88f3d04d5c'[39m,
    [32m'{"after":{"invitedEmail":"audit-user2@test.com","token":"12bc22902e5449841699cfffb75194e2ca53f206a657606cf17448850a1f28cb"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:164:22
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w51
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w51,public

[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mComplete Organization Workflow[2m > [22m[2mStep 2: Invite member via email
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,47658add-bd9c-4c61-bc4c-91ab7e2d5630,organization.invite_send,organization,8cf6dfcd-7752-4175-8e20-4b955a72c7f7,{"after":{"invitedEmail":"org-member@test.com","token":"353a9e7705462ed03414ac03542e20cf69b0c27637377dd606faef916b34609c"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'47658add-bd9c-4c61-bc4c-91ab7e2d5630'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'8cf6dfcd-7752-4175-8e20-4b955a72c7f7'[39m,
    [32m'{"after":{"invitedEmail":"org-member@test.com","token":"353a9e7705462ed03414ac03542e20cf69b0c27637377dd606faef916b34609c"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:117:22
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w51 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w51%2Cpublic

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould create invite for existing user without creating placeholder
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,b8292cd5-0cad-4dc0-8a3b-6a91b7f6ccb5,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'b8292cd5-0cad-4dc0-8a3b-6a91b7f6ccb5'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould prevent transfer to org if user is not a member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,7c074b64-0a4f-465b-a1ae-dacdb685240c,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'7c074b64-0a4f-465b-a1ae-dacdb685240c'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768511816156,"env":"test","module":"auth-routes","userId":"ac8ab7348f2abf750a3b684ad06536f8","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould prevent backup code reuse
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511816162,"env":"test","module":"auth-routes","userId":"4ba645c9cb9b702195622e7ac0a7b992","msg":"User logged in successfully"}
{"level":50,"time":1768511816210,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["4ba645c9cb9b702195622e7ac0a7b992","login_success","security","4ba645c9cb9b702195622e7ac0a7b992","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:56.162Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:56.163Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"4ba645c9cb9b702195622e7ac0a7b992","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould detect and prevent refresh token reuse (token theft)
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 4ba645c9cb9b702195622e7ac0a7b992,login_success,security,4ba645c9cb9b702195622e7ac0a7b992,{"metadata":{"timestamp":"2026-01-15T21:16:56.162Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:56.163Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'4ba645c9cb9b702195622e7ac0a7b992'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'4ba645c9cb9b702195622e7ac0a7b992'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:56.162Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:56.163Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511816211,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["4ba645c9cb9b702195622e7ac0a7b992","login_success","security","4ba645c9cb9b702195622e7ac0a7b992","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:56.162Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:56.163Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768511816216,"env":"test","module":"auth-service","tokenHash":"9ef8d56db36e1ad33bc525265298ff3796ad37cfa35098cd710fdfff7d297a24","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768511816267,"env":"test","module":"mfa-service","userId":"ac8ab7348f2abf750a3b684ad06536f8","msg":"TOTP verification successful"}
{"level":30,"time":1768511816319,"env":"test","module":"auth-routes","userId":"ac8ab7348f2abf750a3b684ad06536f8","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w52
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w52,public

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w52 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w52%2Cpublic

{"level":30,"time":1768511816377,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511816416,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511816543,"env":"test","module":"email-queue","jobId":"bc075fd9-85d3-465a-86ec-cf0245407b2e","to":"existing_1768511812103@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #2: Invite acceptance race condition[2m > [22m[2mshould prevent double-acceptance via transaction
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,1832fcd8-61d9-4fe1-9d4c-832d89f01159,organization.invite_accept,organization,8ebd9fa0-482d-4d6f-a180-1d88f3d04d5c,{"after":{"email":"audit-user2@test.com"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'1832fcd8-61d9-4fe1-9d4c-832d89f01159'[39m,
    [32m'organization.invite_accept'[39m,
    [32m'organization'[39m,
    [32m'8ebd9fa0-482d-4d6f-a180-1d88f3d04d5c'[39m,
    [32m'{"after":{"email":"audit-user2@test.com"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.acceptInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:797:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:171:7
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768511816628,"env":"test","module":"auth-routes","userId":"7838472924feda1522948cb63e9f3880","msg":"User logged in successfully"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould create invite for existing user without creating placeholder
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,b8292cd5-0cad-4dc0-8a3b-6a91b7f6ccb5,{"after":{"invitedEmail":"existing_1768511812103@test.com","token":"5a31b01ba057e628b117f77cdbb998b3e21804405ce1254fa039d76a062206d8"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'b8292cd5-0cad-4dc0-8a3b-6a91b7f6ccb5'[39m,
    [32m'{"after":{"invitedEmail":"existing_1768511812103@test.com","token":"5a31b01ba057e628b117f77cdbb998b3e21804405ce1254fa039d76a062206d8"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:100:28
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511816644,"env":"test","msg":"DB: initializing... Local"}
{"level":50,"time":1768511816672,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["7838472924feda1522948cb63e9f3880","login_success","security","7838472924feda1522948cb63e9f3880","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:56.628Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:56.628Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"7838472924feda1522948cb63e9f3880","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould prevent backup code reuse
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 7838472924feda1522948cb63e9f3880,login_success,security,7838472924feda1522948cb63e9f3880,{"metadata":{"timestamp":"2026-01-15T21:16:56.628Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:56.628Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'7838472924feda1522948cb63e9f3880'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'7838472924feda1522948cb63e9f3880'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:56.628Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:56.628Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511816672,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["7838472924feda1522948cb63e9f3880","login_success","security","7838472924feda1522948cb63e9f3880","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:56.628Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:56.628Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768511816676,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768511816683,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511816714,"env":"test","module":"auth-service","tokenHash":"9ef8d56db36e1ad33bc525265298ff3796ad37cfa35098cd710fdfff7d297a24","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mupdateOrganization[2m > [22m[2mshould allow admin to update organization
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,e9eb03b5-691e-4734-94b9-db093bb71ea9,{"after":{"name":"Original Name Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'e9eb03b5-691e-4734-94b9-db093bb71ea9'[39m,
    [32m'{"after":{"name":"Original Name Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:122:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mComplete Organization Workflow[2m > [22m[2mStep 3: Accept invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,b4051708-8256-4195-8874-70bf00e46c96,organization.invite_accept,organization,8cf6dfcd-7752-4175-8e20-4b955a72c7f7,{"after":{"email":"org-member@test.com"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'b4051708-8256-4195-8874-70bf00e46c96'[39m,
    [32m'organization.invite_accept'[39m,
    [32m'organization'[39m,
    [32m'8cf6dfcd-7752-4175-8e20-4b955a72c7f7'[39m,
    [32m'{"after":{"email":"org-member@test.com"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.acceptInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:797:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:141:22
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould return 404 for non-existent session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768511816762,"env":"test","module":"auth-service","userId":"4ba645c9cb9b702195622e7ac0a7b992","tokenHash":"9ef8d56db36e1ad33bc525265298ff3796ad37cfa35098cd710fdfff7d297a24","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w52, public

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w52
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w50.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w50.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511816863,"env":"test","module":"email-queue","jobId":"76d51ba3-64b8-4a70-8fca-e2eae483b94e","to":"test-1768511816301-h1vi27@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768511816863,"env":"test","module":"auth-service","email":"test-1768511816301-h1vi27@example.com","msg":"Password reset email sent"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould prevent transfer to org if user is not a member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,393b4419-9d28-425a-a772-d1067dc40eea,{"after":{"name":"Other Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'393b4419-9d28-425a-a772-d1067dc40eea'[39m,
    [32m'{"after":{"name":"Other Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:131:30
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w51, public

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w51
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w52.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w52.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511817140,"env":"test","module":"writeback-execution-service","runId":"00739fae-572b-49d6-bc3c-92c557137655","workflowId":"9b7046ad-60cb-46b4-9e66-a6bdc20b8b15","msg":"Executing writeback mappings for completed run"}
{"level":30,"time":1768511817187,"env":"test","module":"writeback-execution-service","runId":"00739fae-572b-49d6-bc3c-92c557137655","workflowId":"9b7046ad-60cb-46b4-9e66-a6bdc20b8b15","mappingCount":1,"msg":"Found writeback mappings"}
{"level":30,"time":1768511817218,"env":"test","module":"auth-routes","userId":"f5ead475483eb82ec042459138cca365","msg":"User logged in successfully"}
{"level":30,"time":1768511817233,"env":"test","module":"user-credentials-repository","userId":"3c7dd90ea700584a7b3cd32282d6556c","msg":"User password updated"}
[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mComplete Organization Workflow[2m > [22m[2mStep 4: Create workflow owned by user
[22m[39mFailed to increment workflow stats: TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')
    at getTableColumns [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/utils.js:109:15[90m)[39m
    at PgSelectBuilder.from [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/query-builders/select.js:62:16[90m)[39m
    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)
    at SystemStatsRepository.incrementWorkflowsCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:118:16)
    at WorkflowRepository.create (C:/Users/scoot/poll/VaultLogic/server/repositories/WorkflowRepository.ts:30:35)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/services/WorkflowService.ts:123:24
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:167:24
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20

{"level":50,"time":1768511817268,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["f5ead475483eb82ec042459138cca365","login_success","security","f5ead475483eb82ec042459138cca365","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:57.219Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:57.219Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"f5ead475483eb82ec042459138cca365","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould return 404 for non-existent session
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: f5ead475483eb82ec042459138cca365,login_success,security,f5ead475483eb82ec042459138cca365,{"metadata":{"timestamp":"2026-01-15T21:16:57.219Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:57.219Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'f5ead475483eb82ec042459138cca365'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'f5ead475483eb82ec042459138cca365'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:57.219Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:57.219Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511817268,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["f5ead475483eb82ec042459138cca365","login_success","security","f5ead475483eb82ec042459138cca365","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:57.219Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:57.219Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768511817273,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768511817383,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["3c7dd90ea700584a7b3cd32282d6556c","password_reset","security","3c7dd90ea700584a7b3cd32282d6556c","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:57.333Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:57.333Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"3c7dd90ea700584a7b3cd32282d6556c","eventType":"password_reset","msg":"Failed to log security event"}
{"level":50,"time":1768511817383,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["3c7dd90ea700584a7b3cd32282d6556c","password_reset","security","3c7dd90ea700584a7b3cd32282d6556c","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:57.333Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:57.333Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Reset password error"}
{"level":30,"time":1768511817388,"env":"test","module":"writeback-execution-service","runId":"00739fae-572b-49d6-bc3c-92c557137655","workflowId":"9b7046ad-60cb-46b4-9e66-a6bdc20b8b15","mappingId":"b1fd1d99-e6e8-41f3-8fc9-4a64d89248d4","tableId":"92195e0f-b1ae-472e-a8ef-49d3d7671e54","msg":"Executing writeback mapping"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for c95d5d4a75bca7758d54e81561a61333

{"level":30,"time":1768511817439,"env":"test","module":"email-queue","jobId":"b0ebe1cb-9c3b-4d66-9dce-a7e36cf885e3","to":"email-test@example.com","subject":"You've been invited to join Test Org Audit","msg":"Email added to queue"}
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #3: Invite email failure rollback[2m > [22m[2mshould not create invite if email fails
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,44993df4-1f41-42f6-b7ca-f7fa8994c381,organization.invite_send,organization,8ebd9fa0-482d-4d6f-a180-1d88f3d04d5c,{"after":{"invitedEmail":"email-test@example.com","token":"91efc65a9ccb6ac99dc29a992254d800473cd98e2f6f06772b1779a7b46c0bbb"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'44993df4-1f41-42f6-b7ca-f7fa8994c381'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'8ebd9fa0-482d-4d6f-a180-1d88f3d04d5c'[39m,
    [32m'{"after":{"invitedEmail":"email-test@example.com","token":"91efc65a9ccb6ac99dc29a992254d800473cd98e2f6f06772b1779a7b46c0bbb"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:192:22
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mupdateOrganization[2m > [22m[2mshould deny non-admin from updating organization
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,0edea8e4-5b0a-4aae-a281-b5b10126eccf,{"after":{"name":"Test Org Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'0edea8e4-5b0a-4aae-a281-b5b10126eccf'[39m,
    [32m'{"after":{"name":"Test Org Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:139:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768511817784,"env":"test","module":"writeback-execution-service","runId":"00739fae-572b-49d6-bc3c-92c557137655","workflowId":"9b7046ad-60cb-46b4-9e66-a6bdc20b8b15","mappingId":"b1fd1d99-e6e8-41f3-8fc9-4a64d89248d4","columnCount":3,"msg":"Successfully created DataVault row"}
{"level":30,"time":1768511817784,"env":"test","module":"writeback-execution-service","runId":"00739fae-572b-49d6-bc3c-92c557137655","workflowId":"9b7046ad-60cb-46b4-9e66-a6bdc20b8b15","rowsCreated":1,"errorCount":0,"msg":"Writeback execution completed"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould list all active sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould prevent duplicate pending invites
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,09f69df7-e60e-4b1e-9526-1d83e937c55f,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'09f69df7-e60e-4b1e-9526-1d83e937c55f'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould allow org member to transfer org-owned project to another org they belong to
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,03f6deb8-a30b-4510-84e2-18ed8ae42b75,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'03f6deb8-a30b-4510-84e2-18ed8ae42b75'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768511818131,"env":"test","workflowId":"d9b6cf22-c774-40d0-9b30-281bce05778b","userId":"b4051708-8256-4195-8874-70bf00e46c96","sectionsCount":1,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould try TOTP before backup code
[22m[39m[TEST UTILS] MFA Secret verified for 772791ad262a42b96841c0ea341f20fd

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 6fa4ddf25d87d3b118385126d0dbfcf4

{"level":30,"time":1768511818372,"env":"test","module":"auth-routes","userId":"81028300e921cbbaac59cc31c839a11f","msg":"User logged in successfully"}
{"level":30,"time":1768511818378,"env":"test","module":"email-queue","jobId":"b2d26f96-879e-4c93-811e-aec4aaa71268","to":"expired-test@example.com","subject":"You've been invited to join Test Org Audit","msg":"Email added to queue"}
[90mstdout[2m | tests/unit/services/AuthService.test.ts[2m > [22m[2mAuthService[2m > [22m[2mJWT Token Management[2m > [22m[2mverifyToken()[2m > [22m[2mshould throw error for invalid token signature
[22m[39mDEBUG: verifyToken threw: Invalid or malformed token InvalidTokenError

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould try TOTP before backup code
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768511818419,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["81028300e921cbbaac59cc31c839a11f","login_success","security","81028300e921cbbaac59cc31c839a11f","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:58.372Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-15T21:16:58.372Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"81028300e921cbbaac59cc31c839a11f","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould list all active sessions
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 81028300e921cbbaac59cc31c839a11f,login_success,security,81028300e921cbbaac59cc31c839a11f,{"metadata":{"timestamp":"2026-01-15T21:16:58.372Z"}},::ffff:127.0.0.1,Mozilla/5.0 (Windows NT 10.0; Win64; x64),2026-01-15T21:16:58.372Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'81028300e921cbbaac59cc31c839a11f'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'81028300e921cbbaac59cc31c839a11f'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:58.372Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [32m'Mozilla/5.0 (Windows NT 10.0; Win64; x64)'[39m,
    [32m'2026-01-15T21:16:58.372Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511818419,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["81028300e921cbbaac59cc31c839a11f","login_success","security","81028300e921cbbaac59cc31c839a11f","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:58.372Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-15T21:16:58.372Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould list all active sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #5: Expired invites[2m > [22m[2mshould allow re-invite after invite expires
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,44993df4-1f41-42f6-b7ca-f7fa8994c381,organization.invite_send,organization,8ebd9fa0-482d-4d6f-a180-1d88f3d04d5c,{"after":{"invitedEmail":"expired-test@example.com","token":"38db74df7a1e8d6614e1bccfe39bd76da441956761d29f4485c86b64e7a227c1"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'44993df4-1f41-42f6-b7ca-f7fa8994c381'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'8ebd9fa0-482d-4d6f-a180-1d88f3d04d5c'[39m,
    [32m'{"after":{"invitedEmail":"expired-test@example.com","token":"38db74df7a1e8d6614e1bccfe39bd76da441956761d29f4485c86b64e7a227c1"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:215:23
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511818483,"env":"test","error":{"error":{"code":"INTERNAL_ERROR","message":""}},"msg":"Failed to render template"}
{"level":30,"time":1768511818500,"env":"test","module":"email-queue","jobId":"91056e8f-1564-4057-b923-bd2be1b35f51","to":"newuser_1768511812103@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
{"level":30,"time":1768511818534,"env":"test","workflowId":"d9b6cf22-c774-40d0-9b30-281bce05778b","userId":"47658add-bd9c-4c61-bc4c-91ab7e2d5630","sectionsCount":1,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould prevent duplicate pending invites
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,09f69df7-e60e-4b1e-9526-1d83e937c55f,{"after":{"invitedEmail":"newuser_1768511812103@test.com","token":"28b8a2e27d5b43b27fd7c0bb90b0e44047ccf7c70619517098b0dc78499d1ede"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'09f69df7-e60e-4b1e-9526-1d83e937c55f'[39m,
    [32m'{"after":{"invitedEmail":"newuser_1768511812103@test.com","token":"28b8a2e27d5b43b27fd7c0bb90b0e44047ccf7c70619517098b0dc78499d1ede"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:119:13
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768511818659,"env":"test","module":"auth-service","email":"reset@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768511818664,"env":"test","module":"auth-service","email":"reset@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768511818686,"env":"test","module":"auth-service","tokenHash":"0f45e858fbc4176cdf4e411f88281edefc390ae5afe7df0f44cd9297f0a64580","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768511818688,"env":"test","module":"auth-service","tokenHash":"9206c2394794b8fc97fcd896f95e40028ab7a15c10279446c23fbdd4b4ae7a1e","plainTokenLen":13,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768511818689,"env":"test","module":"auth-service","tokenHash":"9206c2394794b8fc97fcd896f95e40028ab7a15c10279446c23fbdd4b4ae7a1e","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768511818689,"env":"test","module":"auth-service","allTokensCount":0,"msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768511818691,"env":"test","module":"auth-service","tokenHash":"0f45e858fbc4176cdf4e411f88281edefc390ae5afe7df0f44cd9297f0a64580","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768511818691,"env":"test","module":"auth-service","userId":"user-123","tokenHash":"0f45e858fbc4176cdf4e411f88281edefc390ae5afe7df0f44cd9297f0a64580","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768511818695,"env":"test","module":"auth-service","tokenHash":"0f45e858fbc4176cdf4e411f88281edefc390ae5afe7df0f44cd9297f0a64580","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768511818695,"env":"test","module":"auth-service","userId":"user-123","msg":"Security: Expired refresh token used"}
{"level":30,"time":1768511818699,"env":"test","module":"auth-service","msg":"Cleaned up expired tokens and old login attempts"}
{"level":30,"time":1768511818700,"env":"test","module":"auth-service","msg":"Cleaned up expired tokens and old login attempts"}
{"level":30,"time":1768511818702,"env":"test","module":"auth-service","msg":"Cleaned up expired tokens and old login attempts"}
{"level":30,"time":1768511818703,"env":"test","module":"auth-service","msg":"Cleaned up expired tokens and old login attempts"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mgetOrganizationMembers[2m > [22m[2mshould return all members of organization
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,6df618b3-ecb2-4c8c-86c7-bb83f745d85e,{"after":{"name":"Members Test Org Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'6df618b3-ecb2-4c8c-86c7-bb83f745d85e'[39m,
    [32m'{"after":{"name":"Members Test Org Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:160:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768511818770,"env":"test","module":"writeback-execution-service","runId":"9a40ba26-8f90-42e1-8701-38e5394506ab","workflowId":"9b7046ad-60cb-46b4-9e66-a6bdc20b8b15","msg":"Executing writeback mappings for completed run"}
{"level":30,"time":1768511818793,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511818794,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768511818819,"env":"test","module":"writeback-execution-service","runId":"9a40ba26-8f90-42e1-8701-38e5394506ab","workflowId":"9b7046ad-60cb-46b4-9e66-a6bdc20b8b15","mappingCount":1,"msg":"Found writeback mappings"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould allow org member to transfer org-owned project to another org they belong to
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,f07c23af-da67-4b15-bb23-fb76ae9502c4,{"after":{"name":"Second Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'f07c23af-da67-4b15-bb23-fb76ae9502c4'[39m,
    [32m'{"after":{"name":"Second Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:154:26
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768511818863,"env":"test","module":"email-queue","jobId":"3b76caf5-c6f3-4ed6-b69e-06ae5cdb75f8","to":"test-1768511818298-dlm1pj@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768511818863,"env":"test","module":"auth-service","email":"test-1768511818298-dlm1pj@example.com","msg":"Password reset email sent"}
 [32m‚úì[39m tests/ui/runs.components.test.tsx [2m([22m[2m19 tests[22m[2m)[22m[33m 3258[2mms[22m[39m
       [33m[2m‚úì[22m[39m should show download options for successful runs [33m 623[2mms[22m[39m
{"level":30,"time":1768511818885,"env":"test","module":"auth-routes","userId":"772791ad262a42b96841c0ea341f20fd","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking other user's session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511818923,"env":"test","module":"auth-routes","userId":"c95d5d4a75bca7758d54e81561a61333","msg":"Login requires MFA verification"}
{"level":30,"time":1768511818986,"env":"test","module":"mfa-service","userId":"772791ad262a42b96841c0ea341f20fd","msg":"TOTP verification successful"}
{"level":30,"time":1768511819013,"env":"test","module":"writeback-execution-service","runId":"9a40ba26-8f90-42e1-8701-38e5394506ab","workflowId":"9b7046ad-60cb-46b4-9e66-a6bdc20b8b15","mappingId":"b1fd1d99-e6e8-41f3-8fc9-4a64d89248d4","tableId":"92195e0f-b1ae-472e-a8ef-49d3d7671e54","msg":"Executing writeback mapping"}
{"level":30,"time":1768511819027,"env":"test","module":"mfa-service","userId":"c95d5d4a75bca7758d54e81561a61333","msg":"TOTP verification successful"}
{"level":30,"time":1768511819033,"env":"test","module":"auth-routes","userId":"772791ad262a42b96841c0ea341f20fd","msg":"MFA login successful"}
{"level":30,"time":1768511819077,"env":"test","module":"auth-routes","userId":"c95d5d4a75bca7758d54e81561a61333","msg":"MFA login successful"}
{"level":30,"time":1768511819203,"env":"test","module":"auth-routes","userId":"81028300e921cbbaac59cc31c839a11f","msg":"User logged in successfully"}
{"level":30,"time":1768511819229,"env":"test","module":"auth-routes","userId":"c95d5d4a75bca7758d54e81561a61333","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":50,"time":1768511819254,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["81028300e921cbbaac59cc31c839a11f","login_success","security","81028300e921cbbaac59cc31c839a11f","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:59.203Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (iPhone; CPU iPhone OS 14_0)","2026-01-15T21:16:59.203Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"81028300e921cbbaac59cc31c839a11f","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould list all active sessions
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 81028300e921cbbaac59cc31c839a11f,login_success,security,81028300e921cbbaac59cc31c839a11f,{"metadata":{"timestamp":"2026-01-15T21:16:59.203Z"}},::ffff:127.0.0.1,Mozilla/5.0 (iPhone; CPU iPhone OS 14_0),2026-01-15T21:16:59.203Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'81028300e921cbbaac59cc31c839a11f'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'81028300e921cbbaac59cc31c839a11f'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:59.203Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [32m'Mozilla/5.0 (iPhone; CPU iPhone OS 14_0)'[39m,
    [32m'2026-01-15T21:16:59.203Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511819254,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["81028300e921cbbaac59cc31c839a11f","login_success","security","81028300e921cbbaac59cc31c839a11f","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:59.203Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (iPhone; CPU iPhone OS 14_0)","2026-01-15T21:16:59.203Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768511819259,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768511819316,"env":"test","module":"email-queue","jobId":"70ea0351-274b-43ac-87c4-0978304a8ee7","to":"expired-test@example.com","subject":"You've been invited to join Test Org Audit","msg":"Email added to queue"}
{"level":30,"time":1768511819332,"env":"test","module":"auth-routes","userId":"c95d5d4a75bca7758d54e81561a61333","deviceCount":1,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511819382,"env":"test","module":"auth-routes","userId":"3876aee2276159ffc3b3ef438050885c","msg":"User logged in successfully"}
{"level":30,"time":1768511819399,"env":"test","module":"writeback-execution-service","runId":"9a40ba26-8f90-42e1-8701-38e5394506ab","workflowId":"9b7046ad-60cb-46b4-9e66-a6bdc20b8b15","mappingId":"b1fd1d99-e6e8-41f3-8fc9-4a64d89248d4","columnCount":3,"msg":"Successfully created DataVault row"}
{"level":30,"time":1768511819399,"env":"test","module":"writeback-execution-service","runId":"9a40ba26-8f90-42e1-8701-38e5394506ab","workflowId":"9b7046ad-60cb-46b4-9e66-a6bdc20b8b15","rowsCreated":1,"errorCount":0,"msg":"Writeback execution completed"}
{"level":30,"time":1768511819399,"env":"test","runId":"9a40ba26-8f90-42e1-8701-38e5394506ab","rowsCreated":1,"msg":"DataVault writeback completed"}
{"level":30,"time":1768511819400,"env":"test","runId":"9a40ba26-8f90-42e1-8701-38e5394506ab","service":"DocumentGenerationService","msg":"Starting document generation for run"}
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #5: Expired invites[2m > [22m[2mshould allow re-invite after invite expires
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,44993df4-1f41-42f6-b7ca-f7fa8994c381,organization.invite_send,organization,8ebd9fa0-482d-4d6f-a180-1d88f3d04d5c,{"after":{"invitedEmail":"expired-test@example.com","token":"b3648cb0329c39c8dcf4e2ded4fe7d02cadc86de53f8e07b766fa5c6712530fe"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'44993df4-1f41-42f6-b7ca-f7fa8994c381'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'8ebd9fa0-482d-4d6f-a180-1d88f3d04d5c'[39m,
    [32m'{"after":{"invitedEmail":"expired-test@example.com","token":"b3648cb0329c39c8dcf4e2ded4fe7d02cadc86de53f8e07b766fa5c6712530fe"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:224:23
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511819426,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["3876aee2276159ffc3b3ef438050885c","login_success","security","3876aee2276159ffc3b3ef438050885c","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:59.382Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:59.382Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"3876aee2276159ffc3b3ef438050885c","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking other user's session
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 3876aee2276159ffc3b3ef438050885c,login_success,security,3876aee2276159ffc3b3ef438050885c,{"metadata":{"timestamp":"2026-01-15T21:16:59.382Z"}},::ffff:127.0.0.1,,2026-01-15T21:16:59.382Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'3876aee2276159ffc3b3ef438050885c'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'3876aee2276159ffc3b3ef438050885c'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:16:59.382Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:16:59.382Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511819426,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["3876aee2276159ffc3b3ef438050885c","login_success","security","3876aee2276159ffc3b3ef438050885c","{\"metadata\":{\"timestamp\":\"2026-01-15T21:16:59.382Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:16:59.382Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking other user's session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768511819497,"env":"test","runId":"9a40ba26-8f90-42e1-8701-38e5394506ab","service":"DocumentGenerationService","allSections":[{"id":"21349ff1-c1db-48e2-be74-426148a0ba23","config":{}}],"runId":"9a40ba26-8f90-42e1-8701-38e5394506ab","msg":"No Final Documents sections found, skipping generation. This might cause the frontend to hang."}
{"level":30,"time":1768511819498,"env":"test","runId":"9a40ba26-8f90-42e1-8701-38e5394506ab","msg":"Documents generated successfully"}
{"level":50,"time":1768511819745,"env":"test","error":{"query":"insert into \"workflow_run_events\" (\"id\", \"run_id\", \"version_id\", \"workflow_id\", \"block_id\", \"page_id\", \"type\", \"timestamp\", \"payload\", \"is_preview\") values (default, $1, $2, $3, default, default, $4, $5, $6, $7)","params":["9a40ba26-8f90-42e1-8701-38e5394506ab","draft","9b7046ad-60cb-46b4-9e66-a6bdc20b8b15","workflow.complete","2026-01-15T21:16:59.692Z","{\"durationMs\":1170,\"stepCount\":2}",false],"cause":{"length":137,"name":"error","severity":"ERROR","code":"22P02","where":"unnamed portal parameter $2 = '...'","file":"uuid.c","line":"138","routine":"string_to_uuid"}},"input":{"runId":"9a40ba26-8f90-42e1-8701-38e5394506ab","workflowId":"9b7046ad-60cb-46b4-9e66-a6bdc20b8b15","versionId":"draft","type":"workflow.complete","timestamp":"2026-01-15T21:16:59.692Z","isPreview":false,"payload":{"durationMs":1170,"stepCount":2}},"msg":"Failed to record analytics event"}
[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mComplete Organization Workflow[2m > [22m[2mStep 14: Remove member from org
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,47658add-bd9c-4c61-bc4c-91ab7e2d5630,organization.member_remove,organization,8cf6dfcd-7752-4175-8e20-4b955a72c7f7,{"after":{"removedUserId":"b4051708-8256-4195-8874-70bf00e46c96"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'47658add-bd9c-4c61-bc4c-91ab7e2d5630'[39m,
    [32m'organization.member_remove'[39m,
    [32m'organization'[39m,
    [32m'8cf6dfcd-7752-4175-8e20-4b955a72c7f7'[39m,
    [32m'{"after":{"removedUserId":"b4051708-8256-4195-8874-70bf00e46c96"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.removeMember (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:343:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:285:7
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768511819805,"env":"test","module":"auth-routes","userId":"6fa4ddf25d87d3b118385126d0dbfcf4","msg":"Login requires MFA verification"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mpromoteMember[2m > [22m[2mshould allow admin to promote member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,5377887f-5064-4e89-979e-6eb5ade789ee,{"after":{"name":"Promote Test Org Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'5377887f-5064-4e89-979e-6eb5ade789ee'[39m,
    [32m'{"after":{"name":"Promote Test Org Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:179:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768511819910,"env":"test","module":"mfa-service","userId":"6fa4ddf25d87d3b118385126d0dbfcf4","msg":"TOTP verification successful"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mGET /api/auth/me[2m > [22m[2mshould return current user for valid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511819961,"env":"test","module":"auth-routes","userId":"6fa4ddf25d87d3b118385126d0dbfcf4","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Status[2m > [22m[2mshould return MFA status for user
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould prevent inviting existing members
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,5a560ec6-4693-47e6-a403-83bda2347771,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'5a560ec6-4693-47e6-a403-83bda2347771'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768511820209,"env":"test","module":"auth-routes","userId":"d34db44a2720e558d6103cd867fd0a19","msg":"User logged in successfully"}
{"level":50,"time":1768511820258,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["d34db44a2720e558d6103cd867fd0a19","login_success","security","d34db44a2720e558d6103cd867fd0a19","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:00.209Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:00.210Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"d34db44a2720e558d6103cd867fd0a19","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking other user's session
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: d34db44a2720e558d6103cd867fd0a19,login_success,security,d34db44a2720e558d6103cd867fd0a19,{"metadata":{"timestamp":"2026-01-15T21:17:00.209Z"}},::ffff:127.0.0.1,,2026-01-15T21:17:00.210Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'd34db44a2720e558d6103cd867fd0a19'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'd34db44a2720e558d6103cd867fd0a19'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:17:00.209Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:17:00.210Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511820258,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["d34db44a2720e558d6103cd867fd0a19","login_success","security","d34db44a2720e558d6103cd867fd0a19","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:00.209Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:00.210Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768511820264,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould detach workflow from project when transferring to different owner
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,acecbcb4-7270-43f9-8289-bb0397d0f3ad,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'acecbcb4-7270-43f9-8289-bb0397d0f3ad'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mpromoteMember[2m > [22m[2mshould allow admin to promote member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.member_promote,organization,5377887f-5064-4e89-979e-6eb5ade789ee,{"after":{"userId":"00000000-0000-0000-0000-000000000012","newRole":"admin"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.member_promote'[39m,
    [32m'organization'[39m,
    [32m'5377887f-5064-4e89-979e-6eb5ade789ee'[39m,
    [32m'{"after":{"userId":"00000000-0000-0000-0000-000000000012","newRole":"admin"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.promoteMember (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:248:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:186:13
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #7: Delete organization[2m > [22m[2mshould allow last admin to delete empty organization
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,44993df4-1f41-42f6-b7ca-f7fa8994c381,organization.create,organization,b8d9f27b-aeab-4a44-86ca-3dcbd8dd5eb7,{"after":{"name":"Delete Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'44993df4-1f41-42f6-b7ca-f7fa8994c381'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'b8d9f27b-aeab-4a44-86ca-3dcbd8dd5eb7'[39m,
    [32m'{"after":{"name":"Delete Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:244:19
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768511820394,"env":"test","module":"auth-routes","userId":"89c6d63472206086e7af4b53b9fdd40f","msg":"User logged in successfully"}
{"level":50,"time":1768511820442,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["89c6d63472206086e7af4b53b9fdd40f","login_success","security","89c6d63472206086e7af4b53b9fdd40f","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:00.394Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:00.394Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"89c6d63472206086e7af4b53b9fdd40f","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mGET /api/auth/me[2m > [22m[2mshould return current user for valid token
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 89c6d63472206086e7af4b53b9fdd40f,login_success,security,89c6d63472206086e7af4b53b9fdd40f,{"metadata":{"timestamp":"2026-01-15T21:17:00.394Z"}},::ffff:127.0.0.1,,2026-01-15T21:17:00.394Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'89c6d63472206086e7af4b53b9fdd40f'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'89c6d63472206086e7af4b53b9fdd40f'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:17:00.394Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:17:00.394Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511820442,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["89c6d63472206086e7af4b53b9fdd40f","login_success","security","89c6d63472206086e7af4b53b9fdd40f","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:00.394Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:00.394Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768511820447,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768511820482,"env":"test","module":"auth-routes","userId":"7fea66fac35f4ceced654797a6d394a3","msg":"User logged in successfully"}
{"level":30,"time":1768511820516,"env":"test","module":"auth-service","tokenHash":"b43305b81d3b8f403731667bbf6fa84b9f81672e75bf24ff117280da37b59d93","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768511820519,"env":"test","module":"auth-service","email":"reset@example.com","msg":"Password reset email sent"}
{"level":50,"time":1768511820530,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["7fea66fac35f4ceced654797a6d394a3","login_success","security","7fea66fac35f4ceced654797a6d394a3","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:00.482Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:00.482Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"7fea66fac35f4ceced654797a6d394a3","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Status[2m > [22m[2mshould return MFA status for user
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 7fea66fac35f4ceced654797a6d394a3,login_success,security,7fea66fac35f4ceced654797a6d394a3,{"metadata":{"timestamp":"2026-01-15T21:17:00.482Z"}},::ffff:127.0.0.1,,2026-01-15T21:17:00.482Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'7fea66fac35f4ceced654797a6d394a3'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'7fea66fac35f4ceced654797a6d394a3'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:17:00.482Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:17:00.482Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511820530,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["7fea66fac35f4ceced654797a6d394a3","login_success","security","7fea66fac35f4ceced654797a6d394a3","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:00.482Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:00.482Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768511820535,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould detach workflow from project when transferring to different owner
[22m[39mFailed to increment workflow stats: TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')
    at getTableColumns [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/utils.js:109:15[90m)[39m
    at PgSelectBuilder.from [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/query-builders/select.js:62:16[90m)[39m
    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)
    at SystemStatsRepository.incrementWorkflowsCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:118:16)
    at WorkflowRepository.create (C:/Users/scoot/poll/VaultLogic/server/repositories/WorkflowRepository.ts:30:35)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/services/WorkflowService.ts:123:24
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:187:30
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20

{"level":30,"time":1768511820698,"env":"test","workflowId":"d9b6cf22-c774-40d0-9b30-281bce05778b","userId":"b4051708-8256-4195-8874-70bf00e46c96","sectionsCount":1,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511820968,"env":"test","module":"auth-service","email":"reset@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768511821100,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511821101,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/ownershipAccess.test.ts [2m([22m[2m19 tests[22m[2m)[22m[33m 5127[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow member of multiple orgs to access all their org assets [33m 302[2mms[22m[39m
{"level":30,"time":1768511821177,"env":"test","module":"auth-routes","userId":"36b3a98f37cf3b6987fce1908aeff69d","msg":"User logged in successfully"}
{"level":50,"time":1768511821223,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["36b3a98f37cf3b6987fce1908aeff69d","login_success","security","36b3a98f37cf3b6987fce1908aeff69d","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:01.178Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:01.178Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"36b3a98f37cf3b6987fce1908aeff69d","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 36b3a98f37cf3b6987fce1908aeff69d,login_success,security,36b3a98f37cf3b6987fce1908aeff69d,{"metadata":{"timestamp":"2026-01-15T21:17:01.178Z"}},::ffff:127.0.0.1,,2026-01-15T21:17:01.178Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'36b3a98f37cf3b6987fce1908aeff69d'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'36b3a98f37cf3b6987fce1908aeff69d'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:17:01.178Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:17:01.178Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511821223,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["36b3a98f37cf3b6987fce1908aeff69d","login_success","security","36b3a98f37cf3b6987fce1908aeff69d","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:01.178Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:01.178Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w53
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w53,public

[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #7: Delete organization[2m > [22m[2mshould prevent deletion if org owns assets
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,44993df4-1f41-42f6-b7ca-f7fa8994c381,organization.create,organization,93c342c9-ecd1-48a5-a7e7-6250b5163f66,{"after":{"name":"Has Assets Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'44993df4-1f41-42f6-b7ca-f7fa8994c381'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'93c342c9-ecd1-48a5-a7e7-6250b5163f66'[39m,
    [32m'{"after":{"name":"Has Assets Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:262:19
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w53 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w53%2Cpublic

{"level":50,"time":1768511821461,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768511821466,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768511821511,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511821511,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #7: Delete organization[2m > [22m[2mshould prevent deletion if org owns assets
[22m[39mFailed to increment workflow stats: TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')
    at getTableColumns [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/utils.js:109:15[90m)[39m
    at PgSelectBuilder.from [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/query-builders/select.js:62:16[90m)[39m
    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)
    at SystemStatsRepository.incrementWorkflowsCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:118:16)
    at WorkflowRepository.create (C:/Users/scoot/poll/VaultLogic/server/repositories/WorkflowRepository.ts:30:35)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/services/WorkflowService.ts:123:24
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:267:24
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20

 [32m‚úì[39m tests/integration/workflows/runtime-pipelines.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 6733[2mms[22m[39m
       [33m[2m‚úì[22m[39m should create DataVault row on workflow completion [33m 889[2mms[22m[39m
       [33m[2m‚úì[22m[39m should execute writebacks via RunService.completeRun() [33m 2389[2mms[22m[39m
{"level":30,"time":1768511821614,"env":"test","module":"email-queue","jobId":"7ba676ec-93a5-4945-a3a3-94e0d880a9c4","to":"duplicate@test.com","subject":"You've been invited to join Test Organization","msg":"Email added to queue"}
[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/services/AuthService.test.ts [2m([22m[2m113 tests[22m[2m)[22m[33m 8097[2mms[22m[39m
         [33m[2m‚úì[22m[39m should generate different hashes for same password [33m 467[2mms[22m[39m
         [33m[2m‚úì[22m[39m should return true for correct password [33m 448[2mms[22m[39m
         [33m[2m‚úì[22m[39m should return false for incorrect password [33m 447[2mms[22m[39m
         [33m[2m‚úì[22m[39m should be case-sensitive [33m 442[2mms[22m[39m
         [33m[2m‚úì[22m[39m should handle empty password comparison [33m 447[2mms[22m[39m
         [33m[2m‚úì[22m[39m should throw error for expired token [33m 1104[2mms[22m[39m
         [33m[2m‚úì[22m[39m should handle password with special characters [33m 454[2mms[22m[39m
         [33m[2m‚úì[22m[39m should handle password with newlines and tabs [33m 445[2mms[22m[39m
         [33m[2m‚úì[22m[39m should reject password with null bytes (if validation exists) [33m 454[2mms[22m[39m
         [33m[2m‚úì[22m[39m should support complete password reset workflow [33m 449[2mms[22m[39m
         [33m[2m‚úì[22m[39m should compare password in reasonable time (< 500ms) [33m 468[2mms[22m[39m
[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mEdge Cases and Security[2m > [22m[2mCannot invite same email twice (pending invite exists)
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,47658add-bd9c-4c61-bc4c-91ab7e2d5630,organization.invite_send,organization,8cf6dfcd-7752-4175-8e20-4b955a72c7f7,{"after":{"invitedEmail":"duplicate@test.com","token":"265c1b501b5df2289773a090fdb1de9d135dc121ca827a76069418f4e4f58734"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'47658add-bd9c-4c61-bc4c-91ab7e2d5630'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'8cf6dfcd-7752-4175-8e20-4b955a72c7f7'[39m,
    [32m'{"after":{"invitedEmail":"duplicate@test.com","token":"265c1b501b5df2289773a090fdb1de9d135dc121ca827a76069418f4e4f58734"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:323:23
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould require admin access to create invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,f2a077e0-f50a-4644-abce-5dc32d680b12,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'f2a077e0-f50a-4644-abce-5dc32d680b12'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39m[TEST UTILS] MFA Secret verified for b578b60ff6013dc0f4495ab2b8bfe693

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Status[2m > [22m[2mshould return backup codes count for MFA users
[22m[39m[TEST UTILS] MFA Secret verified for a785a78bf5d2cf9ad03d9e0a3c14587d

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould complete MFA login with valid TOTP code
[22m[39m[TEST UTILS] MFA Secret verified for 8864d00e6cab43bc3ab5fdfabff82e5b

{"level":30,"time":1768511821984,"env":"test","module":"auth-routes","userId":"36b3a98f37cf3b6987fce1908aeff69d","msg":"User logged in successfully"}
{"level":50,"time":1768511822027,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["36b3a98f37cf3b6987fce1908aeff69d","login_success","security","36b3a98f37cf3b6987fce1908aeff69d","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:01.984Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:01.984Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"36b3a98f37cf3b6987fce1908aeff69d","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 36b3a98f37cf3b6987fce1908aeff69d,login_success,security,36b3a98f37cf3b6987fce1908aeff69d,{"metadata":{"timestamp":"2026-01-15T21:17:01.984Z"}},::ffff:127.0.0.1,,2026-01-15T21:17:01.984Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'36b3a98f37cf3b6987fce1908aeff69d'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'36b3a98f37cf3b6987fce1908aeff69d'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:17:01.984Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:17:01.984Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mdemoteMember[2m > [22m[2mshould allow admin to demote other admin
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,91871003-4276-4781-92a1-8a54409f5cf6,{"after":{"name":"Demote Test Org Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'91871003-4276-4781-92a1-8a54409f5cf6'[39m,
    [32m'{"after":{"name":"Demote Test Org Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:197:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511822027,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["36b3a98f37cf3b6987fce1908aeff69d","login_success","security","36b3a98f37cf3b6987fce1908aeff69d","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:01.984Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:01.984Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768511822032,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould keep workflow in project when transferring to same owner
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,18061f4c-7269-4c6c-9b82-003f5abdfe39,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'18061f4c-7269-4c6c-9b82-003f5abdfe39'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511822139,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511822188,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Status[2m > [22m[2mshould return backup codes count for MFA users
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould complete MFA login with valid TOTP code
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511822434,"env":"test","module":"email-queue","jobId":"3b2bc223-79ba-4806-b6c6-9b3ee87378ae","to":"expired@test.com","subject":"You've been invited to join Test Organization","msg":"Email added to queue"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould keep workflow in project when transferring to same owner
[22m[39mFailed to increment workflow stats: TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')
    at getTableColumns [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/utils.js:109:15[90m)[39m
    at PgSelectBuilder.from [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/query-builders/select.js:62:16[90m)[39m
    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)
    at SystemStatsRepository.incrementWorkflowsCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:118:16)
    at WorkflowRepository.create (C:/Users/scoot/poll/VaultLogic/server/repositories/WorkflowRepository.ts:30:35)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/services/WorkflowService.ts:123:24
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:215:30
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511822460,"env":"test","module":"email-queue","jobId":"395b8a3e-c333-4569-a774-4cd9e4048e89","to":"placeholder-test@example.com","subject":"You've been invited to join Test Org Audit","msg":"Email added to queue"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mdemoteMember[2m > [22m[2mshould allow admin to demote other admin
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.member_demote,organization,91871003-4276-4781-92a1-8a54409f5cf6,{"after":{"userId":"00000000-0000-0000-0000-000000000012","newRole":"member"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.member_demote'[39m,
    [32m'organization'[39m,
    [32m'91871003-4276-4781-92a1-8a54409f5cf6'[39m,
    [32m'{"after":{"userId":"00000000-0000-0000-0000-000000000012","newRole":"member"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.demoteMember (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:296:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:204:13
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mEdge Cases and Security[2m > [22m[2mCannot accept expired invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,47658add-bd9c-4c61-bc4c-91ab7e2d5630,organization.invite_send,organization,8cf6dfcd-7752-4175-8e20-4b955a72c7f7,{"after":{"invitedEmail":"expired@test.com","token":"d1ec93de5a19d2b42e1aa51ddbe50f9c86a957ccf523e3dfd411971c087d70c7"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'47658add-bd9c-4c61-bc4c-91ab7e2d5630'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'8cf6dfcd-7752-4175-8e20-4b955a72c7f7'[39m,
    [32m'{"after":{"invitedEmail":"expired@test.com","token":"d1ec93de5a19d2b42e1aa51ddbe50f9c86a957ccf523e3dfd411971c087d70c7"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:348:22
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w53, public

[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #8: Placeholder user cleanup[2m > [22m[2mshould cleanup placeholder user when invite is revoked
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,44993df4-1f41-42f6-b7ca-f7fa8994c381,organization.invite_send,organization,8ebd9fa0-482d-4d6f-a180-1d88f3d04d5c,{"after":{"invitedEmail":"placeholder-test@example.com","token":"106ffe242cb93537a0a5deca67ef2936634cf73ffac269f76ea2bb36df0a3581"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'44993df4-1f41-42f6-b7ca-f7fa8994c381'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'8ebd9fa0-482d-4d6f-a180-1d88f3d04d5c'[39m,
    [32m'{"after":{"invitedEmail":"placeholder-test@example.com","token":"106ffe242cb93537a0a5deca67ef2936634cf73ffac269f76ea2bb36df0a3581"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:295:22
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w53
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w51.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w51.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511822700,"env":"test","module":"auth-routes","userId":"8864d00e6cab43bc3ab5fdfabff82e5b","msg":"Login requires MFA verification"}
{"level":30,"time":1768511822707,"env":"test","module":"auth-routes","userId":"a785a78bf5d2cf9ad03d9e0a3c14587d","msg":"Login requires MFA verification"}
{"level":30,"time":1768511822713,"env":"test","module":"auth-routes","userId":"b578b60ff6013dc0f4495ab2b8bfe693","msg":"Login requires MFA verification"}
{"level":30,"time":1768511822800,"env":"test","module":"mfa-service","userId":"8864d00e6cab43bc3ab5fdfabff82e5b","msg":"TOTP verification successful"}
{"level":30,"time":1768511822819,"env":"test","module":"mfa-service","userId":"b578b60ff6013dc0f4495ab2b8bfe693","msg":"TOTP verification successful"}
{"level":30,"time":1768511822848,"env":"test","module":"auth-routes","userId":"8864d00e6cab43bc3ab5fdfabff82e5b","msg":"MFA login successful"}
{"level":30,"time":1768511822854,"env":"test","module":"mfa-service","userId":"a785a78bf5d2cf9ad03d9e0a3c14587d","msg":"TOTP verification successful"}
{"level":30,"time":1768511822867,"env":"test","module":"auth-routes","userId":"b578b60ff6013dc0f4495ab2b8bfe693","msg":"MFA login successful"}
{"level":30,"time":1768511822888,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511822888,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould set expiry to 7 days from now
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,7f063214-405d-4395-b60f-ba83a2f2738c,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'7f063214-405d-4395-b60f-ba83a2f2738c'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768511822905,"env":"test","module":"auth-routes","userId":"a785a78bf5d2cf9ad03d9e0a3c14587d","msg":"MFA login successful"}
{"level":30,"time":1768511822933,"env":"test","module":"auth-routes","userId":"722793d36071343cd966907ce868efc6","msg":"User logged in successfully"}
{"level":50,"time":1768511822983,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["722793d36071343cd966907ce868efc6","login_success","security","722793d36071343cd966907ce868efc6","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:02.934Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:02.934Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"722793d36071343cd966907ce868efc6","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 722793d36071343cd966907ce868efc6,login_success,security,722793d36071343cd966907ce868efc6,{"metadata":{"timestamp":"2026-01-15T21:17:02.934Z"}},::ffff:127.0.0.1,,2026-01-15T21:17:02.934Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'722793d36071343cd966907ce868efc6'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'722793d36071343cd966907ce868efc6'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:17:02.934Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:17:02.934Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511822983,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["722793d36071343cd966907ce868efc6","login_success","security","722793d36071343cd966907ce868efc6","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:02.934Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:02.934Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

 [31m‚ùØ[39m tests/integration/auth.flows.real.test.ts [2m([22m[2m11 tests[22m[2m | [22m[31m6 failed[39m[2m)[22m[33m 29760[2mms[22m[39m
[31m       [31m√ó[31m should complete registration, verify email, then login[39m[33m 2463[2mms[22m[39m
       [33m[2m‚úì[22m[39m should lock account after 5 failed attempts, then unlock after waiting [33m 3860[2mms[22m[39m
       [33m[2m‚úì[22m[39m should record all login attempts [33m 2838[2mms[22m[39m
[31m       [31m√ó[31m should complete MFA setup and login with TOTP[39m[33m 1823[2mms[22m[39m
[31m       [31m√ó[31m should login with backup code when TOTP unavailable[39m[33m 1978[2mms[22m[39m
[31m       [31m√ó[31m should complete full password reset flow[39m[33m 2424[2mms[22m[39m
       [33m[2m‚úì[22m[39m should invalidate all sessions after password reset [33m 3133[2mms[22m[39m
       [33m[2m‚úì[22m[39m should rotate refresh token on each use [33m 2430[2mms[22m[39m
       [33m[2m‚úì[22m[39m should detect and prevent refresh token reuse (token theft) [33m 2203[2mms[22m[39m
[31m       [31m√ó[31m should list all active sessions[39m[33m 2829[2mms[22m[39m
[31m       [31m√ó[31m should revoke specific session[39m[33m 2540[2mms[22m[39m
{"level":30,"time":1768511823025,"env":"test","module":"auth-routes","userId":"b578b60ff6013dc0f4495ab2b8bfe693","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #8: Placeholder user cleanup[2m > [22m[2mshould cleanup placeholder user when invite is revoked
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: e60fade7-0ff5-4fa3-8d2d-bb467126ca37,44993df4-1f41-42f6-b7ca-f7fa8994c381,organization.invite_revoke,organization,8ebd9fa0-482d-4d6f-a180-1d88f3d04d5c,{"after":{"inviteId":"6c6d055f-982b-42d8-845e-2b072f1277ae","email":"placeholder-test@example.com"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [32m'e60fade7-0ff5-4fa3-8d2d-bb467126ca37'[39m,
    [32m'44993df4-1f41-42f6-b7ca-f7fa8994c381'[39m,
    [32m'organization.invite_revoke'[39m,
    [32m'organization'[39m,
    [32m'8ebd9fa0-482d-4d6f-a180-1d88f3d04d5c'[39m,
    [32m'{"after":{"inviteId":"6c6d055f-982b-42d8-845e-2b072f1277ae","email":"placeholder-test@example.com"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.revokeInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:840:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:305:7
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mEdge Cases and Security[2m > [22m[2mCannot transfer workflow to org user is not a member of
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,f804858b-4a02-49d7-b656-9c9a5248373f,organization.create,organization,3ae75a89-958b-46ca-850c-db6fcca25d90,{"after":{"name":"Other Organization","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'f804858b-4a02-49d7-b656-9c9a5248373f'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'3ae75a89-958b-46ca-850c-db6fcca25d90'[39m,
    [32m'{"after":{"name":"Other Organization","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:373:20
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w54
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w54,public

{"level":30,"time":1768511823471,"env":"test","module":"email-queue","jobId":"a6aa2859-854f-4b8d-a3d8-d811f0a30f26","to":"newuser_1768511812103@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w54 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w54%2Cpublic

{"level":30,"time":1768511823569,"env":"test","module":"auth-routes","userId":"b578b60ff6013dc0f4495ab2b8bfe693","msg":"Login from trusted device - MFA skipped"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould set expiry to 7 days from now
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,7f063214-405d-4395-b60f-ba83a2f2738c,{"after":{"invitedEmail":"newuser_1768511812103@test.com","token":"1905af288833400cf76c18e15b88efcb546a879aaff4e1c4e17b7257d79e7967"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'7f063214-405d-4395-b60f-ba83a2f2738c'[39m,
    [32m'{"after":{"invitedEmail":"newuser_1768511812103@test.com","token":"1905af288833400cf76c18e15b88efcb546a879aaff4e1c4e17b7257d79e7967"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:143:28
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768511823624,"env":"test","module":"auth-routes","userId":"b578b60ff6013dc0f4495ab2b8bfe693","msg":"User logged in successfully"}
{"level":50,"time":1768511823678,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["b578b60ff6013dc0f4495ab2b8bfe693","login_success","security","b578b60ff6013dc0f4495ab2b8bfe693","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:03.625Z\"}}","192.168.1.100","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-15T21:17:03.625Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"b578b60ff6013dc0f4495ab2b8bfe693","eventType":"login_success","msg":"Failed to log security event"}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #8: Placeholder user cleanup[2m > [22m[2mshould cleanup placeholder user when invite is revoked
[22m[39mCleaned up placeholder user 7d930954-922a-4f54-88e0-026ff6c3b156 (no pending invites or memberships)

[90mstderr[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: b578b60ff6013dc0f4495ab2b8bfe693,login_success,security,b578b60ff6013dc0f4495ab2b8bfe693,{"metadata":{"timestamp":"2026-01-15T21:17:03.625Z"}},192.168.1.100,Mozilla/5.0 (Windows NT 10.0; Win64; x64),2026-01-15T21:17:03.625Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'b578b60ff6013dc0f4495ab2b8bfe693'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'b578b60ff6013dc0f4495ab2b8bfe693'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:17:03.625Z"}}'[39m,
    [32m'192.168.1.100'[39m,
    [32m'Mozilla/5.0 (Windows NT 10.0; Win64; x64)'[39m,
    [32m'2026-01-15T21:17:03.625Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511823678,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["b578b60ff6013dc0f4495ab2b8bfe693","login_success","security","b578b60ff6013dc0f4495ab2b8bfe693","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:03.625Z\"}}","192.168.1.100","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-15T21:17:03.625Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould prevent non-member from transferring org workflow
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,d1014983-26a1-46c7-a4df-6f2aec75592b,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'd1014983-26a1-46c7-a4df-6f2aec75592b'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768511823757,"env":"test","module":"auth-routes","userId":"722793d36071343cd966907ce868efc6","msg":"User logged in successfully"}
{"level":50,"time":1768511823802,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["722793d36071343cd966907ce868efc6","login_success","security","722793d36071343cd966907ce868efc6","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:03.757Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:03.758Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"722793d36071343cd966907ce868efc6","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 722793d36071343cd966907ce868efc6,login_success,security,722793d36071343cd966907ce868efc6,{"metadata":{"timestamp":"2026-01-15T21:17:03.757Z"}},::ffff:127.0.0.1,,2026-01-15T21:17:03.758Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'722793d36071343cd966907ce868efc6'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'722793d36071343cd966907ce868efc6'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:17:03.757Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:17:03.758Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511823802,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["722793d36071343cd966907ce868efc6","login_success","security","722793d36071343cd966907ce868efc6","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:03.757Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:03.758Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould reject invalid MFA code
[22m[39m[TEST UTILS] MFA Secret verified for 8ed46547a271c9966ce61d7e9cc44dea

[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mdemoteMember[2m > [22m[2mshould prevent self-demotion
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,5fcf9678-8eae-49c9-8963-940337c72264,{"after":{"name":"Self Demote Test Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'5fcf9678-8eae-49c9-8963-940337c72264'[39m,
    [32m'{"after":{"name":"Self Demote Test Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:213:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould prevent non-member from transferring org workflow
[22m[39mFailed to increment workflow stats: TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')
    at getTableColumns [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/utils.js:109:15[90m)[39m
    at PgSelectBuilder.from [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/query-builders/select.js:62:16[90m)[39m
    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)
    at SystemStatsRepository.incrementWorkflowsCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:118:16)
    at WorkflowRepository.create (C:/Users/scoot/poll/VaultLogic/server/repositories/WorkflowRepository.ts:30:35)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/services/WorkflowService.ts:123:24
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:236:30
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20

[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #9: Transfer validation order[2m > [22m[2mshould fail fast on non-existent org
[22m[39mFailed to increment workflow stats: TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')
    at getTableColumns [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/utils.js:109:15[90m)[39m
    at PgSelectBuilder.from [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/query-builders/select.js:62:16[90m)[39m
    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)
    at SystemStatsRepository.incrementWorkflowsCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:118:16)
    at WorkflowRepository.create (C:/Users/scoot/poll/VaultLogic/server/repositories/WorkflowRepository.ts:30:35)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/services/WorkflowService.ts:123:24
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:324:24
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Disable Flow[2m > [22m[2mshould disable MFA with password verification
[22m[39m[TEST UTILS] MFA Secret verified for 2fdcb50e3da1d76081275e24bc5221a5

{"level":30,"time":1768511824190,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511824191,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/organizations-workflow.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 10724[2mms[22m[39m
       [33m[2m‚úì[22m[39m Step 1: Create organization [33m 648[2mms[22m[39m
       [33m[2m‚úì[22m[39m Step 2: Invite member via email [33m 908[2mms[22m[39m
       [33m[2m‚úì[22m[39m Step 3: Accept invite [33m 837[2mms[22m[39m
       [33m[2m‚úì[22m[39m Step 6: Org member (user2) can access workflow [33m 553[2mms[22m[39m
       [33m[2m‚úì[22m[39m Step 16: Re-add member and verify access restored [33m 692[2mms[22m[39m
       [33m[2m‚úì[22m[39m Cannot invite same email twice (pending invite exists) [33m 1256[2mms[22m[39m
       [33m[2m‚úì[22m[39m Cannot accept expired invite [33m 724[2mms[22m[39m
       [33m[2m‚úì[22m[39m Cannot transfer workflow to org user is not a member of [33m 872[2mms[22m[39m
{"level":40,"time":1768511824302,"env":"test","module":"mfa-service","userId":"8ed46547a271c9966ce61d7e9cc44dea","msg":"TOTP verification failed"}
{"level":40,"time":1768511824302,"env":"test","module":"auth-routes","userId":"8ed46547a271c9966ce61d7e9cc44dea","msg":"MFA verification failed during login"}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511824399,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Disable Flow[2m > [22m[2mshould disable MFA with password verification
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w56
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w56,public

{"level":30,"time":1768511824456,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w56 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w56%2Cpublic

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w55
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w55,public

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w55 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w55%2Cpublic

{"level":30,"time":1768511824621,"env":"test","module":"auth-routes","userId":"722793d36071343cd966907ce868efc6","msg":"User logged in successfully"}
{"level":30,"time":1768511824623,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511824624,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768511824672,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["722793d36071343cd966907ce868efc6","login_success","security","722793d36071343cd966907ce868efc6","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:04.621Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:04.621Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"722793d36071343cd966907ce868efc6","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 722793d36071343cd966907ce868efc6,login_success,security,722793d36071343cd966907ce868efc6,{"metadata":{"timestamp":"2026-01-15T21:17:04.621Z"}},::ffff:127.0.0.1,,2026-01-15T21:17:04.621Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'722793d36071343cd966907ce868efc6'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'722793d36071343cd966907ce868efc6'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:17:04.621Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:17:04.621Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511824672,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["722793d36071343cd966907ce868efc6","login_success","security","722793d36071343cd966907ce868efc6","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:04.621Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:04.621Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

 [32m‚úì[39m tests/unit/components/datavault/TableGridView.test.tsx [2m([22m[2m9 tests[22m[2m)[22m[33m 3665[2mms[22m[39m
     [33m[2m‚úì[22m[39m loads table schema and rows [33m 405[2mms[22m[39m
     [33m[2m‚úì[22m[39m updates cell value on blur [33m 552[2mms[22m[39m
     [33m[2m‚úì[22m[39m renders delete button for each row [33m 312[2mms[22m[39m
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w54, public

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould accept invite and create membership
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,dd319cd8-5993-4bf1-b556-267a91d773e6,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'dd319cd8-5993-4bf1-b556-267a91d773e6'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w54
‚è© Schema reused, skipping migrations.

[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mremoveMember[2m > [22m[2mshould allow admin to remove member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,f55debf3-2482-4da4-90e9-bef5ae567c01,{"after":{"name":"Remove Test Org Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'f55debf3-2482-4da4-90e9-bef5ae567c01'[39m,
    [32m'{"after":{"name":"Remove Test Org Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:227:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768511824887,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511824888,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768511824907,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511824907,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w53.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w53.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511824917,"env":"test","module":"auth-routes","userId":"2fdcb50e3da1d76081275e24bc5221a5","msg":"Login requires MFA verification"}
{"level":30,"time":1768511824941,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511824942,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/organizations-audit-fixes.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 12383[2mms[22m[39m
       [33m[2m‚úì[22m[39m should cascade ownership to workflow runs when project is transferred [33m 888[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent double-acceptance via transaction [33m 1674[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not create invite if email fails [33m 950[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow re-invite after invite expires [33m 1919[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow last admin to delete empty organization [33m 1001[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent deletion if org owns assets [33m 1125[2mms[22m[39m
       [33m[2m‚úì[22m[39m should cleanup placeholder user when invite is revoked [33m 1953[2mms[22m[39m
       [33m[2m‚úì[22m[39m should fail fast on non-existent org [33m 345[2mms[22m[39m
{"level":30,"time":1768511825019,"env":"test","module":"mfa-service","userId":"2fdcb50e3da1d76081275e24bc5221a5","msg":"TOTP verification successful"}
 [32m‚úì[39m tests/unit/engine/templateNode.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 11840[2mms[22m[39m
       [33m[2m‚úì[22m[39m should resolve template by key from workflowTemplates mapping [33m 720[2mms[22m[39m
       [33m[2m‚úì[22m[39m should throw error if template key not found [33m 560[2mms[22m[39m
       [33m[2m‚úì[22m[39m should store output in runOutputs table [33m 713[2mms[22m[39m
       [33m[2m‚úì[22m[39m should resolve template by templateId directly [33m 556[2mms[22m[39m
       [33m[2m‚úì[22m[39m should throw error if templateId not found [33m 557[2mms[22m[39m
       [33m[2m‚úì[22m[39m should use docxRenderer2 by default (v2 engine) [33m 624[2mms[22m[39m
       [33m[2m‚úì[22m[39m should use legacy engine when engine="legacy" [33m 557[2mms[22m[39m
       [33m[2m‚úì[22m[39m should generate PDF when toPdf=true [33m 704[2mms[22m[39m
       [33m[2m‚úì[22m[39m should default to DOCX when toPdf=false [33m 694[2mms[22m[39m
       [33m[2m‚úì[22m[39m should skip execution when condition evaluates to false [33m 484[2mms[22m[39m
       [33m[2m‚úì[22m[39m should execute when condition evaluates to true [33m 983[2mms[22m[39m
       [33m[2m‚úì[22m[39m should resolve simple bindings [33m 552[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle binding resolution errors gracefully [33m 517[2mms[22m[39m
       [33m[2m‚úì[22m[39m should record failed output in runOutputs table [33m 798[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not throw errors (should return error in result) [33m 560[2mms[22m[39m
       [33m[2m‚úì[22m[39m should deny access to templates from different tenant [33m 554[2mms[22m[39m
       [33m[2m‚úì[22m[39m should require either templateKey or templateId [33m 505[2mms[22m[39m
 [31m‚ùØ[39m tests/integration/auth.routes.real.test.ts [2m([22m[2m26 tests[22m[2m | [22m[31m3 failed[39m[2m)[22m[33m 31759[2mms[22m[39m
       [33m[2m‚úì[22m[39m should register a new user successfully [33m 1216[2mms[22m[39m
       [32m‚úì[39m should return 400 for invalid email format[32m 6[2mms[22m[39m
       [32m‚úì[39m should return 400 for weak password[32m 4[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 409 for duplicate email [33m 1215[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set httpOnly refresh token cookie [33m 535[2mms[22m[39m
[31m       [31m√ó[31m should login with valid credentials[39m[33m 1895[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 for invalid password [33m 1460[2mms[22m[39m
       [32m‚úì[39m should return 401 for non-existent user[32m 157[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 403 for unverified email [33m 917[2mms[22m[39m
       [33m[2m‚úì[22m[39m should record failed login attempt [33m 1538[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return requiresMfa=true for MFA-enabled users [33m 1859[2mms[22m[39m
       [33m[2m‚úì[22m[39m should lock account after 5 failed attempts [33m 3817[2mms[22m[39m
       [33m[2m‚úì[22m[39m should logout and clear refresh token cookie [33m 1900[2mms[22m[39m
       [33m[2m‚úì[22m[39m should refresh access token with valid refresh token [33m 2100[2mms[22m[39m
       [32m‚úì[39m should return 401 for missing refresh token[32m 5[2mms[22m[39m
       [33m[2m‚úì[22m[39m should rotate refresh token after use [33m 2134[2mms[22m[39m
       [33m[2m‚úì[22m[39m should send password reset email for existing user [33m 1151[2mms[22m[39m
       [32m‚úì[39m should not reveal if email exists (security)[32m 51[2mms[22m[39m
[31m       [31m√ó[31m should reset password with valid token[39m[33m 1947[2mms[22m[39m
       [32m‚úì[39m should return 400 for invalid token[32m 50[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 400 for weak new password [33m 1240[2mms[22m[39m
[31m       [31m√ó[31m should return current user for valid token[39m[33m 1919[2mms[22m[39m
       [32m‚úì[39m should return 401 for missing token[32m 5[2mms[22m[39m
       [32m‚úì[39m should return 401 for invalid token[32m 5[2mms[22m[39m
         [33m[2m‚úì[22m[39m should complete MFA login with valid TOTP code [33m 1957[2mms[22m[39m
         [33m[2m‚úì[22m[39m should reject invalid MFA code [33m 1462[2mms[22m[39m
{"level":30,"time":1768511825070,"env":"test","module":"auth-routes","userId":"2fdcb50e3da1d76081275e24bc5221a5","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39m[TEST UTILS] MFA Secret verified for 5eb5a3dd4fe29b5dad22e7ef2d958d38

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mDatabase Transfer[2m > [22m[2mshould transfer database ownership
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,5ff30bcb-aa1c-49ee-ac07-f2e4a44cde5e,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'5ff30bcb-aa1c-49ee-ac07-f2e4a44cde5e'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mremoveMember[2m > [22m[2mshould allow admin to remove member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.member_remove,organization,f55debf3-2482-4da4-90e9-bef5ae567c01,{"after":{"removedUserId":"00000000-0000-0000-0000-000000000012"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.member_remove'[39m,
    [32m'organization'[39m,
    [32m'f55debf3-2482-4da4-90e9-bef5ae567c01'[39m,
    [32m'{"after":{"removedUserId":"00000000-0000-0000-0000-000000000012"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.removeMember (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:343:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:234:13
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768511825320,"env":"test","module":"email-queue","jobId":"273943b5-9e83-4193-8e93-129407d9cd2e","to":"existing_1768511812103@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511825417,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould accept invite and create membership
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,dd319cd8-5993-4bf1-b556-267a91d773e6,{"after":{"invitedEmail":"existing_1768511812103@test.com","token":"9bd111d4d5e8bf21cf5a4628d5e80e75180b8329e2980217054c437ef58eba22"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'dd319cd8-5993-4bf1-b556-267a91d773e6'[39m,
    [32m'{"after":{"invitedEmail":"existing_1768511812103@test.com","token":"9bd111d4d5e8bf21cf5a4628d5e80e75180b8329e2980217054c437ef58eba22"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:165:34
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511825453,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511825469,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511825498,"env":"test","module":"auth-routes","userId":"722793d36071343cd966907ce868efc6","msg":"User logged in successfully"}
{"level":30,"time":1768511825513,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768511825545,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["722793d36071343cd966907ce868efc6","login_success","security","722793d36071343cd966907ce868efc6","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:05.498Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:05.498Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"722793d36071343cd966907ce868efc6","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 722793d36071343cd966907ce868efc6,login_success,security,722793d36071343cd966907ce868efc6,{"metadata":{"timestamp":"2026-01-15T21:17:05.498Z"}},::ffff:127.0.0.1,,2026-01-15T21:17:05.498Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'722793d36071343cd966907ce868efc6'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'722793d36071343cd966907ce868efc6'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:17:05.498Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:17:05.498Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511825545,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["722793d36071343cd966907ce868efc6","login_success","security","722793d36071343cd966907ce868efc6","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:05.498Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:05.498Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768511825551,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768511825623,"env":"test","module":"mfa-service","userId":"2fdcb50e3da1d76081275e24bc5221a5","msg":"MFA disabled"}
{"level":30,"time":1768511825623,"env":"test","module":"auth-routes","userId":"2fdcb50e3da1d76081275e24bc5221a5","msg":"MFA disabled by user"}
{"level":50,"time":1768511825673,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["2fdcb50e3da1d76081275e24bc5221a5","mfa_disabled","security","2fdcb50e3da1d76081275e24bc5221a5","{\"metadata\":{\"mfaMethod\":\"totp\",\"timestamp\":\"2026-01-15T21:17:05.623Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:05.623Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"2fdcb50e3da1d76081275e24bc5221a5","eventType":"mfa_disabled","msg":"Failed to log security event"}
{"level":50,"time":1768511825673,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["2fdcb50e3da1d76081275e24bc5221a5","mfa_disabled","security","2fdcb50e3da1d76081275e24bc5221a5","{\"metadata\":{\"mfaMethod\":\"totp\",\"timestamp\":\"2026-01-15T21:17:05.623Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:05.623Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"MFA disable error"}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w57
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w57,public

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w57 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w57%2Cpublic

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w56, public

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w55, public

{"level":30,"time":1768511825887,"env":"test","module":"auth-routes","userId":"5eb5a3dd4fe29b5dad22e7ef2d958d38","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w56
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w55
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w54.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w54.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w54.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w54.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511825987,"env":"test","module":"mfa-service","userId":"5eb5a3dd4fe29b5dad22e7ef2d958d38","msg":"TOTP verification successful"}
{"level":30,"time":1768511826039,"env":"test","module":"auth-routes","userId":"5eb5a3dd4fe29b5dad22e7ef2d958d38","msg":"MFA login successful"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould accept invite and create membership
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000022,organization.invite_accept,organization,dd319cd8-5993-4bf1-b556-267a91d773e6,{"after":{"email":"existing_1768511812103@test.com"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000022'[39m,
    [32m'organization.invite_accept'[39m,
    [32m'organization'[39m,
    [32m'dd319cd8-5993-4bf1-b556-267a91d773e6'[39m,
    [32m'{"after":{"email":"existing_1768511812103@test.com"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.acceptInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:797:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:171:28
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768511826192,"env":"test","module":"auth-routes","userId":"5eb5a3dd4fe29b5dad22e7ef2d958d38","deviceFingerprint":"10fa3aea039bf6fec7b6bcb982cbed1cc6ab844dd3c0879bec32baefb2997b52","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mremoveMember[2m > [22m[2mshould prevent self-removal
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,f73ebd85-b56f-4454-b740-c4be732485b3,{"after":{"name":"Self Remove Test Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'f73ebd85-b56f-4454-b740-c4be732485b3'[39m,
    [32m'{"after":{"name":"Self Remove Test Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:243:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mDatabase Transfer[2m > [22m[2mshould allow org member to transfer org database
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,0e6607d5-c624-4186-b22d-10a9fc3243ee,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'0e6607d5-c624-4186-b22d-10a9fc3243ee'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768511826683,"env":"test","module":"auth-routes","userId":"5eb5a3dd4fe29b5dad22e7ef2d958d38","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511826688,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511826747,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould keep current session active
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Disable Flow[2m > [22m[2mshould require correct password to disable MFA
[22m[39m[TEST UTILS] MFA Secret verified for 0d01e9429fc638f9ab8181593e29e670

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w57, public

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w57
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w55.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w56.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w55.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mDEBUG: Dropping existing function: test_schema_w56.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstderr[2m | tests/ui/datavault/EditableCell.test.tsx[2m > [22m[2mEditableCell Component[2m > [22m[2mError Handling[2m > [22m[2mreverts value on save error
[22m[39mFailed to save cell: Error: Network error
    at C:/Users/scoot/poll/VaultLogic/tests/ui/datavault/EditableCell.test.tsx:206:36
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

{"level":30,"time":1768511827348,"env":"test","module":"auth-routes","userId":"bcdef30052ecb5529a280428af58e1b7","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Disable Flow[2m > [22m[2mshould require correct password to disable MFA
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768511827399,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["bcdef30052ecb5529a280428af58e1b7","login_success","security","bcdef30052ecb5529a280428af58e1b7","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:07.349Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:07.349Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"bcdef30052ecb5529a280428af58e1b7","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould keep current session active
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: bcdef30052ecb5529a280428af58e1b7,login_success,security,bcdef30052ecb5529a280428af58e1b7,{"metadata":{"timestamp":"2026-01-15T21:17:07.349Z"}},::ffff:127.0.0.1,,2026-01-15T21:17:07.349Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'bcdef30052ecb5529a280428af58e1b7'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'bcdef30052ecb5529a280428af58e1b7'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:17:07.349Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:17:07.349Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511827400,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["bcdef30052ecb5529a280428af58e1b7","login_success","security","bcdef30052ecb5529a280428af58e1b7","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:07.349Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:07.349Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould keep current session active
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511827407,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511827408,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mleaveOrganization[2m > [22m[2mshould allow member to leave organization
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,2a0aed59-83c0-4e32-81bd-b93ee2500c03,{"after":{"name":"Leave Test Org Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'2a0aed59-83c0-4e32-81bd-b93ee2500c03'[39m,
    [32m'{"after":{"name":"Leave Test Org Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:257:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

 [32m‚úì[39m tests/ui/datavault/TableCard.test.tsx [2m([22m[2m8 tests[22m[2m)[22m[33m 3412[2mms[22m[39m
     [33m[2m‚úì[22m[39m should call onDelete when delete button is clicked [33m 959[2mms[22m[39m
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould convert placeholder user to real user on accept
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,d31fc4fb-2c42-44c5-8de9-52d852e41f83,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'd31fc4fb-2c42-44c5-8de9-52d852e41f83'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/ui/datavault/EditableCell.test.tsx[2m > [22m[2mEditableCell Component[2m > [22m[2mError Handling[2m > [22m[2mdisplays error indicator on save failure
[22m[39mFailed to save cell: Error: Network error
    at C:/Users/scoot/poll/VaultLogic/tests/ui/datavault/EditableCell.test.tsx:222:36
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould validate expression after debounce
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w58
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w58,public

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w58 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w58%2Cpublic

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould return validation errors for invalid expression
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39m[TEST UTILS] MFA Secret verified for 053646f79fce1c63bfd802bb4e4c91e5

{"level":30,"time":1768511827772,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511827773,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould return validation errors for invalid expression
[22m[39mValidation Result DEBUG: {"ok":false,"errors":[{"message":"Unknown identifier: unknown_var","start":{"line":0,"col":0},"end":{"line":0,"col":11}}]}
IsValid DEBUG: [33mfalse[39m

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould debounce validation calls
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

{"level":30,"time":1768511827841,"env":"test","module":"auth-routes","userId":"0d01e9429fc638f9ab8181593e29e670","msg":"Login requires MFA verification"}
 [32m‚úì[39m tests/unit/collab.client.test.tsx [2m([22m[2m17 tests[22m[2m)[22m[33m 3695[2mms[22m[39m
     [33m[2m‚úì[22m[39m should add a comment [33m 508[2mms[22m[39m
     [33m[2m‚úì[22m[39m should allow comment owner to delete their comment [33m 320[2mms[22m[39m
[90mstderr[2m | tests/ui/datavault/EditableCell.test.tsx[2m > [22m[2mEditableCell Component[2m > [22m[2mBoolean Type (Checkbox)[2m > [22m[2mshows loading spinner when saving checkbox
[22m[39mWarning: An update to EditableCell inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at EditableCell (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/EditableCell.tsx:12:25)

{"level":30,"time":1768511827935,"env":"test","module":"mfa-service","userId":"0d01e9429fc638f9ab8181593e29e670","msg":"TOTP verification successful"}
{"level":30,"time":1768511827984,"env":"test","module":"auth-routes","userId":"0d01e9429fc638f9ab8181593e29e670","msg":"MFA login successful"}
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould not validate when workflowId or nodeId is missing
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould not validate when workflowId or nodeId is missing
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511828054,"env":"test","module":"email-queue","jobId":"aa17a959-6f6b-4996-b55e-12743b1bc30b","to":"newuser_1768511812103@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w61
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w61,public

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mDatabase Transfer[2m > [22m[2mshould prevent transfer to org if user is not a member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,8119a943-9617-4e6b-92b9-a2cbcb494ea9,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'8119a943-9617-4e6b-92b9-a2cbcb494ea9'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w62
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w62,public

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w61 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w61%2Cpublic

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould convert placeholder user to real user on accept
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,d31fc4fb-2c42-44c5-8de9-52d852e41f83,{"after":{"invitedEmail":"newuser_1768511812103@test.com","token":"4d4cdd1312ad53322e1c4766ca3bbe2ec86109e1a424b3af058181e602a567d3"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'd31fc4fb-2c42-44c5-8de9-52d852e41f83'[39m,
    [32m'{"after":{"invitedEmail":"newuser_1768511812103@test.com","token":"4d4cdd1312ad53322e1c4766ca3bbe2ec86109e1a424b3af058181e602a567d3"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:194:34
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression validation integration[2m > [22m[2mshould validate helper functions in expressions
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w62 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w62%2Cpublic

{"level":30,"time":1768511828177,"env":"test","module":"auth-routes","userId":"bcdef30052ecb5529a280428af58e1b7","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w59
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w59,public

{"level":50,"time":1768511828224,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["bcdef30052ecb5529a280428af58e1b7","login_success","security","bcdef30052ecb5529a280428af58e1b7","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:08.177Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:08.177Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"bcdef30052ecb5529a280428af58e1b7","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould keep current session active
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: bcdef30052ecb5529a280428af58e1b7,login_success,security,bcdef30052ecb5529a280428af58e1b7,{"metadata":{"timestamp":"2026-01-15T21:17:08.177Z"}},::ffff:127.0.0.1,,2026-01-15T21:17:08.177Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'bcdef30052ecb5529a280428af58e1b7'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'bcdef30052ecb5529a280428af58e1b7'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:17:08.177Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:17:08.177Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511828224,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["bcdef30052ecb5529a280428af58e1b7","login_success","security","bcdef30052ecb5529a280428af58e1b7","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:08.177Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:08.177Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768511828232,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w59 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w59%2Cpublic

{"level":50,"time":1768511828237,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768511828244,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511828245,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression validation integration[2m > [22m[2mshould validate complex expressions with multiple helpers
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

 [32m‚úì[39m tests/ui/datavault/EditableCell.test.tsx [2m([22m[2m29 tests[22m[2m)[22m[33m 5211[2mms[22m[39m
       [33m[2m‚úì[22m[39m saves on blur [33m 327[2mms[22m[39m
       [33m[2m‚úì[22m[39m cancels edit on Escape key press [33m 381[2mms[22m[39m
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression validation integration[2m > [22m[2mshould handle syntax errors
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768511828555,"env":"test","module":"auth-routes","userId":"053646f79fce1c63bfd802bb4e4c91e5","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511828579,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression Editor component behavior[2m > [22m[2mshould update validation when expression changes
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

{"level":30,"time":1768511828635,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511828665,"env":"test","module":"mfa-service","userId":"053646f79fce1c63bfd802bb4e4c91e5","msg":"TOTP verification successful"}
{"level":30,"time":1768511828713,"env":"test","module":"auth-routes","userId":"053646f79fce1c63bfd802bb4e4c91e5","msg":"MFA login successful"}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w60
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w60,public

[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mleaveOrganization[2m > [22m[2mshould allow admin to leave organization
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,8ee059bc-5339-481f-9b0f-31520d374df8,{"after":{"name":"Admin Leave Test Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'8ee059bc-5339-481f-9b0f-31520d374df8'[39m,
    [32m'{"after":{"name":"Admin Leave Test Int","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:272:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w60 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w60%2Cpublic

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression Editor component behavior[2m > [22m[2mshould update validation when expression changes
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mDatabase Transfer[2m > [22m[2mshould prevent transfer to org if user is not a member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000032,organization.create,organization,e0201cbd-7dad-4a7e-9e2f-4e6f4f495269,{"after":{"name":"Other Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000032'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'e0201cbd-7dad-4a7e-9e2f-4e6f4f495269'[39m,
    [32m'{"after":{"name":"Other Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:328:30
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w64
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w64,public

{"level":30,"time":1768511828926,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511828926,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768511828937,"env":"test","module":"auth-routes","userId":"053646f79fce1c63bfd802bb4e4c91e5","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w64 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w64%2Cpublic

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould convert placeholder user to real user on accept
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,1c050075-f797-4f29-9867-aaeb9d676d8e,organization.invite_accept,organization,d31fc4fb-2c42-44c5-8de9-52d852e41f83,{"after":{"email":"newuser_1768511812103@test.com"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'1c050075-f797-4f29-9867-aaeb9d676d8e'[39m,
    [32m'organization.invite_accept'[39m,
    [32m'organization'[39m,
    [32m'd31fc4fb-2c42-44c5-8de9-52d852e41f83'[39m,
    [32m'{"after":{"email":"newuser_1768511812103@test.com"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.acceptInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:797:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:204:13
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w58, public

 [32m‚úì[39m tests/ui/expression-editor.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 3655[2mms[22m[39m
       [33m[2m‚úì[22m[39m should update validation when expression changes [33m 310[2mms[22m[39m
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511829012,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511829014,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w58
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w57.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w57.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511829084,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511829098,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511829103,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511829151,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511829361,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511829362,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/organizationService.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 17050[2mms[22m[39m
       [33m[2m‚úì[22m[39m should create organization and auto-create admin membership [33m 971[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return all organizations for user [33m 989[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return empty array for user with no memberships [33m 346[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow admin to update organization [33m 1185[2mms[22m[39m
       [33m[2m‚úì[22m[39m should deny non-admin from updating organization [33m 1026[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return all members of organization [33m 1135[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow admin to promote member [33m 1682[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow admin to demote other admin [33m 2135[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent self-demotion [33m 1177[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow admin to remove member [33m 1637[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent self-removal [33m 985[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow member to leave organization [33m 1257[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow admin to leave organization [33m 1333[2mms[22m[39m
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w61, public

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w62, public

[90mstderr[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx[2m > [22m[2mTableGridView - Drag & Drop[2m > [22m[2mrenders DndContext wrapper
[22m[39mWarning: validateDOMNesting(...): <th> cannot appear as a child of <div>.
    at th
    at SortableColumnHeader (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/SortableColumnHeader.tsx:12:33)
    at div
    at SortableContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:26:23)
    at tr
    at thead
    at table
    at div
    at DndContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:18:18)
    at div
    at div
    at TableGridView (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/TableGridView.tsx:32:26)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
Warning: validateDOMNesting(...): <div> cannot appear as a child of <tr>.
    at div
    at SortableContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:26:23)
    at tr
    at thead
    at table
    at div
    at DndContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:18:18)
    at div
    at div
    at TableGridView (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/TableGridView.tsx:32:26)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w61
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w62
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould return 400 if no active session found
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w59, public

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w58.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w58.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Regeneration[2m > [22m[2mshould regenerate backup codes
[22m[39m[TEST UTILS] MFA Secret verified for 32b19c39f059985d6235b89fed9cf48e

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w58.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w58.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w59
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mDEBUG: Existing functions: []

{"level":30,"time":1768511829626,"env":"test","module":"auth-routes","userId":"053646f79fce1c63bfd802bb4e4c91e5","msg":"Login from trusted device - MFA skipped"}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511829629,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511829674,"env":"test","module":"auth-routes","userId":"053646f79fce1c63bfd802bb4e4c91e5","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511829699,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768511829722,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["053646f79fce1c63bfd802bb4e4c91e5","login_success","security","053646f79fce1c63bfd802bb4e4c91e5","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:09.674Z\"}}","192.168.1.100","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-15T21:17:09.674Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"053646f79fce1c63bfd802bb4e4c91e5","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 053646f79fce1c63bfd802bb4e4c91e5,login_success,security,053646f79fce1c63bfd802bb4e4c91e5,{"metadata":{"timestamp":"2026-01-15T21:17:09.674Z"}},192.168.1.100,Mozilla/5.0 (Windows NT 10.0; Win64; x64),2026-01-15T21:17:09.674Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'053646f79fce1c63bfd802bb4e4c91e5'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'053646f79fce1c63bfd802bb4e4c91e5'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:17:09.674Z"}}'[39m,
    [32m'192.168.1.100'[39m,
    [32m'Mozilla/5.0 (Windows NT 10.0; Win64; x64)'[39m,
    [32m'2026-01-15T21:17:09.674Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511829722,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["053646f79fce1c63bfd802bb4e4c91e5","login_success","security","053646f79fce1c63bfd802bb4e4c91e5","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:09.674Z\"}}","192.168.1.100","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-15T21:17:09.674Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511829813,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Regeneration[2m > [22m[2mshould regenerate backup codes
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511829869,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768511829922,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511829923,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768511829985,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511829986,"env":"test","module":"auth-routes","userId":"91ef6df6387b4cf2a0d9f92bd2212894","msg":"User logged in successfully"}
{"level":30,"time":1768511829986,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/ui/datavault/ColumnTypeIcon.test.tsx [2m([22m[2m27 tests[22m[2m)[22m[33m 2303[2mms[22m[39m
{"level":50,"time":1768511830037,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["91ef6df6387b4cf2a0d9f92bd2212894","login_success","security","91ef6df6387b4cf2a0d9f92bd2212894","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:09.986Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:09.986Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"91ef6df6387b4cf2a0d9f92bd2212894","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould return 400 if no active session found
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 91ef6df6387b4cf2a0d9f92bd2212894,login_success,security,91ef6df6387b4cf2a0d9f92bd2212894,{"metadata":{"timestamp":"2026-01-15T21:17:09.986Z"}},::ffff:127.0.0.1,,2026-01-15T21:17:09.986Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'91ef6df6387b4cf2a0d9f92bd2212894'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'91ef6df6387b4cf2a0d9f92bd2212894'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:17:09.986Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:17:09.986Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511830037,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["91ef6df6387b4cf2a0d9f92bd2212894","login_success","security","91ef6df6387b4cf2a0d9f92bd2212894","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:09.986Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:09.986Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768511830045,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w60, public

 [32m‚úì[39m tests/ui/datavault/TemplateCard.test.tsx [2m([22m[2m6 tests[22m[2m)[22m[33m 2296[2mms[22m[39m
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mTransfer Validation[2m > [22m[2mshould only allow transfer to self when targetOwnerType is user
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,0197c841-cf03-4f0c-8ed8-656817c73731,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'0197c841-cf03-4f0c-8ed8-656817c73731'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w60
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w59.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w61.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w62.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w59.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mDEBUG: Dropping existing function: test_schema_w61.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w65
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w65,public

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w64, public

{"level":30,"time":1768511830243,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511830244,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w65 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w65%2Cpublic

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mDEBUG: Dropping existing function: test_schema_w62.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511830247,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject expired invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,ee45672b-90d1-43bf-8e1c-e246240cb815,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'ee45672b-90d1-43bf-8e1c-e246240cb815'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w64
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768511830296,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511830306,"env":"test","module":"auth-routes","userId":"32b19c39f059985d6235b89fed9cf48e","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mDEBUG: Existing functions: []

 [32m‚úì[39m tests/unit/components/datavault/TableGridViewDragDrop.test.tsx [2m([22m[2m7 tests[22m[2m)[22m[33m 3086[2mms[22m[39m
     [33m[2m‚úì[22m[39m displays columns in order based on orderIndex [33m 424[2mms[22m[39m
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w63
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w63,public

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w67
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w67,public

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w63 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w63%2Cpublic

{"level":30,"time":1768511830409,"env":"test","module":"mfa-service","userId":"32b19c39f059985d6235b89fed9cf48e","msg":"TOTP verification successful"}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w67 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w67%2Cpublic

{"level":30,"time":1768511830458,"env":"test","module":"auth-routes","userId":"32b19c39f059985d6235b89fed9cf48e","msg":"MFA login successful"}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768511830583,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511830584,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/engine.expr.test.ts [2m([22m[2m26 tests[22m[2m)[22m[33m 2075[2mms[22m[39m
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w65, public

{"level":30,"time":1768511830673,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768511830674,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w65
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w60.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w64.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w60.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511830742,"env":"test","module":"email-queue","jobId":"8db99594-9521-47fa-9b88-2f1d3f7fe6e9","to":"existing_1768511812103@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
{"level":30,"time":1768511830745,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511830746,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w64.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [31m‚ùØ[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 37546[2mms[22m[39m
       [33m[2m‚úì[22m[39m should trust current device [33m 2283[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set trust expiry to 30 days [33m 2168[2mms[22m[39m
       [33m[2m‚úì[22m[39m should update expiry if device already trusted [33m 2475[2mms[22m[39m
       [32m‚úì[39m should require authentication[32m 5[2mms[22m[39m
       [33m[2m‚úì[22m[39m should list all trusted devices [33m 3770[2mms[22m[39m
       [33m[2m‚úì[22m[39m should mark current device [33m 2292[2mms[22m[39m
       [33m[2m‚úì[22m[39m should exclude revoked devices [33m 2456[2mms[22m[39m
       [33m[2m‚úì[22m[39m should exclude expired devices [33m 2506[2mms[22m[39m
       [33m[2m‚úì[22m[39m should revoke specific device [33m 2594[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 404 for non-existent device [33m 2024[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent revoking other user's device [33m 4497[2mms[22m[39m
[31m       [31m√ó[31m should skip MFA for trusted device[39m[33m 3147[2mms[22m[39m
       [33m[2m‚úì[22m[39m should require MFA for untrusted device [33m 2656[2mms[22m[39m
       [33m[2m‚úì[22m[39m should update lastUsedAt on trusted device login [33m 3416[2mms[22m[39m
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject expired invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,ee45672b-90d1-43bf-8e1c-e246240cb815,{"after":{"invitedEmail":"existing_1768511812103@test.com","token":"18358cd4cca7358bce826b2ee3c57b945d0a654b9124d85a5be9885fd6f19e44"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'ee45672b-90d1-43bf-8e1c-e246240cb815'[39m,
    [32m'{"after":{"invitedEmail":"existing_1768511812103@test.com","token":"18358cd4cca7358bce826b2ee3c57b945d0a654b9124d85a5be9885fd6f19e44"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:216:34
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

 [32m‚úì[39m tests/unit/components/datavault/CellRenderer.test.tsx [2m([22m[2m12 tests[22m[2m)[22m[33m 2990[2mms[22m[39m
     [33m[2m‚úì[22m[39m renders boolean value as Yes/No [33m 319[2mms[22m[39m
{"level":30,"time":1768511830878,"env":"test","module":"mfa-service","userId":"32b19c39f059985d6235b89fed9cf48e","count":10,"msg":"Stored backup codes"}
{"level":30,"time":1768511830878,"env":"test","module":"mfa-service","userId":"32b19c39f059985d6235b89fed9cf48e","msg":"Regenerated backup codes"}
{"level":30,"time":1768511830878,"env":"test","module":"auth-routes","userId":"32b19c39f059985d6235b89fed9cf48e","msg":"Backup codes regenerated"}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w68
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w68,public

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w68 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w68%2Cpublic

[90mstderr[2m | tests/integration/dynamic_options_workflow.test.ts[2m > [22m[2mDynamic Options Integration Flow
[22m[39mFailed to increment workflow stats: TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')
    at getTableColumns [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/utils.js:109:15[90m)[39m
    at PgSelectBuilder.from [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/query-builders/select.js:62:16[90m)[39m
    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)
    at SystemStatsRepository.incrementWorkflowsCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:118:16)
    at WorkflowRepository.create (C:/Users/scoot/poll/VaultLogic/server/repositories/WorkflowRepository.ts:30:35)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/services/WorkflowService.ts:123:24
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/dynamic_options_workflow.test.ts:41:26

{"level":30,"time":1768511831229,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511831230,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511831291,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mTransfer Validation[2m > [22m[2mshould allow transfer from user to self (org member transferring org asset to themselves)
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,296043b0-6d59-43b2-8d61-446893811f57,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'296043b0-6d59-43b2-8d61-446893811f57'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

 [32m‚úì[39m tests/ui/datavault/DatabaseSettingsPage.test.tsx [2m([22m[2m7 tests[22m[2m)[22m[33m 2962[2mms[22m[39m
     [33m[2m‚úì[22m[39m should render database settings page with breadcrumbs [33m 359[2mms[22m[39m
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all trusted devices
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w70
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w70,public

{"level":30,"time":1768511831349,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w70 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w70%2Cpublic

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511831535,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511831600,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w67, public

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w67
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w65.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w65.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511831821,"env":"test","module":"auth-routes","userId":"1e61e6b8b33f633e989d192398851eb6","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

{"level":30,"time":1768511831868,"env":"test","blockId":"87e21a61-9f6a-443e-80b6-5eeeecb3a5bf","virtualStepId":"cc64bbb9-5da0-4797-a615-e0c9237667e9","outputVar":"userList","msg":"Created read table block with virtual step"}
{"level":50,"time":1768511831871,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["1e61e6b8b33f633e989d192398851eb6","login_success","security","1e61e6b8b33f633e989d192398851eb6","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:11.821Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:11.821Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"1e61e6b8b33f633e989d192398851eb6","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all trusted devices
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 1e61e6b8b33f633e989d192398851eb6,login_success,security,1e61e6b8b33f633e989d192398851eb6,{"metadata":{"timestamp":"2026-01-15T21:17:11.821Z"}},::ffff:127.0.0.1,,2026-01-15T21:17:11.821Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'1e61e6b8b33f633e989d192398851eb6'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'1e61e6b8b33f633e989d192398851eb6'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:17:11.821Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:17:11.821Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511831871,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["1e61e6b8b33f633e989d192398851eb6","login_success","security","1e61e6b8b33f633e989d192398851eb6","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:11.821Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:11.821Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Regeneration[2m > [22m[2mshould return error if MFA not enabled
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768511831879,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768511831884,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w72
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w72,public

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511831915,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w73
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w73,public

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w63, public

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

{"level":30,"time":1768511831959,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w72 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w72%2Cpublic

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w66
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w66,public

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w73 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w73%2Cpublic

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w63
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w66 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w66%2Cpublic

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w71
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w71,public

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w67.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w67.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511832066,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511832066,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w71 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w71%2Cpublic

 [32m‚úì[39m tests/unit/workflow/QueryBlock.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2088[2mms[22m[39m
{"level":30,"time":1768511832161,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511832162,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511832193,"env":"test","msg":"DB: initializing... Local"}
 [32m‚úì[39m tests/integration/transferOwnership.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 19690[2mms[22m[39m
       [33m[2m‚úì[22m[39m should transfer user-owned project to org [33m 1761[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent transfer to org if user is not a member [33m 1924[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow org member to transfer org-owned project to another org they belong to [33m 2308[2mms[22m[39m
       [33m[2m‚úì[22m[39m should detach workflow from project when transferring to different owner [33m 1762[2mms[22m[39m
       [33m[2m‚úì[22m[39m should keep workflow in project when transferring to same owner [33m 1612[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent non-member from transferring org workflow [33m 1560[2mms[22m[39m
       [33m[2m‚úì[22m[39m should transfer database ownership [33m 1330[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow org member to transfer org database [33m 1445[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent transfer to org if user is not a member [33m 2024[2mms[22m[39m
       [33m[2m‚úì[22m[39m should only allow transfer to self when targetOwnerType is user [33m 1263[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow transfer from user to self (org member transferring org asset to themselves) [33m 1472[2mms[22m[39m
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject already accepted invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,748a75ce-81a9-4434-bb45-b6598201548d,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'748a75ce-81a9-4434-bb45-b6598201548d'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768511832254,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511832279,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511832279,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w68, public

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w74
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w74,public

 [32m‚úì[39m tests/integration/dynamic_options_workflow.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 2488[2mms[22m[39m
     [33m[2m‚úì[22m[39m should successfully configure a workflow with Read Table -> Dynamic Choice [33m 697[2mms[22m[39m
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w68
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w74 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w74%2Cpublic

{"level":30,"time":1768511832362,"env":"test","module":"auth-routes","userId":"542d99938a2eb8e5cb0476a0ab7b5a8a","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w63.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w63.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768511832406,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["542d99938a2eb8e5cb0476a0ab7b5a8a","login_success","security","542d99938a2eb8e5cb0476a0ab7b5a8a","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:12.362Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:12.363Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"542d99938a2eb8e5cb0476a0ab7b5a8a","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Regeneration[2m > [22m[2mshould return error if MFA not enabled
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 542d99938a2eb8e5cb0476a0ab7b5a8a,login_success,security,542d99938a2eb8e5cb0476a0ab7b5a8a,{"metadata":{"timestamp":"2026-01-15T21:17:12.362Z"}},::ffff:127.0.0.1,,2026-01-15T21:17:12.363Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'542d99938a2eb8e5cb0476a0ab7b5a8a'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'542d99938a2eb8e5cb0476a0ab7b5a8a'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:17:12.362Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:17:12.363Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511832406,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["542d99938a2eb8e5cb0476a0ab7b5a8a","login_success","security","542d99938a2eb8e5cb0476a0ab7b5a8a","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:12.362Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:12.363Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768511832413,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768511832506,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511832506,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w69
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w69,public

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w69 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w69%2Cpublic

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

 [32m‚úì[39m tests/ui/common/Breadcrumbs.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 2586[2mms[22m[39m
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w70, public

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w70
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w68.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w68.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511832734,"env":"test","module":"email-queue","jobId":"3ee92200-f15a-490d-89dc-f2a5a1bc6a59","to":"existing_1768511812103@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511832805,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511832808,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject already accepted invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,748a75ce-81a9-4434-bb45-b6598201548d,{"after":{"invitedEmail":"existing_1768511812103@test.com","token":"af7942d045032fab624e658dbcf56ae8226c4b8f855046988c11777b17734f0a"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'748a75ce-81a9-4434-bb45-b6598201548d'[39m,
    [32m'{"after":{"invitedEmail":"existing_1768511812103@test.com","token":"af7942d045032fab624e658dbcf56ae8226c4b8f855046988c11777b17734f0a"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:241:34
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":40,"time":1768511832858,"env":"test","error":{},"msg":"PDF conversion failed"}
{"level":30,"time":1768511832864,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768511832865,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768511832866,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511832881,"env":"test","msg":"DB: initialized flag set."}
 [32m‚úì[39m tests/unit/docxRenderer.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 2234[2mms[22m[39m
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511832995,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511833001,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511833002,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511833037,"env":"test","msg":"DB: initializing... Local"}
 [32m‚úì[39m tests/integration/intake.portal.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 2073[2mms[22m[39m
{"level":30,"time":1768511833047,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511833098,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w75
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w75,public

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w72, public

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w75 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w75%2Cpublic

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511833236,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w73, public

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould handle user with single session gracefully
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w72
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768511833288,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w73
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w70.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w70.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w76
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w76,public

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w70.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w70.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w76 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w76%2Cpublic

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w71, public

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w77
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w77,public

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w66, public

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w71
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w66
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w77 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w77%2Cpublic

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w73.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w72.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w73.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511833529,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w73.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w72.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w73.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w72.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject already accepted invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000022,organization.invite_accept,organization,748a75ce-81a9-4434-bb45-b6598201548d,{"after":{"email":"existing_1768511812103@test.com"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000022'[39m,
    [32m'organization.invite_accept'[39m,
    [32m'organization'[39m,
    [32m'748a75ce-81a9-4434-bb45-b6598201548d'[39m,
    [32m'{"after":{"email":"existing_1768511812103@test.com"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.acceptInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:797:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:248:13
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mDEBUG: Dropping existing function: test_schema_w72.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511833585,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768511833597,"env":"test","status":401,"statusText":"Unauthorized","error":"Invalid client credentials","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768511833597,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768511833600,"env":"test","data":{"token_type":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768511833600,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768511833600,"env":"test","data":{"access_token":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768511833600,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768511833601,"env":"test","error":"Network error: ECONNREFUSED","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":30,"time":1768511833610,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511833611,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w74, public

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w78
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w78,public

 [32m‚úì[39m tests/unit/listPipeline.semantics.test.ts [2m([22m[2m70 tests[22m[2m)[22m[33m 2129[2mms[22m[39m
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w78 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w78%2Cpublic

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w74
‚è© Schema reused, skipping migrations.

{"level":50,"time":1768511833707,"env":"test","error":"Invalid credentials","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":50,"time":1768511833708,"env":"test","error":"ECONNREFUSED","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768511833710,"env":"test","status":400,"statusText":"Bad Request","error":"Invalid grant_type","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768511833710,"env":"test","error":"OAuth2 token request failed: 400 Bad Request","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768511833711,"env":"test","status":401,"statusText":"Unauthorized","error":"Client authentication failed","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768511833711,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768511833711,"env":"test","status":403,"statusText":"Forbidden","error":"Access denied","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768511833711,"env":"test","error":"OAuth2 token request failed: 403 Forbidden","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768511833712,"env":"test","status":500,"statusText":"Internal Server Error","error":"Server error","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768511833712,"env":"test","error":"OAuth2 token request failed: 500 Internal Server Error","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768511833712,"env":"test","error":"Unexpected token in JSON","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768511833713,"env":"test","error":"Request timeout","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":30,"time":1768511833714,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768511833715,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768511833730,"env":"test","module":"auth-routes","userId":"6a93f1ac80ef24f5d3ed00b1b25926b9","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w71.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w66.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w71.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32m‚úì[39m tests/integration/auth/oauth2.client-credentials.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 2205[2mms[22m[39m
{"level":50,"time":1768511833774,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["6a93f1ac80ef24f5d3ed00b1b25926b9","login_success","security","6a93f1ac80ef24f5d3ed00b1b25926b9","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:13.730Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:13.731Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"6a93f1ac80ef24f5d3ed00b1b25926b9","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768511833775,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["6a93f1ac80ef24f5d3ed00b1b25926b9","login_success","security","6a93f1ac80ef24f5d3ed00b1b25926b9","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:13.730Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:13.731Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould handle user with single session gracefully
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 6a93f1ac80ef24f5d3ed00b1b25926b9,login_success,security,6a93f1ac80ef24f5d3ed00b1b25926b9,{"metadata":{"timestamp":"2026-01-15T21:17:13.730Z"}},::ffff:127.0.0.1,,2026-01-15T21:17:13.731Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'6a93f1ac80ef24f5d3ed00b1b25926b9'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'6a93f1ac80ef24f5d3ed00b1b25926b9'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:17:13.730Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:17:13.731Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511833782,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w66.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mTenant-Level MFA Enforcement[2m > [22m[2mshould enforce MFA for tenant users when required by tenant
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768511833842,"env":"test","warnings":["Python code does not call emit(). Script will not produce output."],"msg":"Script validation warnings"}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511833845,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768511833846,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/ScriptEngine.test.ts [2m([22m[2m26 tests[22m[2m | [22m[33m4 skipped[39m[2m)[22m[33m 2219[2mms[22m[39m
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w79
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w79,public

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w80
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w80,public

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w69, public

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w79 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w79%2Cpublic

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w80 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w80%2Cpublic

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w69
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w74.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w74.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511834051,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511834051,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511834066,"env":"test","msg":"DB: initializing... Local"}
 [32m‚úì[39m tests/unit/captcha.service.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 2148[2mms[22m[39m
{"level":30,"time":1768511834151,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

{"level":30,"time":1768511834215,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511834215,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511834249,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511834282,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768511834283,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/components/datavault/SortableColumnHeader.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 2675[2mms[22m[39m
{"level":30,"time":1768511834303,"env":"test","msg":"DB: initialized flag set."}
 [32m‚úì[39m tests/ui/blocks/SendDataToTableBlockEditor.test.tsx [2m([22m[2m12 tests[22m[2m)[22m[33m 2304[2mms[22m[39m
{"level":30,"time":1768511834364,"env":"test","module":"auth-routes","userId":"83ec6e118f0363a541aebebe5a42c640","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w75, public

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w75
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w69.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w69.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511834640,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w76, public

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w76
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768511834693,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w75.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w75.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w81
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w81,public

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w77, public

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w82
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w82,public

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w81 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w81%2Cpublic

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w77
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w82 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w82%2Cpublic

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511834848,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511834851,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould verify email matches invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,56b322b8-b4f4-4e6f-8cdc-d587da448cc6,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'56b322b8-b4f4-4e6f-8cdc-d587da448cc6'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768511834868,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511834868,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w76.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w76.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511834906,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511834907,"env":"test","msg":"DB: initialized flag set."}
 [32m‚úì[39m tests/unit/shared/validation/PageValidator.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2090[2mms[22m[39m
[90mstderr[2m | tests/unit/shared/workflowLogic.test.ts[2m > [22m[2mworkflowLogic[2m > [22m[2mevaluateRules[2m > [22m[2mOperators[2m > [22m[2mUnknown operator[2m > [22m[2mshould return false and log warning for unknown operator
[22m[39mUnknown operator: unknown_operator

{"level":30,"time":1768511834997,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511834998,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould include device metadata in sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w78, public

 [32m‚úì[39m tests/unit/shared/workflowLogic.test.ts [2m([22m[2m65 tests[22m[2m)[22m[33m 2102[2mms[22m[39m
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w78
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w77.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w77.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/BlockRunner.validate.test.ts [2m([22m[2m7 tests[22m[2m)[22m[33m 2150[2mms[22m[39m
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w85
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w85,public

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w80, public

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w79, public

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w86
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w86,public

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w85 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w85%2Cpublic

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w80
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w79
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w86 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w86%2Cpublic

{"level":30,"time":1768511835340,"env":"test","module":"email-queue","jobId":"763906f0-98ce-4d46-9f28-aeeda6234e4c","to":"existing_1768511812103@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w78.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w78.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w78.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w78.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768511835374,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511835375,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w83
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w83,public

 [32m‚úì[39m tests/ui/blocks/SendDataBlockEditorRouting.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 2136[2mms[22m[39m
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould verify email matches invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,56b322b8-b4f4-4e6f-8cdc-d587da448cc6,{"after":{"invitedEmail":"existing_1768511812103@test.com","token":"71b8f2c371c654a6423edf382b3ae7d8145fed4db29f75ae39612e7bf2103d0f"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'56b322b8-b4f4-4e6f-8cdc-d587da448cc6'[39m,
    [32m'{"after":{"invitedEmail":"existing_1768511812103@test.com","token":"71b8f2c371c654a6423edf382b3ae7d8145fed4db29f75ae39612e7bf2103d0f"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:257:34
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w83 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w83%2Cpublic

{"level":30,"time":1768511835503,"env":"test","module":"auth-routes","userId":"5f5c15171a204f1700445d1a74f59c0a","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

{"level":50,"time":1768511835552,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["5f5c15171a204f1700445d1a74f59c0a","login_success","security","5f5c15171a204f1700445d1a74f59c0a","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:15.503Z\"}}","192.168.1.100","Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/96.0","2026-01-15T21:17:15.503Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"5f5c15171a204f1700445d1a74f59c0a","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould include device metadata in sessions
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 5f5c15171a204f1700445d1a74f59c0a,login_success,security,5f5c15171a204f1700445d1a74f59c0a,{"metadata":{"timestamp":"2026-01-15T21:17:15.503Z"}},192.168.1.100,Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/96.0,2026-01-15T21:17:15.503Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'5f5c15171a204f1700445d1a74f59c0a'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'5f5c15171a204f1700445d1a74f59c0a'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:17:15.503Z"}}'[39m,
    [32m'192.168.1.100'[39m,
    [32m'Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/96.0'[39m,
    [32m'2026-01-15T21:17:15.503Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511835553,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["5f5c15171a204f1700445d1a74f59c0a","login_success","security","5f5c15171a204f1700445d1a74f59c0a","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:15.503Z\"}}","192.168.1.100","Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/96.0","2026-01-15T21:17:15.503Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768511835560,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511835563,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768511835564,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768511835594,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511835595,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768511835622,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511835623,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/WorkflowChangeAnalyzer.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 2069[2mms[22m[39m
 [32m‚úì[39m tests/unit/workflows/validation.test.ts [2m([22m[2m66 tests[22m[2m)[22m[33m 2111[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511835696,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511835703,"env":"test","msg":"DB: initializing... Local"}
 [31m‚ùØ[39m tests/integration/mfa.flow.real.test.ts [2m([22m[2m20 tests[22m[2m | [22m[31m9 failed[39m[2m)[22m[33m 42435[2mms[22m[39m
[31m       [31m√ó[31m should complete full MFA setup flow[39m[33m 1888[2mms[22m[39m
[31m       [31m√ó[31m should reject invalid TOTP code during setup[39m[33m 1837[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not allow MFA setup if already enabled [33m 1837[2mms[22m[39m
[31m       [31m√ó[31m should generate unique backup codes[39m[33m 1839[2mms[22m[39m
[31m       [31m√ó[31m should store hashed backup codes[39m[33m 1902[2mms[22m[39m
       [33m[2m‚úì[22m[39m should require MFA for enabled users [33m 1864[2mms[22m[39m
       [33m[2m‚úì[22m[39m should complete MFA login with valid TOTP [33m 2067[2mms[22m[39m
       [33m[2m‚úì[22m[39m should reject invalid TOTP during login [33m 2076[2mms[22m[39m
       [33m[2m‚úì[22m[39m should accept TOTP codes within 60-second window [33m 2737[2mms[22m[39m
[31m       [31m√ó[31m should login with valid backup code[39m[33m 1927[2mms[22m[39m
       [33m[2m‚úì[22m[39m should mark backup code as used [33m 1438[2mms[22m[39m
[31m       [31m√ó[31m should prevent backup code reuse[39m[33m 1876[2mms[22m[39m
       [33m[2m‚úì[22m[39m should try TOTP before backup code [33m 1964[2mms[22m[39m
[31m       [31m√ó[31m should return MFA status for user[39m[33m 1832[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return backup codes count for MFA users [33m 2201[2mms[22m[39m
[31m       [31m√ó[31m should disable MFA with password verification[39m[33m 2908[2mms[22m[39m
       [33m[2m‚úì[22m[39m should require correct password to disable MFA [33m 2444[2mms[22m[39m
       [33m[2m‚úì[22m[39m should regenerate backup codes [33m 2486[2mms[22m[39m
[31m       [31m√ó[31m should return error if MFA not enabled[39m[33m 1811[2mms[22m[39m
       [33m[2m‚úì[22m[39m should enforce MFA for tenant users when required by tenant [33m 2255[2mms[22m[39m
{"level":30,"time":1768511835762,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511835770,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w87
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w87,public

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w87 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w87%2Cpublic

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w88
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w88,public

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w88 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w88%2Cpublic

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w82, public

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w81, public

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511836164,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w81
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w82
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w89
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w89,public

{"level":30,"time":1768511836221,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w79.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w80.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w79.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w79.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w80.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w79.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w89 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w89%2Cpublic

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w80.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511836275,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w80.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511836328,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511836339,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511836389,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w90
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w90,public

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w90 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w90%2Cpublic

{"level":50,"time":1768511836523,"env":"test","module":"intake-navigation","error":{},"pageId":"page1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating visibleIf condition"}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":50,"time":1768511836523,"env":"test","module":"intake-navigation","error":{},"pageId":"page1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating skipIf condition"}
{"level":30,"time":1768511836525,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768511836526,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768511836543,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511836544,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w91
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w91,public

 [32m‚úì[39m tests/unit/services/intakeNavigation.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 2162[2mms[22m[39m
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w85, public

 [32m‚úì[39m tests/unit/shared/validation/Validator.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 2148[2mms[22m[39m
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w91 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w91%2Cpublic

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w85
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w84
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w84,public

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w92
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w92,public

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w86, public

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w81.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w82.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w81.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w84 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w84%2Cpublic

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w93
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w93,public

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w92 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w92%2Cpublic

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511836701,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w86
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w82.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w83, public

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w93 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w93%2Cpublic

{"level":30,"time":1768511836754,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w82.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w82.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject invalid token
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,08e2e862-ce66-43e5-a205-6525f853fa5e,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'08e2e862-ce66-43e5-a205-6525f853fa5e'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w83
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould not expose sensitive token data
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w85.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w85.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511836899,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511836971,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/unit/client/choice-utils.test.ts[2m > [22m[2mchoice-utils[2m > [22m[2mhandles missing content gracefully
[22m[39m[generateOptionsFromList] Invalid list data: [1mnull[22m

{"level":30,"time":1768511836985,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511836986,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511837019,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511837020,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511837021,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/client/choice-utils.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 2170[2mms[22m[39m
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

 [32m‚úì[39m tests/ui/builder.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 2146[2mms[22m[39m
{"level":30,"time":1768511837063,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768511837094,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768511837095,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w87, public

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w87
‚è© Schema reused, skipping migrations.

 [32m‚úì[39m tests/unit/services/docxRenderer2.test.ts [2m([22m[2m27 tests[22m[2m)[22m[33m 2095[2mms[22m[39m
[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w83.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w86.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w83.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w86.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511837313,"env":"test","module":"auth-routes","userId":"9cdad89f28c127d949d99678f131430c","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511837318,"env":"test","msg":"DB: initializing... Local"}
{"level":50,"time":1768511837358,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["9cdad89f28c127d949d99678f131430c","login_success","security","9cdad89f28c127d949d99678f131430c","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:17.313Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:17.313Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"9cdad89f28c127d949d99678f131430c","eventType":"login_success","msg":"Failed to log security event"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould not expose sensitive token data
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: 9cdad89f28c127d949d99678f131430c,login_success,security,9cdad89f28c127d949d99678f131430c,{"metadata":{"timestamp":"2026-01-15T21:17:17.313Z"}},::ffff:127.0.0.1,,2026-01-15T21:17:17.313Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'9cdad89f28c127d949d99678f131430c'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'9cdad89f28c127d949d99678f131430c'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:17:17.313Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:17:17.313Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":50,"time":1768511837358,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["9cdad89f28c127d949d99678f131430c","login_success","security","9cdad89f28c127d949d99678f131430c","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:17.313Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:17.313Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768511837366,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w88, public

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w89, public

{"level":30,"time":1768511837400,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w88
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w89
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w87.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w87.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511837492,"env":"test","msg":"DB: initializing... Local"}
{"level":40,"time":1768511837494,"env":"test","module":"rbac-middleware","path":"/api/workflows","permission":"workflow:create","msg":"Unauthenticated user attempted to access protected resource"}
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w87.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w87.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":40,"time":1768511837498,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","permission":"workflow:create","path":"/api/workflows","msg":"Permission denied"}
{"level":40,"time":1768511837500,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":null,"permission":"workflow:view","path":"/api/workflows","msg":"Permission denied"}
{"level":40,"time":1768511837501,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","permissions":["workflow:create","workflow:edit","workflow:delete"],"path":"/api/workflows","msg":"Permission denied (none of required permissions)"}
{"level":40,"time":1768511837503,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"builder","permissions":["workflow:edit","workflow:delete"],"path":"/api/workflows","msg":"Permission denied (missing some required permissions)"}
{"level":40,"time":1768511837505,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","requiredRoles":["owner","builder"],"path":"/api/admin","msg":"Role check failed"}
{"level":40,"time":1768511837505,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":null,"requiredRoles":["owner"],"path":"/api/admin","msg":"Role check failed"}
{"level":40,"time":1768511837506,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"builder","requiredRoles":["owner"],"path":"/api/test","msg":"Role check failed"}
{"level":40,"time":1768511837507,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"runner","requiredRoles":["owner","builder"],"path":"/api/test","msg":"Role check failed"}
{"level":40,"time":1768511837509,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","requiredRoles":["owner","builder","runner"],"path":"/api/test","msg":"Role check failed"}
{"level":40,"time":1768511837513,"env":"test","module":"rbac-middleware","path":"/api/test","permission":"workflow:view","msg":"Unauthenticated user attempted to access protected resource"}
{"level":40,"time":1768511837514,"env":"test","module":"rbac-middleware","userId":"user-123","permission":"workflow:view","path":"/api/test","msg":"Permission denied"}
{"level":40,"time":1768511837514,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"invalid-role","permission":"workflow:view","path":"/api/test","msg":"Permission denied"}
{"level":30,"time":1768511837515,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768511837516,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w94
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w94,public

{"level":30,"time":1768511837542,"env":"test","msg":"DB: initialized flag set."}
 [32m‚úì[39m tests/unit/middleware/rbac.test.ts [2m([22m[2m44 tests[22m[2m)[22m[33m 2033[2mms[22m[39m
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511837562,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w95
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w95,public

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w94 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w94%2Cpublic

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511837592,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511837598,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511837620,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w95 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w95%2Cpublic

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

{"level":30,"time":1768511837656,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511837651,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w90, public

{"level":30,"time":1768511837747,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511837748,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768511837764,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511837764,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w90
‚è© Schema reused, skipping migrations.

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mgetPendingInvitesForUser[2m > [22m[2mshould return pending invites for user email
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,7c84148a-a944-41ae-b93f-8d0b55533e0d,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'7c84148a-a944-41ae-b93f-8d0b55533e0d'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

 [32m‚úì[39m tests/unit/utils/encryption.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 2168[2mms[22m[39m
 [32m‚úì[39m tests/unit/shared/validation/stepConfigSchemas.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 1963[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w89.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w88.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w89.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w88.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w91, public

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w91
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w84, public

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w90.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w90.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w92, public

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w93, public

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w84
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w92
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w93
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w91.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w91.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511838110,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511838111,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w91.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w91.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w97
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w97,public

 [32m‚úì[39m tests/unit/utils/variableResolver.test.ts [2m([22m[2m20 tests[22m[2m)[22m[33m 2085[2mms[22m[39m
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w96
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w96,public

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w97 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w97%2Cpublic

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w98
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w98,public

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w96 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w96%2Cpublic

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w98 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w98%2Cpublic

{"level":30,"time":1768511838276,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511838276,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768511838287,"env":"test","module":"email-queue","jobId":"b5f84148-d35b-4711-be4e-fa4520028c08","to":"existing_1768511812103@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
 [32m‚úì[39m tests/unit/services/docxHelpers.test.ts [2m([22m[2m39 tests[22m[2m)[22m[33m 2100[2mms[22m[39m
{"level":30,"time":1768511838348,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511838349,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511838380,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mgetPendingInvitesForUser[2m > [22m[2mshould return pending invites for user email
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,7c84148a-a944-41ae-b93f-8d0b55533e0d,{"after":{"invitedEmail":"existing_1768511812103@test.com","token":"ae5b2ce34dc61fdb9f30e9dc51472dcacfb09dc1904e601c1497f24bc5b49d90"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'7c84148a-a944-41ae-b93f-8d0b55533e0d'[39m,
    [32m'{"after":{"invitedEmail":"existing_1768511812103@test.com","token":"ae5b2ce34dc61fdb9f30e9dc51472dcacfb09dc1904e601c1497f24bc5b49d90"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:278:34
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

 [32m‚úì[39m tests/unit/engine/Performance.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2090[2mms[22m[39m
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511838397,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511838406,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768511838407,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511838433,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511838443,"env":"test","msg":"DB: initialized flag set."}
 [32m‚úì[39m tests/unit/utils/pagination.test.ts [2m([22m[2m24 tests[22m[2m)[22m[33m 2108[2mms[22m[39m
{"level":30,"time":1768511838473,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK initialized successfully"}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w99
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w99,public

{"level":30,"time":1768511838473,"env":"test","module":"telemetry","msg":"Prometheus metrics initialized"}
{"level":30,"time":1768511838478,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768511838525,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK shut down successfully"}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w99 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w99%2Cpublic

{"level":30,"time":1768511838591,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK initialized successfully"}
{"level":30,"time":1768511838591,"env":"test","module":"telemetry","msg":"Prometheus metrics initialized"}
{"level":30,"time":1768511838592,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":40,"time":1768511838600,"env":"test","module":"metrics-routes","ip":"::ffff:127.0.0.1","msg":"Unauthorized metrics access attempt"}
{"level":30,"time":1768511838611,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK shut down successfully"}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511838611,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768511838612,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould track session activity timestamps
[22m[39mDEBUG: LOGIN HANDLER HIT

 [32m‚úì[39m tests/integration/metrics.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 2375[2mms[22m[39m
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w95, public

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w94, public

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w95
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w94
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w84.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w92.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w93.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w84.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w84.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w92.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w93.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w84.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w92.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w100
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w100,public

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w101
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w101,public

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w92.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w93.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w100 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w100%2Cpublic

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w101 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w101%2Cpublic

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w93.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511839046,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511839099,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511839098,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511839149,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511839159,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511839167,"env":"test","module":"auth-routes","userId":"ec25f91469a0ac64a2b48505790692c1","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

{"level":50,"time":1768511839211,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["ec25f91469a0ac64a2b48505790692c1","login_success","security","ec25f91469a0ac64a2b48505790692c1","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:19.167Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:19.167Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"ec25f91469a0ac64a2b48505790692c1","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768511839211,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["ec25f91469a0ac64a2b48505790692c1","login_success","security","ec25f91469a0ac64a2b48505790692c1","{\"metadata\":{\"timestamp\":\"2026-01-15T21:17:19.167Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T21:17:19.167Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould track session activity timestamps
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"
params: ec25f91469a0ac64a2b48505790692c1,login_success,security,ec25f91469a0ac64a2b48505790692c1,{"metadata":{"timestamp":"2026-01-15T21:17:19.167Z"}},::ffff:127.0.0.1,,2026-01-15T21:17:19.167Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
    at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning "id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp"'[39m,
  params: [
    [32m'ec25f91469a0ac64a2b48505790692c1'[39m,
    [32m'login_success'[39m,
    [32m'security'[39m,
    [32m'ec25f91469a0ac64a2b48505790692c1'[39m,
    [32m'{"metadata":{"timestamp":"2026-01-15T21:17:19.167Z"}}'[39m,
    [32m'::ffff:127.0.0.1'[39m,
    [1mnull[22m,
    [32m'2026-01-15T21:17:19.167Z'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:124:18
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:117:22
      at AuditLogService.logSecurityEvent (C:/Users/scoot/poll/VaultLogic/server/services/AuditLogService.ts:95:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:328:7 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768511839217,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511839218,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768511839219,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768511839217,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w102
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w102,public

{"level":30,"time":1768511839252,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511839253,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/services/RunExecutionCoordinator.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 2032[2mms[22m[39m
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w102 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w102%2Cpublic

 [32m‚úì[39m tests/unit/WorkflowOptimizationService.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 2119[2mms[22m[39m
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w103
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w103,public

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511839401,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w103 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w103%2Cpublic

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w97, public

{"level":30,"time":1768511839449,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w104
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w104,public

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w105
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w105,public

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w97
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w96, public

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w104 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w104%2Cpublic

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w105 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w105%2Cpublic

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w94.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w95.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w94.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w96
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w98, public

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w95.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w98
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w95.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w95.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mgetPendingInvitesForUser[2m > [22m[2mshould not return expired invites
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,0e0b3bb4-1a31-4e8f-8dc0-4c323274fbe0,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'0e0b3bb4-1a31-4e8f-8dc0-4c323274fbe0'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511839759,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w99, public

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w106
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w106,public

{"level":30,"time":1768511839844,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511839848,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts[2m > [22m[2mIntakeQuestionVisibilityService[2m > [22m[2mHelper methods[2m > [22m[2mshould get visible question count
[22m[39mMOCK SETUP DONE. Mock questions: [
  {
    id: [32m'q1'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q1'[39m,
    order: [33m0[39m,
    isVirtual: [33mfalse[39m,
    alias: [32m'show'[39m,
    visibleIf: [1mnull[22m
  },
  {
    id: [32m'q2'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q2'[39m,
    order: [33m1[39m,
    isVirtual: [33mfalse[39m,
    visibleIf: { op: [32m'equals'[39m, left: [36m[Object][39m, right: [36m[Object][39m }
  },
  {
    id: [32m'q3'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q3'[39m,
    order: [33m2[39m,
    isVirtual: [33mfalse[39m,
    visibleIf: [1mnull[22m
  }
]
Calling getVisibleQuestionCount...

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts[2m > [22m[2mIntakeQuestionVisibilityService[2m > [22m[2mHelper methods[2m > [22m[2mshould get visible question count
[22m[39mCOUNT RESULT: [33m0[39m
Mock called times: [33m1[39m
Mock last call args: [ [ [32m'section1'[39m ] ]

{"level":50,"time":1768511839864,"env":"test","module":"intake-question-visibility","error":{},"questionId":"q1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating visibleIf condition"}
{"level":30,"time":1768511839865,"env":"test","module":"ai-service","estimatedInputTokens":18,"estimatedOutputTokens":36,"sectionCount":0,"msg":"Attempting single-shot workflow revision"}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w99
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511839866,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768511839866,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w106 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w106%2Cpublic

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511839867,"env":"test","module":"gemini-provider","event":"ai_request_success","provider":"gemini","model":"gemini-2.0-flash-exp","taskType":"workflow_revision","promptTokens":812,"responseTokens":66,"durationMs":0,"estimatedCostUSD":0.00010760000000000001,"msg":"Gemini request succeeded"}
{"level":30,"time":1768511839870,"env":"test","module":"ai-service","duration":5,"workflowId":"123","changeCount":1,"msg":"AI workflow revision succeeded"}
{"level":30,"time":1768511839873,"env":"test","module":"ai-service","estimatedInputTokens":18,"estimatedOutputTokens":36,"sectionCount":0,"msg":"Attempting single-shot workflow revision"}
{"level":30,"time":1768511839874,"env":"test","module":"gemini-provider","event":"ai_request_success","provider":"gemini","model":"gemini-2.0-flash-exp","taskType":"workflow_revision","promptTokens":812,"responseTokens":45,"durationMs":1,"estimatedCostUSD":0.00009920000000000001,"msg":"Gemini request succeeded"}
{"level":30,"time":1768511839874,"env":"test","module":"ai-service","duration":1,"workflowId":"123","changeCount":0,"msg":"AI workflow revision succeeded"}
{"level":30,"time":1768511839874,"env":"test","module":"ai-service","estimatedInputTokens":18,"estimatedOutputTokens":36,"sectionCount":0,"msg":"Attempting single-shot workflow revision"}
{"level":30,"time":1768511839875,"env":"test","module":"gemini-provider","event":"ai_request_success","provider":"gemini","model":"gemini-2.0-flash-exp","taskType":"workflow_revision","promptTokens":811,"responseTokens":4,"durationMs":0,"estimatedCostUSD":0.0000827,"msg":"Gemini request succeeded"}
{"level":40,"time":1768511839875,"env":"test","module":"ai-provider","lastChar":"N","last50":"I am not JSON","msg":"Response does not end with closing brace/bracket"}
{"level":50,"time":1768511839876,"env":"test","module":"ai-service","responseLength":13,"estimatedTokens":4,"responseSuffix":"I am not JSON","msg":"Detected truncated AI response - workflow too large for single-shot revision"}
{"level":50,"time":1768511839876,"env":"test","module":"ai-service","error":{"code":"RESPONSE_TRUNCATED","estimatedTokens":4,"responseLength":13},"duration":1,"msg":"AI workflow revision failed"}
{"level":40,"time":1768511839876,"env":"test","module":"ai-service","estimatedInputTokens":18,"estimatedOutputTokens":36,"actualOutputTokens":4,"responseLength":13,"msg":"Single-shot revision truncated - automatically retrying with chunking"}
{"level":30,"time":1768511839876,"env":"test","module":"gemini-provider","event":"ai_request_success","provider":"gemini","model":"gemini-2.0-flash-exp","taskType":"workflow_revision","promptTokens":811,"responseTokens":4,"durationMs":0,"estimatedCostUSD":0.0000827,"msg":"Gemini request succeeded"}
{"level":40,"time":1768511839876,"env":"test","module":"ai-provider","lastChar":"N","last50":"I am not JSON","msg":"Response does not end with closing brace/bracket"}
{"level":50,"time":1768511839876,"env":"test","module":"ai-service","responseLength":13,"estimatedTokens":4,"responseSuffix":"I am not JSON","msg":"Detected truncated AI response - workflow too large for single-shot revision"}
{"level":50,"time":1768511839877,"env":"test","module":"ai-service","error":{"code":"RESPONSE_TRUNCATED","estimatedTokens":4,"responseLength":13},"duration":1,"msg":"AI workflow revision failed"}
{"level":50,"time":1768511839877,"env":"test","module":"ai-service","duration":3,"error":{"code":"RESPONSE_TRUNCATED","estimatedTokens":4,"responseLength":13},"msg":"AI workflow revision failed"}
{"level":30,"time":1768511839879,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768511839880,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/services/intakeQuestionVisibility.test.ts [2m([22m[2m19 tests[22m[2m)[22m[33m 2123[2mms[22m[39m
{"level":30,"time":1768511839909,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w97.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w96.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w98.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w97.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511839915,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511839916,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/services/AIService.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2104[2mms[22m[39m
 [32m‚úì[39m tests/unit/services/repeater.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 2117[2mms[22m[39m
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w96.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w98.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511840098,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511840098,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511840110,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w107
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w107,public

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w108
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w108,public

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w107 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w107%2Cpublic

{"level":30,"time":1768511840176,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w100, public

{"level":30,"time":1768511840192,"env":"test","module":"email-queue","jobId":"311ef391-a357-4a06-85ec-c7f1f60da8c3","to":"existing_1768511812103@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w108 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w108%2Cpublic

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w100
‚è© Schema reused, skipping migrations.

 [31m‚ùØ[39m tests/integration/session.management.real.test.ts [2m([22m[2m18 tests[22m[2m | [22m[31m16 failed[39m[2m)[22m[33m 46969[2mms[22m[39m
[31m       [31m√ó[31m should list all active sessions for current user[39m[33m 3554[2mms[22m[39m
[31m       [31m√ó[31m should mark current session correctly[39m[33m 2711[2mms[22m[39m
[31m       [31m√ó[31m should exclude revoked sessions[39m[33m 2761[2mms[22m[39m
[31m       [31m√ó[31m should order sessions by last used (most recent first)[39m[33m 3757[2mms[22m[39m
[31m       [31m√ó[31m should filter sessions by current user only[39m[33m 4726[2mms[22m[39m
       [32m‚úì[39m should return 401 for unauthenticated request[32m 7[2mms[22m[39m
[31m       [31m√ó[31m should revoke specific session[39m[33m 2720[2mms[22m[39m
[31m       [31m√ó[31m should prevent revoking current session[39m[33m 1797[2mms[22m[39m
[31m       [31m√ó[31m should return 404 for non-existent session[39m[33m 1781[2mms[22m[39m
[31m       [31m√ó[31m should prevent revoking other user's session[39m[33m 3884[2mms[22m[39m
[31m       [31m√ó[31m should revoke all other sessions[39m[33m 4382[2mms[22m[39m
[31m       [31m√ó[31m should keep current session active[39m[33m 2664[2mms[22m[39m
[31m       [31m√ó[31m should return 400 if no active session found[39m[33m 1823[2mms[22m[39m
       [33m[2m‚úì[22m[39m should revoke all trusted devices [33m 1900[2mms[22m[39m
[31m       [31m√ó[31m should handle user with single session gracefully[39m[33m 1806[2mms[22m[39m
[31m       [31m√ó[31m should include device metadata in sessions[39m[33m 1820[2mms[22m[39m
[31m       [31m√ó[31m should not expose sensitive token data[39m[33m 1805[2mms[22m[39m
[31m       [31m√ó[31m should track session activity timestamps[39m[33m 1848[2mms[22m[39m
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w101, public

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w99.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w99.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511840284,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768511840285,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mgetPendingInvitesForUser[2m > [22m[2mshould not return expired invites
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,0e0b3bb4-1a31-4e8f-8dc0-4c323274fbe0,{"after":{"invitedEmail":"existing_1768511812103@test.com","token":"0f965134e7cec937f3cb4c88adf1fa34d9d8881a0908e84ef8d053f799a4b303"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'0e0b3bb4-1a31-4e8f-8dc0-4c323274fbe0'[39m,
    [32m'{"after":{"invitedEmail":"existing_1768511812103@test.com","token":"0f965134e7cec937f3cb4c88adf1fa34d9d8881a0908e84ef8d053f799a4b303"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:294:34
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511840296,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w101
‚è© Schema reused, skipping migrations.

 [32m‚úì[39m tests/unit/workflows/conditionTruthTable.test.ts [2m([22m[2m51 tests[22m[2m)[22m[33m 2189[2mms[22m[39m
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mDEBUG: Existing functions: []

{"level":30,"time":1768511840350,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511840401,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511840430,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

{"level":30,"time":1768511840467,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

{"level":30,"time":1768511840494,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511840542,"env":"test","module":"workflow-quality-validator","overall":99,"breakdown":{"aliases":100,"types":100,"structure":100,"ux":95,"completeness":100,"validation":100},"issuesCount":1,"passed":true,"msg":"Workflow quality validation completed"}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w102, public

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511840543,"env":"test","module":"ai-service","duration":6,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":99,"qualityBreakdown":{"aliases":100,"types":100,"structure":100,"ux":95,"completeness":100,"validation":100},"qualityPassed":true,"issuesCount":1,"msg":"AI workflow generation succeeded"}
{"level":50,"time":1768511840549,"env":"test","module":"ai-service","error":{"code":"VALIDATION_ERROR","troubleshooting":"üîß Troubleshooting Steps:\n1. The AI response structure doesn't match our expected format\n2. This may indicate:\n   - A breaking change in the AI model behavior\n   - The model is struggling with the complexity of the request\n3. Try simplifying your workflow or request\n4. If this persists, please report this issue with the workflow details"},"duration":2,"msg":"AI workflow generation failed"}
{"level":50,"time":1768511840554,"env":"test","module":"ai-service","error":{"code":"VALIDATION_ERROR","troubleshooting":"üîß Troubleshooting Steps:\n1. The AI response structure doesn't match our expected format\n2. This may indicate:\n   - A breaking change in the AI model behavior\n   - The model is struggling with the complexity of the request\n3. Try simplifying your workflow or request\n4. If this persists, please report this issue with the workflow details"},"duration":1,"msg":"AI workflow generation failed"}
{"level":50,"time":1768511840556,"env":"test","module":"ai-service","error":{"code":"VALIDATION_ERROR","troubleshooting":"üîß Troubleshooting Steps:\n1. The AI response structure doesn't match our expected format\n2. This may indicate:\n   - A breaking change in the AI model behavior\n   - The model is struggling with the complexity of the request\n3. Try simplifying your workflow or request\n4. If this persists, please report this issue with the workflow details"},"duration":1,"msg":"AI workflow generation failed"}
{"level":40,"time":1768511840559,"env":"test","module":"ai-service","attempt":0,"retryAfter":1000,"error":"Rate limit exceeded","msg":"Retrying AI request..."}
{"level":40,"time":1768511840559,"env":"test","module":"ai-service","attempt":1,"retryAfter":2000,"error":"Rate limit exceeded","msg":"Retrying AI request..."}
{"level":40,"time":1768511840559,"env":"test","module":"ai-service","attempt":2,"retryAfter":4000,"error":"Rate limit exceeded","msg":"Retrying AI request..."}
{"level":50,"time":1768511840559,"env":"test","module":"ai-service","event":"ai_request_failed","provider":"openai","model":"gpt-4-turbo-preview","taskType":"workflow_generation","errorType":"RATE_LIMIT","durationMs":1,"attempts":4,"msg":"AI request failed: rate limit"}
{"level":50,"time":1768511840559,"env":"test","module":"ai-service","error":{"code":"RATE_LIMIT","details":{"originalError":"Rate limit exceeded","retryAfterSeconds":60},"troubleshooting":"üîß Troubleshooting Steps:\n1. You've hit the AI provider's rate limit\n2. Solutions:\n   - Wait 60 seconds and try again\n   - Check your API key quota at your provider's dashboard\n   - Consider upgrading your API plan for higher limits\n   - If using free tier, you may need to wait until limits reset"},"duration":1,"msg":"AI workflow generation failed"}
{"level":50,"time":1768511840562,"env":"test","module":"ai-service","error":{},"duration":0,"msg":"AI workflow generation failed"}
{"level":30,"time":1768511840566,"env":"test","module":"workflow-quality-validator","overall":100,"breakdown":{"aliases":100,"types":100,"structure":100,"ux":100,"completeness":100,"validation":100},"issuesCount":0,"passed":true,"msg":"Workflow quality validation completed"}
{"level":30,"time":1768511840566,"env":"test","module":"ai-service","duration":0,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":100,"qualityBreakdown":{"aliases":100,"types":100,"structure":100,"ux":100,"completeness":100,"validation":100},"qualityPassed":true,"issuesCount":0,"msg":"AI workflow generation succeeded"}
{"level":30,"time":1768511840568,"env":"test","module":"workflow-quality-validator","overall":96,"breakdown":{"aliases":100,"types":100,"structure":80,"ux":100,"completeness":90,"validation":100},"issuesCount":2,"passed":true,"msg":"Workflow quality validation completed"}
{"level":30,"time":1768511840568,"env":"test","module":"ai-service","duration":0,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":96,"qualityBreakdown":{"aliases":100,"types":100,"structure":80,"ux":100,"completeness":90,"validation":100},"qualityPassed":true,"issuesCount":2,"msg":"AI workflow generation succeeded"}
{"level":30,"time":1768511840572,"env":"test","module":"ai-service","duration":1,"suggestionsCount":1,"msg":"AI binding suggestion succeeded"}
{"level":30,"time":1768511840573,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768511840573,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w102
‚è© Schema reused, skipping migrations.

 [32m‚úì[39m tests/unit/ai.service.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 2062[2mms[22m[39m
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w100.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w101.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w100.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511840658,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768511840659,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511840699,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w103, public

 [32m‚úì[39m tests/unit/HelperLibrary.test.ts [2m([22m[2m60 tests[22m[2m)[22m[33m 2131[2mms[22m[39m
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w101.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w103
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768511840747,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w104, public

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w105, public

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w104
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w105
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w102.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w103.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w102.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w102.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w103.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w102.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w109
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w109,public

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w103.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511840971,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511840971,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w110
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w110,public

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w103.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w109 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w109%2Cpublic

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511840994,"env":"test","msg":"DB: initializing... Local"}
 [32m‚úì[39m tests/integration/session.management.test.ts [2m([22m[2m22 tests[22m[2m)[22m[33m 2178[2mms[22m[39m
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w110 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w110%2Cpublic

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511841052,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511841053,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511841053,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511841053,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w106, public

 [32m‚úì[39m tests/integration/auth.routes.test.ts [2m([22m[2m41 tests[22m[2m)[22m[33m 2104[2mms[22m[39m
{"level":30,"time":1768511841109,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w106
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w111
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w111,public

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w105.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w104.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w105.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w112
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w112,public

[90mstderr[2m | tests/unit/shared/conditionEvaluator.test.ts[2m > [22m[2mconditionEvaluator[2m > [22m[2mComparison operators[2m > [22m[2mUnknown operator[2m > [22m[2mshould default to true and log warning
[22m[39mUnknown operator: unknown_operator

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w111 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w111%2Cpublic

{"level":30,"time":1768511841223,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511841223,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w104.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511841240,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511841240,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w112 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w112%2Cpublic

 [32m‚úì[39m tests/integration/api.ai.test.ts [2m([22m[2m32 tests[22m[2m)[22m[33m 2190[2mms[22m[39m
 [32m‚úì[39m tests/unit/shared/conditionEvaluator.test.ts [2m([22m[2m70 tests[22m[2m)[22m[33m 2158[2mms[22m[39m
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w107, public

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w108, public

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w107
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w114
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w114,public

{"level":30,"time":1768511841500,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511841501,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w108
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w106.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w106.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w114 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w114%2Cpublic

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

 [32m‚úì[39m tests/unit/services/TemplateAnalysisService.test.ts [2m([22m[2m27 tests[22m[2m)[22m[33m 2085[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w106.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w106.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mgetPendingInvitesForUser[2m > [22m[2mshould not return accepted invites
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,e884bc19-7f9a-44c8-825f-190f875a9fb3,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'e884bc19-7f9a-44c8-825f-190f875a9fb3'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768511841772,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511841773,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

{"level":30,"time":1768511841804,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511841804,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/client/list-choice-options.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 2051[2mms[22m[39m
 [32m‚úì[39m tests/unit/utils/conditionalLogic-simple.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2050[2mms[22m[39m
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511841855,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w116
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w116,public

{"level":30,"time":1768511841920,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511841925,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w116 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w116%2Cpublic

{"level":30,"time":1768511841998,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511842038,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768511842092,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511842150,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511842151,"env":"test","module":"email-queue","jobId":"7fd58f92-d2c1-48e2-9e9c-edd2a47a7ddf","to":"existing_1768511812103@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
{"level":30,"time":1768511842203,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mgetPendingInvitesForUser[2m > [22m[2mshould not return accepted invites
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,e884bc19-7f9a-44c8-825f-190f875a9fb3,{"after":{"invitedEmail":"existing_1768511812103@test.com","token":"2860f79299c78f2c4dff354e3c5ce62934aa81fb3c06d46ffd1eb71f5384838d"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'e884bc19-7f9a-44c8-825f-190f875a9fb3'[39m,
    [32m'{"after":{"invitedEmail":"existing_1768511812103@test.com","token":"2860f79299c78f2c4dff354e3c5ce62934aa81fb3c06d46ffd1eb71f5384838d"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:312:34
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w109, public

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w109
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w110, public

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w107.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w108.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w107.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w110
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w108.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ListTools.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w108.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w108.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w111, public

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w111
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w112, public

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w109.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w109.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511842597,"env":"test","workflowId":"123e4567-e89b-12d3-a456-426614174000","userId":"user-123","sectionsCount":2,"stepsCount":0,"logicRulesCount":1,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w112
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w115
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w115,public

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w110.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w110.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32m‚úì[39m tests/unit/services/WorkflowService.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 1501[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return workflow if user is the creator [33m 1039[2mms[22m[39m
[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w115 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w115%2Cpublic

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

{"level":30,"time":1768511842712,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511842712,"env":"test","msg":"DB: pool closed."}
{"level":40,"time":1768511842741,"env":"test","module":"auth-middleware","path":"/test","msg":"No authorization token provided"}
 [32m‚úì[39m tests/integration/conditions/conditionEvaluation.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 2176[2mms[22m[39m
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":50,"time":1768511842753,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768511842757,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768511842757,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768511842757,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768511842758,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768511842758,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768511842761,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768511842763,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768511842763,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768511842764,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768511842764,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768511842765,"env":"test","module":"auth-middleware","path":"/test","msg":"No authorization token provided"}
{"level":30,"time":1768511842766,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768511842766,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/middleware/auth.middleware.test.ts [2m([22m[2m22 tests[22m[2m)[22m[33m 2178[2mms[22m[39m
{"level":40,"time":1768511842830,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":40,"time":1768511842856,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":40,"time":1768511842863,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":40,"time":1768511842868,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":40,"time":1768511842871,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":30,"time":1768511842879,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768511842879,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768511842902,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511842903,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/isolatedVmBridge.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 2095[2mms[22m[39m
 [32m‚úì[39m tests/unit/utils/conditionalLogic.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 2091[2mms[22m[39m
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511842971,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mgetPendingInvitesForUser[2m > [22m[2mshould not return accepted invites
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000022,organization.invite_accept,organization,e884bc19-7f9a-44c8-825f-190f875a9fb3,{"after":{"email":"existing_1768511812103@test.com"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000022'[39m,
    [32m'organization.invite_accept'[39m,
    [32m'organization'[39m,
    [32m'e884bc19-7f9a-44c8-825f-190f875a9fb3'[39m,
    [32m'{"after":{"email":"existing_1768511812103@test.com"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.acceptInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:797:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:318:13
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768511843039,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w117
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w117,public

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w117 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w117%2Cpublic

{"level":30,"time":1768511843089,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511843140,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w119
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w119,public

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w119 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w119%2Cpublic

{"level":30,"time":1768511843292,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768511843342,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w116, public

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w116
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w120
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w120,public

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w117, public

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w111.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w112.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w111.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w120 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w120%2Cpublic

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w117
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511843545,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w112.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511843597,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w112.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w112.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w119, public

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w119
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w116.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w117.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w116.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w117.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511843889,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511843890,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts[2m > [22m[2mDatavaultColumnsService[2m > [22m[2mgetColumns[2m > [22m[2mshould throw 404 if table not found
[22m[39m[DEBUG] Table not found: 660e8400-e29b-41d4-a716-446655440001

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w120, public

 [32m‚úì[39m tests/integration/mfa.flow.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 2393[2mms[22m[39m
[90mstdout[2m | tests/ListTools.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w122
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w122,public

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w121
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w121,public

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w120
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ListTools.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w122 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w122%2Cpublic

{"level":30,"time":1768511844004,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w121 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w121%2Cpublic

{"level":30,"time":1768511844034,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511844035,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w119.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w119.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511844060,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511844054,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/services/DatavaultColumnsService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 1388[2mms[22m[39m
 [32m‚úì[39m tests/unit/services/MfaService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 1863[2mms[22m[39m
{"level":30,"time":1768511844110,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511844121,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511844122,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/services/EmailTemplateMetadataService.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 1360[2mms[22m[39m
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511844309,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511844310,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

 [32m‚úì[39m tests/unit/schema/collections.test.ts [2m([22m[2m34 tests[22m[2m)[22m[33m 1263[2mms[22m[39m
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mrevokeInvite[2m > [22m[2mshould allow admin to revoke invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,402000e1-8755-4053-b0b2-e9efa9c22419,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'402000e1-8755-4053-b0b2-e9efa9c22419'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w122, public

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w122
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w121, public

[90mstdout[2m | tests/ListTools.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w120.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w120.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w121
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w123
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w123,public

{"level":40,"time":1768511844777,"env":"test","sourceListVar":"nonexistent_list","inputKey":"nonexistent_list","msg":"Input list not found, treating as empty array"}
[90mstdout[2m | tests/ListTools.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511844779,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768511844779,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w127
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w127,public

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w123 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w123%2Cpublic

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w126
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w126,public

{"level":30,"time":1768511844819,"env":"test","msg":"DB: initializing... Local"}
 [32m‚úì[39m tests/ListTools.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 1224[2mms[22m[39m
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w127 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w127%2Cpublic

{"level":30,"time":1768511844850,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w126 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w126%2Cpublic

{"level":30,"time":1768511844869,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511844874,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511844875,"env":"test","module":"email-queue","jobId":"c0351a62-0cac-4bf8-9021-6f90fc80a5c8","to":"existing_1768511812103@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
{"level":30,"time":1768511844881,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511844882,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768511844915,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511844918,"env":"test","msg":"DB: initialized flag set."}
 [32m‚úì[39m tests/unit/schema/documentEngine.test.ts [2m([22m[2m33 tests[22m[2m)[22m[33m 1341[2mms[22m[39m
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mrevokeInvite[2m > [22m[2mshould allow admin to revoke invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,402000e1-8755-4053-b0b2-e9efa9c22419,{"after":{"invitedEmail":"existing_1768511812103@test.com","token":"8cff1b30fa9055986c13ae95a4aaaea25ed1d72b499c7daf7644a1217f140703"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'402000e1-8755-4053-b0b2-e9efa9c22419'[39m,
    [32m'{"after":{"invitedEmail":"existing_1768511812103@test.com","token":"8cff1b30fa9055986c13ae95a4aaaea25ed1d72b499c7daf7644a1217f140703"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:328:34
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w123, public

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w127, public

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w123
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w126, public

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w127
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w118
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w118,public

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w122.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w121.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w122.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w126
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w122.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w121.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w122.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w118 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w118%2Cpublic

{"level":30,"time":1768511845365,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w121.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w121.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w121.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w121.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768511845477,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mrevokeInvite[2m > [22m[2mshould allow admin to revoke invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: 00000000-0000-0000-0000-000000000098,00000000-0000-0000-0000-000000000021,organization.invite_revoke,organization,402000e1-8755-4053-b0b2-e9efa9c22419,{"after":{"inviteId":"9ba923eb-3d54-4562-8203-603cc9cf39bb","email":"existing_1768511812103@test.com"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [32m'00000000-0000-0000-0000-000000000098'[39m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_revoke'[39m,
    [32m'organization'[39m,
    [32m'402000e1-8755-4053-b0b2-e9efa9c22419'[39m,
    [32m'{"after":{"inviteId":"9ba923eb-3d54-4562-8203-603cc9cf39bb","email":"existing_1768511812103@test.com"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.revokeInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:840:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:334:13
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768511845635,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511845636,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768511845643,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768511845644,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511845644,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768511845644,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

 [32m‚úì[39m tests/unit/repositories/DocumentTemplateRepository.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 1347[2mms[22m[39m
 [32m‚úì[39m tests/services/BrandingService.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 1239[2mms[22m[39m
 [32m‚úì[39m tests/unit/lib/queries/QueryRunner.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 1217[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w118, public

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w118
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w123.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w126.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w127.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w123.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w126.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w127.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w128
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w128,public

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w129
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w129,public

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w128 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w128%2Cpublic

{"level":30,"time":1768511846143,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w129 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w129%2Cpublic

{"level":30,"time":1768511846183,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511846200,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768511846237,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w130
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w130,public

{"level":30,"time":1768511846297,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768511846297,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w124
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w124,public

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w125
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w125,public

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w130 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w130%2Cpublic

{"level":30,"time":1768511846335,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w124 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w124%2Cpublic

{"level":30,"time":1768511846373,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w131
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w131,public

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w125 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w125%2Cpublic

{"level":30,"time":1768511846381,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511846385,"env":"test","msg":"DB: initialized flag set."}
 [32m‚úì[39m tests/unit/workflow/PreviewExecution.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 1433[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w131 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w131%2Cpublic

{"level":30,"time":1768511846431,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511846431,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511846439,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511846482,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w128, public

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w132
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w132,public

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w129, public

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w128
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w132 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w132%2Cpublic

{"level":30,"time":1768511846606,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w129
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w118.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w118.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511846659,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w118.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w118.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w130, public

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w125, public

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w130
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w124, public

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w131, public

{"level":30,"time":1768511846831,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w125
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w129.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w128.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w129.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w124
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w131
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w128.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w129.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w128.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w129.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w128.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w128.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511846916,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511846917,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w128.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w128.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w128.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mrevokeInvite[2m > [22m[2mshould prevent accepting revoked invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,626af52e-1c04-49b3-9b25-98026c3a2cd7,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'626af52e-1c04-49b3-9b25-98026c3a2cd7'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

{"level":30,"time":1768511846955,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511846956,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w133
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w133,public

 [32m‚úì[39m tests/unit/repositories/DatavaultTablesRepository.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 1226[2mms[22m[39m
 [32m‚úì[39m tests/unit/services/DataSourceService.test.ts [2m([22m[2m9 tests[22m[2m)[22m[33m 1219[2mms[22m[39m
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w133 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w133%2Cpublic

{"level":30,"time":1768511847010,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w132, public

{"level":30,"time":1768511847059,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w132
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w125.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w124.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w131.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w130.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w125.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstderr[2m | tests/unit/debugging/Lineage.test.ts[2m > [22m[2mDebug & Lineage[2m > [22m[2mshould generate execution trace with lineage
[22m[39m[DEBUG Question] Node q1 executed. Key: userName, Value: Alice. Context keys: 3

{"level":30,"time":1768511847151,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511847152,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768511847156,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511847157,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w124.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould skip question when condition is false
[22m[39m[DEBUG Question] Node q1 executed. Key: has_code, Value: false. Context keys: 3

{"level":30,"time":1768511847201,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511847201,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould execute question when condition is true
[22m[39m[DEBUG Question] Node q1 executed. Key: has_code, Value: true. Context keys: 4

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould execute question when condition is true
[22m[39m[DEBUG Question] Node q2 executed. Key: code, Value: ABC123. Context keys: 5

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould skip compute node when condition is false
[22m[39m[DEBUG Question] Node q1 executed. Key: amount, Value: 0. Context keys: 3

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould execute compute node when condition is true
[22m[39m[DEBUG Question] Node q1 executed. Key: amount, Value: 100. Context keys: 3

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould handle complex workflow with multiple conditions
[22m[39m[DEBUG Question] Node q1 executed. Key: has_code, Value: false. Context keys: 4

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould handle complex workflow with multiple conditions
[22m[39m[DEBUG Question] Node q3 executed. Key: amount, Value: 1000. Context keys: 5

 [32m‚úì[39m tests/unit/services/StepService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 1299[2mms[22m[39m
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w131.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

 [32m‚úì[39m tests/unit/services/DocumentTemplateService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 1265[2mms[22m[39m
[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mDebug Mode[2m > [22m[2mshould return trace when debug is enabled
[22m[39m[DEBUG Question] Node q1 executed. Key: name, Value: John. Context keys: 3

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mDebug Mode[2m > [22m[2mshould not return trace when debug is disabled
[22m[39m[DEBUG Question] Node q1 executed. Key: name, Value: John. Context keys: 3

{"level":30,"time":1768511847274,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511847274,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w130.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32m‚úì[39m tests/unit/debugging/Lineage.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 1262[2mms[22m[39m
 [32m‚úì[39m tests/unit/engine.run-conditions.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 1345[2mms[22m[39m
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w133, public

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w133
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768511847474,"env":"test","module":"email-queue","jobId":"0094dbf1-97e8-4f7e-8a2c-95e6e9c84314","to":"existing_1768511812103@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w132.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w132.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

{"level":30,"time":1768511847555,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511847555,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mrevokeInvite[2m > [22m[2mshould prevent accepting revoked invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.invite_send,organization,626af52e-1c04-49b3-9b25-98026c3a2cd7,{"after":{"invitedEmail":"existing_1768511812103@test.com","token":"56e4f10d43b8db018461a74377c8a70d8d2d3796f6c663726f518cc6ec168d89"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'626af52e-1c04-49b3-9b25-98026c3a2cd7'[39m,
    [32m'{"after":{"invitedEmail":"existing_1768511812103@test.com","token":"56e4f10d43b8db018461a74377c8a70d8d2d3796f6c663726f518cc6ec168d89"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:344:34
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

 [32m‚úì[39m tests/unit/services/RecordService.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 1392[2mms[22m[39m
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511847765,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511847766,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w135
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w135,public

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w134
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w134,public

 [32m‚úì[39m tests/unit/services/CollectionService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 1217[2mms[22m[39m
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w135 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w135%2Cpublic

{"level":30,"time":1768511847825,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w134 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w134%2Cpublic

{"level":30,"time":1768511847855,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511847881,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768511847903,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mrevokeInvite[2m > [22m[2mshould prevent accepting revoked invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: 00000000-0000-0000-0000-000000000098,00000000-0000-0000-0000-000000000021,organization.invite_revoke,organization,626af52e-1c04-49b3-9b25-98026c3a2cd7,{"after":{"inviteId":"b62ed785-f82d-4bfb-b933-08ada8bc2ce4","email":"existing_1768511812103@test.com"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [32m'00000000-0000-0000-0000-000000000098'[39m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.invite_revoke'[39m,
    [32m'organization'[39m,
    [32m'626af52e-1c04-49b3-9b25-98026c3a2cd7'[39m,
    [32m'{"after":{"inviteId":"b62ed785-f82d-4bfb-b933-08ada8bc2ce4","email":"existing_1768511812103@test.com"}}'[39m
  ],
  cause: error: column "tenant_id" of relation "audit_logs" does not exist
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.revokeInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:840:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:350:13
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m132[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42703'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'33'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'parse_target.c'[39m,
    line: [32m'1065'[39m,
    routine: [32m'checkInsertTargets'[39m
  }
}

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w135, public

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w134, public

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w135
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w134
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w136
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w136,public

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w133.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w133.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w133.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w133.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w136 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w136%2Cpublic

{"level":30,"time":1768511848358,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511848411,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w138
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w138,public

{"level":30,"time":1768511848598,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511848598,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w138 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w138%2Cpublic

{"level":30,"time":1768511848601,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511848606,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511848607,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/services/CollectionFieldService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 1230[2mms[22m[39m
{"level":30,"time":1768511848657,"env":"test","msg":"DB: initialized flag set."}
 [32m‚úì[39m tests/integration/datavault.api-tokens.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 1209[2mms[22m[39m
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w136, public

{"level":30,"time":1768511848778,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511848779,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w136
‚è© Schema reused, skipping migrations.

 [32m‚úì[39m tests/integration/organizationInvites.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 36663[2mms[22m[39m
       [33m[2m‚úì[22m[39m should create placeholder user for non-existent email [33m 2003[2mms[22m[39m
       [33m[2m‚úì[22m[39m should create invite for existing user without creating placeholder [33m 1878[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent duplicate pending invites [33m 2186[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent inviting existing members [33m 1315[2mms[22m[39m
       [33m[2m‚úì[22m[39m should require admin access to create invite [33m 1453[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set expiry to 7 days from now [33m 1985[2mms[22m[39m
       [33m[2m‚úì[22m[39m should accept invite and create membership [33m 2668[2mms[22m[39m
       [33m[2m‚úì[22m[39m should convert placeholder user to real user on accept [33m 2728[2mms[22m[39m
       [33m[2m‚úì[22m[39m should reject expired invite [33m 2017[2mms[22m[39m
       [33m[2m‚úì[22m[39m should reject already accepted invite [33m 2570[2mms[22m[39m
       [33m[2m‚úì[22m[39m should verify email matches invite [33m 1912[2mms[22m[39m
       [33m[2m‚úì[22m[39m should reject invalid token [33m 1044[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return pending invites for user email [33m 1904[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not return expired invites [33m 1959[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not return accepted invites [33m 2682[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow admin to revoke invite [33m 2605[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent accepting revoked invite [33m 2559[2mms[22m[39m
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w134.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w135.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w134.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w135.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w146
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w146,public

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w138, public

[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w146 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w146%2Cpublic

[90mstderr[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): Error: [vitest] No "closeDatabase" export is defined on the "../../../server/db" mock. Did you forget to return it from "vi.mock"?
If you need to partially mock a module, you can use "importOriginal" helper inside:

    at VitestMocker.createError [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:311:17[90m)[39m
    at Object.get [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:384:16[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:144:34
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m {
  codeFrame: [32m'vi.mock(import("../../../server/db"), async (importOriginal) => {\n'[39m +
    [32m'  const actual = await importOriginal()\n'[39m +
    [32m'  return {\n'[39m +
    [32m'    ...actual,\n'[39m +
    [32m'    // your mocked methods\n'[39m +
    [32m'  }\n'[39m +
    [32m'})'[39m
}

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w138
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768511849061,"env":"test","module":"write-runner","operation":"write_start","mode":"create","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"create","columnMappings":[{"columnId":"col-first","value":"{{ firstName }}"},{"columnId":"col-last","value":"Doe"},{"columnId":"col-age","value":"{{ age }}"}]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
{"level":30,"time":1768511849072,"env":"test","module":"write-runner","operation":"write_start","mode":"create","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"create","columnMappings":[]},"tableId":"table-users","preview":true,"msg":"Starting write execution"}
[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511849072,"env":"test","module":"write-runner","operation":"write_preview_simulated","values":{},"msg":"Simulating write in preview mode"}
{"level":30,"time":1768511849074,"env":"test","module":"write-runner","operation":"write_start","mode":"update","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"test@example.com","columnMappings":[{"columnId":"col-status","value":"Active"}]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
{"level":30,"time":1768511849076,"env":"test","module":"write-runner","operation":"write_start","mode":"update","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"missing@example.com","columnMappings":[]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
{"level":50,"time":1768511849076,"env":"test","module":"write-runner","error":{},"config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"missing@example.com","columnMappings":[]},"msg":"Write execution failed"}
 [32m‚úì[39m tests/unit/writes/WriteRunner.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 549[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w136.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w136.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511849167,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511849168,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

 [32m‚úì[39m tests/integration/branding.routes.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 1246[2mms[22m[39m
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w140
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w140,public

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w140 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w140%2Cpublic

{"level":30,"time":1768511849318,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511849369,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768511849369,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511849376,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w144
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w144,public

 [32m‚úì[39m tests/unit/services/DatavaultTablesService.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 1259[2mms[22m[39m
[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w144 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w144%2Cpublic

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w142
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w142,public

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w142 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w142%2Cpublic

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

 [32m‚úì[39m tests/unit/services/BrandingService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 488[2mms[22m[39m
[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/services/PortalAuthService.test.ts [2m([22m[2m42 tests[22m[2m)[22m[33m 614[2mms[22m[39m
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w140, public

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w143
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w143,public

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w140
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w143 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w143%2Cpublic

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

{"level":40,"time":1768511849796,"env":"test","hookId":"hook-1","hookName":"Hook 1","error":"Test error","msg":"LifecycleHookService: Hook execution failed"}
[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":50,"time":1768511849801,"env":"test","error":{},"workflowId":"workflow-1","runId":"run-1","phase":"beforePage","msg":"LifecycleHookService: Failed to execute hooks for phase"}
{"level":30,"time":1768511849805,"env":"test","hookId":"hook-1","workflowId":"workflow-1","phase":"beforePage","msg":"LifecycleHookService: Created lifecycle hook"}
{"level":30,"time":1768511849811,"env":"test","hookId":"hook-1","workflowId":"workflow-1","msg":"LifecycleHookService: Updated lifecycle hook"}
{"level":30,"time":1768511849813,"env":"test","hookId":"hook-1","workflowId":"workflow-1","msg":"LifecycleHookService: Deleted lifecycle hook"}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w138.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w138.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w145
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w145,public

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

 [32m‚úì[39m tests/unit/LifecycleHookService.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 500[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w145 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w145%2Cpublic

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

 [32m‚úì[39m tests/unit/services/DatavaultReferenceColumns.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 479[2mms[22m[39m
{"level":30,"time":1768511850088,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511850089,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

 [32m‚úì[39m tests/unit/repositories/DatavaultColumnsRepository.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 1238[2mms[22m[39m
[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w149
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w149,public

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w149 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w149%2Cpublic

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

{"level":30,"time":1768511850225,"env":"test","msg":"External Send Completed","destination":"My Webhook","success":true,"status":200}
[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w148
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w148,public

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511850231,"env":"test","msg":"Simulating External Send","destination":"Test","payload":{}}
 [32m‚úì[39m tests/unit/external/ExternalSendRunner.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 481[2mms[22m[39m
[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w148 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w148%2Cpublic

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

 [32m‚úì[39m tests/unit/services/Guardrail.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 484[2mms[22m[39m
[90mstdout[2m | tests/unit/collab.server.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w147
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w147,public

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w147 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w147%2Cpublic

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/repositories/DatavaultRowsRepository.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 457[2mms[22m[39m
[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w150
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w150,public

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w150 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w150%2Cpublic

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w151
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w151,public

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/services/EmailTemplateMetadataService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 469[2mms[22m[39m
[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w151 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w151%2Cpublic

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/services/AuditLogService.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 445[2mms[22m[39m
{"level":30,"time":1768511851383,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w153
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w153,public

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w152
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w152,public

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w153 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w153%2Cpublic

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/collab.server.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w152 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w152%2Cpublic

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

 [32m‚úì[39m tests/unit/engine/FinalBlockSnapshot.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 459[2mms[22m[39m
[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/services/AccountLockoutService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 467[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w139
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w139,public

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w141
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w141,public

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w139 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w139%2Cpublic

{"level":30,"time":1768511851678,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w154
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w154,public

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w141 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w141%2Cpublic

{"level":30,"time":1768511851705,"env":"test","msg":"DB: initializing... Local"}
 [2m[90m‚Üì[39m[22m tests/unit/collab.server.test.ts [2m([22m[2m14 tests[22m[2m | [22m[33m14 skipped[39m[2m)[22m
{"level":30,"time":1768511851733,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w154 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w154%2Cpublic

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

{"level":30,"time":1768511851764,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/services/DatavaultRowsService.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 443[2mms[22m[39m
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m‚úÖ OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w139, public

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w141, public

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w139
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w141
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w140.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w140.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w113
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w113,public

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w140.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w140.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w113 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w113%2Cpublic

{"level":30,"time":1768511852233,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511852273,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511852408,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511852408,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768511852438,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511852439,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/datavault.routes.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 1152[2mms[22m[39m
 [32m‚úì[39m tests/integration/datavault.row-notes.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 1174[2mms[22m[39m
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w113, public

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w113
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w141.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w139.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w141.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w139.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m‚úÖ OpenAPI specification loaded successfully

{"level":30,"time":1768511852967,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts[2m > [22m[2mPersonalization API Integration Tests
[22m[39müìö API Documentation available at /api-docs
[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768511852975,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768511852976,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768511852981,"env":"test","module":"documents-routes","msg":"Document routes registered"}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w137
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w137,public

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w137 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w137%2Cpublic

{"level":30,"time":1768511853279,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768511853316,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768511853402,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511853403,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/api.ai.personalization.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 1576[2mms[22m[39m
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w137, public

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w137
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w113.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w113.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768511853950,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768511853969,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts[2m > [22m[2mAI Document Assistant API Integration Tests
[22m[39müìö API Documentation available at /api-docs
[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768511853958,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768511853958,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768511853963,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768511853968,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768511853968,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768511853969,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768511853969,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":40,"time":1768511853992,"env":"test","error":{},"msg":"Deterministic DOCX extraction failed"}
{"level":30,"time":1768511854032,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768511854033,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/api.ai.doc.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 1153[2mms[22m[39m

[31m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[39m[1m[41m Failed Suites 21 [49m[22m[31m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[39m

[41m[1m FAIL [22m[49m tests/integration/api.dataSources.native.test.ts[2m [ tests/integration/api.dataSources.native.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/api.expression-validation.test.ts[2m [ tests/integration/api.expression-validation.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/api.projects.test.ts[2m [ tests/integration/api.projects.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/api.runs.docx.test.ts[2m [ tests/integration/api.runs.docx.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/api.runs.graph.test.ts[2m [ tests/integration/api.runs.graph.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/api.snapshots.test.ts[2m [ tests/integration/api.snapshots.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/api.templates-runs.test.ts[2m [ tests/integration/api.templates-runs.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/api.workflows.test.ts[2m [ tests/integration/api.workflows.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/datavault-v4-regression.test.ts[2m [ tests/integration/datavault-v4-regression.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/datavault.permissions.test.ts[2m [ tests/integration/datavault.permissions.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/intake.workflow.test.ts[2m [ tests/integration/intake.workflow.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/js_helpers.test.ts[2m [ tests/integration/js_helpers.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/lifecycle-hooks-execution.test.ts[2m [ tests/integration/lifecycle-hooks-execution.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/auth/auth.middleware.integration.test.ts[2m [ tests/integration/auth/auth.middleware.integration.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/auth/jwt.authentication.test.ts[2m [ tests/integration/auth/jwt.authentication.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/auth/protected.routes.test.ts[2m [ tests/integration/auth/protected.routes.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/auth/session.management.integration.test.ts[2m [ tests/integration/auth/session.management.integration.test.ts ][22m
[31m[1mTypeError[22m: () => ({
      getGenerativeModel: __vite_ssr_import_0__.vi.fn().mockReturnValue({
        generateContent: __v...<omitted>...}) is not a constructor[39m
[36m [2m‚ùØ[22m new DocumentAIAssistService server/lib/ai/DocumentAIAssistService.ts:[2m43:26[22m[39m
    [90m 41| [39m        [35mconst[39m apiKey [33m=[39m process[33m.[39menv[33m.[39m[33mGEMINI_API_KEY[39m[33m;[39m
    [90m 42| [39m        [35mif[39m (apiKey) {
    [90m 43| [39m            [35mthis[39m[33m.[39mgenAI [33m=[39m [35mnew[39m [33mGoogleGenerativeAI[39m(apiKey)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m 44| [39m            const model = process.env.GEMINI_MODEL || "gemini-2.0-flas‚Ä¶
    [90m 45| [39m            [35mthis[39m[33m.[39mmodel [33m=[39m [35mthis[39m[33m.[39mgenAI[33m.[39m[34mgetGenerativeModel[39m({ model })[33m;[39m
[90m [2m‚ùØ[22m server/lib/ai/DocumentAIAssistService.ts:[2m258:40[22m[39m
[90m [2m‚ùØ[22m server/routes/ai.doc.routes.ts:[2m5:1[22m[39m
[90m [2m‚ùØ[22m server/routes/index.ts:[2m9:1[22m[39m
[90m [2m‚ùØ[22m server/routes.ts:[2m11:1[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[1/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/workflow_versioning.test.ts[2m > [22mWorkflow Versioning & Lineage
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, default, $2, $3, default, default, default, default, default, default, default, default, default, default, default, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Versioning Test Workflow,69278086-d992-447b-9eac-b4e387ee63b3,69278086-d992-447b-9eac-b4e387ee63b3[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/workflow_versioning.test.ts:[2m48:28[22m[39m
    [90m 46| [39m
    [90m 47| [39m        [90m// Create Workflow[39m
    [90m 48| [39m        [35mconst[39m [workflow] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m                           [31m^[39m
    [90m 49| [39m
    [90m 50| [39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/workflow_versioning.test.ts:[2m48:28[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 474, severity: 'ERROR', code: '23502', detail: 'Failing row contains (4b2c4da4-4037-4e0a-adbb-e61e791084fb, Versioning Test Workflow, null, 69278086-d992-447b-9eac-b4e387ee63b3, null, 2026-01-15 21:16:39.116751, 2026-01-15 21:16:39.116751, 69278086-d992-447b-9eac-b4e387ee63b3, null, null, null, null, null, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[2/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/api.ai.logic.test.ts[2m [ tests/unit/api.ai.logic.test.ts ][22m
[41m[1m FAIL [22m[49m tests/unit/api.ai.revise.test.ts[2m [ tests/unit/api.ai.revise.test.ts ][22m
[41m[1m FAIL [22m[49m tests/unit/debug_import.test.ts[2m [ tests/unit/debug_import.test.ts ][22m
[31m[1mTypeError[22m: () => ({
      getGenerativeModel: __vite_ssr_import_0__.vi.fn().mockReturnValue({
        generateContent: __v...<omitted>...}) is not a constructor[39m
[36m [2m‚ùØ[22m new GeminiService server/services/geminiService.ts:[2m27:18[22m[39m
    [90m 25| [39m    }
    [90m 26| [39m
    [90m 27| [39m    [35mthis[39m[33m.[39mgenAI [33m=[39m [35mnew[39m [33mGoogleGenerativeAI[39m(apiKey)[33m;[39m
    [90m   | [39m                 [31m^[39m
    [90m 28| [39m    // Use configurable Gemini model from env, fallback to gemini-2.0-‚Ä¶
    [90m 29| [39m    [35mconst[39m model [33m=[39m process[33m.[39menv[33m.[39m[33mGEMINI_MODEL[39m [33m||[39m [32m"gemini-2.0-flash"[39m[33m;[39m
[90m [2m‚ùØ[22m server/services/geminiService.ts:[2m299:30[22m[39m
[90m [2m‚ùØ[22m server/controllers/AiController.ts:[2m16:1[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[3/138]‚éØ[22m[39m


[31m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[39m[1m[41m Failed Tests 117 [49m[22m[31m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[39m

[41m[1m FAIL [22m[49m tests/integration/analytics_preservation.test.ts[2m > [22mAnalytics Preservation[2m > [22mshould preserve lifetime user count when a user is deleted
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')[39m
[90m [2m‚ùØ[22m getTableColumns node_modules/drizzle-orm/utils.js:[2m109:15[22m[39m
[90m [2m‚ùØ[22m PgSelectBuilder.from node_modules/drizzle-orm/pg-core/query-builders/select.js:[2m62:16[22m[39m
[36m [2m‚ùØ[22m SystemStatsRepository.getOrInitialize server/repositories/SystemStatsRepository.ts:[2m18:35[22m[39m
    [90m 16| [39m   */[39m
    [90m 17| [39m  [35masync[39m [34mgetOrInitialize[39m()[33m:[39m [33mPromise[39m[33m<[39m[33mSystemStats[39m[33m>[39m {
    [90m 18| [39m    let stats = await db.select().from(systemStats).where(eq(systemSta‚Ä¶
    [90m   | [39m                                  [31m^[39m
    [90m 19| [39m
    [90m 20| [39m    [35mif[39m (stats[33m.[39mlength [33m===[39m [34m0[39m) {
[90m [2m‚ùØ[22m SystemStatsRepository.getStats server/repositories/SystemStatsRepository.ts:[2m133:17[22m[39m
[90m [2m‚ùØ[22m tests/integration/analytics_preservation.test.ts:[2m18:58[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[4/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mComplete Registration ‚Üí Login Flow[2m > [22mshould complete registration, verify email, then login
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m97:36[22m[39m
    [90m 95| [39m        [33m.[39m[34msend[39m({ email[33m,[39m password })[33m;[39m
    [90m 96| [39m
    [90m 97| [39m      [34mexpect[39m(loginAttempt2[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                   [31m^[39m
    [90m 98| [39m      [34mexpect[39m(loginAttempt2[33m.[39mbody[33m.[39mtoken)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m 99| [39m      [34mexpect[39m(loginAttempt2[33m.[39mbody[33m.[39muser[33m.[39memailVerified)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[5/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mMFA Enrollment and Login Flow[2m > [22mshould complete MFA setup and login with TOTP
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m197:36[22m[39m
    [90m195| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m196| [39m
    [90m197| [39m      [34mexpect[39m(setupResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                   [31m^[39m
    [90m198| [39m      [34mexpect[39m(setupResponse[33m.[39mbody[33m.[39mqrCodeDataUrl)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m199| [39m      [34mexpect[39m(setupResponse[33m.[39mbody[33m.[39mbackupCodes)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[6/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mMFA Enrollment and Login Flow[2m > [22mshould login with backup code when TOTP unavailable
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'secret')[39m
[36m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m279:52[22m[39m
    [90m277| [39m      })[33m;[39m
    [90m278| [39m
    [90m279| [39m      [35mconst[39m totpCode [33m=[39m [34mgenerateTotpCode[39m(mfaSecret[33m![39m[33m.[39msecret)[33m;[39m
    [90m   | [39m                                                   [31m^[39m
    [90m280| [39m
    [90m281| [39m      [35mawait[39m [34mrequest[39m(app)

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[7/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mPassword Reset Flow[2m > [22mshould complete full password reset flow
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m364:36[22m[39m
    [90m362| [39m        })[33m;[39m
    [90m363| [39m
    [90m364| [39m      [34mexpect[39m(resetResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                   [31m^[39m
    [90m365| [39m
    [90m366| [39m      [90m// Step 4: Verify old password no longer works[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[8/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mSession Management Flow[2m > [22mshould list all active sessions
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m528:39[22m[39m
    [90m526| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m527| [39m
    [90m528| [39m      [34mexpect[39m(sessionsResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                      [31m^[39m
    [90m529| [39m      [34mexpect[39m(sessionsResponse[33m.[39mbody[33m.[39msessions)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m530| [39m      expect(sessionsResponse.body.sessions.length).toBeGreaterThanOrE‚Ä¶

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[9/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mSession Management Flow[2m > [22mshould revoke specific session
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m554:40[22m[39m
    [90m552| [39m
    [90m553| [39m      [35mconst[39m sessions [33m=[39m sessionsResponse[33m.[39mbody[33m.[39msessions[33m;[39m
    [90m554| [39m      [35mconst[39m sessionToRevoke [33m=[39m sessions[33m.[39m[34mfind[39m((s[33m:[39m any) [33m=>[39m [33m![39ms[33m.[39mcurrent)[33m;[39m
    [90m   | [39m                                       [31m^[39m
    [90m555| [39m
    [90m556| [39m      [90m// Revoke first session[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[10/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould login with valid credentials
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m171:31[22m[39m
    [90m169| [39m        [33m.[39m[34msend[39m({ email[33m,[39m password })[33m;[39m
    [90m170| [39m
    [90m171| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m172| [39m      [34mexpect[39m((response[33m.[39mbody)[33m.[39mmessage)[33m.[39m[34mtoBe[39m([32m"Login successful"[39m)[33m;[39m
    [90m173| [39m      [34mexpect[39m((response[33m.[39mbody)[33m.[39mtoken)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[11/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/reset-password[2m > [22mshould reset password with valid token
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m439:31[22m[39m
    [90m437| [39m        })[33m;[39m
    [90m438| [39m
    [90m439| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m440| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoContain[39m([32m"Password updated"[39m)[33m;[39m
    [90m441| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[12/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mGET /api/auth/me[2m > [22mshould return current user for valid token
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m500:31[22m[39m
    [90m498| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m499| [39m
    [90m500| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m501| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39memail)[33m.[39m[34mtoBe[39m(email)[33m;[39m
    [90m502| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mid)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[13/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mField Management[2m > [22mshould create text field
[31m[1mError[22m: Failed query: insert into "collection_fields" ("id", "collection_id", "name", "slug", "type", "is_required", "options", "default_value", "order", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, default, default, default, default, default) returning "id", "collection_id", "name", "slug", "type", "is_required", "options", "default_value", "order", "created_at", "updated_at"
params: 06601baf-0281-4f25-8b41-ceb2e550a5e4,First Name,first_name,text,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m CollectionFieldRepository.create server/repositories/BaseRepository.ts:[2m90:22[22m[39m
    [90m 88| [39m    [35mconst[39m database [33m=[39m [35mthis[39m[33m.[39m[34mgetDb[39m(tx)[33m;[39m
    [90m 89| [39m
    [90m 90| [39m    [35mconst[39m [record] [33m=[39m [35mawait[39m database
    [90m   | [39m                     [31m^[39m
    [90m 91| [39m      [33m.[39m[34minsert[39m([35mthis[39m[33m.[39mtable [35mas[39m any)
    [90m 92| [39m      [33m.[39m[34mvalues[39m(data [35mas[39m any)
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m115:21[22m[39m

[31m[1mCaused by: error[22m: column "type" of relation "collection_fields" does not exist[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m CollectionFieldRepository.create server/repositories/BaseRepository.ts:[2m90:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m115:21[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 134, severity: 'ERROR', code: '42703', detail: undefined, hint: undefined, position: '73', internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: 'parse_target.c', routine: 'checkInsertTargets' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[14/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mField Management[2m > [22mshould create email field
[31m[1mError[22m: Failed query: insert into "collection_fields" ("id", "collection_id", "name", "slug", "type", "is_required", "options", "default_value", "order", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, default, default, default, default, default) returning "id", "collection_id", "name", "slug", "type", "is_required", "options", "default_value", "order", "created_at", "updated_at"
params: 06601baf-0281-4f25-8b41-ceb2e550a5e4,Email Address,email_address,text,true[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m CollectionFieldRepository.create server/repositories/BaseRepository.ts:[2m90:22[22m[39m
    [90m 88| [39m    [35mconst[39m database [33m=[39m [35mthis[39m[33m.[39m[34mgetDb[39m(tx)[33m;[39m
    [90m 89| [39m
    [90m 90| [39m    [35mconst[39m [record] [33m=[39m [35mawait[39m database
    [90m   | [39m                     [31m^[39m
    [90m 91| [39m      [33m.[39m[34minsert[39m([35mthis[39m[33m.[39mtable [35mas[39m any)
    [90m 92| [39m      [33m.[39m[34mvalues[39m(data [35mas[39m any)
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m133:21[22m[39m

[31m[1mCaused by: error[22m: column "type" of relation "collection_fields" does not exist[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m CollectionFieldRepository.create server/repositories/BaseRepository.ts:[2m90:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m133:21[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 134, severity: 'ERROR', code: '42703', detail: undefined, hint: undefined, position: '73', internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: 'parse_target.c', routine: 'checkInsertTargets' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[15/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mField Management[2m > [22mshould create number field
[31m[1mError[22m: Failed query: insert into "collection_fields" ("id", "collection_id", "name", "slug", "type", "is_required", "options", "default_value", "order", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, default, $6, default, default, default) returning "id", "collection_id", "name", "slug", "type", "is_required", "options", "default_value", "order", "created_at", "updated_at"
params: 06601baf-0281-4f25-8b41-ceb2e550a5e4,Age,age,number,false,0[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m CollectionFieldRepository.create server/repositories/BaseRepository.ts:[2m90:22[22m[39m
    [90m 88| [39m    [35mconst[39m database [33m=[39m [35mthis[39m[33m.[39m[34mgetDb[39m(tx)[33m;[39m
    [90m 89| [39m
    [90m 90| [39m    [35mconst[39m [record] [33m=[39m [35mawait[39m database
    [90m   | [39m                     [31m^[39m
    [90m 91| [39m      [33m.[39m[34minsert[39m([35mthis[39m[33m.[39mtable [35mas[39m any)
    [90m 92| [39m      [33m.[39m[34mvalues[39m(data [35mas[39m any)
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m146:21[22m[39m

[31m[1mCaused by: error[22m: column "type" of relation "collection_fields" does not exist[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m CollectionFieldRepository.create server/repositories/BaseRepository.ts:[2m90:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m146:21[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 134, severity: 'ERROR', code: '42703', detail: undefined, hint: undefined, position: '73', internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: 'parse_target.c', routine: 'checkInsertTargets' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[16/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mField Management[2m > [22mshould create select field with options
[31m[1mError[22m: Failed query: insert into "collection_fields" ("id", "collection_id", "name", "slug", "type", "is_required", "options", "default_value", "order", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default) returning "id", "collection_id", "name", "slug", "type", "is_required", "options", "default_value", "order", "created_at", "updated_at"
params: 06601baf-0281-4f25-8b41-ceb2e550a5e4,Status,status,select,true,["active","inactive","pending"],"pending"[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m CollectionFieldRepository.create server/repositories/BaseRepository.ts:[2m90:22[22m[39m
    [90m 88| [39m    [35mconst[39m database [33m=[39m [35mthis[39m[33m.[39m[34mgetDb[39m(tx)[33m;[39m
    [90m 89| [39m
    [90m 90| [39m    [35mconst[39m [record] [33m=[39m [35mawait[39m database
    [90m   | [39m                     [31m^[39m
    [90m 91| [39m      [33m.[39m[34minsert[39m([35mthis[39m[33m.[39mtable [35mas[39m any)
    [90m 92| [39m      [33m.[39m[34mvalues[39m(data [35mas[39m any)
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m161:21[22m[39m

[31m[1mCaused by: error[22m: column "type" of relation "collection_fields" does not exist[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m CollectionFieldRepository.create server/repositories/BaseRepository.ts:[2m90:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m161:21[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 134, severity: 'ERROR', code: '42703', detail: undefined, hint: undefined, position: '73', internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: 'parse_target.c', routine: 'checkInsertTargets' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[17/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mField Management[2m > [22mshould create boolean field
[31m[1mError[22m: Failed query: insert into "collection_fields" ("id", "collection_id", "name", "slug", "type", "is_required", "options", "default_value", "order", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, default, $6, default, default, default) returning "id", "collection_id", "name", "slug", "type", "is_required", "options", "default_value", "order", "created_at", "updated_at"
params: 06601baf-0281-4f25-8b41-ceb2e550a5e4,Is Premium,is_premium,boolean,false,false[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m CollectionFieldRepository.create server/repositories/BaseRepository.ts:[2m90:22[22m[39m
    [90m 88| [39m    [35mconst[39m database [33m=[39m [35mthis[39m[33m.[39m[34mgetDb[39m(tx)[33m;[39m
    [90m 89| [39m
    [90m 90| [39m    [35mconst[39m [record] [33m=[39m [35mawait[39m database
    [90m   | [39m                     [31m^[39m
    [90m 91| [39m      [33m.[39m[34minsert[39m([35mthis[39m[33m.[39mtable [35mas[39m any)
    [90m 92| [39m      [33m.[39m[34mvalues[39m(data [35mas[39m any)
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m178:21[22m[39m

[31m[1mCaused by: error[22m: column "type" of relation "collection_fields" does not exist[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m CollectionFieldRepository.create server/repositories/BaseRepository.ts:[2m90:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m178:21[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 134, severity: 'ERROR', code: '42703', detail: undefined, hint: undefined, position: '73', internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: 'parse_target.c', routine: 'checkInsertTargets' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[18/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mField Management[2m > [22mshould list all fields
[31m[1mError[22m: Failed query: select "id", "collection_id", "name", "slug", "type", "is_required", "options", "default_value", "order", "created_at", "updated_at" from "collection_fields" where "collection_fields"."collection_id" = $1 order by "collection_fields"."created_at" asc
params: 06601baf-0281-4f25-8b41-ceb2e550a5e4[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m193:22[22m[39m
    [90m191| [39m
    [90m192| [39m    [34mit[39m([32m'should list all fields'[39m[33m,[39m [35masync[39m () [33m=>[39m {
    [90m193| [39m      const fields = await collectionFieldService.listFields(testColle‚Ä¶
    [90m   | [39m                     [31m^[39m
    [90m194| [39m
    [90m195| [39m      [34mexpect[39m(fields[33m.[39mlength)[33m.[39m[34mtoBe[39m([34m5[39m)[33m;[39m

[31m[1mCaused by: error[22m: column "type" does not exist[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m193:22[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 104, severity: 'ERROR', code: '42703', detail: undefined, hint: undefined, position: '47', internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: 'parse_relation.c', routine: 'errorMissingColumn' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[19/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mField Management[2m > [22mshould update field
[31m[1mError[22m: Failed query: select "id", "collection_id", "name", "slug", "type", "is_required", "options", "default_value", "order", "created_at", "updated_at" from "collection_fields" where "collection_fields"."id" = $1
params: [39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m CollectionFieldRepository.findById server/repositories/BaseRepository.ts:[2m57:22[22m[39m
    [90m 55| [39m    [35mconst[39m idColumn [33m=[39m ([35mthis[39m[33m.[39mtable [35mas[39m any)[33m.[39mid[33m;[39m
    [90m 56| [39m
    [90m 57| [39m    [35mconst[39m [record] [33m=[39m [35mawait[39m database
    [90m   | [39m                     [31m^[39m
    [90m 58| [39m      [33m.[39m[34mselect[39m()
    [90m 59| [39m      [33m.[39m[35mfrom[39m([35mthis[39m[33m.[39mtable [35mas[39m any)
[90m [2m‚ùØ[22m CollectionFieldService.verifyFieldOwnership server/services/CollectionFieldService.ts:[2m70:19[22m[39m
[90m [2m‚ùØ[22m CollectionFieldService.updateField server/services/CollectionFieldService.ts:[2m206:5[22m[39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m206:23[22m[39m

[31m[1mCaused by: error[22m: column "type" does not exist[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m CollectionFieldRepository.findById server/repositories/BaseRepository.ts:[2m57:22[22m[39m
[90m [2m‚ùØ[22m CollectionFieldService.verifyFieldOwnership server/services/CollectionFieldService.ts:[2m70:19[22m[39m
[90m [2m‚ùØ[22m CollectionFieldService.updateField server/services/CollectionFieldService.ts:[2m206:5[22m[39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m206:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 104, severity: 'ERROR', code: '42703', detail: undefined, hint: undefined, position: '47', internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: 'parse_relation.c', routine: 'errorMissingColumn' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[20/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mRecord CRUD Operations[2m > [22mshould create a record
[31m[1mError[22m: Failed query: select "id", "collection_id", "name", "slug", "type", "is_required", "options", "default_value", "order", "created_at", "updated_at" from "collection_fields" where "collection_fields"."collection_id" = $1 order by "collection_fields"."created_at" asc
params: 06601baf-0281-4f25-8b41-ceb2e550a5e4[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m RecordService.applyDefaults server/services/RecordService.ts:[2m193:20[22m[39m
    [90m191| [39m    tx[33m?[39m[33m:[39m [33mDbTransaction[39m
    [90m192| [39m  )[33m:[39m [33mPromise[39m[33m<[39m[33mRecord[39m[33m<[39mstring[33m,[39m any[33m>>[39m {
    [90m193| [39m    const fields = await this.fieldRepo.findByCollectionId(collectionI‚Ä¶
    [90m   | [39m                   [31m^[39m
    [90m194| [39m    [35mconst[39m enrichedData [33m=[39m { [33m...[39mdata }[33m;[39m
    [90m195| [39m
[90m [2m‚ùØ[22m RecordService.createRecord server/services/RecordService.ts:[2m220:26[22m[39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m219:22[22m[39m

[31m[1mCaused by: error[22m: column "type" does not exist[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m RecordService.applyDefaults server/services/RecordService.ts:[2m193:20[22m[39m
[90m [2m‚ùØ[22m RecordService.createRecord server/services/RecordService.ts:[2m220:26[22m[39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m219:22[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 104, severity: 'ERROR', code: '42703', detail: undefined, hint: undefined, position: '47', internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: 'parse_relation.c', routine: 'errorMissingColumn' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[21/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mRecord CRUD Operations[2m > [22mshould create multiple records
[31m[1mError[22m: Failed query: select "id", "collection_id", "name", "slug", "type", "is_required", "options", "default_value", "order", "created_at", "updated_at" from "collection_fields" where "collection_fields"."collection_id" = $1 order by "collection_fields"."created_at" asc
params: 06601baf-0281-4f25-8b41-ceb2e550a5e4[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m RecordService.applyDefaults server/services/RecordService.ts:[2m193:20[22m[39m
    [90m191| [39m    tx[33m?[39m[33m:[39m [33mDbTransaction[39m
    [90m192| [39m  )[33m:[39m [33mPromise[39m[33m<[39m[33mRecord[39m[33m<[39mstring[33m,[39m any[33m>>[39m {
    [90m193| [39m    const fields = await this.fieldRepo.findByCollectionId(collectionI‚Ä¶
    [90m   | [39m                   [31m^[39m
    [90m194| [39m    [35mconst[39m enrichedData [33m=[39m { [33m...[39mdata }[33m;[39m
    [90m195| [39m
[90m [2m‚ùØ[22m RecordService.createRecord server/services/RecordService.ts:[2m220:26[22m[39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m241:23[22m[39m

[31m[1mCaused by: error[22m: column "type" does not exist[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m RecordService.applyDefaults server/services/RecordService.ts:[2m193:20[22m[39m
[90m [2m‚ùØ[22m RecordService.createRecord server/services/RecordService.ts:[2m220:26[22m[39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m241:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 104, severity: 'ERROR', code: '42703', detail: undefined, hint: undefined, position: '47', internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: 'parse_relation.c', routine: 'errorMissingColumn' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mRecord CRUD Operations[2m > [22mshould list records with pagination
[31m[1mAssertionError[22m: expected +0 to be 3 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 3[39m
[31m+ 0[39m

[36m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m273:29[22m[39m
    [90m271| [39m      })[33m;[39m
    [90m272| [39m
    [90m273| [39m      [34mexpect[39m(result[33m.[39mlength)[33m.[39m[34mtoBe[39m([34m3[39m)[33m;[39m
    [90m   | [39m                            [31m^[39m
    [90m274| [39m    })[33m;[39m
    [90m275| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[23/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mRecord CRUD Operations[2m > [22mshould get a single record
[31m[1mError[22m: Record not found[39m
[36m [2m‚ùØ[22m RecordService.verifyRecordOwnership server/services/RecordService.ts:[2m51:13[22m[39m
    [90m 49| [39m
    [90m 50| [39m    [35mif[39m ([33m![39mrecord) {
    [90m 51| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Record not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m 52| [39m    }
    [90m 53| [39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m277:22[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[24/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mRecord CRUD Operations[2m > [22mshould update a record
[31m[1mError[22m: Record not found[39m
[36m [2m‚ùØ[22m RecordService.verifyRecordOwnership server/services/RecordService.ts:[2m51:13[22m[39m
    [90m 49| [39m
    [90m 50| [39m    [35mif[39m ([33m![39mrecord) {
    [90m 51| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Record not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m 52| [39m    }
    [90m 53| [39m
[90m [2m‚ùØ[22m RecordService.updateRecord server/services/RecordService.ts:[2m273:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m284:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[25/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mRecord CRUD Operations[2m > [22mshould find records by filters
[31m[1mAssertionError[22m: expected +0 to be 1 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 1[39m
[31m+ 0[39m

[36m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m303:29[22m[39m
    [90m301| [39m      )[33m;[39m
    [90m302| [39m
    [90m303| [39m      [34mexpect[39m(result[33m.[39mlength)[33m.[39m[34mtoBe[39m([34m1[39m)[33m;[39m
    [90m   | [39m                            [31m^[39m
    [90m304| [39m      [34mexpect[39m((result[[34m0[39m][33m.[39mdata [35mas[39m any)[33m.[39mfirst_name)[33m.[39m[34mtoBe[39m([32m'Jane'[39m)[33m;[39m
    [90m305| [39m    })[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[26/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mRecord CRUD Operations[2m > [22mshould delete a record
[31m[1mError[22m: Record not found[39m
[36m [2m‚ùØ[22m RecordService.verifyRecordOwnership server/services/RecordService.ts:[2m51:13[22m[39m
    [90m 49| [39m
    [90m 50| [39m    [35mif[39m ([33m![39mrecord) {
    [90m 51| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Record not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m 52| [39m    }
    [90m 53| [39m
[90m [2m‚ùØ[22m RecordService.deleteRecord server/services/RecordService.ts:[2m298:5[22m[39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m308:7[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[27/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mCollection Stats[2m > [22mshould list collections with stats
[31m[1mError[22m: Failed query: select "id", "collection_id", "name", "slug", "type", "is_required", "options", "default_value", "order", "created_at", "updated_at" from "collection_fields" where "collection_fields"."collection_id" = $1 order by "collection_fields"."created_at" asc
params: 06601baf-0281-4f25-8b41-ceb2e550a5e4[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m server/services/CollectionService.ts:[2m126:24[22m[39m
    [90m124| [39m    [35mreturn[39m [33mPromise[39m[33m.[39m[34mall[39m(
    [90m125| [39m      collections[33m.[39m[34mmap[39m([35masync[39m (collection) [33m=>[39m {
    [90m126| [39m        const fields = await this.fieldRepo.findByCollectionId(collect‚Ä¶
    [90m   | [39m                       [31m^[39m
    [90m127| [39m        const recordCount = await this.recordRepo.countByCollectionId(‚Ä¶
    [90m128| [39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m321:27[22m[39m

[31m[1mCaused by: error[22m: column "type" does not exist[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m server/services/CollectionService.ts:[2m126:24[22m[39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m321:27[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 104, severity: 'ERROR', code: '42703', detail: undefined, hint: undefined, position: '47', internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: 'parse_relation.c', routine: 'errorMissingColumn' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[28/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mData Validation[2m > [22mshould validate field types
[31m[1mError[22m: Failed query: select "id", "collection_id", "name", "slug", "type", "is_required", "options", "default_value", "order", "created_at", "updated_at" from "collection_fields" where "collection_fields"."collection_id" = $1 order by "collection_fields"."created_at" asc
params: 06601baf-0281-4f25-8b41-ceb2e550a5e4[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m RecordService.applyDefaults server/services/RecordService.ts:[2m193:20[22m[39m
    [90m191| [39m    tx[33m?[39m[33m:[39m [33mDbTransaction[39m
    [90m192| [39m  )[33m:[39m [33mPromise[39m[33m<[39m[33mRecord[39m[33m<[39mstring[33m,[39m any[33m>>[39m {
    [90m193| [39m    const fields = await this.fieldRepo.findByCollectionId(collectionI‚Ä¶
    [90m   | [39m                   [31m^[39m
    [90m194| [39m    [35mconst[39m enrichedData [33m=[39m { [33m...[39mdata }[33m;[39m
    [90m195| [39m
[90m [2m‚ùØ[22m RecordService.createRecord server/services/RecordService.ts:[2m220:26[22m[39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m345:22[22m[39m

[31m[1mCaused by: error[22m: column "type" does not exist[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m RecordService.applyDefaults server/services/RecordService.ts:[2m193:20[22m[39m
[90m [2m‚ùØ[22m RecordService.createRecord server/services/RecordService.ts:[2m220:26[22m[39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m345:22[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 104, severity: 'ERROR', code: '42703', detail: undefined, hint: undefined, position: '47', internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: 'parse_relation.c', routine: 'errorMissingColumn' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[29/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mCleanup[2m > [22mshould delete collection (cascade fields and records)
[31m[1mError[22m: Failed query: select "id", "collection_id", "name", "slug", "type", "is_required", "options", "default_value", "order", "created_at", "updated_at" from "collection_fields" where "collection_fields"."collection_id" = $1 order by "collection_fields"."created_at" asc
params: 06601baf-0281-4f25-8b41-ceb2e550a5e4[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m374:22[22m[39m
    [90m372| [39m
    [90m373| [39m      [90m// Verify fields are also deleted[39m
    [90m374| [39m      const fields = await collectionFieldService.listFields(testColle‚Ä¶
    [90m   | [39m                     [31m^[39m
    [90m375| [39m      [34mexpect[39m(fields[33m.[39mlength)[33m.[39m[34mtoBe[39m([34m0[39m)[33m;[39m
    [90m376| [39m

[31m[1mCaused by: error[22m: column "type" does not exist[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m374:22[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 104, severity: 'ERROR', code: '42703', detail: undefined, hint: undefined, position: '47', internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: 'parse_relation.c', routine: 'errorMissingColumn' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[30/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/dataBlocks.test.ts[2m > [22mData Block Integration Tests[2m > [22mshould write data to DataVault via WriteBlock
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, default, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Write Block Workflow,91c63b35-ec93-4084-8f9f-9fc2ce9be4e5,91c63b35-ec93-4084-8f9f-9fc2ce9be4e5,d39797bc-30d3-4422-9b5a-e0d835acfa89[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/dataBlocks.test.ts:[2m113:28[22m[39m
    [90m111| [39m        projectId [33m=[39m project[33m.[39mid[33m;[39m
    [90m112| [39m
    [90m113| [39m        [35mconst[39m [workflow] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m                           [31m^[39m
    [90m114| [39m            projectId[33m:[39m projectId[33m,[39m
    [90m115| [39m            title[33m:[39m [32m'Write Block Workflow'[39m[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/dataBlocks.test.ts:[2m113:28[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 502, severity: 'ERROR', code: '23502', detail: 'Failing row contains (8eeeb76e-ee6b-4719-913b-a6f9da8c19a8, Write Block Workflow, null, 91c63b35-ec93-4084-8f9f-9fc2ce9be4e5, null, 2026-01-15 21:16:37.464401, 2026-01-15 21:16:37.464401, 91c63b35-ec93-4084-8f9f-9fc2ce9be4e5, d39797bc-30d3-4422-9b5a-e0d835acfa89, null, null, null, null, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[31/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/dataBlocks.test.ts[2m > [22mData Block Integration Tests[2m > [22mshould query data from DataVault via QueryBlock and use in Logic
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, default, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Query Block Workflow,91c63b35-ec93-4084-8f9f-9fc2ce9be4e5,91c63b35-ec93-4084-8f9f-9fc2ce9be4e5,d39797bc-30d3-4422-9b5a-e0d835acfa89[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/dataBlocks.test.ts:[2m194:28[22m[39m
    [90m192| [39m    it('should query data from DataVault via QueryBlock and use in Log‚Ä¶
    [90m193| [39m        [90m// 1. Create Workflow & Query[39m
    [90m194| [39m        [35mconst[39m [workflow] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m                           [31m^[39m
    [90m195| [39m            projectId[33m:[39m projectId[33m,[39m
    [90m196| [39m            title[33m:[39m [32m'Query Block Workflow'[39m[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/dataBlocks.test.ts:[2m194:28[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 502, severity: 'ERROR', code: '23502', detail: 'Failing row contains (091a8cff-330e-4637-b194-f151457c2480, Query Block Workflow, null, 91c63b35-ec93-4084-8f9f-9fc2ce9be4e5, null, 2026-01-15 21:16:37.813372, 2026-01-15 21:16:37.813372, 91c63b35-ec93-4084-8f9f-9fc2ce9be4e5, d39797bc-30d3-4422-9b5a-e0d835acfa89, null, null, null, null, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[32/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault.autonumber.test.ts[2m > [22mDataVault Autonumber Integration Tests[2m > [22mshould generate basic autonumber without prefix
[31m[1mError[22m: Failed query: SELECT datavault_get_next_autonumber(
        $1::UUID,
        $2::UUID,
        $3::UUID,
        'default'::TEXT,
        $4::INTEGER,
        $5::TEXT,
        $6::TEXT
      ) as next_value
params: 15f19932-cda8-4294-a8e2-851fe4a1a2ad,ed2a7249-96a2-45be-a632-c5f614baaf9a,36856cfb-9e10-4b51-8754-76623fd5f3da,4,,[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m DatavaultRowsRepository.getNextAutonumber server/repositories/DatavaultRowsRepository.ts:[2m442:17[22m[39m
    [90m440| [39m    [90m// Call the database function with all parameters[39m
    [90m441| [39m    // SQL Signature: (tenant, table, column, context_key, min_digits,‚Ä¶
    [90m442| [39m    [35mconst[39m res [33m=[39m [35mawait[39m database[33m.[39m[34mexecute[39m(
    [90m   | [39m                [31m^[39m
    [90m443| [39m      sql[32m`SELECT datavault_get_next_autonumber(
    [90m444| [39m        [39m[36m${[39mtenantId[36m}[39m[32m::UUID,
[90m [2m‚ùØ[22m DatavaultRowsService.validateRowData server/services/DatavaultRowsService.ts:[2m221:29[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService._createRowImpl server/services/DatavaultRowsService.ts:[2m305:29[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m101:18[22m[39m

[31m[1mCaused by: error[22m: function datavault_get_next_autonumber(uuid, uuid, uuid, text, integer, text, text) does not exist[39m
[90m [2m‚ùØ[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m DatavaultRowsRepository.getNextAutonumber server/repositories/DatavaultRowsRepository.ts:[2m442:17[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService.validateRowData server/services/DatavaultRowsService.ts:[2m221:29[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService._createRowImpl server/services/DatavaultRowsService.ts:[2m305:29[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m101:18[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 266, severity: 'ERROR', code: '42883', detail: undefined, hint: 'No function matches the given name and argument types. You might need to add explicit type casts.', position: '8', internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: 'parse_func.c', routine: 'ParseFuncOrColumn' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[33/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault.autonumber.test.ts[2m > [22mDataVault Autonumber Integration Tests[2m > [22mshould generate autonumber with prefix
[31m[1mError[22m: Failed query: SELECT datavault_get_next_autonumber(
        $1::UUID,
        $2::UUID,
        $3::UUID,
        'default'::TEXT,
        $4::INTEGER,
        $5::TEXT,
        $6::TEXT
      ) as next_value
params: 15f19932-cda8-4294-a8e2-851fe4a1a2ad,ed2a7249-96a2-45be-a632-c5f614baaf9a,36856cfb-9e10-4b51-8754-76623fd5f3da,4,,[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m DatavaultRowsRepository.getNextAutonumber server/repositories/DatavaultRowsRepository.ts:[2m442:17[22m[39m
    [90m440| [39m    [90m// Call the database function with all parameters[39m
    [90m441| [39m    // SQL Signature: (tenant, table, column, context_key, min_digits,‚Ä¶
    [90m442| [39m    [35mconst[39m res [33m=[39m [35mawait[39m database[33m.[39m[34mexecute[39m(
    [90m   | [39m                [31m^[39m
    [90m443| [39m      sql[32m`SELECT datavault_get_next_autonumber(
    [90m444| [39m        [39m[36m${[39mtenantId[36m}[39m[32m::UUID,
[90m [2m‚ùØ[22m DatavaultRowsService.validateRowData server/services/DatavaultRowsService.ts:[2m221:29[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService._createRowImpl server/services/DatavaultRowsService.ts:[2m305:29[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m126:18[22m[39m

[31m[1mCaused by: error[22m: function datavault_get_next_autonumber(uuid, uuid, uuid, text, integer, text, text) does not exist[39m
[90m [2m‚ùØ[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m DatavaultRowsRepository.getNextAutonumber server/repositories/DatavaultRowsRepository.ts:[2m442:17[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService.validateRowData server/services/DatavaultRowsService.ts:[2m221:29[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService._createRowImpl server/services/DatavaultRowsService.ts:[2m305:29[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m126:18[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 266, severity: 'ERROR', code: '42883', detail: undefined, hint: 'No function matches the given name and argument types. You might need to add explicit type casts.', position: '8', internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: 'parse_func.c', routine: 'ParseFuncOrColumn' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[34/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault.autonumber.test.ts[2m > [22mDataVault Autonumber Integration Tests[2m > [22mshould generate autonumber with yearly reset format
[31m[1mError[22m: Failed query: SELECT datavault_get_next_autonumber(
        $1::UUID,
        $2::UUID,
        $3::UUID,
        'default'::TEXT,
        $4::INTEGER,
        $5::TEXT,
        $6::TEXT
      ) as next_value
params: 15f19932-cda8-4294-a8e2-851fe4a1a2ad,ed2a7249-96a2-45be-a632-c5f614baaf9a,36856cfb-9e10-4b51-8754-76623fd5f3da,4,,[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m DatavaultRowsRepository.getNextAutonumber server/repositories/DatavaultRowsRepository.ts:[2m442:17[22m[39m
    [90m440| [39m    [90m// Call the database function with all parameters[39m
    [90m441| [39m    // SQL Signature: (tenant, table, column, context_key, min_digits,‚Ä¶
    [90m442| [39m    [35mconst[39m res [33m=[39m [35mawait[39m database[33m.[39m[34mexecute[39m(
    [90m   | [39m                [31m^[39m
    [90m443| [39m      sql[32m`SELECT datavault_get_next_autonumber(
    [90m444| [39m        [39m[36m${[39mtenantId[36m}[39m[32m::UUID,
[90m [2m‚ùØ[22m DatavaultRowsService.validateRowData server/services/DatavaultRowsService.ts:[2m221:29[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService._createRowImpl server/services/DatavaultRowsService.ts:[2m305:29[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m150:18[22m[39m

[31m[1mCaused by: error[22m: function datavault_get_next_autonumber(uuid, uuid, uuid, text, integer, text, text) does not exist[39m
[90m [2m‚ùØ[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m DatavaultRowsRepository.getNextAutonumber server/repositories/DatavaultRowsRepository.ts:[2m442:17[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService.validateRowData server/services/DatavaultRowsService.ts:[2m221:29[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService._createRowImpl server/services/DatavaultRowsService.ts:[2m305:29[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m150:18[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 266, severity: 'ERROR', code: '42883', detail: undefined, hint: 'No function matches the given name and argument types. You might need to add explicit type casts.', position: '8', internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: 'parse_func.c', routine: 'ParseFuncOrColumn' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[35/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault.autonumber.test.ts[2m > [22mDataVault Autonumber Integration Tests[2m > [22mshould be atomic and prevent race conditions
[31m[1mError[22m: Failed query: SELECT datavault_get_next_autonumber(
        $1::UUID,
        $2::UUID,
        $3::UUID,
        'default'::TEXT,
        $4::INTEGER,
        $5::TEXT,
        $6::TEXT
      ) as next_value
params: 15f19932-cda8-4294-a8e2-851fe4a1a2ad,ed2a7249-96a2-45be-a632-c5f614baaf9a,36856cfb-9e10-4b51-8754-76623fd5f3da,4,,[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m DatavaultRowsRepository.getNextAutonumber server/repositories/DatavaultRowsRepository.ts:[2m442:17[22m[39m
    [90m440| [39m    [90m// Call the database function with all parameters[39m
    [90m441| [39m    // SQL Signature: (tenant, table, column, context_key, min_digits,‚Ä¶
    [90m442| [39m    [35mconst[39m res [33m=[39m [35mawait[39m database[33m.[39m[34mexecute[39m(
    [90m   | [39m                [31m^[39m
    [90m443| [39m      sql[32m`SELECT datavault_get_next_autonumber(
    [90m444| [39m        [39m[36m${[39mtenantId[36m}[39m[32m::UUID,
[90m [2m‚ùØ[22m DatavaultRowsService.validateRowData server/services/DatavaultRowsService.ts:[2m221:29[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService._createRowImpl server/services/DatavaultRowsService.ts:[2m305:29[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m177:18[22m[39m

[31m[1mCaused by: error[22m: function datavault_get_next_autonumber(uuid, uuid, uuid, text, integer, text, text) does not exist[39m
[90m [2m‚ùØ[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m DatavaultRowsRepository.getNextAutonumber server/repositories/DatavaultRowsRepository.ts:[2m442:17[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService.validateRowData server/services/DatavaultRowsService.ts:[2m221:29[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService._createRowImpl server/services/DatavaultRowsService.ts:[2m305:29[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m177:18[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 266, severity: 'ERROR', code: '42883', detail: undefined, hint: 'No function matches the given name and argument types. You might need to add explicit type casts.', position: '8', internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: 'parse_func.c', routine: 'ParseFuncOrColumn' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[36/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault.autonumber.test.ts[2m > [22mDataVault Autonumber Integration Tests[2m > [22mshould prevent manual updates to autonumber values
[31m[1mError[22m: Failed query: SELECT datavault_get_next_autonumber(
        $1::UUID,
        $2::UUID,
        $3::UUID,
        'default'::TEXT,
        $4::INTEGER,
        $5::TEXT,
        $6::TEXT
      ) as next_value
params: 15f19932-cda8-4294-a8e2-851fe4a1a2ad,ed2a7249-96a2-45be-a632-c5f614baaf9a,36856cfb-9e10-4b51-8754-76623fd5f3da,4,,[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m DatavaultRowsRepository.getNextAutonumber server/repositories/DatavaultRowsRepository.ts:[2m442:17[22m[39m
    [90m440| [39m    [90m// Call the database function with all parameters[39m
    [90m441| [39m    // SQL Signature: (tenant, table, column, context_key, min_digits,‚Ä¶
    [90m442| [39m    [35mconst[39m res [33m=[39m [35mawait[39m database[33m.[39m[34mexecute[39m(
    [90m   | [39m                [31m^[39m
    [90m443| [39m      sql[32m`SELECT datavault_get_next_autonumber(
    [90m444| [39m        [39m[36m${[39mtenantId[36m}[39m[32m::UUID,
[90m [2m‚ùØ[22m DatavaultRowsService.validateRowData server/services/DatavaultRowsService.ts:[2m221:29[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService._createRowImpl server/services/DatavaultRowsService.ts:[2m305:29[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m189:17[22m[39m

[31m[1mCaused by: error[22m: function datavault_get_next_autonumber(uuid, uuid, uuid, text, integer, text, text) does not exist[39m
[90m [2m‚ùØ[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m DatavaultRowsRepository.getNextAutonumber server/repositories/DatavaultRowsRepository.ts:[2m442:17[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService.validateRowData server/services/DatavaultRowsService.ts:[2m221:29[22m[39m
[90m [2m‚ùØ[22m DatavaultRowsService._createRowImpl server/services/DatavaultRowsService.ts:[2m305:29[22m[39m
[90m [2m‚ùØ[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m189:17[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 266, severity: 'ERROR', code: '42883', detail: undefined, hint: 'No function matches the given name and argument types. You might need to add explicit type casts.', position: '8', internalPosition: undefined, internalQuery: undefined, where: undefined, schema: undefined, table: undefined, dataType: undefined, constraint: undefined, file: 'parse_func.c', routine: 'ParseFuncOrColumn' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[37/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/externalSends.test.ts[2m > [22mExternal Send Block Integration[2m > [22mPREVIEW MODE: Should simulate send and NOT call fetch
[41m[1m FAIL [22m[49m tests/integration/externalSends.test.ts[2m > [22mExternal Send Block Integration[2m > [22mLIVE MODE: Should call fetch with mapped payload
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, default, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Send Workflow,a0048099-bc63-420d-b15a-f94823fa083f,a0048099-bc63-420d-b15a-f94823fa083f,eb2a2f5c-1241-4094-a4ac-a876627e962d[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/externalSends.test.ts:[2m90:28[22m[39m
    [90m 88| [39m
    [90m 89| [39m        [90m// 4. Setup Workflow & Version & Section[39m
    [90m 90| [39m        [35mconst[39m [workflow] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m                           [31m^[39m
    [90m 91| [39m            projectId[33m,[39m
    [90m 92| [39m            title[33m:[39m [32m'Send Workflow'[39m[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/integration/externalSends.test.ts:[2m90:28[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 495, severity: 'ERROR', code: '23502', detail: 'Failing row contains (7f53ce09-0537-4e71-ab5f-dcce8708ea6c, Send Workflow, null, a0048099-bc63-420d-b15a-f94823fa083f, null, 2026-01-15 21:16:39.357231, 2026-01-15 21:16:39.357231, a0048099-bc63-420d-b15a-f94823fa083f, eb2a2f5c-1241-4094-a4ac-a876627e962d, null, null, null, null, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[38/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould complete full MFA setup flow
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'mfaEnabled')[39m
[36m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m68:40[22m[39m
    [90m 66| [39m
    [90m 67| [39m      [35mconst[39m token [33m=[39m (loginResponse[33m.[39mbody)[33m.[39mtoken[33m;[39m
    [90m 68| [39m      [34mexpect[39m((loginResponse[33m.[39mbody)[33m.[39muser[33m.[39mmfaEnabled)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
    [90m   | [39m                                       [31m^[39m
    [90m 69| [39m
    [90m 70| [39m      [90m// Step 2: Setup MFA[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[39/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould reject invalid TOTP code during setup
[31m[1mAssertionError[22m: expected 401 to be 400 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 400[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m145:37[22m[39m
    [90m143| [39m        [33m.[39m[34msend[39m({ token[33m:[39m [32m"000000"[39m })[33m;[39m [90m// Invalid code[39m
    [90m144| [39m
    [90m145| [39m      [34mexpect[39m(verifyResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m400[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m146| [39m      [34mexpect[39m(verifyResponse[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoContain[39m([32m"Invalid"[39m)[33m;[39m
    [90m147| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[40/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould generate unique backup codes
[31m[1mAssertionError[22m: expected +0 to be 10 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 10[39m
[31m+ 0[39m

[36m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m186:32[22m[39m
    [90m184| [39m      [90m// All codes should be unique[39m
    [90m185| [39m      [35mconst[39m uniqueCodes [33m=[39m [35mnew[39m [33mSet[39m(backupCodes)[33m;[39m
    [90m186| [39m      [34mexpect[39m(uniqueCodes[33m.[39msize)[33m.[39m[34mtoBe[39m([34m10[39m)[33m;[39m
    [90m   | [39m                               [31m^[39m
    [90m187| [39m    })[33m;[39m
    [90m188| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[41/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould store hashed backup codes
[31m[1mAssertionError[22m: expected [] to have a length of 10 but got +0[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 10[39m
[31m+ 0[39m

[36m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m208:27[22m[39m
    [90m206| [39m      })[33m;[39m
    [90m207| [39m
    [90m208| [39m      [34mexpect[39m(storedCodes)[33m.[39m[34mtoHaveLength[39m([34m10[39m)[33m;[39m
    [90m   | [39m                          [31m^[39m
    [90m209| [39m
    [90m210| [39m      [90m// Hashes should not match plain codes[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[42/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Flow[2m > [22mshould login with valid backup code
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'secret')[39m
[36m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m341:52[22m[39m
    [90m339| [39m      })[33m;[39m
    [90m340| [39m
    [90m341| [39m      [35mconst[39m totpCode [33m=[39m [34mgenerateTotpCode[39m(mfaSecret[33m![39m[33m.[39msecret)[33m;[39m
    [90m   | [39m                                                   [31m^[39m
    [90m342| [39m
    [90m343| [39m      [35mawait[39m [34mrequest[39m(app)

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[43/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Flow[2m > [22mshould prevent backup code reuse
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'secret')[39m
[36m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m413:52[22m[39m
    [90m411| [39m      })[33m;[39m
    [90m412| [39m
    [90m413| [39m      [35mconst[39m totpCode [33m=[39m [34mgenerateTotpCode[39m(mfaSecret[33m![39m[33m.[39msecret)[33m;[39m
    [90m   | [39m                                                   [31m^[39m
    [90m414| [39m
    [90m415| [39m      [35mawait[39m [34mrequest[39m(app)

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[44/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Status[2m > [22mshould return MFA status for user
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m486:37[22m[39m
    [90m484| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mloginResponse[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m485| [39m
    [90m486| [39m      [34mexpect[39m(statusResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m487| [39m      [34mexpect[39m(statusResponse[33m.[39mbody[33m.[39mmfaEnabled)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
    [90m488| [39m      [34mexpect[39m(statusResponse[33m.[39mbody[33m.[39mbackupCodesRemaining)[33m.[39m[34mtoBe[39m([34m0[39m)[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[45/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Disable Flow[2m > [22mshould disable MFA with password verification
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m552:38[22m[39m
    [90m550| [39m        [33m.[39m[34msend[39m({ password })[33m;[39m
    [90m551| [39m
    [90m552| [39m      [34mexpect[39m(disableResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                     [31m^[39m
    [90m553| [39m
    [90m554| [39m      [90m// Verify MFA is disabled[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[46/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Regeneration[2m > [22mshould return error if MFA not enabled
[31m[1mAssertionError[22m: expected 401 to be 400 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 400[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m657:31[22m[39m
    [90m655| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mloginResponse[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m656| [39m
    [90m657| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m400[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m658| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoContain[39m([32m"not enabled"[39m)[33m;[39m
    [90m659| [39m    })[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[47/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/regression-REG-1.test.ts[2m > [22mREG-1: Workflow Logic Regression[2m > [22m1. Required + Show/Hide (Questions)[2m > [22mshould block Next when required visible question is empty
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: da4ba344-9c92-49ed-b82e-6fd32814495a,Required Question Test,a4517192-125d-4388-ae9e-6ac5dbdcdec5,a4517192-125d-4388-ae9e-6ac5dbdcdec5,b6e0dc4b-c023-4d0d-a024-a0467bf003a3,70b97e14-89a7-48f3-8042-1fed1659cf77[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m100:13[22m[39m
    [90m 98| [39m            workflowVersionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 99| [39m
    [90m100| [39m            [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m            [31m^[39m
    [90m101| [39m                id[33m:[39m workflowId[33m,[39m
    [90m102| [39m                projectId[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m100:13[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 536, severity: 'ERROR', code: '23502', detail: 'Failing row contains (da4ba344-9c92-49ed-b82e-6fd32814495a, Required Question Test, null, a4517192-125d-4388-ae9e-6ac5dbdcdec5, null, 2026-01-15 21:16:41.030944, 2026-01-15 21:16:41.030944, a4517192-125d-4388-ae9e-6ac5dbdcdec5, b6e0dc4b-c023-4d0d-a024-a0467bf003a3, null, null, null, 70b97e14-89a7-48f3-8042-1fed1659cf77, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[48/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/regression-REG-1.test.ts[2m > [22mREG-1: Workflow Logic Regression[2m > [22m1. Required + Show/Hide (Questions)[2m > [22mshould NOT block Next when required question is hidden
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: 6ecdbbe3-744a-4729-99b6-40a7821b5aa2,Required Question Test,a4517192-125d-4388-ae9e-6ac5dbdcdec5,a4517192-125d-4388-ae9e-6ac5dbdcdec5,b6e0dc4b-c023-4d0d-a024-a0467bf003a3,2884e802-2937-41ad-9e49-4ddd82f4ba3b[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m100:13[22m[39m
    [90m 98| [39m            workflowVersionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 99| [39m
    [90m100| [39m            [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m            [31m^[39m
    [90m101| [39m                id[33m:[39m workflowId[33m,[39m
    [90m102| [39m                projectId[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m100:13[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 536, severity: 'ERROR', code: '23502', detail: 'Failing row contains (6ecdbbe3-744a-4729-99b6-40a7821b5aa2, Required Question Test, null, a4517192-125d-4388-ae9e-6ac5dbdcdec5, null, 2026-01-15 21:16:41.384238, 2026-01-15 21:16:41.384238, a4517192-125d-4388-ae9e-6ac5dbdcdec5, b6e0dc4b-c023-4d0d-a024-a0467bf003a3, null, null, null, 2884e802-2937-41ad-9e49-4ddd82f4ba3b, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[49/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/regression-REG-1.test.ts[2m > [22mREG-1: Workflow Logic Regression[2m > [22m1. Required + Show/Hide (Questions)[2m > [22mshould block when required becomes visible and is empty
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: 0dd9e7c2-ee2f-4449-8795-393c10d76f36,Required Question Test,a4517192-125d-4388-ae9e-6ac5dbdcdec5,a4517192-125d-4388-ae9e-6ac5dbdcdec5,b6e0dc4b-c023-4d0d-a024-a0467bf003a3,9aca8f72-c64a-4189-870e-79f2dcab0da7[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m100:13[22m[39m
    [90m 98| [39m            workflowVersionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 99| [39m
    [90m100| [39m            [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m            [31m^[39m
    [90m101| [39m                id[33m:[39m workflowId[33m,[39m
    [90m102| [39m                projectId[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m100:13[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 536, severity: 'ERROR', code: '23502', detail: 'Failing row contains (0dd9e7c2-ee2f-4449-8795-393c10d76f36, Required Question Test, null, a4517192-125d-4388-ae9e-6ac5dbdcdec5, null, 2026-01-15 21:16:41.726529, 2026-01-15 21:16:41.726529, a4517192-125d-4388-ae9e-6ac5dbdcdec5, b6e0dc4b-c023-4d0d-a024-a0467bf003a3, null, null, null, 9aca8f72-c64a-4189-870e-79f2dcab0da7, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[50/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/regression-REG-1.test.ts[2m > [22mREG-1: Workflow Logic Regression[2m > [22m2. Required + Show/Hide (Pages)[2m > [22mshould skip hidden required page entirely
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: b4230d8d-1a89-491c-84c3-4fbbb9ccbd5c,Page Visibility Test,a4517192-125d-4388-ae9e-6ac5dbdcdec5,a4517192-125d-4388-ae9e-6ac5dbdcdec5,b6e0dc4b-c023-4d0d-a024-a0467bf003a3,a97daa84-75e0-4a61-a692-ba674ed980f8[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m272:13[22m[39m
    [90m270| [39m            workflowVersionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m271| [39m
    [90m272| [39m            [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m            [31m^[39m
    [90m273| [39m                id[33m:[39m workflowId[33m,[39m
    [90m274| [39m                projectId[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m272:13[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 532, severity: 'ERROR', code: '23502', detail: 'Failing row contains (b4230d8d-1a89-491c-84c3-4fbbb9ccbd5c, Page Visibility Test, null, a4517192-125d-4388-ae9e-6ac5dbdcdec5, null, 2026-01-15 21:16:42.06009, 2026-01-15 21:16:42.06009, a4517192-125d-4388-ae9e-6ac5dbdcdec5, b6e0dc4b-c023-4d0d-a024-a0467bf003a3, null, null, null, a97daa84-75e0-4a61-a692-ba674ed980f8, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[51/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/regression-REG-1.test.ts[2m > [22mREG-1: Workflow Logic Regression[2m > [22m2. Required + Show/Hide (Pages)[2m > [22mshould enforce required on visible page
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: 21c2f586-1759-46a6-aa8c-dd8cd7c920f1,Page Required Test,a4517192-125d-4388-ae9e-6ac5dbdcdec5,a4517192-125d-4388-ae9e-6ac5dbdcdec5,b6e0dc4b-c023-4d0d-a024-a0467bf003a3,b8e74a81-5464-4bcd-bf0d-8f5dd84cb9cf[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m357:13[22m[39m
    [90m355| [39m            workflowVersionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m356| [39m
    [90m357| [39m            [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m            [31m^[39m
    [90m358| [39m                id[33m:[39m workflowId[33m,[39m
    [90m359| [39m                projectId[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m357:13[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 532, severity: 'ERROR', code: '23502', detail: 'Failing row contains (21c2f586-1759-46a6-aa8c-dd8cd7c920f1, Page Required Test, null, a4517192-125d-4388-ae9e-6ac5dbdcdec5, null, 2026-01-15 21:16:42.410068, 2026-01-15 21:16:42.410068, a4517192-125d-4388-ae9e-6ac5dbdcdec5, b6e0dc4b-c023-4d0d-a024-a0467bf003a3, null, null, null, b8e74a81-5464-4bcd-bf0d-8f5dd84cb9cf, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[52/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould list all active sessions for current user
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m86:31[22m[39m
    [90m 84| [39m        [33m.[39m[35mset[39m([32m"Cookie"[39m[33m,[39m cookie[33m![39m)[33m;[39m
    [90m 85| [39m
    [90m 86| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m 87| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39msessions)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m 88| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39msessions[33m.[39mlength)[33m.[39m[34mtoBe[39m([34m3[39m)[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[53/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould mark current session correctly
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'filter')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m128:40[22m[39m
    [90m126| [39m
    [90m127| [39m      [35mconst[39m sessions [33m=[39m response[33m.[39mbody[33m.[39msessions[33m;[39m
    [90m128| [39m      [35mconst[39m currentSessions [33m=[39m sessions[33m.[39m[34mfilter[39m((s[33m:[39m any) [33m=>[39m s[33m.[39mcurrent)[33m;[39m
    [90m   | [39m                                       [31m^[39m
    [90m129| [39m
    [90m130| [39m      [90m// Only one should be current[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[54/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould exclude revoked sessions
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'length')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m163:37[22m[39m
    [90m161| [39m
    [90m162| [39m      [90m// Should only show 1 session (non-revoked)[39m
    [90m163| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39msessions[33m.[39mlength)[33m.[39m[34mtoBe[39m([34m1[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m164| [39m    })[33m;[39m
    [90m165| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[55/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould order sessions by last used (most recent first)
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'length')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m190:36[22m[39m
    [90m188| [39m
    [90m189| [39m      [90m// Should be ordered by lastUsedAt descending[39m
    [90m190| [39m      [35mfor[39m ([35mlet[39m i [33m=[39m [34m1[39m[33m;[39m i [33m<[39m sessions[33m.[39mlength[33m;[39m i[33m++[39m) {
    [90m   | [39m                                   [31m^[39m
    [90m191| [39m        [35mconst[39m prev [33m=[39m [35mnew[39m [33mDate[39m(sessions[i [33m-[39m [34m1[39m][33m.[39mlastUsedAt)[33m;[39m
    [90m192| [39m        [35mconst[39m curr [33m=[39m [35mnew[39m [33mDate[39m(sessions[i][33m.[39mlastUsedAt)[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[56/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould filter sessions by current user only
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'length')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m222:37[22m[39m
    [90m220| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39muser1Login[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m221| [39m
    [90m222| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39msessions[33m.[39mlength)[33m.[39m[34mtoBe[39m([34m2[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m223| [39m    })[33m;[39m
    [90m224| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[57/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould revoke specific session
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m254:40[22m[39m
    [90m252| [39m
    [90m253| [39m      [35mconst[39m sessions [33m=[39m sessionsResponse[33m.[39mbody[33m.[39msessions[33m;[39m
    [90m254| [39m      [35mconst[39m sessionToRevoke [33m=[39m sessions[33m.[39m[34mfind[39m((s[33m:[39m any) [33m=>[39m [33m![39ms[33m.[39mcurrent)[33m;[39m
    [90m   | [39m                                       [31m^[39m
    [90m255| [39m
    [90m256| [39m      [90m// Revoke non-current session[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[58/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould prevent revoking current session
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m297:61[22m[39m
    [90m295| [39m        [33m.[39m[35mset[39m([32m"Cookie"[39m[33m,[39m cookie[33m![39m)[33m;[39m
    [90m296| [39m
    [90m297| [39m      [35mconst[39m currentSession [33m=[39m sessionsResponse[33m.[39mbody[33m.[39msessions[33m.[39m[34mfind[39m(
    [90m   | [39m                                                            [31m^[39m
    [90m298| [39m        (s[33m:[39m any) [33m=>[39m s[33m.[39mcurrent
    [90m299| [39m      )[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[59/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould return 404 for non-existent session
[31m[1mAssertionError[22m: expected 401 to be 404 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 404[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m323:31[22m[39m
    [90m321| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mlogin[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m322| [39m
    [90m323| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m404[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m324| [39m    })[33m;[39m
    [90m325| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[60/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould prevent revoking other user's session
[31m[1mTypeError[22m: Cannot read properties of undefined (reading '0')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m347:49[22m[39m
    [90m345| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39muser1Login[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m346| [39m
    [90m347| [39m      [35mconst[39m user1SessionId [33m=[39m user1Sessions[33m.[39mbody[33m.[39msessions[[34m0[39m][33m.[39mid[33m;[39m
    [90m   | [39m                                                [31m^[39m
    [90m348| [39m
    [90m349| [39m      [90m// Try to revoke user 1's session as user 2[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[61/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould revoke all other sessions
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m382:31[22m[39m
    [90m380| [39m        [33m.[39m[35mset[39m([32m"Cookie"[39m[33m,[39m cookie[33m![39m)[33m;[39m
    [90m381| [39m
    [90m382| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m383| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoContain[39m([32m"all other devices"[39m)[33m;[39m
    [90m384| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[62/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould keep current session active
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m419:33[22m[39m
    [90m417| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m418| [39m
    [90m419| [39m      [34mexpect[39m(meResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                [31m^[39m
    [90m420| [39m
    [90m421| [39m      [90m// Should be able to refresh with current token[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[63/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould return 400 if no active session found
[31m[1mAssertionError[22m: expected 401 to be 400 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 400[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m444:31[22m[39m
    [90m442| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m443| [39m
    [90m444| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m400[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m445| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoContain[39m([32m"No active session"[39m)[33m;[39m
    [90m446| [39m    })[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[64/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould handle user with single session gracefully
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m498:31[22m[39m
    [90m496| [39m        [33m.[39m[35mset[39m([32m"Cookie"[39m[33m,[39m cookie[33m![39m)[33m;[39m
    [90m497| [39m
    [90m498| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m499| [39m
    [90m500| [39m      [90m// Current session should still exist[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[65/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mSession Security[2m > [22mshould include device metadata in sessions
[31m[1mTypeError[22m: Cannot read properties of undefined (reading '0')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m526:37[22m[39m
    [90m524| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m525| [39m
    [90m526| [39m      [35mconst[39m session [33m=[39m response[33m.[39mbody[33m.[39msessions[[34m0[39m][33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m527| [39m
    [90m528| [39m      [34mexpect[39m(session[33m.[39mdeviceName)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[66/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mSession Security[2m > [22mshould not expose sensitive token data
[31m[1mTypeError[22m: Cannot read properties of undefined (reading '0')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m544:37[22m[39m
    [90m542| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mlogin[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m543| [39m
    [90m544| [39m      [35mconst[39m session [33m=[39m response[33m.[39mbody[33m.[39msessions[[34m0[39m][33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m545| [39m
    [90m546| [39m      [90m// Should NOT include token hash or metadata[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[67/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mSession Security[2m > [22mshould track session activity timestamps
[31m[1mTypeError[22m: Cannot read properties of undefined (reading '0')[39m
[36m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m563:37[22m[39m
    [90m561| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mlogin[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m562| [39m
    [90m563| [39m      [35mconst[39m session [33m=[39m response[33m.[39mbody[33m.[39msessions[[34m0[39m][33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m564| [39m
    [90m565| [39m      [34mexpect[39m(session[33m.[39mcreatedAt)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[68/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDevice Trust with MFA Login[2m > [22mshould skip MFA for trusted device
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m491:42[22m[39m
    [90m489| [39m
    [90m490| [39m      [90m// Should not require MFA[39m
    [90m491| [39m      [34mexpect[39m(secondLoginResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                         [31m^[39m
    [90m492| [39m      [34mexpect[39m(secondLoginResponse[33m.[39mbody[33m.[39mrequiresMfa)[33m.[39m[34mtoBeUndefined[39m()[33m;[39m
    [90m493| [39m      [34mexpect[39m(secondLoginResponse[33m.[39mbody[33m.[39mtoken)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[69/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mREPRO: ScriptEngine fails to resolve alias 'input_variable' when aliasMap is NOT provided
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: e6f8e23a-355a-47de-902a-2176f394ca3d,Safety Workflow,f4774fd1-49de-427a-86a3-9b0987380fbf,f4774fd1-49de-427a-86a3-9b0987380fbf,f94c958c-de66-4e38-ae73-faa98b3b0d0f,8c474830-6856-4a1b-89bb-ee11a0bdc659[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m
    [90m 73| [39m        workflowId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 74| [39m        versionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 75| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(workflowsSchema)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 76| [39m            id[33m:[39m workflowId[33m,[39m
    [90m 77| [39m            projectId[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 529, severity: 'ERROR', code: '23502', detail: 'Failing row contains (e6f8e23a-355a-47de-902a-2176f394ca3d, Safety Workflow, null, f4774fd1-49de-427a-86a3-9b0987380fbf, null, 2026-01-15 21:16:34.480882, 2026-01-15 21:16:34.480882, f4774fd1-49de-427a-86a3-9b0987380fbf, f94c958c-de66-4e38-ae73-faa98b3b0d0f, null, null, null, 8c474830-6856-4a1b-89bb-ee11a0bdc659, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[70/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mScriptEngine resolves alias 'input_variable' when aliasMap is provided
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: 3e70dff8-49b3-4cd3-9146-ac00499f06d4,Safety Workflow,40a39386-ba82-4a85-a6c6-956d4080b893,40a39386-ba82-4a85-a6c6-956d4080b893,253ae3b8-0cb9-4c4f-9d11-bababf55e4a5,6a5bebd1-1dc9-45dd-a8be-0bd7b9afe44e[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m
    [90m 73| [39m        workflowId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 74| [39m        versionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 75| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(workflowsSchema)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 76| [39m            id[33m:[39m workflowId[33m,[39m
    [90m 77| [39m            projectId[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 529, severity: 'ERROR', code: '23502', detail: 'Failing row contains (3e70dff8-49b3-4cd3-9146-ac00499f06d4, Safety Workflow, null, 40a39386-ba82-4a85-a6c6-956d4080b893, null, 2026-01-15 21:16:34.967164, 2026-01-15 21:16:34.967164, 40a39386-ba82-4a85-a6c6-956d4080b893, 253ae3b8-0cb9-4c4f-9d11-bababf55e4a5, null, null, null, 6a5bebd1-1dc9-45dd-a8be-0bd7b9afe44e, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[71/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mREPRO: BlockRunner fails to resolve alias in CreateRecordConfig
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: 8a16258b-4c6a-420c-b7b7-016f5a0acdec,Safety Workflow,1877337c-38a6-4de6-8fd5-070eba09fa86,1877337c-38a6-4de6-8fd5-070eba09fa86,9531fab2-2368-4c66-b82a-90bd285056d6,bde0c21b-bb2f-4f88-bd67-968018d8ac43[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m
    [90m 73| [39m        workflowId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 74| [39m        versionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 75| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(workflowsSchema)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 76| [39m            id[33m:[39m workflowId[33m,[39m
    [90m 77| [39m            projectId[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 529, severity: 'ERROR', code: '23502', detail: 'Failing row contains (8a16258b-4c6a-420c-b7b7-016f5a0acdec, Safety Workflow, null, 1877337c-38a6-4de6-8fd5-070eba09fa86, null, 2026-01-15 21:16:35.460101, 2026-01-15 21:16:35.460101, 1877337c-38a6-4de6-8fd5-070eba09fa86, 9531fab2-2368-4c66-b82a-90bd285056d6, null, null, null, bde0c21b-bb2f-4f88-bd67-968018d8ac43, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[72/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mBlockRunner logic resolves alias with aliasMap
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: e6f132ae-d5de-431e-83f1-2d6fa3b5bf89,Safety Workflow,85febe6f-97e2-4777-b4f2-3f9b8a64cf9a,85febe6f-97e2-4777-b4f2-3f9b8a64cf9a,a9d83254-4cbd-4165-818e-bdc413a57f0b,c813587d-1be7-45ec-9b86-642240658a26[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m
    [90m 73| [39m        workflowId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 74| [39m        versionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 75| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(workflowsSchema)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 76| [39m            id[33m:[39m workflowId[33m,[39m
    [90m 77| [39m            projectId[33m,[39m

[31m[1mCaused by: error[22m: null value in column "status" of relation "workflows" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 529, severity: 'ERROR', code: '23502', detail: 'Failing row contains (e6f132ae-d5de-431e-83f1-2d6fa3b5bf89, Safety Workflow, null, 85febe6f-97e2-4777-b4f2-3f9b8a64cf9a, null, 2026-01-15 21:16:35.959606, 2026-01-15 21:16:35.959606, 85febe6f-97e2-4777-b4f2-3f9b8a64cf9a, a9d83254-4cbd-4165-818e-bdc413a57f0b, null, null, null, c813587d-1be7-45ec-9b86-642240658a26, f, null, f, null, {}, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'workflows', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[73/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould create draft version on successful AI edit
[31m[1mError[22m: expected 200 "OK", got 500 "Internal Server Error"[39m
[36m [2m‚ùØ[22m tests/integration/ai/workflowEdit.test.ts:[2m183:8[22m[39m
    [90m181| [39m      })
    [90m182| [39m
    [90m183| [39m      [33m.[39m[34mexpect[39m([34m200[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m184| [39m
    [90m185| [39m    [34mexpect[39m(response[33m.[39mbody[33m.[39msuccess)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
[90m [2m‚ùØ[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2m‚ùØ[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2m‚ùØ[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2m‚ùØ[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2m‚ùØ[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2m‚ùØ[22m Server.<anonymous> node_modules/supertest/lib/test.js:[2m152:11[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[74/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould enforce draft mode (revert active workflow to draft)
[31m[1mError[22m: expected 200 "OK", got 500 "Internal Server Error"[39m
[36m [2m‚ùØ[22m tests/integration/ai/workflowEdit.test.ts:[2m223:8[22m[39m
    [90m221| [39m        userMessage[33m:[39m [32m'Add a phone number field'[39m[33m,[39m
    [90m222| [39m      })
    [90m223| [39m      [33m.[39m[34mexpect[39m([34m200[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m224| [39m
    [90m225| [39m    [90m// Verify workflow is now draft[39m
[90m [2m‚ùØ[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2m‚ùØ[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2m‚ùØ[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2m‚ùØ[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2m‚ùØ[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2m‚ùØ[22m Server.<anonymous> node_modules/supertest/lib/test.js:[2m152:11[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[75/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould not create version when no changes detected (checksum match)
[31m[1mError[22m: expected 200 "OK", got 500 "Internal Server Error"[39m
[36m [2m‚ùØ[22m tests/integration/ai/workflowEdit.test.ts:[2m240:8[22m[39m
    [90m238| [39m        userMessage[33m:[39m [32m'Add contact section'[39m[33m,[39m
    [90m239| [39m      })
    [90m240| [39m      [33m.[39m[34mexpect[39m([34m200[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m241| [39m
    [90m242| [39m    [35mconst[39m versionId1 [33m=[39m response1[33m.[39mbody[33m.[39mdata[33m.[39mversionId[33m;[39m
[90m [2m‚ùØ[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2m‚ùØ[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2m‚ùØ[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2m‚ùØ[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2m‚ùØ[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2m‚ùØ[22m Server.<anonymous> node_modules/supertest/lib/test.js:[2m152:11[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[76/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould reject unsafe DataVault operations
[31m[1mError[22m: expected 400 "Bad Request", got 500 "Internal Server Error"[39m
[36m [2m‚ùØ[22m tests/integration/ai/workflowEdit.test.ts:[2m323:8[22m[39m
    [90m321| [39m        userMessage[33m:[39m [32m'Delete all data'[39m[33m,[39m
    [90m322| [39m      })
    [90m323| [39m      [33m.[39m[34mexpect[39m([34m400[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m324| [39m
    [90m325| [39m    [34mexpect[39m(response[33m.[39mbody[33m.[39msuccess)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
[90m [2m‚ùØ[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2m‚ùØ[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2m‚ùØ[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2m‚ùØ[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2m‚ùØ[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2m‚ùØ[22m Server.<anonymous> node_modules/supertest/lib/test.js:[2m152:11[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[77/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould handle multi-operation edits with tempId resolution
[31m[1mError[22m: expected 200 "OK", got 500 "Internal Server Error"[39m
[36m [2m‚ùØ[22m tests/integration/ai/workflowEdit.test.ts:[2m394:8[22m[39m
    [90m392| [39m        userMessage: 'Add emergency contact section with name and phon‚Ä¶
    [90m393| [39m      })
    [90m394| [39m      [33m.[39m[34mexpect[39m([34m200[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m395| [39m
    [90m396| [39m    [34mexpect[39m(response[33m.[39mbody[33m.[39msuccess)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
[90m [2m‚ùØ[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2m‚ùØ[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2m‚ùØ[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2m‚ùØ[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2m‚ùØ[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2m‚ùØ[22m Server.<anonymous> node_modules/supertest/lib/test.js:[2m152:11[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[78/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould create BEFORE and AFTER snapshots
[31m[1mError[22m: expected 200 "OK", got 500 "Internal Server Error"[39m
[36m [2m‚ùØ[22m tests/integration/ai/workflowEdit.test.ts:[2m431:8[22m[39m
    [90m429| [39m        userMessage[33m:[39m [32m'Add a simple field'[39m[33m,[39m
    [90m430| [39m      })
    [90m431| [39m      [33m.[39m[34mexpect[39m([34m200[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m432| [39m
    [90m433| [39m    [35mconst[39m versionId [33m=[39m response[33m.[39mbody[33m.[39mdata[33m.[39mversionId[33m;[39m
[90m [2m‚ùØ[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2m‚ùØ[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2m‚ùØ[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2m‚ùØ[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2m‚ùØ[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2m‚ùØ[22m Server.<anonymous> node_modules/supertest/lib/test.js:[2m152:11[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[79/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould rollback on validation failure
[31m[1mError[22m: expected 400 "Bad Request", got 500 "Internal Server Error"[39m
[36m [2m‚ùØ[22m tests/integration/ai/workflowEdit.test.ts:[2m500:8[22m[39m
    [90m498| [39m        userMessage[33m:[39m [32m'Add backup email field'[39m[33m,[39m
    [90m499| [39m      })
    [90m500| [39m      [33m.[39m[34mexpect[39m([34m400[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m501| [39m
    [90m502| [39m    [34mexpect[39m(response[33m.[39mbody[33m.[39msuccess)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
[90m [2m‚ùØ[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2m‚ùØ[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2m‚ùØ[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2m‚ùØ[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2m‚ùØ[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2m‚ùØ[22m Server.<anonymous> node_modules/supertest/lib/test.js:[2m152:11[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[80/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Authorization Flow Initiation[2m > [22mshould initiate OAuth2 3-legged flow and generate authorization URL
[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Authorization Flow Initiation[2m > [22mshould include optional scope in authorization URL
[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 State Validation[2m > [22mshould validate valid OAuth2 state token
[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 State Validation[2m > [22mshould reject invalid OAuth2 state token
[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 State Validation[2m > [22mshould reject expired OAuth2 state token
[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 State Validation[2m > [22mshould clean up OAuth2 state after use
[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Callback Error Handling[2m > [22mshould handle callback with missing state parameter
[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Callback Error Handling[2m > [22mshould handle callback with missing code parameter
[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Callback Error Handling[2m > [22mshould handle OAuth2 provider error responses
[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Connection Status[2m > [22mshould track OAuth2 connection status
[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Connection Status[2m > [22mshould store OAuth2 state in connection metadata
[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Security[2m > [22mshould use cryptographically secure random state
[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Security[2m > [22mshould prevent state reuse after validation
[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Security[2m > [22mshould include PKCE support metadata in state record
[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Redirect URI Validation[2m > [22mshould validate redirect URI matches allowed URIs
[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Redirect URI Validation[2m > [22mshould encode redirect URI in authorization URL
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'projectId')[39m
[36m [2m‚ùØ[22m tests/integration/auth/oauth2.callback.test.ts:[2m93:55[22m[39m
    [90m 91| [39m  [34mbeforeEach[39m([35masync[39m () [33m=>[39m {
    [90m 92| [39m    [90m// Clean up connections before each test[39m
    [90m 93| [39m    await db.delete(connections).where(eq(connections.projectId, testP‚Ä¶
    [90m   | [39m                                                      [31m^[39m
    [90m 94| [39m    await db.delete(secrets).where(eq(secrets.projectId, testProjectId‚Ä¶
    [90m 95| [39m  })[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[81/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould successfully authenticate with valid Google ID token
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2m‚ùØ[22m tests/integration/auth/oauth2.google.test.ts:[2m91:31[22m[39m
    [90m 89| [39m
    [90m 90| [39m      [90m// Verify response[39m
    [90m 91| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m 92| [39m      [34mexpect[39m(response[33m.[39mbody)[33m.[39m[34mtoMatchObject[39m({
    [90m 93| [39m        message[33m:[39m [32m'Authentication successful'[39m[33m,[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[82/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/all - Logout All Other Devices[2m > [22mshould revoke all sessions except current
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m326:31[22m[39m
    [90m324| [39m        [33m.[39m[35mset[39m([32m'Cookie'[39m[33m,[39m [32m`refresh_token=[39m[36m${[39mcurrentToken[36m}[39m[32m`[39m)[33m;[39m
    [90m325| [39m
    [90m326| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m327| [39m      expect(response.body.message).toBe('Logged out from all other de‚Ä¶
    [90m328| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[83/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/all - Logout All Other Devices[2m > [22mshould revoke all trusted devices
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m368:31[22m[39m
    [90m366| [39m        [33m.[39m[35mset[39m([32m'Cookie'[39m[33m,[39m [32m`refresh_token=[39m[36m${[39mcurrentToken[36m}[39m[32m`[39m)[33m;[39m
    [90m367| [39m
    [90m368| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m369| [39m
    [90m370| [39m      [90m// Verify all trusted devices are revoked[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[84/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Lifecycle[2m > [22mshould create refresh token on login
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m322:31[22m[39m
    [90m320| [39m        })[33m;[39m
    [90m321| [39m
    [90m322| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m323| [39m
    [90m324| [39m      [90m// Verify refresh token cookie is set[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[85/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22menqueue[2m > [22mshould enqueue a PDF conversion job
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, default, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,10af5af6-2283-4b2d-896d-c27f3142a181,1eccf41e-e1f5-4f25-b6a9-581d84098899,10af5af6-2283-4b2d-896d-c27f3142a181[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: null value in column "created_by" of relation "projects" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 481, severity: 'ERROR', code: '23502', detail: 'Failing row contains (7ab52db2-48ec-498f-b73f-c87922d890c2, Test Project, Test project, 10af5af6-2283-4b2d-896d-c27f3142a181, active, 2026-01-15 21:16:33.611417, 2026-01-15 21:16:33.611417, 10af5af6-2283-4b2d-896d-c27f3142a181, 1eccf41e-e1f5-4f25-b6a9-581d84098899, Test Project, f, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'projects', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[86/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22menqueue[2m > [22mshould create output with empty storagePath initially
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, default, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,18f97950-d4e2-4937-8894-1813e6dfde79,f429fd2c-ec65-4fae-91ec-5340e8c03a45,18f97950-d4e2-4937-8894-1813e6dfde79[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: null value in column "created_by" of relation "projects" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 481, severity: 'ERROR', code: '23502', detail: 'Failing row contains (c8100f0b-2d2b-4451-8337-1506c3d7cff4, Test Project, Test project, 18f97950-d4e2-4937-8894-1813e6dfde79, active, 2026-01-15 21:16:34.304589, 2026-01-15 21:16:34.304589, 18f97950-d4e2-4937-8894-1813e6dfde79, f429fd2c-ec65-4fae-91ec-5340e8c03a45, Test Project, f, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'projects', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[87/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mgetJobStatus[2m > [22mshould return job status for pending job
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, default, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,ef71a42a-7c54-4ff2-9891-488e9838778e,359d46c1-8dbd-4bea-aca9-a47f2c62b465,ef71a42a-7c54-4ff2-9891-488e9838778e[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: null value in column "created_by" of relation "projects" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 481, severity: 'ERROR', code: '23502', detail: 'Failing row contains (a3006cfd-82ec-4e79-80b9-4518ff10d5a7, Test Project, Test project, ef71a42a-7c54-4ff2-9891-488e9838778e, active, 2026-01-15 21:16:34.987301, 2026-01-15 21:16:34.987301, ef71a42a-7c54-4ff2-9891-488e9838778e, 359d46c1-8dbd-4bea-aca9-a47f2c62b465, Test Project, f, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'projects', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[88/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mgetJobStatus[2m > [22mshould return null for non-existent job
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, default, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,da94f7bd-0eb6-48e1-b70f-0ed6a259353d,90f91588-7f19-457d-bb5e-f9b1c6e7596b,da94f7bd-0eb6-48e1-b70f-0ed6a259353d[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: null value in column "created_by" of relation "projects" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 481, severity: 'ERROR', code: '23502', detail: 'Failing row contains (983043cd-065a-403c-af43-7a94081ac50a, Test Project, Test project, da94f7bd-0eb6-48e1-b70f-0ed6a259353d, active, 2026-01-15 21:16:35.687452, 2026-01-15 21:16:35.687452, da94f7bd-0eb6-48e1-b70f-0ed6a259353d, 90f91588-7f19-457d-bb5e-f9b1c6e7596b, Test Project, f, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'projects', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[89/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mgetJobStatus[2m > [22mshould parse attempt count from error field
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, default, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,3ba054af-ec4b-4fc5-9281-f90d7e9dc041,26dc051e-223b-4c7e-8227-294dbbb0a45c,3ba054af-ec4b-4fc5-9281-f90d7e9dc041[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: null value in column "created_by" of relation "projects" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 481, severity: 'ERROR', code: '23502', detail: 'Failing row contains (c768b9b4-3a47-4916-9c94-6496e5986c69, Test Project, Test project, 3ba054af-ec4b-4fc5-9281-f90d7e9dc041, active, 2026-01-15 21:16:36.378603, 2026-01-15 21:16:36.378603, 3ba054af-ec4b-4fc5-9281-f90d7e9dc041, 26dc051e-223b-4c7e-8227-294dbbb0a45c, Test Project, f, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'projects', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[90/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mconvertImmediate[2m > [22mshould convert DOCX to PDF immediately
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, default, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,eed26a90-0b41-428c-a534-4d4164d30650,e15617e0-b9f0-4715-befc-4db947cfcd53,eed26a90-0b41-428c-a534-4d4164d30650[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: null value in column "created_by" of relation "projects" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 479, severity: 'ERROR', code: '23502', detail: 'Failing row contains (d857603f-329e-4291-a3dc-907dccc3c708, Test Project, Test project, eed26a90-0b41-428c-a534-4d4164d30650, active, 2026-01-15 21:16:37.08504, 2026-01-15 21:16:37.08504, eed26a90-0b41-428c-a534-4d4164d30650, e15617e0-b9f0-4715-befc-4db947cfcd53, Test Project, f, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'projects', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[91/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mconvertImmediate[2m > [22mshould handle conversion errors gracefully
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, default, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,305a1ce3-b18e-4ab2-a932-cca78284f114,1edcfef8-bf70-4fb4-9daf-95287b9c1c23,305a1ce3-b18e-4ab2-a932-cca78284f114[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: null value in column "created_by" of relation "projects" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 481, severity: 'ERROR', code: '23502', detail: 'Failing row contains (f0ae9ac6-7e5f-4673-8464-3e671f952336, Test Project, Test project, 305a1ce3-b18e-4ab2-a932-cca78284f114, active, 2026-01-15 21:16:37.786569, 2026-01-15 21:16:37.786569, 305a1ce3-b18e-4ab2-a932-cca78284f114, 1edcfef8-bf70-4fb4-9daf-95287b9c1c23, Test Project, f, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'projects', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[92/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mService Lifecycle[2m > [22mshould start and stop service
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, default, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,a27d3bb2-4e33-47b4-908b-6d9043815529,b14ea193-b4cf-4fa9-8572-0ebc4c1976e8,a27d3bb2-4e33-47b4-908b-6d9043815529[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: null value in column "created_by" of relation "projects" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 481, severity: 'ERROR', code: '23502', detail: 'Failing row contains (a91a260a-581b-4dc3-84a2-c695a6f4d248, Test Project, Test project, a27d3bb2-4e33-47b4-908b-6d9043815529, active, 2026-01-15 21:16:38.479616, 2026-01-15 21:16:38.479616, a27d3bb2-4e33-47b4-908b-6d9043815529, b14ea193-b4cf-4fa9-8572-0ebc4c1976e8, Test Project, f, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'projects', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[93/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mService Lifecycle[2m > [22mshould not start if already running
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, default, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,4675eda3-24b9-43fc-bb04-978908ffb5bb,3b87ffb9-9898-40f8-9889-a02c2bf5aa1e,4675eda3-24b9-43fc-bb04-978908ffb5bb[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: null value in column "created_by" of relation "projects" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 481, severity: 'ERROR', code: '23502', detail: 'Failing row contains (5a5af737-56ac-42a5-bbd4-f4a5f9b61f42, Test Project, Test project, 4675eda3-24b9-43fc-bb04-978908ffb5bb, active, 2026-01-15 21:16:39.188562, 2026-01-15 21:16:39.188562, 4675eda3-24b9-43fc-bb04-978908ffb5bb, 3b87ffb9-9898-40f8-9889-a02c2bf5aa1e, Test Project, f, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'projects', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[94/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mService Lifecycle[2m > [22mshould handle stop when not running
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, default, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,45df23f1-b569-458f-be88-8235c1b4aba5,ed39edcd-a5d7-4316-9337-30b1718c2211,45df23f1-b569-458f-be88-8235c1b4aba5[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: null value in column "created_by" of relation "projects" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 481, severity: 'ERROR', code: '23502', detail: 'Failing row contains (0086407e-4098-4529-942c-77ec2893ac7e, Test Project, Test project, 45df23f1-b569-458f-be88-8235c1b4aba5, active, 2026-01-15 21:16:39.888863, 2026-01-15 21:16:39.888863, 45df23f1-b569-458f-be88-8235c1b4aba5, ed39edcd-a5d7-4316-9337-30b1718c2211, Test Project, f, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'projects', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[95/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mQueue Processing[2m > [22mshould process pending jobs when queue is processed
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, default, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,46b8fab0-b038-47d8-8280-a27e271f3abb,c05c157b-d8cb-48cd-a219-4c8a84c2fd9f,46b8fab0-b038-47d8-8280-a27e271f3abb[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: null value in column "created_by" of relation "projects" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 481, severity: 'ERROR', code: '23502', detail: 'Failing row contains (3f747d4b-254b-4aec-b9e0-471a0fe47c6d, Test Project, Test project, 46b8fab0-b038-47d8-8280-a27e271f3abb, active, 2026-01-15 21:16:40.594639, 2026-01-15 21:16:40.594639, 46b8fab0-b038-47d8-8280-a27e271f3abb, c05c157b-d8cb-48cd-a219-4c8a84c2fd9f, Test Project, f, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'projects', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[96/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mQueue Processing[2m > [22mshould process multiple jobs in batch
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, default, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,f81e950f-70b9-4927-96c8-204ad7bcdab7,37926fa7-562b-4658-b0aa-840294e57c3d,f81e950f-70b9-4927-96c8-204ad7bcdab7[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: null value in column "created_by" of relation "projects" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 481, severity: 'ERROR', code: '23502', detail: 'Failing row contains (b08b6190-74f1-42ab-a6f8-b4a2409e71d6, Test Project, Test project, f81e950f-70b9-4927-96c8-204ad7bcdab7, active, 2026-01-15 21:16:41.287862, 2026-01-15 21:16:41.287862, f81e950f-70b9-4927-96c8-204ad7bcdab7, 37926fa7-562b-4658-b0aa-840294e57c3d, Test Project, f, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'projects', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[97/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mError Handling[2m > [22mshould handle missing DOCX output gracefully
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, default, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,0bb06d59-39f4-48da-9af1-a250895e391b,5dbfe111-603d-450a-8bd1-ecdcecb68e6d,0bb06d59-39f4-48da-9af1-a250895e391b[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: null value in column "created_by" of relation "projects" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 479, severity: 'ERROR', code: '23502', detail: 'Failing row contains (5c3ba4d2-d743-4bc0-8148-1d0e78e53dbe, Test Project, Test project, 0bb06d59-39f4-48da-9af1-a250895e391b, active, 2026-01-15 21:16:41.98847, 2026-01-15 21:16:41.98847, 0bb06d59-39f4-48da-9af1-a250895e391b, 5dbfe111-603d-450a-8bd1-ecdcecb68e6d, Test Project, f, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'projects', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[98/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mTransaction Support[2m > [22mshould support enqueue within transaction
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, default, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,f0106604-35be-451d-b1aa-beb21a461bc4,1c63e38a-7a61-48f2-abba-c1b9cc1ed0b1,f0106604-35be-451d-b1aa-beb21a461bc4[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: null value in column "created_by" of relation "projects" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 481, severity: 'ERROR', code: '23502', detail: 'Failing row contains (047e4a31-9a60-434d-9b64-ebd261648eb1, Test Project, Test project, f0106604-35be-451d-b1aa-beb21a461bc4, active, 2026-01-15 21:16:42.704916, 2026-01-15 21:16:42.704916, f0106604-35be-451d-b1aa-beb21a461bc4, 1c63e38a-7a61-48f2-abba-c1b9cc1ed0b1, Test Project, f, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'projects', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[99/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mTransaction Support[2m > [22mshould support convertImmediate within transaction
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, default, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,b8c0eb51-e87e-47e1-833d-b3a81f17d029,4b3c7f11-c2ff-4dd8-beba-75fa8cb729fd,b8c0eb51-e87e-47e1-833d-b3a81f17d029[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: null value in column "created_by" of relation "projects" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 481, severity: 'ERROR', code: '23502', detail: 'Failing row contains (04d3a6ef-93d1-4ff6-8e41-ab4ce1a3d041, Test Project, Test project, b8c0eb51-e87e-47e1-833d-b3a81f17d029, active, 2026-01-15 21:16:43.394307, 2026-01-15 21:16:43.394307, b8c0eb51-e87e-47e1-833d-b3a81f17d029, 4b3c7f11-c2ff-4dd8-beba-75fa8cb729fd, Test Project, f, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'projects', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[100/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowPatchService.test.ts[2m > [22mWorkflowPatchService[2m > [22mDataVault Additive Enforcement[2m > [22mshould allow safe DataVault operations (createTable, addColumns)
[31m[1mError[22m: Workflow not found[39m
[36m [2m‚ùØ[22m WorkflowPatchService.getTenantContext server/services/WorkflowPatchService.ts:[2m70:13[22m[39m
    [90m 68| [39m    [35mconst[39m workflow [33m=[39m [35mawait[39m workflowRepository[33m.[39m[34mfindById[39m(workflowId)[33m;[39m
    [90m 69| [39m    [35mif[39m ([33m![39mworkflow) {
    [90m 70| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Workflow not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m 71| [39m    }
    [90m 72| [39m
[90m [2m‚ùØ[22m WorkflowPatchService.applyOp server/services/WorkflowPatchService.ts:[2m514:30[22m[39m
[90m [2m‚ùØ[22m WorkflowPatchService.applyOps server/services/WorkflowPatchService.ts:[2m134:24[22m[39m
[90m [2m‚ùØ[22m tests/unit/services/WorkflowPatchService.test.ts:[2m482:22[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[101/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowPatchService.test.ts[2m > [22mWorkflowPatchService[2m > [22mOperation Application[2m > [22mshould clear tempId mappings between batch calls
[31m[1mError[22m: Invalid section ID: temp-section-1[39m
[36m [2m‚ùØ[22m Object.<anonymous> tests/unit/services/WorkflowPatchService.test.ts:[2m589:17[22m[39m
    [90m587| [39m      mockStepRepoCreate[33m.[39m[34mmockImplementation[39m([35masync[39m (data[33m:[39m any) [33m=>[39m {
    [90m588| [39m        [35mif[39m (data[33m.[39msectionId[33m?.[39m[34mstartsWith[39m([32m'temp-'[39m)) {
    [90m589| [39m          [35mthrow[39m [35mnew[39m [33mError[39m([32m`Invalid section ID: [39m[36m${[39mdata[33m.[39msectionId[36m}[39m[32m`[39m)[33m;[39m
    [90m   | [39m                [31m^[39m
    [90m590| [39m        }
    [90m591| [39m        [35mreturn[39m { id[33m:[39m [32m'step-1'[39m }[33m;[39m
[90m [2m‚ùØ[22m WorkflowPatchService.applyOp server/services/WorkflowPatchService.ts:[2m255:48[22m[39m
[90m [2m‚ùØ[22m WorkflowPatchService.applyOps server/services/WorkflowPatchService.ts:[2m134:24[22m[39m
[90m [2m‚ùØ[22m tests/unit/services/WorkflowPatchService.test.ts:[2m609:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[102/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowPatchService.test.ts[2m > [22mWorkflowPatchService[2m > [22mDocument Operations[2m > [22mshould reject binding to non-existent step alias
[31m[1mError[22m: Step alias 'nonExistentAlias' not found in workflow. Please create the step first.[39m
[36m [2m‚ùØ[22m WorkflowPatchService.applyOp server/services/WorkflowPatchService.ts:[2m487:19[22m[39m
    [90m485| [39m        [35mfor[39m ([35mconst[39m stepAlias [35mof[39m [33mObject[39m[33m.[39m[34mvalues[39m(op[33m.[39mbindings)) {
    [90m486| [39m          [35mif[39m ([33m![39mvalidAliases[33m.[39m[34mhas[39m(stepAlias)) {
    [90m487| [39m            [35mthrow[39m [35mnew[39m [33mError[39m(
    [90m   | [39m                  [31m^[39m
    [90m488| [39m              `Step alias '${stepAlias}' not found in workflow. Please‚Ä¶
    [90m489| [39m            )[33m;[39m
[90m [2m‚ùØ[22m WorkflowPatchService.applyOps server/services/WorkflowPatchService.ts:[2m134:24[22m[39m
[90m [2m‚ùØ[22m tests/unit/services/WorkflowPatchService.test.ts:[2m862:22[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[103/138]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mshould throw error if template belongs to different project
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, default, $5, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Other Project,Other Project,Another project,167897ed-fd09-4acc-a3c0-4c6d7849def1,167897ed-fd09-4acc-a3c0-4c6d7849def1[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m110:30[22m[39m
    [90m108| [39m    it('should throw error if template belongs to different project', ‚Ä¶
    [90m109| [39m      [90m// Create another project[39m
    [90m110| [39m      [35mconst[39m [otherProject] [33m=[39m [35mawait[39m db
    [90m   | [39m                             [31m^[39m
    [90m111| [39m        [33m.[39m[34minsert[39m(projects)
    [90m112| [39m        [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: null value in column "created_by" of relation "projects" violates not-null constraint[39m
[90m [2m‚ùØ[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2m‚ùØ[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m110:30[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 454, severity: 'ERROR', code: '23502', detail: 'Failing row contains (f48c2f90-bd7f-42b9-9566-0a8cce660833, Other Project, Another project, 167897ed-fd09-4acc-a3c0-4c6d7849def1, active, 2026-01-15 21:16:33.697605, 2026-01-15 21:16:33.697605, 167897ed-fd09-4acc-a3c0-4c6d7849def1, null, Other Project, f, null, null, null).', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'public', table: 'projects', dataType: undefined, constraint: undefined, file: 'execMain.c', routine: 'ExecConstraints' }[39m
[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[104/138]‚éØ[22m[39m


[2m Test Files [22m [1m[31m41 failed[39m[22m[2m | [22m[1m[32m114 passed[39m[22m[2m | [22m[33m1 skipped[39m[90m (156)[39m
[2m      Tests [22m [1m[31m117 failed[39m[22m[2m | [22m[1m[32m2242 passed[39m[22m[2m | [22m[33m21 skipped[39m[90m (2380)[39m
[2m   Start at [22m 15:16:28
[2m   Duration [22m 73.84s[2m (transform 27.02s, setup 19.21s, import 147.21s, tests 634.31s, environment 18.19s)[22m

