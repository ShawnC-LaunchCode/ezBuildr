npm warn Unknown project config "puppeteer_skip_download". This will stop working in the next major version of npm.

[1m[46m RUN [49m[22m [36mv4.0.16 [39m[90mC:/Users/scoot/poll/VaultLogic[39m

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w10_aef950c7

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w10_aef950c7

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w11_5d40d2a7

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w11_5d40d2a7

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768250118861,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768250118901,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768250118960,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768250118992,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w8_9e49ace6

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w8_9e49ace6

{"level":30,"time":1768250119828,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768250119874,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w9_9d80b8fc

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w9_9d80b8fc

{"level":30,"time":1768250120162,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768250120208,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

{"level":30,"time":1768250120683,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768250120694,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768250120700,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768250120702,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768250120705,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768250120733,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768250120733,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768250120742,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w5_df31ac3e

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w7_a7b3e856

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w6_12a6f122

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w1_f42eed12

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w7_a7b3e856

{"level":30,"time":1768250121227,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w1_f42eed12

{"level":30,"time":1768250121232,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w5_df31ac3e

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w6_12a6f122

{"level":30,"time":1768250121245,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768250121246,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768250121263,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768250121270,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

{"level":30,"time":1768250121283,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768250121283,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w2_c7d2f708

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w4_0c3dfcb4

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w3_d400aba4

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w0_b635fde1

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w2_c7d2f708

{"level":30,"time":1768250125897,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w4_0c3dfcb4

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w3_d400aba4

{"level":30,"time":1768250125910,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768250125910,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_b635fde1

{"level":30,"time":1768250125929,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768250125939,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

{"level":30,"time":1768250125951,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768250125952,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

{"level":30,"time":1768250125968,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

stderr | tests/integration/auth/oauth2.client-credentials.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: relation "global_recipients" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 115,
  severity: 'ERROR',
  code: '42P01',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'namespace.c',
  line: '637',
  routine: 'RangeVarGetRelidExtended'
}

{"level":50,"time":1768250126985,"env":"test","status":401,"statusText":"Unauthorized","error":"Invalid client credentials","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token request failed"}
{"level":50,"time":1768250126986,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768250126987,"env":"test","data":{"token_type":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768250126987,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768250126987,"env":"test","data":{"access_token":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768250126987,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768250126988,"env":"test","error":"Network error: ECONNREFUSED","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768250127092,"env":"test","error":"Invalid credentials","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":50,"time":1768250127092,"env":"test","error":"ECONNREFUSED","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768250127093,"env":"test","status":400,"statusText":"Bad Request","error":"Invalid grant_type","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token request failed"}
{"level":50,"time":1768250127093,"env":"test","error":"OAuth2 token request failed: 400 Bad Request","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768250127094,"env":"test","status":401,"statusText":"Unauthorized","error":"Client authentication failed","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token request failed"}
{"level":50,"time":1768250127094,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768250127094,"env":"test","status":403,"statusText":"Forbidden","error":"Access denied","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token request failed"}
{"level":50,"time":1768250127094,"env":"test","error":"OAuth2 token request failed: 403 Forbidden","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768250127094,"env":"test","status":500,"statusText":"Internal Server Error","error":"Server error","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token request failed"}
{"level":50,"time":1768250127094,"env":"test","error":"OAuth2 token request failed: 500 Internal Server Error","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768250127095,"env":"test","error":"Unexpected token in JSON","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768250127095,"env":"test","error":"Request timeout","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":30,"time":1768250127096,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768250127097,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w11_5d40d2a7

 [32mÎ“Â£Ã´[39m tests/integration/auth/oauth2.client-credentials.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 9831[2mms[22m[39m
stderr | tests/integration/auth.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: relation "global_recipients" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 115,
  severity: 'ERROR',
  code: '42P01',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'namespace.c',
  line: '637',
  routine: 'RangeVarGetRelidExtended'
}

{"level":30,"time":1768250132246,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250132247,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w10_aef950c7

 [32mÎ“Â£Ã´[39m tests/integration/auth.routes.test.ts [2m([22m[2m41 tests[22m[2m)[22m[33m 15244[2mms[22m[39m
stderr | tests/integration/auth/oauth2.callback.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: relation "global_recipients" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 115,
  severity: 'ERROR',
  code: '42P01',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'namespace.c',
  line: '637',
  routine: 'RangeVarGetRelidExtended'
}

{"level":30,"time":1768250137771,"env":"test","connectionId":"f0a91352-8b3b-48a0-808e-843ac8d7be1b","projectId":"659e90b2-313c-4653-9fba-4d5af5abfb37","name":"Test OAuth2 Connection","type":"oauth2_3leg","msg":"Connection created:"}
{"level":30,"time":1768250138824,"env":"test","connectionId":"5cb146e4-8c38-4733-a71a-ee6d82f24906","projectId":"659e90b2-313c-4653-9fba-4d5af5abfb37","name":"Status Test Connection","type":"oauth2_3leg","msg":"Connection created:"}
{"level":30,"time":1768250139503,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250139504,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w8_9e49ace6

 [32mÎ“Â£Ã´[39m tests/integration/auth/oauth2.callback.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 20607[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should initiate OAuth2 3-legged flow and generate authorization URL [33m 311[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should track OAuth2 connection status [33m 335[2mms[22m[39m
stderr | tests/integration/auth/oauth2.google.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: relation "global_recipients" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 115,
  severity: 'ERROR',
  code: '42P01',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'namespace.c',
  line: '637',
  routine: 'RangeVarGetRelidExtended'
}

{"level":30,"time":1768250143046,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":50,"time":1768250143271,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:165:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
{"level":50,"time":1768250143272,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:165:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google authentication failed"}
{"level":40,"time":1768250143322,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768250143322,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:89:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:155:23"},"msg":"Google token verification failed"}
{"level":50,"time":1768250143322,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:89:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:155:23"},"msg":"Google authentication failed"}
{"level":30,"time":1768250143703,"env":"test","module":"auth","email":"existing@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1768250144103,"env":"test","module":"auth","email":"refresh@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1768250144511,"env":"test","module":"auth","email":"idtoken@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1768250144922,"env":"test","module":"auth","email":"minimal@example.com","msg":"OAuth2 login successful"}
{"level":50,"time":1768250145018,"env":"test","module":"auth","err":{"type":"Error","message":"Token verification failed","stack":"Error: Token verification failed\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:425:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
{"level":40,"time":1768250145064,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768250145065,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:89:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
{"level":50,"time":1768250145112,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token payload","stack":"Error: Invalid token payload\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:85:25)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
{"level":30,"time":1768250145169,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250145169,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w9_9d80b8fc

 [32mÎ“Â£Ã´[39m tests/integration/auth/oauth2.google.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 25916[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should successfully authenticate with valid Google ID token [33m 528[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should update existing user on subsequent logins [33m 427[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should create refresh token record in database [33m 401[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should support both "token" and "idToken" fields [33m 361[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle missing profile information gracefully [33m 360[2mms[22m[39m
stderr | tests/integration/auth.routes.real.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: relation "global_recipients" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 115,
  severity: 'ERROR',
  code: '42P01',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'namespace.c',
  line: '637',
  routine: 'RangeVarGetRelidExtended'
}

{"level":30,"time":1768250148501,"env":"test","module":"user-credentials-repository","userId":"2138dfc0-48a9-402c-9cf1-4ab19e255a81","msg":"User credentials created"}
{"level":30,"time":1768250148597,"env":"test","module":"email-queue","jobId":"b678d517-3a24-46b9-9fe7-48754e2db99c","to":"test-1768250148115-utoqpp@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250148648,"env":"test","module":"auth-routes","userId":"2138dfc0-48a9-402c-9cf1-4ab19e255a81","email":"test-1768250148115-utoqpp@example.com","msg":"User registered"}
{"level":30,"time":1768250151351,"env":"test","module":"user-credentials-repository","userId":"e083f7f7-f0c9-4741-bc06-05bff41a7c8f","msg":"User credentials created"}
{"level":30,"time":1768250151447,"env":"test","module":"email-queue","jobId":"aa7cbc36-5902-4bf1-aac8-1fe48da9ce8b","to":"test-1768250150983-qhnvzj@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250151494,"env":"test","module":"auth-routes","userId":"e083f7f7-f0c9-4741-bc06-05bff41a7c8f","email":"test-1768250150983-qhnvzj@example.com","msg":"User registered"}
{"level":30,"time":1768250152659,"env":"test","module":"user-credentials-repository","userId":"198d1efd-eaee-4ba7-8735-353e862f9191","msg":"User credentials created"}
stderr | tests/integration/auth.flows.real.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: relation "global_recipients" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 115,
  severity: 'ERROR',
  code: '42P01',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'namespace.c',
  line: '637',
  routine: 'RangeVarGetRelidExtended'
}

{"level":30,"time":1768250152761,"env":"test","module":"email-queue","jobId":"3b105227-6167-42d2-94a6-2f3ad0771e86","to":"test-1768250152299-gm3eri@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250152809,"env":"test","module":"auth-routes","userId":"198d1efd-eaee-4ba7-8735-353e862f9191","email":"test-1768250152299-gm3eri@example.com","msg":"User registered"}
{"level":30,"time":1768250153659,"env":"test","module":"user-credentials-repository","userId":"afcdded0-338d-4d6f-8231-e399a380c81d","msg":"User credentials created"}
{"level":30,"time":1768250153754,"env":"test","module":"email-queue","jobId":"a5fb342e-9963-4956-b104-759812cb02b5","to":"test-1768250153274-fwgndw@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250153805,"env":"test","module":"auth-routes","userId":"afcdded0-338d-4d6f-8231-e399a380c81d","email":"test-1768250153274-fwgndw@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mComplete Registration Î“Ã¥Ã† Login Flow[2m > [22m[2mshould complete registration, verify email, then login
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould login with valid credentials
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768250154185,"env":"test","module":"auth-routes","userId":"afcdded0-338d-4d6f-8231-e399a380c81d","email":"test-1768250153274-fwgndw@example.com","msg":"Login blocked: email not verified"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Complete Registration Î“Ã¥Ã† Login Flow > should complete registration, verify email, then login
Login Failed DEBUG: EmailNotVerifiedError: Please verify your email before logging in. Check your inbox for the verification link.
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:86:11)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_006',
  statusCode: 403,
  isOperational: true
}

{"level":50,"time":1768250154186,"env":"test","module":"auth-routes","error":{"name":"EmailNotVerifiedError","code":"AUTH_006","statusCode":403,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mComplete Registration Î“Ã¥Ã† Login Flow[2m > [22m[2mshould complete registration, verify email, then login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250154390,"env":"test","module":"auth-routes","userId":"988d2696ff7c5b54981a9b51699a2974","msg":"User logged in successfully"}
{"level":30,"time":1768250154439,"env":"test","module":"audit-log-service","userId":"988d2696ff7c5b54981a9b51699a2974","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250154697,"env":"test","module":"auth-routes","userId":"afcdded0-338d-4d6f-8231-e399a380c81d","msg":"User logged in successfully"}
{"level":30,"time":1768250154750,"env":"test","module":"audit-log-service","userId":"afcdded0-338d-4d6f-8231-e399a380c81d","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for invalid password
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250155868,"env":"test","module":"auth-routes","email":"test-1768250155126-71w1sg@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":50,"time":1768250155959,"env":"test","module":"auth-routes","email":"test-1768250155217-sbc46b@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":50,"time":1768250155969,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250156054,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should return 401 for invalid password
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250156339,"env":"test","module":"auth-routes","email":"test-1768250155126-71w1sg@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":50,"time":1768250156434,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250156588,"env":"test","module":"auth-routes","userId":"3887d41326314152684b9819c4a6cec1","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250156693,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for non-existent user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250156851,"env":"test","module":"auth-routes","userId":"3887d41326314152684b9819c4a6cec1","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250156878,"env":"test","module":"auth-routes","email":"nonexistent@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768250156982,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250156988,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should return 401 for non-existent user
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:51:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250157127,"env":"test","module":"auth-routes","userId":"3887d41326314152684b9819c4a6cec1","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250157223,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250157375,"env":"test","module":"auth-routes","userId":"3887d41326314152684b9819c4a6cec1","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250157470,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/oauth2.sessions.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: relation "global_recipients" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 115,
  severity: 'ERROR',
  code: '42P01',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'namespace.c',
  line: '637',
  routine: 'RangeVarGetRelidExtended'
}

{"level":30,"time":1768250158139,"env":"test","module":"user-credentials-repository","userId":"e70fba99-f3cb-4a86-8b6a-f7a768c93c3e","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250158235,"env":"test","module":"email-queue","jobId":"e06f029d-2744-4fc4-a6be-ae362df77cc7","to":"test-1768250157768-t63sct@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250158287,"env":"test","module":"auth-routes","userId":"e70fba99-f3cb-4a86-8b6a-f7a768c93c3e","email":"test-1768250157768-t63sct@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 403 for unverified email
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250158539,"env":"test","module":"user-credentials-repository","userId":"UV5JAentgUlmQmrG0wM0W","msg":"User credentials created"}
{"level":50,"time":1768250158594,"env":"test","module":"auth-routes","email":"test-1768250157859-j83aq@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":40,"time":1768250158661,"env":"test","module":"auth-routes","userId":"e70fba99-f3cb-4a86-8b6a-f7a768c93c3e","email":"test-1768250157768-t63sct@example.com","msg":"Login blocked: email not verified"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should return 403 for unverified email
Login Failed DEBUG: EmailNotVerifiedError: Please verify your email before logging in. Check your inbox for the verification link.
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:86:11)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_006',
  statusCode: 403,
  isOperational: true
}

{"level":50,"time":1768250158661,"env":"test","module":"auth-routes","error":{"name":"EmailNotVerifiedError","code":"AUTH_006","statusCode":403,"isOperational":true},"msg":"Login failed"}
{"level":50,"time":1768250158698,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should record all login attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250158723,"env":"test","module":"auth-routes","userId":"UV5JAentgUlmQmrG0wM0W","sessionCount":2,"msg":"Listed active sessions"}
{"level":30,"time":1768250159052,"env":"test","module":"user-credentials-repository","userId":"ONAjtHxJG7IGV7SkpXv8B","msg":"User credentials created"}
{"level":50,"time":1768250159062,"env":"test","module":"auth-routes","email":"test-1768250157859-j83aq@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768250159155,"env":"test","module":"auth-routes","userId":"ONAjtHxJG7IGV7SkpXv8B","sessionCount":1,"msg":"Listed active sessions"}
{"level":50,"time":1768250159162,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should record all login attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250159309,"env":"test","module":"auth-routes","userId":"8b3cf0e39a9caeacd8afe2658188791a","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250159410,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should record all login attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250159472,"env":"test","module":"user-credentials-repository","userId":"yutbm6AopnsIqqmP6J_oy","msg":"User credentials created"}
{"level":30,"time":1768250159567,"env":"test","module":"auth-routes","userId":"yutbm6AopnsIqqmP6J_oy","sessionCount":0,"msg":"Listed active sessions"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould record failed login attempt
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250159888,"env":"test","module":"user-credentials-repository","userId":"93n7P0uaAJPafUXiRzPX-","msg":"User credentials created"}
{"level":50,"time":1768250159954,"env":"test","module":"auth-routes","userId":"ffdb09bb0c580d2934840821689b00c9","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250159985,"env":"test","module":"auth-routes","userId":"93n7P0uaAJPafUXiRzPX-","sessionCount":0,"msg":"Listed active sessions"}
{"level":50,"time":1768250160047,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should record failed login attempt
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould complete MFA setup and login with TOTP
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250160293,"env":"test","module":"user-credentials-repository","userId":"MrebKiwhk_vPUOGiWSaTh","msg":"User credentials created"}
{"level":30,"time":1768250160438,"env":"test","module":"auth-routes","userId":"MrebKiwhk_vPUOGiWSaTh","sessionCount":0,"msg":"Listed active sessions"}
{"level":30,"time":1768250160679,"env":"test","module":"auth-routes","userId":"410a150a11958f3274f8c4b050c6f1f8","msg":"User logged in successfully"}
{"level":30,"time":1768250160730,"env":"test","module":"audit-log-service","userId":"410a150a11958f3274f8c4b050c6f1f8","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250160754,"env":"test","module":"user-credentials-repository","userId":"t-eLr5Q96S2TslJJtRiCL","msg":"User credentials created"}
{"level":30,"time":1768250160854,"env":"test","module":"auth-routes","userId":"t-eLr5Q96S2TslJJtRiCL","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768250161170,"env":"test","module":"mfa-service","userId":"410a150a11958f3274f8c4b050c6f1f8","count":10,"msg":"Stored backup codes"}
{"level":30,"time":1768250161170,"env":"test","module":"mfa-service","userId":"410a150a11958f3274f8c4b050c6f1f8","msg":"Generated TOTP secret"}
{"level":30,"time":1768250161170,"env":"test","module":"auth-routes","userId":"410a150a11958f3274f8c4b050c6f1f8","msg":"MFA setup initiated"}
{"level":30,"time":1768250161176,"env":"test","module":"user-credentials-repository","userId":"mF-INtKMIZ6Aj59b79XSk","msg":"User credentials created"}
{"level":50,"time":1768250161179,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return requiresMfa=true for MFA-enabled users
[22m[39m[TEST UTILS] MFA Secret verified for 3e0a9c702702d21cabe705eea0600e4e

{"level":30,"time":1768250161462,"env":"test","module":"mfa-service","userId":"410a150a11958f3274f8c4b050c6f1f8","msg":"MFA enabled successfully"}
{"level":30,"time":1768250161462,"env":"test","module":"auth-routes","userId":"410a150a11958f3274f8c4b050c6f1f8","msg":"MFA enabled successfully"}
{"level":30,"time":1768250161497,"env":"test","module":"user-credentials-repository","userId":"sDjcPK5oSLlzRlWT1Ng08","msg":"User credentials created"}
{"level":30,"time":1768250161510,"env":"test","module":"audit-log-service","userId":"410a150a11958f3274f8c4b050c6f1f8","eventType":"mfa_enabled","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould complete MFA setup and login with TOTP
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return requiresMfa=true for MFA-enabled users
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250161657,"env":"test","module":"auth-routes","userId":"410a150a11958f3274f8c4b050c6f1f8","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250161699,"env":"test","module":"auth-routes","userId":"sDjcPK5oSLlzRlWT1Ng08","sessionId":"7ec63172-cc99-4e20-b963-6023201ac7de","msg":"Session revoked"}
{"level":50,"time":1768250161764,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > MFA Enrollment and Login Flow > should complete MFA setup and login with TOTP
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250162051,"env":"test","module":"auth-routes","userId":"3e0a9c702702d21cabe705eea0600e4e","msg":"Login requires MFA verification"}
{"level":30,"time":1768250162080,"env":"test","module":"user-credentials-repository","userId":"WnYWPWECyx9V-3JVOiY_4","msg":"User credentials created"}
{"level":30,"time":1768250162405,"env":"test","module":"user-credentials-repository","userId":"GEQKVLBOwRu0sXp34gbOc","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould login with backup code when TOTP unavailable
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250162868,"env":"test","module":"user-credentials-repository","userId":"iSt6JRRliIgck7BPr1_54","msg":"User credentials created"}
{"level":30,"time":1768250162976,"env":"test","module":"auth-routes","userId":"94703399e65b3e16f17bb33f57782cd4","msg":"User logged in successfully"}
{"level":30,"time":1768250163024,"env":"test","module":"audit-log-service","userId":"94703399e65b3e16f17bb33f57782cd4","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

stderr | tests/integration/auth/oauth2.token-refresh.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: relation "global_recipients" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 115,
  severity: 'ERROR',
  code: '42P01',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'namespace.c',
  line: '637',
  routine: 'RangeVarGetRelidExtended'
}

{"level":30,"time":1768250163386,"env":"test","module":"user-credentials-repository","userId":"_qQs2W_pWZ1VA0ziWMykO","msg":"User credentials created"}
{"level":50,"time":1768250163389,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250163445,"env":"test","module":"mfa-service","userId":"94703399e65b3e16f17bb33f57782cd4","count":10,"msg":"Stored backup codes"}
{"level":30,"time":1768250163445,"env":"test","module":"mfa-service","userId":"94703399e65b3e16f17bb33f57782cd4","msg":"Generated TOTP secret"}
{"level":30,"time":1768250163446,"env":"test","module":"auth-routes","userId":"94703399e65b3e16f17bb33f57782cd4","msg":"MFA setup initiated"}
{"level":50,"time":1768250163538,"env":"test","module":"auth-routes","email":"test-1768250162813-r82zah@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":50,"time":1768250163634,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250163704,"env":"test","module":"user-credentials-repository","userId":"5rnXSyyUE51Nb8bzxY9fc","msg":"User credentials created"}
{"level":30,"time":1768250163736,"env":"test","module":"mfa-service","userId":"94703399e65b3e16f17bb33f57782cd4","msg":"MFA enabled successfully"}
{"level":30,"time":1768250163736,"env":"test","module":"auth-routes","userId":"94703399e65b3e16f17bb33f57782cd4","msg":"MFA enabled successfully"}
{"level":30,"time":1768250163775,"env":"test","module":"user-credentials-repository","userId":"vbYiMXYfcQDYSpBt89Ycw","msg":"User credentials created"}
{"level":30,"time":1768250163788,"env":"test","module":"audit-log-service","userId":"94703399e65b3e16f17bb33f57782cd4","eventType":"mfa_enabled","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould login with backup code when TOTP unavailable
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250163850,"env":"test","module":"auth-service","tokenHash":"18a640bf283bbc3672860411bfe87c8c5b4786f92704904b0f6338f0871313c9","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":50,"time":1768250163945,"env":"test","module":"auth-routes","userId":"94703399e65b3e16f17bb33f57782cd4","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250163999,"env":"test","module":"auth-routes","email":"test-1768250162813-r82zah@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":50,"time":1768250164041,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > MFA Enrollment and Login Flow > should login with backup code when TOTP unavailable
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250164097,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250164194,"env":"test","module":"auth-routes","userId":"5rnXSyyUE51Nb8bzxY9fc","msg":"All other sessions revoked"}
{"level":30,"time":1768250164243,"env":"test","module":"audit-log-service","userId":"5rnXSyyUE51Nb8bzxY9fc","eventType":"all_sessions_revoked","ipAddress":"::ffff:127.0.0.1","hasMetadata":false,"msg":"Security event logged"}
{"level":30,"time":1768250164390,"env":"test","module":"user-credentials-repository","userId":"LBWQDL5wXV00lrf0ePnjv","msg":"User credentials created"}
{"level":30,"time":1768250164445,"env":"test","module":"auth-service","tokenHash":"a327111802069674207c75f89289340400693700f289558fab9dc29108e17082","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":50,"time":1768250164467,"env":"test","module":"auth-routes","email":"test-1768250162813-r82zah@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":50,"time":1768250164567,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250164614,"env":"test","module":"user-credentials-repository","userId":"kmQgjgRoUTbWsobggIBFY","msg":"User credentials created"}
{"level":50,"time":1768250164716,"env":"test","module":"auth-routes","userId":"acbae5696423063699d35526a041ca7e","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250164816,"env":"test","module":"auth-routes","userId":"kmQgjgRoUTbWsobggIBFY","msg":"All other sessions revoked"}
{"level":50,"time":1768250164820,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250164864,"env":"test","module":"audit-log-service","userId":"kmQgjgRoUTbWsobggIBFY","eventType":"all_sessions_revoked","ipAddress":"::ffff:127.0.0.1","hasMetadata":false,"msg":"Security event logged"}
{"level":50,"time":1768250164968,"env":"test","module":"auth-routes","userId":"acbae5696423063699d35526a041ca7e","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250165005,"env":"test","module":"email-queue","jobId":"d15650cc-4f9b-4659-a97f-10584514c573","to":"test-1768250164443-sbwzvv@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250165005,"env":"test","module":"auth-service","email":"test-1768250164443-sbwzvv@example.com","msg":"Password reset email sent"}
{"level":50,"time":1768250165064,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250165071,"env":"test","module":"user-credentials-repository","userId":"jc5kwHvO7k6R1SkjJI6E0","msg":"User credentials created"}
{"level":50,"time":1768250165209,"env":"test","module":"auth-routes","userId":"acbae5696423063699d35526a041ca7e","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250165225,"env":"test","module":"user-credentials-repository","userId":"VhbTdmLB6itrVAIp_kxPm","msg":"User credentials created"}
{"level":30,"time":1768250165306,"env":"test","module":"email-queue","jobId":"532d5ee8-948c-4baf-9293-cba9701746c5","to":"test-1768250164443-sbwzvv@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250165306,"env":"test","module":"auth-service","email":"test-1768250164443-sbwzvv@example.com","msg":"Password reset email sent"}
{"level":50,"time":1768250165311,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250165436,"env":"test","module":"user-credentials-repository","userId":"cGb_tZ9aqYs3-A_YIeGf7","msg":"User credentials created"}
{"level":30,"time":1768250165492,"env":"test","module":"auth-service","tokenHash":"2fe6f7ff0fa9bd1ee1eb2b4de4567a52a13546270f31f9607e884393806b0e0c","plainTokenLen":19,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250165540,"env":"test","module":"auth-service","tokenHash":"2fe6f7ff0fa9bd1ee1eb2b4de4567a52a13546270f31f9607e884393806b0e0c","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768250165547,"env":"test","module":"user-credentials-repository","userId":"QpluKKcb0IIukblypfkWn","msg":"User credentials created"}
{"level":50,"time":1768250165550,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250165586,"env":"test","module":"auth-service","allTokensCount":5,"sampleToken":"a327111802069674207c75f89289340400693700f289558fab9dc29108e17082","msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768250165683,"env":"test","module":"user-credentials-repository","userId":"4364543979e461bc35489ff71bb203d0","msg":"User password updated"}
{"level":30,"time":1768250165826,"env":"test","module":"audit-log-service","userId":"4364543979e461bc35489ff71bb203d0","eventType":"password_reset","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mPassword Reset Flow[2m > [22m[2mshould complete full password reset flow
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250165865,"env":"test","module":"user-credentials-repository","userId":"x0i1uAZ_cMj8JizzZX--s","msg":"User credentials created"}
{"level":30,"time":1768250165902,"env":"test","module":"user-credentials-repository","userId":"npf61yKbBTuPkUraVT_h_","msg":"User credentials created"}
{"level":30,"time":1768250165963,"env":"test","module":"auth-routes","userId":"x0i1uAZ_cMj8JizzZX--s","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Device marked as trusted"}
{"level":50,"time":1768250165975,"env":"test","module":"auth-routes","userId":"4364543979e461bc35489ff71bb203d0","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250166002,"env":"test","module":"auth-service","tokenHash":"719d4f34fd9de961e8180db389d381f3f2fb25ec3f7287005acb16280bd0a506","plainTokenLen":17,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250166052,"env":"test","module":"auth-service","tokenHash":"719d4f34fd9de961e8180db389d381f3f2fb25ec3f7287005acb16280bd0a506","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":50,"time":1768250166071,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Password Reset Flow > should complete full password reset flow
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mPassword Reset Flow[2m > [22m[2mshould complete full password reset flow
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250166097,"env":"test","module":"auth-service","allTokensCount":1,"sampleToken":"expired-token-hash","msg":"DEBUG: Tokens in DB"}
{"level":50,"time":1768250166220,"env":"test","module":"auth-routes","userId":"4364543979e461bc35489ff71bb203d0","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250166323,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Password Reset Flow > should complete full password reset flow
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250166331,"env":"test","module":"user-credentials-repository","userId":"v7GwPlUyjBdkDPuDw-GuN","msg":"User credentials created"}
{"level":30,"time":1768250166415,"env":"test","module":"user-credentials-repository","userId":"vM7TW99KhZSUdHtvl4C_N","msg":"User credentials created"}
{"level":30,"time":1768250166435,"env":"test","module":"auth-routes","userId":"v7GwPlUyjBdkDPuDw-GuN","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/logout[2m > [22m[2mshould logout and clear refresh token cookie
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250166516,"env":"test","module":"auth-service","tokenHash":"f173b6be2130a91552d39f7b09cd3000829ab6c199f41b690de6a7e77fae6271","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250166570,"env":"test","module":"auth-service","userId":"vM7TW99KhZSUdHtvl4C_N","tokenHash":"f173b6be2130a91552d39f7b09cd3000829ab6c199f41b690de6a7e77fae6271","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768250166582,"env":"test","module":"auth-routes","userId":"v7GwPlUyjBdkDPuDw-GuN","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Device marked as trusted"}
{"level":30,"time":1768250166922,"env":"test","module":"auth-routes","userId":"82bc878f29c0d148e2d81cfc90052e91","msg":"User logged in successfully"}
{"level":30,"time":1768250166938,"env":"test","module":"user-credentials-repository","userId":"P2VNK2-7m0GxmFwN3e9Sv","msg":"User credentials created"}
{"level":30,"time":1768250166943,"env":"test","module":"user-credentials-repository","userId":"K7jBsTSFEIoU5EN-s0XwO","msg":"User credentials created"}
{"level":30,"time":1768250166970,"env":"test","module":"audit-log-service","userId":"82bc878f29c0d148e2d81cfc90052e91","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250167049,"env":"test","module":"auth-routes","userId":"K7jBsTSFEIoU5EN-s0XwO","deviceCount":2,"msg":"Listed trusted devices"}
{"level":30,"time":1768250167061,"env":"test","module":"auth-service","tokenHash":"1292e5c9c04b1b644c8f0c5f6b4de92ca7e9a5fc365392cbbca2693331d342dd","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mPassword Reset Flow[2m > [22m[2mshould invalidate all sessions after password reset
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768250167109,"env":"test","module":"auth-service","tokenHash":"1292e5c9c04b1b644c8f0c5f6b4de92ca7e9a5fc365392cbbca2693331d342dd","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768250167159,"env":"test","module":"auth-service","allTokensCount":1,"sampleToken":"138e7163e49df9305dc6cd1265bc6e4b07d2a935e42b1083c17c95811f9877c1","msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768250167384,"env":"test","module":"user-credentials-repository","userId":"RGjw0uZIJleMEX9wF66XV","msg":"User credentials created"}
{"level":30,"time":1768250167478,"env":"test","module":"user-credentials-repository","userId":"qf9gj3DmKaPFDPkxa3c27","msg":"User credentials created"}
{"level":30,"time":1768250167484,"env":"test","module":"auth-routes","userId":"RGjw0uZIJleMEX9wF66XV","deviceCount":0,"msg":"Listed trusted devices"}
{"level":30,"time":1768250167532,"env":"test","module":"auth-service","tokenHash":"9877b9f54aeee7322c2941bcba2d9edae930ce61694fba60fc032aef93b156ca","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250167543,"env":"test","module":"auth-routes","userId":"0871090682206acf6f1e9bbe96186c36","msg":"User logged in successfully"}
{"level":30,"time":1768250167591,"env":"test","module":"audit-log-service","userId":"0871090682206acf6f1e9bbe96186c36","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250167784,"env":"test","module":"email-queue","jobId":"4c424254-ae3e-4b7f-ac7d-48b0a6e00ca6","to":"test-1768250166710-ua6k9v@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250167784,"env":"test","module":"auth-service","email":"test-1768250166710-ua6k9v@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768250167795,"env":"test","module":"user-credentials-repository","userId":"Mi20J0ftqmm2_t8SS76qW","msg":"User credentials created"}
{"level":30,"time":1768250167936,"env":"test","module":"auth-routes","userId":"Mi20J0ftqmm2_t8SS76qW","deviceId":"7ba6a18a-504a-4bbf-9820-837766aa20de","msg":"Trusted device revoked"}
{"level":30,"time":1768250168089,"env":"test","module":"user-credentials-repository","userId":"fqdW-mMKL-WA7vC0kv-CL","msg":"User credentials created"}
{"level":30,"time":1768250168142,"env":"test","module":"auth-service","tokenHash":"ba384a26d105c8c17074a6e7bb975c221f7ec1a8052567f8acfdb67e900123ee","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250168142,"env":"test","module":"auth-service","tokenHash":"ba384a26d105c8c17074a6e7bb975c221f7ec1a8052567f8acfdb67e900123ee","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":50,"time":1768250168148,"env":"test","module":"user-credentials-repository","error":{},"userId":"0871090682206acf6f1e9bbe96186c36","msg":"Failed to update user password"}
{"level":50,"time":1768250168148,"env":"test","module":"auth-routes","error":{},"msg":"Reset password error"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/refresh-token[2m > [22m[2mshould refresh access token with valid refresh token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250168302,"env":"test","module":"user-credentials-repository","userId":"hXoVvVFtSOjxweeAR-b3C","msg":"User credentials created"}
stderr | tests/integration/auth/session.management.integration.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: relation "global_recipients" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 115,
  severity: 'ERROR',
  code: '42P01',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'namespace.c',
  line: '637',
  routine: 'RangeVarGetRelidExtended'
}

{"level":40,"time":1768250168502,"env":"test","module":"auth-service","userId":"fqdW-mMKL-WA7vC0kv-CL","tokenHash":"ba384a26d105c8c17074a6e7bb975c221f7ec1a8052567f8acfdb67e900123ee","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768250168622,"env":"test","module":"user-credentials-repository","userId":"coh8FSPb_E7tlJ5Usrw8h","msg":"User credentials created"}
{"level":30,"time":1768250168643,"env":"test","module":"auth-routes","userId":"072861e11d298fc7532883f5fa254b08","msg":"User logged in successfully"}
{"level":30,"time":1768250168651,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768250168664,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests
[22m[39m[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768250168657,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768250168658,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768250168660,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768250168664,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768250168664,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768250168664,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768250168664,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768250168689,"env":"test","module":"audit-log-service","userId":"072861e11d298fc7532883f5fa254b08","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250168693,"env":"test","module":"auth-service","tokenHash":"f1e641cf5afe057f4bef5fe6cc9aff4d8548685a49cd063e2d753e1d2bee91d2","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250168870,"env":"test","module":"user-credentials-repository","userId":"7rN3qSeWozFmCxIc1APVz","msg":"User credentials created"}
{"level":30,"time":1768250168922,"env":"test","module":"auth-service","tokenHash":"723be8881cf2d6b330f7ae16754fda44ff8c0aac89412f87a5b56cce132e5be4","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250169043,"env":"test","module":"user-credentials-repository","userId":"sb2BM4swRxKBlC0lL__Lg","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould rotate refresh token on each use
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250169119,"env":"test","module":"user-credentials-repository","userId":"e808aa8e-0b9c-467f-825a-617aa3d9f9cf","msg":"User credentials created"}
{"level":30,"time":1768250169218,"env":"test","module":"email-queue","jobId":"c3b2e6f5-b379-45ec-b471-fd6709f64b6d","to":"test-HTl7rrNoOpFvlrKmPYt1C@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250169268,"env":"test","module":"auth-routes","userId":"e808aa8e-0b9c-467f-825a-617aa3d9f9cf","email":"test-HTl7rrNoOpFvlrKmPYt1C@example.com","msg":"User registered"}
{"level":30,"time":1768250169423,"env":"test","module":"user-credentials-repository","userId":"Ra-40VpCT9ysBJepPrAuU","msg":"User credentials created"}
{"level":30,"time":1768250169454,"env":"test","module":"user-credentials-repository","userId":"4yyLir8sAmCrtyoUdInoP","msg":"User credentials created"}
{"level":30,"time":1768250169470,"env":"test","module":"auth-service","tokenHash":"a741628e018d1f6ce29e971de89c007cd208790e5c334a3aafd00523ad8d4b16","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250169568,"env":"test","module":"auth-routes","userId":"3e5d93cf7a8641da405aa8cb02bd260c","msg":"User logged in successfully"}
{"level":40,"time":1768250169573,"env":"test","module":"auth-service","userId":"Ra-40VpCT9ysBJepPrAuU","tokenHash":"a741628e018d1f6ce29e971de89c007cd208790e5c334a3aafd00523ad8d4b16","msg":"Security: REUSED REFRESH TOKEN DETECTED (Concurrent). Revoking all sessions."}
{"level":30,"time":1768250169614,"env":"test","module":"audit-log-service","userId":"3e5d93cf7a8641da405aa8cb02bd260c","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250169618,"env":"test","module":"auth-service","tokenHash":"5cda7cf87e5a80afeaa40a2c47cf7ab252e473e4c6be5aa04a307aebc217bfbe","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250169652,"env":"test","module":"auth-service","tokenHash":"92e78c65e008fe93666095cef6063ca2f9648b806774f337f9add46e2d4e74fc","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250169703,"env":"test","module":"auth-service","tokenHash":"92e78c65e008fe93666095cef6063ca2f9648b806774f337f9add46e2d4e74fc","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768250169749,"env":"test","module":"auth-service","allTokensCount":1,"sampleToken":"5cda7cf87e5a80afeaa40a2c47cf7ab252e473e4c6be5aa04a307aebc217bfbe","msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768250169804,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250169805,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768250169809,"env":"test","module":"user-credentials-repository","userId":"b190770f-4d3c-4178-a15f-2c0d08ad2942","msg":"User credentials created"}
{"level":30,"time":1768250169816,"env":"test","module":"auth-service","tokenHash":"d4a9b046f93d8103255a06285ab502c3af45ca44661fbc86566dfacbcb921ec7","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250169924,"env":"test","module":"email-queue","jobId":"feab294b-ce91-449a-91cb-ac1bc090b465","to":"session-test-c9_7iJfKlsIlMzdj0CWSV@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250169935,"env":"test","module":"user-credentials-repository","userId":"EkJp1UwOMu6Jaf_ptC18t","msg":"User credentials created"}
{"level":30,"time":1768250169972,"env":"test","module":"auth-routes","userId":"b190770f-4d3c-4178-a15f-2c0d08ad2942","email":"session-test-c9_7iJfKlsIlMzdj0CWSV@example.com","msg":"User registered"}
{"level":30,"time":1768250169987,"env":"test","module":"auth-service","tokenHash":"334cde8562ef33bacbeba49a55b512ffa87f4338fcca0a289b79152c65cfc674","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250170020,"env":"test","module":"auth-service","tokenHash":"7875e08609f49331c8a8951e99eb28f3701e7379a4ed7730aaef52cc9efcea23","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Creation and Tracking[2m > [22m[2mshould create refresh token on login
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w7_a7b3e856

 [31mÎ“Â¥Â»[39m tests/integration/auth/oauth2.sessions.test.ts [2m([22m[2m25 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 49472[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should list all active sessions for current user [33m 512[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should mark current session as current [33m 425[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return empty array when user has no active sessions [33m 411[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not include expired sessions [33m 418[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not include revoked sessions [33m 453[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should parse device name from user agent [33m 418[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for unauthenticated request [33m 324[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke a specific session [33m 569[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 404 for non-existent session [33m 336[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prevent revoking current session [33m 467[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prevent revoking another user's session [33m 517[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for unauthenticated request [33m 320[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke all sessions except current [33m 901[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke all trusted devices [33m 624[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 400 when no active session found [33m 314[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for unauthenticated request [33m 322[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should mark current device as trusted [33m 460[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should update existing trusted device expiry[39m[33m 619[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should list all trusted devices [33m 421[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should not include revoked devices [33m 434[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should revoke a trusted device [33m 502[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should return 404 for non-existent device [33m 319[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should track IP address for sessions [33m 415[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should track user agent for sessions [33m 418[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update lastUsedAt on token refresh[39m[33m 664[2mms[22m[39m
{"level":50,"time":1768250170231,"env":"test","module":"auth-routes","userId":"b190770f-4d3c-4178-a15f-2c0d08ad2942","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250170332,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > Session Creation and Tracking > should create refresh token on login
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250170498,"env":"test","module":"user-credentials-repository","userId":"7xW8iSfH9tqi6Ul6dwdbd","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22m[2mOAuth2 Token Refresh Flow[2m > [22m[2mRefresh Token Lifecycle[2m > [22m[2mshould create refresh token on login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250170705,"env":"test","module":"auth-routes","userId":"7xW8iSfH9tqi6Ul6dwdbd","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250170713,"env":"test","module":"user-credentials-repository","userId":"e5c6c0e9-9575-4508-82f5-3b05cd2b385d","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/refresh-token[2m > [22m[2mshould rotate refresh token after use
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250170800,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > Refresh Token Lifecycle > should create refresh token on login
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250170816,"env":"test","module":"email-queue","jobId":"8b4881aa-0b61-44a2-8c06-a61637c01371","to":"session-test-jDe_KrhKNEUuQTeCMv7YX@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250170865,"env":"test","module":"auth-routes","userId":"e5c6c0e9-9575-4508-82f5-3b05cd2b385d","email":"session-test-jDe_KrhKNEUuQTeCMv7YX@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Creation and Tracking[2m > [22m[2mshould track device metadata in session
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould detect and prevent refresh token reuse (token theft)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250171119,"env":"test","module":"user-credentials-repository","userId":"jD7nd5vOqeUiheb-aW2BG","msg":"User credentials created"}
{"level":30,"time":1768250171258,"env":"test","module":"auth-routes","userId":"f2d75219a59a20e337623414a1acc044","msg":"User logged in successfully"}
{"level":30,"time":1768250171306,"env":"test","module":"audit-log-service","userId":"f2d75219a59a20e337623414a1acc044","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250171309,"env":"test","module":"auth-service","tokenHash":"829405e6ebd77137c0ef860051591f6d54281b2b5bd7496a996d571f968ebcef","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250171430,"env":"test","module":"auth-routes","userId":"e5c6c0e9-9575-4508-82f5-3b05cd2b385d","msg":"User logged in successfully"}
{"level":30,"time":1768250171451,"env":"test","module":"auth-routes","userId":"c43578fbca4044c9e915fc1de7a10c2d","msg":"User logged in successfully"}
{"level":30,"time":1768250171481,"env":"test","module":"audit-log-service","userId":"e5c6c0e9-9575-4508-82f5-3b05cd2b385d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250171500,"env":"test","module":"audit-log-service","userId":"c43578fbca4044c9e915fc1de7a10c2d","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250171503,"env":"test","module":"auth-service","tokenHash":"5a7e94e5eb183e077c17580557abef8c8a144482c70a8506fa09a62d54c2d3e6","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250171513,"env":"test","module":"auth-service","tokenHash":"829405e6ebd77137c0ef860051591f6d54281b2b5bd7496a996d571f968ebcef","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250171569,"env":"test","module":"auth-service","userId":"f2d75219a59a20e337623414a1acc044","tokenHash":"829405e6ebd77137c0ef860051591f6d54281b2b5bd7496a996d571f968ebcef","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768250171579,"env":"test","module":"user-credentials-repository","userId":"JBBhx1a8ay-68btBIAmAz","msg":"User credentials created"}
{"level":30,"time":1768250171697,"env":"test","module":"auth-service","tokenHash":"5a7e94e5eb183e077c17580557abef8c8a144482c70a8506fa09a62d54c2d3e6","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250171743,"env":"test","module":"auth-service","userId":"c43578fbca4044c9e915fc1de7a10c2d","tokenHash":"5a7e94e5eb183e077c17580557abef8c8a144482c70a8506fa09a62d54c2d3e6","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768250171907,"env":"test","module":"user-credentials-repository","userId":"45a2d2df-535b-4cdf-af8f-ec2c884104a8","msg":"User credentials created"}
{"level":30,"time":1768250171950,"env":"test","module":"user-credentials-repository","userId":"WlTwdNimNJVUDcGidBb3u","msg":"User credentials created"}
{"level":30,"time":1768250172008,"env":"test","module":"email-queue","jobId":"7302ba91-bf41-4d29-ac95-3d492c83877b","to":"session-test-n1v1LerJBjDfHqY13KgNy@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250172056,"env":"test","module":"auth-routes","userId":"45a2d2df-535b-4cdf-af8f-ec2c884104a8","email":"session-test-n1v1LerJBjDfHqY13KgNy@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Creation and Tracking[2m > [22m[2mshould create separate sessions for multiple device logins
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250172307,"env":"test","module":"auth-routes","userId":"45a2d2df-535b-4cdf-af8f-ec2c884104a8","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250172403,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > Session Creation and Tracking > should create separate sessions for multiple device logins
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250172468,"env":"test","module":"user-credentials-repository","userId":"8km5qGlaUPIjaLIHk7lPk","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould list all active sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250172769,"env":"test","module":"user-credentials-repository","userId":"b448592e-eda0-44eb-97ae-922050347a36","msg":"User credentials created"}
{"level":30,"time":1768250172868,"env":"test","module":"email-queue","jobId":"ff2fef44-d864-4268-a8e3-683998b1f415","to":"session-test-3jD_uU6xREsR3rYi4KsdW@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250172915,"env":"test","module":"auth-routes","userId":"b448592e-eda0-44eb-97ae-922050347a36","email":"session-test-3jD_uU6xREsR3rYi4KsdW@example.com","msg":"User registered"}
{"level":30,"time":1768250172935,"env":"test","module":"email-queue","jobId":"4dfc4ad6-3d17-4035-a327-5b9a59db1829","to":"test-1768250172375-1xscq6@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250172935,"env":"test","module":"auth-service","email":"test-1768250172375-1xscq6@example.com","msg":"Password reset email sent"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250173015,"env":"test","module":"user-credentials-repository","userId":"m8hnDhb4NPzgVdgyu-IRJ","msg":"User credentials created"}
{"level":30,"time":1768250173114,"env":"test","module":"auth-routes","userId":"69984980e120b0e029bfc89b33076b28","msg":"User logged in successfully"}
{"level":30,"time":1768250173434,"env":"test","module":"audit-log-service","userId":"69984980e120b0e029bfc89b33076b28","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould list all active sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250173473,"env":"test","module":"auth-routes","userId":"b448592e-eda0-44eb-97ae-922050347a36","msg":"User logged in successfully"}
{"level":30,"time":1768250173522,"env":"test","module":"audit-log-service","userId":"b448592e-eda0-44eb-97ae-922050347a36","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250173676,"env":"test","module":"auth-routes","userId":"b448592e-eda0-44eb-97ae-922050347a36","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250173773,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > GET /api/auth/sessions > should list all active sessions for user
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: relation "global_recipients" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 115,
  severity: 'ERROR',
  code: '42P01',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'namespace.c',
  line: '637',
  routine: 'RangeVarGetRelidExtended'
}

{"level":30,"time":1768250173910,"env":"test","module":"auth-routes","userId":"69984980e120b0e029bfc89b33076b28","msg":"User logged in successfully"}
{"level":30,"time":1768250173967,"env":"test","module":"audit-log-service","userId":"69984980e120b0e029bfc89b33076b28","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250174005,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768250174023,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests
[22m[39m[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768250174012,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768250174012,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768250174018,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768250174022,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768250174023,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768250174023,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768250174023,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768250174069,"env":"test","module":"auth-routes","userId":"69984980e120b0e029bfc89b33076b28","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768250174152,"env":"test","module":"user-credentials-repository","userId":"73891e57-8806-490f-8401-8143906384c0","msg":"User credentials created"}
{"level":30,"time":1768250174258,"env":"test","module":"email-queue","jobId":"11ef68e9-728d-455c-a95f-b80642f17811","to":"session-test-gqQGzYRIOBIYpIO7qqdxs@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250174310,"env":"test","module":"auth-routes","userId":"73891e57-8806-490f-8401-8143906384c0","email":"session-test-gqQGzYRIOBIYpIO7qqdxs@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould mark current session correctly
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250174482,"env":"test","module":"user-credentials-repository","userId":"fc9360b1-ccc2-4dea-b770-0dfaf6951ac3","msg":"User credentials created"}
{"level":50,"time":1768250174562,"env":"test","module":"auth-routes","userId":"73891e57-8806-490f-8401-8143906384c0","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250174578,"env":"test","module":"email-queue","jobId":"77bc02b8-6b67-41af-9b8b-20c2fa24a9c9","to":"test-27LOJOtF2SPvnCacUVr-j@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250174630,"env":"test","module":"auth-routes","userId":"fc9360b1-ccc2-4dea-b770-0dfaf6951ac3","email":"test-27LOJOtF2SPvnCacUVr-j@example.com","msg":"User registered"}
{"level":50,"time":1768250174659,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > GET /api/auth/sessions > should mark current session correctly
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250174990,"env":"test","module":"auth-routes","userId":"3922aef85f3b0cf3a9313fd2427ab8f5","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250175035,"env":"test","module":"user-credentials-repository","userId":"eb77a963-b262-4d9f-816c-648e141b2270","msg":"User credentials created"}
{"level":50,"time":1768250175092,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Session Management Flow > should revoke specific session
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250175138,"env":"test","module":"email-queue","jobId":"1751eb30-ac01-4ebc-8e20-68968c73e0ab","to":"session-test-inMG-J1-yd9qTjXgtO2FC@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250175189,"env":"test","module":"auth-routes","userId":"eb77a963-b262-4d9f-816c-648e141b2270","email":"session-test-inMG-J1-yd9qTjXgtO2FC@example.com","msg":"User registered"}
{"level":50,"time":1768250175242,"env":"test","module":"auth-routes","userId":"3922aef85f3b0cf3a9313fd2427ab8f5","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250175270,"env":"test","module":"user-credentials-repository","userId":"390fd1c5-055b-4279-a425-b89f80dc01d0","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould not include revoked sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250175350,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Session Management Flow > should revoke specific session
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250175354,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250175355,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250175357,"env":"test","module":"email-queue","jobId":"5bb690c8-9f1d-48fb-b792-b2fc250da961","to":"test-1768250174806-tkveym@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250175356,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768250175357,"env":"test","module":"auth-service","email":"test-1768250174806-tkveym@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768250175369,"env":"test","module":"email-queue","jobId":"a8548007-86f9-4d78-a0b1-a19d7c0dfc48","to":"middleware-test-GxhPyMEYeN9XN4rzwI57P@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250175421,"env":"test","module":"auth-routes","userId":"390fd1c5-055b-4279-a425-b89f80dc01d0","email":"middleware-test-GxhPyMEYeN9XN4rzwI57P@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould allow access with valid JWT Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w6_12a6f122

{"level":30,"time":1768250175728,"env":"test","module":"user-credentials-repository","userId":"5acae90143a4954f42456da17469ff9c","msg":"User password updated"}
 [31mÎ“Â¥Â»[39m tests/integration/auth.flows.real.test.ts [2m([22m[2m11 tests[22m[2m | [22m[31m7 failed[39m[2m)[22m[33m 55014[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should complete registration, verify email, then login [33m 1850[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should lock account after 5 failed attempts, then unlock after waiting[39m[33m 2723[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should record all login attempts[39m[33m 1985[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should complete MFA setup and login with TOTP[39m[33m 2306[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should login with backup code when TOTP unavailable[39m[33m 2277[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should complete full password reset flow[39m[33m 2281[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should invalidate all sessions after password reset [33m 2025[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should rotate refresh token on each use [33m 1883[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should detect and prevent refresh token reuse (token theft) [33m 1660[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all active sessions[39m[33m 2180[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific session[39m[33m 1282[2mms[22m[39m
{"level":30,"time":1768250175765,"env":"test","module":"auth-routes","userId":"eb77a963-b262-4d9f-816c-648e141b2270","msg":"User logged in successfully"}
{"level":30,"time":1768250175813,"env":"test","module":"audit-log-service","userId":"eb77a963-b262-4d9f-816c-648e141b2270","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould not include revoked sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250175882,"env":"test","module":"audit-log-service","userId":"5acae90143a4954f42456da17469ff9c","eventType":"password_reset","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/reset-password[2m > [22m[2mshould reset password with valid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250175946,"env":"test","module":"auth-routes","userId":"390fd1c5-055b-4279-a425-b89f80dc01d0","msg":"User logged in successfully"}
{"level":30,"time":1768250175998,"env":"test","module":"audit-log-service","userId":"390fd1c5-055b-4279-a425-b89f80dc01d0","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250176276,"env":"test","module":"auth-routes","userId":"eb77a963-b262-4d9f-816c-648e141b2270","msg":"User logged in successfully"}
{"level":30,"time":1768250176326,"env":"test","module":"audit-log-service","userId":"eb77a963-b262-4d9f-816c-648e141b2270","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250176349,"env":"test","module":"auth-routes","userId":"5acae90143a4954f42456da17469ff9c","msg":"User logged in successfully"}
{"level":30,"time":1768250176399,"env":"test","module":"audit-log-service","userId":"5acae90143a4954f42456da17469ff9c","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/reset-password[2m > [22m[2mshould reset password with valid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250176425,"env":"test","module":"auth-routes","userId":"eb77a963-b262-4d9f-816c-648e141b2270","sessionCount":2,"msg":"Listed active sessions"}
{"level":30,"time":1768250176478,"env":"test","module":"user-credentials-repository","userId":"e40123bc-31cd-4102-9351-da530012cc77","msg":"User credentials created"}
{"level":30,"time":1768250176579,"env":"test","module":"auth-routes","userId":"eb77a963-b262-4d9f-816c-648e141b2270","sessionId":"58ed0c01-cb52-4c80-9c4e-842623c21abf","msg":"Session revoked"}
{"level":30,"time":1768250176579,"env":"test","module":"email-queue","jobId":"5ea647b9-62a0-4e56-9bb6-c0bda74e7b91","to":"middleware-test-yIrulEyLXq6mI9jG3ObZR@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250176627,"env":"test","module":"auth-routes","userId":"e40123bc-31cd-4102-9351-da530012cc77","email":"middleware-test-yIrulEyLXq6mI9jG3ObZR@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 when no token provided
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250176681,"env":"test","module":"auth-routes","userId":"eb77a963-b262-4d9f-816c-648e141b2270","sessionCount":1,"msg":"Listed active sessions"}
{"level":50,"time":1768250176757,"env":"test","module":"auth-routes","email":"test-1768250174806-tkveym@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":50,"time":1768250176850,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/reset-password > should reset password with valid token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250177052,"env":"test","module":"user-credentials-repository","userId":"ce1f19c7-a8c7-40d6-b7a0-54f3a674fc24","msg":"User credentials created"}
{"level":30,"time":1768250177136,"env":"test","module":"auth-routes","userId":"e40123bc-31cd-4102-9351-da530012cc77","msg":"User logged in successfully"}
{"level":30,"time":1768250177156,"env":"test","module":"email-queue","jobId":"5a9bedfd-eb6b-4212-bb65-ecd701df7b9e","to":"session-test-18fA7_QrNIJC_PCfnA8dm@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250177184,"env":"test","module":"audit-log-service","userId":"e40123bc-31cd-4102-9351-da530012cc77","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250177188,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250177205,"env":"test","module":"auth-routes","userId":"ce1f19c7-a8c7-40d6-b7a0-54f3a674fc24","email":"session-test-18fA7_QrNIJC_PCfnA8dm@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250177458,"env":"test","module":"auth-routes","userId":"ce1f19c7-a8c7-40d6-b7a0-54f3a674fc24","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250177555,"env":"test","module":"user-credentials-repository","userId":"a2657d76-b8c7-456b-96ea-338f80f13496","msg":"User credentials created"}
{"level":50,"time":1768250177558,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > GET /api/auth/sessions > should order sessions by last used (most recent first)
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250177648,"env":"test","module":"email-queue","jobId":"a854355d-0c4d-424f-950a-a9b2679c7167","to":"middleware-test-CwR1JZETn8zJ6INJj7MDM@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250177697,"env":"test","module":"auth-routes","userId":"a2657d76-b8c7-456b-96ea-338f80f13496","email":"middleware-test-CwR1JZETn8zJ6INJj7MDM@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 with invalid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250177891,"env":"test","module":"auth-routes","userId":"a2657d76-b8c7-456b-96ea-338f80f13496","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250177930,"env":"test","module":"user-credentials-repository","userId":"413db08f-cfbe-4430-8548-bfb49105c064","msg":"User credentials created"}
{"level":50,"time":1768250177992,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should return 401 with invalid token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should return 401 with invalid token
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:36:17.995Z'
  }
}

{"level":30,"time":1768250178026,"env":"test","module":"email-queue","jobId":"e8d866ab-0261-4003-ba5b-ba2e9f75edd3","to":"session-test-uKlQWc7slB2MLflqPgcal@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 with invalid token
[22m[39mUser in DB: {
  id: [32m'a2657d76-b8c7-456b-96ea-338f80f13496'[39m,
  email: [32m'middleware-test-CwR1JZETn8zJ6INJj7MDM@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:36:20.463Z[39m,
  updatedAt: [35m2026-01-12T20:36:20.463Z[39m
}

{"level":30,"time":1768250178077,"env":"test","module":"auth-routes","userId":"413db08f-cfbe-4430-8548-bfb49105c064","email":"session-test-uKlQWc7slB2MLflqPgcal@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 with invalid token
[22m[39mCreds in DB: [90mundefined[39m

{"level":50,"time":1768250178174,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250178479,"env":"test","module":"user-credentials-repository","userId":"42796e31-1b76-456c-a1fa-f7ada559775a","msg":"User credentials created"}
{"level":30,"time":1768250178504,"env":"test","module":"user-credentials-repository","userId":"sGwWZW8wwf76RkWAnrOiy","msg":"User credentials created"}
{"level":30,"time":1768250178540,"env":"test","module":"user-credentials-repository","userId":"7d95ccb6-67c4-486e-8912-867eed9ed2b6","msg":"User credentials created"}
{"level":30,"time":1768250178580,"env":"test","module":"email-queue","jobId":"0de7f923-9497-4b75-97ad-70656b090dfa","to":"middleware-test-p5JtQw5Lm_qNvyOY7a_rv@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250178626,"env":"test","module":"auth-routes","userId":"42796e31-1b76-456c-a1fa-f7ada559775a","email":"middleware-test-p5JtQw5Lm_qNvyOY7a_rv@example.com","msg":"User registered"}
{"level":30,"time":1768250178634,"env":"test","module":"email-queue","jobId":"130c9881-63be-4c17-aee5-a0896682431e","to":"session-test-0FhFew_nbBrlfNKctDPD-@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 with expired token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250178682,"env":"test","module":"auth-routes","userId":"7d95ccb6-67c4-486e-8912-867eed9ed2b6","email":"session-test-0FhFew_nbBrlfNKctDPD-@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250178960,"env":"test","module":"user-credentials-repository","userId":"hekMg7Xz3QpVYIiyb75t9","msg":"User credentials created"}
{"level":30,"time":1768250179000,"env":"test","module":"email-queue","jobId":"e4a9b78e-ef2c-4e34-8c38-e700c403d1c8","to":"test-1768250178432-ccygxe@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250179000,"env":"test","module":"auth-service","email":"test-1768250178432-ccygxe@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768250179009,"env":"test","module":"auth-service","tokenHash":"645dcc184d33abb3f92116e96ca2111b0277fccd6ab9724c609b6f3ac4cbbe80","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250179134,"env":"test","module":"auth-routes","userId":"42796e31-1b76-456c-a1fa-f7ada559775a","msg":"User logged in successfully"}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: relation "global_recipients" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 115,
  severity: 'ERROR',
  code: '42P01',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'namespace.c',
  line: '637',
  routine: 'RangeVarGetRelidExtended'
}

{"level":30,"time":1768250179183,"env":"test","module":"audit-log-service","userId":"42796e31-1b76-456c-a1fa-f7ada559775a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250179211,"env":"test","module":"auth-service","tokenHash":"645dcc184d33abb3f92116e96ca2111b0277fccd6ab9724c609b6f3ac4cbbe80","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250179242,"env":"test","module":"auth-routes","userId":"7d95ccb6-67c4-486e-8912-867eed9ed2b6","msg":"User logged in successfully"}
{"level":40,"time":1768250179255,"env":"test","module":"auth-service","userId":"hekMg7Xz3QpVYIiyb75t9","tokenHash":"645dcc184d33abb3f92116e96ca2111b0277fccd6ab9724c609b6f3ac4cbbe80","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768250179290,"env":"test","module":"audit-log-service","userId":"7d95ccb6-67c4-486e-8912-867eed9ed2b6","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250179358,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768250179375,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests
[22m[39m[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768250179365,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768250179366,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768250179370,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768250179375,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768250179375,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768250179375,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768250179375,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768250179615,"env":"test","module":"user-credentials-repository","userId":"asYCTra3UvZUivsfG7x13","msg":"User credentials created"}
{"level":30,"time":1768250179759,"env":"test","module":"auth-routes","userId":"7d95ccb6-67c4-486e-8912-867eed9ed2b6","msg":"User logged in successfully"}
{"level":30,"time":1768250179807,"env":"test","module":"audit-log-service","userId":"7d95ccb6-67c4-486e-8912-867eed9ed2b6","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250179835,"env":"test","module":"user-credentials-repository","userId":"00f1c84f-7f47-4e97-8d29-cf5c9d6b90f8","msg":"User credentials created"}
{"level":30,"time":1768250179907,"env":"test","module":"auth-routes","userId":"7d95ccb6-67c4-486e-8912-867eed9ed2b6","sessionCount":0,"msg":"Listed active sessions"}
{"level":30,"time":1768250179935,"env":"test","module":"email-queue","jobId":"b5e9e4ec-db6b-488e-8ccd-21ab2e23b28f","to":"test-sGckQl5fL6Hl188n2O7e9@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250179989,"env":"test","module":"auth-routes","userId":"00f1c84f-7f47-4e97-8d29-cf5c9d6b90f8","email":"test-sGckQl5fL6Hl188n2O7e9@example.com","msg":"User registered"}
{"level":30,"time":1768250180081,"env":"test","module":"user-credentials-repository","userId":"R0mfbYtOPESH5eA92OFt6","msg":"User credentials created"}
{"level":30,"time":1768250180129,"env":"test","module":"auth-service","tokenHash":"cf02e2cb3914d38ec300ff96718614502e1b4413b5745cf6e1cbad52bb23e8a6","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mGET /api/auth/me[2m > [22m[2mshould return current user for valid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250180277,"env":"test","module":"user-credentials-repository","userId":"ff68a937-562f-49b7-b1f6-1b5d1b6c9070","msg":"User credentials created"}
{"level":40,"time":1768250180288,"env":"test","module":"auth-middleware","error":{"name":"TokenExpiredError","code":"AUTH_002","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768250180288,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250180378,"env":"test","module":"email-queue","jobId":"f270aacd-7ce5-4f20-8fb6-3773648f6131","to":"session-test-tqUL90ObXcGA6whdF6LKS@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250180431,"env":"test","module":"auth-routes","userId":"ff68a937-562f-49b7-b1f6-1b5d1b6c9070","email":"session-test-tqUL90ObXcGA6whdF6LKS@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking current session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250180641,"env":"test","module":"user-credentials-repository","userId":"4a18e670-deef-4173-97d2-8ce153cc5467","msg":"User credentials created"}
{"level":30,"time":1768250180648,"env":"test","module":"user-credentials-repository","userId":"c7oAmRL7XFl0CXKPhRsRI","msg":"User credentials created"}
{"level":30,"time":1768250180670,"env":"test","module":"user-credentials-repository","userId":"a0cd0157-56ba-4615-a915-2f97e66b032b","msg":"User credentials created"}
{"level":30,"time":1768250180701,"env":"test","module":"auth-service","tokenHash":"dea1f3db7ff6e21df26f72c44374ff4938c9ef0e0f5baeb2b979276ba82e6ad4","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250180731,"env":"test","module":"auth-routes","userId":"9081103a4ff73ff83a55c3b94b521d9c","msg":"User logged in successfully"}
{"level":30,"time":1768250180745,"env":"test","module":"email-queue","jobId":"1f1bdbd8-183a-4d24-acdf-8284e2cd7918","to":"protected-test-NqumAshxJ_7C1orUjBEMh@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250180767,"env":"test","module":"email-queue","jobId":"72d2ceac-c40e-4bf3-924f-ea80616060a1","to":"middleware-test-l0YmwtpSoxgzuVgMTdFkJ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250180779,"env":"test","module":"audit-log-service","userId":"9081103a4ff73ff83a55c3b94b521d9c","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250180793,"env":"test","module":"auth-routes","userId":"4a18e670-deef-4173-97d2-8ce153cc5467","email":"protected-test-NqumAshxJ_7C1orUjBEMh@example.com","msg":"User registered"}
{"level":30,"time":1768250180819,"env":"test","module":"auth-routes","userId":"a0cd0157-56ba-4615-a915-2f97e66b032b","email":"middleware-test-l0YmwtpSoxgzuVgMTdFkJ@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould authenticate with JWT Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould allow access with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250181009,"env":"test","module":"auth-routes","userId":"ff68a937-562f-49b7-b1f6-1b5d1b6c9070","msg":"User logged in successfully"}
{"level":30,"time":1768250181057,"env":"test","module":"audit-log-service","userId":"ff68a937-562f-49b7-b1f6-1b5d1b6c9070","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250181156,"env":"test","module":"auth-routes","userId":"ff68a937-562f-49b7-b1f6-1b5d1b6c9070","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768250181213,"env":"test","module":"user-credentials-repository","userId":"W_2o-_x9U7ivKzxzQWFaO","msg":"User credentials created"}
{"level":30,"time":1768250181260,"env":"test","module":"auth-service","tokenHash":"6994d974d4c263d91e663371f41c8ff1ee6843bd9a39fb3069e6ff28e515050f","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250181334,"env":"test","module":"auth-routes","userId":"a0cd0157-56ba-4615-a915-2f97e66b032b","msg":"User logged in successfully"}
{"level":30,"time":1768250181381,"env":"test","module":"audit-log-service","userId":"a0cd0157-56ba-4615-a915-2f97e66b032b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250181411,"env":"test","module":"auth-routes","userId":"4a18e670-deef-4173-97d2-8ce153cc5467","msg":"User logged in successfully"}
{"level":30,"time":1768250181459,"env":"test","module":"audit-log-service","userId":"4a18e670-deef-4173-97d2-8ce153cc5467","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250181624,"env":"test","module":"user-credentials-repository","userId":"fee6d00c-010e-4935-b662-bc1e75f70014","msg":"User credentials created"}
{"level":50,"time":1768250181658,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250181726,"env":"test","module":"email-queue","jobId":"a6931f92-ee30-4b1b-9932-c72572f8b8dd","to":"session-test-bPXW7n7FLu3mabkxbH3Du@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250181778,"env":"test","module":"user-credentials-repository","userId":"0SRhtRz_E09gRXL4_poj8","msg":"User credentials created"}
{"level":30,"time":1768250181780,"env":"test","module":"auth-routes","userId":"fee6d00c-010e-4935-b662-bc1e75f70014","email":"session-test-bPXW7n7FLu3mabkxbH3Du@example.com","msg":"User registered"}
{"level":30,"time":1768250181834,"env":"test","module":"auth-service","tokenHash":"328d93fc8ecb2c8229130d1f4a9e73de88b081abc2baf8ceac5e38114ba262a8","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250181851,"env":"test","module":"user-credentials-repository","userId":"0b9230c0-d16d-4815-a3e7-4b89ad59e0b7","msg":"User credentials created"}
{"level":30,"time":1768250181900,"env":"test","module":"user-credentials-repository","userId":"b473179a-7c4c-4c47-ae97-af9d6f04fe79","msg":"User credentials created"}
{"level":30,"time":1768250181951,"env":"test","module":"email-queue","jobId":"fa3ca3cc-7b22-4e68-a15b-68a0383166e3","to":"middleware-test-DbobhAgUEICGQL8ymTH3E@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250182003,"env":"test","module":"email-queue","jobId":"b4ba565d-771f-48da-8f56-ceb44e9ab274","to":"protected-test-gPkgNHoVP7TIWf6NSd70q@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250182004,"env":"test","module":"auth-routes","userId":"0b9230c0-d16d-4815-a3e7-4b89ad59e0b7","email":"middleware-test-DbobhAgUEICGQL8ymTH3E@example.com","msg":"User registered"}
{"level":30,"time":1768250182059,"env":"test","module":"auth-routes","userId":"b473179a-7c4c-4c47-ae97-af9d6f04fe79","email":"protected-test-gPkgNHoVP7TIWf6NSd70q@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould authenticate with refresh token cookie (GET only)
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould reject access without Authorization header
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250182214,"env":"test","module":"auth-routes","userId":"0b9230c0-d16d-4815-a3e7-4b89ad59e0b7","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250182258,"env":"test","module":"user-credentials-repository","userId":"663fcb34-2188-40de-b33a-ab45c4b70761","msg":"User credentials created"}
{"level":50,"time":1768250182305,"env":"test","module":"auth-routes","userId":"b473179a-7c4c-4c47-ae97-af9d6f04fe79","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250182307,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250182308,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768250182313,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should authenticate with refresh token cookie (GET only)
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should authenticate with refresh token cookie (GET only)
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:36:22.314Z'
  }
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould authenticate with refresh token cookie (GET only)
[22m[39mUser in DB: {
  id: [32m'0b9230c0-d16d-4815-a3e7-4b89ad59e0b7'[39m,
  email: [32m'middleware-test-DbobhAgUEICGQL8ymTH3E@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:36:24.750Z[39m,
  updatedAt: [35m2026-01-12T20:36:24.750Z[39m
}

{"level":30,"time":1768250182367,"env":"test","module":"email-queue","jobId":"1962b8b9-2bcc-4c11-b22a-cbe471414b70","to":"user2-EQrvJFtMIot-u2HGAMJsu@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768250182401,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould authenticate with refresh token cookie (GET only)
[22m[39mCreds in DB: [90mundefined[39m

{"level":30,"time":1768250182422,"env":"test","module":"auth-routes","userId":"663fcb34-2188-40de-b33a-ab45c4b70761","email":"user2-EQrvJFtMIot-u2HGAMJsu@example.com","msg":"User registered"}
{"level":50,"time":1768250182425,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould not allow revoking other users sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w5_df31ac3e

{"level":50,"time":1768250182627,"env":"test","module":"auth-routes","userId":"663fcb34-2188-40de-b33a-ab45c4b70761","msg":"DEBUG: ValidateCredentials - Credentials not found"}
 [31mÎ“Â¥Â»[39m tests/integration/auth/oauth2.token-refresh.test.ts [2m([22m[2m25 tests[22m[2m | [22m[31m3 failed[39m[2m)[22m[33m 61963[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should refresh access token with valid refresh token [33m 615[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should rotate refresh token after use [33m 683[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 when refresh token is missing [33m 369[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for invalid refresh token [33m 462[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for expired refresh token [33m 512[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for revoked refresh token [33m 519[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 when user is not found [33m 542[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update refresh token metadata on rotation[39m[33m 616[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle concurrent refresh token requests (token reuse detection) [33m 779[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set secure cookie in production [33m 556[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set proper cookie attributes[39m[33m 513[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should include user role information in response [33m 556[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should create refresh token on login[39m[33m 624[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke refresh token on logout [33m 461[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle logout without refresh token gracefully [33m 369[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should support multiple active refresh tokens per user [33m 515[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke all user tokens on password reset [33m 550[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should use cryptographically strong random tokens [33m 5492[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should hash refresh tokens before storing in database [33m 451[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prevent refresh token reuse after rotation [33m 660[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should validate token ownership [33m 461[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set HttpOnly flag to prevent XSS [33m 557[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set SameSite=Strict to prevent CSRF [33m 578[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set proper cookie path [33m 554[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set appropriate expiry (30 days) [33m 579[2mms[22m[39m
{"level":50,"time":1768250182732,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/:sessionId > should not allow revoking other users sessions
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250182779,"env":"test","module":"user-credentials-repository","userId":"4e60288e-26cf-4e6b-89fc-d698a5df48de","msg":"User credentials created"}
{"level":30,"time":1768250182786,"env":"test","module":"user-credentials-repository","userId":"369bc312-766e-41fb-b9ac-5a679d4848bd","msg":"User credentials created"}
{"level":30,"time":1768250182872,"env":"test","module":"email-queue","jobId":"841c0000-4388-4e25-b753-d65bd363a351","to":"protected-test-G-R0Fln02CaEFRfPk1Qob@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250182878,"env":"test","module":"email-queue","jobId":"702086b5-9de1-4c2c-a1e9-cb10244ef12f","to":"middleware-test-oEn0QlOFMqnKl7m-KJqQh@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250182920,"env":"test","module":"auth-routes","userId":"4e60288e-26cf-4e6b-89fc-d698a5df48de","email":"protected-test-G-R0Fln02CaEFRfPk1Qob@example.com","msg":"User registered"}
{"level":30,"time":1768250182932,"env":"test","module":"auth-routes","userId":"369bc312-766e-41fb-b9ac-5a679d4848bd","email":"middleware-test-oEn0QlOFMqnKl7m-KJqQh@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for POST requests (mutation-strict)
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould reject access with empty Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250183105,"env":"test","module":"user-credentials-repository","userId":"36c36988-1312-4706-84df-dc843c8f4655","msg":"User credentials created"}
{"level":50,"time":1768250183139,"env":"test","module":"auth-routes","userId":"369bc312-766e-41fb-b9ac-5a679d4848bd","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250183176,"env":"test","module":"auth-routes","userId":"4e60288e-26cf-4e6b-89fc-d698a5df48de","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250183204,"env":"test","module":"email-queue","jobId":"940fd8fd-0f1e-4028-9865-df381ac5204a","to":"session-test-S4XgvumIT2cBQ6DJ2cxaY@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768250183232,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should reject cookie auth for POST requests (mutation-strict)
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should reject cookie auth for POST requests (mutation-strict)
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:36:23.232Z'
  }
}

{"level":30,"time":1768250183251,"env":"test","module":"auth-routes","userId":"36c36988-1312-4706-84df-dc843c8f4655","email":"session-test-S4XgvumIT2cBQ6DJ2cxaY@example.com","msg":"User registered"}
{"level":50,"time":1768250183269,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with empty Bearer token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for POST requests (mutation-strict)
[22m[39mUser in DB: {
  id: [32m'369bc312-766e-41fb-b9ac-5a679d4848bd'[39m,
  email: [32m'middleware-test-oEn0QlOFMqnKl7m-KJqQh@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:36:25.688Z[39m,
  updatedAt: [35m2026-01-12T20:36:25.688Z[39m
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for POST requests (mutation-strict)
[22m[39mCreds in DB: [90mundefined[39m

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould return 404 for non-existent session ID
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250183494,"env":"test","module":"auth-routes","userId":"36c36988-1312-4706-84df-dc843c8f4655","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250183590,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/:sessionId > should return 404 for non-existent session ID
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250183638,"env":"test","module":"user-credentials-repository","userId":"91280ecf-6b89-4c2e-beff-1ee6ec1456ce","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould complete MFA login with valid TOTP code
[22m[39m[TEST UTILS] MFA Secret verified for 5a67239404b6966fc4dea7c4a95a46c5

{"level":30,"time":1768250183700,"env":"test","module":"user-credentials-repository","userId":"205e5d08-c3ef-410b-90b0-650ccc00a046","msg":"User credentials created"}
{"level":30,"time":1768250183737,"env":"test","module":"email-queue","jobId":"d5542d49-d219-40e0-a499-0f3a7e0c3524","to":"protected-test-yoUqW59wd7VvChb_DKvNN@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250183801,"env":"test","module":"auth-routes","userId":"91280ecf-6b89-4c2e-beff-1ee6ec1456ce","email":"protected-test-yoUqW59wd7VvChb_DKvNN@example.com","msg":"User registered"}
{"level":30,"time":1768250183804,"env":"test","module":"email-queue","jobId":"f3ec3b67-a839-4d41-bb7e-ee296b94fd62","to":"middleware-test-Y1gmIguFAWgICK6BwjurF@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250183857,"env":"test","module":"auth-routes","userId":"205e5d08-c3ef-410b-90b0-650ccc00a046","email":"middleware-test-Y1gmIguFAWgICK6BwjurF@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould reject access with malformed Authorization header
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for PUT requests
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould complete MFA login with valid TOTP code
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250183963,"env":"test","module":"user-credentials-repository","userId":"2c718dcc-b6f1-44c1-89c0-8adbe52b8735","msg":"User credentials created"}
{"level":30,"time":1768250184067,"env":"test","module":"email-queue","jobId":"e14b9c13-179e-4789-b9f2-89e0f7985b0c","to":"session-test-9EeaAC8o1UNUUleTrs-SQ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250184119,"env":"test","module":"auth-routes","userId":"2c718dcc-b6f1-44c1-89c0-8adbe52b8735","email":"session-test-9EeaAC8o1UNUUleTrs-SQ@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all sessions except current
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250184382,"env":"test","module":"auth-routes","userId":"205e5d08-c3ef-410b-90b0-650ccc00a046","msg":"User logged in successfully"}
{"level":30,"time":1768250184387,"env":"test","module":"auth-routes","userId":"5a67239404b6966fc4dea7c4a95a46c5","msg":"Login requires MFA verification"}
{"level":30,"time":1768250184421,"env":"test","module":"auth-routes","userId":"91280ecf-6b89-4c2e-beff-1ee6ec1456ce","msg":"User logged in successfully"}
{"level":30,"time":1768250184430,"env":"test","module":"audit-log-service","userId":"205e5d08-c3ef-410b-90b0-650ccc00a046","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250184435,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250184468,"env":"test","module":"audit-log-service","userId":"91280ecf-6b89-4c2e-beff-1ee6ec1456ce","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250184471,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250184486,"env":"test","module":"mfa-service","userId":"5a67239404b6966fc4dea7c4a95a46c5","msg":"TOTP verification successful"}
stderr | tests/integration/auth/jwt.authentication.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: relation "global_recipients" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 115,
  severity: 'ERROR',
  code: '42P01',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'namespace.c',
  line: '637',
  routine: 'RangeVarGetRelidExtended'
}

{"level":30,"time":1768250184534,"env":"test","module":"auth-routes","userId":"5a67239404b6966fc4dea7c4a95a46c5","msg":"MFA login successful"}
{"level":30,"time":1768250184686,"env":"test","module":"auth-routes","userId":"2c718dcc-b6f1-44c1-89c0-8adbe52b8735","msg":"User logged in successfully"}
{"level":30,"time":1768250184722,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768250184734,"env":"test","module":"audit-log-service","userId":"2c718dcc-b6f1-44c1-89c0-8adbe52b8735","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250184740,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests
[22m[39m[Routes] E-Signature routes registered at /api/esign

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all sessions except current
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250184730,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768250184730,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768250184735,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768250184739,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768250184739,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768250184740,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768250184740,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768250184806,"env":"test","module":"user-credentials-repository","userId":"6e509f79-4a53-4a49-a0eb-a939ecb65521","msg":"User credentials created"}
{"level":30,"time":1768250184844,"env":"test","module":"user-credentials-repository","userId":"066061e1-1e5b-411a-b9fa-4baa2962d134","msg":"User credentials created"}
{"level":30,"time":1768250184898,"env":"test","module":"email-queue","jobId":"809a2767-75f4-434c-bb19-b7f4d4734d40","to":"middleware-test-qsu-aBiDCBzJ-A7CS2n-G@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250184944,"env":"test","module":"email-queue","jobId":"1166863c-266a-4630-8da1-501614acea6e","to":"protected-test-K_pb3ym2poL4q9U-M6C9R@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250184949,"env":"test","module":"auth-routes","userId":"6e509f79-4a53-4a49-a0eb-a939ecb65521","email":"middleware-test-qsu-aBiDCBzJ-A7CS2n-G@example.com","msg":"User registered"}
{"level":30,"time":1768250184998,"env":"test","module":"auth-routes","userId":"066061e1-1e5b-411a-b9fa-4baa2962d134","email":"protected-test-K_pb3ym2poL4q9U-M6C9R@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for DELETE requests
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould reject access with wrong token type
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250185150,"env":"test","module":"auth-routes","userId":"6e509f79-4a53-4a49-a0eb-a939ecb65521","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250185201,"env":"test","module":"auth-routes","userId":"2c718dcc-b6f1-44c1-89c0-8adbe52b8735","msg":"User logged in successfully"}
{"level":30,"time":1768250185202,"env":"test","module":"user-credentials-repository","userId":"8113481c-e32e-44d5-aa20-c17b6d692283","msg":"User credentials created"}
{"level":50,"time":1768250185242,"env":"test","module":"auth-routes","userId":"066061e1-1e5b-411a-b9fa-4baa2962d134","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250185249,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should reject cookie auth for DELETE requests
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should reject cookie auth for DELETE requests
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:36:25.249Z'
  }
}

{"level":30,"time":1768250185255,"env":"test","module":"audit-log-service","userId":"2c718dcc-b6f1-44c1-89c0-8adbe52b8735","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all sessions except current
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for DELETE requests
[22m[39mUser in DB: {
  id: [32m'6e509f79-4a53-4a49-a0eb-a939ecb65521'[39m,
  email: [32m'middleware-test-qsu-aBiDCBzJ-A7CS2n-G@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:36:27.711Z[39m,
  updatedAt: [35m2026-01-12T20:36:27.711Z[39m
}

{"level":30,"time":1768250185304,"env":"test","module":"email-queue","jobId":"bdfd63ab-7b0e-43e4-9460-9e3e464f9b4d","to":"test-PIEvfcjfyqIAcKcVuqwNa@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768250185337,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with wrong token type
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for DELETE requests
[22m[39mCreds in DB: [90mundefined[39m

{"level":30,"time":1768250185356,"env":"test","module":"auth-routes","userId":"8113481c-e32e-44d5-aa20-c17b6d692283","email":"test-PIEvfcjfyqIAcKcVuqwNa@example.com","msg":"User registered"}
{"level":50,"time":1768250185406,"env":"test","module":"auth-routes","userId":"2c718dcc-b6f1-44c1-89c0-8adbe52b8735","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250185510,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/all > should revoke all sessions except current
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250185702,"env":"test","module":"user-credentials-repository","userId":"c7c6a59b-4144-4d4c-94e9-d1828b930268","msg":"User credentials created"}
{"level":30,"time":1768250185719,"env":"test","module":"user-credentials-repository","userId":"f3d99d36-59d4-43ef-bec0-dcfa49fb97c8","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould reject invalid MFA code
[22m[39m[TEST UTILS] MFA Secret verified for ac17dbf6314dddc4492b5c08f17309b5

{"level":30,"time":1768250185800,"env":"test","module":"email-queue","jobId":"f9ae2032-6fb8-4c6a-befb-0ee4a9839915","to":"protected-test-NWutzsxj4JJLB9wTGWVIe@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250185817,"env":"test","module":"email-queue","jobId":"7a2c2711-9fba-4036-9f00-4d80fd17207c","to":"middleware-test-biSR149jZyycw2dmWnzFZ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250185850,"env":"test","module":"auth-routes","userId":"c7c6a59b-4144-4d4c-94e9-d1828b930268","email":"protected-test-NWutzsxj4JJLB9wTGWVIe@example.com","msg":"User registered"}
{"level":30,"time":1768250185864,"env":"test","module":"auth-routes","userId":"f3d99d36-59d4-43ef-bec0-dcfa49fb97c8","email":"middleware-test-biSR149jZyycw2dmWnzFZ@example.com","msg":"User registered"}
{"level":30,"time":1768250185880,"env":"test","module":"user-credentials-repository","userId":"f3d8508c-e9d2-4ad1-a2f5-bd11bd69202a","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould allow cookie auth for HEAD requests
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPOST Protected Routes[2m > [22m[2mshould allow POST with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250185976,"env":"test","module":"email-queue","jobId":"a5559e51-e733-4146-a8ae-97b6c39ba835","to":"session-test-lmtzsYPrnZwzyN0Wesvf4@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250186015,"env":"test","module":"user-credentials-repository","userId":"2e0b8163-4702-4c4a-a16b-7b1765dfe858","msg":"User credentials created"}
{"level":30,"time":1768250186031,"env":"test","module":"auth-routes","userId":"f3d8508c-e9d2-4ad1-a2f5-bd11bd69202a","email":"session-test-lmtzsYPrnZwzyN0Wesvf4@example.com","msg":"User registered"}
{"level":30,"time":1768250186115,"env":"test","module":"email-queue","jobId":"970e58f7-4bac-454d-a51c-68d0cedb4b6f","to":"jwt-test-FOTaS8X-9tOSKUth9c7ui@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all trusted devices
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768250186160,"env":"test","module":"mfa-service","userId":"ac17dbf6314dddc4492b5c08f17309b5","msg":"TOTP verification failed"}
{"level":40,"time":1768250186160,"env":"test","module":"auth-routes","userId":"ac17dbf6314dddc4492b5c08f17309b5","msg":"MFA verification failed during login"}
{"level":30,"time":1768250186167,"env":"test","module":"auth-routes","userId":"2e0b8163-4702-4c4a-a16b-7b1765dfe858","email":"jwt-test-FOTaS8X-9tOSKUth9c7ui@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mJWT Token Generation[2m > [22m[2mshould generate valid JWT token on successful login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250186369,"env":"test","module":"auth-routes","userId":"f3d99d36-59d4-43ef-bec0-dcfa49fb97c8","msg":"User logged in successfully"}
{"level":30,"time":1768250186417,"env":"test","module":"audit-log-service","userId":"f3d99d36-59d4-43ef-bec0-dcfa49fb97c8","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250186457,"env":"test","module":"auth-routes","userId":"c7c6a59b-4144-4d4c-94e9-d1828b930268","msg":"User logged in successfully"}
{"level":40,"time":1768250186469,"env":"test","module":"auth-middleware","msg":"Cookie strategy: Invalid refresh token"}
{"level":50,"time":1768250186469,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250186504,"env":"test","module":"audit-log-service","userId":"c7c6a59b-4144-4d4c-94e9-d1828b930268","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250186529,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250186530,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768250186585,"env":"test","module":"auth-routes","userId":"f3d8508c-e9d2-4ad1-a2f5-bd11bd69202a","msg":"User logged in successfully"}
{"level":30,"time":1768250186640,"env":"test","module":"audit-log-service","userId":"f3d8508c-e9d2-4ad1-a2f5-bd11bd69202a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250186772,"env":"test","module":"auth-routes","userId":"2e0b8163-4702-4c4a-a16b-7b1765dfe858","msg":"User logged in successfully"}
{"level":30,"time":1768250186814,"env":"test","module":"auth-routes","userId":"f3d8508c-e9d2-4ad1-a2f5-bd11bd69202a","deviceFingerprint":"377ad01217b8c93ca52518d515505c47ab7553fab66d6fddaa60af67802c5a4c","msg":"Device marked as trusted"}
{"level":30,"time":1768250186827,"env":"test","module":"audit-log-service","userId":"2e0b8163-4702-4c4a-a16b-7b1765dfe858","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w1_f42eed12

{"level":30,"time":1768250186859,"env":"test","module":"user-credentials-repository","userId":"cd4f86e2-f723-4b9d-a236-916dc7c6663e","msg":"User credentials created"}
 [31mÎ“Â¥Â»[39m tests/integration/auth.routes.real.test.ts [2m([22m[2m26 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 66162[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should register a new user successfully [33m 1361[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 400 for invalid email format [33m 762[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 400 for weak password [33m 758[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 409 for duplicate email [33m 1321[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set httpOnly refresh token cookie [33m 1258[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should login with valid credentials [33m 1627[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for invalid password [33m 1620[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for non-existent user [33m 946[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 403 for unverified email [33m 1670[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should record failed login attempt [33m 1427[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return requiresMfa=true for MFA-enabled users [33m 1950[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should lock account after 5 failed attempts[39m[33m 3273[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should logout and clear refresh token cookie [33m 1721[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should refresh access token with valid refresh token [33m 1848[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for missing refresh token [33m 758[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should rotate refresh token after use [33m 1969[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should send password reset email for existing user [33m 1596[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not reveal if email exists (security) [33m 824[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reset password with valid token [33m 2819[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 400 for invalid token [33m 811[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 400 for weak new password [33m 1444[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return current user for valid token [33m 1773[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for missing token [33m 777[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for invalid token [33m 760[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should complete MFA login with valid TOTP code [33m 2128[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should reject invalid MFA code [33m 1597[2mms[22m[39m
{"level":30,"time":1768250186932,"env":"test","module":"user-credentials-repository","userId":"508789dc-6c8e-4407-b684-868211c485fe","msg":"User credentials created"}
{"level":30,"time":1768250186950,"env":"test","module":"email-queue","jobId":"56c2cf56-1839-4563-bf11-8cb16dc86aa9","to":"middleware-test-tFIsyqZX8eABRrna_hwDz@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250186956,"env":"test","module":"auth-routes","userId":"f3d8508c-e9d2-4ad1-a2f5-bd11bd69202a","msg":"All other sessions revoked"}
{"level":30,"time":1768250186998,"env":"test","module":"auth-routes","userId":"cd4f86e2-f723-4b9d-a236-916dc7c6663e","email":"middleware-test-tFIsyqZX8eABRrna_hwDz@example.com","msg":"User registered"}
{"level":30,"time":1768250187010,"env":"test","module":"audit-log-service","userId":"f3d8508c-e9d2-4ad1-a2f5-bd11bd69202a","eventType":"all_sessions_revoked","ipAddress":"::1","hasMetadata":false,"msg":"Security event logged"}
{"level":30,"time":1768250187032,"env":"test","module":"email-queue","jobId":"d7eeb691-3f44-4e0e-a03e-8fce273a6020","to":"protected-test-KOZXK2Ly2cA8y2wSubCHj@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould prioritize JWT over cookie when both present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250187081,"env":"test","module":"auth-routes","userId":"508789dc-6c8e-4407-b684-868211c485fe","email":"protected-test-KOZXK2Ly2cA8y2wSubCHj@example.com","msg":"User registered"}
{"level":30,"time":1768250187110,"env":"test","module":"auth-routes","userId":"f3d8508c-e9d2-4ad1-a2f5-bd11bd69202a","deviceCount":0,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPOST Protected Routes[2m > [22m[2mshould reject POST without Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250187196,"env":"test","module":"user-credentials-repository","userId":"5212da73-66fd-4ac1-bdad-13fa69cad5b5","msg":"User credentials created"}
{"level":30,"time":1768250187300,"env":"test","module":"email-queue","jobId":"ae0c2621-7a8a-45fa-b225-7a02c6c3f85a","to":"jwt-test-GlLqfCOsczq7zvbuS6l8e@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250187347,"env":"test","module":"auth-routes","userId":"5212da73-66fd-4ac1-bdad-13fa69cad5b5","email":"jwt-test-GlLqfCOsczq7zvbuS6l8e@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mJWT Token Generation[2m > [22m[2mshould include correct payload in JWT token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250187482,"env":"test","module":"user-credentials-repository","userId":"c96dd890-bce2-4244-a48c-399666573c6e","msg":"User credentials created"}
{"level":30,"time":1768250187502,"env":"test","module":"auth-routes","userId":"cd4f86e2-f723-4b9d-a236-916dc7c6663e","msg":"User logged in successfully"}
{"level":30,"time":1768250187548,"env":"test","module":"audit-log-service","userId":"cd4f86e2-f723-4b9d-a236-916dc7c6663e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250187582,"env":"test","module":"email-queue","jobId":"4e91d151-ee1b-4dde-849c-6e62b08ee927","to":"session-test-RNoq7ySnPTo_t8hXRXrdV@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250187633,"env":"test","module":"auth-routes","userId":"c96dd890-bce2-4244-a48c-399666573c6e","email":"session-test-RNoq7ySnPTo_t8hXRXrdV@example.com","msg":"User registered"}
{"level":30,"time":1768250187688,"env":"test","module":"auth-routes","userId":"508789dc-6c8e-4407-b684-868211c485fe","msg":"User logged in successfully"}
{"level":50,"time":1768250187729,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250187739,"env":"test","module":"audit-log-service","userId":"508789dc-6c8e-4407-b684-868211c485fe","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250187744,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250187853,"env":"test","module":"auth-routes","userId":"5212da73-66fd-4ac1-bdad-13fa69cad5b5","msg":"User logged in successfully"}
{"level":30,"time":1768250187901,"env":"test","module":"audit-log-service","userId":"5212da73-66fd-4ac1-bdad-13fa69cad5b5","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250187907,"env":"test","module":"user-credentials-repository","userId":"2c4c4333-a74a-4789-a7ba-4a3ce76bc193","msg":"User credentials created"}
{"level":30,"time":1768250188001,"env":"test","module":"email-queue","jobId":"2cc52b8f-d71d-487f-8f70-10a22f773231","to":"user2-TWoLQvf4JaJKcCeWuvZMD@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250188059,"env":"test","module":"auth-routes","userId":"2c4c4333-a74a-4789-a7ba-4a3ce76bc193","email":"user2-TWoLQvf4JaJKcCeWuvZMD@example.com","msg":"User registered"}
{"level":30,"time":1768250188101,"env":"test","module":"user-credentials-repository","userId":"6c57f447-46b6-408d-8475-261f039ff0f3","msg":"User credentials created"}
{"level":30,"time":1768250188116,"env":"test","module":"user-credentials-repository","userId":"7f45fd94-c430-4059-83f6-0029bccb5164","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould prioritize JWT over cookie when both present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250188194,"env":"test","module":"email-queue","jobId":"3745395c-37ee-435a-9121-8bb3d19d6921","to":"session-test-3TWs97I49AkNwXH5MFrnH@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250188217,"env":"test","module":"email-queue","jobId":"0189b65d-685c-44d4-885a-94d57a6426bd","to":"protected-test-fYk-bWC9Crg79LrgPmpfv@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250188241,"env":"test","module":"auth-routes","userId":"6c57f447-46b6-408d-8475-261f039ff0f3","email":"session-test-3TWs97I49AkNwXH5MFrnH@example.com","msg":"User registered"}
{"level":30,"time":1768250188264,"env":"test","module":"auth-routes","userId":"7f45fd94-c430-4059-83f6-0029bccb5164","email":"protected-test-fYk-bWC9Crg79LrgPmpfv@example.com","msg":"User registered"}
{"level":30,"time":1768250188271,"env":"test","module":"user-credentials-repository","userId":"b103719a-bd63-4af5-948f-78a2ad478f8d","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Expiration[2m > [22m[2mshould reject refresh token after 30 days
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250188370,"env":"test","module":"email-queue","jobId":"25a7a267-eab1-475d-b67e-b0889907be03","to":"jwt-test-Z13Ob83jSsBL35_Pcf7p0@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPOST Protected Routes[2m > [22m[2mshould reject POST with invalid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250188418,"env":"test","module":"auth-routes","userId":"b103719a-bd63-4af5-948f-78a2ad478f8d","email":"jwt-test-Z13Ob83jSsBL35_Pcf7p0@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mJWT Token Generation[2m > [22m[2mshould set JWT expiry to 15 minutes
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250188579,"env":"test","module":"auth-routes","userId":"2c4c4333-a74a-4789-a7ba-4a3ce76bc193","msg":"User logged in successfully"}
{"level":30,"time":1768250188626,"env":"test","module":"audit-log-service","userId":"2c4c4333-a74a-4789-a7ba-4a3ce76bc193","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250188801,"env":"test","module":"auth-routes","userId":"6c57f447-46b6-408d-8475-261f039ff0f3","msg":"User logged in successfully"}
{"level":30,"time":1768250188849,"env":"test","module":"audit-log-service","userId":"6c57f447-46b6-408d-8475-261f039ff0f3","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250188886,"env":"test","module":"auth-routes","userId":"7f45fd94-c430-4059-83f6-0029bccb5164","msg":"User logged in successfully"}
{"level":30,"time":1768250188927,"env":"test","module":"auth-routes","userId":"b103719a-bd63-4af5-948f-78a2ad478f8d","msg":"User logged in successfully"}
{"level":30,"time":1768250188934,"env":"test","module":"audit-log-service","userId":"7f45fd94-c430-4059-83f6-0029bccb5164","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250188937,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250188949,"env":"test","module":"auth-service","tokenHash":"679ad841a635e9b0ead3b961e2dfa3c12b8c352525251085c081dc8d0dec88aa","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250188974,"env":"test","module":"audit-log-service","userId":"b103719a-bd63-4af5-948f-78a2ad478f8d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768250189000,"env":"test","module":"auth-service","userId":"6c57f447-46b6-408d-8475-261f039ff0f3","msg":"Security: Expired refresh token used"}
{"level":30,"time":1768250189089,"env":"test","module":"user-credentials-repository","userId":"ac176d70-d370-40c5-a5c9-d6bed8b566c7","msg":"User credentials created"}
{"level":30,"time":1768250189207,"env":"test","module":"email-queue","jobId":"becef810-701a-4140-8fcd-6dfc00a19f02","to":"middleware-test-twZcdMngAr2bXUcTwCvjT@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250189254,"env":"test","module":"auth-routes","userId":"ac176d70-d370-40c5-a5c9-d6bed8b566c7","email":"middleware-test-twZcdMngAr2bXUcTwCvjT@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould return 401 when no auth provided
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250189315,"env":"test","module":"user-credentials-repository","userId":"b39f68bd-5ba2-4c45-b0c9-53ce523a6989","msg":"User credentials created"}
{"level":30,"time":1768250189341,"env":"test","module":"user-credentials-repository","userId":"89bcfb7b-4910-4f3a-9b73-184110adbecc","msg":"User credentials created"}
{"level":30,"time":1768250189372,"env":"test","module":"user-credentials-repository","userId":"c64732b4-e4f9-4370-8ea2-9a8645ba0c9f","msg":"User credentials created"}
{"level":30,"time":1768250189411,"env":"test","module":"email-queue","jobId":"0b338e4c-f1b4-4273-80a4-4a87fdf22fa2","to":"protected-test-guF-wAmvgn9QswKtC2IeE@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250189441,"env":"test","module":"email-queue","jobId":"cfc11973-6146-4220-9ce9-b17744c640da","to":"jwt-test-95u83ch9d6sArG87Df8r7@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250189460,"env":"test","module":"auth-routes","userId":"b39f68bd-5ba2-4c45-b0c9-53ce523a6989","email":"protected-test-guF-wAmvgn9QswKtC2IeE@example.com","msg":"User registered"}
{"level":30,"time":1768250189476,"env":"test","module":"email-queue","jobId":"4f1c1cc4-f1f0-499c-8524-1817c6a0fa0a","to":"session-test-621gmjIjLPB4a7WQK9bwE@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250189489,"env":"test","module":"auth-routes","userId":"89bcfb7b-4910-4f3a-9b73-184110adbecc","email":"jwt-test-95u83ch9d6sArG87Df8r7@example.com","msg":"User registered"}
{"level":30,"time":1768250189523,"env":"test","module":"auth-routes","userId":"c64732b4-e4f9-4370-8ea2-9a8645ba0c9f","email":"session-test-621gmjIjLPB4a7WQK9bwE@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mJWT Token Validation[2m > [22m[2mshould accept valid JWT token on protected routes
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPUT Protected Routes[2m > [22m[2mshould allow PUT with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mConcurrent Session Handling[2m > [22m[2mshould handle multiple concurrent logins
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mConcurrent Session Handling[2m > [22m[2mshould handle multiple concurrent logins
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mConcurrent Session Handling[2m > [22m[2mshould handle multiple concurrent logins
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250189773,"env":"test","module":"auth-routes","userId":"ac176d70-d370-40c5-a5c9-d6bed8b566c7","msg":"User logged in successfully"}
{"level":30,"time":1768250189826,"env":"test","module":"audit-log-service","userId":"ac176d70-d370-40c5-a5c9-d6bed8b566c7","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250189830,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250190003,"env":"test","module":"auth-routes","userId":"89bcfb7b-4910-4f3a-9b73-184110adbecc","msg":"User logged in successfully"}
{"level":30,"time":1768250190054,"env":"test","module":"audit-log-service","userId":"89bcfb7b-4910-4f3a-9b73-184110adbecc","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250190071,"env":"test","module":"auth-routes","userId":"b39f68bd-5ba2-4c45-b0c9-53ce523a6989","msg":"User logged in successfully"}
{"level":30,"time":1768250190078,"env":"test","module":"auth-routes","userId":"c64732b4-e4f9-4370-8ea2-9a8645ba0c9f","msg":"User logged in successfully"}
{"level":30,"time":1768250190118,"env":"test","module":"audit-log-service","userId":"b39f68bd-5ba2-4c45-b0c9-53ce523a6989","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250190126,"env":"test","module":"audit-log-service","userId":"c64732b4-e4f9-4370-8ea2-9a8645ba0c9f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250190160,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768250190164,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250190202,"env":"test","module":"user-credentials-repository","userId":"84fa3070-b5ef-4d8a-a83b-a6e2ca090a4b","msg":"User credentials created"}
{"level":30,"time":1768250190302,"env":"test","module":"email-queue","jobId":"5231dafc-920d-4ba1-b064-d4f2e8019347","to":"middleware-test-wokLSlebhkst7QLtSOI3Q@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250190349,"env":"test","module":"auth-routes","userId":"84fa3070-b5ef-4d8a-a83b-a6e2ca090a4b","email":"middleware-test-wokLSlebhkst7QLtSOI3Q@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould return 401 when both JWT and cookie are invalid
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250190414,"env":"test","module":"auth-routes","userId":"c64732b4-e4f9-4370-8ea2-9a8645ba0c9f","msg":"User logged in successfully"}
{"level":30,"time":1768250190422,"env":"test","module":"auth-routes","userId":"c64732b4-e4f9-4370-8ea2-9a8645ba0c9f","msg":"User logged in successfully"}
{"level":30,"time":1768250190460,"env":"test","module":"audit-log-service","userId":"c64732b4-e4f9-4370-8ea2-9a8645ba0c9f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250190470,"env":"test","module":"audit-log-service","userId":"c64732b4-e4f9-4370-8ea2-9a8645ba0c9f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250190540,"env":"test","module":"user-credentials-repository","userId":"ec9f3c4d-aba3-4bd4-81e2-110898daf7e7","msg":"User credentials created"}
{"level":30,"time":1768250190641,"env":"test","module":"email-queue","jobId":"d9143033-4b42-41e1-9550-c23a58fe54e9","to":"jwt-test-dQyYVbj2dACGFp6VLnK-h@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250190649,"env":"test","module":"user-credentials-repository","userId":"279c8862-9f61-4c64-a950-3a5b86023a48","msg":"User credentials created"}
{"level":30,"time":1768250190690,"env":"test","module":"auth-routes","userId":"ec9f3c4d-aba3-4bd4-81e2-110898daf7e7","email":"jwt-test-dQyYVbj2dACGFp6VLnK-h@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mJWT Token Validation[2m > [22m[2mshould accept request with missing Bearer prefix (lenient)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250190744,"env":"test","module":"email-queue","jobId":"6869ec2a-132b-49fc-9e1e-57ab59cec5eb","to":"protected-test-81AzuyojSoLyyq8gKCRKQ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250190797,"env":"test","module":"auth-routes","userId":"279c8862-9f61-4c64-a950-3a5b86023a48","email":"protected-test-81AzuyojSoLyyq8gKCRKQ@example.com","msg":"User registered"}
{"level":30,"time":1768250190868,"env":"test","module":"auth-routes","userId":"84fa3070-b5ef-4d8a-a83b-a6e2ca090a4b","msg":"User logged in successfully"}
{"level":30,"time":1768250190903,"env":"test","module":"user-credentials-repository","userId":"9134a6e7-4eb9-4cd8-98d6-e1ff7c6aecaa","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPUT Protected Routes[2m > [22m[2mshould reject PUT without Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250190922,"env":"test","module":"audit-log-service","userId":"84fa3070-b5ef-4d8a-a83b-a6e2ca090a4b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250190926,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250191001,"env":"test","module":"email-queue","jobId":"2e3f6d38-826d-4569-8031-9fc652746a46","to":"session-test-nhmgvsGzOCHKY6eGyvW-g@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250191050,"env":"test","module":"auth-routes","userId":"9134a6e7-4eb9-4cd8-98d6-e1ff7c6aecaa","email":"session-test-nhmgvsGzOCHKY6eGyvW-g@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mConcurrent Session Handling[2m > [22m[2mshould handle concurrent token refreshes
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250191219,"env":"test","module":"auth-routes","userId":"ec9f3c4d-aba3-4bd4-81e2-110898daf7e7","msg":"User logged in successfully"}
{"level":30,"time":1768250191268,"env":"test","module":"audit-log-service","userId":"ec9f3c4d-aba3-4bd4-81e2-110898daf7e7","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250191295,"env":"test","module":"user-credentials-repository","userId":"1467d2a9-6ff0-4687-9bde-67ba166e8d8e","msg":"User credentials created"}
{"level":40,"time":1768250191372,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768250191372,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250191397,"env":"test","module":"email-queue","jobId":"fab2606a-381d-4199-adc1-461dd41501e9","to":"middleware-test-h9Y3xj9rsfWkDn1eRhvMc@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250191420,"env":"test","module":"auth-routes","userId":"279c8862-9f61-4c64-a950-3a5b86023a48","msg":"User logged in successfully"}
{"level":30,"time":1768250191444,"env":"test","module":"auth-routes","userId":"1467d2a9-6ff0-4687-9bde-67ba166e8d8e","email":"middleware-test-h9Y3xj9rsfWkDn1eRhvMc@example.com","msg":"User registered"}
{"level":30,"time":1768250191469,"env":"test","module":"audit-log-service","userId":"279c8862-9f61-4c64-a950-3a5b86023a48","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250191474,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould authenticate with JWT if provided
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250191618,"env":"test","module":"auth-routes","userId":"9134a6e7-4eb9-4cd8-98d6-e1ff7c6aecaa","msg":"User logged in successfully"}
{"level":30,"time":1768250191667,"env":"test","module":"audit-log-service","userId":"9134a6e7-4eb9-4cd8-98d6-e1ff7c6aecaa","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250191669,"env":"test","module":"auth-service","tokenHash":"62b155d52ae18e4042e7454d5a087eaca20f93a929def7fccc1e4529b2f10f30","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250191838,"env":"test","module":"user-credentials-repository","userId":"399a3fc0-c00e-48fa-9409-f94051552fb6","msg":"User credentials created"}
{"level":30,"time":1768250191874,"env":"test","module":"auth-service","tokenHash":"62b155d52ae18e4042e7454d5a087eaca20f93a929def7fccc1e4529b2f10f30","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250191922,"env":"test","module":"auth-service","userId":"9134a6e7-4eb9-4cd8-98d6-e1ff7c6aecaa","tokenHash":"62b155d52ae18e4042e7454d5a087eaca20f93a929def7fccc1e4529b2f10f30","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768250191936,"env":"test","module":"email-queue","jobId":"f88e6281-1b04-4831-9145-caf6106c218a","to":"protected-test-YxbgFzqbfRZvsB_lH1Ptr@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250191946,"env":"test","module":"auth-routes","userId":"1467d2a9-6ff0-4687-9bde-67ba166e8d8e","msg":"User logged in successfully"}
{"level":30,"time":1768250191978,"env":"test","module":"auth-service","tokenHash":"2002e079689c63aad9a92e34a416a943fcc45208a16822f1f9938bcceff494e9","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250191982,"env":"test","module":"auth-routes","userId":"399a3fc0-c00e-48fa-9409-f94051552fb6","email":"protected-test-YxbgFzqbfRZvsB_lH1Ptr@example.com","msg":"User registered"}
{"level":30,"time":1768250191998,"env":"test","module":"audit-log-service","userId":"1467d2a9-6ff0-4687-9bde-67ba166e8d8e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768250192068,"env":"test","module":"auth-service","userId":"9134a6e7-4eb9-4cd8-98d6-e1ff7c6aecaa","tokenHash":"2002e079689c63aad9a92e34a416a943fcc45208a16822f1f9938bcceff494e9","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mDELETE Protected Routes[2m > [22m[2mshould allow DELETE with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250192382,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250192382,"env":"test","msg":"DB: pool closed."}
{"level":40,"time":1768250192477,"env":"test","module":"auth-middleware","error":{"name":"TokenExpiredError","code":"AUTH_002","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768250192477,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250192564,"env":"test","module":"intake-service","runId":"7d249dd2-e45e-44c6-9756-63d844227954","slug":"hybrid-jwt-2I_9R08MjpO85LI5I_vsd","userId":"1467d2a9-6ff0-4687-9bde-67ba166e8d8e","msg":"Created intake run"}
{"level":30,"time":1768250192593,"env":"test","module":"auth-routes","userId":"399a3fc0-c00e-48fa-9409-f94051552fb6","msg":"User logged in successfully"}
{"level":30,"time":1768250192643,"env":"test","module":"audit-log-service","userId":"399a3fc0-c00e-48fa-9409-f94051552fb6","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w2_c7d2f708

 [31mÎ“Â¥Â»[39m tests/integration/auth/session.management.integration.test.ts [2m([22m[2m18 tests[22m[2m | [22m[31m10 failed[39m[2m)[22m[33m 67347[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should create refresh token on login[39m[33m 905[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should track device metadata in session [33m 1199[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should create separate sessions for multiple device logins[39m[33m 868[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all active sessions for user[39m[33m 1369[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should mark current session correctly[39m[33m 887[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not include revoked sessions [33m 2021[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should order sessions by last used (most recent first)[39m[33m 878[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 614[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific session[39m[33m 1734[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent revoking current session[39m[33m 1346[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should not allow revoking other users sessions[39m[33m 1480[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 404 for non-existent session ID[39m[33m 857[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke all sessions except current[39m[33m 1920[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke all trusted devices [33m 1599[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require active session [33m 620[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject refresh token after 30 days [33m 1271[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle multiple concurrent logins [33m 1522[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle concurrent token refreshes [33m 1597[2mms[22m[39m
{"level":30,"time":1768250192932,"env":"test","module":"user-credentials-repository","userId":"5ec438cd-ef6c-434c-8009-760517430e5c","msg":"User credentials created"}
{"level":30,"time":1768250193031,"env":"test","module":"email-queue","jobId":"d3e994d6-87a6-4e28-a223-b722888a2c7b","to":"middleware-test-84wRnA3LwOhOM5SltQHwR@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250193080,"env":"test","module":"auth-routes","userId":"5ec438cd-ef6c-434c-8009-760517430e5c","email":"middleware-test-84wRnA3LwOhOM5SltQHwR@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould authenticate with cookie if JWT not provided
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250193177,"env":"test","module":"user-credentials-repository","userId":"f9d9479e-c7be-4b38-866c-4644f671b53e","msg":"User credentials created"}
{"level":30,"time":1768250193274,"env":"test","module":"email-queue","jobId":"e536cb51-6bec-4ca6-8e44-eff645849fb0","to":"protected-test-cw3yxoMerjEnurtHSP_HU@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250193321,"env":"test","module":"auth-routes","userId":"f9d9479e-c7be-4b38-866c-4644f671b53e","email":"protected-test-cw3yxoMerjEnurtHSP_HU@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mDELETE Protected Routes[2m > [22m[2mshould reject DELETE without Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768250193581,"env":"test","module":"auth-middleware","error":{"name":"TokenExpiredError","code":"AUTH_002","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768250193582,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250193597,"env":"test","module":"auth-routes","userId":"5ec438cd-ef6c-434c-8009-760517430e5c","msg":"User logged in successfully"}
{"level":30,"time":1768250193646,"env":"test","module":"audit-log-service","userId":"5ec438cd-ef6c-434c-8009-760517430e5c","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250193946,"env":"test","module":"auth-routes","userId":"f9d9479e-c7be-4b38-866c-4644f671b53e","msg":"User logged in successfully"}
{"level":30,"time":1768250193997,"env":"test","module":"audit-log-service","userId":"f9d9479e-c7be-4b38-866c-4644f671b53e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250194002,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250194145,"env":"test","module":"intake-service","runId":"ee04e842-0a9d-4c7a-b06f-0367d77be02b","slug":"hybrid-cookie-yry0sitzXCw9HMokfUn-i","msg":"Created intake run"}
{"level":30,"time":1768250194370,"env":"test","module":"user-credentials-repository","userId":"1f98ea95-5491-4abf-bfd6-265e8ea58bda","msg":"User credentials created"}
{"level":30,"time":1768250194468,"env":"test","module":"email-queue","jobId":"592edcc9-ae93-4b47-9545-c4b4ddf3d68c","to":"protected-test-ViG5LKII4TdSgTW2ae6TW@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250194518,"env":"test","module":"auth-routes","userId":"1f98ea95-5491-4abf-bfd6-265e8ea58bda","email":"protected-test-ViG5LKII4TdSgTW2ae6TW@example.com","msg":"User registered"}
{"level":30,"time":1768250194522,"env":"test","module":"user-credentials-repository","userId":"da8d48af-748e-41f1-9b37-f2fa843589f4","msg":"User credentials created"}
{"level":30,"time":1768250194527,"env":"test","module":"user-credentials-repository","userId":"0d313382-0fb4-46f2-8739-4a90868e4478","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPATCH Protected Routes[2m > [22m[2mshould allow PATCH with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250194620,"env":"test","module":"email-queue","jobId":"51a4d7b8-8520-423a-b587-c26ef6e75208","to":"jwt-test-Zr6_ucWYAS2W7BuuqmJOV@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250194626,"env":"test","module":"email-queue","jobId":"6ba9058e-f794-4cc4-a599-03a038f6ed1f","to":"middleware-test-OYw5D7w4LAXtuAsq-E3DK@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250194671,"env":"test","module":"auth-routes","userId":"da8d48af-748e-41f1-9b37-f2fa843589f4","email":"jwt-test-Zr6_ucWYAS2W7BuuqmJOV@example.com","msg":"User registered"}
{"level":30,"time":1768250194676,"env":"test","module":"auth-routes","userId":"0d313382-0fb4-46f2-8739-4a90868e4478","email":"middleware-test-OYw5D7w4LAXtuAsq-E3DK@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould proceed anonymously if no auth provided
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250194820,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250195123,"env":"test","module":"auth-routes","userId":"1f98ea95-5491-4abf-bfd6-265e8ea58bda","msg":"User logged in successfully"}
{"level":30,"time":1768250195170,"env":"test","module":"audit-log-service","userId":"1f98ea95-5491-4abf-bfd6-265e8ea58bda","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250195192,"env":"test","module":"auth-routes","userId":"0d313382-0fb4-46f2-8739-4a90868e4478","msg":"User logged in successfully"}
{"level":30,"time":1768250195197,"env":"test","module":"user-credentials-repository","userId":"0a9a054d-8c90-41e2-ab6a-ec9998a8a510","msg":"User credentials created"}
{"level":30,"time":1768250195241,"env":"test","module":"audit-log-service","userId":"0d313382-0fb4-46f2-8739-4a90868e4478","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250195293,"env":"test","module":"email-queue","jobId":"fc7f941b-9b3c-4d64-8f93-a14f794d259e","to":"user1-Hdcyamc8P-NUGWIt7nhZP@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250195347,"env":"test","module":"auth-routes","userId":"0a9a054d-8c90-41e2-ab6a-ec9998a8a510","email":"user1-Hdcyamc8P-NUGWIt7nhZP@example.com","msg":"User registered"}
{"level":30,"time":1768250195713,"env":"test","module":"user-credentials-repository","userId":"544a80e6-2a55-42aa-9258-80cad67c7b2d","msg":"User credentials created"}
{"level":30,"time":1768250195744,"env":"test","module":"intake-service","runId":"4d07597e-3483-462c-b984-4c3c78061697","slug":"hybrid-anon-PPJ_A84AxYBVxwD9BqGPJ","msg":"Created intake run"}
{"level":30,"time":1768250195808,"env":"test","module":"email-queue","jobId":"d1d8df7d-594c-46bd-998c-eb32959057a4","to":"user2-FwRzkz5jr9hdCWYwvd7og@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250195855,"env":"test","module":"auth-routes","userId":"544a80e6-2a55-42aa-9258-80cad67c7b2d","email":"user2-FwRzkz5jr9hdCWYwvd7og@example.com","msg":"User registered"}
{"level":30,"time":1768250196113,"env":"test","module":"user-credentials-repository","userId":"ff267f09-b8ee-439c-adb0-9fca1959ecc1","msg":"User credentials created"}
{"level":30,"time":1768250196197,"env":"test","module":"user-credentials-repository","userId":"94103adb-5471-4dcd-af36-d1168a066737","msg":"User credentials created"}
{"level":30,"time":1768250196217,"env":"test","module":"email-queue","jobId":"0aa2b87b-0ad2-45dc-8810-d09e3d814cce","to":"middleware-test-egKjPS9HssTFBD63-PVy4@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250196264,"env":"test","module":"auth-routes","userId":"ff267f09-b8ee-439c-adb0-9fca1959ecc1","email":"middleware-test-egKjPS9HssTFBD63-PVy4@example.com","msg":"User registered"}
{"level":30,"time":1768250196292,"env":"test","module":"email-queue","jobId":"0fade848-2845-467f-91df-7511a8ba74c1","to":"protected-test-JBS1dJHn9A8UJ-JQS-1_m@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould proceed anonymously if both JWT and cookie are invalid
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250196329,"env":"test","module":"user-credentials-repository","userId":"b81b37b1-9d9e-4509-9cab-e963ec9cd77a","msg":"User credentials created"}
{"level":30,"time":1768250196339,"env":"test","module":"auth-routes","userId":"94103adb-5471-4dcd-af36-d1168a066737","email":"protected-test-JBS1dJHn9A8UJ-JQS-1_m@example.com","msg":"User registered"}
{"level":30,"time":1768250196430,"env":"test","module":"email-queue","jobId":"a2a1f38a-4982-4c22-b8b6-659047031730","to":"jwt-test-9VfLjHa2taDjnVWstbI-V@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPATCH Protected Routes[2m > [22m[2mshould reject PATCH without Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250196476,"env":"test","module":"auth-routes","userId":"b81b37b1-9d9e-4509-9cab-e963ec9cd77a","email":"jwt-test-9VfLjHa2taDjnVWstbI-V@example.com","msg":"User registered"}
{"level":50,"time":1768250196479,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250196775,"env":"test","module":"auth-routes","userId":"ff267f09-b8ee-439c-adb0-9fca1959ecc1","msg":"User logged in successfully"}
{"level":30,"time":1768250196825,"env":"test","module":"audit-log-service","userId":"ff267f09-b8ee-439c-adb0-9fca1959ecc1","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250196841,"env":"test","module":"user-credentials-repository","userId":"6f29829d-fd83-424d-860e-b882e0a553a5","msg":"User credentials created"}
{"level":30,"time":1768250196941,"env":"test","module":"email-queue","jobId":"4207d4e3-99cf-4ce4-9b4f-83eeeedd6a6b","to":"jwt-test-01AFWZIjRHg4AXGKdiaYj@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250196956,"env":"test","module":"auth-routes","userId":"94103adb-5471-4dcd-af36-d1168a066737","msg":"User logged in successfully"}
{"level":30,"time":1768250196988,"env":"test","module":"auth-routes","userId":"6f29829d-fd83-424d-860e-b882e0a553a5","email":"jwt-test-01AFWZIjRHg4AXGKdiaYj@example.com","msg":"User registered"}
{"level":30,"time":1768250197002,"env":"test","module":"audit-log-service","userId":"94103adb-5471-4dcd-af36-d1168a066737","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250197006,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mHybrid Authentication Strategy[2m > [22m[2mshould allow GET requests with cookie auth only
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250197315,"env":"test","module":"intake-service","runId":"5d6714a3-8967-48f3-a51f-2baa22f767aa","slug":"hybrid-invalid-FyMIK0WAcELMNuUG0uuCQ","msg":"Created intake run"}
{"level":30,"time":1768250197373,"env":"test","module":"user-credentials-repository","userId":"654b34c7-3fd7-4d95-8dd6-75ae21cc09d6","msg":"User credentials created"}
{"level":30,"time":1768250197468,"env":"test","module":"email-queue","jobId":"791795eb-e114-4a59-9390-f1d353127610","to":"protected-test-Domj53T6agP_vSooU2Pgw@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250197489,"env":"test","module":"auth-routes","userId":"6f29829d-fd83-424d-860e-b882e0a553a5","msg":"User logged in successfully"}
{"level":30,"time":1768250197515,"env":"test","module":"auth-routes","userId":"654b34c7-3fd7-4d95-8dd6-75ae21cc09d6","email":"protected-test-Domj53T6agP_vSooU2Pgw@example.com","msg":"User registered"}
{"level":30,"time":1768250197537,"env":"test","module":"audit-log-service","userId":"6f29829d-fd83-424d-860e-b882e0a553a5","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle Bearer token with extra spaces
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250197676,"env":"test","module":"user-credentials-repository","userId":"c85c19f7-f4e0-432b-aa43-5f2659c3a619","msg":"User credentials created"}
{"level":30,"time":1768250197775,"env":"test","module":"email-queue","jobId":"d0c38efe-017b-4d3e-aff6-9d3eb5481ef8","to":"middleware-test-IhGW_QaIwcFM-jLgO-XAw@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250197823,"env":"test","module":"auth-routes","userId":"c85c19f7-f4e0-432b-aa43-5f2659c3a619","email":"middleware-test-IhGW_QaIwcFM-jLgO-XAw@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mCookie Strategy Security[2m > [22m[2mshould only allow safe methods for cookie auth
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250198057,"env":"test","module":"user-credentials-repository","userId":"afbdb5b8-bbc8-4e30-b1b9-bf04115bbe72","msg":"User credentials created"}
{"level":30,"time":1768250198141,"env":"test","module":"auth-routes","userId":"654b34c7-3fd7-4d95-8dd6-75ae21cc09d6","msg":"User logged in successfully"}
{"level":30,"time":1768250198152,"env":"test","module":"email-queue","jobId":"580385b3-cf28-4812-84c0-0f44bc4f130d","to":"jwt-test--NCPxWGjRQHkPRk8VdpMi@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250198189,"env":"test","module":"audit-log-service","userId":"654b34c7-3fd7-4d95-8dd6-75ae21cc09d6","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768250198192,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768250198192,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250198199,"env":"test","module":"auth-routes","userId":"afbdb5b8-bbc8-4e30-b1b9-bf04115bbe72","email":"jwt-test--NCPxWGjRQHkPRk8VdpMi@example.com","msg":"User registered"}
{"level":50,"time":1768250198202,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250198322,"env":"test","module":"auth-routes","userId":"c85c19f7-f4e0-432b-aa43-5f2659c3a619","msg":"User logged in successfully"}
{"level":30,"time":1768250198370,"env":"test","module":"audit-log-service","userId":"c85c19f7-f4e0-432b-aa43-5f2659c3a619","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250198523,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250198564,"env":"test","module":"user-credentials-repository","userId":"35db47f8-90af-475a-b2d8-8ea675f0573e","msg":"User credentials created"}
{"level":30,"time":1768250198658,"env":"test","module":"email-queue","jobId":"e1ed718b-f03a-450b-a02a-366a7b2a1d07","to":"protected-test-a6CkQgzHW60DTheftqybD@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250198709,"env":"test","module":"auth-routes","userId":"35db47f8-90af-475a-b2d8-8ea675f0573e","email":"protected-test-a6CkQgzHW60DTheftqybD@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle very long invalid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250198889,"env":"test","module":"user-credentials-repository","userId":"35387f64-fb8b-410a-a48c-b9376f6ce3a5","msg":"User credentials created"}
{"level":30,"time":1768250198982,"env":"test","module":"email-queue","jobId":"a7b7fa98-08dc-4bba-96ff-27d861489984","to":"middleware-test-G7HVUUUCNn3KCkwVQja1n@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250199028,"env":"test","module":"auth-routes","userId":"35387f64-fb8b-410a-a48c-b9376f6ce3a5","email":"middleware-test-G7HVUUUCNn3KCkwVQja1n@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mCookie Strategy Security[2m > [22m[2mshould ignore cookies when Bearer token present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250199314,"env":"test","module":"auth-routes","userId":"35db47f8-90af-475a-b2d8-8ea675f0573e","msg":"User logged in successfully"}
{"level":30,"time":1768250199364,"env":"test","module":"audit-log-service","userId":"35db47f8-90af-475a-b2d8-8ea675f0573e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250199367,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250199479,"env":"test","module":"user-credentials-repository","userId":"0956fb1b-abf9-45f9-a0fc-e2ad077c3063","msg":"User credentials created"}
{"level":30,"time":1768250199532,"env":"test","module":"auth-routes","userId":"35387f64-fb8b-410a-a48c-b9376f6ce3a5","msg":"User logged in successfully"}
{"level":30,"time":1768250199574,"env":"test","module":"email-queue","jobId":"e8aa0586-bdf4-4334-805a-ebeec70e06d8","to":"jwt-test-c5Ob2BxuGDRLNiDfnYB-d@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250199578,"env":"test","module":"audit-log-service","userId":"35387f64-fb8b-410a-a48c-b9376f6ce3a5","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250199626,"env":"test","module":"auth-routes","userId":"0956fb1b-abf9-45f9-a0fc-e2ad077c3063","email":"jwt-test-c5Ob2BxuGDRLNiDfnYB-d@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould refresh access token using refresh token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250199735,"env":"test","module":"user-credentials-repository","userId":"d5d8a017-dd2c-41b7-bb47-49de02969d34","msg":"User credentials created"}
{"level":30,"time":1768250199838,"env":"test","module":"email-queue","jobId":"e10807fe-e6fe-4574-b79d-14bbec50ed1e","to":"protected-test-31aFtXi9RXZkUJ2XuLjpr@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250199885,"env":"test","module":"auth-routes","userId":"d5d8a017-dd2c-41b7-bb47-49de02969d34","email":"protected-test-31aFtXi9RXZkUJ2XuLjpr@example.com","msg":"User registered"}
{"level":30,"time":1768250199953,"env":"test","module":"user-credentials-repository","userId":"4f973327-153e-452e-bb67-f6e4dcaf1775","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle empty Authorization header
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250200048,"env":"test","module":"email-queue","jobId":"f2d0770d-4cd4-45e3-84f7-0b65e95d4f2f","to":"cookie-test-ygAWRH-LG7bgyBQen_TcK@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250200107,"env":"test","module":"auth-routes","userId":"4f973327-153e-452e-bb67-f6e4dcaf1775","email":"cookie-test-ygAWRH-LG7bgyBQen_TcK@example.com","msg":"User registered"}
{"level":30,"time":1768250200157,"env":"test","module":"auth-routes","userId":"0956fb1b-abf9-45f9-a0fc-e2ad077c3063","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mCookie Strategy Security[2m > [22m[2mshould ignore cookies when Bearer token present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250200205,"env":"test","module":"audit-log-service","userId":"0956fb1b-abf9-45f9-a0fc-e2ad077c3063","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250200502,"env":"test","module":"auth-routes","userId":"d5d8a017-dd2c-41b7-bb47-49de02969d34","msg":"User logged in successfully"}
{"level":30,"time":1768250200566,"env":"test","module":"audit-log-service","userId":"d5d8a017-dd2c-41b7-bb47-49de02969d34","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250200569,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250200621,"env":"test","module":"auth-routes","userId":"4f973327-153e-452e-bb67-f6e4dcaf1775","msg":"User logged in successfully"}
{"level":30,"time":1768250200676,"env":"test","module":"audit-log-service","userId":"4f973327-153e-452e-bb67-f6e4dcaf1775","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250200933,"env":"test","module":"user-credentials-repository","userId":"f69c03e0-47fd-4a96-8923-bcf6cdbb7df0","msg":"User credentials created"}
{"level":30,"time":1768250201028,"env":"test","module":"email-queue","jobId":"f3bd57f5-77f2-460c-851c-927a8714d742","to":"protected-test-UH6JZeMg7n7GMVNerH9YS@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250201076,"env":"test","module":"auth-routes","userId":"f69c03e0-47fd-4a96-8923-bcf6cdbb7df0","email":"protected-test-UH6JZeMg7n7GMVNerH9YS@example.com","msg":"User registered"}
{"level":30,"time":1768250201148,"env":"test","module":"user-credentials-repository","userId":"ead08953-9f31-42fd-8937-7a37d5ebdc70","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle Authorization header with only Bearer
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250201209,"env":"test","module":"auth-service","tokenHash":"23430c57d4ab1f1a7adf3ab176e07158ba74cf8ace1d23211f444ae93aaddfe0","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250201263,"env":"test","module":"email-queue","jobId":"9e4b22de-5f55-43e2-b5f6-3c40f1aab602","to":"middleware-test-HapperykOBRcMlIhPHB9U@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250201314,"env":"test","module":"auth-routes","userId":"ead08953-9f31-42fd-8937-7a37d5ebdc70","email":"middleware-test-HapperykOBRcMlIhPHB9U@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mUser Context Attachment[2m > [22m[2mshould attach userId to request
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250201715,"env":"test","module":"auth-routes","userId":"f69c03e0-47fd-4a96-8923-bcf6cdbb7df0","msg":"User logged in successfully"}
{"level":30,"time":1768250201769,"env":"test","module":"audit-log-service","userId":"f69c03e0-47fd-4a96-8923-bcf6cdbb7df0","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250201773,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250201788,"env":"test","module":"user-credentials-repository","userId":"45809d52-50cc-465b-b1f7-679c3c3f9280","msg":"User credentials created"}
{"level":30,"time":1768250201837,"env":"test","module":"auth-routes","userId":"ead08953-9f31-42fd-8937-7a37d5ebdc70","msg":"User logged in successfully"}
{"level":30,"time":1768250201901,"env":"test","module":"email-queue","jobId":"95ff5a87-664f-4f55-b5cc-dee293fc8f66","to":"jwt-test-ZkdezAvagpiperbYi-jXh@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250201901,"env":"test","module":"audit-log-service","userId":"ead08953-9f31-42fd-8937-7a37d5ebdc70","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250201959,"env":"test","module":"auth-routes","userId":"45809d52-50cc-465b-b1f7-679c3c3f9280","email":"jwt-test-ZkdezAvagpiperbYi-jXh@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould rotate refresh token on use
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250202163,"env":"test","module":"user-credentials-repository","userId":"40524b26-46f7-4957-9fec-83d6acae123e","msg":"User credentials created"}
{"level":30,"time":1768250202256,"env":"test","module":"email-queue","jobId":"d9d3d343-5408-4016-a42e-4b4cc2cfe801","to":"protected-test-LuvnOu8DK7I51xjPHCMx6@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250202304,"env":"test","module":"auth-routes","userId":"40524b26-46f7-4957-9fec-83d6acae123e","email":"protected-test-LuvnOu8DK7I51xjPHCMx6@example.com","msg":"User registered"}
{"level":30,"time":1768250202373,"env":"test","module":"user-credentials-repository","userId":"58a19036-f4d0-4e0e-8315-08de54d926c4","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle multiple Authorization headers
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250202477,"env":"test","module":"auth-routes","userId":"45809d52-50cc-465b-b1f7-679c3c3f9280","msg":"User logged in successfully"}
{"level":30,"time":1768250202490,"env":"test","module":"email-queue","jobId":"fba8d0fc-52f7-41f1-a95a-ac3b569c73aa","to":"middleware-test-S2wvbblmtigqOgL8mAIPQ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250202525,"env":"test","module":"audit-log-service","userId":"45809d52-50cc-465b-b1f7-679c3c3f9280","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250202527,"env":"test","module":"auth-service","tokenHash":"c116bd65181ec287c54c72c1c6c87d16fc952156fe46da894d9ce2dff3973417","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250202541,"env":"test","module":"auth-routes","userId":"58a19036-f4d0-4e0e-8315-08de54d926c4","email":"middleware-test-S2wvbblmtigqOgL8mAIPQ@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mUser Context Attachment[2m > [22m[2mshould attach userEmail to request
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250202727,"env":"test","module":"auth-service","tokenHash":"c116bd65181ec287c54c72c1c6c87d16fc952156fe46da894d9ce2dff3973417","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250202772,"env":"test","module":"auth-service","userId":"45809d52-50cc-465b-b1f7-679c3c3f9280","tokenHash":"c116bd65181ec287c54c72c1c6c87d16fc952156fe46da894d9ce2dff3973417","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768250202828,"env":"test","module":"auth-service","tokenHash":"c9845665f48c72f3b1d08c6c39396b2e49c277d3d2221b3ce55d85c7b827672f","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250202875,"env":"test","module":"auth-service","userId":"45809d52-50cc-465b-b1f7-679c3c3f9280","tokenHash":"c9845665f48c72f3b1d08c6c39396b2e49c277d3d2221b3ce55d85c7b827672f","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768250202933,"env":"test","module":"auth-routes","userId":"40524b26-46f7-4957-9fec-83d6acae123e","msg":"User logged in successfully"}
{"level":30,"time":1768250202985,"env":"test","module":"audit-log-service","userId":"40524b26-46f7-4957-9fec-83d6acae123e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250202987,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250203041,"env":"test","module":"auth-routes","userId":"58a19036-f4d0-4e0e-8315-08de54d926c4","msg":"User logged in successfully"}
{"level":30,"time":1768250203090,"env":"test","module":"audit-log-service","userId":"58a19036-f4d0-4e0e-8315-08de54d926c4","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250203288,"env":"test","module":"user-credentials-repository","userId":"2fade258-d684-4f1c-9a41-f52175bab78e","msg":"User credentials created"}
{"level":30,"time":1768250203359,"env":"test","module":"user-credentials-repository","userId":"14be394d-243f-4ee0-96d3-b61e0a44ec65","msg":"User credentials created"}
{"level":30,"time":1768250203387,"env":"test","module":"email-queue","jobId":"c9c73ff8-1bd0-4341-83b2-a286f1ba96d9","to":"jwt-test-NP2YwF6rufiPQ36atPhJx@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250203434,"env":"test","module":"auth-routes","userId":"2fade258-d684-4f1c-9a41-f52175bab78e","email":"jwt-test-NP2YwF6rufiPQ36atPhJx@example.com","msg":"User registered"}
{"level":30,"time":1768250203459,"env":"test","module":"email-queue","jobId":"3287ba4c-a0e6-4cc1-963b-1ca84f1c92c4","to":"protected-test-o2fcWDjAfTYE7hewm3tS8@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould detect token reuse and revoke all user tokens
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250203505,"env":"test","module":"auth-routes","userId":"14be394d-243f-4ee0-96d3-b61e0a44ec65","email":"protected-test-o2fcWDjAfTYE7hewm3tS8@example.com","msg":"User registered"}
{"level":30,"time":1768250203562,"env":"test","module":"user-credentials-repository","userId":"44dc7a84-7c9c-4484-ab80-c839a651d1cf","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould reject token with SQL injection attempt
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250203672,"env":"test","module":"email-queue","jobId":"8b8ea179-38db-4524-8519-e78c83775d2d","to":"middleware-test-B3GRoaGCdKppUMX1EDGYB@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250203721,"env":"test","module":"auth-routes","userId":"44dc7a84-7c9c-4484-ab80-c839a651d1cf","email":"middleware-test-B3GRoaGCdKppUMX1EDGYB@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould return consistent error format for missing token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250203950,"env":"test","module":"auth-routes","userId":"2fade258-d684-4f1c-9a41-f52175bab78e","msg":"User logged in successfully"}
{"level":30,"time":1768250204002,"env":"test","module":"audit-log-service","userId":"2fade258-d684-4f1c-9a41-f52175bab78e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould detect token reuse and revoke all user tokens
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250204129,"env":"test","module":"auth-routes","userId":"14be394d-243f-4ee0-96d3-b61e0a44ec65","msg":"User logged in successfully"}
{"level":30,"time":1768250204186,"env":"test","module":"audit-log-service","userId":"14be394d-243f-4ee0-96d3-b61e0a44ec65","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250204189,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250204231,"env":"test","module":"auth-routes","userId":"44dc7a84-7c9c-4484-ab80-c839a651d1cf","msg":"User logged in successfully"}
{"level":30,"time":1768250204277,"env":"test","module":"audit-log-service","userId":"44dc7a84-7c9c-4484-ab80-c839a651d1cf","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250204280,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250204485,"env":"test","module":"auth-routes","userId":"2fade258-d684-4f1c-9a41-f52175bab78e","msg":"User logged in successfully"}
{"level":30,"time":1768250204536,"env":"test","module":"audit-log-service","userId":"2fade258-d684-4f1c-9a41-f52175bab78e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250204540,"env":"test","module":"auth-service","tokenHash":"1d1b6769e8a53d8049921965d6447d17bc80c246d75a7fbdaa19c1a75b2d250b","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250204562,"env":"test","module":"user-credentials-repository","userId":"36b5f0ff-1f57-45c4-809b-ba62c3464a9b","msg":"User credentials created"}
{"level":30,"time":1768250204656,"env":"test","module":"user-credentials-repository","userId":"b1540009-f79c-45f5-a0f3-4efef788b9e6","msg":"User credentials created"}
{"level":30,"time":1768250204664,"env":"test","module":"email-queue","jobId":"dd18db30-980d-4cbd-932f-b558aece337e","to":"protected-test-EohRTkV181t18Jz8esRkh@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250204722,"env":"test","module":"auth-routes","userId":"36b5f0ff-1f57-45c4-809b-ba62c3464a9b","email":"protected-test-EohRTkV181t18Jz8esRkh@example.com","msg":"User registered"}
{"level":30,"time":1768250204744,"env":"test","module":"auth-service","tokenHash":"1d1b6769e8a53d8049921965d6447d17bc80c246d75a7fbdaa19c1a75b2d250b","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250204765,"env":"test","module":"email-queue","jobId":"d5212537-e17a-4b1c-a849-a5836b4af1a7","to":"middleware-test-QTfjr85pR5TobEPkzLMVG@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":40,"time":1768250204790,"env":"test","module":"auth-service","userId":"2fade258-d684-4f1c-9a41-f52175bab78e","tokenHash":"1d1b6769e8a53d8049921965d6447d17bc80c246d75a7fbdaa19c1a75b2d250b","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768250204813,"env":"test","module":"auth-routes","userId":"b1540009-f79c-45f5-a0f3-4efef788b9e6","email":"middleware-test-QTfjr85pR5TobEPkzLMVG@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould reject token with XSS attempt
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250204845,"env":"test","module":"auth-service","tokenHash":"8e474ac40793f57a2a3a13a5224059af2256ecd06cc194a067939f59bc35cf9e","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould return consistent error format for invalid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768250204891,"env":"test","module":"auth-service","userId":"2fade258-d684-4f1c-9a41-f52175bab78e","tokenHash":"8e474ac40793f57a2a3a13a5224059af2256ecd06cc194a067939f59bc35cf9e","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768250205313,"env":"test","module":"user-credentials-repository","userId":"03b498e7-38de-4a92-8738-98a0038ae368","msg":"User credentials created"}
{"level":30,"time":1768250205321,"env":"test","module":"auth-routes","userId":"b1540009-f79c-45f5-a0f3-4efef788b9e6","msg":"User logged in successfully"}
{"level":30,"time":1768250205341,"env":"test","module":"auth-routes","userId":"36b5f0ff-1f57-45c4-809b-ba62c3464a9b","msg":"User logged in successfully"}
{"level":30,"time":1768250205369,"env":"test","module":"audit-log-service","userId":"b1540009-f79c-45f5-a0f3-4efef788b9e6","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250205374,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250205388,"env":"test","module":"audit-log-service","userId":"36b5f0ff-1f57-45c4-809b-ba62c3464a9b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250205392,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250205414,"env":"test","module":"email-queue","jobId":"f0c5b31b-b7fd-43e0-bbeb-1dcdb099d07c","to":"jwt-test-UPXspURi5_nnGxPLjGpir@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250205461,"env":"test","module":"auth-routes","userId":"03b498e7-38de-4a92-8738-98a0038ae368","email":"jwt-test-UPXspURi5_nnGxPLjGpir@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mLogout Flow[2m > [22m[2mshould revoke refresh token on logout
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250205749,"env":"test","module":"user-credentials-repository","userId":"607d3a3e-e763-4780-8588-5921fc67f7a0","msg":"User credentials created"}
{"level":30,"time":1768250205764,"env":"test","module":"user-credentials-repository","userId":"156d36be-781f-4874-be9d-bc6d6b06b4c6","msg":"User credentials created"}
{"level":30,"time":1768250205848,"env":"test","module":"email-queue","jobId":"2c1cfe03-2296-4ed8-8d9d-de69e16e4c0e","to":"middleware-test-GPfM1p14altMbW3Jp3lpZ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250205856,"env":"test","module":"email-queue","jobId":"f5859620-e53d-4cf0-8060-ea1bc3900a7f","to":"protected-test-ZEagd8MyQLjRjuwsJhTzh@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250205898,"env":"test","module":"auth-routes","userId":"607d3a3e-e763-4780-8588-5921fc67f7a0","email":"middleware-test-GPfM1p14altMbW3Jp3lpZ@example.com","msg":"User registered"}
{"level":30,"time":1768250205904,"env":"test","module":"auth-routes","userId":"156d36be-781f-4874-be9d-bc6d6b06b4c6","email":"protected-test-ZEagd8MyQLjRjuwsJhTzh@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould return consistent error format for expired token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250205960,"env":"test","module":"auth-routes","userId":"03b498e7-38de-4a92-8738-98a0038ae368","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Payload Validation[2m > [22m[2mshould reject token with missing userId
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250206008,"env":"test","module":"audit-log-service","userId":"03b498e7-38de-4a92-8738-98a0038ae368","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250206059,"env":"test","module":"auth-service","tokenHash":"d8f38eab41e9f2f714ceaec2a279692966b485e1e1357e0a016b219ca2561316","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250206108,"env":"test","module":"auth-service","userId":"03b498e7-38de-4a92-8738-98a0038ae368","tokenHash":"d8f38eab41e9f2f714ceaec2a279692966b485e1e1357e0a016b219ca2561316","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768250206405,"env":"test","module":"auth-routes","userId":"607d3a3e-e763-4780-8588-5921fc67f7a0","msg":"User logged in successfully"}
{"level":30,"time":1768250206457,"env":"test","module":"audit-log-service","userId":"607d3a3e-e763-4780-8588-5921fc67f7a0","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250206514,"env":"test","module":"auth-routes","userId":"156d36be-781f-4874-be9d-bc6d6b06b4c6","msg":"User logged in successfully"}
{"level":30,"time":1768250206524,"env":"test","module":"user-credentials-repository","userId":"8fb197a7-f15c-4ab2-a6ed-084e2c745cc3","msg":"User credentials created"}
{"level":30,"time":1768250206566,"env":"test","module":"audit-log-service","userId":"156d36be-781f-4874-be9d-bc6d6b06b4c6","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250206621,"env":"test","module":"email-queue","jobId":"f8ccb98a-79f8-487b-b522-748986904e15","to":"jwt-test-ZJRWRSyAx9c2yOoPJif72@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250206672,"env":"test","module":"auth-routes","userId":"8fb197a7-f15c-4ab2-a6ed-084e2c745cc3","email":"jwt-test-ZJRWRSyAx9c2yOoPJif72@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mLogout Flow[2m > [22m[2mshould clear refresh token cookie on logout
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250206937,"env":"test","module":"user-credentials-repository","userId":"b786bc90-87d4-4f4f-885e-844f813ece3b","msg":"User credentials created"}
{"level":30,"time":1768250207037,"env":"test","module":"email-queue","jobId":"00b26268-8c2c-4947-bb2f-0049ce17e366","to":"protected-test-20ShellrWFF1B8BW5J-t5@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250207084,"env":"test","module":"auth-routes","userId":"b786bc90-87d4-4f4f-885e-844f813ece3b","email":"protected-test-20ShellrWFF1B8BW5J-t5@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Payload Validation[2m > [22m[2mshould reject token with non-existent userId
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250207188,"env":"test","module":"auth-routes","userId":"8fb197a7-f15c-4ab2-a6ed-084e2c745cc3","msg":"User logged in successfully"}
{"level":30,"time":1768250207238,"env":"test","module":"audit-log-service","userId":"8fb197a7-f15c-4ab2-a6ed-084e2c745cc3","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250207547,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250207547,"env":"test","msg":"DB: pool closed."}
{"level":40,"time":1768250207561,"env":"test","module":"auth-middleware","error":{"name":"TokenExpiredError","code":"AUTH_002","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768250207561,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250207682,"env":"test","module":"auth-routes","userId":"b786bc90-87d4-4f4f-885e-844f813ece3b","msg":"User logged in successfully"}
{"level":30,"time":1768250207731,"env":"test","module":"audit-log-service","userId":"b786bc90-87d4-4f4f-885e-844f813ece3b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w4_0c3dfcb4

{"level":30,"time":1768250207924,"env":"test","module":"user-credentials-repository","userId":"8f5ef847-d5ac-4209-a7a9-fcb5b1c12e58","msg":"User credentials created"}
 [32mÎ“Â£Ã´[39m tests/integration/auth/jwt.authentication.test.ts [2m([22m[2m27 tests[22m[2m)[22m[33m 82512[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should generate valid JWT token on successful login [33m 1197[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should include correct payload in JWT token [33m 1073[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set JWT expiry to 15 minutes [33m 1073[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should accept valid JWT token on protected routes [33m 1181[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should accept request with missing Bearer prefix (lenient) [33m 1203[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject expired JWT token [33m 1105[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return token_expired error code for expired tokens [33m 1104[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should exchange valid session cookie for JWT token [33m 672[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prefer Bearer token over cookie when both present [33m 1140[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should fall back to cookie if Bearer token is invalid [33m 519[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow GET requests with cookie auth only [33m 1214[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject POST requests with cookie auth only (mutation-strict) [33m 510[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow anonymous access to public workflows [33m 448[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should attach user info if authenticated on optional auth routes [33m 450[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should refresh access token using refresh token [33m 2306[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should rotate refresh token on use [33m 1514[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should detect token reuse and revoke all user tokens [33m 2021[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke refresh token on logout [33m 1213[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should clear refresh token cookie on logout [33m 1130[2mms[22m[39m
{"level":30,"time":1768250208023,"env":"test","module":"email-queue","jobId":"2209c056-51c1-4225-ba41-5668dba94561","to":"middleware-test-Ro5fY8MeUIrmkU-ELAqlW@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250208071,"env":"test","module":"auth-routes","userId":"8f5ef847-d5ac-4209-a7a9-fcb5b1c12e58","email":"middleware-test-Ro5fY8MeUIrmkU-ELAqlW@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould handle malformed JWT gracefully
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250208197,"env":"test","module":"user-credentials-repository","userId":"ea95196f-90aa-4ccc-b56f-d651d966a4a4","msg":"User credentials created"}
{"level":30,"time":1768250208298,"env":"test","module":"email-queue","jobId":"43e5b8a7-325d-4a9b-97af-0ca419f90950","to":"protected-test-knmwf8ApTkHzb2bdaL4AD@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250208346,"env":"test","module":"auth-routes","userId":"ea95196f-90aa-4ccc-b56f-d651d966a4a4","email":"protected-test-knmwf8ApTkHzb2bdaL4AD@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mCross-User Authorization[2m > [22m[2mshould not allow user to access another user's resources
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250208568,"env":"test","module":"auth-routes","userId":"8f5ef847-d5ac-4209-a7a9-fcb5b1c12e58","msg":"User logged in successfully"}
{"level":30,"time":1768250208614,"env":"test","module":"audit-log-service","userId":"8f5ef847-d5ac-4209-a7a9-fcb5b1c12e58","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768250208618,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768250208618,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250208956,"env":"test","module":"auth-routes","userId":"ea95196f-90aa-4ccc-b56f-d651d966a4a4","msg":"User logged in successfully"}
{"level":30,"time":1768250208978,"env":"test","module":"user-credentials-repository","userId":"12763f42-4450-404b-9605-f3d0d0f95b89","msg":"User credentials created"}
{"level":30,"time":1768250209005,"env":"test","module":"audit-log-service","userId":"ea95196f-90aa-4ccc-b56f-d651d966a4a4","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250209073,"env":"test","module":"email-queue","jobId":"0054b88d-cafe-4359-a12a-4f72564af8d9","to":"middleware-test-LEDqNY_JV2dd980lsHW7G@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250209122,"env":"test","module":"auth-routes","userId":"12763f42-4450-404b-9605-f3d0d0f95b89","email":"middleware-test-LEDqNY_JV2dd980lsHW7G@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould handle JWT with wrong algorithm
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250209368,"env":"test","module":"user-credentials-repository","userId":"36042d9f-b98d-4a13-974f-4838a56aa5e4","msg":"User credentials created"}
{"level":30,"time":1768250209462,"env":"test","module":"email-queue","jobId":"132896e2-9c59-4b8e-9950-88b61f9363dd","to":"user2-aSSEqR4vnfV_-WIDE_j8j@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250209508,"env":"test","module":"auth-routes","userId":"36042d9f-b98d-4a13-974f-4838a56aa5e4","email":"user2-aSSEqR4vnfV_-WIDE_j8j@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mCross-User Authorization[2m > [22m[2mshould not allow user to access another user's resources
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250209616,"env":"test","module":"auth-routes","userId":"12763f42-4450-404b-9605-f3d0d0f95b89","msg":"User logged in successfully"}
{"level":30,"time":1768250209664,"env":"test","module":"audit-log-service","userId":"12763f42-4450-404b-9605-f3d0d0f95b89","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768250209668,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768250209669,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250209934,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250209935,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768250210068,"env":"test","module":"auth-routes","userId":"36042d9f-b98d-4a13-974f-4838a56aa5e4","msg":"User logged in successfully"}
{"level":30,"time":1768250210116,"env":"test","module":"audit-log-service","userId":"36042d9f-b98d-4a13-974f-4838a56aa5e4","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768250210173,"env":"test","module":"rbac-middleware","userId":"36042d9f-b98d-4a13-974f-4838a56aa5e4","userRole":"viewer","permission":"project:delete","path":"/57a5312d-ca64-41bd-af1a-7c4abe0fbb18","msg":"Permission denied"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w0_b635fde1

 [31mÎ“Â¥Â»[39m tests/integration/auth/auth.middleware.integration.test.ts [2m([22m[2m27 tests[22m[2m | [22m[31m5 failed[39m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 84909[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow access with valid JWT Bearer token [33m 1217[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 when no token provided [33m 1086[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 401 with invalid token[39m[33m 909[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 with expired token [33m 2189[2mms[22m[39m
       [2m[90mÎ“Ã¥Ã´[39m[22m should proceed without authentication if no token provided
       [33m[2mÎ“Â£Ã´[22m[39m should authenticate with JWT Bearer token [33m 1192[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should authenticate with refresh token cookie (GET only)[39m[33m 934[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject cookie auth for POST requests (mutation-strict)[39m[33m 915[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject cookie auth for PUT requests [33m 1105[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject cookie auth for DELETE requests[39m[33m 914[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow cookie auth for HEAD requests[39m[33m 1121[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prioritize JWT over cookie when both present [33m 2257[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 when no auth provided [33m 1102[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 when both JWT and cookie are invalid [33m 1096[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should authenticate with JWT if provided [33m 1638[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should authenticate with cookie if JWT not provided [33m 1580[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should proceed anonymously if no auth provided [33m 1599[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should proceed anonymously if both JWT and cookie are invalid [33m 1571[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should only allow safe methods for cookie auth [33m 1207[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should ignore cookies when Bearer token present [33m 2262[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should attach userId to request [33m 1222[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should attach userEmail to request [33m 1183[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return consistent error format for missing token [33m 1090[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return consistent error format for invalid token [33m 1094[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return consistent error format for expired token [33m 2186[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle malformed JWT gracefully [33m 1057[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle JWT with wrong algorithm [33m 1051[2mms[22m[39m
{"level":30,"time":1768250210537,"env":"test","module":"user-credentials-repository","userId":"9e921f9f-cd47-4b31-9fcb-fa9ce798480d","msg":"User credentials created"}
{"level":30,"time":1768250210642,"env":"test","module":"email-queue","jobId":"ae7b072b-2e33-4307-8dda-1d37c3bbb364","to":"protected-test-81A3PJUP8J9gwzSZgsWWt@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250210693,"env":"test","module":"auth-routes","userId":"9e921f9f-cd47-4b31-9fcb-fa9ce798480d","email":"protected-test-81A3PJUP8J9gwzSZgsWWt@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mUser Context Injection[2m > [22m[2mshould inject userId into request context
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250211289,"env":"test","module":"auth-routes","userId":"9e921f9f-cd47-4b31-9fcb-fa9ce798480d","msg":"User logged in successfully"}
{"level":30,"time":1768250211337,"env":"test","module":"audit-log-service","userId":"9e921f9f-cd47-4b31-9fcb-fa9ce798480d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250211766,"env":"test","module":"user-credentials-repository","userId":"7ea2aae5-06f5-4dc2-b9ae-aca504ff93ab","msg":"User credentials created"}
{"level":30,"time":1768250211862,"env":"test","module":"email-queue","jobId":"9fe9587f-2f42-42e5-9cbb-dda6ac2421bf","to":"protected-test-Afxpa2G5HkUvcdZ-D-YF4@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250211911,"env":"test","module":"auth-routes","userId":"7ea2aae5-06f5-4dc2-b9ae-aca504ff93ab","email":"protected-test-Afxpa2G5HkUvcdZ-D-YF4@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mUser Context Injection[2m > [22m[2mshould inject tenantId into request context
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250212500,"env":"test","module":"auth-routes","userId":"7ea2aae5-06f5-4dc2-b9ae-aca504ff93ab","msg":"User logged in successfully"}
{"level":30,"time":1768250212548,"env":"test","module":"audit-log-service","userId":"7ea2aae5-06f5-4dc2-b9ae-aca504ff93ab","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250212961,"env":"test","module":"user-credentials-repository","userId":"66d983fc-5661-4805-baba-037f40aebadb","msg":"User credentials created"}
{"level":30,"time":1768250213054,"env":"test","module":"email-queue","jobId":"27b4eda4-1f93-413e-bf80-0ea79244a82c","to":"protected-test-i7cD0R3GQGu6j0hCmK-Hi@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250213101,"env":"test","module":"auth-routes","userId":"66d983fc-5661-4805-baba-037f40aebadb","email":"protected-test-i7cD0R3GQGu6j0hCmK-Hi@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mUser Context Injection[2m > [22m[2mshould inject role into request context
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250213699,"env":"test","module":"auth-routes","userId":"66d983fc-5661-4805-baba-037f40aebadb","msg":"User logged in successfully"}
{"level":30,"time":1768250213746,"env":"test","module":"audit-log-service","userId":"66d983fc-5661-4805-baba-037f40aebadb","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250214155,"env":"test","module":"user-credentials-repository","userId":"6152c86f-2c76-4a14-96dc-1973e66a9f2f","msg":"User credentials created"}
{"level":30,"time":1768250214249,"env":"test","module":"email-queue","jobId":"3d562e16-3145-4d33-9de9-a84d4a594501","to":"protected-test-Ha1tkrcY9Gt-C1gswBeiu@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250214296,"env":"test","module":"auth-routes","userId":"6152c86f-2c76-4a14-96dc-1973e66a9f2f","email":"protected-test-Ha1tkrcY9Gt-C1gswBeiu@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mRate Limiting on Protected Routes[2m > [22m[2mshould not apply general rate limiting to authenticated requests
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250214892,"env":"test","module":"auth-routes","userId":"6152c86f-2c76-4a14-96dc-1973e66a9f2f","msg":"User logged in successfully"}
{"level":30,"time":1768250214940,"env":"test","module":"audit-log-service","userId":"6152c86f-2c76-4a14-96dc-1973e66a9f2f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250215784,"env":"test","module":"user-credentials-repository","userId":"e8480925-9906-4dba-bb8a-4de8a1970d0d","msg":"User credentials created"}
{"level":30,"time":1768250215880,"env":"test","module":"email-queue","jobId":"34b3adea-b771-4e5b-8311-b6228cee8d3a","to":"protected-test-Q2T4BenAEAZ-i6OGXFVno@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250215928,"env":"test","module":"auth-routes","userId":"e8480925-9906-4dba-bb8a-4de8a1970d0d","email":"protected-test-Q2T4BenAEAZ-i6OGXFVno@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mMixed Auth Scenarios[2m > [22m[2mshould handle request with both Bearer token and cookies
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250216538,"env":"test","module":"auth-routes","userId":"e8480925-9906-4dba-bb8a-4de8a1970d0d","msg":"User logged in successfully"}
{"level":30,"time":1768250216586,"env":"test","module":"audit-log-service","userId":"e8480925-9906-4dba-bb8a-4de8a1970d0d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mMixed Auth Scenarios[2m > [22m[2mshould handle request with both Bearer token and cookies
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250217106,"env":"test","module":"auth-routes","userId":"e8480925-9906-4dba-bb8a-4de8a1970d0d","msg":"User logged in successfully"}
{"level":30,"time":1768250217153,"env":"test","module":"audit-log-service","userId":"e8480925-9906-4dba-bb8a-4de8a1970d0d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250217576,"env":"test","module":"user-credentials-repository","userId":"cbdd5ae1-5b16-4b38-a085-86c9c6281687","msg":"User credentials created"}
{"level":30,"time":1768250217673,"env":"test","module":"email-queue","jobId":"da79c118-28a0-42a2-abab-a187dc62b4aa","to":"protected-test-YKMiiZBfW3AvAE9WEqal7@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250217726,"env":"test","module":"auth-routes","userId":"cbdd5ae1-5b16-4b38-a085-86c9c6281687","email":"protected-test-YKMiiZBfW3AvAE9WEqal7@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mMixed Auth Scenarios[2m > [22m[2mshould prioritize Bearer token over cookie when both present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250218338,"env":"test","module":"auth-routes","userId":"cbdd5ae1-5b16-4b38-a085-86c9c6281687","msg":"User logged in successfully"}
{"level":30,"time":1768250218386,"env":"test","module":"audit-log-service","userId":"cbdd5ae1-5b16-4b38-a085-86c9c6281687","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mMixed Auth Scenarios[2m > [22m[2mshould prioritize Bearer token over cookie when both present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250218892,"env":"test","module":"auth-routes","userId":"cbdd5ae1-5b16-4b38-a085-86c9c6281687","msg":"User logged in successfully"}
{"level":30,"time":1768250218947,"env":"test","module":"audit-log-service","userId":"cbdd5ae1-5b16-4b38-a085-86c9c6281687","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250219303,"env":"test","module":"user-credentials-repository","userId":"f2608845-8338-442c-a77d-79b54af13264","msg":"User credentials created"}
{"level":30,"time":1768250219402,"env":"test","module":"email-queue","jobId":"c3c86b47-7b26-49d9-9838-e295970228f7","to":"user2-fRbsBhlYw12A_L8QiMqYU@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250219452,"env":"test","module":"auth-routes","userId":"f2608845-8338-442c-a77d-79b54af13264","email":"user2-fRbsBhlYw12A_L8QiMqYU@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mMixed Auth Scenarios[2m > [22m[2mshould prioritize Bearer token over cookie when both present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250219954,"env":"test","module":"auth-routes","userId":"f2608845-8338-442c-a77d-79b54af13264","msg":"User logged in successfully"}
{"level":30,"time":1768250220002,"env":"test","module":"audit-log-service","userId":"f2608845-8338-442c-a77d-79b54af13264","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250220461,"env":"test","module":"user-credentials-repository","userId":"1a29985a-03ab-4d9b-b0ae-6c866933f555","msg":"User credentials created"}
{"level":30,"time":1768250220564,"env":"test","module":"email-queue","jobId":"ad8507ee-8a92-4357-b4e3-b533842a805a","to":"protected-test-RgRV_E0YQi1c5cyIQDXph@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250220612,"env":"test","module":"auth-routes","userId":"1a29985a-03ab-4d9b-b0ae-6c866933f555","email":"protected-test-RgRV_E0YQi1c5cyIQDXph@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mOptional Auth Routes[2m > [22m[2mshould allow unauthenticated access to optional auth routes
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250221223,"env":"test","module":"auth-routes","userId":"1a29985a-03ab-4d9b-b0ae-6c866933f555","msg":"User logged in successfully"}
{"level":30,"time":1768250221272,"env":"test","module":"audit-log-service","userId":"1a29985a-03ab-4d9b-b0ae-6c866933f555","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250221799,"env":"test","module":"intake-service","runId":"7637a918-762a-4cdb-8679-1c5e4085e6a3","slug":"public-kVtUr587vDvpkNdYpAkP4","msg":"Created intake run"}
{"level":30,"time":1768250222208,"env":"test","module":"user-credentials-repository","userId":"b14d006c-c53f-440c-8775-154a7c0128fc","msg":"User credentials created"}
{"level":30,"time":1768250222308,"env":"test","module":"email-queue","jobId":"f1023f36-6bc8-4d39-8fb0-82de48292895","to":"protected-test-hFPoIMA7xQhKn_VD_n3pT@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250222356,"env":"test","module":"auth-routes","userId":"b14d006c-c53f-440c-8775-154a7c0128fc","email":"protected-test-hFPoIMA7xQhKn_VD_n3pT@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mOptional Auth Routes[2m > [22m[2mshould enhance optional auth routes with user context when authenticated
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250222956,"env":"test","module":"auth-routes","userId":"b14d006c-c53f-440c-8775-154a7c0128fc","msg":"User logged in successfully"}
{"level":30,"time":1768250223004,"env":"test","module":"audit-log-service","userId":"b14d006c-c53f-440c-8775-154a7c0128fc","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250223513,"env":"test","module":"intake-service","runId":"51921efc-c563-46ef-accf-adf68f3e34e9","slug":"optional-geoywUgTiEK9nbe0NNoRq","userId":"b14d006c-c53f-440c-8775-154a7c0128fc","msg":"Created intake run"}
{"level":30,"time":1768250224031,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250224032,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w3_d400aba4

 [31mÎ“Â¥Â»[39m tests/integration/auth/protected.routes.test.ts [2m([22m[2m33 tests[22m[2m | [22m[31m3 failed[39m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 98994[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow access with valid Bearer token [33m 1256[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject access without Authorization header[39m[33m 890[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject access with empty Bearer token[39m[33m 865[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject access with malformed Authorization header [33m 1202[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject access with wrong token type[39m[33m 866[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow POST with valid Bearer token [33m 1218[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject POST without Bearer token [33m 1188[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject POST with invalid token [33m 1194[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow PUT with valid Bearer token [33m 1340[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject PUT without Bearer token [33m 1196[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow DELETE with valid Bearer token [33m 1336[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject DELETE without Bearer token [33m 1192[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow PATCH with valid Bearer token [33m 1811[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject PATCH without Bearer token [33m 1192[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle Bearer token with extra spaces [33m 1186[2mms[22m[39m
       [2m[90mÎ“Ã¥Ã´[39m[22m should handle token with newlines
       [33m[2mÎ“Â£Ã´[22m[39m should handle very long invalid token [33m 1175[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle empty Authorization header [33m 1201[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle Authorization header with only Bearer [33m 1205[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle multiple Authorization headers [33m 1215[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject token with SQL injection attempt [33m 1200[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject token with XSS attempt [33m 1203[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject token with missing userId [33m 1179[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject token with non-existent userId [33m 1256[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not allow user to access another user's resources [33m 2345[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should inject userId into request context [33m 1219[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should inject tenantId into request context [33m 1209[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should inject role into request context [33m 1193[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not apply general rate limiting to authenticated requests [33m 1611[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle request with both Bearer token and cookies [33m 1798[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prioritize Bearer token over cookie when both present [33m 2897[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow unauthenticated access to optional auth routes [33m 1746[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should enhance optional auth routes with user context when authenticated [33m 1766[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 31 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
AssertionError: expected 401 to be 423 // Object.is equality

- Expected
+ Received

- 423
+ 401

 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:110:36
    108|         });
    109| 
    110|       expect(lockedAttempt.status).toBe(423);
       |                                    ^
    111|       expect(lockedAttempt.body.message || lockedAttempt.body.error).tÎ“Ã‡Âª
    112| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/31]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should record all login attempts
AssertionError: expected 2 to be 3 // Object.is equality

- Expected
+ Received

- 3
+ 2

 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:145:31
    143|       });
    144| 
    145|       expect(attempts.length).toBe(3);
       |                               ^
    146|       expect(attempts.filter(a => !a.successful).length).toBe(2);
    147|       expect(attempts.filter(a => a.successful).length).toBe(1);

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/31]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > MFA Enrollment and Login Flow > should complete MFA setup and login with TOTP
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:203:37
    201|         .send({ email, password });
    202| 
    203|       expect(login2Response.status).toBe(200);
       |                                     ^
    204|       expect(login2Response.body.requiresMfa).toBe(true);
    205|       expect(login2Response.body.userId).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/31]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > MFA Enrollment and Login Flow > should login with backup code when TOTP unavailable
AssertionError: expected undefined to be true // Object.is equality

- Expected: 
true

+ Received: 
undefined

 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:262:47
    260|         .send({ email, password });
    261| 
    262|       expect(login2Response.body.requiresMfa).toBe(true);
       |                                               ^
    263| 
    264|       // Use backup code instead of TOTP

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/31]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Password Reset Flow > should complete full password reset flow
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:346:39
    344|         .send({ email, password: newPassword });
    345| 
    346|       expect(newPasswordLogin.status).toBe(200);
       |                                       ^
    347|       expect(newPasswordLogin.body.token).toBeDefined();
    348|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/31]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Session Management Flow > should list all active sessions
AssertionError: expected 1 to be greater than or equal to 2
 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:494:53
    492|       expect(sessionsResponse.status).toBe(200);
    493|       expect(sessionsResponse.body.sessions).toBeDefined();
    494|       expect(sessionsResponse.body.sessions.length).toBeGreaterThanOrEÎ“Ã‡Âª
       |                                                     ^
    495|     });
    496| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/31]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Session Management Flow > should revoke specific session
TypeError: Cannot read properties of undefined (reading 'find')
 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:517:40
    515| 
    516|       const sessions = sessionsResponse.body.sessions;
    517|       const sessionToRevoke = sessions.find((s: any) => !s.current);
       |                                        ^
    518| 
    519|       // Revoke first session

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[7/31]Î“Ã„Â»

 FAIL  tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
AssertionError: expected 401 to be 423 // Object.is equality

- Expected
+ Received

- 423
+ 401

 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:250:31
    248|         });
    249| 
    250|       expect(response.status).toBe(423);
       |                               ^
    251|       expect(response.body).toBeDefined();
    252|       expect(response.body.error || response.body.message).toBeDefinedÎ“Ã‡Âª

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[8/31]Î“Ã„Â»

 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should return 401 with invalid token
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should authenticate with refresh token cookie (GET only)
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should reject cookie auth for POST requests (mutation-strict)
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should reject cookie auth for DELETE requests
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth/auth.middleware.integration.test.ts:82:33
     80|         }
     81| 
     82|         expect(loginRes.status).toBe(200);
       |                                 ^
     83| 
     84|         userToken = loginRes.body.token;

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[9/31]Î“Ã„Â»

 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should allow cookie auth for HEAD requests
AssertionError: expected [ 200, 404 ] to include 401
 Î“Â¥Â» tests/integration/auth/auth.middleware.integration.test.ts:194:32
    192|                 .set("Cookie", refreshCookie);
    193| 
    194|             expect([200, 404]).toContain(res.status);
       |                                ^
    195|         });
    196| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[10/31]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > Trusted Devices Management > POST /api/auth/trust-device > should update existing trusted device expiry
TypeError: Cannot read properties of undefined (reading 'lastUsedAt')
 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:439:26
    437|         // Expiry should be updated
    438|         expect(devices[0].lastUsedAt?.getTime()).toBeGreaterThan(
    439|           initialDevice!.lastUsedAt?.getTime() || 0
       |                          ^
    440|         );
    441|       });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[11/31]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > Session Metadata Tracking > should update lastUsedAt on token refresh
AssertionError: expected +0 to be 1 // Object.is equality

- Expected
+ Received

- 1
+ 0

 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:590:31
    588|         ));
    589| 
    590|       expect(sessions.length).toBe(1);
       |                               ^
    591|       expect(sessions[0].lastUsedAt).toBeDefined();
    592|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[12/31]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > POST /api/auth/refresh-token > should update refresh token metadata on rotation
AssertionError: expected undefined to be defined
 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:235:24
    233|       });
    234| 
    235|       expect(newToken).toBeDefined();
       |                        ^
    236|       expect(newToken?.lastUsedAt).toBeDefined();
    237|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[13/31]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > POST /api/auth/refresh-token > should set proper cookie attributes
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:283:31
    281|         .set('Cookie', `refresh_token=${testRefreshToken}`);
    282| 
    283|       expect(response.status).toBe(200);
       |                               ^
    284| 
    285|       const setCookieHeader = response.headers['set-cookie']?.[0];

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[14/31]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > Refresh Token Lifecycle > should create refresh token on login
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:316:31
    314|         });
    315| 
    316|       expect(response.status).toBe(200);
       |                               ^
    317| 
    318|       // Verify refresh token cookie is set

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[15/31]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with empty Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access with wrong token type
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:80:14
     78|                 password: testUser.password,
     79|             })
     80|             .expect(200);
       |              ^
     81| 
     82|         userToken = loginRes.body.token;
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[16/31]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > Session Creation and Tracking > should create refresh token on login
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:74:18
     72|                     password: testUser.password,
     73|                 })
     74|                 .expect(200);
       |                  ^
     75| 
     76|             expect(loginRes.headers['set-cookie']).toBeDefined();
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[17/31]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > Session Creation and Tracking > should create separate sessions for multiple device logins
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:120:18
    118|                     password: testUser.password,
    119|                 })
    120|                 .expect(200);
       |                  ^
    121| 
    122|             // Login from device 2
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[18/31]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > GET /api/auth/sessions > should list all active sessions for user
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:172:18
    170|                     password: testUser.password,
    171|                 })
    172|                 .expect(200);
       |                  ^
    173| 
    174|             await request(ctx.baseURL)
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[19/31]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > GET /api/auth/sessions > should mark current session correctly
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:208:18
    206|                     password: testUser.password,
    207|                 })
    208|                 .expect(200);
       |                  ^
    209| 
    210|             await request(ctx.baseURL)
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[20/31]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > GET /api/auth/sessions > should order sessions by last used (most recent first)
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:282:18
    280|                     password: testUser.password,
    281|                 })
    282|                 .expect(200);
       |                  ^
    283| 
    284|             await new Promise(resolve => setTimeout(resolve, 100));
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[21/31]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/:sessionId > should revoke specific session
TypeError: Cannot read properties of undefined (reading 'id')
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:354:60
    352|             // Revoke session2
    353|             await request(ctx.baseURL)
    354|                 .delete(`/api/auth/sessions/${session2Info.id}`)
       |                                                            ^
    355|                 .set("Authorization", `Bearer ${session1.body.token}`)
    356|                 .set("Cookie", session1.headers['set-cookie'])

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[22/31]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/:sessionId > should prevent revoking current session
Error: expected 400 "Bad Request", got 404 "Not Found"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:388:18
    386|                 .set("Authorization", `Bearer ${session.body.token}`)
    387|                 .set("Cookie", session.headers['set-cookie'])
    388|                 .expect(400);
       |                  ^
    389| 
    390|             expect(revokeRes.body.message).toContain("current session"Î“Ã‡Âª
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[23/31]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/:sessionId > should not allow revoking other users sessions
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:417:18
    415|                     password: user2.password,
    416|                 })
    417|                 .expect(200);
       |                  ^
    418| 
    419|             // User1 tries to get user2's sessions
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[24/31]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/:sessionId > should return 404 for non-existent session ID
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:452:18
    450|                     password: testUser.password,
    451|                 })
    452|                 .expect(200);
       |                  ^
    453| 
    454|             await request(ctx.baseURL)
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[25/31]Î“Ã„Â»

 FAIL  tests/integration/auth/session.management.integration.test.ts > Session Management Integration Tests > DELETE /api/auth/sessions/all > should revoke all sessions except current
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/session.management.integration.test.ts:489:18
    487|                     password: testUser.password,
    488|                 })
    489|                 .expect(200);
       |                  ^
    490| 
    491|             // Revoke all from session1
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[26/31]Î“Ã„Â»


[2m Test Files [22m [1m[31m7 failed[39m[22m[2m | [22m[1m[32m5 passed[39m[22m[90m (12)[39m
[2m      Tests [22m [1m[31m31 failed[39m[22m[2m | [22m[1m[32m259 passed[39m[22m[2m | [22m[33m2 skipped[39m[90m (292)[39m
[2m   Start at [22m 14:35:16
[2m   Duration [22m 108.04s[2m (transform 16.54s, setup 3.10s, import 50.74s, tests 637.97s, environment 3ms)[22m

