
> ezbuildr@1.0.0 test
> cross-env VITEST_INTEGRATION=true vitest run --coverage


[1m[46m RUN [49m[22m [36mv4.0.16 [39m[90mC:/Users/scoot/poll/VaultLogic[39m
      [2mCoverage enabled with [22m[33mv8[39m

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w11
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w11,public

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w11 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w11%2Cpublic

{"level":30,"time":1768514568156,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514568206,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w11, public

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w11
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w138.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w138.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w7
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w7,public

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w7 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w7%2Cpublic

{"level":30,"time":1768514568736,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w8
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w8,public

{"level":30,"time":1768514568786,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w8 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w8%2Cpublic

{"level":30,"time":1768514568794,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514568848,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w10
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w10,public

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w7, public

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w9
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w9,public

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w10 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w10%2Cpublic

{"level":30,"time":1768514569158,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w7
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w9 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w9%2Cpublic

{"level":30,"time":1768514569176,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w12
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w12,public

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w8, public

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w11.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w11.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514569220,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w12 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w12%2Cpublic

{"level":30,"time":1768514569234,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514569237,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w8
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768514569286,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w10, public

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w14
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w14,public

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w9, public

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w10
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w14 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w14%2Cpublic

{"level":30,"time":1768514569619,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w9
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w12, public

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w7.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w8.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w7.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w7.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w8.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w7.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514569671,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w12
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w8.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w8.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w8.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w8.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514569724,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768514569725,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768514569728,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768514569730,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768514569729,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768514569743,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768514569789,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w14, public

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w14
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w12.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w10.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w9.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w12.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w10.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514570175,"env":"test","workflowId":"a36992f5-441d-492d-b243-27cc8e49511a","userId":"a612cd20-2532-4ed1-b992-dbac36e2aa65","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w5
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w5,public

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w9.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w0
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0,public

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w4
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w4,public

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w3,public

{"level":50,"time":1768514570230,"env":"test","module":"auth","err":{"type":"TypeError","message":"Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')","stack":"TypeError: Cannot read properties of undefined (reading 'Symbol(drizzle:Columns)')\n    at getTableColumns (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/utils.js:109:15)\n    at PgSelectBuilder.from (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/query-builders/select.js:62:16)\n    at SystemStatsRepository.getOrInitialize (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:18:35)\n    at SystemStatsRepository.incrementUsersCreated (C:/Users/scoot/poll/VaultLogic/server/repositories/SystemStatsRepository.ts:103:16)\n    at UserRepository.upsert (C:/Users/scoot/poll/VaultLogic/server/repositories/UserRepository.ts:95:37)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:69:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"userId":"google-user-123","msg":"Failed to upsert user during authentication"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w1
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w1,public

{"level":50,"time":1768514570233,"env":"test","module":"auth","err":{"type":"Error","message":"Failed to create or update user account","stack":"Error: Failed to create or update user account\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:73:11)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"msg":"Google authentication failed"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w2
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w2,public

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w5 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w5%2Cpublic

{"level":30,"time":1768514570246,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w6
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w6,public

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w0 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0%2Cpublic

{"level":30,"time":1768514570262,"env":"test","msg":"DB: initializing... Local"}
{"level":50,"time":1768514570268,"env":"test","error":{},"msg":"Failed to create connection:"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w4 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w4%2Cpublic

{"level":30,"time":1768514570275,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w3 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w3%2Cpublic

{"level":30,"time":1768514570277,"env":"test","msg":"DB: initializing... Local"}
{"level":50,"time":1768514570278,"env":"test","module":"ai-workflow-edit-routes","error":{"query":"select \"id\", \"scope\", \"system_prompt\", \"updated_by\", \"created_at\", \"updated_at\" from \"ai_settings\" \"aiSettings\" where \"aiSettings\".\"scope\" = $1 limit $2","params":["global",1],"cause":{"length":178,"name":"error","severity":"ERROR","code":"42703","hint":"Perhaps you meant to reference the column \"aiSettings.updated_at\".","position":"54","file":"parse_relation.c","line":"3723","routine":"errorMissingColumn"}},"workflowId":"a36992f5-441d-492d-b243-27cc8e49511a","msg":"AI model call failed"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w1 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w1%2Cpublic

{"level":30,"time":1768514570286,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w2 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w2%2Cpublic

{"level":30,"time":1768514570294,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514570296,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w6 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w6%2Cpublic

{"level":30,"time":1768514570299,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514570314,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514570323,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514570331,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514570337,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514570343,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514570347,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768514570427,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:168:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
{"level":50,"time":1768514570427,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:168:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google authentication failed"}
{"level":40,"time":1768514570481,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768514570481,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:158:23"},"msg":"Google token verification failed"}
{"level":50,"time":1768514570481,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:158:23"},"msg":"Google authentication failed"}
{"level":40,"time":1768514570520,"env":"test","msg":"Failed to parse legacy string condition: \"trigger == \", defaulting to visible"}
{"level":40,"time":1768514570520,"env":"test","msg":"Failed to parse legacy string condition: \"trigger == \", defaulting to visible"}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w5, public

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w0, public

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w4, public

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w3, public

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w1, public

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w5
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w2, public

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w6, public

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w0
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w4
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w1
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w3
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w2
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w14.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w14.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w6
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w14.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w14.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w14.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w14.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w14.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w14.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w14.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w14.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w14.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w14.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514570778,"env":"test","workflowId":"a4d1353c-2474-4a83-bd59-dbf298ef1cb5","userId":"a612cd20-2532-4ed1-b992-dbac36e2aa65","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mDEBUG: Existing functions: []

{"level":50,"time":1768514570874,"env":"test","module":"ai-workflow-edit-routes","error":{"query":"select \"id\", \"scope\", \"system_prompt\", \"updated_by\", \"created_at\", \"updated_at\" from \"ai_settings\" \"aiSettings\" where \"aiSettings\".\"scope\" = $1 limit $2","params":["global",1],"cause":{"length":178,"name":"error","severity":"ERROR","code":"42703","hint":"Perhaps you meant to reference the column \"aiSettings.updated_at\".","position":"54","file":"parse_relation.c","line":"3723","routine":"errorMissingColumn"}},"workflowId":"a4d1353c-2474-4a83-bd59-dbf298ef1cb5","msg":"AI model call failed"}
{"level":30,"time":1768514570917,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514570918,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768514570934,"env":"test","module":"auth","email":"existing@example.com","msg":"OAuth2 login successful"}
 [31m‚ùØ[39m tests/integration/regression-REG-1.test.ts [2m([22m[2m8 tests[22m[2m | [22m[31m5 failed[39m[2m)[22m[33m 3195[2mms[22m[39m
[31m       [31m√ó[31m should block Next when required visible question is empty[39m[32m 54[2mms[22m[39m
[31m       [31m√ó[31m should NOT block Next when required question is hidden[39m[33m 328[2mms[22m[39m
[31m       [31m√ó[31m should block when required becomes visible and is empty[39m[33m 341[2mms[22m[39m
[31m       [31m√ó[31m should skip hidden required page entirely[39m[33m 349[2mms[22m[39m
[31m       [31m√ó[31m should enforce required on visible page[39m[33m 339[2mms[22m[39m
       [32m‚úì[39m should evaluate visibility consistently across modes[32m 2[2mms[22m[39m
       [32m‚úì[39m should handle malformed visibility expression gracefully[32m 1[2mms[22m[39m
       [32m‚úì[39m should handle missing variable in visibility expression[32m 0[2mms[22m[39m
{"level":50,"time":1768514571146,"env":"test","error":{},"msg":"Failed to create connection:"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w13
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w13,public

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w13 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w13%2Cpublic

{"level":30,"time":1768514571240,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514571279,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514571342,"env":"test","workflowId":"bcdb2fc4-66d5-414b-a107-1c399988d6cd","userId":"a612cd20-2532-4ed1-b992-dbac36e2aa65","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":30,"time":1768514571349,"env":"test","module":"auth","email":"refresh@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1768514571380,"env":"test","module":"user-credentials-repository","userId":"B1R--TJT9rlEkf_q8v-E9","msg":"User credentials created"}
{"level":30,"time":1768514571409,"env":"test","module":"user-credentials-repository","userId":"5a9e1a5b-7dbc-4e1b-9e86-03b3d89c8428","msg":"User credentials created"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould complete full MFA setup flow
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514571428,"env":"test","module":"user-credentials-repository","userId":"D53UBS006VecYgaghoBsu","msg":"User credentials created"}
{"level":50,"time":1768514571434,"env":"test","module":"ai-workflow-edit-routes","error":{"query":"select \"id\", \"scope\", \"system_prompt\", \"updated_by\", \"created_at\", \"updated_at\" from \"ai_settings\" \"aiSettings\" where \"aiSettings\".\"scope\" = $1 limit $2","params":["global",1],"cause":{"length":178,"name":"error","severity":"ERROR","code":"42703","hint":"Perhaps you meant to reference the column \"aiSettings.updated_at\".","position":"54","file":"parse_relation.c","line":"3723","routine":"errorMissingColumn"}},"workflowId":"bcdb2fc4-66d5-414b-a107-1c399988d6cd","msg":"AI model call failed"}
{"level":30,"time":1768514571455,"env":"test","module":"auth-service","tokenHash":"14dfb41b6a8b9a019408a547b1bcd1fbef9ef08b420f59c1bd1f892f4cb1f3bf","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768514571460,"env":"test","module":"user-credentials-repository","userId":"32ab13e6-3d81-41c6-8e15-0ccf1d17b3ca","msg":"User credentials created"}
{"level":30,"time":1768514571512,"env":"test","module":"email-queue","jobId":"c65dfb00-9a6f-4f67-b7ac-159d314e1c3c","to":"test-1768514571003-wbzo4@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for 33cef285268f557e0d2fc4e1dbbaaabd

{"level":30,"time":1768514571562,"env":"test","module":"email-queue","jobId":"d0677fc0-6782-4319-8f98-6e67b183bc38","to":"test-1768514571045-wdffvw@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768514571566,"env":"test","module":"auth-routes","userId":"5a9e1a5b-7dbc-4e1b-9e86-03b3d89c8428","email":"test-1768514571003-wbzo4@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mComplete Registration ‚Üí Login Flow[2m > [22m[2mshould complete registration, verify email, then login
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w13, public

{"level":30,"time":1768514571616,"env":"test","module":"auth-routes","userId":"32ab13e6-3d81-41c6-8e15-0ccf1d17b3ca","email":"test-1768514571045-wdffvw@example.com","msg":"User registered"}
{"level":30,"time":1768514571624,"env":"test","module":"auth-routes","userId":"D53UBS006VecYgaghoBsu","sessionCount":2,"msg":"Listed active sessions"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w13
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w6.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w1.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w2.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w4.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w0.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w5.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w6.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514571744,"env":"test","module":"auth","email":"idtoken@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1768514571755,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514571756,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w1.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514571795,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514571796,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/integration/externalSends.test.ts [2m([22m[2m2 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 2577[2mms[22m[39m
[31m     [31m√ó[31m PREVIEW MODE: Should simulate send and NOT call fetch[39m[32m 61[2mms[22m[39m
[31m     [31m√ó[31m LIVE MODE: Should call fetch with mapped payload[39m[33m 332[2mms[22m[39m
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w2.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39mDEBUG: LOGIN HANDLER HIT

 [31m‚ùØ[39m tests/integration/auth/oauth2.callback.test.ts [2m([22m[2m16 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 2999[2mms[22m[39m
[31m       [31m√ó[31m should initiate OAuth2 3-legged flow and generate authorization URL[39m[32m 165[2mms[22m[39m
       [32m‚úì[39m should include optional scope in authorization URL[32m 100[2mms[22m[39m
       [32m‚úì[39m should validate valid OAuth2 state token[32m 89[2mms[22m[39m
       [32m‚úì[39m should reject invalid OAuth2 state token[32m 93[2mms[22m[39m
       [32m‚úì[39m should reject expired OAuth2 state token[32m 89[2mms[22m[39m
       [32m‚úì[39m should clean up OAuth2 state after use[32m 94[2mms[22m[39m
       [32m‚úì[39m should handle callback with missing state parameter[32m 90[2mms[22m[39m
       [32m‚úì[39m should handle callback with missing code parameter[32m 96[2mms[22m[39m
       [32m‚úì[39m should handle OAuth2 provider error responses[32m 95[2mms[22m[39m
[31m       [31m√ó[31m should track OAuth2 connection status[39m[32m 111[2mms[22m[39m
       [32m‚úì[39m should store OAuth2 state in connection metadata[32m 98[2mms[22m[39m
       [32m‚úì[39m should use cryptographically secure random state[32m 105[2mms[22m[39m
       [32m‚úì[39m should prevent state reuse after validation[32m 94[2mms[22m[39m
       [32m‚úì[39m should include PKCE support metadata in state record[32m 90[2mms[22m[39m
       [32m‚úì[39m should validate redirect URI matches allowed URIs[32m 90[2mms[22m[39m
       [32m‚úì[39m should encode redirect URI in authorization URL[32m 103[2mms[22m[39m
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w4.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514571885,"env":"test","module":"auth-routes","userId":"03d55b811b84c0bfa75220f591927581","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w0.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514571924,"env":"test","module":"auth-routes","userId":"05e9552b1abf9ca0287fe0f9bbbd628a","msg":"User logged in successfully"}
{"level":30,"time":1768514571929,"env":"test","workflowId":"0ad9a832-979a-4df1-bb71-273cfb72f246","userId":"a612cd20-2532-4ed1-b992-dbac36e2aa65","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":50,"time":1768514571934,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["03d55b811b84c0bfa75220f591927581","login_success","security","03d55b811b84c0bfa75220f591927581","{\"metadata\":{\"timestamp\":\"2026-01-15T22:02:51.885Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:02:51.885Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"03d55b811b84c0bfa75220f591927581","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514571934,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["03d55b811b84c0bfa75220f591927581","login_success","security","03d55b811b84c0bfa75220f591927581","{\"metadata\":{\"timestamp\":\"2026-01-15T22:02:51.885Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:02:51.885Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":40,"time":1768514571959,"env":"test","module":"auth-routes","userId":"5a9e1a5b-7dbc-4e1b-9e86-03b3d89c8428","email":"test-1768514571003-wbzo4@example.com","msg":"Login blocked: email not verified"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w3.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768514571959,"env":"test","module":"auth-routes","error":{"name":"EmailNotVerifiedError","code":"AUTH_006","statusCode":403,"isOperational":true},"msg":"Login failed"}
{"level":30,"time":1768514571974,"env":"test","module":"user-credentials-repository","userId":"MX-p9gnUnX0FjSNgZM7qo","msg":"User credentials created"}
{"level":50,"time":1768514571975,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["05e9552b1abf9ca0287fe0f9bbbd628a","login_success","security","05e9552b1abf9ca0287fe0f9bbbd628a","{\"metadata\":{\"timestamp\":\"2026-01-15T22:02:51.925Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-15T22:02:51.925Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"05e9552b1abf9ca0287fe0f9bbbd628a","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514571975,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["05e9552b1abf9ca0287fe0f9bbbd628a","login_success","security","05e9552b1abf9ca0287fe0f9bbbd628a","{\"metadata\":{\"timestamp\":\"2026-01-15T22:02:51.925Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-15T22:02:51.925Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514572004,"env":"test","module":"user-credentials-repository","userId":"t6CxKzK-yzUKdYtlWQ91y","msg":"User credentials created"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w5.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mComplete Registration ‚Üí Login Flow[2m > [22m[2mshould complete registration, verify email, then login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768514572032,"env":"test","module":"ai-workflow-edit-routes","error":{"query":"select \"id\", \"scope\", \"system_prompt\", \"updated_by\", \"created_at\", \"updated_at\" from \"ai_settings\" \"aiSettings\" where \"aiSettings\".\"scope\" = $1 limit $2","params":["global",1],"cause":{"length":178,"name":"error","severity":"ERROR","code":"42703","hint":"Perhaps you meant to reference the column \"aiSettings.updated_at\".","position":"54","file":"parse_relation.c","line":"3723","routine":"errorMissingColumn"}},"workflowId":"0ad9a832-979a-4df1-bb71-273cfb72f246","msg":"AI model call failed"}
{"level":30,"time":1768514572058,"env":"test","module":"auth-service","tokenHash":"31c0a47f77bc2b566ddec8d9a600f63218fb7514be23c6db4312e648f3fd0e20","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768514572074,"env":"test","module":"auth-routes","userId":"MX-p9gnUnX0FjSNgZM7qo","sessionCount":1,"msg":"Listed active sessions"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768514572141,"env":"test","module":"auth","email":"minimal@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1768514572157,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768514572158,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39müßπ Cleaning up test environment...

 [31m‚ùØ[39m tests/integration/variableSafety.test.ts [2m([22m[2m4 tests[22m[2m | [22m[31m4 failed[39m[2m)[22m[33m 3422[2mms[22m[39m
[31m     [31m√ó[31m REPRO: ScriptEngine fails to resolve alias 'input_variable' when aliasMap is NOT provided[39m[32m 198[2mms[22m[39m
[31m     [31m√ó[31m ScriptEngine resolves alias 'input_variable' when aliasMap is provided[39m[33m 494[2mms[22m[39m
[31m     [31m√ó[31m REPRO: BlockRunner fails to resolve alias in CreateRecordConfig[39m[33m 468[2mms[22m[39m
[31m     [31m√ó[31m BlockRunner logic resolves alias with aliasMap[39m[33m 486[2mms[22m[39m
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w15
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w15,public

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

{"level":50,"time":1768514572238,"env":"test","module":"auth","err":{"type":"Error","message":"Token verification failed","stack":"Error: Token verification failed\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:431:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w15 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w15%2Cpublic

{"level":30,"time":1768514572280,"env":"test","msg":"DB: initializing... Local"}
{"level":40,"time":1768514572290,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768514572290,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
{"level":30,"time":1768514572307,"env":"test","module":"auth-routes","userId":"33cef285268f557e0d2fc4e1dbbaaabd","msg":"Login requires MFA verification"}
{"level":30,"time":1768514572322,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768514572336,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token payload","stack":"Error: Invalid token payload\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:88:26)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
{"level":30,"time":1768514572396,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514572396,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768514572400,"env":"test","module":"user-credentials-repository","userId":"F4fVggduLVVkOVmITsz87","msg":"User credentials created"}
{"level":30,"time":1768514572410,"env":"test","module":"mfa-service","userId":"33cef285268f557e0d2fc4e1dbbaaabd","msg":"TOTP verification successful"}
 [31m‚ùØ[39m tests/integration/auth/oauth2.google.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 3642[2mms[22m[39m
[31m       [31m√ó[31m should successfully authenticate with valid Google ID token[39m[32m 249[2mms[22m[39m
       [32m‚úì[39m should return 400 when ID token is missing[32m 70[2mms[22m[39m
       [32m‚úì[39m should return 403 when Origin header is invalid[32m 53[2mms[22m[39m
       [32m‚úì[39m should return 401 when Google token verification fails[32m 57[2mms[22m[39m
       [32m‚úì[39m should return 401 when email is not verified by Google[32m 54[2mms[22m[39m
       [33m[2m‚úì[22m[39m should update existing user on subsequent logins [33m 503[2mms[22m[39m
       [33m[2m‚úì[22m[39m should create refresh token record in database [33m 415[2mms[22m[39m
       [33m[2m‚úì[22m[39m should support both "token" and "idToken" fields [33m 345[2mms[22m[39m
       [32m‚úì[39m should respect rate limiting[32m 43[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle missing profile information gracefully [33m 354[2mms[22m[39m
       [32m‚úì[39m should verify valid Google ID token[32m 46[2mms[22m[39m
       [32m‚úì[39m should throw error when token verification fails[32m 50[2mms[22m[39m
       [32m‚úì[39m should throw error when email is not verified[32m 50[2mms[22m[39m
       [32m‚úì[39m should throw error when payload is null[32m 46[2mms[22m[39m
{"level":30,"time":1768514572479,"env":"test","module":"auth-routes","userId":"33cef285268f557e0d2fc4e1dbbaaabd","msg":"MFA login successful"}
{"level":30,"time":1768514572482,"env":"test","workflowId":"606171a1-e15d-4114-a725-19a8b265e545","userId":"a612cd20-2532-4ed1-b992-dbac36e2aa65","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":30,"time":1768514572490,"env":"test","module":"auth-routes","userId":"5a9e1a5b-7dbc-4e1b-9e86-03b3d89c8428","msg":"User logged in successfully"}
{"level":30,"time":1768514572499,"env":"test","module":"auth-routes","userId":"F4fVggduLVVkOVmITsz87","sessionCount":0,"msg":"Listed active sessions"}
{"level":50,"time":1768514572546,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["5a9e1a5b-7dbc-4e1b-9e86-03b3d89c8428","login_success","security","5a9e1a5b-7dbc-4e1b-9e86-03b3d89c8428","{\"metadata\":{\"timestamp\":\"2026-01-15T22:02:52.490Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:02:52.491Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"5a9e1a5b-7dbc-4e1b-9e86-03b3d89c8428","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514572546,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["5a9e1a5b-7dbc-4e1b-9e86-03b3d89c8428","login_success","security","5a9e1a5b-7dbc-4e1b-9e86-03b3d89c8428","{\"metadata\":{\"timestamp\":\"2026-01-15T22:02:52.490Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:02:52.491Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768514572577,"env":"test","module":"ai-workflow-edit-routes","error":{"query":"select \"id\", \"scope\", \"system_prompt\", \"updated_by\", \"created_at\", \"updated_at\" from \"ai_settings\" \"aiSettings\" where \"aiSettings\".\"scope\" = $1 limit $2","params":["global",1],"cause":{"length":178,"name":"error","severity":"ERROR","code":"42703","hint":"Perhaps you meant to reference the column \"aiSettings.updated_at\".","position":"54","file":"parse_relation.c","line":"3723","routine":"errorMissingColumn"}},"workflowId":"606171a1-e15d-4114-a725-19a8b265e545","msg":"AI model call failed"}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

{"level":30,"time":1768514572648,"env":"test","module":"auth-routes","userId":"33cef285268f557e0d2fc4e1dbbaaabd","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768514572651,"env":"test","module":"user-credentials-repository","userId":"1832f298-b357-412a-987b-b3cebfac7b58","msg":"User credentials created"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w16
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w16,public

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w15, public

{"level":30,"time":1768514572699,"env":"test","module":"user-credentials-repository","userId":"_TohP0lvxkBFkw8osJ_ff","msg":"User credentials created"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w16 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w16%2Cpublic

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w15
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768514572748,"env":"test","module":"email-queue","jobId":"f6ebd0e4-d205-4861-bad1-d07d50dcacba","to":"test-1768514572266-16q7v@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768514572790,"env":"test","module":"auth-routes","userId":"05e9552b1abf9ca0287fe0f9bbbd628a","msg":"User logged in successfully"}
{"level":30,"time":1768514572796,"env":"test","module":"auth-routes","userId":"1832f298-b357-412a-987b-b3cebfac7b58","email":"test-1768514572266-16q7v@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w13.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w13.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768514572839,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["05e9552b1abf9ca0287fe0f9bbbd628a","login_success","security","05e9552b1abf9ca0287fe0f9bbbd628a","{\"metadata\":{\"timestamp\":\"2026-01-15T22:02:52.790Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (iPhone; CPU iPhone OS 14_0)","2026-01-15T22:02:52.790Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"05e9552b1abf9ca0287fe0f9bbbd628a","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514572839,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["05e9552b1abf9ca0287fe0f9bbbd628a","login_success","security","05e9552b1abf9ca0287fe0f9bbbd628a","{\"metadata\":{\"timestamp\":\"2026-01-15T22:02:52.790Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (iPhone; CPU iPhone OS 14_0)","2026-01-15T22:02:52.790Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514572850,"env":"test","module":"user-credentials-repository","userId":"ShfRAdw1qv4St-Ba612Uk","msg":"User credentials created"}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514572952,"env":"test","module":"auth-routes","userId":"ShfRAdw1qv4St-Ba612Uk","sessionCount":0,"msg":"Listed active sessions"}
{"level":30,"time":1768514573013,"env":"test","workflowId":"d5a362ff-7ff1-4ef4-bc0c-74aab46db922","userId":"a612cd20-2532-4ed1-b992-dbac36e2aa65","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":30,"time":1768514573083,"env":"test","module":"user-credentials-repository","userId":"7a5nHrQw7R24e9XKRCZtA","msg":"User credentials created"}
{"level":50,"time":1768514573106,"env":"test","module":"ai-workflow-edit-routes","error":{"query":"select \"id\", \"scope\", \"system_prompt\", \"updated_by\", \"created_at\", \"updated_at\" from \"ai_settings\" \"aiSettings\" where \"aiSettings\".\"scope\" = $1 limit $2","params":["global",1],"cause":{"length":178,"name":"error","severity":"ERROR","code":"42703","hint":"Perhaps you meant to reference the column \"aiSettings.updated_at\".","position":"54","file":"parse_relation.c","line":"3723","routine":"errorMissingColumn"}},"workflowId":"d5a362ff-7ff1-4ef4-bc0c-74aab46db922","msg":"AI model call failed"}
{"level":30,"time":1768514573136,"env":"test","module":"auth-service","tokenHash":"2fe6f7ff0fa9bd1ee1eb2b4de4567a52a13546270f31f9607e884393806b0e0c","plainTokenLen":19,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768514573186,"env":"test","module":"auth-service","tokenHash":"2fe6f7ff0fa9bd1ee1eb2b4de4567a52a13546270f31f9607e884393806b0e0c","msg":"Security: Unknown refresh token used (Not Found in DB)"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould reject invalid TOTP code during setup
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514573273,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514573278,"env":"test","module":"user-credentials-repository","userId":"4Pgz-wpT3a9iG-hI8RUx7","msg":"User credentials created"}
{"level":30,"time":1768514573309,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514573427,"env":"test","module":"auth-routes","userId":"4Pgz-wpT3a9iG-hI8RUx7","sessionCount":1,"msg":"Listed active sessions"}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w17
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w17,public

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w17 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w17%2Cpublic

{"level":30,"time":1768514573486,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514573522,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w18
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w18,public

{"level":30,"time":1768514573612,"env":"test","module":"auth-service","allTokensCount":5441,"sampleToken":"2b484d683e217a5794883c3321285a69f23da26d5e0f749725f993d77b121982","msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768514573619,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514573619,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768514573620,"env":"test","module":"auth-routes","userId":"05e9552b1abf9ca0287fe0f9bbbd628a","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w16, public

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w18 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w18%2Cpublic

{"level":30,"time":1768514573655,"env":"test","msg":"DB: initializing... Local"}
{"level":50,"time":1768514573670,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["05e9552b1abf9ca0287fe0f9bbbd628a","login_success","security","05e9552b1abf9ca0287fe0f9bbbd628a","{\"metadata\":{\"timestamp\":\"2026-01-15T22:02:53.620Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)","2026-01-15T22:02:53.620Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"05e9552b1abf9ca0287fe0f9bbbd628a","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514573671,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["05e9552b1abf9ca0287fe0f9bbbd628a","login_success","security","05e9552b1abf9ca0287fe0f9bbbd628a","{\"metadata\":{\"timestamp\":\"2026-01-15T22:02:53.620Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)","2026-01-15T22:02:53.620Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768514573677,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w16
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768514573688,"env":"test","workflowId":"190563d7-692c-41ae-b2fd-06c925b3e692","userId":"a612cd20-2532-4ed1-b992-dbac36e2aa65","sectionsCount":1,"stepsCount":1,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":30,"time":1768514573689,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514573703,"env":"test","module":"auth-routes","userId":"3bf0573d3b12d874d0abc3c671a03e46","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w15.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w15.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768514573750,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["3bf0573d3b12d874d0abc3c671a03e46","login_success","security","3bf0573d3b12d874d0abc3c671a03e46","{\"metadata\":{\"timestamp\":\"2026-01-15T22:02:53.703Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:02:53.703Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"3bf0573d3b12d874d0abc3c671a03e46","eventType":"login_success","msg":"Failed to log security event"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39m[TEST UTILS] MFA Secret verified for 95e9484f85d0bc732a76db8ce9011f0b

{"level":50,"time":1768514573750,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["3bf0573d3b12d874d0abc3c671a03e46","login_success","security","3bf0573d3b12d874d0abc3c671a03e46","{\"metadata\":{\"timestamp\":\"2026-01-15T22:02:53.703Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:02:53.703Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768514573755,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768514573756,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768514573756,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768514573757,"env":"test","module":"user-credentials-repository","userId":"s2fmNaAiVTC-N59iG7lK0","msg":"User credentials created"}
 [31m‚ùØ[39m tests/integration/dataBlocks.test.ts [2m([22m[2m2 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 2800[2mms[22m[39m
[31m     [31m√ó[31m should write data to DataVault via WriteBlock[39m[32m 107[2mms[22m[39m
[31m     [31m√ó[31m should query data from DataVault via QueryBlock and use in Logic[39m[33m 344[2mms[22m[39m
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":50,"time":1768514573762,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768514573782,"env":"test","module":"ai-workflow-edit-routes","error":{"query":"select \"id\", \"scope\", \"system_prompt\", \"updated_by\", \"created_at\", \"updated_at\" from \"ai_settings\" \"aiSettings\" where \"aiSettings\".\"scope\" = $1 limit $2","params":["global",1],"cause":{"length":178,"name":"error","severity":"ERROR","code":"42703","hint":"Perhaps you meant to reference the column \"aiSettings.updated_at\".","position":"54","file":"parse_relation.c","line":"3723","routine":"errorMissingColumn"}},"workflowId":"190563d7-692c-41ae-b2fd-06c925b3e692","msg":"AI model call failed"}
 [31m‚ùØ[39m tests/integration/workflow_versioning.test.ts [2m([22m[2m3 tests[22m[2m | [22m[33m3 skipped[39m[2m)[22m[33m 1897[2mms[22m[39m
     [2m[90m‚Üì[39m[22m should diff two versions correctly
     [2m[90m‚Üì[39m[22m should create a version and populate changelog
     [2m[90m‚Üì[39m[22m should track execution lineage via snapshot
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514573850,"env":"test","module":"user-credentials-repository","userId":"344608ba-3160-42e1-9e54-5b8a361c5254","msg":"User credentials created"}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w17, public

{"level":30,"time":1768514573866,"env":"test","module":"auth-routes","userId":"s2fmNaAiVTC-N59iG7lK0","sessionCount":1,"msg":"Listed active sessions"}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w17
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768514573961,"env":"test","module":"user-credentials-repository","userId":"Ulwttamh8sPkOsi4x8d22","msg":"User credentials created"}
{"level":30,"time":1768514573961,"env":"test","module":"email-queue","jobId":"5d9ec91e-c560-4664-917a-9c2dd1b131aa","to":"test-1768514573481-gyoche@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w16.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w16.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768514573994,"env":"test","module":"workflow-patch-service","error":{},"op":{"op":"step.create","sectionRef":"temp-section-1","type":"short_text","title":"Field 1","alias":"field1"},"msg":"Failed to apply operation"}
{"level":30,"time":1768514574009,"env":"test","module":"auth-routes","userId":"344608ba-3160-42e1-9e54-5b8a361c5254","email":"test-1768514573481-gyoche@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":50,"time":1768514574016,"env":"test","module":"workflow-patch-service","error":{},"op":{"op":"document.bindFields","id":"template-123","bindings":{"client_name":"nonExistentAlias"}},"msg":"Failed to apply operation"}
{"level":30,"time":1768514574019,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768514574020,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/unit/services/WorkflowPatchService.test.ts [2m([22m[2m21 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 1748[2mms[22m[39m
       [32m‚úì[39m should resolve section tempId to real UUID when creating step[32m 9[2mms[22m[39m
       [32m‚úì[39m should handle multi-level tempId references[32m 2[2mms[22m[39m
       [32m‚úì[39m should reject duplicate step alias on create[32m 1[2mms[22m[39m
       [32m‚úì[39m should allow same alias on update of same step[32m 1[2mms[22m[39m
       [32m‚úì[39m should reject duplicate alias on update to different step[32m 1[2mms[22m[39m
       [32m‚úì[39m should reject completely unknown operation[32m 1[2mms[22m[39m
       [32m‚úì[39m should reject malformed operation (missing required fields)[32m 1[2mms[22m[39m
       [32m‚úì[39m should reject unsafe DataVault operations (dropTable)[32m 1[2mms[22m[39m
       [32m‚úì[39m should reject unsafe DataVault operations (dropColumn)[32m 1[2mms[22m[39m
       [32m‚úì[39m should reject unsafe DataVault operations (deleteRows)[32m 0[2mms[22m[39m
       [32m‚úì[39m should reject unsafe DataVault operations (updateRowData)[32m 0[2mms[22m[39m
       [32m‚úì[39m should allow safe DataVault operations (createTable, addColumns)[32m 1[2mms[22m[39m
       [32m‚úì[39m should rollback all ops if any op fails[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should clear tempId mappings between batch calls[39m[32m 10[2mms[22m[39m
       [32m‚úì[39m should create visibility rule on step[32m 3[2mms[22m[39m
       [32m‚úì[39m should parse complex condition expressions[32m 1[2mms[22m[39m
       [32m‚úì[39m should attach document to workflow (document.add)[32m 2[2mms[22m[39m
       [32m‚úì[39m should bind document fields to workflow variables (document.bindFields)[32m 6[2mms[22m[39m
[31m       [31m√ó[31m should reject binding to non-existent step alias[39m[32m 1[2mms[22m[39m
       [32m‚úì[39m should create DataVault table with columns (datavault.createTable)[32m 1[2mms[22m[39m
       [32m‚úì[39m should create writeback mapping (datavault.createWritebackMapping)[32m 1[2mms[22m[39m
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w18, public

{"level":30,"time":1768514574061,"env":"test","module":"auth-service","tokenHash":"719d4f34fd9de961e8180db389d381f3f2fb25ec3f7287005acb16280bd0a506","plainTokenLen":17,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w18
‚è© Schema reused, skipping migrations.

{"level":40,"time":1768514574112,"env":"test","module":"auth-service","tokenHash":"719d4f34fd9de961e8180db389d381f3f2fb25ec3f7287005acb16280bd0a506","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768514574132,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514574133,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w17.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w17.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514574191,"env":"test","module":"user-credentials-repository","userId":"DqSR6IOCQmOlxgrgG4F1b","msg":"User credentials created"}
 [31m‚ùØ[39m tests/integration/ai/workflowEdit.test.ts [2m([22m[2m8 tests[22m[2m | [22m[31m7 failed[39m[2m)[22m[33m 5766[2mms[22m[39m
[31m     [31m√ó[31m should create draft version on successful AI edit[39m[33m 600[2mms[22m[39m
[31m     [31m√ó[31m should enforce draft mode (revert active workflow to draft)[39m[33m 587[2mms[22m[39m
[31m     [31m√ó[31m should not create version when no changes detected (checksum match)[39m[33m 560[2mms[22m[39m
     [32m‚úì[39m should reject unauthorized access[32m 58[2mms[22m[39m
[31m     [31m√ó[31m should reject unsafe DataVault operations[39m[33m 540[2mms[22m[39m
[31m     [31m√ó[31m should handle multi-operation edits with tempId resolution[39m[33m 545[2mms[22m[39m
[31m     [31m√ó[31m should create BEFORE and AFTER snapshots[39m[33m 528[2mms[22m[39m
[31m     [31m√ó[31m should rollback on validation failure[39m[33m 676[2mms[22m[39m
{"level":50,"time":1768514574196,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768514574205,"env":"test","module":"auth-routes","email":"test-1768514573452-9lqhk@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":50,"time":1768514574300,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514574414,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768514574414,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould login with valid credentials
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514574440,"env":"test","module":"auth-service","allTokensCount":5447,"sampleToken":"2b484d683e217a5794883c3321285a69f23da26d5e0f749725f993d77b121982","msg":"DEBUG: Tokens in DB"}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

 [31m‚ùØ[39m tests/integration/analytics_preservation.test.ts [2m([22m[2m1 test[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 1170[2mms[22m[39m
[31m     [31m√ó[31m should preserve lifetime user count when a user is deleted[39m[32m 7[2mms[22m[39m
{"level":30,"time":1768514574550,"env":"test","module":"auth-routes","userId":"95e9484f85d0bc732a76db8ce9011f0b","msg":"Login requires MFA verification"}
{"level":30,"time":1768514574559,"env":"test","module":"user-credentials-repository","userId":"ujhk4UgxfKk0IviEv8UGO","msg":"User credentials created"}
{"level":30,"time":1768514574647,"env":"test","module":"mfa-service","userId":"95e9484f85d0bc732a76db8ce9011f0b","msg":"TOTP verification successful"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768514574700,"env":"test","module":"auth-routes","userId":"95e9484f85d0bc732a76db8ce9011f0b","msg":"MFA login successful"}
{"level":50,"time":1768514574707,"env":"test","module":"auth-routes","email":"test-1768514573452-9lqhk@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768514574710,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514574711,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/integration/collections.e2e.test.ts [2m([22m[2m22 tests[22m[2m | [22m[33m22 skipped[39m[2m)[22m[33m 1647[2mms[22m[39m
       [2m[90m‚Üì[39m[22m should create a collection
       [2m[90m‚Üì[39m[22m should list collections
       [2m[90m‚Üì[39m[22m should get a collection by ID
       [2m[90m‚Üì[39m[22m should update a collection
       [2m[90m‚Üì[39m[22m should create text field
       [2m[90m‚Üì[39m[22m should create email field
       [2m[90m‚Üì[39m[22m should create number field
       [2m[90m‚Üì[39m[22m should create select field with options
       [2m[90m‚Üì[39m[22m should create boolean field
       [2m[90m‚Üì[39m[22m should list all fields
       [2m[90m‚Üì[39m[22m should update field
       [2m[90m‚Üì[39m[22m should create a record
       [2m[90m‚Üì[39m[22m should create multiple records
       [2m[90m‚Üì[39m[22m should list records with pagination
       [2m[90m‚Üì[39m[22m should get a single record
       [2m[90m‚Üì[39m[22m should update a record
       [2m[90m‚Üì[39m[22m should find records by filters
       [2m[90m‚Üì[39m[22m should delete a record
       [2m[90m‚Üì[39m[22m should list collections with stats
       [2m[90m‚Üì[39m[22m should enforce required fields
       [2m[90m‚Üì[39m[22m should validate field types
       [2m[90m‚Üì[39m[22m should delete collection (cascade fields and records)
{"level":30,"time":1768514574769,"env":"test","module":"auth-routes","userId":"ujhk4UgxfKk0IviEv8UGO","sessionId":"0301923d-6dc9-4f9b-8751-de83c014ea6d","msg":"Session revoked"}
{"level":30,"time":1768514574784,"env":"test","module":"user-credentials-repository","userId":"dD2GStkBMDG1fcTbU47G2","msg":"User credentials created"}
{"level":50,"time":1768514574819,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514574864,"env":"test","module":"auth-routes","userId":"95e9484f85d0bc732a76db8ce9011f0b","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768514574887,"env":"test","module":"auth-service","tokenHash":"e43a99d05d5077776ab290777d2eeaf361f2a1b860feacb6d7e7e977ee3bc8ce","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768514574924,"env":"test","module":"auth-routes","userId":"fc210d59b5168bd72a88bccbaa8c0b58","msg":"User logged in successfully"}
{"level":40,"time":1768514574932,"env":"test","module":"auth-service","userId":"dD2GStkBMDG1fcTbU47G2","tokenHash":"e43a99d05d5077776ab290777d2eeaf361f2a1b860feacb6d7e7e977ee3bc8ce","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":50,"time":1768514574976,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["fc210d59b5168bd72a88bccbaa8c0b58","login_success","security","fc210d59b5168bd72a88bccbaa8c0b58","{\"metadata\":{\"timestamp\":\"2026-01-15T22:02:54.925Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:02:54.925Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"fc210d59b5168bd72a88bccbaa8c0b58","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514574976,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["fc210d59b5168bd72a88bccbaa8c0b58","login_success","security","fc210d59b5168bd72a88bccbaa8c0b58","{\"metadata\":{\"timestamp\":\"2026-01-15T22:02:54.925Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:02:54.925Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould mark current session correctly
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514575185,"env":"test","module":"user-credentials-repository","userId":"eUWyalxx7sVswhZkU51Je","msg":"User credentials created"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould not allow MFA setup if already enabled
[22m[39m[TEST UTILS] MFA Secret verified for 18e52dcc627a81d8f67385e101eb4122

{"level":50,"time":1768514575263,"env":"test","module":"auth-routes","email":"test-1768514573452-9lqhk@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768514575382,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514575389,"env":"test","module":"user-credentials-repository","userId":"GgiVME7iCXvFpGaY7uSor","msg":"User credentials created"}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514575504,"env":"test","module":"auth-service","tokenHash":"ec408ef3a62e0230b78a61d595d64e1b7d305a993f14a7fe7770c5acb4e94d49","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768514575523,"env":"test","module":"auth-routes","userId":"5646a5eda033636915d3fa45f69a7a48","msg":"User logged in successfully"}
{"level":40,"time":1768514575557,"env":"test","module":"auth-service","tokenHash":"ec408ef3a62e0230b78a61d595d64e1b7d305a993f14a7fe7770c5acb4e94d49","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":50,"time":1768514575566,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["5646a5eda033636915d3fa45f69a7a48","login_success","security","5646a5eda033636915d3fa45f69a7a48","{\"metadata\":{\"timestamp\":\"2026-01-15T22:02:55.523Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:02:55.523Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"5646a5eda033636915d3fa45f69a7a48","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514575566,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["5646a5eda033636915d3fa45f69a7a48","login_success","security","5646a5eda033636915d3fa45f69a7a48","{\"metadata\":{\"timestamp\":\"2026-01-15T22:02:55.523Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:02:55.523Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould mark current session correctly
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514575634,"env":"test","module":"user-credentials-repository","userId":"STenkJslSTx0A7JcoPXlg","msg":"User credentials created"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould not allow MFA setup if already enabled
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768514575828,"env":"test","module":"auth-routes","email":"test-1768514573452-9lqhk@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768514575879,"env":"test","module":"auth-service","allTokensCount":5447,"sampleToken":"2b484d683e217a5794883c3321285a69f23da26d5e0f749725f993d77b121982","msg":"DEBUG: Tokens in DB"}
[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768514575932,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for 2851ecb823a5b264642648130832687a

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514576167,"env":"test","module":"auth-routes","userId":"18e52dcc627a81d8f67385e101eb4122","msg":"Login requires MFA verification"}
{"level":30,"time":1768514576189,"env":"test","module":"user-credentials-repository","userId":"Rf1KmP8VySkcbU6ijCAfm","msg":"User credentials created"}
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514576249,"env":"test","module":"user-credentials-repository","userId":"QryMkL1s88GOlXRhnos46","msg":"User credentials created"}
{"level":30,"time":1768514576301,"env":"test","module":"auth-service","tokenHash":"b47bf0c6cb80e1253d3b3b0c6ff4c7443896164572d86e3aeea49d198c82da74","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768514576361,"env":"test","module":"auth-routes","email":"test-1768514573452-9lqhk@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for invalid password
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514576510,"env":"test","module":"auth-routes","userId":"5646a5eda033636915d3fa45f69a7a48","msg":"User logged in successfully"}
{"level":50,"time":1768514576559,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["5646a5eda033636915d3fa45f69a7a48","login_success","security","5646a5eda033636915d3fa45f69a7a48","{\"metadata\":{\"timestamp\":\"2026-01-15T22:02:56.510Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:02:56.510Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"5646a5eda033636915d3fa45f69a7a48","eventType":"login_success","msg":"Failed to log security event"}
{"level":40,"time":1768514576560,"env":"test","module":"account-lockout","userId":"769229dc9b88beeed636d564646946b3","email":"test-1768514573452-9lqhk@example.com","lockedUntil":"2026-01-15T22:17:56.511Z","msg":"Account locked due to too many failed attempts"}
{"level":50,"time":1768514576559,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["5646a5eda033636915d3fa45f69a7a48","login_success","security","5646a5eda033636915d3fa45f69a7a48","{\"metadata\":{\"timestamp\":\"2026-01-15T22:02:56.510Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:02:56.510Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768514576561,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":50,"time":1768514576565,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768514576664,"env":"test","module":"auth-routes","userId":"769229dc9b88beeed636d564646946b3","email":"test-1768514573452-9lqhk@example.com","msg":"Login blocked: account locked"}
{"level":50,"time":1768514576665,"env":"test","module":"auth-routes","error":{"name":"AccountLockedError","code":"AUTH_005","statusCode":423,"isOperational":true,"lockedUntil":"2026-01-15T22:17:56.511Z","remainingMinutes":15},"msg":"Login failed"}
{"level":30,"time":1768514576782,"env":"test","module":"user-credentials-repository","userId":"5g_EplpU8L5JkbCnDJFgI","msg":"User credentials created"}
{"level":50,"time":1768514576786,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768514576833,"env":"test","module":"auth-routes","userId":"2851ecb823a5b264642648130832687a","msg":"Login requires MFA verification"}
{"level":50,"time":1768514576853,"env":"test","module":"auth-routes","email":"test-1768514575978-y58l5@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":50,"time":1768514576944,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":30,"time":1768514576945,"env":"test","module":"mfa-service","userId":"2851ecb823a5b264642648130832687a","msg":"TOTP verification successful"}
{"level":30,"time":1768514576952,"env":"test","module":"user-credentials-repository","userId":"mCy5WElgtshqrVkAqZnRt","msg":"User credentials created"}
{"level":30,"time":1768514577002,"env":"test","module":"auth-routes","userId":"2851ecb823a5b264642648130832687a","msg":"MFA login successful"}
{"level":30,"time":1768514577007,"env":"test","module":"auth-service","tokenHash":"e1859be8ffcafdc583cbd6940a4b714faf8761c37470b38b138f7b76d57db530","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768514577008,"env":"test","module":"auth-service","tokenHash":"e1859be8ffcafdc583cbd6940a4b714faf8761c37470b38b138f7b76d57db530","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514577161,"env":"test","module":"auth-routes","userId":"2851ecb823a5b264642648130832687a","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768514577187,"env":"test","module":"user-credentials-repository","userId":"HGshNtf3LsQzvDfSPaICc","msg":"User credentials created"}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould generate unique backup codes
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

{"level":40,"time":1768514577354,"env":"test","module":"auth-service","userId":"mCy5WElgtshqrVkAqZnRt","tokenHash":"e1859be8ffcafdc583cbd6940a4b714faf8761c37470b38b138f7b76d57db530","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768514577415,"env":"test","module":"auth-routes","userId":"2851ecb823a5b264642648130832687a","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Trusted device expiry updated"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for non-existent user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768514577602,"env":"test","module":"auth-routes","email":"nonexistent@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":30,"time":1768514577661,"env":"test","module":"auth-routes","userId":"HGshNtf3LsQzvDfSPaICc","msg":"All other sessions revoked"}
[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

{"level":50,"time":1768514577698,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":50,"time":1768514577709,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["HGshNtf3LsQzvDfSPaICc","all_sessions_revoked","security","HGshNtf3LsQzvDfSPaICc",null,"::ffff:127.0.0.1",null,"2026-01-15T22:02:57.662Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"HGshNtf3LsQzvDfSPaICc","eventType":"all_sessions_revoked","msg":"Failed to log security event"}
{"level":50,"time":1768514577709,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["HGshNtf3LsQzvDfSPaICc","all_sessions_revoked","security","HGshNtf3LsQzvDfSPaICc",null,"::ffff:127.0.0.1",null,"2026-01-15T22:02:57.662Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Error revoking all sessions"}
{"level":30,"time":1768514577738,"env":"test","module":"auth-routes","userId":"a8f6797c3d5492191953a2a7e683f55f","msg":"User logged in successfully"}
{"level":30,"time":1768514577777,"env":"test","module":"user-credentials-repository","userId":"brKSWTGVe8_lXSkTNhY2n","msg":"User credentials created"}
{"level":50,"time":1768514577787,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["a8f6797c3d5492191953a2a7e683f55f","login_success","security","a8f6797c3d5492191953a2a7e683f55f","{\"metadata\":{\"timestamp\":\"2026-01-15T22:02:57.738Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:02:57.738Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"a8f6797c3d5492191953a2a7e683f55f","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514577787,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["a8f6797c3d5492191953a2a7e683f55f","login_success","security","a8f6797c3d5492191953a2a7e683f55f","{\"metadata\":{\"timestamp\":\"2026-01-15T22:02:57.738Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:02:57.738Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768514577794,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768514577833,"env":"test","module":"auth-service","tokenHash":"985324e6146b7d0c5a925e7e7f078a7c77ca825f10dddb587e5eb2940194a57b","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould exclude revoked sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768514578051,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts[2m > [22m[2mDataVault Autonumber Integration Tests
[22m[39mError cleaning up table: Error: Table not found
    at DatavaultTablesService.verifyTenantOwnership (C:/Users/scoot/poll/VaultLogic/server/services/DatavaultTablesService.ts:152:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at DatavaultTablesService.deleteTable (C:/Users/scoot/poll/VaultLogic/server/services/DatavaultTablesService.ts:290:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/datavault.autonumber.test.ts:91:9

{"level":30,"time":1768514578086,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514578087,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768514578119,"env":"test","module":"user-credentials-repository","userId":"DLqMf2U7O-fN3p7yO4lMV","msg":"User credentials created"}
 [31m‚ùØ[39m tests/integration/datavault.autonumber.test.ts [2m([22m[2m5 tests[22m[2m | [22m[31m5 failed[39m[2m)[22m[33m 9779[2mms[22m[39m
[31m     [31m√ó[31m should generate basic autonumber without prefix[39m[33m 351[2mms[22m[39m
[31m     [31m√ó[31m should generate autonumber with prefix[39m[33m 329[2mms[22m[39m
[31m     [31m√ó[31m should generate autonumber with yearly reset format[39m[33m 340[2mms[22m[39m
[31m     [31m√ó[31m should be atomic and prevent race conditions[39m[33m 340[2mms[22m[39m
[31m     [31m√ó[31m should prevent manual updates to autonumber values[39m[33m 329[2mms[22m[39m
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768514578190,"env":"test","module":"user-credentials-repository","userId":"965f204b-c26e-4446-a38d-088a1d94a422","msg":"User credentials created"}
{"level":30,"time":1768514578281,"env":"test","module":"email-queue","jobId":"788e52ab-58eb-462f-a65c-333ed2738ff3","to":"test-1768514577701-vbpcfk@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768514578305,"env":"test","module":"auth-routes","email":"test-1768514577440-grl2up@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768514578318,"env":"test","module":"auth-routes","userId":"DLqMf2U7O-fN3p7yO4lMV","msg":"All other sessions revoked"}
{"level":30,"time":1768514578326,"env":"test","module":"auth-routes","userId":"965f204b-c26e-4446-a38d-088a1d94a422","email":"test-1768514577701-vbpcfk@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 403 for unverified email
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768514578369,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["DLqMf2U7O-fN3p7yO4lMV","all_sessions_revoked","security","DLqMf2U7O-fN3p7yO4lMV",null,"::ffff:127.0.0.1",null,"2026-01-15T22:02:58.318Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"DLqMf2U7O-fN3p7yO4lMV","eventType":"all_sessions_revoked","msg":"Failed to log security event"}
{"level":50,"time":1768514578369,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["DLqMf2U7O-fN3p7yO4lMV","all_sessions_revoked","security","DLqMf2U7O-fN3p7yO4lMV",null,"::ffff:127.0.0.1",null,"2026-01-15T22:02:58.318Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Error revoking all sessions"}
{"level":30,"time":1768514578392,"env":"test","module":"user-credentials-repository","userId":"91X7EfRuHOP7ASERNzRUz","msg":"User credentials created"}
{"level":30,"time":1768514578399,"env":"test","module":"auth-routes","userId":"13cc735a88c57cdffdccc14b86a33c84","msg":"User logged in successfully"}
{"level":50,"time":1768514578400,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514578445,"env":"test","module":"auth-service","tokenHash":"b893e2a753fe6fc4bcf29e844811113b9d2a29210a00a742d86b98b548043f3b","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":50,"time":1768514578445,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["13cc735a88c57cdffdccc14b86a33c84","login_success","security","13cc735a88c57cdffdccc14b86a33c84","{\"metadata\":{\"timestamp\":\"2026-01-15T22:02:58.400Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:02:58.400Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"13cc735a88c57cdffdccc14b86a33c84","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514578445,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["13cc735a88c57cdffdccc14b86a33c84","login_success","security","13cc735a88c57cdffdccc14b86a33c84","{\"metadata\":{\"timestamp\":\"2026-01-15T22:02:58.400Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:02:58.400Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould exclude revoked sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39m[TEST UTILS] MFA Secret verified for 4ac952f4a89b58da499f400f975b7ff1

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

{"level":40,"time":1768514578738,"env":"test","module":"auth-routes","userId":"965f204b-c26e-4446-a38d-088a1d94a422","email":"test-1768514577701-vbpcfk@example.com","msg":"Login blocked: email not verified"}
{"level":50,"time":1768514578738,"env":"test","module":"auth-routes","error":{"name":"EmailNotVerifiedError","code":"AUTH_006","statusCode":403,"isOperational":true},"msg":"Login failed"}
{"level":30,"time":1768514578773,"env":"test","module":"user-credentials-repository","userId":"xvTCnNDEMWOCZZ0DRqUBV","msg":"User credentials created"}
{"level":50,"time":1768514578799,"env":"test","module":"auth-routes","email":"test-1768514577440-grl2up@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

{"level":50,"time":1768514578896,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514579015,"env":"test","module":"user-credentials-repository","userId":"7A-tGkyQeTBYjPAUQttCy","msg":"User credentials created"}
{"level":30,"time":1768514579072,"env":"test","module":"auth-service","tokenHash":"c988ddb2b411e7f2aec9b9a90dc7a616f4002eedb8f110fb954521fdbf051cde","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould store hashed backup codes
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould record failed login attempt
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514579151,"env":"test","module":"user-credentials-repository","userId":"LrB36-hlwNGqtuge_apZD","msg":"User credentials created"}
{"level":50,"time":1768514579155,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768514579280,"env":"test","module":"auth-routes","userId":"13cc735a88c57cdffdccc14b86a33c84","msg":"User logged in successfully"}
{"level":50,"time":1768514579323,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["13cc735a88c57cdffdccc14b86a33c84","login_success","security","13cc735a88c57cdffdccc14b86a33c84","{\"metadata\":{\"timestamp\":\"2026-01-15T22:02:59.280Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:02:59.280Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"13cc735a88c57cdffdccc14b86a33c84","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514579323,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["13cc735a88c57cdffdccc14b86a33c84","login_success","security","13cc735a88c57cdffdccc14b86a33c84","{\"metadata\":{\"timestamp\":\"2026-01-15T22:02:59.280Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:02:59.280Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514579438,"env":"test","module":"auth-routes","userId":"4ac952f4a89b58da499f400f975b7ff1","msg":"Login requires MFA verification"}
{"level":30,"time":1768514579453,"env":"test","module":"auth-routes","userId":"8ad29f827e93d112d8072ebf8ae0d223","msg":"User logged in successfully"}
{"level":50,"time":1768514579509,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["8ad29f827e93d112d8072ebf8ae0d223","login_success","security","8ad29f827e93d112d8072ebf8ae0d223","{\"metadata\":{\"timestamp\":\"2026-01-15T22:02:59.454Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:02:59.454Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"8ad29f827e93d112d8072ebf8ae0d223","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514579509,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["8ad29f827e93d112d8072ebf8ae0d223","login_success","security","8ad29f827e93d112d8072ebf8ae0d223","{\"metadata\":{\"timestamp\":\"2026-01-15T22:02:59.454Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:02:59.454Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514579536,"env":"test","module":"user-credentials-repository","userId":"VcvaUEwUemu2gsFYMAcXW","msg":"User credentials created"}
{"level":30,"time":1768514579541,"env":"test","module":"mfa-service","userId":"4ac952f4a89b58da499f400f975b7ff1","msg":"TOTP verification successful"}
{"level":50,"time":1768514579557,"env":"test","module":"auth-routes","email":"test-1768514578741-ua8o5a@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768514579593,"env":"test","module":"auth-routes","userId":"4ac952f4a89b58da499f400f975b7ff1","msg":"MFA login successful"}
{"level":30,"time":1768514579623,"env":"test","module":"auth-routes","userId":"065414eaf518f0cbfe16241b2de3df74","msg":"User logged in successfully"}
{"level":30,"time":1768514579630,"env":"test","module":"user-credentials-repository","userId":"B3sONNBB9r5h4KrMxuVqF","msg":"User credentials created"}
{"level":30,"time":1768514579641,"env":"test","module":"auth-routes","userId":"VcvaUEwUemu2gsFYMAcXW","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Device marked as trusted"}
{"level":50,"time":1768514579655,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":50,"time":1768514579668,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["065414eaf518f0cbfe16241b2de3df74","login_success","security","065414eaf518f0cbfe16241b2de3df74","{\"metadata\":{\"timestamp\":\"2026-01-15T22:02:59.624Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:02:59.624Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"065414eaf518f0cbfe16241b2de3df74","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514579668,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["065414eaf518f0cbfe16241b2de3df74","login_success","security","065414eaf518f0cbfe16241b2de3df74","{\"metadata\":{\"timestamp\":\"2026-01-15T22:02:59.624Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:02:59.624Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768514579676,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22m[2mOAuth2 Token Refresh Flow[2m > [22m[2mRefresh Token Lifecycle[2m > [22m[2mshould create refresh token on login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768514579729,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768514579745,"env":"test","module":"auth-routes","userId":"4ac952f4a89b58da499f400f975b7ff1","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514580049,"env":"test","module":"user-credentials-repository","userId":"x8W2sawdmM-bpFi5EtGRh","msg":"User credentials created"}
{"level":30,"time":1768514580158,"env":"test","module":"auth-routes","userId":"x8W2sawdmM-bpFi5EtGRh","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Device marked as trusted"}
{"level":30,"time":1768514580282,"env":"test","module":"auth-routes","userId":"4ac952f4a89b58da499f400f975b7ff1","msg":"Login requires MFA verification"}
{"level":30,"time":1768514580291,"env":"test","module":"auth-routes","userId":"B3sONNBB9r5h4KrMxuVqF","msg":"User logged in successfully"}
{"level":30,"time":1768514580320,"env":"test","module":"auth-routes","userId":"x8W2sawdmM-bpFi5EtGRh","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Trusted device expiry updated"}
{"level":50,"time":1768514580338,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["B3sONNBB9r5h4KrMxuVqF","login_success","security","B3sONNBB9r5h4KrMxuVqF","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:00.292Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:00.292Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"B3sONNBB9r5h4KrMxuVqF","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514580339,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["B3sONNBB9r5h4KrMxuVqF","login_success","security","B3sONNBB9r5h4KrMxuVqF","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:00.292Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:00.292Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768514580375,"env":"test","module":"mfa-service","userId":"4ac952f4a89b58da499f400f975b7ff1","msg":"TOTP verification successful"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768514580426,"env":"test","module":"auth-routes","userId":"4ac952f4a89b58da499f400f975b7ff1","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514580583,"env":"test","module":"auth-routes","userId":"4ac952f4a89b58da499f400f975b7ff1","deviceFingerprint":"091366faa1882b5c8dc1cba02126615a77a378274bbfd3375e821aa38bdd1b4f","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514580720,"env":"test","module":"user-credentials-repository","userId":"owsABJ4_dARJavq4SFXqw","msg":"User credentials created"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514580759,"env":"test","module":"user-credentials-repository","userId":"GHxm5zcE5tqqkDNCsjI2l","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return requiresMfa=true for MFA-enabled users
[22m[39m[TEST UTILS] MFA Secret verified for 893a0a39d051981751769bb14b53e949

{"level":30,"time":1768514580855,"env":"test","module":"auth-routes","userId":"GHxm5zcE5tqqkDNCsjI2l","deviceCount":2,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould complete MFA setup and login with TOTP
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514581100,"env":"test","module":"auth-routes","userId":"4ac952f4a89b58da499f400f975b7ff1","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould require MFA for enabled users
[22m[39m[TEST UTILS] MFA Secret verified for ed8b94d4722f81053020a6cdccaa6bd7

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return requiresMfa=true for MFA-enabled users
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768514581196,"env":"test","module":"mfa-service","userId":"4ac952f4a89b58da499f400f975b7ff1","msg":"TOTP verification successful"}
{"level":30,"time":1768514581229,"env":"test","module":"user-credentials-repository","userId":"qf2UVRD0x_2WnxGSSCSvQ","msg":"User credentials created"}
{"level":30,"time":1768514581235,"env":"test","module":"user-credentials-repository","userId":"FlCHFRpOmRZjPWelL1wG6","msg":"User credentials created"}
{"level":30,"time":1768514581243,"env":"test","module":"auth-routes","userId":"4ac952f4a89b58da499f400f975b7ff1","msg":"MFA login successful"}
{"level":30,"time":1768514581249,"env":"test","module":"auth-routes","userId":"9613da941e46b3e5a733a4579f6050f6","msg":"User logged in successfully"}
{"level":50,"time":1768514581297,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["9613da941e46b3e5a733a4579f6050f6","login_success","security","9613da941e46b3e5a733a4579f6050f6","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:01.250Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:01.250Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"9613da941e46b3e5a733a4579f6050f6","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514581297,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["9613da941e46b3e5a733a4579f6050f6","login_success","security","9613da941e46b3e5a733a4579f6050f6","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:01.250Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:01.250Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768514581334,"env":"test","module":"auth-routes","userId":"qf2UVRD0x_2WnxGSSCSvQ","deviceCount":0,"msg":"Listed trusted devices"}
{"level":30,"time":1768514581341,"env":"test","module":"auth-routes","userId":"4ac952f4a89b58da499f400f975b7ff1","deviceCount":2,"msg":"Listed trusted devices"}
{"level":30,"time":1768514581355,"env":"test","module":"auth-routes","userId":"affc87755fc362278443be3672f2f1d6","msg":"User logged in successfully"}
{"level":50,"time":1768514581400,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["affc87755fc362278443be3672f2f1d6","login_success","security","affc87755fc362278443be3672f2f1d6","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:01.355Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:01.355Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"affc87755fc362278443be3672f2f1d6","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514581400,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["affc87755fc362278443be3672f2f1d6","login_success","security","affc87755fc362278443be3672f2f1d6","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:01.355Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:01.355Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768514581408,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould require MFA for enabled users
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768514581686,"env":"test","module":"user-credentials-repository","userId":"0MFmMdk08RLxPlgPBoWMV","msg":"User credentials created"}
{"level":30,"time":1768514581767,"env":"test","module":"auth-routes","userId":"893a0a39d051981751769bb14b53e949","msg":"Login requires MFA verification"}
{"level":30,"time":1768514581767,"env":"test","module":"user-credentials-repository","userId":"HHM3Bqtt3ZLBNLHXpYET1","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514581926,"env":"test","module":"auth-routes","userId":"HHM3Bqtt3ZLBNLHXpYET1","deviceId":"726ccc6c-31bf-461f-9f0f-7c483a2d5107","msg":"Trusted device revoked"}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

{"level":30,"time":1768514581977,"env":"test","module":"auth-routes","userId":"ed8b94d4722f81053020a6cdccaa6bd7","msg":"Login requires MFA verification"}
{"level":30,"time":1768514582239,"env":"test","module":"user-credentials-repository","userId":"EIgsgn9Tev-J4SGRxw_Y5","msg":"User credentials created"}
{"level":30,"time":1768514582337,"env":"test","module":"user-credentials-repository","userId":"qBV3b16q4IPd_BW7j4Lkk","msg":"User credentials created"}
{"level":30,"time":1768514582345,"env":"test","module":"auth-routes","userId":"9613da941e46b3e5a733a4579f6050f6","msg":"User logged in successfully"}
{"level":50,"time":1768514582394,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["9613da941e46b3e5a733a4579f6050f6","login_success","security","9613da941e46b3e5a733a4579f6050f6","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:02.345Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:02.345Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"9613da941e46b3e5a733a4579f6050f6","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514582394,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["9613da941e46b3e5a733a4579f6050f6","login_success","security","9613da941e46b3e5a733a4579f6050f6","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:02.345Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:02.345Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for 9fe8833cf45eb23c1f8f1b9f5ce6441c

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514582698,"env":"test","module":"user-credentials-repository","userId":"pXCJZ1vGQyIOAdjezoUKI","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould login with backup code when TOTP unavailable
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514582835,"env":"test","module":"user-credentials-repository","userId":"Lu5RHDapsOrNF98TlzFsE","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould complete MFA login with valid TOTP
[22m[39m[TEST UTILS] MFA Secret verified for 12c480a869c3ee22e12e127e860cc71d

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768514583246,"env":"test","module":"user-credentials-repository","userId":"aWYlSFlbljqOWMVnBmj6L","msg":"User credentials created"}
{"level":30,"time":1768514583286,"env":"test","module":"auth-routes","userId":"9fe8833cf45eb23c1f8f1b9f5ce6441c","msg":"Login requires MFA verification"}
{"level":30,"time":1768514583292,"env":"test","module":"auth-routes","userId":"3af26a3fca6d14f32311ac65c7563a00","msg":"User logged in successfully"}
{"level":50,"time":1768514583317,"env":"test","module":"auth-routes","email":"test-1768514582357-hix7i@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":50,"time":1768514583343,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["3af26a3fca6d14f32311ac65c7563a00","login_success","security","3af26a3fca6d14f32311ac65c7563a00","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:03.292Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:03.292Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"3af26a3fca6d14f32311ac65c7563a00","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514583344,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["3af26a3fca6d14f32311ac65c7563a00","login_success","security","3af26a3fca6d14f32311ac65c7563a00","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:03.292Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:03.292Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768514583353,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould complete MFA login with valid TOTP
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514583391,"env":"test","module":"auth-routes","userId":"9613da941e46b3e5a733a4579f6050f6","msg":"User logged in successfully"}
{"level":30,"time":1768514583392,"env":"test","module":"mfa-service","userId":"9fe8833cf45eb23c1f8f1b9f5ce6441c","msg":"TOTP verification successful"}
{"level":50,"time":1768514583418,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w38
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w38,public

{"level":50,"time":1768514583438,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["9613da941e46b3e5a733a4579f6050f6","login_success","security","9613da941e46b3e5a733a4579f6050f6","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:03.391Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:03.391Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"9613da941e46b3e5a733a4579f6050f6","eventType":"login_success","msg":"Failed to log security event"}
{"level":30,"time":1768514583439,"env":"test","module":"auth-routes","userId":"9fe8833cf45eb23c1f8f1b9f5ce6441c","msg":"MFA login successful"}
{"level":50,"time":1768514583438,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["9613da941e46b3e5a733a4579f6050f6","login_success","security","9613da941e46b3e5a733a4579f6050f6","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:03.391Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:03.391Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768514583443,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w38 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w38%2Cpublic

{"level":30,"time":1768514583484,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514583538,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514583594,"env":"test","module":"auth-routes","userId":"9fe8833cf45eb23c1f8f1b9f5ce6441c","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w39
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w39,public

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w41
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w41,public

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w40
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w40,public

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w39 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w39%2Cpublic

{"level":30,"time":1768514583643,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w41 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w41%2Cpublic

{"level":30,"time":1768514583666,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w40 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w40%2Cpublic

{"level":30,"time":1768514583677,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514583686,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514583697,"env":"test","module":"auth-routes","userId":"9fe8833cf45eb23c1f8f1b9f5ce6441c","deviceCount":1,"msg":"Listed trusted devices"}
{"level":30,"time":1768514583696,"env":"test","module":"user-credentials-repository","userId":"3yzVjxWCKu0PhpMr6VTcX","msg":"User credentials created"}
{"level":30,"time":1768514583722,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514583729,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768514583812,"env":"test","module":"auth-routes","email":"test-1768514582357-hix7i@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768514583863,"env":"test","module":"auth-routes","userId":"12c480a869c3ee22e12e127e860cc71d","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w38, public

{"level":30,"time":1768514583904,"env":"test","module":"auth-service","tokenHash":"dda27891d943646a09fd687be937f4ff80d09db3b5cef08cbd129e322104b049","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":50,"time":1768514583906,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w38
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768514583963,"env":"test","module":"mfa-service","userId":"12c480a869c3ee22e12e127e860cc71d","msg":"TOTP verification successful"}
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w18.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w18.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514584013,"env":"test","module":"auth-routes","userId":"12c480a869c3ee22e12e127e860cc71d","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w39, public

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w40, public

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w41, public

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w39
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w40
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w41
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w38.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w38.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w38.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w38.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514584156,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514584156,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w38.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w38.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

 [31m‚ùØ[39m tests/integration/auth/oauth2.sessions.test.ts [2m([22m[2m25 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 14275[2mms[22m[39m
       [33m[2m‚úì[22m[39m should list all active sessions for current user [33m 534[2mms[22m[39m
       [33m[2m‚úì[22m[39m should mark current session as current [33m 442[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return empty array when user has no active sessions [33m 427[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not include expired sessions [33m 451[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not include revoked sessions [33m 475[2mms[22m[39m
       [33m[2m‚úì[22m[39m should parse device name from user agent [33m 439[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 for unauthenticated request [33m 330[2mms[22m[39m
       [33m[2m‚úì[22m[39m should revoke a specific session [33m 620[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 404 for non-existent session [33m 373[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent revoking current session [33m 604[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent revoking another user's session [33m 596[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 for unauthenticated request [33m 396[2mms[22m[39m
[31m       [31m√ó[31m should revoke all sessions except current[39m[33m 934[2mms[22m[39m
[31m       [31m√ó[31m should revoke all trusted devices[39m[33m 651[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 400 when no active session found [33m 405[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 for unauthenticated request [33m 379[2mms[22m[39m
         [33m[2m‚úì[22m[39m should mark current device as trusted [33m 534[2mms[22m[39m
         [33m[2m‚úì[22m[39m should update existing trusted device expiry [33m 687[2mms[22m[39m
         [33m[2m‚úì[22m[39m should list all trusted devices [33m 480[2mms[22m[39m
         [33m[2m‚úì[22m[39m should not include revoked devices [33m 478[2mms[22m[39m
         [33m[2m‚úì[22m[39m should revoke a trusted device [33m 640[2mms[22m[39m
         [33m[2m‚úì[22m[39m should return 404 for non-existent device [33m 368[2mms[22m[39m
       [33m[2m‚úì[22m[39m should track IP address for sessions [33m 452[2mms[22m[39m
       [33m[2m‚úì[22m[39m should track user agent for sessions [33m 557[2mms[22m[39m
       [33m[2m‚úì[22m[39m should update lastUsedAt on token refresh [33m 802[2mms[22m[39m
{"level":50,"time":1768514584317,"env":"test","module":"auth-routes","email":"test-1768514582357-hix7i@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w42
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w42,public

{"level":50,"time":1768514584422,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w42 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w42%2Cpublic

{"level":30,"time":1768514584429,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514584479,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39m[TEST UTILS] MFA Secret verified for 2e4e5c4a50013b4b556abaf128ab73b3

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w42, public

{"level":50,"time":1768514584840,"env":"test","module":"auth-routes","email":"test-1768514582357-hix7i@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w42
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w39.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w40.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w41.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w39.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768514584938,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514584952,"env":"test","module":"email-queue","jobId":"c760b94d-0a50-4484-9343-8f0846281b9f","to":"test-1768514584347-oef5mc@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768514584952,"env":"test","module":"auth-service","email":"test-1768514584347-oef5mc@example.com","msg":"Password reset email sent"}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w40.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w43
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w43,public

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w41.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w43 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w43%2Cpublic

{"level":30,"time":1768514585052,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould reject invalid TOTP during login
[22m[39m[TEST UTILS] MFA Secret verified for 8da8869c063332f0ad08ce5ea6ba7f70

{"level":30,"time":1768514585099,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514585249,"env":"test","module":"email-queue","jobId":"d56c44d4-1f08-4af0-978f-c3ecce55cf8d","to":"test-1768514584347-oef5mc@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768514585249,"env":"test","module":"auth-service","email":"test-1768514584347-oef5mc@example.com","msg":"Password reset email sent"}
{"level":50,"time":1768514585323,"env":"test","module":"auth-routes","email":"test-1768514582357-hix7i@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould reject invalid TOTP during login
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w44
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w44,public

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w43, public

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w44 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w44%2Cpublic

{"level":30,"time":1768514585476,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514585480,"env":"test","module":"auth-routes","userId":"2e4e5c4a50013b4b556abaf128ab73b3","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w43
‚è© Schema reused, skipping migrations.

{"level":40,"time":1768514585518,"env":"test","module":"account-lockout","userId":"e5d40f65e399ad03d59949752cf9a8d2","email":"test-1768514582357-hix7i@example.com","lockedUntil":"2026-01-15T22:18:05.469Z","msg":"Account locked due to too many failed attempts"}
{"level":50,"time":1768514585518,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":30,"time":1768514585522,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w42.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w42.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w45
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w45,public

{"level":30,"time":1768514585576,"env":"test","module":"mfa-service","userId":"2e4e5c4a50013b4b556abaf128ab73b3","msg":"TOTP verification successful"}
{"level":30,"time":1768514585584,"env":"test","module":"email-queue","jobId":"d89bf4dc-9a8e-46ab-8533-4dbf71295816","to":"newuser_1768514583002@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
{"level":30,"time":1768514585603,"env":"test","module":"auth-routes","userId":"2d505ddf0fa3c6c7ff201b94a4928d81","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w45 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w45%2Cpublic

{"level":40,"time":1768514585619,"env":"test","module":"auth-routes","userId":"e5d40f65e399ad03d59949752cf9a8d2","email":"test-1768514582357-hix7i@example.com","msg":"Login blocked: account locked"}
{"level":50,"time":1768514585620,"env":"test","module":"auth-routes","error":{"name":"AccountLockedError","code":"AUTH_005","statusCode":423,"isOperational":true,"lockedUntil":"2026-01-15T22:18:05.469Z","remainingMinutes":15},"msg":"Login failed"}
{"level":30,"time":1768514585628,"env":"test","module":"auth-routes","userId":"2e4e5c4a50013b4b556abaf128ab73b3","msg":"MFA login successful"}
{"level":30,"time":1768514585634,"env":"test","module":"user-credentials-repository","userId":"e47323342e23771924a937a12efae0c4","msg":"User password updated"}
{"level":50,"time":1768514585647,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["2d505ddf0fa3c6c7ff201b94a4928d81","login_success","security","2d505ddf0fa3c6c7ff201b94a4928d81","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:05.603Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:05.603Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"2d505ddf0fa3c6c7ff201b94a4928d81","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514585648,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["2d505ddf0fa3c6c7ff201b94a4928d81","login_success","security","2d505ddf0fa3c6c7ff201b94a4928d81","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:05.603Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:05.603Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768514585770,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["e47323342e23771924a937a12efae0c4","password_reset","security","e47323342e23771924a937a12efae0c4","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:05.726Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:05.726Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"e47323342e23771924a937a12efae0c4","eventType":"password_reset","msg":"Failed to log security event"}
{"level":50,"time":1768514585770,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["e47323342e23771924a937a12efae0c4","password_reset","security","e47323342e23771924a937a12efae0c4","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:05.726Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:05.726Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Reset password error"}
{"level":30,"time":1768514585776,"env":"test","module":"auth-routes","userId":"2e4e5c4a50013b4b556abaf128ab73b3","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768514585811,"env":"test","module":"auth-routes","userId":"8da8869c063332f0ad08ce5ea6ba7f70","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w44, public

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w44
‚è© Schema reused, skipping migrations.

{"level":40,"time":1768514585909,"env":"test","module":"mfa-service","userId":"8da8869c063332f0ad08ce5ea6ba7f70","msg":"TOTP verification failed"}
{"level":40,"time":1768514585909,"env":"test","module":"auth-routes","userId":"8da8869c063332f0ad08ce5ea6ba7f70","msg":"MFA verification failed during login"}
{"level":30,"time":1768514585926,"env":"test","module":"auth-routes","userId":"2e4e5c4a50013b4b556abaf128ab73b3","deviceCount":0,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w43.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w43.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w45, public

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w46
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w46,public

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w45
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w46 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w46%2Cpublic

{"level":30,"time":1768514586040,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514586069,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w44.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w44.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w46, public

{"level":30,"time":1768514586414,"env":"test","module":"auth-routes","userId":"2d505ddf0fa3c6c7ff201b94a4928d81","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w46
‚è© Schema reused, skipping migrations.

{"level":50,"time":1768514586461,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["2d505ddf0fa3c6c7ff201b94a4928d81","login_success","security","2d505ddf0fa3c6c7ff201b94a4928d81","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:06.415Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:06.415Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"2d505ddf0fa3c6c7ff201b94a4928d81","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514586462,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["2d505ddf0fa3c6c7ff201b94a4928d81","login_success","security","2d505ddf0fa3c6c7ff201b94a4928d81","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:06.415Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:06.415Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w45.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w45.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/logout[2m > [22m[2mshould logout and clear refresh token cookie
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514587012,"env":"test","module":"auth-routes","userId":"f75b3aa8a6dac7967d78f4dd8ce8bd55","msg":"User logged in successfully"}
{"level":50,"time":1768514587063,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["f75b3aa8a6dac7967d78f4dd8ce8bd55","login_success","security","f75b3aa8a6dac7967d78f4dd8ce8bd55","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:07.013Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:07.013Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"f75b3aa8a6dac7967d78f4dd8ce8bd55","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514587063,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["f75b3aa8a6dac7967d78f4dd8ce8bd55","login_success","security","f75b3aa8a6dac7967d78f4dd8ce8bd55","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:07.013Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:07.013Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mPassword Reset Flow[2m > [22m[2mshould invalidate all sessions after password reset
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514587204,"env":"test","module":"auth-routes","userId":"06ddcadca1925bae51ebebf65a45825a","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for bc74f7c64f00784e9f96cafe1007f855

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould accept TOTP codes within 60-second window
[22m[39m[TEST UTILS] MFA Secret verified for b60e3671a10245e3b6a9d889d4925755

{"level":50,"time":1768514587246,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["06ddcadca1925bae51ebebf65a45825a","login_success","security","06ddcadca1925bae51ebebf65a45825a","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:07.204Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:07.204Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"06ddcadca1925bae51ebebf65a45825a","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514587246,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["06ddcadca1925bae51ebebf65a45825a","login_success","security","06ddcadca1925bae51ebebf65a45825a","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:07.204Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:07.204Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768514587251,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould accept TOTP codes within 60-second window
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514587599,"env":"test","module":"auth-routes","userId":"fd5ac14e122d1e3997053872cfd10058","msg":"User logged in successfully"}
{"level":50,"time":1768514587648,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["fd5ac14e122d1e3997053872cfd10058","login_success","security","fd5ac14e122d1e3997053872cfd10058","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:07.599Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:07.599Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"fd5ac14e122d1e3997053872cfd10058","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514587648,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["fd5ac14e122d1e3997053872cfd10058","login_success","security","fd5ac14e122d1e3997053872cfd10058","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:07.599Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:07.599Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768514587868,"env":"test","module":"email-queue","jobId":"35f4cdf1-5955-44e4-b178-c597fb296fc3","to":"existing_1768514583002@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
{"level":30,"time":1768514587948,"env":"test","module":"auth-routes","userId":"bc74f7c64f00784e9f96cafe1007f855","msg":"Login requires MFA verification"}
{"level":30,"time":1768514587949,"env":"test","module":"email-queue","jobId":"d4c6a001-04c8-4aea-b963-6412794b1491","to":"org-member@test.com","subject":"You've been invited to join Test Organization","msg":"Email added to queue"}
{"level":30,"time":1768514587959,"env":"test","module":"auth-routes","userId":"b60e3671a10245e3b6a9d889d4925755","msg":"Login requires MFA verification"}
{"level":30,"time":1768514588040,"env":"test","module":"user-credentials-repository","userId":"hCCfRvPSNS4FnptxHjt7Q","msg":"User credentials created"}
{"level":30,"time":1768514588049,"env":"test","module":"mfa-service","userId":"bc74f7c64f00784e9f96cafe1007f855","msg":"TOTP verification successful"}
{"level":30,"time":1768514588061,"env":"test","module":"mfa-service","userId":"b60e3671a10245e3b6a9d889d4925755","msg":"TOTP verification successful"}
{"level":30,"time":1768514588101,"env":"test","module":"auth-routes","userId":"bc74f7c64f00784e9f96cafe1007f855","msg":"MFA login successful"}
{"level":30,"time":1768514588112,"env":"test","module":"auth-routes","userId":"b60e3671a10245e3b6a9d889d4925755","msg":"MFA login successful"}
{"level":30,"time":1768514588115,"env":"test","module":"email-queue","jobId":"f52c6fe4-8898-4f42-ad6e-c83c5146b125","to":"test-1768514586762-pfs2xq@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould accept TOTP codes within 60-second window
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514588115,"env":"test","module":"auth-service","email":"test-1768514586762-pfs2xq@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768514588242,"env":"test","module":"auth-routes","userId":"bc74f7c64f00784e9f96cafe1007f855","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/refresh-token[2m > [22m[2mshould refresh access token with valid refresh token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514588391,"env":"test","module":"auth-routes","userId":"bc74f7c64f00784e9f96cafe1007f855","deviceCount":0,"msg":"Listed trusted devices"}
{"level":30,"time":1768514588391,"env":"test","module":"email-queue","jobId":"3a870cb3-dea0-4269-a994-0880e6ab54f4","to":"audit-user2@test.com","subject":"You've been invited to join Test Org Audit","msg":"Email added to queue"}
{"level":30,"time":1768514588496,"env":"test","module":"user-credentials-repository","userId":"fd5ac14e122d1e3997053872cfd10058","msg":"User password updated"}
{"level":30,"time":1768514588516,"env":"test","module":"user-credentials-repository","userId":"Gh_lqlalvfWkfFGdWPlFa","msg":"User credentials created"}
{"level":30,"time":1768514588570,"env":"test","module":"auth-service","tokenHash":"68f4cd6911d3fb1e2a74a82bcf899c5b6d4b0f6efceca43dbe7455462cff88f0","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768514588595,"env":"test","module":"auth-routes","userId":"b60e3671a10245e3b6a9d889d4925755","msg":"Login requires MFA verification"}
{"level":50,"time":1768514588644,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["fd5ac14e122d1e3997053872cfd10058","password_reset","security","fd5ac14e122d1e3997053872cfd10058","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:08.597Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:08.597Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"fd5ac14e122d1e3997053872cfd10058","eventType":"password_reset","msg":"Failed to log security event"}
{"level":50,"time":1768514588644,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["fd5ac14e122d1e3997053872cfd10058","password_reset","security","fd5ac14e122d1e3997053872cfd10058","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:08.597Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:08.597Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Reset password error"}
{"level":50,"time":1768514588650,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768514588703,"env":"test","module":"mfa-service","userId":"b60e3671a10245e3b6a9d889d4925755","msg":"TOTP verification successful"}
{"level":50,"time":1768514588709,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768514588755,"env":"test","module":"auth-routes","userId":"b60e3671a10245e3b6a9d889d4925755","msg":"MFA login successful"}
{"level":30,"time":1768514588771,"env":"test","module":"auth-service","tokenHash":"68f4cd6911d3fb1e2a74a82bcf899c5b6d4b0f6efceca43dbe7455462cff88f0","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768514588810,"env":"test","module":"auth-routes","userId":"a43d52c0763cb0d739c7d067edb209fc","msg":"User logged in successfully"}
{"level":40,"time":1768514588816,"env":"test","module":"auth-service","userId":"Gh_lqlalvfWkfFGdWPlFa","tokenHash":"68f4cd6911d3fb1e2a74a82bcf899c5b6d4b0f6efceca43dbe7455462cff88f0","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":50,"time":1768514588855,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["a43d52c0763cb0d739c7d067edb209fc","login_success","security","a43d52c0763cb0d739c7d067edb209fc","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:08.810Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:08.810Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"a43d52c0763cb0d739c7d067edb209fc","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514588855,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["a43d52c0763cb0d739c7d067edb209fc","login_success","security","a43d52c0763cb0d739c7d067edb209fc","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:08.810Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:08.810Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768514588862,"env":"test","module":"auth-service","tokenHash":"f2842f11b7452bb3b534c608f0a82bc248cf6633b64f2e9d225c836e47ebedd2","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514589180,"env":"test","module":"user-credentials-repository","userId":"_Wyq3OICoFLTW9w6IRjPu","msg":"User credentials created"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for 51b795fb0789e516ded587ac8f8aa1c2

{"level":30,"time":1768514589524,"env":"test","module":"auth-routes","userId":"34556984c71cf1c5dad4dd34963c6a8d","msg":"User logged in successfully"}
{"level":50,"time":1768514589568,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["34556984c71cf1c5dad4dd34963c6a8d","login_success","security","34556984c71cf1c5dad4dd34963c6a8d","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:09.524Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:09.524Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"34556984c71cf1c5dad4dd34963c6a8d","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514589568,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["34556984c71cf1c5dad4dd34963c6a8d","login_success","security","34556984c71cf1c5dad4dd34963c6a8d","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:09.524Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:09.524Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514589664,"env":"test","module":"user-credentials-repository","userId":"kymPljGLAuJlF015R_k2P","msg":"User credentials created"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould login with valid backup code
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514589720,"env":"test","module":"auth-service","tokenHash":"8f0e18658e70137158901d276a4c2259479ad7ed1affe807fe7c8546ebc3097a","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768514589968,"env":"test","module":"email-queue","jobId":"49610a74-6510-44a6-be2a-41464f13f303","to":"newuser_1768514583002@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould rotate refresh token on each use
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514590016,"env":"test","module":"email-queue","jobId":"0308d632-a258-469b-b200-f459e6d434d4","to":"email-test@example.com","subject":"You've been invited to join Test Org Audit","msg":"Email added to queue"}
{"level":30,"time":1768514590134,"env":"test","module":"auth-routes","userId":"51b795fb0789e516ded587ac8f8aa1c2","msg":"Login requires MFA verification"}
{"level":30,"time":1768514590166,"env":"test","module":"auth-routes","userId":"98f206f4cb3d72afb0e6ce2e36df2930","msg":"User logged in successfully"}
{"level":50,"time":1768514590213,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["98f206f4cb3d72afb0e6ce2e36df2930","login_success","security","98f206f4cb3d72afb0e6ce2e36df2930","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:10.166Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:10.167Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"98f206f4cb3d72afb0e6ce2e36df2930","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514590213,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["98f206f4cb3d72afb0e6ce2e36df2930","login_success","security","98f206f4cb3d72afb0e6ce2e36df2930","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:10.166Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:10.167Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768514590218,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768514590255,"env":"test","module":"mfa-service","userId":"51b795fb0789e516ded587ac8f8aa1c2","msg":"TOTP verification successful"}
{"level":30,"time":1768514590266,"env":"test","module":"user-credentials-repository","userId":"Rq4UAUJ5LnD5GVnu9FHdb","msg":"User credentials created"}
{"level":30,"time":1768514590299,"env":"test","module":"auth-routes","userId":"51b795fb0789e516ded587ac8f8aa1c2","msg":"MFA login successful"}
{"level":30,"time":1768514590316,"env":"test","module":"auth-service","tokenHash":"e81b451f8a69b03c812a656e5c6884fea9ef2ee21f700c2d0a3a8ae426f3bdf7","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/refresh-token[2m > [22m[2mshould rotate refresh token after use
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514590326,"env":"test","module":"auth-routes","userId":"34556984c71cf1c5dad4dd34963c6a8d","msg":"User logged in successfully"}
{"level":50,"time":1768514590361,"env":"test","error":{"error":{"code":"INTERNAL_ERROR","message":""}},"msg":"Failed to render template"}
{"level":30,"time":1768514590373,"env":"test","workflowId":"1ef4e2b1-6764-482d-a3e1-5ded717c8476","userId":"056741f1-cb6f-4837-852b-d1cf04878bd9","sectionsCount":1,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":50,"time":1768514590373,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["34556984c71cf1c5dad4dd34963c6a8d","login_success","security","34556984c71cf1c5dad4dd34963c6a8d","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:10.326Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:10.326Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"34556984c71cf1c5dad4dd34963c6a8d","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514590373,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["34556984c71cf1c5dad4dd34963c6a8d","login_success","security","34556984c71cf1c5dad4dd34963c6a8d","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:10.326Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:10.326Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768514590378,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768514590446,"env":"test","module":"auth-routes","userId":"51b795fb0789e516ded587ac8f8aa1c2","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768514590452,"env":"test","module":"auth-routes","userId":"723398eadf4d39e418f387fa2502fdce","msg":"User logged in successfully"}
{"level":50,"time":1768514590503,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["723398eadf4d39e418f387fa2502fdce","login_success","security","723398eadf4d39e418f387fa2502fdce","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:10.453Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:10.453Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"723398eadf4d39e418f387fa2502fdce","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514590503,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["723398eadf4d39e418f387fa2502fdce","login_success","security","723398eadf4d39e418f387fa2502fdce","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:10.453Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:10.453Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768514590509,"env":"test","module":"auth-service","tokenHash":"5b696c06146ea41217a77224e71a4b65afa1280ad21957560dcf8a9f5a506e02","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768514590547,"env":"test","module":"auth-routes","userId":"51b795fb0789e516ded587ac8f8aa1c2","deviceCount":1,"msg":"Listed trusted devices"}
{"level":30,"time":1768514590689,"env":"test","module":"auth-routes","userId":"51b795fb0789e516ded587ac8f8aa1c2","deviceId":"01e1560d-4457-4bba-b5c2-f2f7462df5fd","msg":"Trusted device revoked"}
{"level":30,"time":1768514590757,"env":"test","workflowId":"1ef4e2b1-6764-482d-a3e1-5ded717c8476","userId":"b42a5faf-9351-43cd-95d9-125c32153122","sectionsCount":1,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":30,"time":1768514590776,"env":"test","module":"auth-routes","userId":"dd30e516f6b1195aa9ba251f2834ef67","msg":"User logged in successfully"}
{"level":30,"time":1768514590823,"env":"test","module":"user-credentials-repository","userId":"AY6g1c0_d0hW-SXmZ_YrU","msg":"User credentials created"}
{"level":50,"time":1768514590823,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["dd30e516f6b1195aa9ba251f2834ef67","login_success","security","dd30e516f6b1195aa9ba251f2834ef67","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:10.776Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:10.776Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"dd30e516f6b1195aa9ba251f2834ef67","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514590823,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["dd30e516f6b1195aa9ba251f2834ef67","login_success","security","dd30e516f6b1195aa9ba251f2834ef67","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:10.776Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:10.776Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768514590829,"env":"test","module":"auth-service","tokenHash":"ee0ebb658972700a5cad84fbdf25851c36a100b20012d1558b26c3575bc9d3bc","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768514590837,"env":"test","module":"auth-routes","userId":"51b795fb0789e516ded587ac8f8aa1c2","deviceCount":0,"msg":"Listed trusted devices"}
{"level":30,"time":1768514590878,"env":"test","module":"auth-service","tokenHash":"567ba15737b317ef120f519d99c7291ecb269780e7a4edbedddd1369146e9e7c","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768514590991,"env":"test","module":"auth-service","tokenHash":"9cfe94e5784390d1e9b3f22139c5188635c9f5ecc24c68cea97c43cc7acb0c25","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768514591041,"env":"test","module":"email-queue","jobId":"4d40fc3e-3360-421d-b2cb-f2478c6e741b","to":"expired-test@example.com","subject":"You've been invited to join Test Org Audit","msg":"Email added to queue"}
{"level":30,"time":1768514591195,"env":"test","module":"auth-service","tokenHash":"aea6cfab1dce69a0e99d4ec24160c909211d9e79ec3a616d64e3473cbc20c1d2","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768514591301,"env":"test","module":"auth-service","tokenHash":"ee0ebb658972700a5cad84fbdf25851c36a100b20012d1558b26c3575bc9d3bc","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768514591349,"env":"test","module":"auth-service","userId":"dd30e516f6b1195aa9ba251f2834ef67","tokenHash":"ee0ebb658972700a5cad84fbdf25851c36a100b20012d1558b26c3575bc9d3bc","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768514591391,"env":"test","module":"user-credentials-repository","userId":"etUFfKJ3yivp3C9vDpTHG","msg":"User credentials created"}
{"level":30,"time":1768514591439,"env":"test","module":"auth-service","tokenHash":"70e6e33dd9ee782f886d577dffd6190cec1cc08795ae15aaf061550e820ccba3","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking current session
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould mark backup code as used
[22m[39m[TEST UTILS] MFA Secret verified for ca0a19ec0a4719e7cf9e4b5bdc8bbc6a

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39m[TEST UTILS] MFA Secret verified for 0746303044473dddbc06f39d8d86c913

{"level":30,"time":1768514591863,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514591863,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/integration/auth/oauth2.token-refresh.test.ts [2m([22m[2m25 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 22038[2mms[22m[39m
       [33m[2m‚úì[22m[39m should refresh access token with valid refresh token [33m 626[2mms[22m[39m
       [33m[2m‚úì[22m[39m should rotate refresh token after use [33m 684[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 when refresh token is missing [33m 398[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 for invalid refresh token [33m 868[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 for expired refresh token [33m 822[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 for revoked refresh token [33m 542[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 when user is not found [33m 897[2mms[22m[39m
       [33m[2m‚úì[22m[39m should update refresh token metadata on rotation [33m 671[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle concurrent refresh token requests (token reuse detection) [33m 852[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set secure cookie in production [33m 618[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set proper cookie attributes [33m 615[2mms[22m[39m
       [33m[2m‚úì[22m[39m should include user role information in response [33m 629[2mms[22m[39m
[31m       [31m√ó[31m should create refresh token on login[39m[33m 1098[2mms[22m[39m
       [33m[2m‚úì[22m[39m should revoke refresh token on logout [33m 505[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle logout without refresh token gracefully [33m 418[2mms[22m[39m
       [33m[2m‚úì[22m[39m should support multiple active refresh tokens per user [33m 590[2mms[22m[39m
       [33m[2m‚úì[22m[39m should revoke all user tokens on password reset [33m 606[2mms[22m[39m
       [33m[2m‚úì[22m[39m should use cryptographically strong random tokens [33m 5244[2mms[22m[39m
       [33m[2m‚úì[22m[39m should hash refresh tokens before storing in database [33m 462[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent refresh token reuse after rotation [33m 674[2mms[22m[39m
       [33m[2m‚úì[22m[39m should validate token ownership [33m 476[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set HttpOnly flag to prevent XSS [33m 577[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set SameSite=Strict to prevent CSRF [33m 591[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set proper cookie path [33m 562[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set appropriate expiry (30 days) [33m 575[2mms[22m[39m
{"level":30,"time":1768514591962,"env":"test","module":"email-queue","jobId":"601e1bbb-121c-4c5b-8fb8-ac1fc8f58783","to":"expired-test@example.com","subject":"You've been invited to join Test Org Audit","msg":"Email added to queue"}
{"level":30,"time":1768514592081,"env":"test","module":"auth-routes","userId":"72f37be641392e419a47e588a1cff25d","msg":"User logged in successfully"}
{"level":50,"time":1768514592126,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["72f37be641392e419a47e588a1cff25d","login_success","security","72f37be641392e419a47e588a1cff25d","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:12.081Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:12.081Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"72f37be641392e419a47e588a1cff25d","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514592127,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["72f37be641392e419a47e588a1cff25d","login_success","security","72f37be641392e419a47e588a1cff25d","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:12.081Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:12.081Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768514592131,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould detect and prevent refresh token reuse (token theft)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514592586,"env":"test","module":"auth-routes","userId":"0746303044473dddbc06f39d8d86c913","msg":"Login requires MFA verification"}
{"level":30,"time":1768514592599,"env":"test","module":"email-queue","jobId":"2dd2fcd1-0fa6-4804-b909-469c0d55331c","to":"test-1768514592017-7u5mt4@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768514592599,"env":"test","module":"auth-service","email":"test-1768514592017-7u5mt4@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768514592684,"env":"test","module":"mfa-service","userId":"0746303044473dddbc06f39d8d86c913","msg":"TOTP verification successful"}
{"level":30,"time":1768514592732,"env":"test","module":"auth-routes","userId":"0746303044473dddbc06f39d8d86c913","msg":"MFA login successful"}
{"level":30,"time":1768514592802,"env":"test","module":"auth-routes","userId":"af650a8a82431f59bac424913f074272","msg":"User logged in successfully"}
{"level":50,"time":1768514592851,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["af650a8a82431f59bac424913f074272","login_success","security","af650a8a82431f59bac424913f074272","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:12.802Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:12.802Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"af650a8a82431f59bac424913f074272","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514592851,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["af650a8a82431f59bac424913f074272","login_success","security","af650a8a82431f59bac424913f074272","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:12.802Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:12.802Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768514592856,"env":"test","module":"auth-service","tokenHash":"66ecb076d7aba5f6e1cea513db22644066124ca3b3fae0bb8ca0a6c90394c79e","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768514592858,"env":"test","workflowId":"1ef4e2b1-6764-482d-a3e1-5ded717c8476","userId":"056741f1-cb6f-4837-852b-d1cf04878bd9","sectionsCount":1,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould prevent backup code reuse
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514593332,"env":"test","module":"email-queue","jobId":"8a080ca9-2ace-493f-af47-2e9ad879002c","to":"duplicate@test.com","subject":"You've been invited to join Test Organization","msg":"Email added to queue"}
{"level":30,"time":1768514593335,"env":"test","module":"auth-service","tokenHash":"66ecb076d7aba5f6e1cea513db22644066124ca3b3fae0bb8ca0a6c90394c79e","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w47
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w47,public

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould return 404 for non-existent session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768514593383,"env":"test","module":"auth-service","userId":"af650a8a82431f59bac424913f074272","tokenHash":"66ecb076d7aba5f6e1cea513db22644066124ca3b3fae0bb8ca0a6c90394c79e","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w47 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w47%2Cpublic

{"level":30,"time":1768514593774,"env":"test","module":"email-queue","jobId":"7748d746-6e80-4dee-8cc6-8e459bb178a5","to":"test-1768514593210-cxss7i@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768514593774,"env":"test","module":"auth-service","email":"test-1768514593210-cxss7i@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768514593810,"env":"test","module":"auth-routes","userId":"ed9c5636a9bbe06cc5659c2adc5b772d","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 0f832fc4d6355f65d0ad11f36b6c67ac

{"level":30,"time":1768514593838,"env":"test","module":"auth-routes","userId":"da84e66b0591bbc28986d6e66f69f79d","msg":"User logged in successfully"}
{"level":50,"time":1768514593858,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["ed9c5636a9bbe06cc5659c2adc5b772d","login_success","security","ed9c5636a9bbe06cc5659c2adc5b772d","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:13.810Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:13.810Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"ed9c5636a9bbe06cc5659c2adc5b772d","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514593858,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["ed9c5636a9bbe06cc5659c2adc5b772d","login_success","security","ed9c5636a9bbe06cc5659c2adc5b772d","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:13.810Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:13.810Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768514593863,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768514593886,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["da84e66b0591bbc28986d6e66f69f79d","login_success","security","da84e66b0591bbc28986d6e66f69f79d","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:13.838Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:13.838Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"da84e66b0591bbc28986d6e66f69f79d","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514593886,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["da84e66b0591bbc28986d6e66f69f79d","login_success","security","da84e66b0591bbc28986d6e66f69f79d","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:13.838Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:13.838Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768514593891,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768514594144,"env":"test","module":"email-queue","jobId":"39eb40f2-db3c-4711-bda1-037794aa3b5c","to":"expired@test.com","subject":"You've been invited to join Test Organization","msg":"Email added to queue"}
{"level":30,"time":1768514594149,"env":"test","module":"user-credentials-repository","userId":"28db51bf4ba0bb01f2dfd168477151a7","msg":"User password updated"}
{"level":50,"time":1768514594309,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["28db51bf4ba0bb01f2dfd168477151a7","password_reset","security","28db51bf4ba0bb01f2dfd168477151a7","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:14.262Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:14.262Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"28db51bf4ba0bb01f2dfd168477151a7","eventType":"password_reset","msg":"Failed to log security event"}
{"level":50,"time":1768514594309,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["28db51bf4ba0bb01f2dfd168477151a7","password_reset","security","28db51bf4ba0bb01f2dfd168477151a7","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:14.262Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:14.262Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Reset password error"}
{"level":30,"time":1768514594421,"env":"test","module":"email-queue","jobId":"5e743b2c-c4f3-4cc2-b20f-b62d0253d31e","to":"newuser_1768514583002@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould list all active sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for c9539ff189bdb3c9264df78dfe8d917f

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514594949,"env":"test","module":"auth-routes","userId":"f8667043d0327347e589bdbfb1911c4d","msg":"User logged in successfully"}
{"level":50,"time":1768514594995,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["f8667043d0327347e589bdbfb1911c4d","login_success","security","f8667043d0327347e589bdbfb1911c4d","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:14.949Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-15T22:03:14.949Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"f8667043d0327347e589bdbfb1911c4d","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514594995,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["f8667043d0327347e589bdbfb1911c4d","login_success","security","f8667043d0327347e589bdbfb1911c4d","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:14.949Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-15T22:03:14.949Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould list all active sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514595273,"env":"test","module":"auth-routes","userId":"0f832fc4d6355f65d0ad11f36b6c67ac","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould try TOTP before backup code
[22m[39m[TEST UTILS] MFA Secret verified for 9ad04fe55ffec11cd9ebb24485be8958

{"level":30,"time":1768514595351,"env":"test","module":"email-queue","jobId":"945a7321-0d57-454a-8154-8fb278897c5f","to":"placeholder-test@example.com","subject":"You've been invited to join Test Org Audit","msg":"Email added to queue"}
{"level":30,"time":1768514595381,"env":"test","module":"mfa-service","userId":"0f832fc4d6355f65d0ad11f36b6c67ac","msg":"TOTP verification successful"}
{"level":30,"time":1768514595432,"env":"test","module":"auth-routes","userId":"0f832fc4d6355f65d0ad11f36b6c67ac","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking other user's session
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould try TOTP before backup code
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514595577,"env":"test","module":"auth-routes","userId":"0f832fc4d6355f65d0ad11f36b6c67ac","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768514595672,"env":"test","module":"auth-routes","userId":"0f832fc4d6355f65d0ad11f36b6c67ac","deviceCount":1,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514595767,"env":"test","module":"auth-routes","userId":"f8667043d0327347e589bdbfb1911c4d","msg":"User logged in successfully"}
{"level":30,"time":1768514595773,"env":"test","module":"email-queue","jobId":"f55ae057-11cf-41e6-b079-81b986d0ba85","to":"test-1768514595217-oaaxcc@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768514595773,"env":"test","module":"auth-service","email":"test-1768514595217-oaaxcc@example.com","msg":"Password reset email sent"}
{"level":50,"time":1768514595810,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["f8667043d0327347e589bdbfb1911c4d","login_success","security","f8667043d0327347e589bdbfb1911c4d","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:15.767Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (iPhone; CPU iPhone OS 14_0)","2026-01-15T22:03:15.767Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"f8667043d0327347e589bdbfb1911c4d","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514595810,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["f8667043d0327347e589bdbfb1911c4d","login_success","security","f8667043d0327347e589bdbfb1911c4d","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:15.767Z\"}}","::ffff:127.0.0.1","Mozilla/5.0 (iPhone; CPU iPhone OS 14_0)","2026-01-15T22:03:15.767Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768514595817,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768514596004,"env":"test","module":"auth-routes","userId":"9ad04fe55ffec11cd9ebb24485be8958","msg":"Login requires MFA verification"}
{"level":30,"time":1768514596010,"env":"test","module":"auth-routes","userId":"71749eb6149c6db278abb1739eff6834","msg":"User logged in successfully"}
{"level":50,"time":1768514596060,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["71749eb6149c6db278abb1739eff6834","login_success","security","71749eb6149c6db278abb1739eff6834","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:16.010Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:16.010Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"71749eb6149c6db278abb1739eff6834","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514596060,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["71749eb6149c6db278abb1739eff6834","login_success","security","71749eb6149c6db278abb1739eff6834","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:16.010Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:16.010Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768514596065,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking other user's session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514596066,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768514596107,"env":"test","module":"mfa-service","userId":"9ad04fe55ffec11cd9ebb24485be8958","msg":"TOTP verification successful"}
 [32m‚úì[39m tests/integration/organizations-workflow.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 10438[2mms[22m[39m
       [33m[2m‚úì[22m[39m Step 1: Create organization [33m 640[2mms[22m[39m
       [33m[2m‚úì[22m[39m Step 2: Invite member via email [33m 859[2mms[22m[39m
       [33m[2m‚úì[22m[39m Step 3: Accept invite [33m 985[2mms[22m[39m
       [33m[2m‚úì[22m[39m Step 6: Org member (user2) can access workflow [33m 576[2mms[22m[39m
       [33m[2m‚úì[22m[39m Step 16: Re-add member and verify access restored [33m 670[2mms[22m[39m
       [33m[2m‚úì[22m[39m Cannot invite same email twice (pending invite exists) [33m 802[2mms[22m[39m
       [33m[2m‚úì[22m[39m Cannot accept expired invite [33m 731[2mms[22m[39m
       [33m[2m‚úì[22m[39m Cannot transfer workflow to org user is not a member of [33m 848[2mms[22m[39m
{"level":30,"time":1768514596137,"env":"test","module":"auth-routes","userId":"c9539ff189bdb3c9264df78dfe8d917f","msg":"Login requires MFA verification"}
{"level":30,"time":1768514596159,"env":"test","module":"auth-routes","userId":"9ad04fe55ffec11cd9ebb24485be8958","msg":"MFA login successful"}
{"level":30,"time":1768514596232,"env":"test","module":"mfa-service","userId":"c9539ff189bdb3c9264df78dfe8d917f","msg":"TOTP verification successful"}
{"level":30,"time":1768514596277,"env":"test","module":"auth-routes","userId":"c9539ff189bdb3c9264df78dfe8d917f","msg":"MFA login successful"}
{"level":30,"time":1768514596297,"env":"test","module":"email-queue","jobId":"5962875e-8ca3-4272-9cb0-39553a63634e","to":"existing_1768514583002@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

{"level":30,"time":1768514596448,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514596448,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/engine/templateNode.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 11390[2mms[22m[39m
       [33m[2m‚úì[22m[39m should resolve template by key from workflowTemplates mapping [33m 686[2mms[22m[39m
       [33m[2m‚úì[22m[39m should throw error if template key not found [33m 665[2mms[22m[39m
       [33m[2m‚úì[22m[39m should store output in runOutputs table [33m 708[2mms[22m[39m
       [33m[2m‚úì[22m[39m should resolve template by templateId directly [33m 535[2mms[22m[39m
       [33m[2m‚úì[22m[39m should throw error if templateId not found [33m 541[2mms[22m[39m
       [33m[2m‚úì[22m[39m should use docxRenderer2 by default (v2 engine) [33m 595[2mms[22m[39m
       [33m[2m‚úì[22m[39m should use legacy engine when engine="legacy" [33m 550[2mms[22m[39m
       [33m[2m‚úì[22m[39m should generate PDF when toPdf=true [33m 684[2mms[22m[39m
       [33m[2m‚úì[22m[39m should default to DOCX when toPdf=false [33m 697[2mms[22m[39m
       [33m[2m‚úì[22m[39m should skip execution when condition evaluates to false [33m 488[2mms[22m[39m
       [33m[2m‚úì[22m[39m should execute when condition evaluates to true [33m 623[2mms[22m[39m
       [33m[2m‚úì[22m[39m should resolve simple bindings [33m 557[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle binding resolution errors gracefully [33m 501[2mms[22m[39m
       [33m[2m‚úì[22m[39m should record failed output in runOutputs table [33m 655[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not throw errors (should return error in result) [33m 541[2mms[22m[39m
       [33m[2m‚úì[22m[39m should deny access to templates from different tenant [33m 743[2mms[22m[39m
       [33m[2m‚úì[22m[39m should require either templateKey or templateId [33m 496[2mms[22m[39m
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #8: Placeholder user cleanup[2m > [22m[2mshould cleanup placeholder user when invite is revoked
[22m[39mCleaned up placeholder user 010f1fc8-1bfa-4851-8445-61db35826ad1 (no pending invites or memberships)

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mGET /api/auth/me[2m > [22m[2mshould return current user for valid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514596821,"env":"test","module":"auth-routes","userId":"1e0c36c75db8aaee0d26db9a28fff394","msg":"User logged in successfully"}
{"level":50,"time":1768514596876,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["1e0c36c75db8aaee0d26db9a28fff394","login_success","security","1e0c36c75db8aaee0d26db9a28fff394","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:16.821Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:16.821Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"1e0c36c75db8aaee0d26db9a28fff394","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514596876,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["1e0c36c75db8aaee0d26db9a28fff394","login_success","security","1e0c36c75db8aaee0d26db9a28fff394","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:16.821Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:16.821Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768514596881,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Status[2m > [22m[2mshould return MFA status for user
[22m[39mDEBUG: LOGIN HANDLER HIT

 [32m‚úì[39m tests/unit/services/PdfQueueService.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 11921[2mms[22m[39m
       [33m[2m‚úì[22m[39m should enqueue a PDF conversion job [33m 649[2mms[22m[39m
       [33m[2m‚úì[22m[39m should create output with empty storagePath initially [33m 654[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return job status for pending job [33m 650[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return null for non-existent job [33m 588[2mms[22m[39m
       [33m[2m‚úì[22m[39m should parse attempt count from error field [33m 669[2mms[22m[39m
       [33m[2m‚úì[22m[39m should convert DOCX to PDF immediately [33m 689[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle conversion errors gracefully [33m 643[2mms[22m[39m
       [33m[2m‚úì[22m[39m should start and stop service [33m 832[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not start if already running [33m 530[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle stop when not running [33m 547[2mms[22m[39m
       [33m[2m‚úì[22m[39m should process pending jobs when queue is processed [33m 918[2mms[22m[39m
       [33m[2m‚úì[22m[39m should process multiple jobs in batch [33m 1211[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle missing DOCX output gracefully [33m 754[2mms[22m[39m
       [33m[2m‚úì[22m[39m should support enqueue within transaction [33m 749[2mms[22m[39m
       [33m[2m‚úì[22m[39m should support convertImmediate within transaction [33m 694[2mms[22m[39m
{"level":30,"time":1768514597277,"env":"test","module":"auth-routes","userId":"b6d1c3cdf6901db471a1a3467e0fa927","msg":"User logged in successfully"}
{"level":50,"time":1768514597324,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["b6d1c3cdf6901db471a1a3467e0fa927","login_success","security","b6d1c3cdf6901db471a1a3467e0fa927","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:17.277Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:17.277Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"b6d1c3cdf6901db471a1a3467e0fa927","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514597325,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["b6d1c3cdf6901db471a1a3467e0fa927","login_success","security","b6d1c3cdf6901db471a1a3467e0fa927","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:17.277Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:17.277Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768514597331,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768514597544,"env":"test","module":"auth-routes","userId":"255941f6b6b6ef4c5283ac946d5dae7c","msg":"User logged in successfully"}
{"level":30,"time":1768514597566,"env":"test","module":"auth-routes","userId":"58a64b402f1ca0cd923d1bc89a29f17d","msg":"User logged in successfully"}
{"level":50,"time":1768514597599,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["255941f6b6b6ef4c5283ac946d5dae7c","login_success","security","255941f6b6b6ef4c5283ac946d5dae7c","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:17.544Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:17.545Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"255941f6b6b6ef4c5283ac946d5dae7c","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514597600,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["255941f6b6b6ef4c5283ac946d5dae7c","login_success","security","255941f6b6b6ef4c5283ac946d5dae7c","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:17.544Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:17.545Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768514597609,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["58a64b402f1ca0cd923d1bc89a29f17d","login_success","security","58a64b402f1ca0cd923d1bc89a29f17d","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:17.566Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:17.566Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"58a64b402f1ca0cd923d1bc89a29f17d","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514597609,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["58a64b402f1ca0cd923d1bc89a29f17d","login_success","security","58a64b402f1ca0cd923d1bc89a29f17d","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:17.566Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:17.566Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768514597616,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w49
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w49,public

[90mstdout[2m | tests/unit/services/AuthService.test.ts[2m > [22m[2mAuthService[2m > [22m[2mJWT Token Management[2m > [22m[2mverifyToken()[2m > [22m[2mshould throw error for invalid token signature
[22m[39mDEBUG: verifyToken threw: Invalid or malformed token InvalidTokenError

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w49 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w49%2Cpublic

{"level":30,"time":1768514597781,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514597817,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514597817,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768514597835,"env":"test","msg":"DB: initialized flag set."}
 [32m‚úì[39m tests/integration/organizations-audit-fixes.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 13187[2mms[22m[39m
       [33m[2m‚úì[22m[39m should cascade ownership to workflow runs when project is transferred [33m 1212[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent double-acceptance via transaction [33m 1622[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not create invite if email fails [33m 900[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow re-invite after invite expires [33m 2003[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow last admin to delete empty organization [33m 1287[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent deletion if org owns assets [33m 1085[2mms[22m[39m
       [33m[2m‚úì[22m[39m should cleanup placeholder user when invite is revoked [33m 1961[2mms[22m[39m
       [33m[2m‚úì[22m[39m should fail fast on non-existent org [33m 363[2mms[22m[39m
{"level":30,"time":1768514597900,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514597901,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/repositories/WorkflowTemplateRepository.test.ts [2m([22m[2m19 tests[22m[2m)[22m[33m 13908[2mms[22m[39m
       [33m[2m‚úì[22m[39m should create a workflow template mapping [33m 612[2mms[22m[39m
       [33m[2m‚úì[22m[39m should create non-primary mapping by default [33m 621[2mms[22m[39m
       [33m[2m‚úì[22m[39m should find all templates for a workflow version [33m 676[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return empty array for version with no templates [33m 594[2mms[22m[39m
       [33m[2m‚úì[22m[39m should order by createdAt desc (newest first) [33m 702[2mms[22m[39m
       [33m[2m‚úì[22m[39m should find mapping by workflow version and key [33m 629[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return undefined for non-existent key [33m 606[2mms[22m[39m
       [33m[2m‚úì[22m[39m should find primary template for workflow version [33m 671[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return undefined when no primary template exists [33m 662[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set a template as primary and unset others [33m 822[2mms[22m[39m
       [33m[2m‚úì[22m[39m should handle setting primary when none existed before [33m 833[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not delete mapping if workflow version does not match [33m 797[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return true if key exists in workflow version [33m 626[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return false if key does not exist [33m 588[2mms[22m[39m
       [33m[2m‚úì[22m[39m should exclude specified id when checking existence [33m 611[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return true if key exists on different mapping [33m 700[2mms[22m[39m
       [33m[2m‚úì[22m[39m should update mapping fields [33m 645[2mms[22m[39m
       [33m[2m‚úì[22m[39m should find mapping by id [33m 629[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return undefined for non-existent id [33m 618[2mms[22m[39m
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39m[TEST UTILS] MFA Secret verified for f9718949d95dca444585d1c209a5a9f0

{"level":30,"time":1768514598070,"env":"test","module":"auth-service","email":"reset@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768514598075,"env":"test","module":"auth-service","email":"reset@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768514598115,"env":"test","module":"auth-service","tokenHash":"0f45e858fbc4176cdf4e411f88281edefc390ae5afe7df0f44cd9297f0a64580","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768514598117,"env":"test","module":"auth-service","tokenHash":"9206c2394794b8fc97fcd896f95e40028ab7a15c10279446c23fbdd4b4ae7a1e","plainTokenLen":13,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768514598117,"env":"test","module":"auth-service","tokenHash":"9206c2394794b8fc97fcd896f95e40028ab7a15c10279446c23fbdd4b4ae7a1e","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768514598118,"env":"test","module":"auth-service","allTokensCount":0,"msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768514598120,"env":"test","module":"auth-service","tokenHash":"0f45e858fbc4176cdf4e411f88281edefc390ae5afe7df0f44cd9297f0a64580","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768514598120,"env":"test","module":"auth-service","userId":"user-123","tokenHash":"0f45e858fbc4176cdf4e411f88281edefc390ae5afe7df0f44cd9297f0a64580","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768514598122,"env":"test","module":"auth-service","tokenHash":"0f45e858fbc4176cdf4e411f88281edefc390ae5afe7df0f44cd9297f0a64580","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768514598122,"env":"test","module":"auth-service","userId":"user-123","msg":"Security: Expired refresh token used"}
{"level":30,"time":1768514598126,"env":"test","module":"auth-service","msg":"Cleaned up expired tokens and old login attempts"}
{"level":30,"time":1768514598128,"env":"test","module":"auth-service","msg":"Cleaned up expired tokens and old login attempts"}
{"level":30,"time":1768514598129,"env":"test","module":"auth-service","msg":"Cleaned up expired tokens and old login attempts"}
{"level":30,"time":1768514598131,"env":"test","module":"auth-service","msg":"Cleaned up expired tokens and old login attempts"}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w48
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w48,public

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w49, public

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w48 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w48%2Cpublic

{"level":50,"time":1768514598226,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768514598227,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768514598231,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w49
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w46.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w46.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514598275,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514598427,"env":"test","module":"auth-routes","userId":"255941f6b6b6ef4c5283ac946d5dae7c","msg":"User logged in successfully"}
{"level":50,"time":1768514598478,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["255941f6b6b6ef4c5283ac946d5dae7c","login_success","security","255941f6b6b6ef4c5283ac946d5dae7c","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:18.428Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:18.428Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"255941f6b6b6ef4c5283ac946d5dae7c","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514598478,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["255941f6b6b6ef4c5283ac946d5dae7c","login_success","security","255941f6b6b6ef4c5283ac946d5dae7c","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:18.428Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:18.428Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768514598485,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w48, public

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w48
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w49.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w49.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould complete MFA login with valid TOTP code
[22m[39m[TEST UTILS] MFA Secret verified for b1073a7f7ec9482de4ee840837bd7e56

{"level":30,"time":1768514598803,"env":"test","module":"auth-routes","userId":"f9718949d95dca444585d1c209a5a9f0","msg":"Login requires MFA verification"}
{"level":30,"time":1768514598902,"env":"test","module":"mfa-service","userId":"f9718949d95dca444585d1c209a5a9f0","msg":"TOTP verification successful"}
{"level":30,"time":1768514598948,"env":"test","module":"auth-routes","userId":"f9718949d95dca444585d1c209a5a9f0","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Status[2m > [22m[2mshould return backup codes count for MFA users
[22m[39m[TEST UTILS] MFA Secret verified for a2627d2a576ace91d7f2f236f2d03df0

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould complete MFA login with valid TOTP code
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514599038,"env":"test","module":"email-queue","jobId":"13969a30-e461-4e1d-9268-c82892220c3f","to":"newuser_1768514583002@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
{"level":30,"time":1768514599089,"env":"test","module":"auth-routes","userId":"f9718949d95dca444585d1c209a5a9f0","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514599159,"env":"test","module":"auth-routes","userId":"eae7cb84456bcf51e37c847731958980","msg":"User logged in successfully"}
{"level":50,"time":1768514599203,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["eae7cb84456bcf51e37c847731958980","login_success","security","eae7cb84456bcf51e37c847731958980","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:19.159Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:19.160Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"eae7cb84456bcf51e37c847731958980","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514599203,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["eae7cb84456bcf51e37c847731958980","login_success","security","eae7cb84456bcf51e37c847731958980","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:19.159Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:19.160Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Status[2m > [22m[2mshould return backup codes count for MFA users
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514599336,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514599336,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768514599379,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514599380,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/services/WorkflowTemplateService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 16172[2mms[22m[39m
       [33m[2m‚úì[22m[39m should throw error if template belongs to different project [33m 579[2mms[22m[39m
       [33m[2m‚úì[22m[39m should automatically unset other primaries when setting new primary [33m 1013[2mms[22m[39m
         [33m[2m‚úì[22m[39m should list all templates for workflow version [33m 758[2mms[22m[39m
         [33m[2m‚úì[22m[39m should return empty array for version with no templates [33m 769[2mms[22m[39m
         [33m[2m‚úì[22m[39m should get template mapping by id and version [33m 650[2mms[22m[39m
         [33m[2m‚úì[22m[39m should throw error if mapping not found [33m 489[2mms[22m[39m
         [33m[2m‚úì[22m[39m should get template by key [33m 630[2mms[22m[39m
         [33m[2m‚úì[22m[39m should throw error if key not found [33m 501[2mms[22m[39m
         [33m[2m‚úì[22m[39m should get primary template for workflow version [33m 737[2mms[22m[39m
         [33m[2m‚úì[22m[39m should return null when no primary template exists [33m 589[2mms[22m[39m
         [33m[2m‚úì[22m[39m should update mapping key [33m 694[2mms[22m[39m
         [33m[2m‚úì[22m[39m should update isPrimary flag [33m 1132[2mms[22m[39m
         [33m[2m‚úì[22m[39m should throw error if new key already exists [33m 731[2mms[22m[39m
         [33m[2m‚úì[22m[39m should throw error if mapping not found [33m 484[2mms[22m[39m
         [33m[2m‚úì[22m[39m should unset other primaries when setting isPrimary to true [33m 981[2mms[22m[39m
         [33m[2m‚úì[22m[39m should detach template from workflow version [33m 801[2mms[22m[39m
         [33m[2m‚úì[22m[39m should throw error if mapping not found [33m 504[2mms[22m[39m
         [33m[2m‚úì[22m[39m should set template as primary [33m 927[2mms[22m[39m
         [33m[2m‚úì[22m[39m should throw error if mapping not found [33m 534[2mms[22m[39m
         [33m[2m‚úì[22m[39m should support operations within a transaction [33m 722[2mms[22m[39m
         [33m[2m‚úì[22m[39m should rollback on transaction error [33m 741[2mms[22m[39m
 [31m‚ùØ[39m tests/integration/auth.flows.real.test.ts [2m([22m[2m11 tests[22m[2m | [22m[31m6 failed[39m[2m)[22m[33m 29490[2mms[22m[39m
[31m       [31m√ó[31m should complete registration, verify email, then login[39m[33m 2449[2mms[22m[39m
       [33m[2m‚úì[22m[39m should lock account after 5 failed attempts, then unlock after waiting [33m 3989[2mms[22m[39m
       [33m[2m‚úì[22m[39m should record all login attempts [33m 3005[2mms[22m[39m
[31m       [31m√ó[31m should complete MFA setup and login with TOTP[39m[33m 1861[2mms[22m[39m
[31m       [31m√ó[31m should login with backup code when TOTP unavailable[39m[33m 2040[2mms[22m[39m
[31m       [31m√ó[31m should complete full password reset flow[39m[33m 2415[2mms[22m[39m
       [33m[2m‚úì[22m[39m should invalidate all sessions after password reset [33m 2851[2mms[22m[39m
       [33m[2m‚úì[22m[39m should rotate refresh token on each use [33m 2368[2mms[22m[39m
       [33m[2m‚úì[22m[39m should detect and prevent refresh token reuse (token theft) [33m 2120[2mms[22m[39m
[31m       [31m√ó[31m should list all active sessions[39m[33m 2604[2mms[22m[39m
[31m       [31m√ó[31m should revoke specific session[39m[33m 2631[2mms[22m[39m
{"level":30,"time":1768514599516,"env":"test","module":"auth-routes","userId":"b1073a7f7ec9482de4ee840837bd7e56","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768514599617,"env":"test","module":"mfa-service","userId":"b1073a7f7ec9482de4ee840837bd7e56","msg":"TOTP verification successful"}
{"level":30,"time":1768514599629,"env":"test","module":"auth-routes","userId":"f9718949d95dca444585d1c209a5a9f0","msg":"Login from trusted device - MFA skipped"}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w50
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w50,public

{"level":30,"time":1768514599665,"env":"test","module":"auth-routes","userId":"b1073a7f7ec9482de4ee840837bd7e56","msg":"MFA login successful"}
{"level":30,"time":1768514599677,"env":"test","module":"auth-routes","userId":"f9718949d95dca444585d1c209a5a9f0","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w50 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w50%2Cpublic

{"level":30,"time":1768514599686,"env":"test","msg":"DB: initializing... Local"}
{"level":50,"time":1768514599731,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["f9718949d95dca444585d1c209a5a9f0","login_success","security","f9718949d95dca444585d1c209a5a9f0","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:19.678Z\"}}","192.168.1.100","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-15T22:03:19.678Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"f9718949d95dca444585d1c209a5a9f0","eventType":"login_success","msg":"Failed to log security event"}
{"level":30,"time":1768514599743,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768514599732,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["f9718949d95dca444585d1c209a5a9f0","login_success","security","f9718949d95dca444585d1c209a5a9f0","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:19.678Z\"}}","192.168.1.100","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-15T22:03:19.678Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":30,"time":1768514599754,"env":"test","module":"auth-routes","userId":"a2627d2a576ace91d7f2f236f2d03df0","msg":"Login requires MFA verification"}
{"level":30,"time":1768514599906,"env":"test","module":"mfa-service","userId":"a2627d2a576ace91d7f2f236f2d03df0","msg":"TOTP verification successful"}
{"level":30,"time":1768514599954,"env":"test","module":"auth-routes","userId":"a2627d2a576ace91d7f2f236f2d03df0","msg":"MFA login successful"}
{"level":30,"time":1768514600010,"env":"test","module":"auth-routes","userId":"eae7cb84456bcf51e37c847731958980","msg":"User logged in successfully"}
{"level":50,"time":1768514600058,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["eae7cb84456bcf51e37c847731958980","login_success","security","eae7cb84456bcf51e37c847731958980","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:20.010Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:20.010Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"eae7cb84456bcf51e37c847731958980","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514600058,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["eae7cb84456bcf51e37c847731958980","login_success","security","eae7cb84456bcf51e37c847731958980","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:20.010Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:20.010Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w50, public

{"level":30,"time":1768514600123,"env":"test","module":"writeback-execution-service","runId":"f709d1da-c972-478c-a0d6-82b70dfbb914","workflowId":"2c97b51d-6e18-4c3f-9cfa-54dc2da70ea7","msg":"Executing writeback mappings for completed run"}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w50
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768514600172,"env":"test","module":"auth-service","tokenHash":"e2ed1b68ca52d5725169a3ac58c9986cc4c84364ce7cb3ff45f615af6fde1bb5","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768514600174,"env":"test","module":"writeback-execution-service","runId":"f709d1da-c972-478c-a0d6-82b70dfbb914","workflowId":"2c97b51d-6e18-4c3f-9cfa-54dc2da70ea7","mappingCount":1,"msg":"Found writeback mappings"}
{"level":30,"time":1768514600175,"env":"test","module":"auth-service","email":"reset@example.com","msg":"Password reset email sent"}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w48.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w48.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514600376,"env":"test","module":"writeback-execution-service","runId":"f709d1da-c972-478c-a0d6-82b70dfbb914","workflowId":"2c97b51d-6e18-4c3f-9cfa-54dc2da70ea7","mappingId":"d9de3fce-7033-4b7f-9932-01697ef2b20c","tableId":"63a688da-964c-4eee-924c-14c71f6409d7","msg":"Executing writeback mapping"}
{"level":30,"time":1768514600658,"env":"test","module":"auth-service","email":"reset@example.com","msg":"Password reset email sent"}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w51
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w51,public

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould reject invalid MFA code
[22m[39m[TEST UTILS] MFA Secret verified for 0153963b24b5462ae620167a3e27fe68

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w51 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w51%2Cpublic

{"level":30,"time":1768514600764,"env":"test","module":"writeback-execution-service","runId":"f709d1da-c972-478c-a0d6-82b70dfbb914","workflowId":"2c97b51d-6e18-4c3f-9cfa-54dc2da70ea7","mappingId":"d9de3fce-7033-4b7f-9932-01697ef2b20c","columnCount":3,"msg":"Successfully created DataVault row"}
{"level":30,"time":1768514600764,"env":"test","module":"writeback-execution-service","runId":"f709d1da-c972-478c-a0d6-82b70dfbb914","workflowId":"2c97b51d-6e18-4c3f-9cfa-54dc2da70ea7","rowsCreated":1,"errorCount":0,"msg":"Writeback execution completed"}
[90mstdout[2m | tests/integration/analytics_service.test.ts[2m > [22m[2mAnalytics Service Integration
[22m[39mMANUAL PATCH: Applied FK fix for workflow_run_events AND workflow_run_metrics

{"level":30,"time":1768514600828,"env":"test","module":"auth-routes","userId":"eae7cb84456bcf51e37c847731958980","msg":"User logged in successfully"}
{"level":50,"time":1768514600881,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["eae7cb84456bcf51e37c847731958980","login_success","security","eae7cb84456bcf51e37c847731958980","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:20.828Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:20.828Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"eae7cb84456bcf51e37c847731958980","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514600881,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["eae7cb84456bcf51e37c847731958980","login_success","security","eae7cb84456bcf51e37c847731958980","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:20.828Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:20.828Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

{"level":40,"time":1768514601109,"env":"test","module":"mfa-service","userId":"0153963b24b5462ae620167a3e27fe68","msg":"TOTP verification failed"}
{"level":40,"time":1768514601109,"env":"test","module":"auth-routes","userId":"0153963b24b5462ae620167a3e27fe68","msg":"MFA verification failed during login"}
{"level":30,"time":1768514601131,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514601131,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w52
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w52,public

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Disable Flow[2m > [22m[2mshould disable MFA with password verification
[22m[39m[TEST UTILS] MFA Secret verified for c5cc1e95036acdde2cd981b399423176

 [32m‚úì[39m tests/integration/organizationService.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 17875[2mms[22m[39m
       [33m[2m‚úì[22m[39m should create organization and auto-create admin membership [33m 949[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return all organizations for user [33m 961[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return empty array for user with no memberships [33m 632[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow admin to update organization [33m 1369[2mms[22m[39m
       [33m[2m‚úì[22m[39m should deny non-admin from updating organization [33m 1175[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return all members of organization [33m 1115[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow admin to promote member [33m 1782[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow admin to demote other admin [33m 2034[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent self-demotion [33m 961[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow admin to remove member [33m 2055[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent self-removal [33m 982[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow member to leave organization [33m 1348[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow admin to leave organization [33m 1363[2mms[22m[39m
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39m[TEST UTILS] MFA Secret verified for bcdfba03b979684e779db3a5ae4030dc

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w52 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w52%2Cpublic

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/services/AuthService.test.ts [2m([22m[2m113 tests[22m[2m)[22m[33m 8421[2mms[22m[39m
         [33m[2m‚úì[22m[39m should generate different hashes for same password [33m 438[2mms[22m[39m
         [33m[2m‚úì[22m[39m should return true for correct password [33m 428[2mms[22m[39m
         [33m[2m‚úì[22m[39m should return false for incorrect password [33m 448[2mms[22m[39m
         [33m[2m‚úì[22m[39m should be case-sensitive [33m 447[2mms[22m[39m
         [33m[2m‚úì[22m[39m should handle empty password comparison [33m 443[2mms[22m[39m
         [33m[2m‚úì[22m[39m should throw error for expired token [33m 1106[2mms[22m[39m
         [33m[2m‚úì[22m[39m should handle password with special characters [33m 519[2mms[22m[39m
         [33m[2m‚úì[22m[39m should handle password with newlines and tabs [33m 493[2mms[22m[39m
         [33m[2m‚úì[22m[39m should reject password with null bytes (if validation exists) [33m 501[2mms[22m[39m
         [33m[2m‚úì[22m[39m should support complete password reset workflow [33m 483[2mms[22m[39m
         [33m[2m‚úì[22m[39m should compare password in reasonable time (< 500ms) [33m 492[2mms[22m[39m
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Disable Flow[2m > [22m[2mshould disable MFA with password verification
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514601688,"env":"test","module":"auth-routes","userId":"eae7cb84456bcf51e37c847731958980","msg":"User logged in successfully"}
{"level":30,"time":1768514601692,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514601693,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768514601735,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["eae7cb84456bcf51e37c847731958980","login_success","security","eae7cb84456bcf51e37c847731958980","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:21.689Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:21.689Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"eae7cb84456bcf51e37c847731958980","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514601735,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["eae7cb84456bcf51e37c847731958980","login_success","security","eae7cb84456bcf51e37c847731958980","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:21.689Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:21.689Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768514601742,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514601773,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514601796,"env":"test","module":"writeback-execution-service","runId":"1013fcf3-8ef5-498b-9375-0ba803f3feed","workflowId":"2c97b51d-6e18-4c3f-9cfa-54dc2da70ea7","msg":"Executing writeback mappings for completed run"}
 [31m‚ùØ[39m tests/integration/auth.routes.real.test.ts [2m([22m[2m26 tests[22m[2m | [22m[31m3 failed[39m[2m)[22m[33m 31846[2mms[22m[39m
       [33m[2m‚úì[22m[39m should register a new user successfully [33m 1207[2mms[22m[39m
       [32m‚úì[39m should return 400 for invalid email format[32m 7[2mms[22m[39m
       [32m‚úì[39m should return 400 for weak password[32m 7[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 409 for duplicate email [33m 1216[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set httpOnly refresh token cookie [33m 531[2mms[22m[39m
[31m       [31m√ó[31m should login with valid credentials[39m[33m 1965[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 401 for invalid password [33m 1566[2mms[22m[39m
       [32m‚úì[39m should return 401 for non-existent user[32m 156[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 403 for unverified email [33m 1040[2mms[22m[39m
       [33m[2m‚úì[22m[39m should record failed login attempt [33m 1571[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return requiresMfa=true for MFA-enabled users [33m 2045[2mms[22m[39m
       [33m[2m‚úì[22m[39m should lock account after 5 failed attempts [33m 3814[2mms[22m[39m
       [33m[2m‚úì[22m[39m should logout and clear refresh token cookie [33m 1811[2mms[22m[39m
       [33m[2m‚úì[22m[39m should refresh access token with valid refresh token [33m 1956[2mms[22m[39m
       [32m‚úì[39m should return 401 for missing refresh token[32m 4[2mms[22m[39m
       [33m[2m‚úì[22m[39m should rotate refresh token after use [33m 2074[2mms[22m[39m
       [33m[2m‚úì[22m[39m should send password reset email for existing user [33m 1142[2mms[22m[39m
       [32m‚úì[39m should not reveal if email exists (security)[32m 51[2mms[22m[39m
[31m       [31m√ó[31m should reset password with valid token[39m[33m 1957[2mms[22m[39m
       [32m‚úì[39m should return 400 for invalid token[32m 49[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 400 for weak new password [33m 1229[2mms[22m[39m
[31m       [31m√ó[31m should return current user for valid token[39m[33m 1778[2mms[22m[39m
       [32m‚úì[39m should return 401 for missing token[32m 5[2mms[22m[39m
       [32m‚úì[39m should return 401 for invalid token[32m 5[2mms[22m[39m
         [33m[2m‚úì[22m[39m should complete MFA login with valid TOTP code [33m 2005[2mms[22m[39m
         [33m[2m‚úì[22m[39m should reject invalid MFA code [33m 1454[2mms[22m[39m
{"level":30,"time":1768514601835,"env":"test","module":"email-queue","jobId":"c57f24ce-f866-4278-917c-c3fbad527b6a","to":"existing_1768514583002@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
{"level":30,"time":1768514601845,"env":"test","module":"writeback-execution-service","runId":"1013fcf3-8ef5-498b-9375-0ba803f3feed","workflowId":"2c97b51d-6e18-4c3f-9cfa-54dc2da70ea7","mappingCount":1,"msg":"Found writeback mappings"}
{"level":30,"time":1768514601857,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514602001,"env":"test","module":"auth-routes","userId":"bcdfba03b979684e779db3a5ae4030dc","msg":"Login requires MFA verification"}
{"level":30,"time":1768514602025,"env":"test","module":"auth-routes","userId":"c5cc1e95036acdde2cd981b399423176","msg":"Login requires MFA verification"}
{"level":30,"time":1768514602031,"env":"test","module":"writeback-execution-service","runId":"1013fcf3-8ef5-498b-9375-0ba803f3feed","workflowId":"2c97b51d-6e18-4c3f-9cfa-54dc2da70ea7","mappingId":"d9de3fce-7033-4b7f-9932-01697ef2b20c","tableId":"63a688da-964c-4eee-924c-14c71f6409d7","msg":"Executing writeback mapping"}
{"level":30,"time":1768514602102,"env":"test","module":"mfa-service","userId":"bcdfba03b979684e779db3a5ae4030dc","msg":"TOTP verification successful"}
{"level":30,"time":1768514602119,"env":"test","module":"mfa-service","userId":"c5cc1e95036acdde2cd981b399423176","msg":"TOTP verification successful"}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514602122,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514602154,"env":"test","module":"auth-routes","userId":"bcdfba03b979684e779db3a5ae4030dc","msg":"MFA login successful"}
{"level":30,"time":1768514602167,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514602170,"env":"test","module":"auth-routes","userId":"c5cc1e95036acdde2cd981b399423176","msg":"MFA login successful"}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w51, public

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w54
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w54,public

{"level":30,"time":1768514602247,"env":"test","module":"writeback-execution-service","runId":"27c9f916-c1c5-415c-8a8b-33f0680cacaf","workflowId":"ebda433f-a6d2-4028-abff-3fd441b4486f","msg":"Executing writeback mappings for completed run"}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w54 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w54%2Cpublic

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w51
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768514602294,"env":"test","runId":"27c9f916-c1c5-415c-8a8b-33f0680cacaf","service":"DocumentGenerationService","msg":"Starting document generation for run"}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w50.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w50.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514602311,"env":"test","module":"auth-routes","userId":"bcdfba03b979684e779db3a5ae4030dc","deviceFingerprint":"10fa3aea039bf6fec7b6bcb982cbed1cc6ab844dd3c0879bec32baefb2997b52","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768514602401,"env":"test","runId":"27c9f916-c1c5-415c-8a8b-33f0680cacaf","service":"DocumentGenerationService","allSections":[],"runId":"27c9f916-c1c5-415c-8a8b-33f0680cacaf","msg":"No Final Documents sections found, skipping generation. This might cause the frontend to hang."}
{"level":30,"time":1768514602401,"env":"test","runId":"27c9f916-c1c5-415c-8a8b-33f0680cacaf","msg":"Documents generated successfully"}
{"level":30,"time":1768514602411,"env":"test","module":"writeback-execution-service","runId":"1013fcf3-8ef5-498b-9375-0ba803f3feed","workflowId":"2c97b51d-6e18-4c3f-9cfa-54dc2da70ea7","mappingId":"d9de3fce-7033-4b7f-9932-01697ef2b20c","columnCount":3,"msg":"Successfully created DataVault row"}
{"level":30,"time":1768514602412,"env":"test","module":"writeback-execution-service","runId":"1013fcf3-8ef5-498b-9375-0ba803f3feed","workflowId":"2c97b51d-6e18-4c3f-9cfa-54dc2da70ea7","rowsCreated":1,"errorCount":0,"msg":"Writeback execution completed"}
{"level":30,"time":1768514602412,"env":"test","runId":"1013fcf3-8ef5-498b-9375-0ba803f3feed","rowsCreated":1,"msg":"DataVault writeback completed"}
{"level":30,"time":1768514602413,"env":"test","runId":"1013fcf3-8ef5-498b-9375-0ba803f3feed","service":"DocumentGenerationService","msg":"Starting document generation for run"}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w53
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w53,public

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w53 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w53%2Cpublic

{"level":30,"time":1768514602488,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514602488,"env":"test","msg":"DB: pool closed."}
{"level":40,"time":1768514602504,"env":"test","runId":"1013fcf3-8ef5-498b-9375-0ba803f3feed","service":"DocumentGenerationService","allSections":[{"id":"d762770a-916a-4f6d-b1e9-2828b7e0b760","config":{}}],"runId":"1013fcf3-8ef5-498b-9375-0ba803f3feed","msg":"No Final Documents sections found, skipping generation. This might cause the frontend to hang."}
{"level":30,"time":1768514602504,"env":"test","runId":"1013fcf3-8ef5-498b-9375-0ba803f3feed","msg":"Documents generated successfully"}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w52, public

 [32m‚úì[39m tests/integration/ownershipAccess.test.ts [2m([22m[2m19 tests[22m[2m)[22m[33m 5131[2mms[22m[39m
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w52
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768514602574,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514602575,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w51.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w51.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32m‚úì[39m tests/integration/transferOwnership.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 19421[2mms[22m[39m
       [33m[2m‚úì[22m[39m should transfer user-owned project to org [33m 1693[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent transfer to org if user is not a member [33m 1886[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow org member to transfer org-owned project to another org they belong to [33m 2258[2mms[22m[39m
       [33m[2m‚úì[22m[39m should detach workflow from project when transferring to different owner [33m 1588[2mms[22m[39m
       [33m[2m‚úì[22m[39m should keep workflow in project when transferring to same owner [33m 1934[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent non-member from transferring org workflow [33m 1523[2mms[22m[39m
       [33m[2m‚úì[22m[39m should transfer database ownership [33m 1297[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow org member to transfer org database [33m 1398[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent transfer to org if user is not a member [33m 1930[2mms[22m[39m
       [33m[2m‚úì[22m[39m should only allow transfer to self when targetOwnerType is user [33m 1245[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow transfer from user to self (org member transferring org asset to themselves) [33m 1443[2mms[22m[39m
{"level":30,"time":1768514602711,"env":"test","module":"mfa-service","userId":"c5cc1e95036acdde2cd981b399423176","msg":"MFA disabled"}
{"level":30,"time":1768514602711,"env":"test","module":"auth-routes","userId":"c5cc1e95036acdde2cd981b399423176","msg":"MFA disabled by user"}
{"level":50,"time":1768514602756,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["c5cc1e95036acdde2cd981b399423176","mfa_disabled","security","c5cc1e95036acdde2cd981b399423176","{\"metadata\":{\"mfaMethod\":\"totp\",\"timestamp\":\"2026-01-15T22:03:22.711Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:22.711Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"c5cc1e95036acdde2cd981b399423176","eventType":"mfa_disabled","msg":"Failed to log security event"}
{"level":50,"time":1768514602756,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["c5cc1e95036acdde2cd981b399423176","mfa_disabled","security","c5cc1e95036acdde2cd981b399423176","{\"metadata\":{\"mfaMethod\":\"totp\",\"timestamp\":\"2026-01-15T22:03:22.711Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:22.711Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"MFA disable error"}
{"level":50,"time":1768514602765,"env":"test","error":{"query":"insert into \"workflow_run_events\" (\"id\", \"run_id\", \"version_id\", \"workflow_id\", \"block_id\", \"page_id\", \"type\", \"timestamp\", \"payload\", \"is_preview\") values (default, $1, $2, $3, default, default, $4, $5, $6, $7)","params":["1013fcf3-8ef5-498b-9375-0ba803f3feed","draft","2c97b51d-6e18-4c3f-9cfa-54dc2da70ea7","workflow.complete","2026-01-15T22:03:22.712Z","{\"durationMs\":1177,\"stepCount\":2}",false],"cause":{"length":137,"name":"error","severity":"ERROR","code":"22P02","where":"unnamed portal parameter $2 = '...'","file":"uuid.c","line":"138","routine":"string_to_uuid"}},"input":{"runId":"1013fcf3-8ef5-498b-9375-0ba803f3feed","workflowId":"2c97b51d-6e18-4c3f-9cfa-54dc2da70ea7","versionId":"draft","type":"workflow.complete","timestamp":"2026-01-15T22:03:22.712Z","isPreview":false,"payload":{"durationMs":1177,"stepCount":2}},"msg":"Failed to record analytics event"}
{"level":30,"time":1768514602819,"env":"test","module":"auth-routes","userId":"bcdfba03b979684e779db3a5ae4030dc","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould keep current session active
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514603166,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514603237,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514603468,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

{"level":30,"time":1768514603526,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514603590,"env":"test","module":"auth-routes","userId":"7a13026f39f40e39d6293985e3980564","msg":"User logged in successfully"}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w54, public

{"level":50,"time":1768514603636,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["7a13026f39f40e39d6293985e3980564","login_success","security","7a13026f39f40e39d6293985e3980564","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:23.590Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:23.590Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"7a13026f39f40e39d6293985e3980564","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514603636,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["7a13026f39f40e39d6293985e3980564","login_success","security","7a13026f39f40e39d6293985e3980564","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:23.590Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:23.590Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w54
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould keep current session active
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w52.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w52.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w55
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w55,public

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w55 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w55%2Cpublic

{"level":30,"time":1768514603867,"env":"test","module":"email-queue","jobId":"675fdb55-6b3f-4492-9759-94690ac71b98","to":"existing_1768514583002@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w53, public

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w53
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39m[TEST UTILS] MFA Secret verified for 248338899ed358de1e393384b8f8f586

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w54.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w54.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514604033,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514604034,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Disable Flow[2m > [22m[2mshould require correct password to disable MFA
[22m[39m[TEST UTILS] MFA Secret verified for 9c2af734fde528db4d01a57cc749e339

 [32m‚úì[39m tests/integration/analytics_service.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 4770[2mms[22m[39m
     [33m[2m‚úì[22m[39m should generate events and metrics on run completion [33m 2865[2mms[22m[39m
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514604400,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514604401,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Disable Flow[2m > [22m[2mshould require correct password to disable MFA
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514604523,"env":"test","module":"auth-routes","userId":"7a13026f39f40e39d6293985e3980564","msg":"User logged in successfully"}
 [32m‚úì[39m tests/integration/workflows/runtime-pipelines.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 6624[2mms[22m[39m
       [33m[2m‚úì[22m[39m should create DataVault row on workflow completion [33m 905[2mms[22m[39m
       [33m[2m‚úì[22m[39m should execute writebacks via RunService.completeRun() [33m 2376[2mms[22m[39m
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

{"level":50,"time":1768514604584,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["7a13026f39f40e39d6293985e3980564","login_success","security","7a13026f39f40e39d6293985e3980564","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:24.523Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:24.523Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"7a13026f39f40e39d6293985e3980564","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514604584,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["7a13026f39f40e39d6293985e3980564","login_success","security","7a13026f39f40e39d6293985e3980564","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:24.523Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:24.523Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768514604590,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768514604597,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768514604738,"env":"test","module":"auth-routes","userId":"248338899ed358de1e393384b8f8f586","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w56
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w56,public

{"level":30,"time":1768514604840,"env":"test","module":"mfa-service","userId":"248338899ed358de1e393384b8f8f586","msg":"TOTP verification successful"}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w56 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w56%2Cpublic

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514604855,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514604889,"env":"test","module":"auth-routes","userId":"248338899ed358de1e393384b8f8f586","msg":"MFA login successful"}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w57
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w57,public

{"level":30,"time":1768514604942,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w57 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w57%2Cpublic

{"level":30,"time":1768514604973,"env":"test","module":"auth-routes","userId":"9c2af734fde528db4d01a57cc749e339","msg":"Login requires MFA verification"}
{"level":30,"time":1768514605047,"env":"test","module":"auth-routes","userId":"248338899ed358de1e393384b8f8f586","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768514605071,"env":"test","module":"mfa-service","userId":"9c2af734fde528db4d01a57cc749e339","msg":"TOTP verification successful"}
{"level":30,"time":1768514605124,"env":"test","module":"auth-routes","userId":"9c2af734fde528db4d01a57cc749e339","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w55, public

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w55
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w53.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w53.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514605438,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514605439,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/ui/datavault/TableCard.test.tsx [2m([22m[2m8 tests[22m[2m)[22m[33m 3661[2mms[22m[39m
     [33m[2m‚úì[22m[39m should call onDelete when delete button is clicked [33m 1259[2mms[22m[39m
{"level":30,"time":1768514605761,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514605761,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768514605778,"env":"test","module":"auth-routes","userId":"248338899ed358de1e393384b8f8f586","msg":"Login from trusted device - MFA skipped"}
{"level":30,"time":1768514605828,"env":"test","module":"auth-routes","userId":"248338899ed358de1e393384b8f8f586","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w61
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w61,public

 [32m‚úì[39m tests/ui/runs.components.test.tsx [2m([22m[2m19 tests[22m[2m)[22m[33m 4988[2mms[22m[39m
       [33m[2m‚úì[22m[39m should show download options for successful runs [33m 947[2mms[22m[39m
       [33m[2m‚úì[22m[39m should call onChange when status filter changes [33m 754[2mms[22m[39m
{"level":50,"time":1768514605879,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["248338899ed358de1e393384b8f8f586","login_success","security","248338899ed358de1e393384b8f8f586","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:25.828Z\"}}","192.168.1.100","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-15T22:03:25.828Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"248338899ed358de1e393384b8f8f586","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514605879,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["248338899ed358de1e393384b8f8f586","login_success","security","248338899ed358de1e393384b8f8f586","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:25.828Z\"}}","192.168.1.100","Mozilla/5.0 (Windows NT 10.0; Win64; x64)","2026-01-15T22:03:25.828Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514605884,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w61 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w61%2Cpublic

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould return 400 if no active session found
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514605939,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514605975,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514605976,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514606009,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w58
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w58,public

[90mstdout[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould return validation errors for invalid expression
[22m[39mValidation Result DEBUG: {"ok":false,"errors":[{"message":"Unknown identifier: unknown_var","start":{"line":0,"col":0},"end":{"line":0,"col":11}}]}
IsValid DEBUG: [33mfalse[39m

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w58 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w58%2Cpublic

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

{"level":30,"time":1768514606074,"env":"test","msg":"DB: initialized flag set."}
 [32m‚úì[39m tests/ui/datavault/EditableCell.test.tsx [2m([22m[2m29 tests[22m[2m)[22m[33m 5692[2mms[22m[39m
       [33m[2m‚úì[22m[39m cancels edit on Escape key press [33m 452[2mms[22m[39m
       [33m[2m‚úì[22m[39m reverts value on save error [33m 508[2mms[22m[39m
{"level":30,"time":1768514606113,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514606113,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w59
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w59,public

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w59 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w59%2Cpublic

 [32m‚úì[39m tests/unit/collab.client.test.tsx [2m([22m[2m17 tests[22m[2m)[22m[33m 4094[2mms[22m[39m
     [33m[2m‚úì[22m[39m should add a comment [33m 652[2mms[22m[39m
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w56, public

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w56
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w55.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w55.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514606400,"env":"test","module":"auth-routes","userId":"cd3ff8292d86cf91a3d121e4f4bd49d0","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w57, public

{"level":50,"time":1768514606444,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["cd3ff8292d86cf91a3d121e4f4bd49d0","login_success","security","cd3ff8292d86cf91a3d121e4f4bd49d0","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:26.400Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:26.400Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"cd3ff8292d86cf91a3d121e4f4bd49d0","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514606444,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["cd3ff8292d86cf91a3d121e4f4bd49d0","login_success","security","cd3ff8292d86cf91a3d121e4f4bd49d0","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:26.400Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:26.400Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768514606451,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w57
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768514606504,"env":"test","module":"email-queue","jobId":"2d41adc4-79b5-4a25-b052-b97de50e23cf","to":"existing_1768514583002@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w56.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w56.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Regeneration[2m > [22m[2mshould regenerate backup codes
[22m[39m[TEST UTILS] MFA Secret verified for d92e167f51bbaa0c1e597f73ab6c904e

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514606712,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514606760,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514606811,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514606811,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 36965[2mms[22m[39m
       [33m[2m‚úì[22m[39m should trust current device [33m 2250[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set trust expiry to 30 days [33m 2160[2mms[22m[39m
       [33m[2m‚úì[22m[39m should update expiry if device already trusted [33m 2593[2mms[22m[39m
       [32m‚úì[39m should require authentication[32m 6[2mms[22m[39m
       [33m[2m‚úì[22m[39m should list all trusted devices [33m 3854[2mms[22m[39m
       [33m[2m‚úì[22m[39m should mark current device [33m 2348[2mms[22m[39m
       [33m[2m‚úì[22m[39m should exclude revoked devices [33m 2505[2mms[22m[39m
       [33m[2m‚úì[22m[39m should exclude expired devices [33m 2198[2mms[22m[39m
       [33m[2m‚úì[22m[39m should revoke specific device [33m 2431[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return 404 for non-existent device [33m 1955[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent revoking other user's device [33m 4173[2mms[22m[39m
[31m       [31m√ó[31m should skip MFA for trusted device[39m[33m 3155[2mms[22m[39m
       [33m[2m‚úì[22m[39m should require MFA for untrusted device [33m 2738[2mms[22m[39m
       [33m[2m‚úì[22m[39m should update lastUsedAt on trusted device login [33m 3398[2mms[22m[39m
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Regeneration[2m > [22m[2mshould regenerate backup codes
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w61, public

{"level":30,"time":1768514607112,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514607118,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768514607122,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w61
‚è© Schema reused, skipping migrations.

 [32m‚úì[39m tests/ui/expression-editor.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 3757[2mms[22m[39m
       [33m[2m‚úì[22m[39m should update validation when expression changes [33m 315[2mms[22m[39m
{"level":30,"time":1768514607208,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w57.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w57.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514607263,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514607347,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w60
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w60,public

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w60 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w60%2Cpublic

{"level":30,"time":1768514607538,"env":"test","module":"auth-routes","userId":"d92e167f51bbaa0c1e597f73ab6c904e","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w58, public

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w58
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768514607645,"env":"test","module":"mfa-service","userId":"d92e167f51bbaa0c1e597f73ab6c904e","msg":"TOTP verification successful"}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w61.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w61.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514607694,"env":"test","module":"auth-routes","userId":"d92e167f51bbaa0c1e597f73ab6c904e","msg":"MFA login successful"}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w59, public

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w59
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w62
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w62,public

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all trusted devices
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w58.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w58.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w62 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w62%2Cpublic

{"level":30,"time":1768514607818,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514607872,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768514608140,"env":"test","module":"mfa-service","userId":"d92e167f51bbaa0c1e597f73ab6c904e","count":10,"msg":"Stored backup codes"}
{"level":30,"time":1768514608140,"env":"test","module":"mfa-service","userId":"d92e167f51bbaa0c1e597f73ab6c904e","msg":"Regenerated backup codes"}
{"level":30,"time":1768514608140,"env":"test","module":"auth-routes","userId":"d92e167f51bbaa0c1e597f73ab6c904e","msg":"Backup codes regenerated"}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w62, public

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w62
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w59.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w59.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514608369,"env":"test","module":"auth-routes","userId":"ef4a6e528b0cb0050469759b11987f82","msg":"User logged in successfully"}
{"level":40,"time":1768514608381,"env":"test","error":{},"msg":"PDF conversion failed"}
{"level":50,"time":1768514608418,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["ef4a6e528b0cb0050469759b11987f82","login_success","security","ef4a6e528b0cb0050469759b11987f82","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:28.369Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:28.369Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"ef4a6e528b0cb0050469759b11987f82","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514608418,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["ef4a6e528b0cb0050469759b11987f82","login_success","security","ef4a6e528b0cb0050469759b11987f82","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:28.369Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:28.369Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768514608426,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768514608432,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768514608465,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514608491,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768514608578,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/docxRenderer.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 3059[2mms[22m[39m
       [33m[2m‚úì[22m[39m should render a template with simple data [33m 409[2mms[22m[39m
{"level":30,"time":1768514608579,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/components/datavault/TableGridViewDragDrop.test.tsx [2m([22m[2m7 tests[22m[2m)[22m[33m 4228[2mms[22m[39m
     [33m[2m‚úì[22m[39m displays columns in order based on orderIndex [33m 959[2mms[22m[39m
     [33m[2m‚úì[22m[39m maintains column order after successful reorder [33m 341[2mms[22m[39m
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514608815,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514608879,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514609103,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514609104,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/ui/datavault/DatabaseSettingsPage.test.tsx [2m([22m[2m7 tests[22m[2m)[22m[33m 3534[2mms[22m[39m
     [33m[2m‚úì[22m[39m should render database settings page with breadcrumbs [33m 505[2mms[22m[39m
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Regeneration[2m > [22m[2mshould return error if MFA not enabled
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w60, public

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w60
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w62.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w62.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

{"level":30,"time":1768514609431,"env":"test","blockId":"d67da7ee-fc21-4d1e-9d53-d0f8fbcd5077","virtualStepId":"dab86d8a-0b0c-4218-af4e-ea407238d8a2","outputVar":"userList","msg":"Created read table block with virtual step"}
{"level":30,"time":1768514609473,"env":"test","module":"email-queue","jobId":"d54a4ffd-227f-4134-a77c-68cfbbf698ef","to":"existing_1768514583002@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w64
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w64,public

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w64 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w64%2Cpublic

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w63
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w63,public

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w63 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w63%2Cpublic

{"level":30,"time":1768514609631,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514609632,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w65
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w65,public

 [32m‚úì[39m tests/unit/components/datavault/CellRenderer.test.tsx [2m([22m[2m12 tests[22m[2m)[22m[33m 3951[2mms[22m[39m
     [33m[2m‚úì[22m[39m renders boolean value as Yes/No [33m 856[2mms[22m[39m
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w65 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w65%2Cpublic

{"level":30,"time":1768514609780,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768514609780,"env":"test","module":"auth-routes","userId":"0da77c86607bc428e181cf310b827d5a","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768514609781,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould handle user with single session gracefully
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768514609828,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["0da77c86607bc428e181cf310b827d5a","login_success","security","0da77c86607bc428e181cf310b827d5a","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:29.780Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:29.781Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"0da77c86607bc428e181cf310b827d5a","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514609828,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["0da77c86607bc428e181cf310b827d5a","login_success","security","0da77c86607bc428e181cf310b827d5a","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:29.780Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:29.781Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768514609835,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768514609854,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514609855,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/components/datavault/SortableColumnHeader.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 2818[2mms[22m[39m
 [32m‚úì[39m tests/integration/dynamic_options_workflow.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 2507[2mms[22m[39m
     [33m[2m‚úì[22m[39m should successfully configure a workflow with Read Table -> Dynamic Choice [33m 706[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w69
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w69,public

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w69 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w69%2Cpublic

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w68
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w68,public

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w68 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w68%2Cpublic

{"level":30,"time":1768514610323,"env":"test","module":"auth-routes","userId":"06f57a6bf65552cf8ea15fe845af10d6","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w66
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w66,public

{"level":50,"time":1768514610373,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["06f57a6bf65552cf8ea15fe845af10d6","login_success","security","06f57a6bf65552cf8ea15fe845af10d6","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:30.323Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:30.323Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"06f57a6bf65552cf8ea15fe845af10d6","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514610373,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["06f57a6bf65552cf8ea15fe845af10d6","login_success","security","06f57a6bf65552cf8ea15fe845af10d6","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:30.323Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:30.323Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768514610380,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w66 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w66%2Cpublic

{"level":30,"time":1768514610417,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514610418,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w70
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w70,public

 [32m‚úì[39m tests/unit/components/datavault/TableGridView.test.tsx [2m([22m[2m9 tests[22m[2m)[22m[33m 5944[2mms[22m[39m
     [33m[2m‚úì[22m[39m loads table schema and rows [33m 876[2mms[22m[39m
     [33m[2m‚úì[22m[39m enters edit mode on double click [33m 828[2mms[22m[39m
     [33m[2m‚úì[22m[39m updates cell value on blur [33m 985[2mms[22m[39m
     [33m[2m‚úì[22m[39m renders delete button for each row [33m 469[2mms[22m[39m
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w67
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w67,public

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w70 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w70%2Cpublic

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w67 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w67%2Cpublic

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514610656,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514610716,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514610789,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514610816,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514610855,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514610883,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514610902,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514610911,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514610951,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514611008,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w64, public

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w64
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w60.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w60.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w65, public

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w63, public

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w69, public

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mTenant-Level MFA Enforcement[2m > [22m[2mshould enforce MFA for tenant users when required by tenant
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w71
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w71,public

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w65
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w63
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w69
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514611327,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w71 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w71%2Cpublic

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w64.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w64.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w64.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w64.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w64.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w64.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w68, public

{"level":30,"time":1768514611381,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w68
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768514611421,"env":"test","module":"email-queue","jobId":"7c5b105f-f774-40cd-bb54-7a6c2324a920","to":"existing_1768514583002@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w73
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w73,public

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w63.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w65.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w69.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w63.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w73 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w73%2Cpublic

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514611502,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514611506,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w65.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514611557,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w69.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514611584,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514611594,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514611595,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768514611627,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514611628,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/workflows/conditionTruthTable.test.ts [2m([22m[2m51 tests[22m[2m)[22m[33m 2097[2mms[22m[39m
 [32m‚úì[39m tests/ui/common/Breadcrumbs.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 2510[2mms[22m[39m
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w74
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w74,public

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w72
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w72,public

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould include device metadata in sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w74 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w74%2Cpublic

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w66, public

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w72 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w72%2Cpublic

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w66
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768514611801,"env":"test","module":"auth-routes","userId":"ea0f6ba4f16d39fd9554cbd57c01b646","msg":"Login requires MFA verification"}
{"level":30,"time":1768514611819,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":40,"time":1768514611820,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":30,"time":1768514611820,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w68.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w68.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":40,"time":1768514611834,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":40,"time":1768514611838,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":40,"time":1768514611846,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":40,"time":1768514611851,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":30,"time":1768514611861,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768514611862,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w70, public

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m‚úÖ Enforced search_path: test_schema_w67, public

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w70
‚è© Schema reused, skipping migrations.

 [32m‚úì[39m tests/ui/datavault/ColumnTypeIcon.test.tsx [2m([22m[2m27 tests[22m[2m)[22m[33m 2710[2mms[22m[39m
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w67
‚è© Schema reused, skipping migrations.

 [32m‚úì[39m tests/unit/isolatedVmBridge.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 2245[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w66.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w66.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w66.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w66.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514612038,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514612038,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/ui/datavault/TemplateCard.test.tsx [2m([22m[2m6 tests[22m[2m)[22m[33m 2739[2mms[22m[39m
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514612199,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514612250,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK initialized successfully"}
{"level":30,"time":1768514612260,"env":"test","module":"auth-routes","userId":"6069ed4626d64c4b1177a2c77cc2d06d","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768514612250,"env":"test","module":"telemetry","msg":"Prometheus metrics initialized"}
{"level":30,"time":1768514612252,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768514612267,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514612267,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768514612283,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514612283,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768514612254,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768514612304,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["6069ed4626d64c4b1177a2c77cc2d06d","login_success","security","6069ed4626d64c4b1177a2c77cc2d06d","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:32.260Z\"}}","192.168.1.100","Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/96.0","2026-01-15T22:03:32.260Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"6069ed4626d64c4b1177a2c77cc2d06d","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514612304,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["6069ed4626d64c4b1177a2c77cc2d06d","login_success","security","6069ed4626d64c4b1177a2c77cc2d06d","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:32.260Z\"}}","192.168.1.100","Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/96.0","2026-01-15T22:03:32.260Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768514612311,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768514612316,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK shut down successfully"}
 [32m‚úì[39m tests/unit/shared/validation/PageValidator.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2179[2mms[22m[39m
 [32m‚úì[39m tests/ui/blocks/SendDataToTableBlockEditor.test.tsx [2m([22m[2m12 tests[22m[2m)[22m[33m 2448[2mms[22m[39m
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768514612436,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK initialized successfully"}
{"level":30,"time":1768514612436,"env":"test","module":"telemetry","msg":"Prometheus metrics initialized"}
{"level":30,"time":1768514612436,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":40,"time":1768514612464,"env":"test","module":"metrics-routes","ip":"::ffff:127.0.0.1","msg":"Unauthorized metrics access attempt"}
{"level":30,"time":1768514612485,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK shut down successfully"}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514612487,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768514612488,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514612509,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514612577,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

 [32m‚úì[39m tests/integration/metrics.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 2633[2mms[22m[39m
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w71, public

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w71
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w67.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w70.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w67.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514612760,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w70.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514612821,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514612821,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768514612877,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w75
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w75,public

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w73, public

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w76
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w76,public

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w75 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w75%2Cpublic

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w73
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w76 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w76%2Cpublic

{"level":30,"time":1768514613021,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514613021,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w71.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w71.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w78
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w78,public

{"level":30,"time":1768514613077,"env":"test","warnings":["Python code does not call emit(). Script will not produce output."],"msg":"Script validation warnings"}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514613079,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768514613080,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w78 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w78%2Cpublic

 [32m‚úì[39m tests/unit/ScriptEngine.test.ts [2m([22m[2m26 tests[22m[2m | [22m[33m4 skipped[39m[2m)[22m[33m 2181[2mms[22m[39m
 [31m‚ùØ[39m tests/integration/mfa.flow.real.test.ts [2m([22m[2m20 tests[22m[2m | [22m[31m9 failed[39m[2m)[22m[33m 43173[2mms[22m[39m
[31m       [31m√ó[31m should complete full MFA setup flow[39m[33m 1846[2mms[22m[39m
[31m       [31m√ó[31m should reject invalid TOTP code during setup[39m[33m 1854[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not allow MFA setup if already enabled [33m 2071[2mms[22m[39m
[31m       [31m√ó[31m should generate unique backup codes[39m[33m 1913[2mms[22m[39m
[31m       [31m√ó[31m should store hashed backup codes[39m[33m 1912[2mms[22m[39m
       [33m[2m‚úì[22m[39m should require MFA for enabled users [33m 1966[2mms[22m[39m
       [33m[2m‚úì[22m[39m should complete MFA login with valid TOTP [33m 2027[2mms[22m[39m
       [33m[2m‚úì[22m[39m should reject invalid TOTP during login [33m 2166[2mms[22m[39m
       [33m[2m‚úì[22m[39m should accept TOTP codes within 60-second window [33m 2571[2mms[22m[39m
[31m       [31m√ó[31m should login with valid backup code[39m[33m 1867[2mms[22m[39m
       [33m[2m‚úì[22m[39m should mark backup code as used [33m 1757[2mms[22m[39m
[31m       [31m√ó[31m should prevent backup code reuse[39m[33m 1864[2mms[22m[39m
       [33m[2m‚úì[22m[39m should try TOTP before backup code [33m 1913[2mms[22m[39m
[31m       [31m√ó[31m should return MFA status for user[39m[33m 1768[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return backup codes count for MFA users [33m 2173[2mms[22m[39m
[31m       [31m√ó[31m should disable MFA with password verification[39m[33m 2976[2mms[22m[39m
       [33m[2m‚úì[22m[39m should require correct password to disable MFA [33m 2542[2mms[22m[39m
       [33m[2m‚úì[22m[39m should regenerate backup codes [33m 2580[2mms[22m[39m
[31m       [31m√ó[31m should return error if MFA not enabled[39m[33m 1978[2mms[22m[39m
       [33m[2m‚úì[22m[39m should enforce MFA for tenant users when required by tenant [33m 2272[2mms[22m[39m
[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w72, public

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w79
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w79,public

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w79 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w79%2Cpublic

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w72
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w74, public

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w73.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w73.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w77
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w77,public

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w74
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w80
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w80,public

{"level":30,"time":1768514613315,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514613315,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w77 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w77%2Cpublic

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w80 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w80%2Cpublic

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w81
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w81,public

 [32m‚úì[39m tests/unit/shared/conditionEvaluator.test.ts [2m([22m[2m70 tests[22m[2m)[22m[33m 2250[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w81 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w81%2Cpublic

{"level":30,"time":1768514613447,"env":"test","module":"email-queue","jobId":"ae19c932-412c-418d-8f87-2ce89ecf67a6","to":"existing_1768514583002@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w82
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w82,public

{"level":30,"time":1768514613548,"env":"test","module":"workflow-quality-validator","overall":99,"breakdown":{"aliases":100,"types":100,"structure":100,"ux":95,"completeness":100,"validation":100},"issuesCount":1,"passed":true,"msg":"Workflow quality validation completed"}
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w82 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w82%2Cpublic

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514613548,"env":"test","module":"ai-service","duration":6,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":99,"qualityBreakdown":{"aliases":100,"types":100,"structure":100,"ux":95,"completeness":100,"validation":100},"qualityPassed":true,"issuesCount":1,"msg":"AI workflow generation succeeded"}
{"level":50,"time":1768514613554,"env":"test","module":"ai-service","error":{"code":"VALIDATION_ERROR","troubleshooting":"üîß Troubleshooting Steps:\n1. The AI response structure doesn't match our expected format\n2. This may indicate:\n   - A breaking change in the AI model behavior\n   - The model is struggling with the complexity of the request\n3. Try simplifying your workflow or request\n4. If this persists, please report this issue with the workflow details"},"duration":2,"msg":"AI workflow generation failed"}
{"level":50,"time":1768514613559,"env":"test","module":"ai-service","error":{"code":"VALIDATION_ERROR","troubleshooting":"üîß Troubleshooting Steps:\n1. The AI response structure doesn't match our expected format\n2. This may indicate:\n   - A breaking change in the AI model behavior\n   - The model is struggling with the complexity of the request\n3. Try simplifying your workflow or request\n4. If this persists, please report this issue with the workflow details"},"duration":0,"msg":"AI workflow generation failed"}
{"level":50,"time":1768514613562,"env":"test","module":"ai-service","error":{"code":"VALIDATION_ERROR","troubleshooting":"üîß Troubleshooting Steps:\n1. The AI response structure doesn't match our expected format\n2. This may indicate:\n   - A breaking change in the AI model behavior\n   - The model is struggling with the complexity of the request\n3. Try simplifying your workflow or request\n4. If this persists, please report this issue with the workflow details"},"duration":0,"msg":"AI workflow generation failed"}
{"level":40,"time":1768514613565,"env":"test","module":"ai-service","attempt":0,"retryAfter":1000,"error":"Rate limit exceeded","msg":"Retrying AI request..."}
{"level":40,"time":1768514613565,"env":"test","module":"ai-service","attempt":1,"retryAfter":2000,"error":"Rate limit exceeded","msg":"Retrying AI request..."}
{"level":40,"time":1768514613565,"env":"test","module":"ai-service","attempt":2,"retryAfter":4000,"error":"Rate limit exceeded","msg":"Retrying AI request..."}
{"level":50,"time":1768514613565,"env":"test","module":"ai-service","event":"ai_request_failed","provider":"openai","model":"gpt-4-turbo-preview","taskType":"workflow_generation","errorType":"RATE_LIMIT","durationMs":0,"attempts":4,"msg":"AI request failed: rate limit"}
{"level":50,"time":1768514613565,"env":"test","module":"ai-service","error":{"code":"RATE_LIMIT","details":{"originalError":"Rate limit exceeded","retryAfterSeconds":60},"troubleshooting":"üîß Troubleshooting Steps:\n1. You've hit the AI provider's rate limit\n2. Solutions:\n   - Wait 60 seconds and try again\n   - Check your API key quota at your provider's dashboard\n   - Consider upgrading your API plan for higher limits\n   - If using free tier, you may need to wait until limits reset"},"duration":0,"msg":"AI workflow generation failed"}
{"level":50,"time":1768514613567,"env":"test","module":"ai-service","error":{},"duration":0,"msg":"AI workflow generation failed"}
{"level":30,"time":1768514613573,"env":"test","module":"workflow-quality-validator","overall":100,"breakdown":{"aliases":100,"types":100,"structure":100,"ux":100,"completeness":100,"validation":100},"issuesCount":0,"passed":true,"msg":"Workflow quality validation completed"}
{"level":30,"time":1768514613573,"env":"test","module":"ai-service","duration":0,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":100,"qualityBreakdown":{"aliases":100,"types":100,"structure":100,"ux":100,"completeness":100,"validation":100},"qualityPassed":true,"issuesCount":0,"msg":"AI workflow generation succeeded"}
{"level":30,"time":1768514613577,"env":"test","module":"workflow-quality-validator","overall":96,"breakdown":{"aliases":100,"types":100,"structure":80,"ux":100,"completeness":90,"validation":100},"issuesCount":2,"passed":true,"msg":"Workflow quality validation completed"}
{"level":30,"time":1768514613577,"env":"test","module":"ai-service","duration":0,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":96,"qualityBreakdown":{"aliases":100,"types":100,"structure":80,"ux":100,"completeness":90,"validation":100},"qualityPassed":true,"issuesCount":2,"msg":"AI workflow generation succeeded"}
{"level":30,"time":1768514613588,"env":"test","module":"ai-service","duration":0,"suggestionsCount":1,"msg":"AI binding suggestion succeeded"}
{"level":30,"time":1768514613590,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768514613591,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould not expose sensitive token data
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768514613630,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514613631,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/ai.service.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 2285[2mms[22m[39m
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

 [32m‚úì[39m tests/unit/workflows/validation.test.ts [2m([22m[2m66 tests[22m[2m)[22m[33m 2356[2mms[22m[39m
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514613863,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514613908,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514613918,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514613957,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514614052,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w83
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w83,public

{"level":30,"time":1768514614102,"env":"test","module":"auth-routes","userId":"2144bccaf0a91bf875aeb9c65aa23613","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514614117,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514614120,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w83 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w83%2Cpublic

{"level":50,"time":1768514614154,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["2144bccaf0a91bf875aeb9c65aa23613","login_success","security","2144bccaf0a91bf875aeb9c65aa23613","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:34.102Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:34.102Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"2144bccaf0a91bf875aeb9c65aa23613","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514614155,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["2144bccaf0a91bf875aeb9c65aa23613","login_success","security","2144bccaf0a91bf875aeb9c65aa23613","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:34.102Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:34.102Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768514614162,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768514614181,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w84
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w84,public

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w75, public

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w76, public

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514614333,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w84 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w84%2Cpublic

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514614348,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w76
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w75
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w74.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w72.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w74.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w74.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w72.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w74.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514614402,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514614423,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514614460,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w72.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w72.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w78, public

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w85
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w85,public

{"level":30,"time":1768514614522,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w78
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w85 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w85%2Cpublic

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w79, public

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w75.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w76.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w75.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w79
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514614618,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w76.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w76.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w76.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514614660,"env":"test","msg":"DB: initialized flag set."}
{"level":40,"time":1768514614733,"env":"test","module":"auth-middleware","path":"/test","msg":"No authorization token provided"}
{"level":50,"time":1768514614742,"env":"test","module":"intake-navigation","error":{},"pageId":"page1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating visibleIf condition"}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":50,"time":1768514614743,"env":"test","module":"intake-navigation","error":{},"pageId":"page1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating skipIf condition"}
{"level":30,"time":1768514614744,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768514614745,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w81, public

{"level":50,"time":1768514614747,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768514614749,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768514614750,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768514614750,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768514614750,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768514614751,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768514614753,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768514614755,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768514614755,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768514614755,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768514614756,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768514614757,"env":"test","module":"auth-middleware","path":"/test","msg":"No authorization token provided"}
{"level":30,"time":1768514614758,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768514614759,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/services/intakeNavigation.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 2283[2mms[22m[39m
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w80, public

 [32m‚úì[39m tests/unit/middleware/auth.middleware.test.ts [2m([22m[2m22 tests[22m[2m)[22m[33m 2231[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w81
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w80
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w78.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w79.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w78.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w77, public

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w78.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w79.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w78.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w86
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w86,public

{"level":30,"time":1768514614895,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514614896,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w79.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514614917,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514614918,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w87
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w87,public

 [32m‚úì[39m tests/ui/blocks/SendDataBlockEditorRouting.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 2249[2mms[22m[39m
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w79.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w77
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514614945,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w86 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w86%2Cpublic

 [32m‚úì[39m tests/unit/client/list-choice-options.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 2119[2mms[22m[39m
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w87 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w87%2Cpublic

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mDEBUG: Existing functions: []

{"level":30,"time":1768514614996,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w82, public

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w82
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w77.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w80.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w81.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w77.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w80.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514615188,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514615189,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768514615194,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514615195,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w81.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

 [32m‚úì[39m tests/unit/shared/validation/stepConfigSchemas.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 2206[2mms[22m[39m
 [32m‚úì[39m tests/unit/WorkflowOptimizationService.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 2275[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768514615301,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768514615302,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514615327,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w83, public

 [32m‚úì[39m tests/unit/HelperLibrary.test.ts [2m([22m[2m60 tests[22m[2m)[22m[33m 2413[2mms[22m[39m
{"level":30,"time":1768514615378,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w83
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w82.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w82.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514615473,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514615474,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould track session activity timestamps
[22m[39mDEBUG: LOGIN HANDLER HIT

 [32m‚úì[39m tests/unit/WorkflowChangeAnalyzer.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 2356[2mms[22m[39m
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w84, public

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w84
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w83.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w83.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w88
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w88,public

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w88 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w88%2Cpublic

{"level":30,"time":1768514615741,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514615742,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w85, public

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w89
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w89,public

 [32m‚úì[39m tests/unit/engine.expr.test.ts [2m([22m[2m26 tests[22m[2m)[22m[33m 2066[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w89 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w89%2Cpublic

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w85
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514615839,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w84.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w84.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514615859,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w91
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w91,public

{"level":30,"time":1768514615904,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w91 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w91%2Cpublic

{"level":30,"time":1768514615909,"env":"test","msg":"DB: initialized flag set."}
 [32m‚úì[39m tests/unit/BlockRunner.validate.test.ts [2m([22m[2m7 tests[22m[2m)[22m[33m 2074[2mms[22m[39m
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

{"level":30,"time":1768514616014,"env":"test","module":"auth-routes","userId":"b8558734ee5361c8e876e518ad0a1feb","msg":"User logged in successfully"}
{"level":50,"time":1768514616062,"env":"test","module":"audit-log-service","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["b8558734ee5361c8e876e518ad0a1feb","login_success","security","b8558734ee5361c8e876e518ad0a1feb","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:36.014Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:36.014Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"userId":"b8558734ee5361c8e876e518ad0a1feb","eventType":"login_success","msg":"Failed to log security event"}
{"level":50,"time":1768514616062,"env":"test","module":"auth-routes","error":{"query":"insert into \"audit_logs\" (\"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\") values (default, default, NULL, $1, $2, default, default, $3, $4, $5, default, $6, $7, default, $8) returning \"id\", \"tenant_id\", \"workspace_id\", \"user_id\", \"action\", \"entity_type\", \"entity_id\", \"resource_type\", \"resource_id\", \"changes\", \"details\", \"ip_address\", \"user_agent\", \"created_at\", \"timestamp\"","params":["b8558734ee5361c8e876e518ad0a1feb","login_success","security","b8558734ee5361c8e876e518ad0a1feb","{\"metadata\":{\"timestamp\":\"2026-01-15T22:03:36.014Z\"}}","::ffff:127.0.0.1",null,"2026-01-15T22:03:36.014Z"],"cause":{"length":132,"name":"error","severity":"ERROR","code":"42703","position":"33","file":"parse_target.c","line":"1065","routine":"checkInsertTargets"}},"msg":"Login failed"}
{"level":50,"time":1768514616069,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768514616091,"env":"test","module":"email-queue","jobId":"643019b1-1a99-43b2-8920-6a23124901e3","to":"existing_1768514583002@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
{"level":30,"time":1768514616102,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514616102,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

 [32m‚úì[39m tests/unit/shared/validation/Validator.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 2029[2mms[22m[39m
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w93
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w93,public

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w86, public

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w92
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w92,public

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w87, public

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w93 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w93%2Cpublic

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w86
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w92 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w92%2Cpublic

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w87
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w85.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w85.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w94
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w94,public

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w85.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w85.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w94 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w94%2Cpublic

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w90
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w90,public

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w90 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w90%2Cpublic

{"level":30,"time":1768514616609,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514616609,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w95
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w95,public

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

 [32m‚úì[39m tests/unit/workflow/QueryBlock.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2104[2mms[22m[39m
{"level":50,"time":1768514616664,"env":"test","status":401,"statusText":"Unauthorized","error":"Invalid client credentials","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token request failed"}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514616669,"env":"test","msg":"DB: initializing... Local"}
{"level":50,"time":1768514616665,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768514616667,"env":"test","data":{"token_type":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768514616667,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768514616668,"env":"test","data":{"access_token":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768514616668,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768514616669,"env":"test","error":"Network error: ECONNREFUSED","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514616674,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w95 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w95%2Cpublic

{"level":30,"time":1768514616726,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514616737,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768514616778,"env":"test","error":"Invalid credentials","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":50,"time":1768514616779,"env":"test","error":"ECONNREFUSED","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768514616781,"env":"test","status":400,"statusText":"Bad Request","error":"Invalid grant_type","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768514616781,"env":"test","error":"OAuth2 token request failed: 400 Bad Request","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768514616782,"env":"test","status":401,"statusText":"Unauthorized","error":"Client authentication failed","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768514616782,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768514616782,"env":"test","status":403,"statusText":"Forbidden","error":"Access denied","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768514616782,"env":"test","error":"OAuth2 token request failed: 403 Forbidden","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768514616783,"env":"test","status":500,"statusText":"Internal Server Error","error":"Server error","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768514616783,"env":"test","error":"OAuth2 token request failed: 500 Internal Server Error","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768514616783,"env":"test","error":"Unexpected token in JSON","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768514616784,"env":"test","error":"Request timeout","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":30,"time":1768514616785,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768514616785,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/auth/oauth2.client-credentials.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 2232[2mms[22m[39m
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w97
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w97,public

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514616881,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w97 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w97%2Cpublic

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w96
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w96,public

{"level":30,"time":1768514616949,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w96 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w96%2Cpublic

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514616989,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768514616989,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w88, public

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w89, public

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w98
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w98,public

 [31m‚ùØ[39m tests/integration/session.management.real.test.ts [2m([22m[2m18 tests[22m[2m | [22m[31m16 failed[39m[2m)[22m[33m 47145[2mms[22m[39m
[31m       [31m√ó[31m should list all active sessions for current user[39m[33m 3606[2mms[22m[39m
[31m       [31m√ó[31m should mark current session correctly[39m[33m 2862[2mms[22m[39m
[31m       [31m√ó[31m should exclude revoked sessions[39m[33m 2855[2mms[22m[39m
[31m       [31m√ó[31m should order sessions by last used (most recent first)[39m[33m 4008[2mms[22m[39m
[31m       [31m√ó[31m should filter sessions by current user only[39m[33m 4377[2mms[22m[39m
       [32m‚úì[39m should return 401 for unauthenticated request[32m 5[2mms[22m[39m
[31m       [31m√ó[31m should revoke specific session[39m[33m 2532[2mms[22m[39m
[31m       [31m√ó[31m should prevent revoking current session[39m[33m 1764[2mms[22m[39m
[31m       [31m√ó[31m should return 404 for non-existent session[39m[33m 1771[2mms[22m[39m
[31m       [31m√ó[31m should prevent revoking other user's session[39m[33m 3517[2mms[22m[39m
[31m       [31m√ó[31m should revoke all other sessions[39m[33m 4343[2mms[22m[39m
[31m       [31m√ó[31m should keep current session active[39m[33m 2881[2mms[22m[39m
[31m       [31m√ó[31m should return 400 if no active session found[39m[33m 1845[2mms[22m[39m
       [33m[2m‚úì[22m[39m should revoke all trusted devices [33m 1988[2mms[22m[39m
[31m       [31m√ó[31m should handle user with single session gracefully[39m[33m 1932[2mms[22m[39m
[31m       [31m√ó[31m should include device metadata in sessions[39m[33m 1928[2mms[22m[39m
[31m       [31m√ó[31m should not expose sensitive token data[39m[33m 1866[2mms[22m[39m
[31m       [31m√ó[31m should track session activity timestamps[39m[33m 1909[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w88
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w89
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w98 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w98%2Cpublic

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w86.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w87.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w86.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w86.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w87.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w86.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w87.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w87.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514617278,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514617301,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514617332,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w91, public

{"level":30,"time":1768514617382,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w91
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514617387,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514617388,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w89.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w88.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w89.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514617444,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514617455,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w88.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514617500,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514617501,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768514617519,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514617520,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514617535,"env":"test","msg":"DB: initializing... Local"}
 [32m‚úì[39m tests/integration/mfa.flow.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 2232[2mms[22m[39m
 [32m‚úì[39m tests/unit/shared/workflowLogic.test.ts [2m([22m[2m65 tests[22m[2m)[22m[33m 2182[2mms[22m[39m
{"level":30,"time":1768514617593,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w99
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w99,public

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w99 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w99%2Cpublic

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w93, public

{"level":30,"time":1768514617737,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w92, public

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w93
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768514617738,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w92
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w91.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w91.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32m‚úì[39m tests/integration/intake.portal.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 2285[2mms[22m[39m
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w94, public

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w90, public

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w91.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w91.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w90
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w94
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514617892,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w93.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w93.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w93.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w93.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514617940,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514617952,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w95, public

{"level":30,"time":1768514618016,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w95
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w100
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w100,public

{"level":30,"time":1768514618053,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514618053,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w90.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w92.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w94.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w90.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w100 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w100%2Cpublic

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

{"level":30,"time":1768514618093,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/integration/auth.routes.test.ts [2m([22m[2m41 tests[22m[2m)[22m[33m 2246[2mms[22m[39m
{"level":30,"time":1768514618094,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w92.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

 [32m‚úì[39m tests/unit/client/choice-utils.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 2281[2mms[22m[39m
{"level":30,"time":1768514618134,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w94.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514618182,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514618182,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768514618190,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514618191,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768514618206,"env":"test","msg":"DB: initialized flag set."}
 [32m‚úì[39m tests/integration/session.management.test.ts [2m([22m[2m22 tests[22m[2m)[22m[33m 2172[2mms[22m[39m
 [32m‚úì[39m tests/unit/services/docxRenderer2.test.ts [2m([22m[2m27 tests[22m[2m)[22m[33m 2106[2mms[22m[39m
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w97, public

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w97
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w95.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w95.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w96, public

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w101
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w101,public

{"level":30,"time":1768514618432,"env":"test","module":"ai-service","estimatedInputTokens":18,"estimatedOutputTokens":36,"sectionCount":0,"msg":"Attempting single-shot workflow revision"}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514618434,"env":"test","module":"gemini-provider","event":"ai_request_success","provider":"gemini","model":"gemini-2.0-flash-exp","taskType":"workflow_revision","promptTokens":812,"responseTokens":66,"durationMs":1,"estimatedCostUSD":0.00010760000000000001,"msg":"Gemini request succeeded"}
{"level":30,"time":1768514618437,"env":"test","module":"ai-service","duration":4,"workflowId":"123","changeCount":1,"msg":"AI workflow revision succeeded"}
{"level":30,"time":1768514618440,"env":"test","module":"ai-service","estimatedInputTokens":18,"estimatedOutputTokens":36,"sectionCount":0,"msg":"Attempting single-shot workflow revision"}
{"level":30,"time":1768514618441,"env":"test","module":"gemini-provider","event":"ai_request_success","provider":"gemini","model":"gemini-2.0-flash-exp","taskType":"workflow_revision","promptTokens":812,"responseTokens":45,"durationMs":0,"estimatedCostUSD":0.00009920000000000001,"msg":"Gemini request succeeded"}
{"level":30,"time":1768514618441,"env":"test","module":"ai-service","duration":0,"workflowId":"123","changeCount":0,"msg":"AI workflow revision succeeded"}
{"level":30,"time":1768514618442,"env":"test","module":"ai-service","estimatedInputTokens":18,"estimatedOutputTokens":36,"sectionCount":0,"msg":"Attempting single-shot workflow revision"}
{"level":30,"time":1768514618443,"env":"test","module":"gemini-provider","event":"ai_request_success","provider":"gemini","model":"gemini-2.0-flash-exp","taskType":"workflow_revision","promptTokens":811,"responseTokens":4,"durationMs":1,"estimatedCostUSD":0.0000827,"msg":"Gemini request succeeded"}
{"level":40,"time":1768514618443,"env":"test","module":"ai-provider","lastChar":"N","last50":"I am not JSON","msg":"Response does not end with closing brace/bracket"}
{"level":50,"time":1768514618443,"env":"test","module":"ai-service","responseLength":13,"estimatedTokens":4,"responseSuffix":"I am not JSON","msg":"Detected truncated AI response - workflow too large for single-shot revision"}
{"level":50,"time":1768514618443,"env":"test","module":"ai-service","error":{"code":"RESPONSE_TRUNCATED","estimatedTokens":4,"responseLength":13},"duration":1,"msg":"AI workflow revision failed"}
{"level":40,"time":1768514618443,"env":"test","module":"ai-service","estimatedInputTokens":18,"estimatedOutputTokens":36,"actualOutputTokens":4,"responseLength":13,"msg":"Single-shot revision truncated - automatically retrying with chunking"}
{"level":30,"time":1768514618444,"env":"test","module":"gemini-provider","event":"ai_request_success","provider":"gemini","model":"gemini-2.0-flash-exp","taskType":"workflow_revision","promptTokens":811,"responseTokens":4,"durationMs":0,"estimatedCostUSD":0.0000827,"msg":"Gemini request succeeded"}
{"level":40,"time":1768514618444,"env":"test","module":"ai-provider","lastChar":"N","last50":"I am not JSON","msg":"Response does not end with closing brace/bracket"}
{"level":50,"time":1768514618444,"env":"test","module":"ai-service","responseLength":13,"estimatedTokens":4,"responseSuffix":"I am not JSON","msg":"Detected truncated AI response - workflow too large for single-shot revision"}
{"level":50,"time":1768514618444,"env":"test","module":"ai-service","error":{"code":"RESPONSE_TRUNCATED","estimatedTokens":4,"responseLength":13},"duration":0,"msg":"AI workflow revision failed"}
{"level":50,"time":1768514618444,"env":"test","module":"ai-service","duration":2,"error":{"code":"RESPONSE_TRUNCATED","estimatedTokens":4,"responseLength":13},"msg":"AI workflow revision failed"}
{"level":30,"time":1768514618446,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768514618447,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w96
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w101 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w101%2Cpublic

 [32m‚úì[39m tests/unit/services/AIService.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2216[2mms[22m[39m
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w97.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w97.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w102
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w102,public

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w98, public

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w102 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w102%2Cpublic

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514618618,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w98
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768514618656,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768514618657,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w103
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w103,public

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w96.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w96.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514618701,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w103 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w103%2Cpublic

 [32m‚úì[39m tests/integration/api.ai.test.ts [2m([22m[2m32 tests[22m[2m)[22m[33m 2185[2mms[22m[39m
{"level":30,"time":1768514618721,"env":"test","module":"email-queue","jobId":"d78502ad-ad7b-4ef6-b9bd-20f8cb954129","to":"existing_1768514583002@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts[2m > [22m[2mIntakeQuestionVisibilityService[2m > [22m[2mHelper methods[2m > [22m[2mshould get visible question count
[22m[39mMOCK SETUP DONE. Mock questions: [
  {
    id: [32m'q1'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q1'[39m,
    order: [33m0[39m,
    isVirtual: [33mfalse[39m,
    alias: [32m'show'[39m,
    visibleIf: [1mnull[22m
  },
  {
    id: [32m'q2'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q2'[39m,
    order: [33m1[39m,
    isVirtual: [33mfalse[39m,
    visibleIf: { op: [32m'equals'[39m, left: [36m[Object][39m, right: [36m[Object][39m }
  },
  {
    id: [32m'q3'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q3'[39m,
    order: [33m2[39m,
    isVirtual: [33mfalse[39m,
    visibleIf: [1mnull[22m
  }
]
Calling getVisibleQuestionCount...

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts[2m > [22m[2mIntakeQuestionVisibilityService[2m > [22m[2mHelper methods[2m > [22m[2mshould get visible question count
[22m[39mCOUNT RESULT: [33m0[39m
Mock called times: [33m1[39m
Mock last call args: [ [ [32m'section1'[39m ] ]

{"level":50,"time":1768514618771,"env":"test","module":"intake-question-visibility","error":{},"questionId":"q1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating visibleIf condition"}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514618773,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768514618773,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w104
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w104,public

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

 [32m‚úì[39m tests/unit/services/intakeQuestionVisibility.test.ts [2m([22m[2m19 tests[22m[2m)[22m[33m 2238[2mms[22m[39m
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w104 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w104%2Cpublic

{"level":30,"time":1768514618962,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514618963,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/utils/pagination.test.ts [2m([22m[2m24 tests[22m[2m)[22m[33m 2232[2mms[22m[39m
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w99, public

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514619119,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w99
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w105
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w105,public

{"level":30,"time":1768514619169,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w105 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w105%2Cpublic

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w98.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w98.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w106
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w106,public

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w108
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w108,public

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w106 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w106%2Cpublic

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w108 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w108%2Cpublic

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514619437,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514619453,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768514619454,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768514619494,"env":"test","msg":"DB: initialized flag set."}
 [32m‚úì[39m tests/unit/utils/variableResolver.test.ts [2m([22m[2m20 tests[22m[2m)[22m[33m 2257[2mms[22m[39m
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w100, public

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w107
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w107,public

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514619596,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w100
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w107 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w107%2Cpublic

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w109
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w109,public

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w99.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w99.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514619668,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w109 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w109%2Cpublic

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514619790,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514619841,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w101, public

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w101
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514619929,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514619938,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514619939,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w110
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w110,public

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w100.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w100.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w110 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w110%2Cpublic

 [32m‚úì[39m tests/unit/services/TemplateAnalysisService.test.ts [2m([22m[2m27 tests[22m[2m)[22m[33m 2299[2mms[22m[39m
{"level":30,"time":1768514619995,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w112
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w112,public

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w111
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w111,public

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w102, public

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514620081,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w112 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w112%2Cpublic

{"level":30,"time":1768514620082,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w111 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w111%2Cpublic

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w102
‚è© Schema reused, skipping migrations.

 [32m‚úì[39m tests/integration/organizationInvites.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 37074[2mms[22m[39m
       [33m[2m‚úì[22m[39m should create placeholder user for non-existent email [33m 1984[2mms[22m[39m
       [33m[2m‚úì[22m[39m should create invite for existing user without creating placeholder [33m 2506[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent duplicate pending invites [33m 2189[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent inviting existing members [33m 1275[2mms[22m[39m
       [33m[2m‚úì[22m[39m should require admin access to create invite [33m 1002[2mms[22m[39m
       [33m[2m‚úì[22m[39m should set expiry to 7 days from now [33m 1857[2mms[22m[39m
       [33m[2m‚úì[22m[39m should accept invite and create membership [33m 2736[2mms[22m[39m
       [33m[2m‚úì[22m[39m should convert placeholder user to real user on accept [33m 2787[2mms[22m[39m
       [33m[2m‚úì[22m[39m should reject expired invite [33m 2075[2mms[22m[39m
       [33m[2m‚úì[22m[39m should reject already accepted invite [33m 2635[2mms[22m[39m
       [33m[2m‚úì[22m[39m should verify email matches invite [33m 1908[2mms[22m[39m
       [33m[2m‚úì[22m[39m should reject invalid token [33m 1063[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return pending invites for user email [33m 1911[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not return expired invites [33m 2026[2mms[22m[39m
       [33m[2m‚úì[22m[39m should not return accepted invites [33m 2690[2mms[22m[39m
       [33m[2m‚úì[22m[39m should allow admin to revoke invite [33m 2590[2mms[22m[39m
       [33m[2m‚úì[22m[39m should prevent accepting revoked invite [33m 2622[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w101.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w101.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514620170,"env":"test","msg":"DB: initializing... Local"}
{"level":40,"time":1768514620214,"env":"test","module":"rbac-middleware","path":"/api/workflows","permission":"workflow:create","msg":"Unauthenticated user attempted to access protected resource"}
{"level":30,"time":1768514620224,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w103, public

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":40,"time":1768514620218,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","permission":"workflow:create","path":"/api/workflows","msg":"Permission denied"}
{"level":40,"time":1768514620220,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":null,"permission":"workflow:view","path":"/api/workflows","msg":"Permission denied"}
{"level":40,"time":1768514620221,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","permissions":["workflow:create","workflow:edit","workflow:delete"],"path":"/api/workflows","msg":"Permission denied (none of required permissions)"}
{"level":40,"time":1768514620223,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"builder","permissions":["workflow:edit","workflow:delete"],"path":"/api/workflows","msg":"Permission denied (missing some required permissions)"}
{"level":40,"time":1768514620226,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","requiredRoles":["owner","builder"],"path":"/api/admin","msg":"Role check failed"}
{"level":40,"time":1768514620226,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":null,"requiredRoles":["owner"],"path":"/api/admin","msg":"Role check failed"}
{"level":40,"time":1768514620227,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"builder","requiredRoles":["owner"],"path":"/api/test","msg":"Role check failed"}
{"level":40,"time":1768514620229,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"runner","requiredRoles":["owner","builder"],"path":"/api/test","msg":"Role check failed"}
{"level":40,"time":1768514620231,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","requiredRoles":["owner","builder","runner"],"path":"/api/test","msg":"Role check failed"}
{"level":40,"time":1768514620235,"env":"test","module":"rbac-middleware","path":"/api/test","permission":"workflow:view","msg":"Unauthenticated user attempted to access protected resource"}
{"level":40,"time":1768514620236,"env":"test","module":"rbac-middleware","userId":"user-123","permission":"workflow:view","path":"/api/test","msg":"Permission denied"}
{"level":40,"time":1768514620236,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"invalid-role","permission":"workflow:view","path":"/api/test","msg":"Permission denied"}
{"level":30,"time":1768514620237,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768514620238,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w103
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

 [32m‚úì[39m tests/unit/middleware/rbac.test.ts [2m([22m[2m44 tests[22m[2m)[22m[33m 2212[2mms[22m[39m
{"level":30,"time":1768514620280,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514620321,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w102.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w102.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514620335,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w104, public

{"level":30,"time":1768514620374,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w104
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768514620422,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514620423,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w103.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w103.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32m‚úì[39m tests/unit/utils/encryption.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 2289[2mms[22m[39m
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768514620609,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514620610,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w105, public

 [32m‚úì[39m tests/unit/services/docxHelpers.test.ts [2m([22m[2m39 tests[22m[2m)[22m[33m 2345[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514620665,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w105
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w106, public

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514620704,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514620710,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514620710,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768514620716,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w104.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w104.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w108, public

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w106
‚è© Schema reused, skipping migrations.

 [32m‚úì[39m tests/ui/builder.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 2327[2mms[22m[39m
{"level":30,"time":1768514620774,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w108
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w105.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w105.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514621002,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514621005,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514621006,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/listPipeline.semantics.test.ts [2m([22m[2m70 tests[22m[2m)[22m[33m 2304[2mms[22m[39m
{"level":30,"time":1768514621054,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514621059,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514621060,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w107, public

 [32m‚úì[39m tests/unit/captcha.service.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 2136[2mms[22m[39m
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

{"level":30,"time":1768514621113,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768514621114,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514621115,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w107
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w109, public

 [32m‚úì[39m tests/unit/services/repeater.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 2195[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w106.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w108.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w106.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w109
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514621197,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514621179,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w108.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w108.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w108.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514621276,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w115
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w115,public

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w115 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w115%2Cpublic

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w110, public

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w110
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768514621476,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514621477,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w107.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w109.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w107.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514621520,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/utils/conditionalLogic.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 2307[2mms[22m[39m
{"level":30,"time":1768514621521,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w109.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w111, public

 [32m‚úì[39m tests/unit/engine/Performance.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2269[2mms[22m[39m
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w111
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w112, public

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w113
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w113,public

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w110.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w110.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w112
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w113 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w113%2Cpublic

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768514621814,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514621815,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/services/RunExecutionCoordinator.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 2266[2mms[22m[39m
{"level":30,"time":1768514621917,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514621918,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/conditions/conditionEvaluation.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 2294[2mms[22m[39m
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514621986,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768514621986,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/utils/conditionalLogic-simple.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2363[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/ListTools.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514622595,"env":"test","workflowId":"123e4567-e89b-12d3-a456-426614174000","userId":"user-123","sectionsCount":2,"stepsCount":0,"logicRulesCount":1,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w116
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w116,public

 [32m‚úì[39m tests/unit/services/WorkflowService.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 1722[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return workflow if user is the creator [33m 1255[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w116 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w116%2Cpublic

{"level":30,"time":1768514622684,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514622730,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w117
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w117,public

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w117 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w117%2Cpublic

{"level":30,"time":1768514622898,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514622955,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w116, public

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w119
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w119,public

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w116
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w119 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w119%2Cpublic

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w120
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w120,public

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w111.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w112.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w111.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514623215,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w120 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w120%2Cpublic

{"level":30,"time":1768514623229,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w112.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32m‚úì[39m tests/unit/services/MfaService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 1959[2mms[22m[39m
         [33m[2m‚úì[22m[39m should try multiple codes if first doesn't match [33m 316[2mms[22m[39m
{"level":30,"time":1768514623286,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514623303,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w117, public

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w117
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w116.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w116.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts[2m > [22m[2mDatavaultColumnsService[2m > [22m[2mgetColumns[2m > [22m[2mshould throw 404 if table not found
[22m[39m[DEBUG] Table not found: 660e8400-e29b-41d4-a716-446655440001

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w121
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w121,public

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w121 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w121%2Cpublic

{"level":30,"time":1768514623544,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

{"level":30,"time":1768514623593,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514623597,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768514623597,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/services/DatavaultColumnsService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 1378[2mms[22m[39m
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w120, public

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514623675,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514623676,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w119, public

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w120
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w119
‚è© Schema reused, skipping migrations.

 [32m‚úì[39m tests/unit/repositories/DocumentTemplateRepository.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 1298[2mms[22m[39m
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w117.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w117.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w117.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w117.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w124
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w124,public

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w124 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w124%2Cpublic

{"level":30,"time":1768514623889,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514623948,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w121, public

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w121
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514624037,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768514624038,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w119.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w120.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w119.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514624054,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514624055,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/repositories/DatavaultColumnsRepository.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 1278[2mms[22m[39m
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w120.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32m‚úì[39m tests/unit/schema/documentEngine.test.ts [2m([22m[2m33 tests[22m[2m)[22m[33m 1443[2mms[22m[39m
[90mstdout[2m | tests/ListTools.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w123
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w123,public

[90mstdout[2m | tests/ListTools.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w123 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w123%2Cpublic

{"level":30,"time":1768514624291,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w124, public

{"level":30,"time":1768514624349,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514624349,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768514624348,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w124
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

 [32m‚úì[39m tests/services/BrandingService.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 1310[2mms[22m[39m
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w121.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w121.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w125
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w125,public

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w125 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w125%2Cpublic

{"level":30,"time":1768514624681,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514624682,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514624691,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ListTools.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w123, public

 [32m‚úì[39m tests/unit/repositories/DatavaultTablesRepository.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 1229[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768514624752,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w122
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w122,public

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w123
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w122 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w122%2Cpublic

{"level":30,"time":1768514624810,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/ListTools.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w124.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w124.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w126
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w126,public

{"level":30,"time":1768514624880,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w126 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w126%2Cpublic

{"level":30,"time":1768514624900,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768514624951,"env":"test","msg":"DB: initialized flag set."}
{"level":40,"time":1768514625092,"env":"test","sourceListVar":"nonexistent_list","inputKey":"nonexistent_list","msg":"Input list not found, treating as empty array"}
[90mstdout[2m | tests/ListTools.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514625095,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768514625095,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w125, public

 [32m‚úì[39m tests/ListTools.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 1287[2mms[22m[39m
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w125
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w128
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w128,public

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w122, public

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w123.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w123.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w127
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w127,public

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w128 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w128%2Cpublic

{"level":30,"time":1768514625266,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w122
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w127 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w127%2Cpublic

{"level":30,"time":1768514625317,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514625317,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w126, public

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w126
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768514625381,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w122.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w125.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w122.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w125.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514625514,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768514625514,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/schema/collections.test.ts [2m([22m[2m34 tests[22m[2m)[22m[33m 1334[2mms[22m[39m
{"level":30,"time":1768514625594,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514625595,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/branding.routes.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 1239[2mms[22m[39m
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w118
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w118,public

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w128, public

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w127, public

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w118 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w118%2Cpublic

{"level":30,"time":1768514625739,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w128
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w127
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768514625787,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514625788,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w126.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w126.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w126.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w126.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32m‚úì[39m tests/unit/services/RecordService.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 1326[2mms[22m[39m
{"level":30,"time":1768514625850,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w130
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w130,public

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w130 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w130%2Cpublic

{"level":30,"time":1768514626020,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514626077,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768514626076,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514626090,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514626090,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768514626119,"env":"test","module":"ai-controller","userId":"user-123","workflowId":"123e4567-e89b-12d3-a456-426614174000","msg":"AI workflow revision job enqueued"}
 [32m‚úì[39m tests/unit/lib/queries/QueryRunner.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 1275[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768514626140,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":50,"time":1768514626156,"env":"test","module":"ai-controller","error":{"issues":[{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["workflowId"]},{"code":"invalid_type","expected":"object","received":"undefined","path":["currentWorkflow"],"message":"Required"},{"code":"invalid_type","expected":"string","received":"undefined","path":["userInstruction"],"message":"Required"}],"name":"ZodError"},"msg":"Failed to enqueue AI revision job"}
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514626161,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768514626162,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w118, public

 [32m‚úì[39m tests/unit/api.ai.revise.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 1311[2mms[22m[39m
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w118
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w132
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w132,public

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w127.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w128.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w127.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w132 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w132%2Cpublic

{"level":30,"time":1768514626336,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w128.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514626388,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w130, public

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w133
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w133,public

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w130
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w133 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w133%2Cpublic

{"level":30,"time":1768514626495,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w118.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w118.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514626542,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w132, public

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514626747,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768514626748,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w132
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768514626804,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514626804,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w130.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w130.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

 [32m‚úì[39m tests/unit/services/DatavaultTablesService.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 1222[2mms[22m[39m
 [32m‚úì[39m tests/unit/engine.run-conditions.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 1469[2mms[22m[39m
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w133, public

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w135
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w135,public

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w133
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w135 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w135%2Cpublic

{"level":30,"time":1768514626962,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w132.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w132.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514627018,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514627097,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768514627098,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w134
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w134,public

 [32m‚úì[39m tests/unit/services/DataSourceService.test.ts [2m([22m[2m9 tests[22m[2m)[22m[33m 1216[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w134 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w134%2Cpublic

{"level":30,"time":1768514627199,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514627247,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514627284,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514627285,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w129
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w129,public

{"level":30,"time":1768514627323,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
 [32m‚úì[39m tests/unit/services/CollectionFieldService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 1257[2mms[22m[39m
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w129 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w129%2Cpublic

{"level":30,"time":1768514627348,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w135, public

{"level":30,"time":1768514627418,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w136
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w136,public

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w135
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w136 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w136%2Cpublic

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w133.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w133.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514627473,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

{"level":30,"time":1768514627527,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w134, public

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w134
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w131
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w131,public

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w135.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w135.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w131 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w131%2Cpublic

{"level":30,"time":1768514627716,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514627727,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514627728,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/services/EmailTemplateMetadataService.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 1257[2mms[22m[39m
[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768514627788,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w129, public

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w129
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w136, public

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w134.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w134.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w137
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w137,public

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w136
‚è© Schema reused, skipping migrations.

{"level":30,"time":1768514627950,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514627950,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w137 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w137%2Cpublic

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mDEBUG: Existing functions: []

{"level":30,"time":1768514627969,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514628025,"env":"test","msg":"DB: initialized flag set."}
 [32m‚úì[39m tests/integration/datavault.api-tokens.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 1205[2mms[22m[39m
{"level":30,"time":1768514628151,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514628152,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w131, public

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w139
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w139,public

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w131
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w139 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w139%2Cpublic

{"level":30,"time":1768514628237,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514628239,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514628240,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w129.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w136.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w129.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514628287,"env":"test","msg":"DB: initialized flag set."}
 [32m‚úì[39m tests/unit/debugging/Lineage.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 1272[2mms[22m[39m
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w136.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32m‚úì[39m tests/unit/services/DocumentTemplateService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 1221[2mms[22m[39m
[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w137, public

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w137
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w131.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w131.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514628578,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514628579,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w139, public

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w144
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w144,public

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w139
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w144 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w144%2Cpublic

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

 [32m‚úì[39m tests/unit/workflow/PreviewExecution.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 1304[2mms[22m[39m
[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w137.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w137.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32m‚úì[39m tests/unit/services/Guardrail.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 463[2mms[22m[39m
[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w146
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w146,public

{"level":30,"time":1768514628966,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514628967,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w146 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w146%2Cpublic

{"level":30,"time":1768514628983,"env":"test","module":"write-runner","operation":"write_start","mode":"create","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"create","columnMappings":[{"columnId":"col-first","value":"{{ firstName }}"},{"columnId":"col-last","value":"Doe"},{"columnId":"col-age","value":"{{ age }}"}]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w142
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w142,public

{"level":30,"time":1768514628995,"env":"test","module":"write-runner","operation":"write_start","mode":"create","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"create","columnMappings":[]},"tableId":"table-users","preview":true,"msg":"Starting write execution"}
[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514628995,"env":"test","module":"write-runner","operation":"write_preview_simulated","values":{},"msg":"Simulating write in preview mode"}
{"level":30,"time":1768514628997,"env":"test","module":"write-runner","operation":"write_start","mode":"update","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"test@example.com","columnMappings":[{"columnId":"col-status","value":"Active"}]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
{"level":30,"time":1768514628998,"env":"test","module":"write-runner","operation":"write_start","mode":"update","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"missing@example.com","columnMappings":[]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
{"level":50,"time":1768514628999,"env":"test","module":"write-runner","error":{},"config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"missing@example.com","columnMappings":[]},"msg":"Write execution failed"}
{"level":30,"time":1768514629011,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514629012,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w142 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w142%2Cpublic

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

 [32m‚úì[39m tests/unit/writes/WriteRunner.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 488[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

 [32m‚úì[39m tests/unit/services/StepService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 1438[2mms[22m[39m
 [32m‚úì[39m tests/unit/services/CollectionService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 1230[2mms[22m[39m
[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/services/PortalAuthService.test.ts [2m([22m[2m42 tests[22m[2m)[22m[33m 576[2mms[22m[39m
[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w145
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w145,public

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w143
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w143,public

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w145 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w145%2Cpublic

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w143 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w143%2Cpublic

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

{"level":40,"time":1768514629540,"env":"test","hookId":"hook-1","hookName":"Hook 1","error":"Test error","msg":"LifecycleHookService: Hook execution failed"}
 [32m‚úì[39m tests/unit/services/AccountLockoutService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 499[2mms[22m[39m
[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":50,"time":1768514629544,"env":"test","error":{},"workflowId":"workflow-1","runId":"run-1","phase":"beforePage","msg":"LifecycleHookService: Failed to execute hooks for phase"}
{"level":30,"time":1768514629546,"env":"test","hookId":"hook-1","workflowId":"workflow-1","phase":"beforePage","msg":"LifecycleHookService: Created lifecycle hook"}
{"level":30,"time":1768514629551,"env":"test","hookId":"hook-1","workflowId":"workflow-1","msg":"LifecycleHookService: Updated lifecycle hook"}
{"level":30,"time":1768514629553,"env":"test","hookId":"hook-1","workflowId":"workflow-1","msg":"LifecycleHookService: Deleted lifecycle hook"}
 [32m‚úì[39m tests/unit/LifecycleHookService.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 529[2mms[22m[39m
[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w150
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w150,public

[90mstdout[2m | tests/unit/collab.server.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w150 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w150%2Cpublic

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

{"level":30,"time":1768514630013,"env":"test","msg":"External Send Completed","destination":"My Webhook","success":true,"status":200}
[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514630020,"env":"test","msg":"Simulating External Send","destination":"Test","payload":{}}
 [32m‚úì[39m tests/unit/external/ExternalSendRunner.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 490[2mms[22m[39m
[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w147
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w147,public

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w147 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w147%2Cpublic

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/services/EmailTemplateMetadataService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 524[2mms[22m[39m
[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w148
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w148,public

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w149
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w149,public

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w148 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w148%2Cpublic

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w149 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w149%2Cpublic

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/services/BrandingService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 475[2mms[22m[39m
 [32m‚úì[39m tests/unit/services/DatavaultRowsService.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 479[2mms[22m[39m
[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w151
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w151,public

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w151 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w151%2Cpublic

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w141
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w141,public

 [32m‚úì[39m tests/unit/engine/FinalBlockSnapshot.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 456[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w141 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w141%2Cpublic

{"level":30,"time":1768514630974,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w140
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w140,public

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w140 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w140%2Cpublic

{"level":30,"time":1768514631035,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514631038,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514631083,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w153
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w153,public

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w154
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w154,public

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w153 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w153%2Cpublic

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/collab.server.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w154 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w154%2Cpublic

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

 [32m‚úì[39m tests/unit/repositories/DatavaultRowsRepository.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 452[2mms[22m[39m
[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/services/AuditLogService.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 452[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w141, public

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w152
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w152,public

{"level":30,"time":1768514631392,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w140, public

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w141
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w152 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w152%2Cpublic

 [2m[90m‚Üì[39m[22m tests/unit/collab.server.test.ts [2m([22m[2m14 tests[22m[2m | [22m[33m14 skipped[39m[2m)[22m
[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w140
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w139.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w139.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32m‚úì[39m tests/unit/services/DatavaultReferenceColumns.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 446[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w139.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w139.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m‚úÖ OpenAPI specification loaded successfully

{"level":30,"time":1768514631740,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514631740,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768514631782,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514631783,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/datavault.row-notes.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 1224[2mms[22m[39m
 [32m‚úì[39m tests/integration/datavault.routes.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 1169[2mms[22m[39m
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w114
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w114,public

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w114 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w114%2Cpublic

{"level":30,"time":1768514632027,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514632079,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w114, public

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w114
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w140.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w141.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w140.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mDEBUG: Dropping existing function: test_schema_w141.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m‚úÖ OpenAPI specification loaded successfully

{"level":30,"time":1768514632787,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts[2m > [22m[2mPersonalization API Integration Tests
[22m[39müìö API Documentation available at /api-docs
[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768514632796,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768514632796,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768514632801,"env":"test","module":"documents-routes","msg":"Document routes registered"}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w138
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w138,public

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w138 (Reused: true)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w138%2Cpublic

{"level":30,"time":1768514633156,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768514633201,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768514633251,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514633251,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/api.ai.personalization.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 1645[2mms[22m[39m
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m‚úÖ Enforced search_path: test_schema_w138, public

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m‚úÖ Database initialized. Current schema: test_schema_w138
‚è© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "test_schema_w114.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: test_schema_w114.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768514633858,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768514633876,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts[2m > [22m[2mAI Document Assistant API Integration Tests
[22m[39müìö API Documentation available at /api-docs
[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768514633865,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768514633866,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768514633871,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768514633876,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768514633876,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768514633876,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768514633876,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":40,"time":1768514633900,"env":"test","error":{},"msg":"Deterministic DOCX extraction failed"}
{"level":30,"time":1768514633937,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768514633938,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/api.ai.doc.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 1201[2mms[22m[39m

[2m Test Files [22m [1m[31m38 failed[39m[22m[2m | [22m[1m[32m117 passed[39m[22m[2m | [22m[33m1 skipped[39m[90m (156)[39m
[2m      Tests [22m [1m[31m69 failed[39m[22m[2m | [22m[1m[32m2270 passed[39m[22m[2m | [22m[33m43 skipped[39m[90m (2382)[39m
[2m   Start at [22m 16:02:44
[2m   Duration [22m 77.31s[2m (transform 33.08s, setup 21.63s, import 164.50s, tests 648.70s, environment 20.03s)[22m

