npm warn Unknown project config "puppeteer_skip_download". This will stop working in the next major version of npm.

[1m[46m RUN [49m[22m [36mv4.0.16 [39m[90mC:/Users/scoot/poll/VaultLogic[39m

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w0

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0,public

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0%2Cpublic

{"level":30,"time":1768455227959,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768455227991,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w0, public

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w0
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0000_daffy_roughhouse.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0001_remove_participants.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0002_add_mode_columns.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0003_add_step_aliases.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in 0003_add_step_aliases.sql (Error: column "alias" of relation "steps" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0004_add_teams_and_acls.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in 0004_add_teams_and_acls.sql (Error: column "owner_id" of relation "projects" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0005_add_transform_block_phases.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in 0005_add_transform_block_phases.sql (Error: column "phase" of relation "transform_blocks" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0006_add_updated_at_columns.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0007_add_js_question_type.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0007_lying_namor.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in 0007_lying_namor.sql (Error: relation "sections" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0008_add_virtual_steps_for_transform_blocks.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0009_add_multi_tenant_data_model.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0009_real_vapor.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in 0009_real_vapor.sql (Error: constraint "workflow_run_events_run_id_workflow_runs_id_fk" for relation "workflow_run_events" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0010_add_external_connections_and_secret_types.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in 0010_add_external_connections_and_secret_types.sql (Error: type "secret_type" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0010_nullable_creator_owner.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0011_add_trace_and_error_to_runs.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0012_add_analytics_sli_tables.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in 0012_add_analytics_sli_tables.sql (Error: type "metrics_event_type" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0013_add_intake_portal_columns.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0014_add_workflow_versioning_columns.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0015_add_intake_config.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0016_add_review_and_esign_tables.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0017_add_connections_table.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0018_add_branding_and_domains.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0019_add_collections_datastore.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0020_add_collection_block_types.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0021_add_page_conditions.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in 0021_add_page_conditions.sql (Error: column "visible_if" of relation "sections" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0022_add_question_conditions.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in 0022_add_question_conditions.sql (Error: column "visible_if" of relation "steps" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0023_add_repeater_type.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0024_add_document_engine_tables.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in 0024_add_document_engine_tables.sql (Error: type "output_status" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0024_add_performance_indexes.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0025_fix_workflows_missing_columns.sql...

stderr | tests/integration/ai/workflowEdit.test.ts
Î“Â¥Ã® FAILED MIGRATION 0025_fix_workflows_missing_columns.sql: null value in column "title" of relation "projects" violates not-null constraint
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: null value in column "title" of relation "projects" violates not-null constraint
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:185:19 {
  length: 672,
  severity: 'ERROR',
  code: '23502',
  detail: 'Failing row contains (5b2fc3ff-34a4-436d-8c39-6e4cba1b2440, null, Default Project, null, null, fc209748-1d1b-49e5-9373-256e503de044, system, system, active, f, 2026-01-15 05:34:42.539391, 2026-01-15 05:34:42.539391).',
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: 'SQL statement "INSERT INTO projects (name, tenant_id, created_by, owner_id)\r\n' +
    "    VALUES ('Default Project', default_tenant_id, COALESCE(first_user_id, 'system'), COALESCE(first_user_id, 'system'))\r\n" +
    '    RETURNING id"\n' +
    'PL/pgSQL function inline_code_block line 33 at SQL statement',
  schema: 'test_schema_w0',
  table: 'projects',
  column: 'title',
  dataType: undefined,
  constraint: undefined,
  file: 'execMain.c',
  line: '2032',
  routine: 'ExecConstraints'
}

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy"
    ],
    "proargtypes": "2950 2950 2950 25 23 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text)"
  }
]

stderr | tests/integration/ai/workflowEdit.test.ts > POST /api/workflows/:workflowId/ai/edit - Integration Test
Î“ÃœÃ¡âˆ©â••Ã… Skipping auditEvents cleanup: auditEvents or testUserId is undefined { auditEvents: false, testUserId: undefined }

{"level":30,"time":1768455281649,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768455281649,"env":"test","msg":"DB: pool closed."}
 [31mÎ“Â¥Â»[39m tests/integration/ai/workflowEdit.test.ts [2m([22m[2m8 tests[22m[2m | [22m[33m8 skipped[39m[2m)[22m[33m 54208[2mms[22m[39m
     [2m[90mÎ“Ã¥Ã´[39m[22m should create draft version on successful AI edit
     [2m[90mÎ“Ã¥Ã´[39m[22m should enforce draft mode (revert active workflow to draft)
     [2m[90mÎ“Ã¥Ã´[39m[22m should not create version when no changes detected (checksum match)
     [2m[90mÎ“Ã¥Ã´[39m[22m should reject unauthorized access
     [2m[90mÎ“Ã¥Ã´[39m[22m should reject unsafe DataVault operations
     [2m[90mÎ“Ã¥Ã´[39m[22m should handle multi-operation edits with tempId resolution
     [2m[90mÎ“Ã¥Ã´[39m[22m should create BEFORE and AFTER snapshots
     [2m[90mÎ“Ã¥Ã´[39m[22m should rollback on validation failure

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/ai/workflowEdit.test.ts > POST /api/workflows/:workflowId/ai/edit - Integration Test
error: column "is_placeholder" of relation "users" does not exist
 Î“Â¥Â» node_modules/pg-pool/index.js:45:11
 Î“Â¥Â» node_modules/drizzle-orm/node-postgres/session.js:83:22
 Î“Â¥Â» tests/integration/ai/workflowEdit.test.ts:112:20
    110| 
    111|     // Create test user
    112|     const [user] = await db.insert(users).values({
       |                    ^
    113|       id: mockUserId,
    114|       email: 'test@example.com',


Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/1]Î“Ã„Â»

[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [33m8 skipped[39m[90m (8)[39m
[2m   Start at [22m 23:33:45
[2m   Duration [22m 55.87s[2m (transform 619ms, setup 141ms, import 1.14s, tests 54.21s, environment 0ms)[22m

