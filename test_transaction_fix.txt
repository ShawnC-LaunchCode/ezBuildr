npm warn Unknown project config "puppeteer_skip_download". This will stop working in the next major version of npm.

> ezbuildr@1.0.0 test
> cross-env VITEST_INTEGRATION=true vitest run --coverage


[1m[46m RUN [49m[22m [36mv4.0.16 [39m[90mC:/Users/scoot/poll/VaultLogic[39m
      [2mCoverage enabled with [22m[33mv8[39m

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w5_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w5_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w7_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w7_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w14_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w10_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w4_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w14_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w10_v3 (Reused: true)

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w4_v3 (Reused: true)

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w12_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mðŸ“Š Schema test_schema_w5_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708784634,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708784635,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w5_v3\",public"}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w12_v3 (Reused: true)

{"level":30,"time":1768708784696,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w5_v3\",public"}
{"level":30,"time":1768708784696,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mðŸ“Š Schema test_schema_w7_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708784723,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708784724,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w7_v3\",public"}
{"level":30,"time":1768708784772,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w7_v3\",public"}
{"level":30,"time":1768708784772,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w6_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w6_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mðŸ“Š Schema test_schema_w10_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39mðŸ“Š Schema test_schema_w14_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstderr[2m | tests/unit/services/AuthService.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): Error: [vitest] No "closeDatabase" export is defined on the "../../../server/db" mock. Did you forget to return it from "vi.mock"?
If you need to partially mock a module, you can use "importOriginal" helper inside:

    at VitestMocker.createError [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:311:17[90m)[39m
    at Object.get [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:384:16[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:177:34
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m {
  codeFrame: [32m'vi.mock(import("../../../server/db"), async (importOriginal) => {\n'[39m +
    [32m'  const actual = await importOriginal()\n'[39m +
    [32m'  return {\n'[39m +
    [32m'    ...actual,\n'[39m +
    [32m'    // your mocked methods\n'[39m +
    [32m'  }\n'[39m +
    [32m'})'[39m
}

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mðŸ“Š Schema test_schema_w4_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708784925,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708784926,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w4_v3\",public"}
{"level":30,"time":1768708784974,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w4_v3\",public"}
{"level":30,"time":1768708784975,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mðŸ“Š Schema test_schema_w12_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708785101,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708785103,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w12_v3\",public"}
{"level":30,"time":1768708785159,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w12_v3\",public"}
{"level":30,"time":1768708785159,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mðŸ“Š Schema test_schema_w6_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708785252,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708785253,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w6_v3\",public"}
{"level":30,"time":1768708785304,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w6_v3\",public"}
{"level":30,"time":1768708785304,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w5_v3, public
âœ… Enforced search_path: test_schema_w5_v3, public

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w7_v3, public
âœ… Enforced search_path: test_schema_w7_v3, public

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w12_v3
âœ… Current search_path: test_schema_w12_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w12_v3
âœ… Current search_path: test_schema_w12_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w10_v3, public
âœ… Enforced search_path: test_schema_w10_v3, public

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w4_v3, public
âœ… Enforced search_path: test_schema_w4_v3, public

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w6_v3
âœ… Current search_path: test_schema_w6_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w6_v3
âœ… Current search_path: test_schema_w6_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w12_v3, public
âœ… Enforced search_path: test_schema_w12_v3, public

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w6_v3
âœ… Current search_path: test_schema_w5_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w6_v3, public
âœ… Enforced search_path: test_schema_w6_v3, public

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w7_v3
âœ… Current search_path: test_schema_w7_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708786209,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768708786214,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768708786214,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768708786216,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768708786216,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768708786218,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768708786216,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w8_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w11_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w1_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w3_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w13_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w9_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w2_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w8_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w11_v3 (Reused: true)

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w1_v3 (Reused: true)

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w13_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w3_v3 (Reused: true)

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w2_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w9_v3 (Reused: true)

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mðŸ“Š Schema test_schema_w8_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708787174,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708787174,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w8_v3\",public"}
{"level":30,"time":1768708787216,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w8_v3\",public"}
{"level":30,"time":1768708787216,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mðŸ“Š Schema test_schema_w13_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708787250,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708787251,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w13_v3\",public"}
[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mðŸ“Š Schema test_schema_w1_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708787255,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708787255,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w1_v3\",public"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mðŸ“Š Schema test_schema_w2_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mðŸ“Š Schema test_schema_w11_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708787274,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708787274,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708787275,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w2_v3\",public"}
{"level":30,"time":1768708787275,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w11_v3\",public"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mðŸ“Š Schema test_schema_w9_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708787277,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708787277,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w9_v3\",public"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mðŸ“Š Schema test_schema_w3_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708787284,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708787300,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w13_v3\",public"}
{"level":30,"time":1768708787300,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708787308,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w1_v3\",public"}
{"level":30,"time":1768708787308,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708787323,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w11_v3\",public"}
{"level":30,"time":1768708787323,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708787326,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w9_v3\",public"}
{"level":30,"time":1768708787326,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w2_v3\",public"}
{"level":30,"time":1768708787326,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708787326,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708787285,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w3_v3\",public"}
{"level":30,"time":1768708787334,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w3_v3\",public"}
{"level":30,"time":1768708787334,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould create placeholder user for non-existent email
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,8d46bbb9-1322-42fa-90f7-483e65f6fbbd,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'8d46bbb9-1322-42fa-90f7-483e65f6fbbd'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m520[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (8ce8a524-167a-4b1b-a06f-f29683b66b7b, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, 8d46bbb9-1322-42fa-90f7-483e65f6fbbd, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-18 03:59:48.795815, 2026-01-18 03:59:48.795815).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w4_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w8_v3, public
âœ… Enforced search_path: test_schema_w8_v3, public

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould transfer user-owned project to org
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,095f959a-b8ef-4ea9-b73a-6a5fd89c927a,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'095f959a-b8ef-4ea9-b73a-6a5fd89c927a'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m522[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (c5e95b9a-93b7-42d9-9201-3e7978e2af7a, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 095f959a-b8ef-4ea9-b73a-6a5fd89c927a, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 03:59:48.994031, 2026-01-18 03:59:48.994031).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w5_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mâš ï¸ Could not set database-level search_path (expected in cloud DBs): tuple concurrently updated
âœ… Enforced search_path: test_schema_w11_v3, public

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mâš ï¸ Could not set database-level search_path (expected in cloud DBs): tuple concurrently updated
âœ… Enforced search_path: test_schema_w2_v3, public

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w1_v3, public
âœ… Enforced search_path: test_schema_w1_v3, public

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w13_v3, public
âœ… Enforced search_path: test_schema_w13_v3, public

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w7_v3
âœ… Current search_path: test_schema_w7_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w3_v3, public
âœ… Enforced search_path: test_schema_w3_v3, public

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w9_v3, public
âœ… Enforced search_path: test_schema_w9_v3, public

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w10_v3
âœ… Current search_path: test_schema_w5_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w5_v3
âœ… Current search_path: test_schema_w5_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w7_v3
âœ… Current search_path: test_schema_w5_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w7_v3
âœ… Current search_path: test_schema_w5_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w7_v3
âœ… Current search_path: test_schema_w8_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w5_v3
âœ… Current search_path: test_schema_w3_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould prevent transfer to org if user is not a member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,f6fe96b5-888f-400f-8ccb-54ef14eb591d,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'f6fe96b5-888f-400f-8ccb-54ef14eb591d'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m522[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (066717aa-5139-4c4a-972a-37f17eed7c15, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, f6fe96b5-888f-400f-8ccb-54ef14eb591d, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 03:59:49.894824, 2026-01-18 03:59:49.894824).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w7_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768708788978,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/services/AuthService.test.ts[2m > [22m[2mAuthService[2m > [22m[2mJWT Token Management[2m > [22m[2mverifyToken()[2m > [22m[2mshould throw error for invalid token signature
[22m[39mDEBUG: verifyToken threw: Invalid or malformed token InvalidTokenError

{"level":50,"time":1768708789685,"env":"test","module":"auth-routes","email":"test-1768708789247-xjwpj@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768708789694,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["b7fdff4f-adf7-417c-946b-0a592e49ddc1","$2b$12$M9xs8Mli8AlqVe3XlJNH2.00dUHiiAocwPaoe67YiUK.veyF5lE/W"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b7fdff4f-adf7-417c-946b-0a592e49ddc1) is not present in table \"users\".","schema":"test_schema_w11_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"b7fdff4f-adf7-417c-946b-0a592e49ddc1","msg":"Failed to create user credentials"}
{"level":50,"time":1768708789694,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["b7fdff4f-adf7-417c-946b-0a592e49ddc1","$2b$12$M9xs8Mli8AlqVe3XlJNH2.00dUHiiAocwPaoe67YiUK.veyF5lE/W"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b7fdff4f-adf7-417c-946b-0a592e49ddc1) is not present in table \"users\".","schema":"test_schema_w11_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768708789699,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["8881df9e-b36e-473e-89bf-45c9cd525dc6","$2b$12$86OPwjrinifEFX1USeEqwOI9jinSOo5d1TCJbQYrp.oVx6.M8Ew36"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(8881df9e-b36e-473e-89bf-45c9cd525dc6) is not present in table \"users\".","schema":"test_schema_w11_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"8881df9e-b36e-473e-89bf-45c9cd525dc6","msg":"Failed to create user credentials"}
{"level":50,"time":1768708789700,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["8881df9e-b36e-473e-89bf-45c9cd525dc6","$2b$12$86OPwjrinifEFX1USeEqwOI9jinSOo5d1TCJbQYrp.oVx6.M8Ew36"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(8881df9e-b36e-473e-89bf-45c9cd525dc6) is not present in table \"users\".","schema":"test_schema_w11_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768708789817,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould allow org member to transfer org-owned project to another org they belong to
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,a0f1489c-dd84-48ee-b9fd-72ae9a90ff33,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'a0f1489c-dd84-48ee-b9fd-72ae9a90ff33'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m522[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (9816ff93-0d0e-4e1c-abde-4ab92e62067d, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, a0f1489c-dd84-48ee-b9fd-72ae9a90ff33, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 03:59:50.829244, 2026-01-18 03:59:50.829244).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w6_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768708789892,"env":"test","module":"auth-routes","email":"test-1768708789247-xjwpj@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768708789990,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768708790044,"env":"test","module":"auth-routes","email":"test-1768708789247-xjwpj@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768708790164,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768708790459,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["7f3333f0-10cf-4182-842f-51b8030854bd","$2b$12$N7U3kc0DD9RT6iBGcbbUtegy/8vHt.7FKAOPykbfHciPsaTX14PZy"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(7f3333f0-10cf-4182-842f-51b8030854bd) is not present in table \"users\".","schema":"test_schema_w7_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"7f3333f0-10cf-4182-842f-51b8030854bd","msg":"Failed to create user credentials"}
{"level":50,"time":1768708790459,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["7f3333f0-10cf-4182-842f-51b8030854bd","$2b$12$N7U3kc0DD9RT6iBGcbbUtegy/8vHt.7FKAOPykbfHciPsaTX14PZy"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(7f3333f0-10cf-4182-842f-51b8030854bd) is not present in table \"users\".","schema":"test_schema_w7_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768708790461,"env":"test","module":"auth-routes","email":"test-1768708789714-10r3im@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768708790580,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768708790640,"env":"test","module":"auth-routes","email":"test-1768708789714-10r3im@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768708790732,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould detach workflow from project when transferring to different owner
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,22c94dec-3afe-4e17-8882-9e23f90cc126,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'22c94dec-3afe-4e17-8882-9e23f90cc126'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m522[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (453abf56-3afc-4974-8372-ad34ef106dc7, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 22c94dec-3afe-4e17-8882-9e23f90cc126, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 03:59:51.757295, 2026-01-18 03:59:51.757295).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w6_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":50,"time":1768708790781,"env":"test","module":"auth-routes","email":"test-1768708789714-10r3im@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768708790873,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768708790879,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768708790927,"env":"test","module":"auth-routes","email":"test-1768708789714-10r3im@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768708791042,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768708791094,"env":"test","module":"auth-routes","email":"test-1768708789714-10r3im@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768708791215,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["2c8ff609-5b29-44da-8ba7-19029400567b","$2b$12$ZIF.6wnKZNwOMKDdhGkydugYaX09FEBabQKIitEMVZR1MN0f.HE/S"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(2c8ff609-5b29-44da-8ba7-19029400567b) is not present in table \"users\".","schema":"test_schema_w11_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"2c8ff609-5b29-44da-8ba7-19029400567b","msg":"Failed to create user credentials"}
{"level":50,"time":1768708791215,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["2c8ff609-5b29-44da-8ba7-19029400567b","$2b$12$ZIF.6wnKZNwOMKDdhGkydugYaX09FEBabQKIitEMVZR1MN0f.HE/S"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(2c8ff609-5b29-44da-8ba7-19029400567b) is not present in table \"users\".","schema":"test_schema_w11_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768708791216,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768708791267,"env":"test","module":"auth-routes","email":"test-1768708789714-10r3im@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768708791364,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould keep workflow in project when transferring to same owner
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,c6a0eb92-b2f4-43a7-b7f5-8b846bab6ccd,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'c6a0eb92-b2f4-43a7-b7f5-8b846bab6ccd'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m522[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (0f090cd9-210c-402d-aa9e-3fb6dbc6b839, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, c6a0eb92-b2f4-43a7-b7f5-8b846bab6ccd, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 03:59:52.656253, 2026-01-18 03:59:52.656253).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w1_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

{"level":50,"time":1768708791803,"env":"test","module":"auth-routes","email":"test-1768708791015-874vj@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould set expiry to 7 days from now
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,3e58dfc6-3796-41e6-81a2-2bfc9d3bcd2b,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'3e58dfc6-3796-41e6-81a2-2bfc9d3bcd2b'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m520[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (11f8a50e-2006-4295-b1e1-04baeb998f7e, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, 3e58dfc6-3796-41e6-81a2-2bfc9d3bcd2b, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-18 03:59:52.855865, 2026-01-18 03:59:52.855865).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w2_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":50,"time":1768708791900,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould generate unique backup codes
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768708791917,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768708791919,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["b361a15e-0984-4b9c-a9ea-cc4493a14fbb","$2b$12$FzmTzfN4B.XIIjrgKeZwZOfDWJU5nGzwbA9/31UL1UmIzUeb4DKMm"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b361a15e-0984-4b9c-a9ea-cc4493a14fbb) is not present in table \"users\".","schema":"test_schema_w11_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"b361a15e-0984-4b9c-a9ea-cc4493a14fbb","msg":"Failed to create user credentials"}
{"level":50,"time":1768708791919,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["b361a15e-0984-4b9c-a9ea-cc4493a14fbb","$2b$12$FzmTzfN4B.XIIjrgKeZwZOfDWJU5nGzwbA9/31UL1UmIzUeb4DKMm"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b361a15e-0984-4b9c-a9ea-cc4493a14fbb) is not present in table \"users\".","schema":"test_schema_w11_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [31mâ¯[39m tests/unit/services/AuthService.test.ts [2m([22m[2m113 tests[22m[2m | [22m[31m13 failed[39m[2m)[22m[33m 8131[2mms[22m[39m
         [32mâœ“[39m should hash a password using bcrypt with 12 rounds[32m 240[2mms[22m[39m
         [33m[2mâœ“[22m[39m should generate different hashes for same password [33m 471[2mms[22m[39m
         [32mâœ“[39m should handle empty passwords[32m 240[2mms[22m[39m
         [32mâœ“[39m should handle long passwords[32m 228[2mms[22m[39m
         [32mâœ“[39m should handle unicode characters in password[32m 244[2mms[22m[39m
         [33m[2mâœ“[22m[39m should return true for correct password [33m 455[2mms[22m[39m
         [33m[2mâœ“[22m[39m should return false for incorrect password [33m 444[2mms[22m[39m
         [33m[2mâœ“[22m[39m should be case-sensitive [33m 443[2mms[22m[39m
         [33m[2mâœ“[22m[39m should handle empty password comparison [33m 447[2mms[22m[39m
         [32mâœ“[39m should accept valid email addresses[32m 2[2mms[22m[39m
         [32mâœ“[39m should reject emails longer than 254 characters (RFC 5321)[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject emails shorter than 3 characters[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject emails with consecutive dots[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject emails without @ symbol[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject emails without domain[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject emails with spaces[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject emails without TLD[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject null or undefined[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject emails with local part longer than 64 characters[32m 1[2mms[22m[39m
         [32mâœ“[39m should accept valid strong passwords[32m 21[2mms[22m[39m
         [32mâœ“[39m should reject passwords shorter than 8 characters[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject passwords longer than 128 characters[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject weak passwords with zxcvbn score < 3[32m 5[2mms[22m[39m
         [32mâœ“[39m should provide helpful feedback for weak passwords[32m 2[2mms[22m[39m
         [32mâœ“[39m should reject password containing user's email[32m 3[2mms[22m[39m
         [32mâœ“[39m should reject password containing user's name[32m 3[2mms[22m[39m
         [32mâœ“[39m should accept strong password even with user inputs provided[32m 5[2mms[22m[39m
         [32mâœ“[39m should accept password with exactly 8 characters if strong enough[32m 2[2mms[22m[39m
         [32mâœ“[39m should accept password with exactly 128 characters if strong[32m 115[2mms[22m[39m
         [32mâœ“[39m should return score in result object[32m 3[2mms[22m[39m
         [32mâœ“[39m should create a valid JWT token for a user[32m 4[2mms[22m[39m
         [32mâœ“[39m should include userId, email, tenantId, and role in token payload[32m 1[2mms[22m[39m
         [32mâœ“[39m should set token expiry to 15 minutes by default[32m 1[2mms[22m[39m
         [32mâœ“[39m should throw error if JWT_SECRET is not configured[32m 1[2mms[22m[39m
         [32mâœ“[39m should handle null tenantId and role[32m 1[2mms[22m[39m
         [32mâœ“[39m should verify and decode a valid token[32m 3[2mms[22m[39m
         [33m[2mâœ“[22m[39m should throw error for expired token [33m 1103[2mms[22m[39m
         [32mâœ“[39m should throw error for invalid token signature[32m 2[2mms[22m[39m
         [32mâœ“[39m should throw error for malformed token[32m 1[2mms[22m[39m
         [32mâœ“[39m should throw error for invalid token[32m 1[2mms[22m[39m
         [32mâœ“[39m should extract token from Bearer authorization header[32m 1[2mms[22m[39m
         [32mâœ“[39m should return token if no Bearer prefix[32m 1[2mms[22m[39m
         [32mâœ“[39m should return null for undefined header[32m 1[2mms[22m[39m
         [32mâœ“[39m should return null for empty header[32m 1[2mms[22m[39m
         [32mâœ“[39m should handle Bearer with multiple spaces[32m 1[2mms[22m[39m
         [32mâœ“[39m should return true for JWT-like tokens[32m 1[2mms[22m[39m
         [32mâœ“[39m should return false for non-JWT tokens[32m 1[2mms[22m[39m
         [32mâœ“[39m should return false for empty token[32m 1[2mms[22m[39m
         [32mâœ“[39m should return false for null/undefined[32m 1[2mms[22m[39m
         [32mâœ“[39m should create a valid portal token for an email[32m 2[2mms[22m[39m
         [32mâœ“[39m should include email and portal flag in token payload[32m 1[2mms[22m[39m
         [32mâœ“[39m should set token expiry to 24 hours[32m 1[2mms[22m[39m
         [32mâœ“[39m should verify and decode a valid portal token[32m 1[2mms[22m[39m
         [32mâœ“[39m should throw error for non-portal token[32m 2[2mms[22m[39m
         [32mâœ“[39m should throw error for token without email[32m 1[2mms[22m[39m
         [32mâœ“[39m should throw error for expired portal token[32m 1[2mms[22m[39m
[31m         [31mÃ—[31m should generate password reset token for existing user[39m[32m 229[2mms[22m[39m
         [32mâœ“[39m should return null for non-existent user[32m 1[2mms[22m[39m
[31m         [31mÃ—[31m should invalidate previous reset tokens[39m[32m 1[2mms[22m[39m
         [32mâœ“[39m should return userId for valid token[32m 1[2mms[22m[39m
         [32mâœ“[39m should return null for invalid token[32m 1[2mms[22m[39m
         [32mâœ“[39m should return null for expired token[32m 1[2mms[22m[39m
         [32mâœ“[39m should return null for used token[32m 1[2mms[22m[39m
         [32mâœ“[39m should mark token as used[32m 2[2mms[22m[39m
         [32mâœ“[39m should generate verification token[32m 1[2mms[22m[39m
         [32mâœ“[39m should have 24 hour expiry[32m 1[2mms[22m[39m
         [32mâœ“[39m should verify email with valid token[32m 2[2mms[22m[39m
         [32mâœ“[39m should return false for invalid token[32m 1[2mms[22m[39m
         [32mâœ“[39m should return false for expired token[32m 1[2mms[22m[39m
         [32mâœ“[39m should delete token after successful verification[32m 1[2mms[22m[39m
         [32mâœ“[39m should create refresh token with 30-day expiry[32m 2[2mms[22m[39m
         [32mâœ“[39m should store device metadata[32m 1[2mms[22m[39m
         [32mâœ“[39m should return userId for valid token[32m 1[2mms[22m[39m
         [32mâœ“[39m should return null for revoked token[32m 1[2mms[22m[39m
         [32mâœ“[39m should return null for expired token[32m 1[2mms[22m[39m
[31m         [31mÃ—[31m should rotate valid token and return new one[39m[32m 2[2mms[22m[39m
[31m         [31mÃ—[31m should return null for unknown token[39m[32m 2[2mms[22m[39m
[31m         [31mÃ—[31m should revoke all tokens on reuse detection[39m[32m 2[2mms[22m[39m
[31m         [31mÃ—[31m should return null for expired token[39m[32m 2[2mms[22m[39m
         [32mâœ“[39m should revoke specific token[32m 1[2mms[22m[39m
         [32mâœ“[39m should revoke all tokens for user[32m 1[2mms[22m[39m
[31m         [31mÃ—[31m should cleanup expired refresh tokens[39m[32m 2[2mms[22m[39m
[31m         [31mÃ—[31m should cleanup expired password reset tokens[39m[32m 2[2mms[22m[39m
[31m         [31mÃ—[31m should cleanup expired email verification tokens[39m[32m 2[2mms[22m[39m
[31m         [31mÃ—[31m should cleanup old login attempts via accountLockoutService[39m[32m 2[2mms[22m[39m
         [32mâœ“[39m should use JWT_SECRET if provided[32m 2[2mms[22m[39m
         [32mâœ“[39m should warn if JWT_SECRET is less than 32 characters[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject token with modified payload[32m 2[2mms[22m[39m
         [32mâœ“[39m should reject token with valid structure but invalid signature[32m 2[2mms[22m[39m
         [33m[2mâœ“[22m[39m should handle password with special characters [33m 442[2mms[22m[39m
         [32mâœ“[39m should handle password with only spaces[32m 223[2mms[22m[39m
         [33m[2mâœ“[22m[39m should handle password with newlines and tabs [33m 442[2mms[22m[39m
         [33m[2mâœ“[22m[39m should reject password with null bytes (if validation exists) [33m 444[2mms[22m[39m
         [32mâœ“[39m should reject email with unicode domain (security fix)[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject email starting with dot (security fix)[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject email ending with dot before @ (security fix)[32m 1[2mms[22m[39m
         [32mâœ“[39m should handle email with plus addressing[32m 1[2mms[22m[39m
         [32mâœ“[39m should handle email with subdomain[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject email with invalid TLD (single char)[32m 1[2mms[22m[39m
         [32mâœ“[39m should accept email with numeric TLD[32m 1[2mms[22m[39m
         [32mâœ“[39m should prevent timing attacks on token validation[32m 1[2mms[22m[39m
[31m         [31mÃ—[31m should support full user authentication lifecycle[39m[32m 219[2mms[22m[39m
[31m         [31mÃ—[31m should support complete password reset workflow[39m[32m 2[2mms[22m[39m
[31m         [31mÃ—[31m should prevent reuse of password reset tokens[39m[32m 2[2mms[22m[39m
         [32mâœ“[39m should support multiple valid refresh tokens per user[32m 2[2mms[22m[39m
         [32mâœ“[39m should revoke all user tokens on security event[32m 1[2mms[22m[39m
         [32mâœ“[39m should handle database connection failures gracefully[32m 2[2mms[22m[39m
         [32mâœ“[39m should handle transaction failures[32m 2[2mms[22m[39m
         [32mâœ“[39m should throw error if JWT signing fails[32m 2[2mms[22m[39m
         [32mâœ“[39m should hash password in reasonable time (< 500ms)[32m 221[2mms[22m[39m
         [33m[2mâœ“[22m[39m should compare password in reasonable time (< 500ms) [33m 442[2mms[22m[39m
         [32mâœ“[39m should create JWT token in < 10ms[32m 1[2mms[22m[39m
         [32mâœ“[39m should verify JWT token in < 50ms[32m 1[2mms[22m[39m
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould prevent non-member from transferring org workflow
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,75402028-c5b6-4e89-aad2-07d8672b1774,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'75402028-c5b6-4e89-aad2-07d8672b1774'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m520[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (ad53f72c-4799-4e77-8c02-425041e6d704, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 75402028-c5b6-4e89-aad2-07d8672b1774, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 03:59:53.60461, 2026-01-18 03:59:53.60461).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w6_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mðŸ“Š Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708792625,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708792626,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w0_v3\",public"}
{"level":30,"time":1768708792667,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w0_v3\",public"}
{"level":30,"time":1768708792667,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

{"level":50,"time":1768708792923,"env":"test","module":"auth-routes","email":"test-1768708792510-oj6k34@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768708793026,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768708793038,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould store hashed backup codes
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768708793043,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w0_v3, public
âœ… Enforced search_path: test_schema_w0_v3, public

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w8_v3
âœ… Current search_path: test_schema_w3_v3, public
â© Schema reused, skipping migrations.

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject expired invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,c8312e06-8570-4d8f-b11c-39ecc13d6c4b,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'c8312e06-8570-4d8f-b11c-39ecc13d6c4b'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m520[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (20da5699-9971-42b2-8ad1-b13e4ad416fa, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, c8312e06-8570-4d8f-b11c-39ecc13d6c4b, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-18 03:59:55.044508, 2026-01-18 03:59:55.044508).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w4_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":50,"time":1768708794054,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["kifPKNLXTYO9MhSRQRTyo","$2b$12$/HJWG.IIP6/ualVVn5cj0e12CLTw7cg9wFfgD9kwQFQe86jW1zL8W"],"cause":{"length":331,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(kifPKNLXTYO9MhSRQRTyo) is not present in table \"users\".","schema":"test_schema_w4_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"kifPKNLXTYO9MhSRQRTyo","msg":"Failed to create user credentials"}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w15_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w15_v3 (Reused: true)

{"level":50,"time":1768708794131,"env":"test","module":"auth-routes","email":"nonexistent@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768708794253,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for non-existent user
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mðŸ“Š Schema test_schema_w15_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708794502,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708794503,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w15_v3\",public"}
{"level":30,"time":1768708794545,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w15_v3\",public"}
{"level":30,"time":1768708794545,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768708794642,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["e8e26d1c-0359-47a4-a20f-0f2765d4393e","$2b$12$VIkmDx0r1RMeoguJJ8eyMu8aEuCKVXCOjcmTQDqJa25YZdxfGGQci"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(e8e26d1c-0359-47a4-a20f-0f2765d4393e) is not present in table \"users\".","schema":"test_schema_w3_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"e8e26d1c-0359-47a4-a20f-0f2765d4393e","msg":"Failed to create user credentials"}
{"level":50,"time":1768708794642,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["e8e26d1c-0359-47a4-a20f-0f2765d4393e","$2b$12$VIkmDx0r1RMeoguJJ8eyMu8aEuCKVXCOjcmTQDqJa25YZdxfGGQci"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(e8e26d1c-0359-47a4-a20f-0f2765d4393e) is not present in table \"users\".","schema":"test_schema_w3_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768708794924,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["WMTiwN0HxIvxfmkA08YhL","$2b$12$wtXqCZRSLZriIqlm6gjXuuaXQVqhkI8XgDyioN0L89lBAPIU8s31O"],"cause":{"length":332,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(WMTiwN0HxIvxfmkA08YhL) is not present in table \"users\".","schema":"test_schema_w13_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"WMTiwN0HxIvxfmkA08YhL","msg":"Failed to create user credentials"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject already accepted invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,af94076b-3b15-46c7-a0d1-d654b4cccf64,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'af94076b-3b15-46c7-a0d1-d654b4cccf64'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m521[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (4c0ca666-e2f5-4fd3-953c-a4087bb2ee28, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, af94076b-3b15-46c7-a0d1-d654b4cccf64, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-18 03:59:56.136379, 2026-01-18 03:59:56.136379).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w13_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mDEBUG: Existing functions: []

{"level":50,"time":1768708795530,"env":"test","module":"auth-routes","email":"test-1768708794260-3a9avm@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768708795617,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":50,"time":1768708795625,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 403 for unverified email
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":30,"time":1768708795636,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708795625,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708795626,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708795631,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708795631,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708795636,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708795636,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708795636,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708795636,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mDatabase Transfer[2m > [22m[2mshould transfer database ownership
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,2dd70f7b-2f28-41df-8e4b-384096c673c3,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'2dd70f7b-2f28-41df-8e4b-384096c673c3'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m522[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (001b71f5-3a96-4365-8079-5e776a116926, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 2dd70f7b-2f28-41df-8e4b-384096c673c3, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 03:59:56.747796, 2026-01-18 03:59:56.747796).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w9_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w15_v3, public
âœ… Enforced search_path: test_schema_w15_v3, public

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w9_v3
âœ… Current search_path: test_schema_w8_v3, public
â© Schema reused, skipping migrations.

{"level":50,"time":1768708796080,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["d10df102-761d-4c0b-9b1e-ef9232fc96f0","$2b$12$aWQXaLZmXF.O5KJkDLHfMuRIwieR6FANHzKhwCLZkOdEP2Fym1rG2"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(d10df102-761d-4c0b-9b1e-ef9232fc96f0) is not present in table \"users\".","schema":"test_schema_w4_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"d10df102-761d-4c0b-9b1e-ef9232fc96f0","msg":"Failed to create user credentials"}
{"level":50,"time":1768708796080,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["d10df102-761d-4c0b-9b1e-ef9232fc96f0","$2b$12$aWQXaLZmXF.O5KJkDLHfMuRIwieR6FANHzKhwCLZkOdEP2Fym1rG2"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(d10df102-761d-4c0b-9b1e-ef9232fc96f0) is not present in table \"users\".","schema":"test_schema_w4_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708796090,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708796091,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/auth/protected.routes.test.ts [2m([22m[2m33 tests[22m[2m | [22m[33m33 skipped[39m[2m)[22m[33m 4286[2mms[22m[39m
       [2m[90mâ†“[39m[22m should allow access with valid Bearer token
       [2m[90mâ†“[39m[22m should reject access without Authorization header
       [2m[90mâ†“[39m[22m should reject access with empty Bearer token
       [2m[90mâ†“[39m[22m should reject access with malformed Authorization header
       [2m[90mâ†“[39m[22m should reject access with wrong token type
       [2m[90mâ†“[39m[22m should allow POST with valid Bearer token
       [2m[90mâ†“[39m[22m should reject POST without Bearer token
       [2m[90mâ†“[39m[22m should reject POST with invalid token
       [2m[90mâ†“[39m[22m should allow PUT with valid Bearer token
       [2m[90mâ†“[39m[22m should reject PUT without Bearer token
       [2m[90mâ†“[39m[22m should allow DELETE with valid Bearer token
       [2m[90mâ†“[39m[22m should reject DELETE without Bearer token
       [2m[90mâ†“[39m[22m should allow PATCH with valid Bearer token
       [2m[90mâ†“[39m[22m should reject PATCH without Bearer token
       [2m[90mâ†“[39m[22m should handle Bearer token with extra spaces
       [2m[90mâ†“[39m[22m should handle token with newlines
       [2m[90mâ†“[39m[22m should handle very long invalid token
       [2m[90mâ†“[39m[22m should handle empty Authorization header
       [2m[90mâ†“[39m[22m should handle Authorization header with only Bearer
       [2m[90mâ†“[39m[22m should handle multiple Authorization headers
       [2m[90mâ†“[39m[22m should reject token with SQL injection attempt
       [2m[90mâ†“[39m[22m should reject token with XSS attempt
       [2m[90mâ†“[39m[22m should reject token with missing userId
       [2m[90mâ†“[39m[22m should reject token with non-existent userId
       [2m[90mâ†“[39m[22m should not allow user to access another user's resources
       [2m[90mâ†“[39m[22m should inject userId into request context
       [2m[90mâ†“[39m[22m should inject tenantId into request context
       [2m[90mâ†“[39m[22m should inject role into request context
       [2m[90mâ†“[39m[22m should not apply general rate limiting to authenticated requests
       [2m[90mâ†“[39m[22m should handle request with both Bearer token and cookies
       [2m[90mâ†“[39m[22m should prioritize Bearer token over cookie when both present
       [2m[90mâ†“[39m[22m should allow unauthenticated access to optional auth routes
       [2m[90mâ†“[39m[22m should enhance optional auth routes with user context when authenticated
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for d5849716d1c7535cc039f696d83d9622

{"level":50,"time":1768708796579,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["4onlmpC6i8uhdAYnoYtAa","$2b$12$dK8g7GimY97KqQRASPLil.x36etLipKt7kfCXsCi7Os0aUGRI5LQy"],"cause":{"length":332,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(4onlmpC6i8uhdAYnoYtAa) is not present in table \"users\".","schema":"test_schema_w15_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"4onlmpC6i8uhdAYnoYtAa","msg":"Failed to create user credentials"}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mDatabase Transfer[2m > [22m[2mshould allow org member to transfer org database
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,17efca34-c101-4162-b24f-c3a32c9809ff,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'17efca34-c101-4162-b24f-c3a32c9809ff'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m522[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (cd619f0e-abd7-4086-a687-df70e419a675, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 17efca34-c101-4162-b24f-c3a32c9809ff, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 03:59:57.646926, 2026-01-18 03:59:57.646926).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w6_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject invalid token
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,9cae2529-0875-4729-b423-3f19ca16c63b,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'9cae2529-0875-4729-b423-3f19ca16c63b'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m520[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (396bc753-2c30-42a7-91c9-bd73b3b5e86c, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, 9cae2529-0875-4729-b423-3f19ca16c63b, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-18 03:59:57.900401, 2026-01-18 03:59:57.900401).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w2_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":50,"time":1768708796904,"env":"test","module":"auth-routes","email":"test-1768708796182-eys6e@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768708797024,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould login with valid backup code
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768708797030,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768708797499,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["PAyaNlKnM8Sd58BR3h6SN","$2b$12$qI9n9WV1iX4rb3eM0iQc2.wWOrL/m3Xnkbw9gCp2XxoPZYlrL/MJC"],"cause":{"length":331,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(PAyaNlKnM8Sd58BR3h6SN) is not present in table \"users\".","schema":"test_schema_w4_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"PAyaNlKnM8Sd58BR3h6SN","msg":"Failed to create user credentials"}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w16_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w16_v3 (Reused: true)

{"level":50,"time":1768708797695,"env":"test","module":"auth-routes","email":"test-1768708796952-98gdf6@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768708797814,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould rotate refresh token on each use
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mðŸ“Š Schema test_schema_w16_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708798026,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708798027,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w16_v3\",public"}
{"level":30,"time":1768708798053,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w16_v3\",public"}
{"level":30,"time":1768708798053,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mDatabase Transfer[2m > [22m[2mshould prevent transfer to org if user is not a member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,cb2d21cb-6641-4900-948e-cc143d8a3acf,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'cb2d21cb-6641-4900-948e-cc143d8a3acf'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m523[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (f3754645-a51d-410c-9e4a-bae3f7258d32, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, cb2d21cb-6641-4900-948e-cc143d8a3acf, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 03:59:59.069331, 2026-01-18 03:59:59.069331).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w11_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":50,"time":1768708798882,"env":"test","module":"auth-routes","email":"test-1768708798456-kbq8qf@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":30,"time":1768708798895,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708798896,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708798971,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708798972,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mTransfer Validation[2m > [22m[2mshould only allow transfer to self when targetOwnerType is user
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,1e8725d0-f5d0-4305-b354-53b7118e2e57,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'1e8725d0-f5d0-4305-b354-53b7118e2e57'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m523[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (d51de6fc-75db-4f5d-8d71-cac04473a714, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 1e8725d0-f5d0-4305-b354-53b7118e2e57, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 03:59:59.981827, 2026-01-18 03:59:59.981827).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w11_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":50,"time":1768708799000,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould detect and prevent refresh token reuse (token theft)
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

 [31mâ¯[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m13 failed[39m[2m)[22m[33m 12567[2mms[22m[39m
[31m       [31mÃ—[31m should trust current device[39m[33m 324[2mms[22m[39m
[31m       [31mÃ—[31m should set trust expiry to 30 days[39m[33m 641[2mms[22m[39m
[31m       [31mÃ—[31m should update expiry if device already trusted[39m[33m 640[2mms[22m[39m
       [32mâœ“[39m should require authentication[32m 25[2mms[22m[39m
[31m       [31mÃ—[31m should list all trusted devices[39m[33m 780[2mms[22m[39m
[31m       [31mÃ—[31m should mark current device[39m[33m 769[2mms[22m[39m
[31m       [31mÃ—[31m should exclude revoked devices[39m[33m 642[2mms[22m[39m
[31m       [31mÃ—[31m should exclude expired devices[39m[33m 1167[2mms[22m[39m
[31m       [31mÃ—[31m should revoke specific device[39m[33m 745[2mms[22m[39m
[31m       [31mÃ—[31m should return 404 for non-existent device[39m[33m 637[2mms[22m[39m
[31m       [31mÃ—[31m should prevent revoking other user's device[39m[33m 1111[2mms[22m[39m
[31m       [31mÃ—[31m should skip MFA for trusted device[39m[33m 738[2mms[22m[39m
[31m       [31mÃ—[31m should require MFA for untrusted device[39m[33m 642[2mms[22m[39m
[31m       [31mÃ—[31m should update lastUsedAt on trusted device login[39m[33m 773[2mms[22m[39m
 [31mâ¯[39m tests/unit/engine/templateNode.test.ts [2m([22m[2m17 tests[22m[2m | [22m[31m17 failed[39m[2m)[22m[33m 14722[2mms[22m[39m
[31m       [31mÃ—[31m should resolve template by key from workflowTemplates mapping[39m[33m 562[2mms[22m[39m
[31m       [31mÃ—[31m should throw error if template key not found[39m[33m 557[2mms[22m[39m
[31m       [31mÃ—[31m should store output in runOutputs table[39m[33m 570[2mms[22m[39m
[31m       [31mÃ—[31m should resolve template by templateId directly[39m[33m 532[2mms[22m[39m
[31m       [31mÃ—[31m should throw error if templateId not found[39m[33m 502[2mms[22m[39m
[31m       [31mÃ—[31m should use docxRenderer2 by default (v2 engine)[39m[33m 503[2mms[22m[39m
[31m       [31mÃ—[31m should use legacy engine when engine="legacy"[39m[33m 550[2mms[22m[39m
[31m       [31mÃ—[31m should generate PDF when toPdf=true[39m[33m 591[2mms[22m[39m
[31m       [31mÃ—[31m should default to DOCX when toPdf=false[39m[33m 575[2mms[22m[39m
[31m       [31mÃ—[31m should skip execution when condition evaluates to false[39m[33m 544[2mms[22m[39m
[31m       [31mÃ—[31m should execute when condition evaluates to true[39m[33m 566[2mms[22m[39m
[31m       [31mÃ—[31m should resolve simple bindings[39m[33m 524[2mms[22m[39m
[31m       [31mÃ—[31m should handle binding resolution errors gracefully[39m[33m 1077[2mms[22m[39m
[31m       [31mÃ—[31m should record failed output in runOutputs table[39m[33m 2062[2mms[22m[39m
[31m       [31mÃ—[31m should not throw errors (should return error in result)[39m[33m 533[2mms[22m[39m
[31m       [31mÃ—[31m should deny access to templates from different tenant[39m[33m 1057[2mms[22m[39m
[31m       [31mÃ—[31m should require either templateKey or templateId[39m[33m 526[2mms[22m[39m
{"level":30,"time":1768708799180,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708799181,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/unit/services/WorkflowTemplateService.test.ts [2m([22m[2m21 tests[22m[2m | [22m[31m21 failed[39m[2m)[22m[33m 15262[2mms[22m[39m
[31m       [31mÃ—[31m should throw error if template belongs to different project[39m[33m 556[2mms[22m[39m
[31m       [31mÃ—[31m should automatically unset other primaries when setting new primary[39m[33m 673[2mms[22m[39m
[31m         [31mÃ—[31m should list all templates for workflow version[39m[33m 509[2mms[22m[39m
[31m         [31mÃ—[31m should return empty array for version with no templates[39m[33m 530[2mms[22m[39m
[31m         [31mÃ—[31m should get template mapping by id and version[39m[33m 522[2mms[22m[39m
[31m         [31mÃ—[31m should throw error if mapping not found[39m[33m 509[2mms[22m[39m
[31m         [31mÃ—[31m should get template by key[39m[33m 522[2mms[22m[39m
[31m         [31mÃ—[31m should throw error if key not found[39m[33m 617[2mms[22m[39m
[31m         [31mÃ—[31m should get primary template for workflow version[39m[33m 534[2mms[22m[39m
[31m         [31mÃ—[31m should return null when no primary template exists[39m[33m 578[2mms[22m[39m
[31m         [31mÃ—[31m should update mapping key[39m[33m 535[2mms[22m[39m
[31m         [31mÃ—[31m should update isPrimary flag[39m[33m 533[2mms[22m[39m
[31m         [31mÃ—[31m should throw error if new key already exists[39m[33m 497[2mms[22m[39m
[31m         [31mÃ—[31m should throw error if mapping not found[39m[33m 623[2mms[22m[39m
[31m         [31mÃ—[31m should unset other primaries when setting isPrimary to true[39m[33m 1076[2mms[22m[39m
[31m         [31mÃ—[31m should detach template from workflow version[39m[33m 518[2mms[22m[39m
[31m         [31mÃ—[31m should throw error if mapping not found[39m[33m 503[2mms[22m[39m
[31m         [31mÃ—[31m should set template as primary[39m[33m 524[2mms[22m[39m
[31m         [31mÃ—[31m should throw error if mapping not found[39m[33m 793[2mms[22m[39m
[31m         [31mÃ—[31m should support operations within a transaction[39m[33m 793[2mms[22m[39m
[31m         [31mÃ—[31m should rollback on transaction error[39m[33m 526[2mms[22m[39m
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w16_v3, public
âœ… Enforced search_path: test_schema_w16_v3, public

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w7_v3
âœ… Current search_path: test_schema_w1_v3, public
â© Schema reused, skipping migrations.

{"level":50,"time":1768708799554,"env":"test","module":"auth-routes","email":"test-1768708797303-nph9gf@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

{"level":50,"time":1768708799688,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking current session
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mTransfer Validation[2m > [22m[2mshould allow transfer from user to self (org member transferring org asset to themselves)
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,99a8e013-465b-4081-850d-518d78f47db0,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'99a8e013-465b-4081-850d-518d78f47db0'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m520[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (25bc65f5-d19f-47f6-957f-a5e63b5beae9, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 99a8e013-465b-4081-850d-518d78f47db0, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 04:00:00.92361, 2026-01-18 04:00:00.92361).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w6_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708800112,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708800113,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708800163,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708800164,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [31mâ¯[39m tests/integration/transferOwnership.test.ts [2m([22m[2m11 tests[22m[2m | [22m[31m11 failed[39m[2m)[22m[33m 15698[2mms[22m[39m
[31m       [31mÃ—[31m should transfer user-owned project to org[39m[33m 913[2mms[22m[39m
[31m       [31mÃ—[31m should prevent transfer to org if user is not a member[39m[33m 896[2mms[22m[39m
[31m       [31mÃ—[31m should allow org member to transfer org-owned project to another org they belong to[39m[33m 925[2mms[22m[39m
[31m       [31mÃ—[31m should detach workflow from project when transferring to different owner[39m[33m 937[2mms[22m[39m
[31m       [31mÃ—[31m should keep workflow in project when transferring to same owner[39m[33m 898[2mms[22m[39m
[31m       [31mÃ—[31m should prevent non-member from transferring org workflow[39m[33m 1628[2mms[22m[39m
[31m       [31mÃ—[31m should transfer database ownership[39m[33m 2467[2mms[22m[39m
[31m       [31mÃ—[31m should allow org member to transfer org database[39m[33m 897[2mms[22m[39m
[31m       [31mÃ—[31m should prevent transfer to org if user is not a member[39m[33m 1415[2mms[22m[39m
[31m       [31mÃ—[31m should only allow transfer to self when targetOwnerType is user[39m[33m 946[2mms[22m[39m
[31m       [31mÃ—[31m should allow transfer from user to self (org member transferring org asset to themselves)[39m[33m 915[2mms[22m[39m
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

 [31mâ¯[39m tests/unit/services/PdfQueueService.test.ts [2m([22m[2m15 tests[22m[2m | [22m[31m15 failed[39m[2m)[22m[33m 16117[2mms[22m[39m
[31m       [31mÃ—[31m should enqueue a PDF conversion job[39m[33m 901[2mms[22m[39m
[31m       [31mÃ—[31m should create output with empty storagePath initially[39m[33m 693[2mms[22m[39m
[31m       [31mÃ—[31m should return job status for pending job[39m[33m 754[2mms[22m[39m
[31m       [31mÃ—[31m should return null for non-existent job[39m[33m 714[2mms[22m[39m
[31m       [31mÃ—[31m should parse attempt count from error field[39m[33m 733[2mms[22m[39m
[31m       [31mÃ—[31m should convert DOCX to PDF immediately[39m[33m 795[2mms[22m[39m
[31m       [31mÃ—[31m should handle conversion errors gracefully[39m[33m 766[2mms[22m[39m
[31m       [31mÃ—[31m should start and stop service[39m[33m 749[2mms[22m[39m
[31m       [31mÃ—[31m should not start if already running[39m[33m 717[2mms[22m[39m
[31m       [31mÃ—[31m should handle stop when not running[39m[33m 987[2mms[22m[39m
[31m       [31mÃ—[31m should process pending jobs when queue is processed[39m[33m 747[2mms[22m[39m
[31m       [31mÃ—[31m should process multiple jobs in batch[39m[33m 972[2mms[22m[39m
[31m       [31mÃ—[31m should handle missing DOCX output gracefully[39m[33m 694[2mms[22m[39m
[31m       [31mÃ—[31m should support enqueue within transaction[39m[33m 697[2mms[22m[39m
[31m       [31mÃ—[31m should support convertImmediate within transaction[39m[33m 2349[2mms[22m[39m
 [31mâ¯[39m tests/integration/organizationInvites.test.ts [2m([22m[2m17 tests[22m[2m | [22m[31m16 failed[39m[2m)[22m[33m 16084[2mms[22m[39m
[31m       [31mÃ—[31m should create placeholder user for non-existent email[39m[33m 1189[2mms[22m[39m
[31m       [31mÃ—[31m should create invite for existing user without creating placeholder[39m[33m 703[2mms[22m[39m
[31m       [31mÃ—[31m should prevent duplicate pending invites[39m[33m 721[2mms[22m[39m
[31m       [31mÃ—[31m should prevent inviting existing members[39m[33m 709[2mms[22m[39m
[31m       [31mÃ—[31m should require admin access to create invite[39m[33m 763[2mms[22m[39m
[31m       [31mÃ—[31m should set expiry to 7 days from now[39m[33m 1138[2mms[22m[39m
[31m       [31mÃ—[31m should accept invite and create membership[39m[33m 414[2mms[22m[39m
[31m       [31mÃ—[31m should convert placeholder user to real user on accept[39m[33m 699[2mms[22m[39m
[31m       [31mÃ—[31m should reject expired invite[39m[33m 1067[2mms[22m[39m
[31m       [31mÃ—[31m should reject already accepted invite[39m[33m 1108[2mms[22m[39m
[31m       [31mÃ—[31m should verify email matches invite[39m[33m 701[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject invalid token [33m 1056[2mms[22m[39m
[31m       [31mÃ—[31m should return pending invites for user email[39m[33m 700[2mms[22m[39m
[31m       [31mÃ—[31m should not return expired invites[39m[33m 727[2mms[22m[39m
[31m       [31mÃ—[31m should not return accepted invites[39m[33m 704[2mms[22m[39m
[31m       [31mÃ—[31m should allow admin to revoke invite[39m[33m 436[2mms[22m[39m
[31m       [31mÃ—[31m should prevent accepting revoked invite[39m[33m 420[2mms[22m[39m
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

{"level":30,"time":1768708800499,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708800500,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708800567,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708800567,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/auth/oauth2.sessions.test.ts [2m([22m[2m25 tests[22m[2m | [22m[31m25 failed[39m[2m)[22m[33m 14181[2mms[22m[39m
[31m       [31mÃ—[31m should list all active sessions for current user[39m[32m 56[2mms[22m[39m
[31m       [31mÃ—[31m should mark current session as current[39m[33m 375[2mms[22m[39m
[31m       [31mÃ—[31m should return empty array when user has no active sessions[39m[33m 381[2mms[22m[39m
[31m       [31mÃ—[31m should not include expired sessions[39m[33m 378[2mms[22m[39m
[31m       [31mÃ—[31m should not include revoked sessions[39m[33m 386[2mms[22m[39m
[31m       [31mÃ—[31m should parse device name from user agent[39m[33m 384[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 for unauthenticated request[39m[33m 373[2mms[22m[39m
[31m       [31mÃ—[31m should revoke a specific session[39m[33m 382[2mms[22m[39m
[31m       [31mÃ—[31m should return 404 for non-existent session[39m[33m 387[2mms[22m[39m
[31m       [31mÃ—[31m should prevent revoking current session[39m[33m 380[2mms[22m[39m
[31m       [31mÃ—[31m should prevent revoking another user's session[39m[33m 630[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 for unauthenticated request[39m[33m 654[2mms[22m[39m
[31m       [31mÃ—[31m should revoke all sessions except current[39m[33m 389[2mms[22m[39m
[31m       [31mÃ—[31m should revoke all trusted devices[39m[33m 384[2mms[22m[39m
[31m       [31mÃ—[31m should return 400 when no active session found[39m[33m 383[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 for unauthenticated request[39m[33m 1881[2mms[22m[39m
[31m         [31mÃ—[31m should mark current device as trusted[39m[33m 387[2mms[22m[39m
[31m         [31mÃ—[31m should update existing trusted device expiry[39m[33m 373[2mms[22m[39m
[31m         [31mÃ—[31m should list all trusted devices[39m[33m 370[2mms[22m[39m
[31m         [31mÃ—[31m should not include revoked devices[39m[33m 381[2mms[22m[39m
[31m         [31mÃ—[31m should revoke a trusted device[39m[33m 373[2mms[22m[39m
[31m         [31mÃ—[31m should return 404 for non-existent device[39m[33m 381[2mms[22m[39m
[31m       [31mÃ—[31m should track IP address for sessions[39m[33m 391[2mms[22m[39m
[31m       [31mÃ—[31m should track user agent for sessions[39m[33m 373[2mms[22m[39m
[31m       [31mÃ—[31m should update lastUsedAt on token refresh[39m[33m 375[2mms[22m[39m
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

 [31mâ¯[39m tests/integration/auth.flows.real.test.ts [2m([22m[2m11 tests[22m[2m | [22m[31m11 failed[39m[2m)[22m[33m 14237[2mms[22m[39m
[31m       [31mÃ—[31m should complete registration, verify email, then login[39m[33m 419[2mms[22m[39m
[31m       [31mÃ—[31m should lock account after 5 failed attempts, then unlock after waiting[39m[33m 2271[2mms[22m[39m
[31m       [31mÃ—[31m should record all login attempts[39m[33m 328[2mms[22m[39m
[31m       [31mÃ—[31m should complete MFA setup and login with TOTP[39m[33m 692[2mms[22m[39m
[31m       [31mÃ—[31m should login with backup code when TOTP unavailable[39m[33m 657[2mms[22m[39m
[31m       [31mÃ—[31m should complete full password reset flow[39m[33m 2896[2mms[22m[39m
[31m       [31mÃ—[31m should invalidate all sessions after password reset[39m[33m 394[2mms[22m[39m
[31m       [31mÃ—[31m should rotate refresh token on each use[39m[33m 1504[2mms[22m[39m
[31m       [31mÃ—[31m should detect and prevent refresh token reuse (token theft)[39m[33m 1104[2mms[22m[39m
[31m       [31mÃ—[31m should list all active sessions[39m[33m 331[2mms[22m[39m
[31m       [31mÃ—[31m should revoke specific session[39m[33m 676[2mms[22m[39m
{"level":50,"time":1768708800706,"env":"test","module":"auth-routes","email":"test-1768708800272-opklqi@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mcreateOrganization[2m > [22m[2mshould create organization and auto-create admin membership
[22m[39mCRITICAL: User lookup failed validation in beforeEach: [90mundefined[39m

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w17_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w17_v3 (Reused: true)

{"level":50,"time":1768708800814,"env":"test","module":"auth-routes","error":{"query":"insert into \"password_reset_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"used\", \"created_at\") values (default, $1, $2, $3, $4, default)","params":["6068217101477cd760e634ec3dfa9ccc","0d3e0e9b5297dc2c032eb396c63bae6b62ec4910a493450fcea5627ad7b27eab","2026-01-18T05:00:00.610Z",false],"cause":{"length":362,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(6068217101477cd760e634ec3dfa9ccc) is not present in table \"users\".","schema":"test_schema_w9_v3","table":"password_reset_tokens","constraint":"password_reset_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Forgot password error"}
{"level":50,"time":1768708800826,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould return 404 for non-existent session
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768708800835,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mðŸ“Š Schema test_schema_w17_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708801224,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708801225,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w17_v3\",public"}
{"level":30,"time":1768708801278,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w17_v3\",public"}
{"level":30,"time":1768708801278,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w19_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w19_v3 (Reused: true)

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w24_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w24_v3 (Reused: true)

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w20_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708802013,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708802014,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w20_v3 (Reused: true)

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w17_v3, public
âœ… Enforced search_path: test_schema_w17_v3, public

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mðŸ“Š Schema test_schema_w19_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708802079,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708802080,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w19_v3\",public"}
 [31mâ¯[39m tests/integration/auth/oauth2.token-refresh.test.ts [2m([22m[2m25 tests[22m[2m | [22m[31m25 failed[39m[2m)[22m[33m 15696[2mms[22m[39m
[31m       [31mÃ—[31m should refresh access token with valid refresh token[39m[32m 52[2mms[22m[39m
[31m       [31mÃ—[31m should rotate refresh token after use[39m[33m 374[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 when refresh token is missing[39m[33m 385[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 for invalid refresh token[39m[33m 384[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 for expired refresh token[39m[33m 367[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 for revoked refresh token[39m[33m 401[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 when user is not found[39m[33m 382[2mms[22m[39m
[31m       [31mÃ—[31m should update refresh token metadata on rotation[39m[33m 380[2mms[22m[39m
[31m       [31mÃ—[31m should handle concurrent refresh token requests (token reuse detection)[39m[33m 385[2mms[22m[39m
[31m       [31mÃ—[31m should set secure cookie in production[39m[33m 380[2mms[22m[39m
[31m       [31mÃ—[31m should set proper cookie attributes[39m[33m 378[2mms[22m[39m
[31m       [31mÃ—[31m should include user role information in response[39m[33m 368[2mms[22m[39m
[31m       [31mÃ—[31m should create refresh token on login[39m[33m 388[2mms[22m[39m
[31m       [31mÃ—[31m should revoke refresh token on logout[39m[33m 374[2mms[22m[39m
[31m       [31mÃ—[31m should handle logout without refresh token gracefully[39m[33m 673[2mms[22m[39m
[31m       [31mÃ—[31m should support multiple active refresh tokens per user[39m[33m 648[2mms[22m[39m
[31m       [31mÃ—[31m should revoke all user tokens on password reset[39m[33m 375[2mms[22m[39m
[31m       [31mÃ—[31m should use cryptographically strong random tokens[39m[33m 632[2mms[22m[39m
[31m       [31mÃ—[31m should hash refresh tokens before storing in database[39m[33m 920[2mms[22m[39m
[31m       [31mÃ—[31m should prevent refresh token reuse after rotation[39m[33m 629[2mms[22m[39m
[31m       [31mÃ—[31m should validate token ownership[39m[33m 1883[2mms[22m[39m
[31m       [31mÃ—[31m should set HttpOnly flag to prevent XSS[39m[33m 398[2mms[22m[39m
[31m       [31mÃ—[31m should set SameSite=Strict to prevent CSRF[39m[33m 398[2mms[22m[39m
[31m       [31mÃ—[31m should set proper cookie path[39m[33m 389[2mms[22m[39m
[31m       [31mÃ—[31m should set appropriate expiry (30 days)[39m[33m 382[2mms[22m[39m
{"level":30,"time":1768708802126,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w19_v3\",public"}
{"level":30,"time":1768708802126,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w8_v3
âœ… Current search_path: test_schema_w5_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mðŸ“Š Schema test_schema_w24_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w21_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mðŸ“Š Schema test_schema_w20_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708802456,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w21_v3 (Reused: true)

{"level":30,"time":1768708802457,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w20_v3\",public"}
{"level":30,"time":1768708802505,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w20_v3\",public"}
{"level":30,"time":1768708802505,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w22_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w22_v3 (Reused: true)

{"level":30,"time":1768708802803,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708802803,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/ownershipAccess.test.ts [2m([22m[2m19 tests[22m[2m | [22m[31m3 failed[39m[2m)[22m[33m 9633[2mms[22m[39m
       [32mâœ“[39m should allow access to user-owned asset by owner[32m 193[2mms[22m[39m
       [32mâœ“[39m should deny access to user-owned asset by non-owner[32m 189[2mms[22m[39m
       [32mâœ“[39m should allow access to org-owned asset by org member[32m 290[2mms[22m[39m
       [32mâœ“[39m should deny access to org-owned asset by non-member[32m 234[2mms[22m[39m
       [32mâœ“[39m should allow access to null ownership (legacy data)[32m 192[2mms[22m[39m
       [32mâœ“[39m should return true for org member[32m 286[2mms[22m[39m
       [32mâœ“[39m should return false for non-member[32m 239[2mms[22m[39m
[31m       [31mÃ—[31m should return true for org admin[39m[33m 325[2mms[22m[39m
[31m       [31mÃ—[31m should return true for org admin[39m[33m 580[2mms[22m[39m
       [32mâœ“[39m should return false for org member (non-admin)[32m 281[2mms[22m[39m
       [32mâœ“[39m should return false for non-member[32m 240[2mms[22m[39m
[31m       [31mÃ—[31m should return all org IDs for a user[39m[33m 609[2mms[22m[39m
       [32mâœ“[39m should return empty array for user with no memberships[32m 238[2mms[22m[39m
       [32mâœ“[39m should allow creating user-owned asset if ownerUuid matches userId[32m 185[2mms[22m[39m
       [32mâœ“[39m should deny creating user-owned asset if ownerUuid does not match userId[32m 192[2mms[22m[39m
       [33m[2mâœ“[22m[39m should allow creating org-owned asset if user is member [33m 335[2mms[22m[39m
       [32mâœ“[39m should deny creating org-owned asset if user is not member[32m 235[2mms[22m[39m
       [32mâœ“[39m should not allow member of org1 to access org2-owned assets[32m 297[2mms[22m[39m
       [33m[2mâœ“[22m[39m should allow member of multiple orgs to access all their org assets [33m 391[2mms[22m[39m
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mðŸ“Š Schema test_schema_w21_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708802872,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708802874,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w21_v3\",public"}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w19_v3, public
âœ… Enforced search_path: test_schema_w19_v3, public

{"level":30,"time":1768708802922,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w21_v3\",public"}
{"level":30,"time":1768708802922,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708802950,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708802951,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w24_v3\",public"}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w20_v3
âœ… Current search_path: test_schema_w16_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mDEBUG: Existing functions: []

{"level":30,"time":1768708803003,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w24_v3\",public"}
{"level":30,"time":1768708803003,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mðŸ“Š Schema test_schema_w22_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708803199,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708803200,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w22_v3\",public"}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708803247,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w22_v3\",public"}
{"level":30,"time":1768708803247,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w20_v3, public
âœ… Enforced search_path: test_schema_w20_v3, public

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w21_v3
âœ… Current search_path: test_schema_w21_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708803412,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708803413,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/unit/repositories/WorkflowTemplateRepository.test.ts [2m([22m[2m19 tests[22m[2m | [22m[31m19 failed[39m[2m)[22m[33m 19680[2mms[22m[39m
[31m       [31mÃ—[31m should create a workflow template mapping[39m[33m 785[2mms[22m[39m
[31m       [31mÃ—[31m should create non-primary mapping by default[39m[33m 756[2mms[22m[39m
[31m       [31mÃ—[31m should find all templates for a workflow version[39m[33m 762[2mms[22m[39m
[31m       [31mÃ—[31m should return empty array for version with no templates[39m[33m 657[2mms[22m[39m
[31m       [31mÃ—[31m should order by createdAt desc (newest first)[39m[33m 774[2mms[22m[39m
[31m       [31mÃ—[31m should find mapping by workflow version and key[39m[33m 655[2mms[22m[39m
[31m       [31mÃ—[31m should return undefined for non-existent key[39m[33m 654[2mms[22m[39m
[31m       [31mÃ—[31m should find primary template for workflow version[39m[33m 663[2mms[22m[39m
[31m       [31mÃ—[31m should return undefined when no primary template exists[39m[33m 740[2mms[22m[39m
[31m       [31mÃ—[31m should set a template as primary and unset others[39m[33m 2225[2mms[22m[39m
[31m       [31mÃ—[31m should handle setting primary when none existed before[39m[33m 955[2mms[22m[39m
[31m       [31mÃ—[31m should not delete mapping if workflow version does not match[39m[33m 655[2mms[22m[39m
[31m       [31mÃ—[31m should return true if key exists in workflow version[39m[33m 1676[2mms[22m[39m
[31m       [31mÃ—[31m should return false if key does not exist[39m[33m 1259[2mms[22m[39m
[31m       [31mÃ—[31m should exclude specified id when checking existence[39m[33m 717[2mms[22m[39m
[31m       [31mÃ—[31m should return true if key exists on different mapping[39m[33m 701[2mms[22m[39m
[31m       [31mÃ—[31m should update mapping fields[39m[33m 704[2mms[22m[39m
[31m       [31mÃ—[31m should find mapping by id[39m[33m 731[2mms[22m[39m
[31m       [31mÃ—[31m should return undefined for non-existent id[39m[33m 690[2mms[22m[39m
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w23_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w23_v3 (Reused: true)

{"level":50,"time":1768708803623,"env":"test","module":"auth-routes","email":"test-1768708802884-c31jic@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768708803671,"env":"test","module":"auth-routes","email":"test-1768708802906-4g02sc@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w21_v3, public
âœ… Enforced search_path: test_schema_w21_v3, public

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w25_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":50,"time":1768708803747,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w25_v3 (Reused: true)

[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mGET /api/auth/me[2m > [22m[2mshould return current user for valid token
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768708803754,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w24_v3, public
âœ… Enforced search_path: test_schema_w24_v3, public

{"level":50,"time":1768708803766,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Regeneration[2m > [22m[2mshould return error if MFA not enabled
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768708803773,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w22_v3
âœ… Current search_path: test_schema_w22_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w24_v3
âœ… Current search_path: test_schema_w24_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mðŸ“Š Schema test_schema_w23_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708803961,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708803962,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w23_v3\",public"}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w22_v3, public
âœ… Enforced search_path: test_schema_w22_v3, public

{"level":30,"time":1768708804015,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w23_v3\",public"}
{"level":30,"time":1768708804015,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w17_v3
âœ… Current search_path: test_schema_w17_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mðŸ“Š Schema test_schema_w25_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708804154,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708804155,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w25_v3\",public"}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mDEBUG: Existing functions: []

{"level":30,"time":1768708804189,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w25_v3\",public"}
{"level":30,"time":1768708804189,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768708804257,"env":"test","module":"auth-routes","email":"test-1768708803472-6prouk@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":30,"time":1768708804288,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":50,"time":1768708804333,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768708804340,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768708804348,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708804349,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768708804378,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould keep current session active
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

 [31mâ¯[39m tests/integration/organizations-audit-fixes.test.ts [2m([22m[2m8 tests[22m[2m | [22m[33m8 skipped[39m[2m)[22m[33m 3963[2mms[22m[39m
       [2m[90mâ†“[39m[22m should cascade ownership to workflow runs when project is transferred
       [2m[90mâ†“[39m[22m should prevent double-acceptance via transaction
       [2m[90mâ†“[39m[22m should not create invite if email fails
       [2m[90mâ†“[39m[22m should allow re-invite after invite expires
       [2m[90mâ†“[39m[22m should allow last admin to delete empty organization
       [2m[90mâ†“[39m[22m should prevent deletion if org owns assets
       [2m[90mâ†“[39m[22m should cleanup placeholder user when invite is revoked
       [2m[90mâ†“[39m[22m should fail fast on non-existent org
{"level":50,"time":1768708804396,"env":"test","module":"auth","err":{"type":"DrizzleQueryError","message":"Failed query: insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"\nparams: google-user-123,testuser@example.com,Test,User,https://example.com/avatar.jpg,c1fae634-e2d2-4ba9-8dde-980f91c89694,viewer,google,easy,true,,Test,User,https://example.com/avatar.jpg,2026-01-18T04:00:04.344Z: insert or update on table \"users\" violates foreign key constraint \"users_tenant_id_tenants_id_fk\"","stack":"Error: Failed query: insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"\nparams: google-user-123,testuser@example.com,Test,User,https://example.com/avatar.jpg,c1fae634-e2d2-4ba9-8dde-980f91c89694,viewer,google,easy,true,,Test,User,https://example.com/avatar.jpg,2026-01-18T04:00:04.344Z\n    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22\n    at UserRepository.upsert (C:/Users/scoot/poll/VaultLogic/server/repositories/UserRepository.ts:72:22)\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:69:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7\ncaused by: error: insert or update on table \"users\" violates foreign key constraint \"users_tenant_id_tenants_id_fk\"\n    at C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\pg-pool\\index.js:45:11\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18\n    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22\n    at UserRepository.upsert (C:/Users/scoot/poll/VaultLogic/server/repositories/UserRepository.ts:72:22)\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:69:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7","query":"insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"","params":["google-user-123","testuser@example.com","Test","User","https://example.com/avatar.jpg","c1fae634-e2d2-4ba9-8dde-980f91c89694","viewer","google","easy",true,null,"Test","User","https://example.com/avatar.jpg","2026-01-18T04:00:04.344Z"]},"userId":"google-user-123","msg":"Failed to upsert user during authentication"}
{"level":50,"time":1768708804399,"env":"test","module":"auth","err":{"type":"Error","message":"Failed to create or update user account","stack":"Error: Failed to create or update user account\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:73:11)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"msg":"Google authentication failed"}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w26_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":50,"time":1768708804432,"env":"test","module":"auth-routes","email":"test-1768708803472-6prouk@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w26_v3 (Reused: true)

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":50,"time":1768708804582,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould keep current session active
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w23_v3, public
âœ… Enforced search_path: test_schema_w23_v3, public

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mðŸ“Š Schema test_schema_w26_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708804882,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708804882,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w26_v3\",public"}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w25_v3
âœ… Current search_path: test_schema_w22_v3, public
â© Schema reused, skipping migrations.

{"level":50,"time":1768708804899,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:168:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
{"level":50,"time":1768708804900,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:168:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google authentication failed"}
{"level":30,"time":1768708804928,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w26_v3\",public"}
{"level":30,"time":1768708804928,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w25_v3, public
âœ… Enforced search_path: test_schema_w25_v3, public

{"level":40,"time":1768708804954,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768708804954,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:158:23"},"msg":"Google token verification failed"}
{"level":50,"time":1768708804954,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:158:23"},"msg":"Google authentication failed"}
{"level":40,"time":1768708804962,"env":"test","module":"auth-middleware","path":"/test","msg":"No authorization token provided"}
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":50,"time":1768708804985,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768708804989,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768708804992,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768708804994,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768708804996,"env":"test","module":"auth-middleware","path":"/test","msg":"No authorization token provided"}
{"level":30,"time":1768708804997,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708804998,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w16_v3
âœ… Current search_path: test_schema_w25_v3, public
â© Schema reused, skipping migrations.

 [31mâ¯[39m tests/unit/middleware/auth.middleware.test.ts [2m([22m[2m22 tests[22m[2m | [22m[31m11 failed[39m[2m)[22m[33m 3589[2mms[22m[39m
       [32mâœ“[39m should authenticate with valid JWT token[32m 4[2mms[22m[39m
       [32mâœ“[39m should return 401 for missing token[32m 7[2mms[22m[39m
       [32mâœ“[39m should return 401 for invalid token[32m 1[2mms[22m[39m
       [32mâœ“[39m should return 401 for expired token[32m 1[2mms[22m[39m
       [32mâœ“[39m should extract token without Bearer prefix[32m 1[2mms[22m[39m
       [32mâœ“[39m should authenticate with valid token[32m 1[2mms[22m[39m
       [32mâœ“[39m should proceed without auth when no token provided[32m 0[2mms[22m[39m
       [32mâœ“[39m should proceed even with invalid token[32m 1[2mms[22m[39m
[31m       [31mÃ—[31m should authenticate with JWT Bearer token[39m[32m 8[2mms[22m[39m
[31m       [31mÃ—[31m should authenticate with refresh token cookie for GET requests[39m[32m 2[2mms[22m[39m
[31m       [31mÃ—[31m should reject cookie auth for POST requests[39m[32m 2[2mms[22m[39m
[31m       [31mÃ—[31m should prioritize JWT over cookie when both present[39m[32m 1[2mms[22m[39m
[31m       [31mÃ—[31m should allow cookie auth only for safe methods[39m[32m 1[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 when no auth provided[39m[32m 1[2mms[22m[39m
[31m       [31mÃ—[31m should authenticate with JWT[39m[32m 1[2mms[22m[39m
[31m       [31mÃ—[31m should authenticate with cookie for GET[39m[32m 1[2mms[22m[39m
[31m       [31mÃ—[31m should proceed without auth when none provided[39m[32m 1[2mms[22m[39m
[31m       [31mÃ—[31m should proceed even with invalid auth[39m[32m 1[2mms[22m[39m
       [32mâœ“[39m should not allow token tampering[32m 1[2mms[22m[39m
[31m       [31mÃ—[31m should not allow cookie auth for mutations (CSRF protection)[39m[32m 2[2mms[22m[39m
       [32mâœ“[39m should reject malformed JWT[32m 1[2mms[22m[39m
       [32mâœ“[39m should handle missing authorization header gracefully[32m 1[2mms[22m[39m
{"level":50,"time":1768708805043,"env":"test","module":"auth-routes","userId":"21bb5a41896a9daaa64e63e6a4c1d05e","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768708805121,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708805122,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mâœ… Applied failsafe schema fixes

 [31mâ¯[39m tests/integration/regression-REG-1.test.ts [2m([22m[2m8 tests[22m[2m | [22m[33m8 skipped[39m[2m)[22m[33m 3503[2mms[22m[39m
       [2m[90mâ†“[39m[22m should block Next when required visible question is empty
       [2m[90mâ†“[39m[22m should NOT block Next when required question is hidden
       [2m[90mâ†“[39m[22m should block when required becomes visible and is empty
       [2m[90mâ†“[39m[22m should skip hidden required page entirely
       [2m[90mâ†“[39m[22m should enforce required on visible page
       [2m[90mâ†“[39m[22m should evaluate visibility consistently across modes
       [2m[90mâ†“[39m[22m should handle malformed visibility expression gracefully
       [2m[90mâ†“[39m[22m should handle missing variable in visibility expression
{"level":50,"time":1768708805165,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mTenant-Level MFA Enforcement[2m > [22m[2mshould enforce MFA for tenant users when required by tenant
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:74:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

{"level":50,"time":1768708805615,"env":"test","module":"auth","err":{"type":"DrizzleQueryError","message":"Failed query: insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"\nparams: google-user-refresh,refresh@example.com,Refresh,Test,,164bf30f-4aff-48cc-b6ef-2c7be7d79b89,viewer,google,easy,true,,Refresh,Test,,2026-01-18T04:00:05.569Z: insert or update on table \"users\" violates foreign key constraint \"users_tenant_id_tenants_id_fk\"","stack":"Error: Failed query: insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"\nparams: google-user-refresh,refresh@example.com,Refresh,Test,,164bf30f-4aff-48cc-b6ef-2c7be7d79b89,viewer,google,easy,true,,Refresh,Test,,2026-01-18T04:00:05.569Z\n    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22\n    at UserRepository.upsert (C:/Users/scoot/poll/VaultLogic/server/repositories/UserRepository.ts:72:22)\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:69:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7\ncaused by: error: insert or update on table \"users\" violates foreign key constraint \"users_tenant_id_tenants_id_fk\"\n    at C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\pg-pool\\index.js:45:11\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18\n    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22\n    at UserRepository.upsert (C:/Users/scoot/poll/VaultLogic/server/repositories/UserRepository.ts:72:22)\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:69:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7","query":"insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"","params":["google-user-refresh","refresh@example.com","Refresh","Test",null,"164bf30f-4aff-48cc-b6ef-2c7be7d79b89","viewer","google","easy",true,null,"Refresh","Test",null,"2026-01-18T04:00:05.569Z"]},"userId":"google-user-refresh","msg":"Failed to upsert user during authentication"}
{"level":50,"time":1768708805616,"env":"test","module":"auth","err":{"type":"Error","message":"Failed to create or update user account","stack":"Error: Failed to create or update user account\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:73:11)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"msg":"Google authentication failed"}
{"level":50,"time":1768708805628,"env":"test","module":"auth-routes","email":"test-1768708805165-ipnbk@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w26_v3, public
âœ… Enforced search_path: test_schema_w26_v3, public

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708805746,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708805746,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w25_v3
âœ… Current search_path: test_schema_w25_v3, public
â© Schema reused, skipping migrations.

{"level":50,"time":1768708805783,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould return 400 if no active session found
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768708805790,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708805838,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708805839,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mremoveMember[2m > [22m[2mshould prevent self-removal
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000011,organization.create,organization,5c6a31c9-3a56-48ff-acf4-50ff13ebb93a,{"after":{"name":"Self Remove Test Int","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000011'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'5c6a31c9-3a56-48ff-acf4-50ff13ebb93a'[39m,
    [32m'{"after":{"name":"Self Remove Test Int","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:243:25
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m526[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (b9ed7a86-c74f-4c3f-914c-582a7b041b16, null, null, 00000000-0000-0000-0000-000000000011, organization.create, null, null, organization, 5c6a31c9-3a56-48ff-acf4-50ff13ebb93a, {"after": {"name": "Self Remove Test Int", "slug": null}}, null, null, null, 2026-01-18 04:00:06.855151, 2026-01-18 04:00:06.855151).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w23_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

 [31mâ¯[39m tests/integration/mfa.flow.real.test.ts [2m([22m[2m20 tests[22m[2m | [22m[31m20 failed[39m[2m)[22m[33m 19415[2mms[22m[39m
[31m       [31mÃ—[31m should complete full MFA setup flow[39m[33m 322[2mms[22m[39m
[31m       [31mÃ—[31m should reject invalid TOTP code during setup[39m[33m 664[2mms[22m[39m
[31m       [31mÃ—[31m should not allow MFA setup if already enabled[39m[33m 770[2mms[22m[39m
[31m       [31mÃ—[31m should generate unique backup codes[39m[33m 1495[2mms[22m[39m
[31m       [31mÃ—[31m should store hashed backup codes[39m[33m 1151[2mms[22m[39m
[31m       [31mÃ—[31m should require MFA for enabled users[39m[33m 445[2mms[22m[39m
[31m       [31mÃ—[31m should complete MFA login with valid TOTP[39m[33m 785[2mms[22m[39m
[31m       [31mÃ—[31m should reject invalid TOTP during login[39m[33m 639[2mms[22m[39m
[31m       [31mÃ—[31m should accept TOTP codes within 60-second window[39m[33m 650[2mms[22m[39m
[31m       [31mÃ—[31m should login with valid backup code[39m[33m 1453[2mms[22m[39m
[31m       [31mÃ—[31m should mark backup code as used[39m[33m 438[2mms[22m[39m
[31m       [31mÃ—[31m should prevent backup code reuse[39m[33m 654[2mms[22m[39m
[31m       [31mÃ—[31m should try TOTP before backup code[39m[33m 694[2mms[22m[39m
[31m       [31mÃ—[31m should return MFA status for user[39m[33m 639[2mms[22m[39m
[31m       [31mÃ—[31m should return backup codes count for MFA users[39m[33m 715[2mms[22m[39m
[31m       [31mÃ—[31m should disable MFA with password verification[39m[33m 813[2mms[22m[39m
[31m       [31mÃ—[31m should require correct password to disable MFA[39m[33m 676[2mms[22m[39m
[31m       [31mÃ—[31m should regenerate backup codes[39m[33m 643[2mms[22m[39m
[31m       [31mÃ—[31m should return error if MFA not enabled[39m[33m 1449[2mms[22m[39m
[31m       [31mÃ—[31m should enforce MFA for tenant users when required by tenant[39m[33m 1391[2mms[22m[39m
 [31mâ¯[39m tests/integration/auth.routes.real.test.ts [2m([22m[2m26 tests[22m[2m | [22m[31m18 failed[39m[2m)[22m[33m 19508[2mms[22m[39m
[31m       [31mÃ—[31m should register a new user successfully[39m[33m 426[2mms[22m[39m
       [32mâœ“[39m should return 400 for invalid email format[32m 6[2mms[22m[39m
       [32mâœ“[39m should return 400 for weak password[32m 12[2mms[22m[39m
[31m       [31mÃ—[31m should return 409 for duplicate email[39m[33m 1479[2mms[22m[39m
[31m       [31mÃ—[31m should set httpOnly refresh token cookie[39m[33m 704[2mms[22m[39m
[31m       [31mÃ—[31m should login with valid credentials[39m[33m 663[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 for invalid password[39m[33m 660[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 401 for non-existent user [33m 1015[2mms[22m[39m
[31m       [31mÃ—[31m should return 403 for unverified email[39m[33m 1368[2mms[22m[39m
[31m       [31mÃ—[31m should record failed login attempt[39m[33m 342[2mms[22m[39m
[31m       [31mÃ—[31m should return requiresMfa=true for MFA-enabled users[39m[33m 649[2mms[22m[39m
[31m       [31mÃ—[31m should lock account after 5 failed attempts[39m[33m 931[2mms[22m[39m
[31m       [31mÃ—[31m should logout and clear refresh token cookie[39m[33m 902[2mms[22m[39m
[31m       [31mÃ—[31m should refresh access token with valid refresh token[39m[33m 660[2mms[22m[39m
       [32mâœ“[39m should return 401 for missing refresh token[32m 6[2mms[22m[39m
[31m       [31mÃ—[31m should rotate refresh token after use[39m[33m 644[2mms[22m[39m
[31m       [31mÃ—[31m should send password reset email for existing user[39m[33m 1962[2mms[22m[39m
       [32mâœ“[39m should not reveal if email exists (security)[32m 55[2mms[22m[39m
[31m       [31mÃ—[31m should reset password with valid token[39m[33m 345[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 400 for invalid token [33m 391[2mms[22m[39m
[31m       [31mÃ—[31m should return 400 for weak new password[39m[33m 368[2mms[22m[39m
[31m       [31mÃ—[31m should return current user for valid token[39m[33m 1445[2mms[22m[39m
       [32mâœ“[39m should return 401 for missing token[32m 6[2mms[22m[39m
       [32mâœ“[39m should return 401 for invalid token[32m 7[2mms[22m[39m
[31m         [31mÃ—[31m should complete MFA login with valid TOTP code[39m[33m 515[2mms[22m[39m
[31m         [31mÃ—[31m should reject invalid MFA code[39m[33m 981[2mms[22m[39m
{"level":30,"time":1768708805994,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708805995,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/auth/oauth2.callback.test.ts [2m([22m[2m16 tests[22m[2m | [22m[33m16 skipped[39m[2m)[22m[33m 3623[2mms[22m[39m
       [2m[90mâ†“[39m[22m should initiate OAuth2 3-legged flow and generate authorization URL
       [2m[90mâ†“[39m[22m should include optional scope in authorization URL
       [2m[90mâ†“[39m[22m should validate valid OAuth2 state token
       [2m[90mâ†“[39m[22m should reject invalid OAuth2 state token
       [2m[90mâ†“[39m[22m should reject expired OAuth2 state token
       [2m[90mâ†“[39m[22m should clean up OAuth2 state after use
       [2m[90mâ†“[39m[22m should handle callback with missing state parameter
       [2m[90mâ†“[39m[22m should handle callback with missing code parameter
       [2m[90mâ†“[39m[22m should handle OAuth2 provider error responses
       [2m[90mâ†“[39m[22m should track OAuth2 connection status
       [2m[90mâ†“[39m[22m should store OAuth2 state in connection metadata
       [2m[90mâ†“[39m[22m should use cryptographically secure random state
       [2m[90mâ†“[39m[22m should prevent state reuse after validation
       [2m[90mâ†“[39m[22m should include PKCE support metadata in state record
       [2m[90mâ†“[39m[22m should validate redirect URI matches allowed URIs
       [2m[90mâ†“[39m[22m should encode redirect URI in authorization URL
{"level":50,"time":1768708806183,"env":"test","module":"auth","err":{"type":"DrizzleQueryError","message":"Failed query: insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"\nparams: google-user-idtoken,idtoken@example.com,,,,00000000-0000-0000-0000-000000000098,viewer,google,easy,true,,,,,2026-01-18T04:00:06.132Z: insert or update on table \"users\" violates foreign key constraint \"users_tenant_id_tenants_id_fk\"","stack":"Error: Failed query: insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"\nparams: google-user-idtoken,idtoken@example.com,,,,00000000-0000-0000-0000-000000000098,viewer,google,easy,true,,,,,2026-01-18T04:00:06.132Z\n    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22\n    at UserRepository.upsert (C:/Users/scoot/poll/VaultLogic/server/repositories/UserRepository.ts:72:22)\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:69:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7\ncaused by: error: insert or update on table \"users\" violates foreign key constraint \"users_tenant_id_tenants_id_fk\"\n    at C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\pg-pool\\index.js:45:11\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18\n    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22\n    at UserRepository.upsert (C:/Users/scoot/poll/VaultLogic/server/repositories/UserRepository.ts:72:22)\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:69:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7","query":"insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"","params":["google-user-idtoken","idtoken@example.com",null,null,null,"00000000-0000-0000-0000-000000000098","viewer","google","easy",true,null,null,null,null,"2026-01-18T04:00:06.132Z"]},"userId":"google-user-idtoken","msg":"Failed to upsert user during authentication"}
{"level":50,"time":1768708806185,"env":"test","module":"auth","err":{"type":"Error","message":"Failed to create or update user account","stack":"Error: Failed to create or update user account\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:73:11)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"msg":"Google authentication failed"}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708806485,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708806486,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/integration/analytics_service.test.ts[2m > [22m[2mAnalytics Service Integration
[22m[39mMANUAL PATCH FAILED DrizzleQueryError: Failed query: ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "workflow_runs"("id") ON DELETE CASCADE
params: 
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/analytics_service.test.ts:23:13 {
  query: [32m'ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "workflow_runs"("id") ON DELETE CASCADE'[39m,
  params: [],
  cause: error: constraint "workflow_run_events_run_id_workflow_runs_id_fk" for relation "workflow_run_events" already exists
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/analytics_service.test.ts:23:13 {
    length: [33m177[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42710'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'tablecmds.c'[39m,
    line: [32m'9387'[39m,
    routine: [32m'ATExecAddConstraint'[39m
  }
}

 [31mâ¯[39m tests/integration/datavault.autonumber.test.ts [2m([22m[2m5 tests[22m[2m | [22m[33m5 skipped[39m[2m)[22m[33m 3152[2mms[22m[39m
     [2m[90mâ†“[39m[22m should generate basic autonumber without prefix
     [2m[90mâ†“[39m[22m should generate autonumber with prefix
     [2m[90mâ†“[39m[22m should generate autonumber with yearly reset format
     [2m[90mâ†“[39m[22m should be atomic and prevent race conditions
     [2m[90mâ†“[39m[22m should prevent manual updates to autonumber values
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w18_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w18_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708806915,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708806916,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768708806921,"env":"test","module":"auth","err":{"type":"Error","message":"User not found after upsert","stack":"Error: User not found after upsert\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:162:27\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google authentication failed"}
{"level":50,"time":1768708806965,"env":"test","module":"auth-routes","email":"test-1768708806523-1oogqk@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
 [31mâ¯[39m tests/integration/organizationService.test.ts [2m([22m[2m13 tests[22m[2m | [22m[31m13 failed[39m[2m)[22m[33m 9704[2mms[22m[39m
[31m       [31mÃ—[31m should create organization and auto-create admin membership[39m[32m 201[2mms[22m[39m
[31m       [31mÃ—[31m should return all organizations for user[39m[32m 98[2mms[22m[39m
[31m       [31mÃ—[31m should return empty array for user with no memberships[39m[33m 467[2mms[22m[39m
[31m       [31mÃ—[31m should allow admin to update organization[39m[33m 807[2mms[22m[39m
[31m       [31mÃ—[31m should deny non-admin from updating organization[39m[32m 108[2mms[22m[39m
[31m       [31mÃ—[31m should return all members of organization[39m[33m 419[2mms[22m[39m
[31m       [31mÃ—[31m should allow admin to promote member[39m[33m 452[2mms[22m[39m
[31m       [31mÃ—[31m should allow admin to demote other admin[39m[33m 441[2mms[22m[39m
[31m       [31mÃ—[31m should prevent self-demotion[39m[33m 936[2mms[22m[39m
[31m       [31mÃ—[31m should allow admin to remove member[39m[33m 555[2mms[22m[39m
[31m       [31mÃ—[31m should prevent self-removal[39m[33m 1050[2mms[22m[39m
[31m       [31mÃ—[31m should allow member to leave organization[39m[33m 542[2mms[22m[39m
[31m       [31mÃ—[31m should allow admin to leave organization[39m[33m 315[2mms[22m[39m
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

{"level":50,"time":1768708807023,"env":"test","module":"auth","err":{"type":"Error","message":"Token verification failed","stack":"Error: Token verification failed\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:431:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mðŸ“Š Schema test_schema_w18_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708807050,"env":"test","msg":"DB: initializing... Local"}
{"level":40,"time":1768708807074,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768708807074,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
{"level":50,"time":1768708807093,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all trusted devices
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":30,"time":1768708807051,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w18_v3\",public"}
{"level":30,"time":1768708807112,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w18_v3\",public"}
{"level":30,"time":1768708807112,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768708807120,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token payload","stack":"Error: Invalid token payload\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:88:26)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708807167,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708807168,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

 [31mâ¯[39m tests/integration/auth/oauth2.google.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m5 failed[39m[2m)[22m[33m 5923[2mms[22m[39m
[31m       [31mÃ—[31m should successfully authenticate with valid Google ID token[39m[32m 254[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 400 when ID token is missing [33m 378[2mms[22m[39m
       [32mâœ“[39m should return 403 when Origin header is invalid[32m 54[2mms[22m[39m
       [32mâœ“[39m should return 401 when Google token verification fails[32m 54[2mms[22m[39m
       [32mâœ“[39m should return 401 when email is not verified by Google[32m 54[2mms[22m[39m
[31m       [31mÃ—[31m should update existing user on subsequent logins[39m[32m 141[2mms[22m[39m
[31m       [31mÃ—[31m should create refresh token record in database[39m[33m 522[2mms[22m[39m
[31m       [31mÃ—[31m should support both "token" and "idToken" fields[39m[33m 570[2mms[22m[39m
       [33m[2mâœ“[22m[39m should respect rate limiting [33m 385[2mms[22m[39m
[31m       [31mÃ—[31m should handle missing profile information gracefully[39m[33m 350[2mms[22m[39m
       [32mâœ“[39m should verify valid Google ID token[32m 52[2mms[22m[39m
       [32mâœ“[39m should throw error when token verification fails[32m 49[2mms[22m[39m
       [32mâœ“[39m should throw error when email is not verified[32m 49[2mms[22m[39m
       [32mâœ“[39m should throw error when payload is null[32m 46[2mms[22m[39m
{"level":30,"time":1768708807358,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708807358,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708807360,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708807361,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/dynamic_options_workflow.test.ts [2m([22m[2m1 test[22m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 3299[2mms[22m[39m
     [2m[90mâ†“[39m[22m should successfully configure a workflow with Read Table -> Dynamic Choice
 [31mâ¯[39m tests/integration/analytics_service.test.ts [2m([22m[2m1 test[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 4229[2mms[22m[39m
[31m     [31mÃ—[31m should generate events and metrics on run completion[39m[32m 4[2mms[22m[39m
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768708807572,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708807573,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/variableSafety.test.ts [2m([22m[2m4 tests[22m[2m | [22m[31m4 failed[39m[2m)[22m[33m 5558[2mms[22m[39m
[31m     [31mÃ—[31m REPRO: ScriptEngine fails to resolve alias 'input_variable' when aliasMap is NOT provided[39m[32m 110[2mms[22m[39m
[31m     [31mÃ—[31m ScriptEngine resolves alias 'input_variable' when aliasMap is provided[39m[33m 621[2mms[22m[39m
[31m     [31mÃ—[31m REPRO: BlockRunner fails to resolve alias in CreateRecordConfig[39m[33m 666[2mms[22m[39m
[31m     [31mÃ—[31m BlockRunner logic resolves alias with aliasMap[39m[33m 678[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w18_v3, public
âœ… Enforced search_path: test_schema_w18_v3, public

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w18_v3
âœ… Current search_path: test_schema_w18_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

{"level":30,"time":1768708808674,"env":"test","module":"auth-routes","userId":"9f075fbbf85fa7bb57b627d7779dcd70","msg":"User logged in successfully"}
{"level":30,"time":1768708808763,"env":"test","module":"audit-log-service","userId":"9f075fbbf85fa7bb57b627d7779dcd70","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708808919,"env":"test","module":"auth-routes","userId":"9f075fbbf85fa7bb57b627d7779dcd70","msg":"All other sessions revoked"}
{"level":30,"time":1768708808966,"env":"test","module":"audit-log-service","userId":"9f075fbbf85fa7bb57b627d7779dcd70","eventType":"all_sessions_revoked","ipAddress":"::ffff:127.0.0.1","hasMetadata":false,"msg":"Security event logged"}
{"level":30,"time":1768708809067,"env":"test","module":"auth-routes","userId":"9f075fbbf85fa7bb57b627d7779dcd70","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768708809124,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768708809153,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts[2m > [22m[2mRuns API - DOCX Generation Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708809137,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708809138,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708809144,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708809145,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708809152,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708809152,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708809152,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708809153,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w34_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w34_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708809433,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w35_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w35_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708809739,"env":"test","module":"user-credentials-repository","userId":"3ad943a6-b4f0-4c2a-8146-2ad6780bc102","msg":"User credentials created"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mðŸ“Š Schema test_schema_w34_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708809751,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708809752,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w34_v3\",public"}
{"level":30,"time":1768708809819,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w34_v3\",public"}
{"level":30,"time":1768708809819,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768708809901,"env":"test","module":"email-queue","jobId":"b36876c1-6aa1-47d3-97b4-f98d1641f785","to":"test-docx-WaagRmOkf4p8wNe6ljyJ3@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708809983,"env":"test","module":"auth-routes","userId":"3ad943a6-b4f0-4c2a-8146-2ad6780bc102","email":"test-docx-WaagRmOkf4p8wNe6ljyJ3@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mðŸ“Š Schema test_schema_w35_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708810012,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708810013,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w35_v3\",public"}
{"level":30,"time":1768708810081,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w35_v3\",public"}
{"level":30,"time":1768708810081,"env":"test","msg":"DB: initialized flag set."}
{"level":40,"time":1768708810251,"env":"test","module":"tenant-middleware","userId":"3ad943a6-b4f0-4c2a-8146-2ad6780bc102","path":"/projects/8a82410a-091b-45a8-9368-9fd7556f3a15/templates","msg":"User does not have an associated tenant"}
{"level":50,"time":1768708810293,"env":"test","module":"auth-routes","userId":"2283f9b9454d22b0c0ec2265bac2d475","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768708810309,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708810310,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768708810505,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould include device metadata in sessions
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:74:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768708810512,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w34_v3, public
âœ… Enforced search_path: test_schema_w34_v3, public

 [31mâ¯[39m tests/integration/api.runs.docx.test.ts [2m([22m[2m6 tests[22m[2m | [22m[33m6 skipped[39m[2m)[22m[33m 4110[2mms[22m[39m
       [2m[90mâ†“[39m[22m should execute workflow with template node and generate DOCX
       [2m[90mâ†“[39m[22m should handle missing template data gracefully
       [2m[90mâ†“[39m[22m should download DOCX output from successful run
       [2m[90mâ†“[39m[22m should return 404 for PDF when not generated
       [2m[90mâ†“[39m[22m should return 404 for non-existent run
       [2m[90mâ†“[39m[22m should extract placeholders from uploaded template
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w35_v3
âœ… Current search_path: test_schema_w35_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w35_v3, public
âœ… Enforced search_path: test_schema_w35_v3, public

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w35_v3
âœ… Current search_path: test_schema_w35_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708811154,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768708812053,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts[2m > [22m[2mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22m[2mshould create draft version on successful AI edit
[22m[39m[DEBUG] Entered workflowEdit route handler. WorkflowId: e37d7af0-d71a-4e90-b8a3-3e41efcfa269
[DEBUG] Validating request body
[DEBUG] Fetching workflow details

{"level":30,"time":1768708812292,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768708812329,"env":"test","module":"auth-routes","userId":"0b0b3cee1d97d5854083419a2c7bb7ea","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

{"level":30,"time":1768708812514,"env":"test","module":"audit-log-service","userId":"0b0b3cee1d97d5854083419a2c7bb7ea","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768708812592,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708812593,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708812620,"env":"test","module":"auth-routes","userId":"0b0b3cee1d97d5854083419a2c7bb7ea","sessionCount":0,"msg":"Listed active sessions"}
{"level":30,"time":1768708812634,"env":"test","workflowId":"e37d7af0-d71a-4e90-b8a3-3e41efcfa269","userId":"11ba025d-9803-4419-b835-377932e9df26","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts[2m > [22m[2mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22m[2mshould create draft version on successful AI edit
[22m[39m[DEBUG] Creating snapshot

 [31mâ¯[39m tests/integration/organizations-workflow.test.ts [2m([22m[2m23 tests[22m[2m | [22m[33m23 skipped[39m[2m)[22m[33m 3465[2mms[22m[39m
       [2m[90mâ†“[39m[22m Step 1: Create organization
       [2m[90mâ†“[39m[22m Step 2: Invite member via email
       [2m[90mâ†“[39m[22m Step 3: Accept invite
       [2m[90mâ†“[39m[22m Step 4: Create workflow owned by user
       [2m[90mâ†“[39m[22m Step 5: Transfer workflow to organization
       [2m[90mâ†“[39m[22m Step 6: Org member (user2) can access workflow
       [2m[90mâ†“[39m[22m Step 7: Org member (user2) can update workflow
       [2m[90mâ†“[39m[22m Step 8: Org admin (user1) can still access workflow after transfer
       [2m[90mâ†“[39m[22m Step 9: Non-member (user3) CANNOT access org workflow
       [2m[90mâ†“[39m[22m Step 10: Non-member (user3) CANNOT update org workflow
       [2m[90mâ†“[39m[22m Step 11: Non-member (user3) CANNOT transfer org workflow
       [2m[90mâ†“[39m[22m Step 12: Org member can see workflow in list
       [2m[90mâ†“[39m[22m Step 13: Non-member CANNOT see workflow in list
       [2m[90mâ†“[39m[22m Step 14: Remove member from org
       [2m[90mâ†“[39m[22m Step 15: Removed member (user2) can no longer access workflow
       [2m[90mâ†“[39m[22m Step 16: Re-add member and verify access restored
       [2m[90mâ†“[39m[22m Cannot invite same email twice (pending invite exists)
       [2m[90mâ†“[39m[22m Cannot accept expired invite
       [2m[90mâ†“[39m[22m Cannot transfer workflow to org user is not a member of
       [2m[90mâ†“[39m[22m Member cannot promote themselves to admin
       [2m[90mâ†“[39m[22m Member cannot remove admin
       [2m[90mâ†“[39m[22m Only members can view organization details
       [2m[90mâ†“[39m[22m Only members can view organization members list
[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768708812784,"env":"test","module":"ai-workflow-edit-routes","error":{"query":"insert into \"workflow_snapshots\" (\"id\", \"workflow_id\", \"name\", \"values\", \"workflow_version_id\", \"version_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, $3, default, default, default, default) returning \"id\", \"workflow_id\", \"name\", \"values\", \"workflow_version_id\", \"version_hash\", \"created_at\", \"updated_at\"","params":["e37d7af0-d71a-4e90-b8a3-3e41efcfa269","AI Edit BEFORE: 2026-01-18T04:00:12.634Z","{}"],"cause":{"length":379,"name":"error","severity":"ERROR","code":"23503","detail":"Key (workflow_id)=(e37d7af0-d71a-4e90-b8a3-3e41efcfa269) is not present in table \"workflows\".","schema":"test_schema_w34_v3","table":"workflow_snapshots","constraint":"workflow_snapshots_workflow_id_workflows_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"workflowId":"e37d7af0-d71a-4e90-b8a3-3e41efcfa269","msg":"Failed to create before snapshot"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts[2m > [22m[2mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22m[2mshould create draft version on successful AI edit
[22m[39m[DEBUG] Calling Gemini

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts[2m > [22m[2mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22m[2mshould create draft version on successful AI edit
[22m[39m[DEBUG] Gemini returned
[DEBUG] Calling applyOps with 2 ops

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w27_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w27_v3 (Reused: true)

{"level":50,"time":1768708813026,"env":"test","module":"workflow-patch-service","error":{"query":"insert into \"sections\" (\"id\", \"workflow_id\", \"title\", \"description\", \"order\", \"config\", \"visible_if\", \"skip_if\", \"created_at\", \"updated_at\") values (default, $1, $2, default, $3, default, default, default, default, default) returning \"id\", \"workflow_id\", \"title\", \"description\", \"order\", \"config\", \"visible_if\", \"skip_if\", \"created_at\", \"updated_at\"","params":["e37d7af0-d71a-4e90-b8a3-3e41efcfa269","Contact Information",1],"cause":{"length":339,"name":"error","severity":"ERROR","code":"23503","detail":"Key (workflow_id)=(e37d7af0-d71a-4e90-b8a3-3e41efcfa269) is not present in table \"workflows\".","schema":"test_schema_w34_v3","table":"sections","constraint":"sections_workflow_id_workflows_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"op":{"op":"section.create","tempId":"temp-section-1","title":"Contact Information","order":1},"msg":"Failed to apply operation"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts[2m > [22m[2mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22m[2mshould create draft version on successful AI edit
[22m[39m[DEBUG] applyOps returned. Errors: 1

{"level":50,"time":1768708813026,"env":"test","module":"ai-workflow-edit-routes","errors":["Failed to apply section.create: Failed query: insert into \"sections\" (\"id\", \"workflow_id\", \"title\", \"description\", \"order\", \"config\", \"visible_if\", \"skip_if\", \"created_at\", \"updated_at\") values (default, $1, $2, default, $3, default, default, default, default, default) returning \"id\", \"workflow_id\", \"title\", \"description\", \"order\", \"config\", \"visible_if\", \"skip_if\", \"created_at\", \"updated_at\"\nparams: e37d7af0-d71a-4e90-b8a3-3e41efcfa269,Contact Information,1"],"workflowId":"e37d7af0-d71a-4e90-b8a3-3e41efcfa269","msg":"Failed to apply some AI operations"}
{"level":30,"time":1768708813234,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mðŸ“Š Schema test_schema_w27_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708813333,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708813334,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w27_v3\",public"}
{"level":30,"time":1768708813404,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w27_v3\",public"}
{"level":30,"time":1768708813404,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

{"level":30,"time":1768708813599,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768708813721,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":50,"time":1768708813850,"env":"test","module":"auth-routes","userId":"aaf9e61a1ceb864434ed4c0191588ee5","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

{"level":50,"time":1768708813980,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould track session activity timestamps
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:74:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768708813987,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w39_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w39_v3 (Reused: true)

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w27_v3, public
âœ… Enforced search_path: test_schema_w27_v3, public

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w34_v3
âœ… Current search_path: test_schema_w34_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w28_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w28_v3 (Reused: true)

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mðŸ“Š Schema test_schema_w39_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708814541,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708814542,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w39_v3\",public"}
{"level":30,"time":1768708814592,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708814593,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708814623,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w39_v3\",public"}
{"level":30,"time":1768708814623,"env":"test","msg":"DB: initialized flag set."}
 [31mâ¯[39m tests/integration/session.management.real.test.ts [2m([22m[2m18 tests[22m[2m | [22m[31m16 failed[39m[2m)[22m[33m 28262[2mms[22m[39m
[31m       [31mÃ—[31m should list all active sessions for current user[39m[33m 1481[2mms[22m[39m
[31m       [31mÃ—[31m should mark current session correctly[39m[33m 316[2mms[22m[39m
[31m       [31mÃ—[31m should exclude revoked sessions[39m[33m 676[2mms[22m[39m
[31m       [31mÃ—[31m should order sessions by last used (most recent first)[39m[33m 646[2mms[22m[39m
[31m       [31mÃ—[31m should filter sessions by current user only[39m[33m 656[2mms[22m[39m
       [32mâœ“[39m should return 401 for unauthenticated request[32m 7[2mms[22m[39m
[31m       [31mÃ—[31m should revoke specific session[39m[33m 4273[2mms[22m[39m
[31m       [31mÃ—[31m should prevent revoking current session[39m[33m 2969[2mms[22m[39m
[31m       [31mÃ—[31m should return 404 for non-existent session[39m[33m 1149[2mms[22m[39m
[31m       [31mÃ—[31m should prevent revoking other user's session[39m[33m 1678[2mms[22m[39m
[31m       [31mÃ—[31m should revoke all other sessions[39m[33m 373[2mms[22m[39m
[31m       [31mÃ—[31m should keep current session active[39m[33m 1694[2mms[22m[39m
[31m       [31mÃ—[31m should return 400 if no active session found[39m[33m 1358[2mms[22m[39m
[31m       [31mÃ—[31m should revoke all trusted devices[39m[33m 1138[2mms[22m[39m
       [33m[2mâœ“[22m[39m should handle user with single session gracefully [33m 2080[2mms[22m[39m
[31m       [31mÃ—[31m should include device metadata in sessions[39m[33m 1380[2mms[22m[39m
[31m       [31mÃ—[31m should not expose sensitive token data[39m[33m 2081[2mms[22m[39m
[31m       [31mÃ—[31m should track session activity timestamps[39m[33m 1390[2mms[22m[39m
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mðŸ“Š Schema test_schema_w28_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708814822,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708814823,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w28_v3\",public"}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

{"level":30,"time":1768708814882,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w41_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708814904,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w28_v3\",public"}
{"level":30,"time":1768708814905,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w41_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708815155,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w29_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w29_v3 (Reused: true)

{"level":30,"time":1768708815331,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mðŸ“Š Schema test_schema_w41_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708815420,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708815421,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w41_v3\",public"}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w30_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w39_v3, public
âœ… Enforced search_path: test_schema_w39_v3, public

{"level":30,"time":1768708815473,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w41_v3\",public"}
{"level":30,"time":1768708815473,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w30_v3 (Reused: true)

[90mstdout[2m | tests/integration/intake.workflow.test.ts[2m > [22m[2mIntake Workflow Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/intake.workflow.test.ts[2m > [22m[2mIntake Workflow Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768708815508,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/intake.workflow.test.ts[2m > [22m[2mIntake Workflow Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708815534,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768708815519,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708815520,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708815526,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708815527,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708815533,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708815533,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708815534,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708815534,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w28_v3
âœ… Current search_path: test_schema_w34_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w28_v3, public
âœ… Enforced search_path: test_schema_w28_v3, public

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mðŸ“Š Schema test_schema_w29_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708815724,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708815725,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w29_v3\",public"}
{"level":30,"time":1768708815783,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w29_v3\",public"}
{"level":30,"time":1768708815783,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w34_v3
âœ… Current search_path: test_schema_w34_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mðŸ“Š Schema test_schema_w30_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708815916,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708815917,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w30_v3\",public"}
{"level":30,"time":1768708815977,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w30_v3\",public"}
{"level":30,"time":1768708815977,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

{"level":50,"time":1768708816112,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["b70c0062-5b6f-4705-8ea3-4ef5036442f5","$2b$12$eb/PH6YNKD9a8PDB/yS7XOUDFP4ETxwlmD7v4byxMbbymOTj.qbui"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b70c0062-5b6f-4705-8ea3-4ef5036442f5) is not present in table \"users\".","schema":"test_schema_w39_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"b70c0062-5b6f-4705-8ea3-4ef5036442f5","msg":"Failed to create user credentials"}
{"level":50,"time":1768708816112,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["b70c0062-5b6f-4705-8ea3-4ef5036442f5","$2b$12$eb/PH6YNKD9a8PDB/yS7XOUDFP4ETxwlmD7v4byxMbbymOTj.qbui"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b70c0062-5b6f-4705-8ea3-4ef5036442f5) is not present in table \"users\".","schema":"test_schema_w39_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/intake.workflow.test.ts[2m > [22m[2mIntake Workflow Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/intake.workflow.test.ts:11:15

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708816129,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708816129,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w41_v3, public
âœ… Enforced search_path: test_schema_w41_v3, public

{"level":30,"time":1768708816256,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708816257,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w31_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [31mâ¯[39m tests/integration/ai/workflowEdit.test.ts [2m([22m[2m8 tests[22m[2m | [22m[31m8 failed[39m[2m)[22m[33m 7344[2mms[22m[39m
[31m     [31mÃ—[31m should create draft version on successful AI edit[39m[33m 1002[2mms[22m[39m
[31m     [31mÃ—[31m should enforce draft mode (revert active workflow to draft)[39m[32m 79[2mms[22m[39m
[31m     [31mÃ—[31m should not create version when no changes detected (checksum match)[39m[33m 397[2mms[22m[39m
[31m     [31mÃ—[31m should reject unauthorized access[39m[33m 425[2mms[22m[39m
[31m     [31mÃ—[31m should reject unsafe DataVault operations[39m[33m 398[2mms[22m[39m
[31m     [31mÃ—[31m should handle multi-operation edits with tempId resolution[39m[33m 415[2mms[22m[39m
[31m     [31mÃ—[31m should create BEFORE and AFTER snapshots[39m[33m 405[2mms[22m[39m
[31m     [31mÃ—[31m should rollback on validation failure[39m[33m 418[2mms[22m[39m
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w28_v3
âœ… Current search_path: test_schema_w28_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w31_v3 (Reused: true)

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

 [31mâ¯[39m tests/integration/intake.workflow.test.ts [2m([22m[2m2 tests[22m[2m | [22m[33m2 skipped[39m[2m)[22m[33m 3644[2mms[22m[39m
     [2m[90mâ†“[39m[22m should allow designating a workflow as Intake
     [2m[90mâ†“[39m[22m should allow linking a downstream workflow to an intake workflow
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w32_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w32_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w29_v3, public
âœ… Enforced search_path: test_schema_w29_v3, public

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w28_v3
âœ… Current search_path: test_schema_w30_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w33_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w33_v3 (Reused: true)

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mðŸ“Š Schema test_schema_w31_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708816758,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708816759,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w31_v3\",public"}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w30_v3, public
âœ… Enforced search_path: test_schema_w30_v3, public

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768708816838,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w31_v3\",public"}
{"level":30,"time":1768708816838,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w30_v3
âœ… Current search_path: test_schema_w41_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708816961,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mðŸ“Š Schema test_schema_w32_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708816982,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708816983,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w32_v3\",public"}
{"level":30,"time":1768708816988,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.projects.test.ts[2m > [22m[2mProjects API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708816973,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708816974,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708816980,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708816981,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708816987,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708816987,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708816988,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708816988,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768708817080,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w32_v3\",public"}
{"level":30,"time":1768708817080,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mðŸ“Š Schema test_schema_w33_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708817283,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708817284,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w33_v3\",public"}
{"level":30,"time":1768708817322,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768708817339,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w33_v3\",public"}
{"level":30,"time":1768708817339,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

{"level":50,"time":1768708817533,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["f157d03b-61cf-4895-9650-fe8901d287b7","$2b$12$/lCTWF24mq5CL1SBkwT0YuJ7puBn5cHaYRHuONtRG2GhBjeDHAH4K"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(f157d03b-61cf-4895-9650-fe8901d287b7) is not present in table \"users\".","schema":"test_schema_w30_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"f157d03b-61cf-4895-9650-fe8901d287b7","msg":"Failed to create user credentials"}
{"level":50,"time":1768708817533,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["f157d03b-61cf-4895-9650-fe8901d287b7","$2b$12$/lCTWF24mq5CL1SBkwT0YuJ7puBn5cHaYRHuONtRG2GhBjeDHAH4K"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(f157d03b-61cf-4895-9650-fe8901d287b7) is not present in table \"users\".","schema":"test_schema_w30_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w31_v3, public
âœ… Enforced search_path: test_schema_w31_v3, public

{"level":30,"time":1768708817640,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708817641,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w36_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w36_v3 (Reused: true)

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w39_v3
âœ… Current search_path: test_schema_w33_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [31mâ¯[39m tests/integration/dataBlocks.test.ts [2m([22m[2m2 tests[22m[2m | [22m[33m2 skipped[39m[2m)[22m[33m 3981[2mms[22m[39m
     [2m[90mâ†“[39m[22m should write data to DataVault via WriteBlock
     [2m[90mâ†“[39m[22m should query data from DataVault via QueryBlock and use in Logic
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w37_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts[2m > [22m[2mData Sources API - Native Catalog
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts[2m > [22m[2mData Sources API - Native Catalog
[22m[39m[DEBUG] Database initialized.

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w32_v3, public
âœ… Enforced search_path: test_schema_w32_v3, public

{"level":30,"time":1768708817898,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w37_v3 (Reused: true)

{"level":30,"time":1768708817922,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts[2m > [22m[2mData Sources API - Native Catalog
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708817908,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708817909,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708817915,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708817915,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708817922,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708817922,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708817922,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708817922,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768708817958,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708817958,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w28_v3
âœ… Current search_path: test_schema_w32_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w38_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708818032,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708818033,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts[2m > [22m[2mTemplates and Runs API Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/api.templates-runs.test.ts[2m > [22m[2mTemplates and Runs API Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768708818038,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w38_v3 (Reused: true)

{"level":30,"time":1768708818062,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts[2m > [22m[2mTemplates and Runs API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708818049,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708818049,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708818056,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708818056,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708818062,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708818062,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708818062,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708818062,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
 [31mâ¯[39m tests/integration/workflow_versioning.test.ts [2m([22m[2m3 tests[22m[2m | [22m[33m3 skipped[39m[2m)[22m[33m 3521[2mms[22m[39m
     [2m[90mâ†“[39m[22m should diff two versions correctly
     [2m[90mâ†“[39m[22m should create a version and populate changelog
     [2m[90mâ†“[39m[22m should track execution lineage via snapshot
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mðŸ“Š Schema test_schema_w36_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708818126,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708818127,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w36_v3\",public"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w33_v3, public
âœ… Enforced search_path: test_schema_w33_v3, public

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708818185,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w36_v3\",public"}
{"level":30,"time":1768708818185,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w31_v3
âœ… Current search_path: test_schema_w28_v3, public
â© Schema reused, skipping migrations.

 [31mâ¯[39m tests/integration/api.projects.test.ts [2m([22m[2m10 tests[22m[2m | [22m[33m10 skipped[39m[2m)[22m[33m 4009[2mms[22m[39m
       [2m[90mâ†“[39m[22m should create a new project
       [2m[90mâ†“[39m[22m should reject without authentication
       [2m[90mâ†“[39m[22m should reject with invalid data
       [2m[90mâ†“[39m[22m should list projects for tenant
       [2m[90mâ†“[39m[22m should support pagination
       [2m[90mâ†“[39m[22m should get project by ID
       [2m[90mâ†“[39m[22m should return 404 for non-existent project
       [2m[90mâ†“[39m[22m should update project
       [2m[90mâ†“[39m[22m should soft-delete project
       [2m[90mâ†“[39m[22m should not allow cross-tenant access
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mðŸ“Š Schema test_schema_w37_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708818346,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708818347,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w37_v3\",public"}
{"level":30,"time":1768708818398,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w37_v3\",public"}
{"level":30,"time":1768708818398,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mðŸ“Š Schema test_schema_w38_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708818491,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708818491,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w38_v3\",public"}
{"level":50,"time":1768708818503,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["37efe898-b959-44d5-8356-439cb7aabae6","$2b$12$hBN8ZFMflIdWKko8UwlQ.ujRovBCJ6HSBggcgHweAVuMmFEWkzsFa"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(37efe898-b959-44d5-8356-439cb7aabae6) is not present in table \"users\".","schema":"test_schema_w32_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"37efe898-b959-44d5-8356-439cb7aabae6","msg":"Failed to create user credentials"}
{"level":50,"time":1768708818504,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["37efe898-b959-44d5-8356-439cb7aabae6","$2b$12$hBN8ZFMflIdWKko8UwlQ.ujRovBCJ6HSBggcgHweAVuMmFEWkzsFa"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(37efe898-b959-44d5-8356-439cb7aabae6) is not present in table \"users\".","schema":"test_schema_w32_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/api.dataSources.native.test.ts[2m > [22m[2mData Sources API - Native Catalog
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/api.dataSources.native.test.ts:20:15

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708818518,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708818518,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

{"level":30,"time":1768708818554,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w38_v3\",public"}
{"level":30,"time":1768708818554,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mDEBUG: Existing functions: []

{"level":50,"time":1768708818634,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["c89dc2b9-7d52-4fdb-8731-a5072d7ef186","$2b$12$Rg.aB10bvcI/VH91BGq2xeJJsIkOAnTw8.WYQISgnyRY05v4Xyr22"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(c89dc2b9-7d52-4fdb-8731-a5072d7ef186) is not present in table \"users\".","schema":"test_schema_w36_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"c89dc2b9-7d52-4fdb-8731-a5072d7ef186","msg":"Failed to create user credentials"}
{"level":50,"time":1768708818634,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["c89dc2b9-7d52-4fdb-8731-a5072d7ef186","$2b$12$Rg.aB10bvcI/VH91BGq2xeJJsIkOAnTw8.WYQISgnyRY05v4Xyr22"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(c89dc2b9-7d52-4fdb-8731-a5072d7ef186) is not present in table \"users\".","schema":"test_schema_w36_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/api.templates-runs.test.ts[2m > [22m[2mTemplates and Runs API Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at Module.setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/api.templates-runs.test.ts:59:11

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708818650,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708818650,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

 [31mâ¯[39m tests/integration/api.dataSources.native.test.ts [2m([22m[2m2 tests[22m[2m | [22m[33m2 skipped[39m[2m)[22m[33m 3668[2mms[22m[39m
     [2m[90mâ†“[39m[22m should list databases and databases' tables in the catalog
     [2m[90mâ†“[39m[22m should create a native_table data source
{"level":30,"time":1768708818873,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768708818899,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts[2m > [22m[2mDataVault v4 Regression Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708818885,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708818886,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708818892,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708818893,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708818899,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708818899,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708818899,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708818899,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w36_v3, public
âœ… Enforced search_path: test_schema_w36_v3, public

 [31mâ¯[39m tests/integration/api.templates-runs.test.ts [2m([22m[2m15 tests[22m[2m | [22m[33m15 skipped[39m[2m)[22m[33m 3608[2mms[22m[39m
         [2m[90mâ†“[39m[22m should create template with file upload
         [2m[90mâ†“[39m[22m should reject non-docx files
         [2m[90mâ†“[39m[22m should reject without file
         [2m[90mâ†“[39m[22m should list templates
         [2m[90mâ†“[39m[22m should get template by ID
         [2m[90mâ†“[39m[22m should extract placeholders
         [2m[90mâ†“[39m[22m should update template name
         [2m[90mâ†“[39m[22m should delete template
         [2m[90mâ†“[39m[22m should execute workflow
         [2m[90mâ†“[39m[22m should include logs in debug mode
         [2m[90mâ†“[39m[22m should reject without required permission
         [2m[90mâ†“[39m[22m should list runs
         [2m[90mâ†“[39m[22m should filter by workflowId
         [2m[90mâ†“[39m[22m should get run by ID
         [2m[90mâ†“[39m[22m should get run logs
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w38_v3
âœ… Current search_path: test_schema_w38_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768708819131,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

{"level":30,"time":1768708819158,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708819142,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708819143,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708819150,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708819151,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708819157,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708819157,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708819157,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708819157,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w37_v3, public
âœ… Enforced search_path: test_schema_w37_v3, public

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w38_v3
âœ… Current search_path: test_schema_w38_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w38_v3, public
âœ… Enforced search_path: test_schema_w38_v3, public

{"level":30,"time":1768708819388,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768708819401,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts[2m > [22m[2mDataVault v4 Regression Tests
[22m[39mLogin Status: [33m200[39m
Login Body: {
  "message": "Authentication successful",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiJnb29nbGUtdXNlci1pZCIsImVtYWlsIjoidGVzdHVzZXJAZXhhbXBsZS5jb20iLCJ0ZW5hbnRJZCI6IjUyNzAzMWIyLTE5NjUtNDMzOC1hYmZiLWU3N2FlODhmOTgyNiIsInJvbGUiOiJhZG1pbiIsInRlbmFudFJvbGUiOiJvd25lciIsImlhdCI6MTc2ODcwODgxOSwiZXhwIjoxNzY4NzA5NzE5fQ.7-r8_TZON-0wo8WO7j-s6Y4H2ZqyEZ48k0DzHNLnwVU",
  "user": {
    "id": "google-user-id",
    "email": "testuser@example.com",
    "firstName": null,
    "lastName": null,
    "profileImageUrl": null,
    "tenantId": "527031b2-1965-4338-abfb-e77ae88f9826",
    "role": "admin",
    "tenantRole": "owner"
  }
}

{"level":30,"time":1768708819414,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.snapshots.test.ts[2m > [22m[2mStage 13: Workflow Snapshots & Versioning
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708819400,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708819401,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708819407,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708819408,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708819414,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708819414,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708819414,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708819414,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w38_v3
âœ… Current search_path: test_schema_w38_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests
[22m[39m[Shim] Request to /api/auth/google, Session User ID: undefined

{"level":50,"time":1768708819745,"env":"test","module":"auth","err":{"type":"DrizzleQueryError","message":"Failed query: insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)\nparams: other-user-id,42adcbb0b6234d6018fe7e93b885d911a23aaf5e8a5b36ab74afb39ac44ee7ee,2026-02-17T04:00:19.582Z,false,{\"ip\":\"::ffff:127.0.0.1\"},,::ffff:127.0.0.1,Location Unknown,2026-01-18T04:00:19.582Z: insert or update on table \"refresh_tokens\" violates foreign key constraint \"refresh_tokens_user_id_users_id_fk\"","stack":"Error: Failed query: insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)\nparams: other-user-id,42adcbb0b6234d6018fe7e93b885d911a23aaf5e8a5b36ab74afb39ac44ee7ee,2026-02-17T04:00:19.582Z,false,{\"ip\":\"::ffff:127.0.0.1\"},,::ffff:127.0.0.1,Location Unknown,2026-01-18T04:00:19.582Z\n    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:173:28\ncaused by: error: insert or update on table \"refresh_tokens\" violates foreign key constraint \"refresh_tokens_user_id_users_id_fk\"\n    at C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\pg-pool\\index.js:45:11\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:113:20\n    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)\n    at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:173:28","query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["other-user-id","42adcbb0b6234d6018fe7e93b885d911a23aaf5e8a5b36ab74afb39ac44ee7ee","2026-02-17T04:00:19.582Z",false,"{\"ip\":\"::ffff:127.0.0.1\"}",null,"::ffff:127.0.0.1","Location Unknown","2026-01-18T04:00:19.582Z"]},"msg":"Google authentication failed"}
{"level":30,"time":1768708819755,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708819755,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w40_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w40_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstderr[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests
[22m[39mCleanup error (non-fatal): DrizzleQueryError: Failed query: delete from "workflows" where  = $1
params: 48b490ca-fe20-41ea-895f-c5705c8f6a12
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/api.runs.graph.test.ts:256:9 {
  query: [32m'delete from "workflows" where  = $1'[39m,
  params: [ [32m'48b490ca-fe20-41ea-895f-c5705c8f6a12'[39m ],
  cause: error: syntax error at or near "="
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/api.runs.graph.test.ts:256:9 {
    length: [33m90[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42601'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'32'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'scan.l'[39m,
    line: [32m'1244'[39m,
    routine: [32m'scanner_yyerror'[39m
  }
}

{"level":30,"time":1768708820037,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708820037,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/datavault-v4-regression.test.ts [2m([22m[2m23 tests[22m[2m | [22m[33m23 skipped[39m[2m)[22m[33m 3873[2mms[22m[39m
       [2m[90mâ†“[39m[22m should create a select column with options
       [2m[90mâ†“[39m[22m should create a multiselect column with options
       [2m[90mâ†“[39m[22m should validate select value against options
       [2m[90mâ†“[39m[22m should validate multiselect values as array
       [2m[90mâ†“[39m[22m should create an autonumber column with sequence
       [2m[90mâ†“[39m[22m should format autonumber with prefix
       [2m[90mâ†“[39m[22m should create a note for a row
       [2m[90mâ†“[39m[22m should get all notes for a row
       [2m[90mâ†“[39m[22m should delete a note
       [2m[90mâ†“[39m[22m should not allow deleting notes by other users
       [2m[90mâ†“[39m[22m should create an API token
       [2m[90mâ†“[39m[22m should validate API token scopes
       [2m[90mâ†“[39m[22m should revoke (delete) an API token
       [2m[90mâ†“[39m[22m should deny access with expired token
       [2m[90mâ†“[39m[22m should grant table permission
       [2m[90mâ†“[39m[22m should list table permissions
       [2m[90mâ†“[39m[22m should update table permission role
       [2m[90mâ†“[39m[22m should revoke table permission
       [2m[90mâ†“[39m[22m should enforce RBAC - only owners can manage permissions
       [2m[90mâ†“[39m[22m should paginate rows efficiently
       [2m[90mâ†“[39m[22m should return user-friendly error for invalid column type
       [2m[90mâ†“[39m[22m should return user-friendly error for missing required fields
       [2m[90mâ†“[39m[22m should handle network errors gracefully
[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768708820250,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708820280,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708820265,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708820266,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708820272,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708820273,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708820279,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708820279,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708820280,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708820280,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w47_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w47_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mðŸ“Š Schema test_schema_w40_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708820381,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708820381,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w40_v3\",public"}
 [31mâ¯[39m tests/integration/api.runs.graph.test.ts [2m([22m[2m19 tests[22m[2m | [22m[33m19 skipped[39m[2m)[22m[33m 3929[2mms[22m[39m
       [2m[90mâ†“[39m[22m should list all runs with pagination
       [2m[90mâ†“[39m[22m should filter runs by status
       [2m[90mâ†“[39m[22m should filter runs by workflow
       [2m[90mâ†“[39m[22m should filter runs by project
       [2m[90mâ†“[39m[22m should filter runs by date range
       [2m[90mâ†“[39m[22m should search runs by query string
       [2m[90mâ†“[39m[22m should get run by ID with all details
       [2m[90mâ†“[39m[22m should return 404 for non-existent run
       [2m[90mâ†“[39m[22m should get logs for a run
       [2m[90mâ†“[39m[22m should re-run workflow with same inputs
       [2m[90mâ†“[39m[22m should re-run workflow with override inputs
       [2m[90mâ†“[39m[22m should return 404 for non-existent run
       [2m[90mâ†“[39m[22m should export runs to CSV
       [2m[90mâ†“[39m[22m should export runs with filters applied
       [2m[90mâ†“[39m[22m should compare two runs
       [2m[90mâ†“[39m[22m should identify changed input keys
       [2m[90mâ†“[39m[22m should return 404 if run A not found
       [2m[90mâ†“[39m[22m should return 404 if run B not found
       [2m[90mâ†“[39m[22m should enforce tenant isolation on runs list
[90mstdout[2m | tests/integration/api.workflows.test.ts[2m > [22m[2mWorkflows API Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

{"level":30,"time":1768708820446,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w40_v3\",public"}
{"level":30,"time":1768708820446,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.workflows.test.ts[2m > [22m[2mWorkflows API Integration Tests
[22m[39m[DEBUG] Database initialized.

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w46_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708820452,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/api.workflows.test.ts[2m > [22m[2mWorkflows API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708820483,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768708820466,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708820467,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708820475,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708820475,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708820482,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708820482,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708820483,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708820483,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w46_v3 (Reused: true)

{"level":30,"time":1768708820553,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708820554,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts[2m > [22m[2mLifecycle Hooks Execution
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts[2m > [22m[2mLifecycle Hooks Execution
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768708820634,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768708820661,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts[2m > [22m[2mLifecycle Hooks Execution
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708820646,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708820647,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708820654,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708820654,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708820660,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708820660,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708820661,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708820661,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mðŸ“Š Schema test_schema_w47_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708820788,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708820789,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w47_v3\",public"}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768708820842,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["8c7e63de-38d0-43d5-83ba-fe2f470e40ba","$2b$12$0bgwUKM9jR6bFxXMtXWtJ.Fs5NQct4LVpLnyebDr447rMddLwsOK2"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(8c7e63de-38d0-43d5-83ba-fe2f470e40ba) is not present in table \"users\".","schema":"test_schema_w40_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"8c7e63de-38d0-43d5-83ba-fe2f470e40ba","msg":"Failed to create user credentials"}
{"level":50,"time":1768708820843,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["8c7e63de-38d0-43d5-83ba-fe2f470e40ba","$2b$12$0bgwUKM9jR6bFxXMtXWtJ.Fs5NQct4LVpLnyebDr447rMddLwsOK2"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(8c7e63de-38d0-43d5-83ba-fe2f470e40ba) is not present in table \"users\".","schema":"test_schema_w40_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768708820849,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w47_v3\",public"}
{"level":30,"time":1768708820849,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/session.management.integration.test.ts:31:15

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708820859,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708820860,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/api.snapshots.test.ts [2m([22m[2m1 test[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 4246[2mms[22m[39m
[31m     [31mÃ—[31m should maintain immutability of runs across versions[39m[33m 418[2mms[22m[39m
{"level":30,"time":1768708820894,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mðŸ“Š Schema test_schema_w46_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708820911,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708820912,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w46_v3\",public"}
{"level":30,"time":1768708820964,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w46_v3\",public"}
{"level":30,"time":1768708820964,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w45_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w45_v3 (Reused: true)

{"level":50,"time":1768708821029,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["2efa0ab3-1a12-44e8-bb33-a4aa60c9057f","$2b$12$bHsITYagjUxupLFJvMQt8ObH.HjB0nPYL0LPG0lfiMFiHUqtZAKIS"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(2efa0ab3-1a12-44e8-bb33-a4aa60c9057f) is not present in table \"users\".","schema":"test_schema_w40_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"2efa0ab3-1a12-44e8-bb33-a4aa60c9057f","msg":"Failed to create user credentials"}
{"level":50,"time":1768708821029,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["2efa0ab3-1a12-44e8-bb33-a4aa60c9057f","$2b$12$bHsITYagjUxupLFJvMQt8ObH.HjB0nPYL0LPG0lfiMFiHUqtZAKIS"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(2efa0ab3-1a12-44e8-bb33-a4aa60c9057f) is not present in table \"users\".","schema":"test_schema_w40_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/api.workflows.test.ts[2m > [22m[2mWorkflows API Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at Module.setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/api.workflows.test.ts:42:11

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708821047,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708821048,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/auth/session.management.integration.test.ts [2m([22m[2m18 tests[22m[2m | [22m[33m18 skipped[39m[2m)[22m[33m 3601[2mms[22m[39m
       [2m[90mâ†“[39m[22m should create refresh token on login
       [2m[90mâ†“[39m[22m should track device metadata in session
       [2m[90mâ†“[39m[22m should create separate sessions for multiple device logins
       [2m[90mâ†“[39m[22m should list all active sessions for user
       [2m[90mâ†“[39m[22m should mark current session correctly
       [2m[90mâ†“[39m[22m should not include revoked sessions
       [2m[90mâ†“[39m[22m should order sessions by last used (most recent first)
       [2m[90mâ†“[39m[22m should require authentication
       [2m[90mâ†“[39m[22m should revoke specific session
       [2m[90mâ†“[39m[22m should prevent revoking current session
       [2m[90mâ†“[39m[22m should not allow revoking other users sessions
       [2m[90mâ†“[39m[22m should return 404 for non-existent session ID
       [2m[90mâ†“[39m[22m should revoke all sessions except current
       [2m[90mâ†“[39m[22m should revoke all trusted devices
       [2m[90mâ†“[39m[22m should require active session
       [2m[90mâ†“[39m[22m should reject refresh token after 30 days
       [2m[90mâ†“[39m[22m should handle multiple concurrent logins
       [2m[90mâ†“[39m[22m should handle concurrent token refreshes
{"level":50,"time":1768708821238,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["b89f2713-7f48-42d1-802b-16a8f623e676","$2b$12$2717psXrcRQoKOeYKp/ZquvQUE.6/PHS4h3./kHvAmo3NwfnIiW6u"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b89f2713-7f48-42d1-802b-16a8f623e676) is not present in table \"users\".","schema":"test_schema_w47_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"b89f2713-7f48-42d1-802b-16a8f623e676","msg":"Failed to create user credentials"}
{"level":50,"time":1768708821238,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["b89f2713-7f48-42d1-802b-16a8f623e676","$2b$12$2717psXrcRQoKOeYKp/ZquvQUE.6/PHS4h3./kHvAmo3NwfnIiW6u"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b89f2713-7f48-42d1-802b-16a8f623e676) is not present in table \"users\".","schema":"test_schema_w47_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w40_v3, public
âœ… Enforced search_path: test_schema_w40_v3, public

[90mstderr[2m | tests/integration/lifecycle-hooks-execution.test.ts[2m > [22m[2mLifecycle Hooks Execution
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/lifecycle-hooks-execution.test.ts:41:11

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708821257,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708821257,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w47_v3
âœ… Current search_path: test_schema_w46_v3, public
â© Schema reused, skipping migrations.

 [31mâ¯[39m tests/integration/api.workflows.test.ts [2m([22m[2m17 tests[22m[2m | [22m[33m17 skipped[39m[2m)[22m[33m 3585[2mms[22m[39m
       [2m[90mâ†“[39m[22m should create a new draft workflow
       [2m[90mâ†“[39m[22m should reject without permission
       [2m[90mâ†“[39m[22m should list workflows
       [2m[90mâ†“[39m[22m should filter by status
       [2m[90mâ†“[39m[22m should search by name
       [2m[90mâ†“[39m[22m should update draft workflow
       [2m[90mâ†“[39m[22m should not allow editing published workflow
       [2m[90mâ†“[39m[22m should publish workflow
       [2m[90mâ†“[39m[22m should list workflow versions
       [2m[90mâ†“[39m[22m should move workflow to a project
       [2m[90mâ†“[39m[22m should move workflow to Main Folder (projectId = null)
       [2m[90mâ†“[39m[22m should reject move to non-existent project
       [2m[90mâ†“[39m[22m should reject move without authentication
       [2m[90mâ†“[39m[22m should reject move of workflow user does not own
       [2m[90mâ†“[39m[22m should reject move with invalid projectId format
       [2m[90mâ†“[39m[22m should reject move without projectId in body
       [2m[90mâ†“[39m[22m should reject move to project user does not have access to
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mðŸ“Š Schema test_schema_w45_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708821427,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708821428,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w45_v3\",public"}
{"level":30,"time":1768708821486,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w45_v3\",public"}
{"level":30,"time":1768708821486,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

 [31mâ¯[39m tests/integration/lifecycle-hooks-execution.test.ts [2m([22m[2m15 tests[22m[2m | [22m[33m15 skipped[39m[2m)[22m[33m 3642[2mms[22m[39m
       [2m[90mâ†“[39m[22m should execute beforePage hook and capture console output
       [2m[90mâ†“[39m[22m should execute beforePage hook with mutation mode enabled
       [2m[90mâ†“[39m[22m should handle errors gracefully without breaking workflow
       [2m[90mâ†“[39m[22m should execute afterPage hook with user input data
       [2m[90mâ†“[39m[22m should execute Python afterPage hook
       [2m[90mâ†“[39m[22m should execute beforeFinalBlock hook before document generation
       [2m[90mâ†“[39m[22m should execute afterDocumentsGenerated hook for cleanup
       [2m[90mâ†“[39m[22m should timeout hook that exceeds timeoutMs limit
       [2m[90mâ†“[39m[22m should execute multiple hooks in correct order
       [2m[90mâ†“[39m[22m should list all hooks for a workflow
       [2m[90mâ†“[39m[22m should update a hook
       [2m[90mâ†“[39m[22m should delete a hook
       [2m[90mâ†“[39m[22m should test a hook with sample data
       [2m[90mâ†“[39m[22m should retrieve execution logs for a run
       [2m[90mâ†“[39m[22m should clear execution logs for a run
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w47_v3, public
âœ… Enforced search_path: test_schema_w47_v3, public

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w46_v3
âœ… Current search_path: test_schema_w46_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w46_v3, public
âœ… Enforced search_path: test_schema_w46_v3, public

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w32_v3
âœ… Current search_path: test_schema_w45_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w52_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w52_v3 (Reused: true)

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w45_v3, public
âœ… Enforced search_path: test_schema_w45_v3, public

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w46_v3
âœ… Current search_path: test_schema_w46_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.expression-validation.test.ts[2m > [22m[2mExpression Validation API Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/api.expression-validation.test.ts[2m > [22m[2mExpression Validation API Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768708822519,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708822546,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.expression-validation.test.ts[2m > [22m[2mExpression Validation API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708822531,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708822531,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708822538,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708822539,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708822545,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708822545,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708822546,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708822546,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mðŸ“Š Schema test_schema_w52_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708822685,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

{"level":30,"time":1768708822843,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w49_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w49_v3 (Reused: true)

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":50,"time":1768708823166,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["8d6bc3d9-e7e5-44d9-8538-5147cc67bfbc","$2b$12$E8lRNVdJJtXYPsPLJ70HW.yh184qQ4IWWlMZAdlSd5S1V7eG10Rlq"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(8d6bc3d9-e7e5-44d9-8538-5147cc67bfbc) is not present in table \"users\".","schema":"test_schema_w38_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"8d6bc3d9-e7e5-44d9-8538-5147cc67bfbc","msg":"Failed to create user credentials"}
{"level":50,"time":1768708823166,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["8d6bc3d9-e7e5-44d9-8538-5147cc67bfbc","$2b$12$E8lRNVdJJtXYPsPLJ70HW.yh184qQ4IWWlMZAdlSd5S1V7eG10Rlq"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(8d6bc3d9-e7e5-44d9-8538-5147cc67bfbc) is not present in table \"users\".","schema":"test_schema_w38_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/api.expression-validation.test.ts[2m > [22m[2mExpression Validation API Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/api.expression-validation.test.ts:20:11

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708823183,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708823184,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mDEBUG: Existing functions: []

[DEBUG] BaseRepository.update collections: id=fce71d17-483c-4bcc-bde7-c77e2ba2fa9a, updates={"description":"Updated customer database"}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mðŸ“Š Schema test_schema_w49_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708823557,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708823558,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/api.expression-validation.test.ts [2m([22m[2m10 tests[22m[2m | [22m[33m10 skipped[39m[2m)[22m[33m 3722[2mms[22m[39m
       [2m[90mâ†“[39m[22m should validate a correct expression with valid variables
       [2m[90mâ†“[39m[22m should validate expression with string concatenation
       [2m[90mâ†“[39m[22m should reject expression with invalid syntax
       [2m[90mâ†“[39m[22m should reject without authentication
       [2m[90mâ†“[39m[22m should reject missing required fields
       [2m[90mâ†“[39m[22m should return available variables for a node
       [2m[90mâ†“[39m[22m should reject without authentication
       [2m[90mâ†“[39m[22m should reject non-existent workflow
       [2m[90mâ†“[39m[22m should return list of helper functions with metadata
       [2m[90mâ†“[39m[22m should reject without authentication
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

 [31mâ¯[39m tests/integration/externalSends.test.ts [2m([22m[2m2 tests[22m[2m | [22m[33m2 skipped[39m[2m)[22m[33m 3538[2mms[22m[39m
     [2m[90mâ†“[39m[22m PREVIEW MODE: Should simulate send and NOT call fetch
     [2m[90mâ†“[39m[22m LIVE MODE: Should call fetch with mapped payload
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708823731,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708823732,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w52_v3\",public"}
{"level":30,"time":1768708823787,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w52_v3\",public"}
{"level":30,"time":1768708823787,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w42_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w42_v3 (Reused: true)

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

{"level":30,"time":1768708824204,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708824204,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [31mâ¯[39m tests/integration/workflows/runtime-pipelines.test.ts [2m([22m[2m4 tests[22m[2m | [22m[33m4 skipped[39m[2m)[22m[33m 3627[2mms[22m[39m
       [2m[90mâ†“[39m[22m should create DataVault row on workflow completion
       [2m[90mâ†“[39m[22m should execute writebacks via RunService.completeRun()
       [2m[90mâ†“[39m[22m should skip document generation when visibleIf condition is false
       [2m[90mâ†“[39m[22m should generate document when visibleIf condition is true
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mðŸ“Š Schema test_schema_w42_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708824477,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708824478,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w42_v3\",public"}
{"level":30,"time":1768708824539,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w42_v3\",public"}
{"level":30,"time":1768708824539,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w52_v3, public
âœ… Enforced search_path: test_schema_w52_v3, public

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w52_v3
âœ… Current search_path: test_schema_w52_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708825183,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708825184,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/collections.e2e.test.ts [2m([22m[2m22 tests[22m[2m | [22m[31m17 failed[39m[2m)[22m[33m 5285[2mms[22m[39m
       [32mâœ“[39m should create a collection[32m 194[2mms[22m[39m
       [32mâœ“[39m should list collections[32m 51[2mms[22m[39m
       [32mâœ“[39m should get a collection by ID[32m 49[2mms[22m[39m
[31m       [31mÃ—[31m should update a collection[39m[32m 118[2mms[22m[39m
[31m       [31mÃ—[31m should create text field[39m[32m 47[2mms[22m[39m
[31m       [31mÃ—[31m should create email field[39m[32m 47[2mms[22m[39m
[31m       [31mÃ—[31m should create number field[39m[32m 50[2mms[22m[39m
[31m       [31mÃ—[31m should create select field with options[39m[32m 50[2mms[22m[39m
[31m       [31mÃ—[31m should create boolean field[39m[32m 56[2mms[22m[39m
[31m       [31mÃ—[31m should list all fields[39m[32m 65[2mms[22m[39m
[31m       [31mÃ—[31m should update field[39m[32m 53[2mms[22m[39m
[31m       [31mÃ—[31m should create a record[39m[32m 54[2mms[22m[39m
[31m       [31mÃ—[31m should create multiple records[39m[32m 51[2mms[22m[39m
[31m       [31mÃ—[31m should list records with pagination[39m[32m 96[2mms[22m[39m
[31m       [31mÃ—[31m should get a single record[39m[32m 46[2mms[22m[39m
[31m       [31mÃ—[31m should update a record[39m[32m 49[2mms[22m[39m
[31m       [31mÃ—[31m should find records by filters[39m[32m 97[2mms[22m[39m
[31m       [31mÃ—[31m should delete a record[39m[32m 48[2mms[22m[39m
[31m       [31mÃ—[31m should list collections with stats[39m[32m 158[2mms[22m[39m
       [32mâœ“[39m should enforce required fields[32m 153[2mms[22m[39m
[31m       [31mÃ—[31m should validate field types[39m[32m 148[2mms[22m[39m
       [32mâœ“[39m should delete collection (cascade fields and records)[32m 263[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w42_v3, public
âœ… Enforced search_path: test_schema_w42_v3, public

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w42_v3
âœ… Current search_path: test_schema_w42_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

{"level":30,"time":1768708826017,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708826113,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708826114,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w49_v3\",public"}
{"level":30,"time":1768708826174,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w49_v3\",public"}
{"level":30,"time":1768708826174,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w43_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w43_v3 (Reused: true)

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":40,"time":1768708826296,"env":"test","error":{},"msg":"PDF conversion failed"}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768708826330,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708826331,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w44_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [32mâœ“[39m tests/unit/docxRenderer.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 4515[2mms[22m[39m
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w44_v3 (Reused: true)

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w55_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w50_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w55_v3 (Reused: true)

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w50_v3 (Reused: true)

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/datavault.permissions.test.ts[2m > [22m[2mDataVault Table Permissions API (v4 Micro-Phase 6)
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/datavault.permissions.test.ts[2m > [22m[2mDataVault Table Permissions API (v4 Micro-Phase 6)
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768708826617,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mðŸ“Š Schema test_schema_w43_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/datavault.permissions.test.ts[2m > [22m[2mDataVault Table Permissions API (v4 Micro-Phase 6)
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708826644,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768708826643,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708826629,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708826630,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708826636,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708826637,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708826643,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708826643,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708826644,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708826644,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768708826644,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w43_v3\",public"}
{"level":30,"time":1768708826704,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w43_v3\",public"}
{"level":30,"time":1768708826704,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mðŸ“Š Schema test_schema_w44_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708826851,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708826852,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w44_v3\",public"}
{"level":30,"time":1768708826909,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w44_v3\",public"}
{"level":30,"time":1768708826909,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w54_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mðŸ“Š Schema test_schema_w55_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w53_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mðŸ“Š Schema test_schema_w50_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w54_v3 (Reused: true)

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w49_v3, public
âœ… Enforced search_path: test_schema_w49_v3, public

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w53_v3 (Reused: true)

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w49_v3
âœ… Current search_path: test_schema_w49_v3, public
â© Schema reused, skipping migrations.

{"level":50,"time":1768708827231,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["b30f1ada-f506-4a4d-9dfc-5528b3b43deb","$2b$12$PLcMVWyPPcPs2sHld4OnyuRkKiA/70HEGQ7s.yNh68X5lz8iRX1Xa"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b30f1ada-f506-4a4d-9dfc-5528b3b43deb) is not present in table \"users\".","schema":"test_schema_w43_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"b30f1ada-f506-4a4d-9dfc-5528b3b43deb","msg":"Failed to create user credentials"}
{"level":50,"time":1768708827231,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["b30f1ada-f506-4a4d-9dfc-5528b3b43deb","$2b$12$PLcMVWyPPcPs2sHld4OnyuRkKiA/70HEGQ7s.yNh68X5lz8iRX1Xa"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b30f1ada-f506-4a4d-9dfc-5528b3b43deb) is not present in table \"users\".","schema":"test_schema_w43_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstderr[2m | tests/integration/datavault.permissions.test.ts[2m > [22m[2mDataVault Table Permissions API (v4 Micro-Phase 6)
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/datavault.permissions.test.ts:22:11

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708827248,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708827248,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mðŸ“Š Schema test_schema_w54_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mðŸ“Š Schema test_schema_w53_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w43_v3, public
âœ… Enforced search_path: test_schema_w43_v3, public

 [31mâ¯[39m tests/integration/datavault.permissions.test.ts [2m([22m[2m22 tests[22m[2m | [22m[33m22 skipped[39m[2m)[22m[33m 3635[2mms[22m[39m
       [2m[90mâ†“[39m[22m should allow owner to read table
       [2m[90mâ†“[39m[22m should allow writer to read table
       [2m[90mâ†“[39m[22m should allow reader to read table
       [2m[90mâ†“[39m[22m should deny non-member from reading table
       [2m[90mâ†“[39m[22m should allow owner to update table
       [2m[90mâ†“[39m[22m should deny writer from updating table
       [2m[90mâ†“[39m[22m should deny reader from updating table
       [2m[90mâ†“[39m[22m should deny writer from deleting table
       [2m[90mâ†“[39m[22m should deny reader from deleting table
       [2m[90mâ†“[39m[22m should deny non-member from deleting table
       [2m[90mâ†“[39m[22m should allow owner to view permissions
       [2m[90mâ†“[39m[22m should deny writer from viewing permissions
       [2m[90mâ†“[39m[22m should deny reader from viewing permissions
       [2m[90mâ†“[39m[22m should allow owner to grant permissions
       [2m[90mâ†“[39m[22m should allow owner to update existing permission (upsert)
       [2m[90mâ†“[39m[22m should deny writer from granting permissions
       [2m[90mâ†“[39m[22m should prevent modifying table owner permissions
       [2m[90mâ†“[39m[22m should allow owner to revoke permissions
       [2m[90mâ†“[39m[22m should deny writer from revoking permissions
       [2m[90mâ†“[39m[22m should enforce owner includes write and read
       [2m[90mâ†“[39m[22m should enforce write includes read but not owner
       [2m[90mâ†“[39m[22m should enforce read is read-only
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w44_v3
âœ… Current search_path: test_schema_w44_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w56_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w44_v3, public
âœ… Enforced search_path: test_schema_w44_v3, public

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w56_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w44_v3
âœ… Current search_path: test_schema_w44_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768708827893,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mðŸ“Š Schema test_schema_w56_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708828148,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708828149,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w55_v3\",public"}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

{"level":30,"time":1768708828211,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w55_v3\",public"}
{"level":30,"time":1768708828211,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708828221,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708828222,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w50_v3\",public"}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

{"level":30,"time":1768708828276,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w50_v3\",public"}
{"level":30,"time":1768708828276,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w57_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w57_v3 (Reused: true)

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708828485,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708828487,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w54_v3\",public"}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708828512,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708828513,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w53_v3\",public"}
{"level":30,"time":1768708828559,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w54_v3\",public"}
{"level":30,"time":1768708828559,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708828578,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w53_v3\",public"}
{"level":30,"time":1768708828578,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768708828732,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w61_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708828759,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708828745,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708828745,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708828751,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708828752,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708828758,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708828758,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708828758,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708828759,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w61_v3 (Reused: true)

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mðŸ“Š Schema test_schema_w57_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768708828942,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768708828968,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708828952,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708828953,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708828959,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708828960,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708828967,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708828967,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708828967,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708828968,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w55_v3, public
âœ… Enforced search_path: test_schema_w55_v3, public

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w58_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w58_v3 (Reused: true)

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w50_v3, public
âœ… Enforced search_path: test_schema_w50_v3, public

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w55_v3
âœ… Current search_path: test_schema_w55_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708829125,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708829126,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w56_v3\",public"}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w48_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708829190,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w56_v3\",public"}
{"level":30,"time":1768708829190,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w50_v3
âœ… Current search_path: test_schema_w50_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mðŸ“Š Schema test_schema_w61_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w48_v3 (Reused: true)

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w54_v3, public
âœ… Enforced search_path: test_schema_w54_v3, public

{"level":30,"time":1768708829366,"env":"test","module":"user-credentials-repository","userId":"b3970b4b-d2ea-463f-b4d2-f071604d96ea","msg":"User credentials created"}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w53_v3, public
âœ… Enforced search_path: test_schema_w53_v3, public

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w53_v3
âœ… Current search_path: test_schema_w53_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w54_v3
âœ… Current search_path: test_schema_w54_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708829477,"env":"test","module":"user-credentials-repository","userId":"b2e09cdd-2d71-4d2a-ba02-bdaaf0a79f63","msg":"User credentials created"}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mðŸ“Š Schema test_schema_w58_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

{"level":50,"time":1768708829553,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["b2e09cdd-2d71-4d2a-ba02-bdaaf0a79f63","542706f6217f860c1305f5490b8d6cc519b34482ae43d3520086683887525718","2026-01-19T04:00:29.478Z"],"cause":{"length":383,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b2e09cdd-2d71-4d2a-ba02-bdaaf0a79f63) is not present in table \"users\".","schema":"test_schema_w46_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768708829557,"env":"test","module":"email-queue","jobId":"ea851b4f-922f-42dd-8dce-d0f238127e38","to":"test-ojEICE-MOnNrv71IazcCA@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstderr[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/jwt.authentication.test.ts:31:15

{"level":30,"time":1768708829567,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708829567,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708829644,"env":"test","module":"auth-routes","userId":"b3970b4b-d2ea-463f-b4d2-f071604d96ea","email":"test-ojEICE-MOnNrv71IazcCA@example.com","msg":"User registered"}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w59_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mðŸ“Š Schema test_schema_w48_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708829650,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w59_v3 (Reused: true)

{"level":30,"time":1768708829651,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w48_v3\",public"}
{"level":30,"time":1768708829705,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w48_v3\",public"}
{"level":30,"time":1768708829705,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708829823,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708829824,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w57_v3\",public"}
 [31mâ¯[39m tests/integration/auth/jwt.authentication.test.ts [2m([22m[2m27 tests[22m[2m | [22m[33m27 skipped[39m[2m)[22m[33m 3590[2mms[22m[39m
       [2m[90mâ†“[39m[22m should generate valid JWT token on successful login
       [2m[90mâ†“[39m[22m should include correct payload in JWT token
       [2m[90mâ†“[39m[22m should set JWT expiry to 15 minutes
       [2m[90mâ†“[39m[22m should accept valid JWT token on protected routes
       [2m[90mâ†“[39m[22m should reject request without authorization header
       [2m[90mâ†“[39m[22m should reject request with malformed token
       [2m[90mâ†“[39m[22m should accept request with missing Bearer prefix (lenient)
       [2m[90mâ†“[39m[22m should reject token with invalid signature
       [2m[90mâ†“[39m[22m should reject expired JWT token
       [2m[90mâ†“[39m[22m should return token_expired error code for expired tokens
       [2m[90mâ†“[39m[22m should authenticate with Bearer token in Authorization header
       [2m[90mâ†“[39m[22m should work with Bearer token on POST requests
       [2m[90mâ†“[39m[22m should work with Bearer token on PUT requests
       [2m[90mâ†“[39m[22m should work with Bearer token on DELETE requests
       [2m[90mâ†“[39m[22m should exchange valid session cookie for JWT token
       [2m[90mâ†“[39m[22m should reject token exchange without valid cookie
       [2m[90mâ†“[39m[22m should prefer Bearer token over cookie when both present
       [2m[90mâ†“[39m[22m should fall back to cookie if Bearer token is invalid
       [2m[90mâ†“[39m[22m should allow GET requests with cookie auth only
       [2m[90mâ†“[39m[22m should reject POST requests with cookie auth only (mutation-strict)
       [2m[90mâ†“[39m[22m should allow anonymous access to public workflows
       [2m[90mâ†“[39m[22m should attach user info if authenticated on optional auth routes
       [2m[90mâ†“[39m[22m should refresh access token using refresh token
       [2m[90mâ†“[39m[22m should rotate refresh token on use
       [2m[90mâ†“[39m[22m should detect token reuse and revoke all user tokens
       [2m[90mâ†“[39m[22m should revoke refresh token on logout
       [2m[90mâ†“[39m[22m should clear refresh token cookie on logout
{"level":30,"time":1768708829885,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w57_v3\",public"}
{"level":30,"time":1768708829885,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

[90mstderr[2m | tests/ui/datavault/EditableCell.test.tsx[2m > [22m[2mEditableCell Component[2m > [22m[2mError Handling[2m > [22m[2mreverts value on save error
[22m[39mFailed to save cell: Error: Network error
    at C:/Users/scoot/poll/VaultLogic/tests/ui/datavault/EditableCell.test.tsx:206:36
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w60_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w56_v3, public
âœ… Enforced search_path: test_schema_w56_v3, public

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w60_v3 (Reused: true)

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708830045,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708830046,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w61_v3\",public"}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w56_v3
âœ… Current search_path: test_schema_w56_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mðŸ“Š Schema test_schema_w59_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708830105,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w61_v3\",public"}
{"level":30,"time":1768708830105,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/ui/datavault/EditableCell.test.tsx[2m > [22m[2mEditableCell Component[2m > [22m[2mError Handling[2m > [22m[2mdisplays error indicator on save failure
[22m[39mFailed to save cell: Error: Network error
    at C:/Users/scoot/poll/VaultLogic/tests/ui/datavault/EditableCell.test.tsx:222:36
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mðŸ“Š Schema test_schema_w60_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708830433,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768708830434,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w58_v3\",public"}
[90mstderr[2m | tests/ui/datavault/EditableCell.test.tsx[2m > [22m[2mEditableCell Component[2m > [22m[2mBoolean Type (Checkbox)[2m > [22m[2mshows loading spinner when saving checkbox
[22m[39mWarning: An update to EditableCell inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at EditableCell (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/EditableCell.tsx:12:25)

{"level":50,"time":1768708830458,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["a57d5e38-743c-4156-9373-0626c88dd274","$2b$12$C6y/2ADMV1G77s3d/.t3peiFcapJXMOQaQu6e5gFju/OOkzX8De22"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(a57d5e38-743c-4156-9373-0626c88dd274) is not present in table \"users\".","schema":"test_schema_w48_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"a57d5e38-743c-4156-9373-0626c88dd274","msg":"Failed to create user credentials"}
{"level":50,"time":1768708830458,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["a57d5e38-743c-4156-9373-0626c88dd274","$2b$12$C6y/2ADMV1G77s3d/.t3peiFcapJXMOQaQu6e5gFju/OOkzX8De22"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(a57d5e38-743c-4156-9373-0626c88dd274) is not present in table \"users\".","schema":"test_schema_w48_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768708830473,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK initialized successfully"}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w48_v3, public
âœ… Enforced search_path: test_schema_w48_v3, public

{"level":30,"time":1768708830493,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w58_v3\",public"}
{"level":30,"time":1768708830493,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708830474,"env":"test","module":"telemetry","msg":"Prometheus metrics initialized"}
{"level":30,"time":1768708830557,"env":"test","msg":"Master key validated successfully"}
{"level":30,"time":1768708830557,"env":"test","provider":"gemini","model":"gemini-2.0-flash","msg":"AI Service configured and ready"}
{"level":30,"time":1768708830557,"env":"test","msg":"Initializing database..."}
{"level":30,"time":1768708830557,"env":"test","msg":"Database initialized."}
{"level":30,"time":1768708830558,"env":"test","module":"email-queue","intervalMs":5000,"msg":"Starting email queue worker"}
Sourcemap for "C:/Users/scoot/poll/VaultLogic/node_modules/node-cron/dist/esm/node-cron.js" points to missing source files
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w48_v3
âœ… Current search_path: test_schema_w48_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708830640,"env":"test","module":"cron","msg":"Initializing cron jobs..."}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w57_v3, public
âœ… Enforced search_path: test_schema_w57_v3, public

{"level":30,"time":1768708830708,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708830677,"env":"test","module":"cron","msg":"Cron jobs initialized"}
{"level":30,"time":1768708830678,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768708830690,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708830691,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708830700,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708830700,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708830707,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708830707,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708830707,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708830708,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768708830708,"env":"test","msg":"Loading Vite for development..."}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w57_v3
âœ… Current search_path: test_schema_w57_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708830820,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708830820,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w61_v3, public
âœ… Enforced search_path: test_schema_w61_v3, public

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32mâœ“[39m tests/ui/datavault/EditableCell.test.tsx [2m([22m[2m29 tests[22m[2m)[22m[33m 8229[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w61_v3
âœ… Current search_path: test_schema_w61_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708831122,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708831123,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w59_v3\",public"}
{"level":30,"time":1768708831175,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w59_v3\",public"}
{"level":30,"time":1768708831175,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708831178,"env":"test","source":"express","msg":"ðŸ“¦ vite.ts module loaded successfully"}
{"level":30,"time":1768708831178,"env":"test","msg":"Vite module loaded, calling setupVite..."}
{"level":30,"time":1768708831179,"env":"test","source":"express","msg":"ðŸ“ setupVite: Starting Vite setup..."}
{"level":30,"time":1768708831179,"env":"test","source":"express","msg":"ðŸ“ setupVite: Resolving Vite config..."}
{"level":30,"time":1768708831185,"env":"test","source":"express","msg":"ðŸ“ setupVite: Vite config resolved"}
{"level":30,"time":1768708831185,"env":"test","source":"express","msg":"ðŸ“ setupVite: Server options prepared, creating Vite server..."}
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould validate expression after debounce
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

{"level":50,"time":1768708831279,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["364e7f2a-b2c0-42bd-9672-b593634e9335","$2b$12$.97WpKE.B/1qBVIVhyrvNOle.srzGYNfVSe5/Ual0OQJIuORNVdJK"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(364e7f2a-b2c0-42bd-9672-b593634e9335) is not present in table \"users\".","schema":"test_schema_w48_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"364e7f2a-b2c0-42bd-9672-b593634e9335","msg":"Failed to create user credentials"}
{"level":50,"time":1768708831279,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["364e7f2a-b2c0-42bd-9672-b593634e9335","$2b$12$.97WpKE.B/1qBVIVhyrvNOle.srzGYNfVSe5/Ual0OQJIuORNVdJK"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(364e7f2a-b2c0-42bd-9672-b593634e9335) is not present in table \"users\".","schema":"test_schema_w48_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768708831285,"env":"test","source":"express","msg":"ðŸ“ setupVite: Vite server created successfully"}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w58_v3, public
âœ… Enforced search_path: test_schema_w58_v3, public

{"level":30,"time":1768708831285,"env":"test","source":"express","msg":"ðŸ“ setupVite: Mounting Vite middlewares..."}
{"level":30,"time":1768708831285,"env":"test","source":"express","msg":"ðŸ“ setupVite: Vite middlewares mounted"}
{"level":30,"time":1768708831285,"env":"test","source":"express","msg":"ðŸ“ setupVite: Vite setup complete!"}
{"level":30,"time":1768708831285,"env":"test","msg":"Vite setup complete"}
{"level":30,"time":1768708831290,"env":"test","source":"express","msg":"serving on port 5000"}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w58_v3
âœ… Current search_path: test_schema_w58_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708831423,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768708831425,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould return validation errors for invalid expression
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708831535,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708831536,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w60_v3\",public"}
 [32mâœ“[39m tests/ui/datavault/TableCard.test.tsx [2m([22m[2m8 tests[22m[2m)[22m[33m 5481[2mms[22m[39m
     [33m[2mâœ“[22m[39m should call onDelete when delete button is clicked [33m 952[2mms[22m[39m
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768708831591,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w60_v3\",public"}
{"level":30,"time":1768708831591,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould return validation errors for invalid expression
[22m[39mValidation Result DEBUG: {"ok":false,"errors":[{"message":"Unknown identifier: unknown_var","start":{"line":0,"col":0},"end":{"line":0,"col":11}}]}
IsValid DEBUG: [33mfalse[39m

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould debounce validation calls
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

{"level":30,"time":1768708831733,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768708831759,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/js_helpers.test.ts[2m > [22m[2mDetailed Verification: JS Helper Availability
[22m[39mðŸ“š API Documentation available at /api-docs

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould not validate when workflowId or nodeId is missing
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould not validate when workflowId or nodeId is missing
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

{"level":30,"time":1768708831746,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708831747,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708831752,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708831753,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708831759,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708831759,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708831759,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708831759,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression validation integration[2m > [22m[2mshould validate helper functions in expressions
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w59_v3, public
âœ… Enforced search_path: test_schema_w59_v3, public

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w59_v3
âœ… Current search_path: test_schema_w59_v3, public
â© Schema reused, skipping migrations.

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression validation integration[2m > [22m[2mshould validate complex expressions with multiple helpers
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

{"level":30,"time":1768708832124,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708832124,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768708832141,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["2e1d2ba9-0f80-4f20-8097-fc9f05ac7652","$2b$12$5pW/U.Fyfm7q4L.7278xtOGqpZJDhRxnmHv9ieLLPFqgoG.3c49Bu"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(2e1d2ba9-0f80-4f20-8097-fc9f05ac7652) is not present in table \"users\".","schema":"test_schema_w46_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"2e1d2ba9-0f80-4f20-8097-fc9f05ac7652","msg":"Failed to create user credentials"}
{"level":50,"time":1768708832141,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["2e1d2ba9-0f80-4f20-8097-fc9f05ac7652","$2b$12$5pW/U.Fyfm7q4L.7278xtOGqpZJDhRxnmHv9ieLLPFqgoG.3c49Bu"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(2e1d2ba9-0f80-4f20-8097-fc9f05ac7652) is not present in table \"users\".","schema":"test_schema_w46_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx[2m > [22m[2mTableGridView - Drag & Drop[2m > [22m[2mrenders DndContext wrapper
[22m[39mWarning: validateDOMNesting(...): <th> cannot appear as a child of <div>.
    at th
    at SortableColumnHeader (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/SortableColumnHeader.tsx:12:33)
    at div
    at SortableContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:26:23)
    at tr
    at thead
    at table
    at div
    at DndContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:18:18)
    at div
    at div
    at TableGridView (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/TableGridView.tsx:32:26)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
Warning: validateDOMNesting(...): <div> cannot appear as a child of <tr>.
    at div
    at SortableContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:26:23)
    at tr
    at thead
    at table
    at div
    at DndContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:18:18)
    at div
    at div
    at TableGridView (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/TableGridView.tsx:32:26)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

 [32mâœ“[39m tests/unit/utils/conditionalLogic.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 3781[2mms[22m[39m
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression validation integration[2m > [22m[2mshould handle syntax errors
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

{"level":30,"time":1768708832348,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708832349,"env":"test","msg":"DB: pool closed."}
{"level":40,"time":1768708832363,"env":"test","workflowId":"7c1046b3-fa3b-4c19-9229-2bfc888a073a","msg":"No current or pinned version found for workflow, run might be unstable"}
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression Editor component behavior[2m > [22m[2mshould update validation when expression changes
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w60_v3, public
âœ… Enforced search_path: test_schema_w60_v3, public

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w60_v3
âœ… Current search_path: test_schema_w60_v3, public
â© Schema reused, skipping migrations.

 [32mâœ“[39m tests/unit/collab.client.test.tsx [2m([22m[2m17 tests[22m[2m)[22m[33m 5874[2mms[22m[39m
     [33m[2mâœ“[22m[39m should add a comment [33m 460[2mms[22m[39m
     [33m[2mâœ“[22m[39m should allow comment owner to delete their comment [33m 401[2mms[22m[39m
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression Editor component behavior[2m > [22m[2mshould update validation when expression changes
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

{"level":30,"time":1768708832631,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708832632,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/components/datavault/TableGridView.test.tsx [2m([22m[2m9 tests[22m[2m)[22m[33m 6585[2mms[22m[39m
     [33m[2mâœ“[22m[39m loads table schema and rows [33m 426[2mms[22m[39m
     [33m[2mâœ“[22m[39m enters edit mode on double click [33m 335[2mms[22m[39m
     [33m[2mâœ“[22m[39m updates cell value on blur [33m 641[2mms[22m[39m
     [33m[2mâœ“[22m[39m renders delete button for each row [33m 434[2mms[22m[39m
{"level":30,"time":1768708832812,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708832813,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

 [32mâœ“[39m tests/ui/expression-editor.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 5620[2mms[22m[39m
       [33m[2mâœ“[22m[39m should update validation when expression changes [33m 441[2mms[22m[39m
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

{"level":30,"time":1768708832960,"env":"test","module":"user-credentials-repository","userId":"c89d3731-dc51-47da-aee5-b09c849dcfeb","msg":"User credentials created"}
{"level":30,"time":1768708833107,"env":"test","module":"runs-routes","runId":"4ff43da8-ec8a-4d15-9bfa-8c83f65d5ec1","sectionId":"eddcb02c-0aef-48d1-9876-da9ad6204efd","valuesType":"object","isArray":true,"valuesLength":0,"bodyKeys":["values"],"msg":"Section submit request received"}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w51_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708833219,"env":"test","module":"email-queue","jobId":"3450d634-ae97-4f14-a475-929fa99a15d3","to":"middleware-test-umAAmS9yPqMY-gtE8sjlS@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708833301,"env":"test","module":"auth-routes","userId":"c89d3731-dc51-47da-aee5-b09c849dcfeb","email":"middleware-test-umAAmS9yPqMY-gtE8sjlS@example.com","msg":"User registered"}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w65_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w65_v3 (Reused: true)

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

{"level":40,"time":1768708833564,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":30,"time":1768708833574,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708833575,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w51_v3 (Reused: true)

 [32mâœ“[39m tests/unit/components/datavault/TableGridViewDragDrop.test.tsx [2m([22m[2m7 tests[22m[2m)[22m[33m 5653[2mms[22m[39m
     [33m[2mâœ“[22m[39m displays columns in order based on orderIndex [33m 872[2mms[22m[39m
{"level":30,"time":1768708833757,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708833758,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w62_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708833772,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708833772,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w66_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w62_v3 (Reused: true)

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w66_v3 (Reused: true)

 [32mâœ“[39m tests/unit/components/datavault/CellRenderer.test.tsx [2m([22m[2m12 tests[22m[2m)[22m[33m 5176[2mms[22m[39m
     [33m[2mâœ“[22m[39m renders boolean value as Yes/No [33m 527[2mms[22m[39m
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mðŸ“Š Schema test_schema_w65_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708833898,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708833898,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/ui/runs.components.test.tsx [2m([22m[2m19 tests[22m[2m)[22m[33m 7255[2mms[22m[39m
       [33m[2mâœ“[22m[39m should show download options for successful runs [33m 1313[2mms[22m[39m
       [33m[2mâœ“[22m[39m should call onChange when status filter changes [33m 585[2mms[22m[39m
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w67_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [32mâœ“[39m tests/ui/common/Breadcrumbs.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 4397[2mms[22m[39m
{"level":30,"time":1768708833988,"env":"test","module":"auth-routes","userId":"c89d3731-dc51-47da-aee5-b09c849dcfeb","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w67_v3 (Reused: true)

{"level":30,"time":1768708834065,"env":"test","module":"audit-log-service","userId":"c89d3731-dc51-47da-aee5-b09c849dcfeb","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mðŸ“Š Schema test_schema_w51_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708834174,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708834176,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w51_v3\",public"}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mðŸ“Š Schema test_schema_w62_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

{"level":30,"time":1768708834246,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mðŸ“Š Schema test_schema_w66_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708834246,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708834245,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w51_v3\",public"}
{"level":30,"time":1768708834259,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

 [32mâœ“[39m tests/ui/datavault/DatabaseSettingsPage.test.tsx [2m([22m[2m7 tests[22m[2m)[22m[33m 5042[2mms[22m[39m
     [33m[2mâœ“[22m[39m should render database settings page with breadcrumbs [33m 428[2mms[22m[39m
{"level":30,"time":1768708834412,"env":"test","module":"runs-routes","runId":"4ff43da8-ec8a-4d15-9bfa-8c83f65d5ec1","sectionId":"eddcb02c-0aef-48d1-9876-da9ad6204efd","msg":"Section submitted successfully"}
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mðŸ“Š Schema test_schema_w67_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768708834476,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708834476,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w63_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w63_v3 (Reused: true)

 [31mâ¯[39m tests/integration/js_helpers.test.ts [2m([22m[2m1 test[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 5695[2mms[22m[39m
[31m     [31mÃ—[31m should execute a JS block that uses helper functions[39m[33m 2438[2mms[22m[39m
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w69_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708834992,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708834993,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w65_v3\",public"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w69_v3 (Reused: true)

{"level":30,"time":1768708835052,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w65_v3\",public"}
{"level":30,"time":1768708835052,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w51_v3, public
âœ… Enforced search_path: test_schema_w51_v3, public

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w71_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w70_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mðŸ“Š Schema test_schema_w63_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w71_v3 (Reused: true)

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w51_v3
âœ… Current search_path: test_schema_w51_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w70_v3 (Reused: true)

{"level":40,"time":1768708835236,"env":"test","module":"auth-middleware","error":{"name":"TokenExpiredError","code":"AUTH_002","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768708835237,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w64_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708835354,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708835355,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w66_v3\",public"}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w64_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

{"level":30,"time":1768708835412,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w66_v3\",public"}
{"level":30,"time":1768708835412,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708835427,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708835427,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w67_v3\",public"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mðŸ“Š Schema test_schema_w69_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708835457,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708835458,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w62_v3\",public"}
{"level":30,"time":1768708835481,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w67_v3\",public"}
{"level":30,"time":1768708835481,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708835515,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w62_v3\",public"}
{"level":30,"time":1768708835515,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mðŸ“Š Schema test_schema_w71_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mðŸ“Š Schema test_schema_w70_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w73_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w73_v3 (Reused: true)

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

{"level":30,"time":1768708835715,"env":"test","module":"user-credentials-repository","userId":"58063285-94f0-4d4f-963f-7f9636975e82","msg":"User credentials created"}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mðŸ“Š Schema test_schema_w64_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w74_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w65_v3, public
âœ… Enforced search_path: test_schema_w65_v3, public

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w74_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w65_v3
âœ… Current search_path: test_schema_w65_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708836043,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708836045,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w63_v3\",public"}
{"level":30,"time":1768708836057,"env":"test","module":"email-queue","jobId":"badd8539-a09f-49fb-841d-c273e67f2ddb","to":"middleware-test-RhZT7-PGTnZNJMJ7_mrrr@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mðŸ“Š Schema test_schema_w73_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768708836104,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w63_v3\",public"}
{"level":30,"time":1768708836104,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w66_v3, public
âœ… Enforced search_path: test_schema_w66_v3, public

{"level":30,"time":1768708836215,"env":"test","module":"auth-routes","userId":"58063285-94f0-4d4f-963f-7f9636975e82","email":"middleware-test-RhZT7-PGTnZNJMJ7_mrrr@example.com","msg":"User registered"}
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w67_v3, public
âœ… Enforced search_path: test_schema_w67_v3, public

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w66_v3
âœ… Current search_path: test_schema_w66_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w62_v3, public
âœ… Enforced search_path: test_schema_w62_v3, public

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708836305,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708836306,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w69_v3\",public"}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mðŸ“Š Schema test_schema_w74_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708836354,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w69_v3\",public"}
{"level":30,"time":1768708836354,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708836359,"env":"test","module":"email-queue","jobId":"3450d634-ae97-4f14-a475-929fa99a15d3","msg":"Email job completed"}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w67_v3
âœ… Current search_path: test_schema_w67_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w62_v3
âœ… Current search_path: test_schema_w62_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708836400,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708836400,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768708836429,"env":"test","module":"auth-routes","userId":"58063285-94f0-4d4f-963f-7f9636975e82","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708836430,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708836431,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w71_v3\",public"}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708836465,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708836465,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w70_v3\",public"}
{"level":30,"time":1768708836484,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w71_v3\",public"}
{"level":30,"time":1768708836484,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768708836521,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w70_v3\",public"}
{"level":30,"time":1768708836521,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768708836562,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould authenticate with JWT Bearer token
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:74:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstderr[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould authenticate with JWT Bearer token
[22m[39mLogin Failed! [33m401[39m {
  success: [33mfalse[39m,
  error: {
    code: [32m'AUTH_004'[39m,
    message: [32m'Invalid credentials'[39m,
    details: { errorType: [32m'InvalidCredentialsError'[39m },
    timestamp: [32m'2026-01-18T04:00:36.570Z'[39m
  }
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould authenticate with JWT Bearer token
[22m[39mUser in DB: [90mundefined[39m

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w68_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708836722,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708836723,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w64_v3\",public"}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w68_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mâœ… Applied failsafe schema fixes

 [32mâœ“[39m tests/integration/api-docs.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 5839[2mms[22m[39m
{"level":30,"time":1768708836777,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w64_v3\",public"}
{"level":30,"time":1768708836777,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708836895,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708836896,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w73_v3\",public"}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w63_v3, public
âœ… Enforced search_path: test_schema_w63_v3, public

{"level":30,"time":1768708836954,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w73_v3\",public"}
{"level":30,"time":1768708836954,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w63_v3
âœ… Current search_path: test_schema_w63_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708837020,"env":"test","module":"user-credentials-repository","userId":"108aff43-9ac8-4011-850b-fef9f749c775","msg":"User credentials created"}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708837107,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708837108,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mðŸ“Š Schema test_schema_w68_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32mâœ“[39m tests/unit/services/repeater.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 4091[2mms[22m[39m
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w69_v3, public
âœ… Enforced search_path: test_schema_w69_v3, public

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708837187,"env":"test","module":"email-queue","jobId":"f7f40121-d5cb-4be3-9144-ab6f109c2068","to":"middleware-test-Mnhji8TS9S5FaKfFzUelL@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708837194,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708837196,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w74_v3\",public"}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768708837234,"env":"test","module":"auth-routes","userId":"108aff43-9ac8-4011-850b-fef9f749c775","email":"middleware-test-Mnhji8TS9S5FaKfFzUelL@example.com","msg":"User registered"}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768708837255,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w74_v3\",public"}
{"level":30,"time":1768708837255,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w69_v3
âœ… Current search_path: test_schema_w69_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w71_v3, public
âœ… Enforced search_path: test_schema_w71_v3, public

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w70_v3, public
âœ… Enforced search_path: test_schema_w70_v3, public

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w71_v3
âœ… Current search_path: test_schema_w71_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w70_v3
âœ… Current search_path: test_schema_w70_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w72_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708837469,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708837469,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w72_v3 (Reused: true)

 [32mâœ“[39m tests/unit/utils/encryption.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 4095[2mms[22m[39m
{"level":30,"time":1768708837541,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708837541,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/WorkflowChangeAnalyzer.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 3992[2mms[22m[39m
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w64_v3, public
âœ… Enforced search_path: test_schema_w64_v3, public

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w64_v3
âœ… Current search_path: test_schema_w64_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w75_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708837730,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708837730,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w73_v3, public
âœ… Enforced search_path: test_schema_w73_v3, public

{"level":30,"time":1768708837757,"env":"test","module":"auth-routes","userId":"108aff43-9ac8-4011-850b-fef9f749c775","msg":"User logged in successfully"}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w75_v3 (Reused: true)

 [32mâœ“[39m tests/unit/components/datavault/SortableColumnHeader.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 4481[2mms[22m[39m
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708837838,"env":"test","module":"audit-log-service","userId":"108aff43-9ac8-4011-850b-fef9f749c775","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w73_v3
âœ… Current search_path: test_schema_w73_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mðŸ“Š Schema test_schema_w72_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708838026,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708838027,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w68_v3\",public"}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w74_v3, public
âœ… Enforced search_path: test_schema_w74_v3, public

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708838096,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w68_v3\",public"}
{"level":30,"time":1768708838096,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w74_v3
âœ… Current search_path: test_schema_w74_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mðŸ“Š Schema test_schema_w75_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

{"level":30,"time":1768708838285,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK initialized successfully"}
{"level":30,"time":1768708838285,"env":"test","module":"telemetry","msg":"Prometheus metrics initialized"}
{"level":30,"time":1768708838287,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768708838319,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK shut down successfully"}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w76_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w76_v3 (Reused: true)

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w77_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708838377,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK initialized successfully"}
{"level":30,"time":1768708838377,"env":"test","module":"telemetry","msg":"Prometheus metrics initialized"}
{"level":30,"time":1768708838377,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":40,"time":1768708838382,"env":"test","module":"metrics-routes","ip":"::ffff:127.0.0.1","msg":"Unauthorized metrics access attempt"}
{"level":30,"time":1768708838393,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK shut down successfully"}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708838394,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708838394,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708838408,"env":"test","module":"user-credentials-repository","userId":"ec21d4be-a173-469a-87a2-409295ad4429","msg":"User credentials created"}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w77_v3 (Reused: true)

{"level":50,"time":1768708838455,"env":"test","module":"workflow-patch-service","error":{},"op":{"op":"step.create","sectionRef":"temp-section-1","type":"short_text","title":"Field 1","alias":"field1"},"msg":"Failed to apply operation"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":50,"time":1768708838463,"env":"test","module":"workflow-patch-service","error":{},"op":{"op":"document.bindFields","id":"template-123","bindings":{"client_name":"nonExistentAlias"}},"msg":"Failed to apply operation"}
{"level":30,"time":1768708838467,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708838468,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/metrics.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 4353[2mms[22m[39m
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w78_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [32mâœ“[39m tests/unit/services/WorkflowPatchService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 3932[2mms[22m[39m
{"level":30,"time":1768708838508,"env":"test","module":"email-queue","jobId":"1f244cb9-acf2-433c-a2a3-1fb4718dfbe8","to":"middleware-test-emMZdpn8ir0bxFR1EejBp@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708838539,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708838539,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w78_v3 (Reused: true)

{"level":30,"time":1768708838555,"env":"test","module":"auth-routes","userId":"ec21d4be-a173-469a-87a2-409295ad4429","email":"middleware-test-emMZdpn8ir0bxFR1EejBp@example.com","msg":"User registered"}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768708838565,"env":"test","status":401,"statusText":"Unauthorized","error":"Invalid client credentials","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768708838566,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768708838568,"env":"test","data":{"token_type":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768708838568,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768708838569,"env":"test","data":{"access_token":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768708838569,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768708838570,"env":"test","error":"Network error: ECONNREFUSED","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
 [32mâœ“[39m tests/unit/shared/validation/PageValidator.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 3835[2mms[22m[39m
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768708838676,"env":"test","error":"Invalid credentials","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":50,"time":1768708838676,"env":"test","error":"ECONNREFUSED","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768708838678,"env":"test","status":400,"statusText":"Bad Request","error":"Invalid grant_type","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768708838678,"env":"test","error":"OAuth2 token request failed: 400 Bad Request","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768708838679,"env":"test","status":401,"statusText":"Unauthorized","error":"Client authentication failed","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768708838679,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768708838680,"env":"test","status":403,"statusText":"Forbidden","error":"Access denied","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768708838680,"env":"test","error":"OAuth2 token request failed: 403 Forbidden","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768708838680,"env":"test","status":500,"statusText":"Internal Server Error","error":"Server error","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768708838680,"env":"test","error":"OAuth2 token request failed: 500 Internal Server Error","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768708838681,"env":"test","error":"Unexpected token in JSON","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768708838681,"env":"test","error":"Request timeout","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":30,"time":1768708838682,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708838683,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w79_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 3965[2mms[22m[39m
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w79_v3 (Reused: true)

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mðŸ“Š Schema test_schema_w76_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mðŸ“Š Schema test_schema_w77_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708838839,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708838841,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w72_v3\",public"}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

{"level":30,"time":1768708838857,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708838858,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w68_v3, public
âœ… Enforced search_path: test_schema_w68_v3, public

 [32mâœ“[39m tests/ui/blocks/SendDataToTableBlockEditor.test.tsx [2m([22m[2m12 tests[22m[2m)[22m[33m 4265[2mms[22m[39m
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708838935,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w72_v3\",public"}
{"level":30,"time":1768708838936,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mreviseWorkflow should delegate to revision service
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mWorkflow Generation[2m > [22m[2mgenerateWorkflow should return a generated workflow
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mWorkflow Suggestions[2m > [22m[2msuggestWorkflowImprovements should return suggestions
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mWorkflow Suggestions[2m > [22m[2msuggestTemplateBindings should return bindings
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mWorkflow Suggestions[2m > [22m[2msuggestValues should return values
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mLogic Analysis[2m > [22m[2mgenerateLogic should return logic rules
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mLogic Analysis[2m > [22m[2mdebugLogic should return issues
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mLogic Analysis[2m > [22m[2mvisualizeLogic should return graph data
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w68_v3
âœ… Current search_path: test_schema_w68_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708838976,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708838976,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mðŸ“Š Schema test_schema_w78_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

 [32mâœ“[39m tests/unit/services/AIService.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 3779[2mms[22m[39m
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708839062,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708839063,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w75_v3\",public"}
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768708839123,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w75_v3\",public"}
{"level":30,"time":1768708839123,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708839140,"env":"test","module":"auth-routes","userId":"ec21d4be-a173-469a-87a2-409295ad4429","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mðŸ“Š Schema test_schema_w79_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708839194,"env":"test","module":"audit-log-service","userId":"ec21d4be-a173-469a-87a2-409295ad4429","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768708839200,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768708839325,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708839326,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/api.ai.test.ts [2m([22m[2m32 tests[22m[2m)[22m[33m 3904[2mms[22m[39m
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

{"level":30,"time":1768708839623,"env":"test","module":"user-credentials-repository","userId":"9f5ce836-12db-446b-a40d-31fea5044cb6","msg":"User credentials created"}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

{"level":30,"time":1768708839725,"env":"test","module":"email-queue","jobId":"158c9ecb-d1ec-4435-a146-ecd54e5416ae","to":"middleware-test-owYsL3AN-1MOw19bCfiD9@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w72_v3, public
âœ… Enforced search_path: test_schema_w72_v3, public

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708839777,"env":"test","module":"auth-routes","userId":"9f5ce836-12db-446b-a40d-31fea5044cb6","email":"middleware-test-owYsL3AN-1MOw19bCfiD9@example.com","msg":"User registered"}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w81_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mâœ… Database initialized. Current schema: test_schema_w72_v3
âœ… Current search_path: test_schema_w72_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708839875,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708839876,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w77_v3\",public"}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w81_v3 (Reused: true)

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w80_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w75_v3, public
âœ… Enforced search_path: test_schema_w75_v3, public

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w82_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708839930,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w77_v3\",public"}
{"level":30,"time":1768708839930,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w83_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708839949,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708839950,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w76_v3\",public"}
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w80_v3 (Reused: true)

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w82_v3 (Reused: true)

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w83_v3 (Reused: true)

{"level":30,"time":1768708839998,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708839998,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w78_v3\",public"}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w75_v3
âœ… Current search_path: test_schema_w75_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708840007,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w76_v3\",public"}
{"level":30,"time":1768708840007,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w84_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708840049,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w78_v3\",public"}
{"level":30,"time":1768708840049,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w84_v3 (Reused: true)

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708840153,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708840154,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w79_v3\",public"}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w85_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708840211,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w79_v3\",public"}
{"level":30,"time":1768708840211,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708840251,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w85_v3 (Reused: true)

{"level":30,"time":1768708840252,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/ui/datavault/ColumnTypeIcon.test.tsx [2m([22m[2m27 tests[22m[2m)[22m[33m 4013[2mms[22m[39m
{"level":30,"time":1768708840322,"env":"test","module":"auth-routes","userId":"9f5ce836-12db-446b-a40d-31fea5044cb6","msg":"User logged in successfully"}
{"level":30,"time":1768708840375,"env":"test","module":"audit-log-service","userId":"9f5ce836-12db-446b-a40d-31fea5044cb6","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w86_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":50,"time":1768708840383,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mðŸ“Š Schema test_schema_w81_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mðŸ“Š Schema test_schema_w80_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w86_v3 (Reused: true)

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mðŸ“Š Schema test_schema_w82_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mðŸ“Š Schema test_schema_w83_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mðŸ“Š Schema test_schema_w84_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mðŸ“Š Schema test_schema_w85_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w77_v3, public
âœ… Enforced search_path: test_schema_w77_v3, public

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768708840773,"env":"test","module":"user-credentials-repository","userId":"1032fa66-9182-471e-b3bc-53cba97bb5a1","msg":"User credentials created"}
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w76_v3, public
âœ… Enforced search_path: test_schema_w76_v3, public

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w77_v3
âœ… Current search_path: test_schema_w77_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w78_v3, public
âœ… Enforced search_path: test_schema_w78_v3, public

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mðŸ“Š Schema test_schema_w86_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708840881,"env":"test","module":"email-queue","jobId":"6b32b42f-0582-4265-9242-37ace9b30e20","to":"middleware-test-Oe41FV6XKKY_S3lRZlTe6@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w76_v3
âœ… Current search_path: test_schema_w76_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

{"level":30,"time":1768708840931,"env":"test","module":"auth-routes","userId":"1032fa66-9182-471e-b3bc-53cba97bb5a1","email":"middleware-test-Oe41FV6XKKY_S3lRZlTe6@example.com","msg":"User registered"}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w78_v3
âœ… Current search_path: test_schema_w78_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w79_v3, public
âœ… Enforced search_path: test_schema_w79_v3, public

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w79_v3
âœ… Current search_path: test_schema_w79_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708841165,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708841165,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708841166,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708841166,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/ui/blocks/SendDataBlockEditorRouting.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 3846[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w87_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [32mâœ“[39m tests/ui/datavault/TemplateCard.test.tsx [2m([22m[2m6 tests[22m[2m)[22m[33m 4136[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w87_v3 (Reused: true)

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708841298,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708841299,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w80_v3\",public"}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708841312,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708841313,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w81_v3\",public"}
{"level":30,"time":1768708841363,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w80_v3\",public"}
{"level":30,"time":1768708841363,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708841373,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708841373,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708841374,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w82_v3\",public"}
{"level":30,"time":1768708841374,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w83_v3\",public"}
{"level":30,"time":1768708841379,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w81_v3\",public"}
{"level":30,"time":1768708841379,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708841427,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w82_v3\",public"}
{"level":30,"time":1768708841428,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708841433,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w83_v3\",public"}
{"level":30,"time":1768708841433,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708841472,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708841473,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w84_v3\",public"}
{"level":30,"time":1768708841530,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w84_v3\",public"}
{"level":30,"time":1768708841530,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708841577,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708841578,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w85_v3\",public"}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708841616,"env":"test","module":"auth-routes","userId":"1032fa66-9182-471e-b3bc-53cba97bb5a1","msg":"User logged in successfully"}
{"level":30,"time":1768708841632,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w85_v3\",public"}
{"level":30,"time":1768708841632,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mðŸ“Š Schema test_schema_w87_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768708841805,"env":"test","module":"audit-log-service","userId":"1032fa66-9182-471e-b3bc-53cba97bb5a1","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768708841811,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708841860,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708841860,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w86_v3\",public"}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768708841899,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w86_v3\",public"}
{"level":30,"time":1768708841899,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708841943,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708841943,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/session.management.test.ts [2m([22m[2m22 tests[22m[2m)[22m[33m 3975[2mms[22m[39m
{"level":30,"time":1768708842069,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708842069,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708842079,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708842080,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/HelperLibrary.test.ts [2m([22m[2m60 tests[22m[2m)[22m[33m 4153[2mms[22m[39m
 [32mâœ“[39m tests/unit/workflows/validation.test.ts [2m([22m[2m66 tests[22m[2m)[22m[33m 3995[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w80_v3, public
âœ… Enforced search_path: test_schema_w80_v3, public

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w81_v3, public
âœ… Enforced search_path: test_schema_w81_v3, public

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w89_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w82_v3, public
âœ… Enforced search_path: test_schema_w82_v3, public

{"level":30,"time":1768708842189,"env":"test","module":"user-credentials-repository","userId":"433a8d4e-6461-4cb1-9c5a-22f890338b1b","msg":"User credentials created"}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w88_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708842209,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708842210,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w89_v3 (Reused: true)

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w83_v3, public
âœ… Enforced search_path: test_schema_w83_v3, public

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w88_v3 (Reused: true)

 [32mâœ“[39m tests/unit/client/list-choice-options.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 3910[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w80_v3
âœ… Current search_path: test_schema_w80_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w81_v3
âœ… Current search_path: test_schema_w81_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w82_v3
âœ… Current search_path: test_schema_w82_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708842293,"env":"test","module":"email-queue","jobId":"1f91243f-c7a2-4e43-9677-97ae5e108298","to":"middleware-test-nMOgl0wUOcJ8n2cdYzNNi@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w84_v3, public
âœ… Enforced search_path: test_schema_w84_v3, public

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768708842342,"env":"test","module":"auth-routes","userId":"433a8d4e-6461-4cb1-9c5a-22f890338b1b","email":"middleware-test-nMOgl0wUOcJ8n2cdYzNNi@example.com","msg":"User registered"}
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w83_v3
âœ… Current search_path: test_schema_w83_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708842374,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708842374,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w87_v3\",public"}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w85_v3, public
âœ… Enforced search_path: test_schema_w85_v3, public

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w84_v3
âœ… Current search_path: test_schema_w84_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708842419,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w87_v3\",public"}
{"level":30,"time":1768708842419,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w85_v3
âœ… Current search_path: test_schema_w85_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mðŸ“Š Schema test_schema_w89_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mðŸ“Š Schema test_schema_w88_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w86_v3, public
âœ… Enforced search_path: test_schema_w86_v3, public

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w86_v3
âœ… Current search_path: test_schema_w86_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708842860,"env":"test","module":"auth-routes","userId":"433a8d4e-6461-4cb1-9c5a-22f890338b1b","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w91_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708842914,"env":"test","module":"audit-log-service","userId":"433a8d4e-6461-4cb1-9c5a-22f890338b1b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w92_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w91_v3 (Reused: true)

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w92_v3 (Reused: true)

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w90_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w90_v3 (Reused: true)

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w87_v3, public
âœ… Enforced search_path: test_schema_w87_v3, public

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w87_v3
âœ… Current search_path: test_schema_w87_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708843309,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708843309,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w88_v3\",public"}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708843330,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708843331,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w89_v3\",public"}
{"level":30,"time":1768708843344,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w88_v3\",public"}
{"level":30,"time":1768708843344,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mðŸ“Š Schema test_schema_w91_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708843359,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w89_v3\",public"}
{"level":30,"time":1768708843359,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

{"level":30,"time":1768708843390,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708843390,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708843395,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708843396,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mðŸ“Š Schema test_schema_w92_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

 [32mâœ“[39m tests/unit/utils/pagination.test.ts [2m([22m[2m24 tests[22m[2m)[22m[33m 3880[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

 [32mâœ“[39m tests/unit/services/TemplateAnalysisService.test.ts [2m([22m[2m27 tests[22m[2m)[22m[33m 3957[2mms[22m[39m
[90mstderr[2m | tests/unit/client/choice-utils.test.ts[2m > [22m[2mchoice-utils[2m > [22m[2mhandles missing content gracefully
[22m[39m[generateOptionsFromList] Invalid list data: [1mnull[22m

{"level":30,"time":1768708843440,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708843440,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708843458,"env":"test","module":"user-credentials-repository","userId":"88451c84-ec9e-460b-821a-7d48c04198a2","msg":"User credentials created"}
 [32mâœ“[39m tests/unit/client/choice-utils.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 3945[2mms[22m[39m
[90mstderr[2m | tests/unit/shared/workflowLogic.test.ts[2m > [22m[2mworkflowLogic[2m > [22m[2mevaluateRules[2m > [22m[2mOperators[2m > [22m[2mUnknown operator[2m > [22m[2mshould return false and log warning for unknown operator
[22m[39mUnknown operator: unknown_operator

{"level":30,"time":1768708843498,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708843498,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mðŸ“Š Schema test_schema_w90_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w93_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

 [32mâœ“[39m tests/unit/shared/workflowLogic.test.ts [2m([22m[2m65 tests[22m[2m)[22m[33m 3993[2mms[22m[39m
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708843565,"env":"test","module":"email-queue","jobId":"94aad07d-3753-4b03-ad48-d1e2d99bc5db","to":"middleware-test-nNzYBtp-_cPTUS01F5wH1@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w93_v3 (Reused: true)

{"level":30,"time":1768708843574,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708843575,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32mâœ“[39m tests/unit/WorkflowOptimizationService.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 3928[2mms[22m[39m
{"level":30,"time":1768708843615,"env":"test","module":"auth-routes","userId":"88451c84-ec9e-460b-821a-7d48c04198a2","email":"middleware-test-nNzYBtp-_cPTUS01F5wH1@example.com","msg":"User registered"}
{"level":50,"time":1768708843674,"env":"test","module":"intake-navigation","error":{},"pageId":"page1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating visibleIf condition"}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":50,"time":1768708843675,"env":"test","module":"intake-navigation","error":{},"pageId":"page1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating skipIf condition"}
{"level":30,"time":1768708843677,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708843677,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/services/intakeNavigation.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 3881[2mms[22m[39m
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768708843902,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708843903,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/engine/Performance.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 3940[2mms[22m[39m
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mðŸ“Š Schema test_schema_w93_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mâš ï¸ Could not set database-level search_path (expected in cloud DBs): tuple concurrently updated
âœ… Enforced search_path: test_schema_w89_v3, public

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w88_v3, public
âœ… Enforced search_path: test_schema_w88_v3, public

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w89_v3
âœ… Current search_path: test_schema_w89_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708844222,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708844223,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w91_v3\",public"}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w88_v3
âœ… Current search_path: test_schema_w88_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708844232,"env":"test","module":"auth-routes","userId":"88451c84-ec9e-460b-821a-7d48c04198a2","msg":"User logged in successfully"}
{"level":30,"time":1768708844282,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w91_v3\",public"}
{"level":30,"time":1768708844282,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708844291,"env":"test","module":"audit-log-service","userId":"88451c84-ec9e-460b-821a-7d48c04198a2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w94_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w95_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708844329,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708844330,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w92_v3\",public"}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w94_v3 (Reused: true)

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w95_v3 (Reused: true)

{"level":30,"time":1768708844379,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w92_v3\",public"}
{"level":30,"time":1768708844379,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708844400,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708844400,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w90_v3\",public"}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w96_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708844443,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w90_v3\",public"}
{"level":30,"time":1768708844443,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708844448,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708844448,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/utils/variableResolver.test.ts [2m([22m[2m20 tests[22m[2m)[22m[33m 3617[2mms[22m[39m
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w96_v3 (Reused: true)

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w97_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w97_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w98_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w98_v3 (Reused: true)

{"level":30,"time":1768708844668,"env":"test","module":"user-credentials-repository","userId":"980fe704-dda9-4e46-8777-ab33a6e3ef24","msg":"User credentials created"}
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708844717,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708844718,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w93_v3\",public"}
{"level":30,"time":1768708844749,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w93_v3\",public"}
{"level":30,"time":1768708844749,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708844776,"env":"test","module":"email-queue","jobId":"34685b37-0e49-45fd-8987-93acf6bde0d5","to":"user2-V2-zeRFTW8si7IIhD0tcL@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mðŸ“Š Schema test_schema_w94_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mðŸ“Š Schema test_schema_w95_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

{"level":30,"time":1768708844827,"env":"test","module":"auth-routes","userId":"980fe704-dda9-4e46-8777-ab33a6e3ef24","email":"user2-V2-zeRFTW8si7IIhD0tcL@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mðŸ“Š Schema test_schema_w96_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w99_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mðŸ“Š Schema test_schema_w97_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w99_v3 (Reused: true)

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mðŸ“Š Schema test_schema_w98_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w91_v3, public
âœ… Enforced search_path: test_schema_w91_v3, public

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w100_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w100_v3 (Reused: true)

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w92_v3, public
âœ… Enforced search_path: test_schema_w92_v3, public

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w91_v3
âœ… Current search_path: test_schema_w91_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w90_v3, public
âœ… Enforced search_path: test_schema_w90_v3, public

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w92_v3
âœ… Current search_path: test_schema_w92_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w101_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w101_v3 (Reused: true)

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w90_v3
âœ… Current search_path: test_schema_w90_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708845335,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708845336,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708845346,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708845347,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708845356,"env":"test","module":"auth-routes","userId":"980fe704-dda9-4e46-8777-ab33a6e3ef24","msg":"User logged in successfully"}
 [32mâœ“[39m tests/integration/mfa.flow.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 3544[2mms[22m[39m
 [32mâœ“[39m tests/integration/conditions/conditionEvaluation.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 3539[2mms[22m[39m
{"level":30,"time":1768708845410,"env":"test","module":"audit-log-service","userId":"980fe704-dda9-4e46-8777-ab33a6e3ef24","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mðŸ“Š Schema test_schema_w99_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w93_v3, public
âœ… Enforced search_path: test_schema_w93_v3, public

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708845558,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708845559,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w94_v3\",public"}
[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mðŸ“Š Schema test_schema_w100_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768708845609,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w94_v3\",public"}
{"level":30,"time":1768708845609,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w93_v3
âœ… Current search_path: test_schema_w93_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mðŸ“Š Schema test_schema_w101_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708845765,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708845766,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w96_v3\",public"}
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708845770,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708845771,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w97_v3\",public"}
{"level":30,"time":1768708845813,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w96_v3\",public"}
{"level":30,"time":1768708845813,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708845818,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w97_v3\",public"}
{"level":30,"time":1768708845818,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768708845911,"env":"test","module":"user-credentials-repository","userId":"a7d02098-4915-4c64-9e95-2915ce12a799","msg":"User credentials created"}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708845928,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708845929,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w98_v3\",public"}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708845976,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w98_v3\",public"}
{"level":30,"time":1768708845976,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768708846013,"env":"test","module":"email-queue","jobId":"388b8448-7dbb-4166-9846-29a785beda7f","to":"middleware-test-mFMVhCsTgtVl9K8Y-uUYe@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768708846061,"env":"test","module":"auth-routes","userId":"a7d02098-4915-4c64-9e95-2915ce12a799","email":"middleware-test-mFMVhCsTgtVl9K8Y-uUYe@example.com","msg":"User registered"}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708846133,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708846134,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w99_v3\",public"}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768708846180,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w99_v3\",public"}
{"level":30,"time":1768708846180,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708846204,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708846205,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w100_v3\",public"}
{"level":30,"time":1768708846249,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w100_v3\",public"}
{"level":30,"time":1768708846249,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w102_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w103_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708846293,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708846294,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w95_v3, public
âœ… Enforced search_path: test_schema_w95_v3, public

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708846322,"env":"test","msg":"DB: initializing... Local"}
 [32mâœ“[39m tests/unit/utils/conditionalLogic-simple.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 3800[2mms[22m[39m
{"level":30,"time":1768708846323,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w101_v3\",public"}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w102_v3 (Reused: true)

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w103_v3 (Reused: true)

[90mstderr[2m | tests/unit/shared/conditionEvaluator.test.ts[2m > [22m[2mconditionEvaluator[2m > [22m[2mComparison operators[2m > [22m[2mUnknown operator[2m > [22m[2mshould default to true and log warning
[22m[39mUnknown operator: unknown_operator

{"level":30,"time":1768708846341,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708846342,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708846365,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w101_v3\",public"}
{"level":30,"time":1768708846365,"env":"test","msg":"DB: initialized flag set."}
 [32mâœ“[39m tests/unit/shared/conditionEvaluator.test.ts [2m([22m[2m70 tests[22m[2m)[22m[33m 3803[2mms[22m[39m
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w94_v3, public
âœ… Enforced search_path: test_schema_w94_v3, public

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w95_v3
âœ… Current search_path: test_schema_w95_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768708846459,"env":"test","warnings":["Python code does not call emit(). Script will not produce output."],"msg":"Script validation warnings"}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708846462,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708846462,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w94_v3
âœ… Current search_path: test_schema_w94_v3, public
â© Schema reused, skipping migrations.

 [32mâœ“[39m tests/unit/ScriptEngine.test.ts [2m([22m[2m26 tests[22m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 3847[2mms[22m[39m
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mâš ï¸ Could not set database-level search_path (expected in cloud DBs): tuple concurrently updated
âœ… Enforced search_path: test_schema_w96_v3, public

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w97_v3, public
âœ… Enforced search_path: test_schema_w97_v3, public

{"level":30,"time":1768708846586,"env":"test","module":"auth-routes","userId":"a7d02098-4915-4c64-9e95-2915ce12a799","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w96_v3
âœ… Current search_path: test_schema_w96_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708846638,"env":"test","module":"audit-log-service","userId":"a7d02098-4915-4c64-9e95-2915ce12a799","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768708846643,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w97_v3
âœ… Current search_path: test_schema_w97_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mðŸ“Š Schema test_schema_w102_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mðŸ“Š Schema test_schema_w103_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w98_v3, public
âœ… Enforced search_path: test_schema_w98_v3, public

{"level":30,"time":1768708846780,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708846780,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

 [32mâœ“[39m tests/unit/services/docxRenderer2.test.ts [2m([22m[2m27 tests[22m[2m)[22m[33m 3635[2mms[22m[39m
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w98_v3
âœ… Current search_path: test_schema_w98_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w99_v3, public
âœ… Enforced search_path: test_schema_w99_v3, public

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w100_v3, public
âœ… Enforced search_path: test_schema_w100_v3, public

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w99_v3
âœ… Current search_path: test_schema_w99_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708847043,"env":"test","module":"user-credentials-repository","userId":"2fe4c6c2-19ff-46fd-b5c1-3535b6609854","msg":"User credentials created"}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w104_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w105_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w104_v3 (Reused: true)

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w100_v3
âœ… Current search_path: test_schema_w100_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708847143,"env":"test","module":"email-queue","jobId":"5fae069c-2f82-4f3d-8a65-beaf05d2a9f5","to":"middleware-test-XynQViQ8kvKFakn5FY5rU@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w101_v3, public
âœ… Enforced search_path: test_schema_w101_v3, public

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w105_v3 (Reused: true)

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708847193,"env":"test","module":"auth-routes","userId":"2fe4c6c2-19ff-46fd-b5c1-3535b6609854","email":"middleware-test-XynQViQ8kvKFakn5FY5rU@example.com","msg":"User registered"}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w101_v3
âœ… Current search_path: test_schema_w101_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708847459,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708847460,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w103_v3\",public"}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708847470,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708847471,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w102_v3\",public"}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768708847502,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w103_v3\",public"}
{"level":30,"time":1768708847502,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708847510,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w102_v3\",public"}
{"level":30,"time":1768708847510,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mðŸ“Š Schema test_schema_w104_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

 [32mâœ“[39m tests/unit/BlockRunner.validate.test.ts [2m([22m[2m7 tests[22m[2m)[22m[33m 3599[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mðŸ“Š Schema test_schema_w105_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

{"level":30,"time":1768708847614,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708847615,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mâœ… Applied failsafe schema fixes

 [32mâœ“[39m tests/unit/workflow/QueryBlock.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 3704[2mms[22m[39m
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w107_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708847720,"env":"test","module":"auth-routes","userId":"2fe4c6c2-19ff-46fd-b5c1-3535b6609854","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w107_v3 (Reused: true)

{"level":30,"time":1768708847765,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708847766,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708847770,"env":"test","module":"audit-log-service","userId":"2fe4c6c2-19ff-46fd-b5c1-3535b6609854","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768708847775,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
 [32mâœ“[39m tests/integration/intake.portal.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 3728[2mms[22m[39m
{"level":30,"time":1768708847821,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708847822,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/captcha.service.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 3679[2mms[22m[39m
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w106_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w106_v3 (Reused: true)

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708848018,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708848019,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/services/docxHelpers.test.ts [2m([22m[2m39 tests[22m[2m)[22m[33m 3835[2mms[22m[39m
[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708848144,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708848145,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w104_v3\",public"}
{"level":30,"time":1768708848157,"env":"test","module":"user-credentials-repository","userId":"dedd19c4-b20e-48a7-8fe5-490f1cb51ce6","msg":"User credentials created"}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mðŸ“Š Schema test_schema_w107_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768708848193,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w104_v3\",public"}
{"level":30,"time":1768708848193,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

{"level":40,"time":1768708848224,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":40,"time":1768708848230,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":40,"time":1768708848232,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":40,"time":1768708848235,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":40,"time":1768708848237,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":30,"time":1768708848245,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708848246,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708848271,"env":"test","module":"workflow-quality-validator","overall":99,"breakdown":{"aliases":100,"types":100,"structure":100,"ux":95,"completeness":100,"validation":100},"issuesCount":1,"passed":true,"msg":"Workflow quality validation completed"}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w102_v3, public
âœ… Enforced search_path: test_schema_w102_v3, public

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708848287,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708848288,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w105_v3\",public"}
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w103_v3, public
âœ… Enforced search_path: test_schema_w103_v3, public

 [32mâœ“[39m tests/unit/isolatedVmBridge.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 3656[2mms[22m[39m
[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708848271,"env":"test","module":"workflow-generation-service","duration":3,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":99,"qualityBreakdown":{"aliases":100,"types":100,"structure":100,"ux":95,"completeness":100,"validation":100},"qualityPassed":true,"issuesCount":1,"msg":"AI workflow generation succeeded"}
{"level":50,"time":1768708848276,"env":"test","module":"workflow-generation-service","error":{"code":"VALIDATION_ERROR","message":"","retryable":false},"duration":1,"msg":"AI workflow generation failed"}
{"level":50,"time":1768708848280,"env":"test","module":"workflow-generation-service","error":{"code":"VALIDATION_ERROR","message":"","retryable":false},"duration":1,"msg":"AI workflow generation failed"}
{"level":50,"time":1768708848282,"env":"test","module":"workflow-generation-service","error":{"code":"VALIDATION_ERROR","message":"","retryable":false},"duration":0,"msg":"AI workflow generation failed"}
{"level":50,"time":1768708848285,"env":"test","module":"workflow-generation-service","error":{"status":429,"code":"rate_limit_exceeded"},"duration":0,"msg":"AI workflow generation failed"}
{"level":50,"time":1768708848288,"env":"test","module":"workflow-generation-service","error":{},"duration":1,"msg":"AI workflow generation failed"}
{"level":30,"time":1768708848292,"env":"test","module":"workflow-quality-validator","overall":100,"breakdown":{"aliases":100,"types":100,"structure":100,"ux":100,"completeness":100,"validation":100},"issuesCount":0,"passed":true,"msg":"Workflow quality validation completed"}
{"level":30,"time":1768708848293,"env":"test","module":"workflow-generation-service","duration":1,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":100,"qualityBreakdown":{"aliases":100,"types":100,"structure":100,"ux":100,"completeness":100,"validation":100},"qualityPassed":true,"issuesCount":0,"msg":"AI workflow generation succeeded"}
{"level":30,"time":1768708848295,"env":"test","module":"workflow-quality-validator","overall":96,"breakdown":{"aliases":100,"types":100,"structure":80,"ux":100,"completeness":90,"validation":100},"issuesCount":2,"passed":true,"msg":"Workflow quality validation completed"}
{"level":30,"time":1768708848295,"env":"test","module":"workflow-generation-service","duration":0,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":96,"qualityBreakdown":{"aliases":100,"types":100,"structure":80,"ux":100,"completeness":90,"validation":100},"qualityPassed":true,"issuesCount":2,"msg":"AI workflow generation succeeded"}
{"level":30,"time":1768708848299,"env":"test","module":"workflow-suggestion-service","duration":0,"suggestionsCount":1,"msg":"AI binding suggestion succeeded"}
{"level":30,"time":1768708848300,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708848300,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w108_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708848335,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w105_v3\",public"}
{"level":30,"time":1768708848336,"env":"test","msg":"DB: initialized flag set."}
 [32mâœ“[39m tests/unit/ai.service.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 3580[2mms[22m[39m
{"level":30,"time":1768708848344,"env":"test","module":"email-queue","jobId":"f014637d-5b62-4d76-91d8-ab8ca8d64500","to":"middleware-test-7umFEFEZLIuK9mmpxku5D@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w108_v3 (Reused: true)

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mðŸ“Š Schema test_schema_w106_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w102_v3
âœ… Current search_path: test_schema_w102_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708848373,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708848374,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w106_v3\",public"}
{"level":40,"time":1768708848376,"env":"test","module":"rbac-middleware","path":"/api/workflows","permission":"workflow:create","msg":"Unauthenticated user attempted to access protected resource"}
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w103_v3
âœ… Current search_path: test_schema_w103_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708848394,"env":"test","module":"auth-routes","userId":"dedd19c4-b20e-48a7-8fe5-490f1cb51ce6","email":"middleware-test-7umFEFEZLIuK9mmpxku5D@example.com","msg":"User registered"}
[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":40,"time":1768708848380,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","permission":"workflow:create","path":"/api/workflows","msg":"Permission denied"}
{"level":40,"time":1768708848381,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":null,"permission":"workflow:view","path":"/api/workflows","msg":"Permission denied"}
{"level":40,"time":1768708848382,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","permissions":["workflow:create","workflow:edit","workflow:delete"],"path":"/api/workflows","msg":"Permission denied (none of required permissions)"}
{"level":40,"time":1768708848384,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"builder","permissions":["workflow:edit","workflow:delete"],"path":"/api/workflows","msg":"Permission denied (missing some required permissions)"}
{"level":40,"time":1768708848385,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","requiredRoles":["owner","builder"],"path":"/api/admin","msg":"Role check failed"}
{"level":40,"time":1768708848388,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":null,"requiredRoles":["owner"],"path":"/api/admin","msg":"Role check failed"}
{"level":40,"time":1768708848389,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"builder","requiredRoles":["owner"],"path":"/api/test","msg":"Role check failed"}
{"level":40,"time":1768708848390,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"runner","requiredRoles":["owner","builder"],"path":"/api/test","msg":"Role check failed"}
{"level":40,"time":1768708848392,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","requiredRoles":["owner","builder","runner"],"path":"/api/test","msg":"Role check failed"}
{"level":40,"time":1768708848396,"env":"test","module":"rbac-middleware","path":"/api/test","permission":"workflow:view","msg":"Unauthenticated user attempted to access protected resource"}
{"level":40,"time":1768708848396,"env":"test","module":"rbac-middleware","userId":"user-123","permission":"workflow:view","path":"/api/test","msg":"Permission denied"}
{"level":40,"time":1768708848397,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"invalid-role","permission":"workflow:view","path":"/api/test","msg":"Permission denied"}
{"level":30,"time":1768708848398,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708848398,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w109_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708848422,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w106_v3\",public"}
{"level":30,"time":1768708848422,"env":"test","msg":"DB: initialized flag set."}
 [32mâœ“[39m tests/unit/middleware/rbac.test.ts [2m([22m[2m44 tests[22m[2m)[22m[33m 3548[2mms[22m[39m
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w109_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w110_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w110_v3 (Reused: true)

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w111_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mðŸ“Š Schema test_schema_w108_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w111_v3 (Reused: true)

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mðŸ“Š Schema test_schema_w109_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708848916,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708848917,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w107_v3\",public"}
{"level":30,"time":1768708848960,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w107_v3\",public"}
{"level":30,"time":1768708848960,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w104_v3, public
âœ… Enforced search_path: test_schema_w104_v3, public

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w104_v3
âœ… Current search_path: test_schema_w104_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mðŸ“Š Schema test_schema_w110_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w105_v3, public
âœ… Enforced search_path: test_schema_w105_v3, public

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768708849195,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["dedd19c4-b20e-48a7-8fe5-490f1cb51ce6","97ae8d7323ce5d3df070578ed5597dd33c51b40f67df341617cc159d008c7ec7","2026-02-17T04:00:48.998Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-18T04:00:48.998Z"],"cause":{"length":340,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(dedd19c4-b20e-48a7-8fe5-490f1cb51ce6) is not present in table \"users\".","schema":"test_schema_w106_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould authenticate with JWT if provided
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)
params: dedd19c4-b20e-48a7-8fe5-490f1cb51ce6,97ae8d7323ce5d3df070578ed5597dd33c51b40f67df341617cc159d008c7ec7,2026-02-17T04:00:48.998Z,false,{"ip":"::1"},,::1,Location Unknown,2026-01-18T04:00:48.998Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
    at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:150:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:325:24 {
  query: [32m'insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)'[39m,
  params: [
    [32m'dedd19c4-b20e-48a7-8fe5-490f1cb51ce6'[39m,
    [32m'97ae8d7323ce5d3df070578ed5597dd33c51b40f67df341617cc159d008c7ec7'[39m,
    [32m'2026-02-17T04:00:48.998Z'[39m,
    [33mfalse[39m,
    [32m'{"ip":"::1"}'[39m,
    [1mnull[22m,
    [32m'::1'[39m,
    [32m'Location Unknown'[39m,
    [32m'2026-01-18T04:00:48.998Z'[39m
  ],
  cause: error: insert or update on table "refresh_tokens" violates foreign key constraint "refresh_tokens_user_id_users_id_fk"
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
      at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:150:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:325:24 {
    length: [33m340[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23503'[39m,
    detail: [32m'Key (user_id)=(dedd19c4-b20e-48a7-8fe5-490f1cb51ce6) is not present in table "users".'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w106_v3'[39m,
    table: [32m'refresh_tokens'[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [32m'refresh_tokens_user_id_users_id_fk'[39m,
    file: [32m'ri_triggers.c'[39m,
    line: [32m'2599'[39m,
    routine: [32m'ri_ReportViolation'[39m
  }
}

[90mstderr[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould authenticate with JWT if provided
[22m[39mLogin Failed! [33m500[39m {
  success: [33mfalse[39m,
  error: {
    code: [32m'ERR_003'[39m,
    message: [32m'Failed query: insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)\n'[39m +
      [32m'params: dedd19c4-b20e-48a7-8fe5-490f1cb51ce6,97ae8d7323ce5d3df070578ed5597dd33c51b40f67df341617cc159d008c7ec7,2026-02-17T04:00:48.998Z,false,{"ip":"::1"},,::1,Location Unknown,2026-01-18T04:00:48.998Z'[39m,
    timestamp: [32m'2026-01-18T04:00:49.198Z'[39m
  }
}

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mðŸ“Š Schema test_schema_w111_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w105_v3
âœ… Current search_path: test_schema_w105_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w106_v3, public
âœ… Enforced search_path: test_schema_w106_v3, public

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w106_v3
âœ… Current search_path: test_schema_w106_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708849485,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708849486,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/engine.expr.test.ts [2m([22m[2m26 tests[22m[2m)[22m[33m 3609[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708849549,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708849550,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708849566,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708849567,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w108_v3\",public"}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

 [32mâœ“[39m tests/unit/listPipeline.semantics.test.ts [2m([22m[2m70 tests[22m[2m)[22m[33m 3657[2mms[22m[39m
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould authenticate with JWT if provided
[22m[39mUser in DB: [90mundefined[39m

{"level":30,"time":1768708849620,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w108_v3\",public"}
{"level":30,"time":1768708849620,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708849681,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708849682,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w109_v3\",public"}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708849730,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w109_v3\",public"}
{"level":30,"time":1768708849730,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w107_v3, public
âœ… Enforced search_path: test_schema_w107_v3, public

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w113_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w107_v3
âœ… Current search_path: test_schema_w107_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w113_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708849886,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708849887,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w110_v3\",public"}
[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

{"level":30,"time":1768708849927,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w110_v3\",public"}
{"level":30,"time":1768708849927,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708849943,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708849944,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w111_v3\",public"}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w114_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708849993,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w111_v3\",public"}
{"level":30,"time":1768708849993,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w114_v3 (Reused: true)

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":50,"time":1768708850150,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["a47e9114-9055-4944-9c9b-53d4be34419e","$2b$12$MpvV2wcQCxKxObtUdB8G/eFjHrJbbQKISLFpXJTNsBe5zfyf5lifm"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(a47e9114-9055-4944-9c9b-53d4be34419e) is not present in table \"users\".","schema":"test_schema_w106_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"a47e9114-9055-4944-9c9b-53d4be34419e","msg":"Failed to create user credentials"}
{"level":50,"time":1768708850150,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["a47e9114-9055-4944-9c9b-53d4be34419e","$2b$12$MpvV2wcQCxKxObtUdB8G/eFjHrJbbQKISLFpXJTNsBe5zfyf5lifm"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(a47e9114-9055-4944-9c9b-53d4be34419e) is not present in table \"users\".","schema":"test_schema_w106_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w115_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts[2m > [22m[2mIntakeQuestionVisibilityService[2m > [22m[2mHelper methods[2m > [22m[2mshould get visible question count
[22m[39mMOCK SETUP DONE. Mock questions: [
  {
    id: [32m'q1'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q1'[39m,
    order: [33m0[39m,
    isVirtual: [33mfalse[39m,
    alias: [32m'show'[39m,
    visibleIf: [1mnull[22m
  },
  {
    id: [32m'q2'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q2'[39m,
    order: [33m1[39m,
    isVirtual: [33mfalse[39m,
    visibleIf: { op: [32m'equals'[39m, left: [36m[Object][39m, right: [36m[Object][39m }
  },
  {
    id: [32m'q3'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q3'[39m,
    order: [33m2[39m,
    isVirtual: [33mfalse[39m,
    visibleIf: [1mnull[22m
  }
]
Calling getVisibleQuestionCount...

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts[2m > [22m[2mIntakeQuestionVisibilityService[2m > [22m[2mHelper methods[2m > [22m[2mshould get visible question count
[22m[39mCOUNT RESULT: [33m0[39m
Mock called times: [33m1[39m
Mock last call args: [ [ [32m'section1'[39m ] ]

{"level":50,"time":1768708850198,"env":"test","module":"intake-question-visibility","error":{},"questionId":"q1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating visibleIf condition"}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708850200,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708850200,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w115_v3 (Reused: true)

 [32mâœ“[39m tests/unit/services/intakeQuestionVisibility.test.ts [2m([22m[2m19 tests[22m[2m)[22m[33m 3516[2mms[22m[39m
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mðŸ“Š Schema test_schema_w113_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708850348,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708850349,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w113_v3\",public"}
{"level":30,"time":1768708850360,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708850361,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w108_v3, public
âœ… Enforced search_path: test_schema_w108_v3, public

 [32mâœ“[39m tests/unit/shared/validation/Validator.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 3655[2mms[22m[39m
{"level":30,"time":1768708850397,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w113_v3\",public"}
{"level":30,"time":1768708850397,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w108_v3
âœ… Current search_path: test_schema_w108_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mðŸ“Š Schema test_schema_w114_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708850482,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708850483,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w114_v3\",public"}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w109_v3, public
âœ… Enforced search_path: test_schema_w109_v3, public

{"level":30,"time":1768708850529,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w114_v3\",public"}
{"level":30,"time":1768708850529,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w109_v3
âœ… Current search_path: test_schema_w109_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mðŸ“Š Schema test_schema_w115_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708850625,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708850626,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w115_v3\",public"}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768708850678,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w115_v3\",public"}
{"level":30,"time":1768708850678,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w110_v3, public
âœ… Enforced search_path: test_schema_w110_v3, public

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w110_v3
âœ… Current search_path: test_schema_w110_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w111_v3, public
âœ… Enforced search_path: test_schema_w111_v3, public

{"level":50,"time":1768708850877,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["c78cdf7b-41df-4459-a69b-fe8fe0c21f03","$2b$12$CCZmxTc2U6sY6fozLSeHRO465AQs1r.L0NSiGxJDHKO6NGfi39kNG"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(c78cdf7b-41df-4459-a69b-fe8fe0c21f03) is not present in table \"users\".","schema":"test_schema_w45_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"c78cdf7b-41df-4459-a69b-fe8fe0c21f03","msg":"Failed to create user credentials"}
{"level":50,"time":1768708850877,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["c78cdf7b-41df-4459-a69b-fe8fe0c21f03","$2b$12$CCZmxTc2U6sY6fozLSeHRO465AQs1r.L0NSiGxJDHKO6NGfi39kNG"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(c78cdf7b-41df-4459-a69b-fe8fe0c21f03) is not present in table \"users\".","schema":"test_schema_w45_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w111_v3
âœ… Current search_path: test_schema_w111_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708850973,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708850974,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708850995,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708850995,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/services/RunExecutionCoordinator.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 3656[2mms[22m[39m
 [32mâœ“[39m tests/integration/analytics_preservation.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 3481[2mms[22m[39m
     [33m[2mâœ“[22m[39m should preserve lifetime user count when a user is deleted [33m 489[2mms[22m[39m
[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w113_v3, public
âœ… Enforced search_path: test_schema_w113_v3, public

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w113_v3
âœ… Current search_path: test_schema_w113_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w114_v3, public
âœ… Enforced search_path: test_schema_w114_v3, public

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w114_v3
âœ… Current search_path: test_schema_w43_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w115_v3, public
âœ… Enforced search_path: test_schema_w115_v3, public

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w43_v3
âœ… Current search_path: test_schema_w43_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708851628,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708851628,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

 [32mâœ“[39m tests/ui/builder.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 3706[2mms[22m[39m
{"level":30,"time":1768708851669,"env":"test","module":"user-credentials-repository","userId":"4ccd1879-12dc-44e4-8d21-39c63f5b6a8c","msg":"User credentials created"}
[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w116_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w116_v3 (Reused: true)

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w118_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w118_v3 (Reused: true)

{"level":30,"time":1768708851813,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708851813,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708851826,"env":"test","module":"email-queue","jobId":"0f501963-3631-4027-aa77-b36820b60d86","to":"middleware-test-iIBMLwCjMkDQE25jbtbd4@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
 [32mâœ“[39m tests/integration/auth.routes.test.ts [2m([22m[2m41 tests[22m[2m)[22m[33m 3788[2mms[22m[39m
{"level":30,"time":1768708851975,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708851976,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768708851991,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["4ccd1879-12dc-44e4-8d21-39c63f5b6a8c","c6f053f8e562752c3ad0bf578e56b6f02d7dc6103adaaffdbd3b871023d851f4","2026-02-17T04:00:51.827Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-18T04:00:51.827Z"],"cause":{"length":340,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(4ccd1879-12dc-44e4-8d21-39c63f5b6a8c) is not present in table \"users\".","schema":"test_schema_w114_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
 [32mâœ“[39m tests/unit/shared/validation/stepConfigSchemas.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 3709[2mms[22m[39m
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768708852116,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708852117,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mDEBUG: Existing functions: []

 [32mâœ“[39m tests/unit/workflows/conditionTruthTable.test.ts [2m([22m[2m51 tests[22m[2m)[22m[33m 3788[2mms[22m[39m
[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mðŸ“Š Schema test_schema_w116_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708852158,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708852159,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w116_v3\",public"}
{"level":30,"time":1768708852209,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w116_v3\",public"}
{"level":30,"time":1768708852209,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mðŸ“Š Schema test_schema_w118_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708852251,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708852253,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w118_v3\",public"}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

{"level":30,"time":1768708852304,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w118_v3\",public"}
{"level":30,"time":1768708852304,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w117_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708852485,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708852486,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w117_v3 (Reused: true)

 [32mâœ“[39m tests/unit/schema/documentEngine.test.ts [2m([22m[2m33 tests[22m[2m)[22m[33m 3054[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w119_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w119_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts[2m > [22m[2mDatavaultColumnsService[2m > [22m[2mgetColumns[2m > [22m[2mshould throw 404 if table not found
[22m[39m[DEBUG] Table not found: 660e8400-e29b-41d4-a716-446655440001

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w121_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w121_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w120_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708852738,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708852739,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708852745,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708852746,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w120_v3 (Reused: true)

 [32mâœ“[39m tests/unit/services/DatavaultColumnsService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 3150[2mms[22m[39m
 [32mâœ“[39m tests/unit/services/CollectionFieldService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 2969[2mms[22m[39m
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

{"level":30,"time":1768708852879,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":50,"time":1768708852884,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["eb1e9e31-1889-4285-9e56-75e89414ce6f","$2b$12$aelu1WL8xB1gRLAI7nRxH.bftZcYO2OPfG9r7BDiCAaeI08rc0I/6"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(eb1e9e31-1889-4285-9e56-75e89414ce6f) is not present in table \"users\".","schema":"test_schema_w116_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"eb1e9e31-1889-4285-9e56-75e89414ce6f","msg":"Failed to create user credentials"}
{"level":50,"time":1768708852884,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["eb1e9e31-1889-4285-9e56-75e89414ce6f","$2b$12$aelu1WL8xB1gRLAI7nRxH.bftZcYO2OPfG9r7BDiCAaeI08rc0I/6"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(eb1e9e31-1889-4285-9e56-75e89414ce6f) is not present in table \"users\".","schema":"test_schema_w116_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mðŸ“Š Schema test_schema_w117_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708852942,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708852943,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w117_v3\",public"}
[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w116_v3, public
âœ… Enforced search_path: test_schema_w116_v3, public

{"level":30,"time":1768708853006,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w117_v3\",public"}
{"level":30,"time":1768708853006,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mðŸ“Š Schema test_schema_w119_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708853025,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708853026,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w119_v3\",public"}
{"level":30,"time":1768708853078,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w119_v3\",public"}
{"level":30,"time":1768708853078,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w118_v3, public
âœ… Enforced search_path: test_schema_w118_v3, public

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mðŸ“Š Schema test_schema_w121_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w116_v3
âœ… Current search_path: test_schema_w116_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708853153,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

{"level":30,"time":1768708853154,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w121_v3\",public"}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w118_v3
âœ… Current search_path: test_schema_w118_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mðŸ“Š Schema test_schema_w120_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708853208,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708853209,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w120_v3\",public"}
{"level":30,"time":1768708853263,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w120_v3\",public"}
{"level":30,"time":1768708853264,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708853300,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w121_v3\",public"}
{"level":30,"time":1768708853301,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768708853679,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["e2bcb405-529b-41e8-9b0f-5be9d272dbf1","$2b$12$62fnbG1I0WF/TJ4CAzkKsORQRy5s.qDr27Gl/CQQ3y1.365qDPJym"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(e2bcb405-529b-41e8-9b0f-5be9d272dbf1) is not present in table \"users\".","schema":"test_schema_w116_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"e2bcb405-529b-41e8-9b0f-5be9d272dbf1","msg":"Failed to create user credentials"}
{"level":50,"time":1768708853679,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["e2bcb405-529b-41e8-9b0f-5be9d272dbf1","$2b$12$62fnbG1I0WF/TJ4CAzkKsORQRy5s.qDr27Gl/CQQ3y1.365qDPJym"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(e2bcb405-529b-41e8-9b0f-5be9d272dbf1) is not present in table \"users\".","schema":"test_schema_w116_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w123_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w117_v3, public
âœ… Enforced search_path: test_schema_w117_v3, public

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w123_v3 (Reused: true)

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w119_v3, public
âœ… Enforced search_path: test_schema_w119_v3, public

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w120_v3
âœ… Current search_path: test_schema_w120_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w120_v3
âœ… Current search_path: test_schema_w116_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w122_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w122_v3 (Reused: true)

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w120_v3, public
âœ… Enforced search_path: test_schema_w120_v3, public

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w121_v3, public
âœ… Enforced search_path: test_schema_w121_v3, public

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w43_v3
âœ… Current search_path: test_schema_w116_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w121_v3
âœ… Current search_path: test_schema_w121_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mðŸ“Š Schema test_schema_w123_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708854228,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708854229,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w123_v3\",public"}
{"level":30,"time":1768708854277,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w123_v3\",public"}
{"level":30,"time":1768708854277,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708854288,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768708854321,"env":"test","module":"ai-controller","userId":"user-123","workflowId":"123e4567-e89b-12d3-a456-426614174000","descriptionLength":26,"msg":"AI logic generation requested"}
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708854439,"env":"test","module":"user-credentials-repository","userId":"f105d44d-f8c6-4b4d-995d-fb0c4c8a796c","msg":"User credentials created"}
[DEBUG] BaseRepository.update datavault_columns: id=770e8400-e29b-41d4-a716-446655440002, updates={"name":"Mobile Phone","required":true,"updatedAt":"2026-01-18T04:00:54.386Z"}
{"level":30,"time":1768708854448,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mðŸ“Š Schema test_schema_w122_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708854448,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708854450,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708854451,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w122_v3\",public"}
{"level":30,"time":1768708854322,"env":"test","module":"ai-controller","userId":"user-123","workflowId":"123e4567-e89b-12d3-a456-426614174000","duration":2,"changeCount":0,"msg":"AI logic generation succeeded"}
{"level":30,"time":1768708854474,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
 [32mâœ“[39m tests/unit/repositories/DatavaultColumnsRepository.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 3078[2mms[22m[39m
{"level":30,"time":1768708854501,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708854499,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w122_v3\",public"}
{"level":30,"time":1768708854499,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708854509,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708854510,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/api.ai.logic.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 3237[2mms[22m[39m
{"level":50,"time":1768708854623,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["f105d44d-f8c6-4b4d-995d-fb0c4c8a796c","51de5033a546c26ed8c51e61f3c8ed04675592700d2cc0a0efa36fc4e352b307","2026-01-19T04:00:54.439Z"],"cause":{"length":384,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(f105d44d-f8c6-4b4d-995d-fb0c4c8a796c) is not present in table \"users\".","schema":"test_schema_w119_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w126_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w127_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w126_v3 (Reused: true)

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w127_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w128_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w128_v3 (Reused: true)

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w123_v3, public
âœ… Enforced search_path: test_schema_w123_v3, public

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould skip question when condition is false
[22m[39m[DEBUG Question] Node q1 executed. Key: has_code, Value: false. Context keys: 3

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould execute question when condition is true
[22m[39m[DEBUG Question] Node q1 executed. Key: has_code, Value: true. Context keys: 4

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould execute question when condition is true
[22m[39m[DEBUG Question] Node q2 executed. Key: code, Value: ABC123. Context keys: 5

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould skip compute node when condition is false
[22m[39m[DEBUG Question] Node q1 executed. Key: amount, Value: 0. Context keys: 3

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould execute compute node when condition is true
[22m[39m[DEBUG Question] Node q1 executed. Key: amount, Value: 100. Context keys: 3

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould handle complex workflow with multiple conditions
[22m[39m[DEBUG Question] Node q1 executed. Key: has_code, Value: false. Context keys: 4

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould handle complex workflow with multiple conditions
[22m[39m[DEBUG Question] Node q3 executed. Key: amount, Value: 1000. Context keys: 5

{"level":30,"time":1768708855148,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708855149,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w43_v3
âœ… Current search_path: test_schema_w43_v3, public
â© Schema reused, skipping migrations.

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mDebug Mode[2m > [22m[2mshould return trace when debug is enabled
[22m[39m[DEBUG Question] Node q1 executed. Key: name, Value: John. Context keys: 3

{"level":30,"time":1768708855184,"env":"test","msg":"DB: closing pool..."}
[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mDebug Mode[2m > [22m[2mshould not return trace when debug is disabled
[22m[39m[DEBUG Question] Node q1 executed. Key: name, Value: John. Context keys: 3

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708855184,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/datavault.api-tokens.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 3002[2mms[22m[39m
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w122_v3, public
âœ… Enforced search_path: test_schema_w122_v3, public

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mðŸ“Š Schema test_schema_w126_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708855300,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708855300,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w126_v3\",public"}
 [32mâœ“[39m tests/unit/engine.run-conditions.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 3109[2mms[22m[39m
{"level":30,"time":1768708855323,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708855324,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708855352,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w126_v3\",public"}
{"level":30,"time":1768708855352,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mðŸ“Š Schema test_schema_w127_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708855365,"env":"test","msg":"DB: initializing... Local"}
 [32mâœ“[39m tests/unit/services/CollectionService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 2998[2mms[22m[39m
{"level":30,"time":1768708855366,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w127_v3\",public"}
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w123_v3
âœ… Current search_path: test_schema_w123_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mðŸ“Š Schema test_schema_w128_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708855391,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708855392,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w128_v3\",public"}
{"level":30,"time":1768708855396,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708855396,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708855419,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w127_v3\",public"}
{"level":30,"time":1768708855419,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708855445,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w128_v3\",public"}
{"level":30,"time":1768708855445,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w124_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [32mâœ“[39m tests/unit/schema/collections.test.ts [2m([22m[2m34 tests[22m[2m)[22m[33m 3178[2mms[22m[39m
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w124_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w112_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w112_v3 (Reused: true)

{"level":30,"time":1768708855736,"env":"test","module":"user-credentials-repository","userId":"d32cf5d2-41cb-4523-b20a-f491624721b9","msg":"User credentials created"}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768708855938,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["d32cf5d2-41cb-4523-b20a-f491624721b9","9a2663454ba41163c69e45580f42c264a50bdefacee8e409a5da543aafe62cfe","2026-01-19T04:00:55.736Z"],"cause":{"length":384,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(d32cf5d2-41cb-4523-b20a-f491624721b9) is not present in table \"users\".","schema":"test_schema_w127_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mðŸ“Š Schema test_schema_w124_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708855941,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708855942,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w124_v3\",public"}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708855999,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w124_v3\",public"}
{"level":30,"time":1768708855999,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mðŸ“Š Schema test_schema_w112_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708856063,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708856064,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w112_v3\",public"}
{"level":30,"time":1768708856122,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w112_v3\",public"}
{"level":30,"time":1768708856122,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w126_v3, public
âœ… Enforced search_path: test_schema_w126_v3, public

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w127_v3, public
âœ… Enforced search_path: test_schema_w127_v3, public

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w128_v3, public
âœ… Enforced search_path: test_schema_w128_v3, public

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w128_v3
âœ… Current search_path: test_schema_w127_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w127_v3
âœ… Current search_path: test_schema_w43_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w127_v3
âœ… Current search_path: test_schema_w43_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w129_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708856379,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708856379,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w129_v3 (Reused: true)

 [32mâœ“[39m tests/unit/services/DocumentTemplateService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 3037[2mms[22m[39m
{"level":30,"time":1768708856546,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

{"level":30,"time":1768708856582,"env":"test","module":"ai-controller","userId":"user-123","workflowId":"123e4567-e89b-12d3-a456-426614174000","msg":"AI workflow revision job enqueued"}
{"level":30,"time":1768708856603,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":50,"time":1768708856609,"env":"test","module":"ai-controller","error":{"issues":[{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["workflowId"]},{"code":"invalid_type","expected":"object","received":"undefined","path":["currentWorkflow"],"message":"Required"},{"code":"invalid_type","expected":"string","received":"undefined","path":["userInstruction"],"message":"Required"}],"name":"ZodError"},"msg":"Failed to enqueue AI revision job"}
{"level":30,"time":1768708856612,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708856613,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

 [32mâœ“[39m tests/unit/api.ai.revise.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 3028[2mms[22m[39m
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w124_v3, public
âœ… Enforced search_path: test_schema_w124_v3, public

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

{"level":50,"time":1768708856820,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["ef11be81-15a5-47b4-9df9-35f4b5f61ea4","$2b$12$Wrvl1MDu4uKC5Dq2fjYAOuOKdy/afefOEf5LO6cvh5/exustWmSAC"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(ef11be81-15a5-47b4-9df9-35f4b5f61ea4) is not present in table \"users\".","schema":"test_schema_w127_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"ef11be81-15a5-47b4-9df9-35f4b5f61ea4","msg":"Failed to create user credentials"}
{"level":50,"time":1768708856820,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["ef11be81-15a5-47b4-9df9-35f4b5f61ea4","$2b$12$Wrvl1MDu4uKC5Dq2fjYAOuOKdy/afefOEf5LO6cvh5/exustWmSAC"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(ef11be81-15a5-47b4-9df9-35f4b5f61ea4) is not present in table \"users\".","schema":"test_schema_w127_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mðŸ“Š Schema test_schema_w129_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708856835,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708856836,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w129_v3\",public"}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708856884,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w129_v3\",public"}
{"level":30,"time":1768708856884,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ListTools.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w127_v3
âœ… Current search_path: test_schema_w128_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w112_v3, public
âœ… Enforced search_path: test_schema_w112_v3, public

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w131_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w128_v3
âœ… Current search_path: test_schema_w127_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w130_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w131_v3 (Reused: true)

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w130_v3 (Reused: true)

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w133_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w132_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w133_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w132_v3 (Reused: true)

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w134_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w134_v3 (Reused: true)

{"level":30,"time":1768708857444,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708857445,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708857478,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708857478,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/repositories/DocumentTemplateRepository.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 3339[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mðŸ“Š Schema test_schema_w131_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708857502,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708857503,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w131_v3\",public"}
{"level":30,"time":1768708857508,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708857509,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ListTools.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

 [32mâœ“[39m tests/unit/lib/queries/QueryRunner.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 3115[2mms[22m[39m
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mðŸ“Š Schema test_schema_w130_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708857520,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708857521,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w130_v3\",public"}
{"level":30,"time":1768708857555,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w131_v3\",public"}
{"level":30,"time":1768708857555,"env":"test","msg":"DB: initialized flag set."}
 [32mâœ“[39m tests/unit/services/RecordService.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 2999[2mms[22m[39m
{"level":30,"time":1768708857575,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w130_v3\",public"}
{"level":30,"time":1768708857575,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768708857646,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["e24d6803-79ae-4973-8627-cc435e7121fc","$2b$12$SrVdrlAdc/xA15UvkzvMW.7s6f.GlDJv9xPcg5ur014vdJGTysXJu"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(e24d6803-79ae-4973-8627-cc435e7121fc) is not present in table \"users\".","schema":"test_schema_w112_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"e24d6803-79ae-4973-8627-cc435e7121fc","msg":"Failed to create user credentials"}
{"level":50,"time":1768708857646,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["e24d6803-79ae-4973-8627-cc435e7121fc","$2b$12$SrVdrlAdc/xA15UvkzvMW.7s6f.GlDJv9xPcg5ur014vdJGTysXJu"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(e24d6803-79ae-4973-8627-cc435e7121fc) is not present in table \"users\".","schema":"test_schema_w112_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w129_v3, public
âœ… Enforced search_path: test_schema_w129_v3, public

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mðŸ“Š Schema test_schema_w133_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708857684,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708857685,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w133_v3\",public"}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mðŸ“Š Schema test_schema_w132_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708857691,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708857691,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w132_v3\",public"}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708857739,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w133_v3\",public"}
{"level":30,"time":1768708857739,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768708857746,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w132_v3\",public"}
{"level":30,"time":1768708857746,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mðŸ“Š Schema test_schema_w134_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708857753,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708857754,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w134_v3\",public"}
{"level":30,"time":1768708857764,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w112_v3
âœ… Current search_path: test_schema_w43_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768708857810,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w134_v3\",public"}
{"level":30,"time":1768708857811,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w135_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ListTools.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w135_v3 (Reused: true)

{"level":30,"time":1768708858110,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708858110,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708858171,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts[2m > [22m[2mPersonalization API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768708858182,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708858182,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708858189,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708858189,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
 [32mâœ“[39m tests/unit/workflow/PreviewExecution.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 3011[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w131_v3, public
âœ… Enforced search_path: test_schema_w131_v3, public

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w130_v3, public
âœ… Enforced search_path: test_schema_w130_v3, public

{"level":50,"time":1768708858415,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["7eec27cb-b16a-4dcd-8f6c-f4c5cbe590d5","$2b$12$mRshsEeBkv7HPMbfud8SqO/QQbiTCdzQPDA468H1Jxv0cok9fr8cW"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(7eec27cb-b16a-4dcd-8f6c-f4c5cbe590d5) is not present in table \"users\".","schema":"test_schema_w129_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"7eec27cb-b16a-4dcd-8f6c-f4c5cbe590d5","msg":"Failed to create user credentials"}
{"level":50,"time":1768708858415,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["7eec27cb-b16a-4dcd-8f6c-f4c5cbe590d5","$2b$12$mRshsEeBkv7HPMbfud8SqO/QQbiTCdzQPDA468H1Jxv0cok9fr8cW"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(7eec27cb-b16a-4dcd-8f6c-f4c5cbe590d5) is not present in table \"users\".","schema":"test_schema_w129_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w134_v3
âœ… Current search_path: test_schema_w133_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w134_v3
âœ… Current search_path: test_schema_w133_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w133_v3, public
âœ… Enforced search_path: test_schema_w133_v3, public

[90mstdout[2m | tests/ListTools.test.ts
[22m[39mðŸ“Š Schema test_schema_w135_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708858529,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708858530,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w135_v3\",public"}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w132_v3, public
âœ… Enforced search_path: test_schema_w132_v3, public

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708858579,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w135_v3\",public"}
{"level":30,"time":1768708858579,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w134_v3, public
âœ… Enforced search_path: test_schema_w134_v3, public

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w133_v3
âœ… Current search_path: test_schema_w133_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w133_v3
âœ… Current search_path: test_schema_w133_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w133_v3
âœ… Current search_path: test_schema_w133_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

{"level":30,"time":1768708858741,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708858742,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708858927,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708858927,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/services/EmailTemplateMetadataService.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 2985[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

 [32mâœ“[39m tests/integration/api.ai.personalization.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 3557[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768708859216,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["e6ba5d6a-a22a-4391-8593-de16a37a26e0","$2b$12$DildLUWXXOIqZ50EvHm9xOU6lwQxYWE4F7Hs.g7GxpFeW5ordxDLq"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(e6ba5d6a-a22a-4391-8593-de16a37a26e0) is not present in table \"users\".","schema":"test_schema_w134_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"e6ba5d6a-a22a-4391-8593-de16a37a26e0","msg":"Failed to create user credentials"}
{"level":50,"time":1768708859217,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["e6ba5d6a-a22a-4391-8593-de16a37a26e0","$2b$12$DildLUWXXOIqZ50EvHm9xOU6lwQxYWE4F7Hs.g7GxpFeW5ordxDLq"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(e6ba5d6a-a22a-4391-8593-de16a37a26e0) is not present in table \"users\".","schema":"test_schema_w134_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w139_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ListTools.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w135_v3, public
âœ… Enforced search_path: test_schema_w135_v3, public

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w139_v3 (Reused: true)

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/ListTools.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w134_v3
âœ… Current search_path: test_schema_w134_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

{"level":30,"time":1768708859584,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708859584,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/services/DataSourceService.test.ts [2m([22m[2m9 tests[22m[2m)[22m[33m 2957[2mms[22m[39m
{"level":30,"time":1768708859625,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708859626,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/branding.routes.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 2955[2mms[22m[39m
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w136_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708859780,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708859781,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mðŸ“Š Schema test_schema_w139_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w136_v3 (Reused: true)

{"level":30,"time":1768708859803,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708859804,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w139_v3\",public"}
 [32mâœ“[39m tests/services/BrandingService.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 2989[2mms[22m[39m
{"level":30,"time":1768708859824,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708859825,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768708859863,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w139_v3\",public"}
{"level":30,"time":1768708859863,"env":"test","msg":"DB: initialized flag set."}
[DEBUG] BaseRepository.update datavault_tables: id=660e8400-e29b-41d4-a716-446655440001, updates={"name":"Updated Table","description":"Updated description","updatedAt":"2026-01-18T04:00:59.868Z"}
{"level":30,"time":1768708859873,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708859874,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/services/StepService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 3003[2mms[22m[39m
 [32mâœ“[39m tests/unit/repositories/DatavaultTablesRepository.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 3004[2mms[22m[39m
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w142_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w142_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mðŸ“Š Schema test_schema_w136_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708860229,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708860230,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w136_v3\",public"}
[90mstdout[2m | tests/ListTools.test.ts
[22m[39mâœ… Applied failsafe schema fixes

{"level":30,"time":1768708860284,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w136_v3\",public"}
{"level":30,"time":1768708860284,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/ListTools.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":50,"time":1768708860341,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["0fd14cba-70ea-4093-8427-5094dc83774e","$2b$12$CQ9EQLzMws11lyIAhc1qJ./R4eNghqy.tfcJXeFm7J0jJRbwHep6C"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(0fd14cba-70ea-4093-8427-5094dc83774e) is not present in table \"users\".","schema":"test_schema_w135_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"0fd14cba-70ea-4093-8427-5094dc83774e","msg":"Failed to create user credentials"}
{"level":50,"time":1768708860341,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["0fd14cba-70ea-4093-8427-5094dc83774e","$2b$12$CQ9EQLzMws11lyIAhc1qJ./R4eNghqy.tfcJXeFm7J0jJRbwHep6C"],"cause":{"length":348,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(0fd14cba-70ea-4093-8427-5094dc83774e) is not present in table \"users\".","schema":"test_schema_w135_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w125_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w125_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mðŸ“Š Schema test_schema_w142_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

{"level":40,"time":1768708860632,"env":"test","sourceListVar":"nonexistent_list","inputKey":"nonexistent_list","msg":"Input list not found, treating as empty array"}
[90mstdout[2m | tests/ListTools.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708860634,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768708860635,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w139_v3, public
âœ… Enforced search_path: test_schema_w139_v3, public

 [32mâœ“[39m tests/ListTools.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 3011[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w43_v3
âœ… Current search_path: test_schema_w43_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708860788,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w140_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708860789,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w140_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mðŸ“Š Schema test_schema_w125_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708860878,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708860879,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w125_v3\",public"}
{"level":30,"time":1768708860940,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w125_v3\",public"}
{"level":30,"time":1768708860940,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w141_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w141_v3 (Reused: true)

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w136_v3, public
âœ… Enforced search_path: test_schema_w136_v3, public

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w43_v3
âœ… Current search_path: test_schema_w43_v3, public
â© Schema reused, skipping migrations.

 [31mâ¯[39m tests/integration/auth/auth.middleware.integration.test.ts [2m([22m[2m27 tests[22m[2m | [22m[31m17 failed[39m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 35005[2mms[22m[39m
[31m       [31mÃ—[31m should allow access with valid JWT Bearer token[39m[33m 531[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 when no token provided[39m[33m 818[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 with invalid token[39m[33m 862[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 401 with expired token [33m 3103[2mms[22m[39m
       [2m[90mâ†“[39m[22m should proceed without authentication if no token provided
[31m       [31mÃ—[31m should authenticate with JWT Bearer token[39m[33m 1382[2mms[22m[39m
       [33m[2mâœ“[22m[39m should authenticate with refresh token cookie (GET only) [33m 1377[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject cookie auth for POST requests (mutation-strict) [33m 1194[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject cookie auth for PUT requests [33m 1183[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject cookie auth for DELETE requests [33m 1428[2mms[22m[39m
       [33m[2mâœ“[22m[39m should allow cookie auth for HEAD requests [33m 1261[2mms[22m[39m
       [33m[2mâœ“[22m[39m should prioritize JWT over cookie when both present [33m 2450[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 401 when no auth provided [33m 1121[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 401 when both JWT and cookie are invalid [33m 1131[2mms[22m[39m
[31m       [31mÃ—[31m should authenticate with JWT if provided[39m[33m 1818[2mms[22m[39m
[31m       [31mÃ—[31m should authenticate with cookie if JWT not provided[39m[33m 557[2mms[22m[39m
[31m       [31mÃ—[31m should proceed anonymously if no auth provided[39m[33m 727[2mms[22m[39m
[31m       [31mÃ—[31m should proceed anonymously if both JWT and cookie are invalid[39m[33m 1116[2mms[22m[39m
[31m       [31mÃ—[31m should only allow safe methods for cookie auth[39m[33m 891[2mms[22m[39m
[31m       [31mÃ—[31m should ignore cookies when Bearer token present[39m[33m 795[2mms[22m[39m
[31m       [31mÃ—[31m should attach userId to request[39m[33m 944[2mms[22m[39m
[31m       [31mÃ—[31m should attach userEmail to request[39m[33m 1314[2mms[22m[39m
[31m       [31mÃ—[31m should return consistent error format for missing token[39m[33m 881[2mms[22m[39m
[31m       [31mÃ—[31m should return consistent error format for invalid token[39m[33m 826[2mms[22m[39m
[31m       [31mÃ—[31m should return consistent error format for expired token[39m[33m 769[2mms[22m[39m
[31m       [31mÃ—[31m should handle malformed JWT gracefully[39m[33m 801[2mms[22m[39m
[31m       [31mÃ—[31m should handle JWT with wrong algorithm[39m[33m 1125[2mms[22m[39m
[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mðŸ“Š Schema test_schema_w140_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708861261,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708861262,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w140_v3\",public"}
[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768708861314,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w140_v3\",public"}
{"level":30,"time":1768708861315,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mðŸ“Š Schema test_schema_w141_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

{"level":30,"time":1768708861495,"env":"test","workflowId":"123e4567-e89b-12d3-a456-426614174000","userId":"user-123","sectionsCount":2,"stepsCount":0,"logicRulesCount":1,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/services/WorkflowService.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 1914[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return workflow if user is the creator [33m 1034[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w143_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w144_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w143_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w144_v3 (Reused: true)

[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w125_v3, public
âœ… Enforced search_path: test_schema_w125_v3, public

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w140_v3
âœ… Current search_path: test_schema_w140_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w137_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w137_v3 (Reused: true)

{"level":30,"time":1768708861940,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708861941,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w138_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [32mâœ“[39m tests/unit/services/DatavaultTablesService.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 3017[2mms[22m[39m
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w138_v3 (Reused: true)

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w146_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w147_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w146_v3 (Reused: true)

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w145_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w147_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mðŸ“Š Schema test_schema_w144_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mðŸ“Š Schema test_schema_w143_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w140_v3, public
âœ… Enforced search_path: test_schema_w140_v3, public

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w145_v3 (Reused: true)

 [32mâœ“[39m tests/unit/services/BrandingService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 914[2mms[22m[39m
[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w149_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w140_v3
âœ… Current search_path: test_schema_w140_v3, public
â© Schema reused, skipping migrations.

 [32mâœ“[39m tests/unit/services/PortalAuthService.test.ts [2m([22m[2m42 tests[22m[2m)[22m[33m 1041[2mms[22m[39m
[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w149_v3 (Reused: true)

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mðŸ“Š Schema test_schema_w137_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708862346,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708862347,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w137_v3\",public"}
[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstderr[2m | tests/unit/debugging/Lineage.test.ts[2m > [22m[2mDebug & Lineage[2m > [22m[2mshould generate execution trace with lineage
[22m[39m[DEBUG Question] Node q1 executed. Key: userName, Value: Alice. Context keys: 3

{"level":30,"time":1768708862372,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708862373,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768708862400,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w137_v3\",public"}
{"level":30,"time":1768708862400,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mðŸ“Š Schema test_schema_w138_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768708862435,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768708862436,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w138_v3\",public"}
 [32mâœ“[39m tests/unit/debugging/Lineage.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 3019[2mms[22m[39m
{"level":30,"time":1768708862494,"env":"test","msg":"DB: Wrapped transaction() to enforce search_path=\"test_schema_w138_v3\",public"}
{"level":30,"time":1768708862494,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mðŸ“Š Schema test_schema_w146_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w148_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mðŸ“Š Schema test_schema_w147_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mðŸ“Š Schema test_schema_w145_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

 [32mâœ“[39m tests/unit/engine/FinalBlockSnapshot.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 920[2mms[22m[39m
{"level":40,"time":1768708862575,"env":"test","hookId":"hook-1","hookName":"Hook 1","error":"Test error","msg":"LifecycleHookService: Hook execution failed"}
[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w148_v3 (Reused: true)

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/services/DatavaultReferenceColumns.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 893[2mms[22m[39m
{"level":50,"time":1768708862580,"env":"test","error":{},"workflowId":"workflow-1","runId":"run-1","phase":"beforePage","msg":"LifecycleHookService: Failed to execute hooks for phase"}
{"level":30,"time":1768708862584,"env":"test","hookId":"hook-1","workflowId":"workflow-1","phase":"beforePage","msg":"LifecycleHookService: Created lifecycle hook"}
{"level":30,"time":1768708862591,"env":"test","hookId":"hook-1","workflowId":"workflow-1","msg":"LifecycleHookService: Updated lifecycle hook"}
{"level":30,"time":1768708862595,"env":"test","hookId":"hook-1","workflowId":"workflow-1","msg":"LifecycleHookService: Deleted lifecycle hook"}
 [32mâœ“[39m tests/unit/LifecycleHookService.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 891[2mms[22m[39m
 [32mâœ“[39m tests/unit/services/MfaService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 2057[2mms[22m[39m
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mðŸ“Š Schema test_schema_w149_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstderr[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): Error: [vitest] No "closeDatabase" export is defined on the "../../../server/db" mock. Did you forget to return it from "vi.mock"?
If you need to partially mock a module, you can use "importOriginal" helper inside:

    at VitestMocker.createError [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:311:17[90m)[39m
    at Object.get [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:384:16[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:177:34
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m {
  codeFrame: [32m'vi.mock(import("../../../server/db"), async (importOriginal) => {\n'[39m +
    [32m'  const actual = await importOriginal()\n'[39m +
    [32m'  return {\n'[39m +
    [32m'    ...actual,\n'[39m +
    [32m'    // your mocked methods\n'[39m +
    [32m'  }\n'[39m +
    [32m'})'[39m
}

{"level":30,"time":1768708862703,"env":"test","module":"write-runner","operation":"write_start","mode":"create","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"create","columnMappings":[{"columnId":"col-first","value":"{{ firstName }}"},{"columnId":"col-last","value":"Doe"},{"columnId":"col-age","value":"{{ age }}"}]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

{"level":30,"time":1768708862712,"env":"test","module":"write-runner","operation":"write_start","mode":"create","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"create","columnMappings":[]},"tableId":"table-users","preview":true,"msg":"Starting write execution"}
[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":30,"time":1768708862713,"env":"test","module":"write-runner","operation":"write_preview_simulated","values":{},"msg":"Simulating write in preview mode"}
{"level":30,"time":1768708862714,"env":"test","module":"write-runner","operation":"write_start","mode":"update","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"test@example.com","columnMappings":[{"columnId":"col-status","value":"Active"}]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
{"level":30,"time":1768708862716,"env":"test","module":"write-runner","operation":"write_start","mode":"update","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"missing@example.com","columnMappings":[]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
{"level":50,"time":1768708862716,"env":"test","module":"write-runner","error":{},"config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"missing@example.com","columnMappings":[]},"msg":"Write execution failed"}
 [32mâœ“[39m tests/unit/writes/WriteRunner.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 919[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mðŸ“Š Schema test_schema_w148_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708863028,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768708863051,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts[2m > [22m[2mAI Document Assistant API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

{"level":30,"time":1768708863038,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768708863039,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768708863044,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768708863045,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768708863051,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768708863051,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768708863051,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768708863051,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
 [32mâœ“[39m tests/unit/services/DatavaultRowsService.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 892[2mms[22m[39m
[90mstdout[2m | tests/unit/collab.server.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

{"level":40,"time":1768708863083,"env":"test","error":{},"msg":"Deterministic DOCX extraction failed"}
[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w150_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768708863141,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708863142,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w150_v3 (Reused: true)

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w137_v3, public
âœ… Enforced search_path: test_schema_w137_v3, public

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w138_v3, public
âœ… Enforced search_path: test_schema_w138_v3, public

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w138_v3
âœ… Current search_path: test_schema_w138_v3, public
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mâœ… Database initialized. Current schema: test_schema_w138_v3
âœ… Current search_path: test_schema_w138_v3, public
â© Schema reused, skipping migrations.

{"level":30,"time":1768708863388,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708863389,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/api.ai.doc.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 3157[2mms[22m[39m
 [32mâœ“[39m tests/unit/debug_import.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 2996[2mms[22m[39m
[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w154_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w154_v3 (Reused: true)

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mðŸ“Š Schema test_schema_w150_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w151_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/repositories/DatavaultRowsRepository.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 867[2mms[22m[39m
[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w151_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w152_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w155_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w152_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w155_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w153_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/collab.server.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w153_v3 (Reused: true)

[90mstdout[2m | tests/unit/collab.server.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mðŸ“Š Schema test_schema_w154_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

{"level":30,"time":1768708863937,"env":"test","msg":"External Send Completed","destination":"My Webhook","success":true,"status":200}
[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708863941,"env":"test","msg":"Simulating External Send","destination":"Test","payload":{}}
 [32mâœ“[39m tests/unit/external/ExternalSendRunner.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 855[2mms[22m[39m
 [2m[90mâ†“[39m[22m tests/unit/collab.server.test.ts [2m([22m[2m14 tests[22m[2m | [22m[33m14 skipped[39m[2m)[22m
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mðŸ“Š Schema test_schema_w151_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/services/AccountLockoutService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 890[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_context_key",
      "p_min_digits",
      "p_prefix",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]
DEBUG: Dropping existing function: datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mâœ… Applied failsafe schema fixes

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mDEBUG: Existing functions: []

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mðŸ“Š Schema test_schema_w152_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mðŸ“Š Schema test_schema_w155_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/services/Guardrail.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 847[2mms[22m[39m
[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mðŸ“Š Schema test_schema_w153_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

 [32mâœ“[39m tests/unit/services/EmailTemplateMetadataService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 903[2mms[22m[39m
[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/services/AuditLogService.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 833[2mms[22m[39m
{"level":30,"time":1768708864418,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708864418,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/datavault.routes.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 2924[2mms[22m[39m
{"level":30,"time":1768708864534,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768708864534,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/datavault.row-notes.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 2986[2mms[22m[39m
Failed to parse file:///C:/Users/scoot/poll/VaultLogic/client/src/components/builder/cards/ChoiceCardEditor.tsx. Excluding it from coverage.
 Error [RollupError]: Expected ',', got 'UniversalBlock'
    at getRollupError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/rollup/dist/es/shared/parseAst.js:401:41)
    at convertProgram (file:///C:/Users/scoot/poll/VaultLogic/node_modules/rollup/dist/es/shared/parseAst.js:1098:26)
    at parseAstAsync (file:///C:/Users/scoot/poll/VaultLogic/node_modules/rollup/dist/es/shared/parseAst.js:2084:106)
    at V8CoverageProvider.remapCoverage (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/coverage-v8/dist/provider.js:135:10)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/coverage-v8/dist/provider.js:121:23
    at async Promise.all (index 7)
    at V8CoverageProvider.getCoverageMapForUncoveredFiles (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/coverage-v8/dist/provider.js:111:4)
    at V8CoverageProvider.generateCoverage (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/coverage-v8/dist/provider.js:59:29)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/cli-api.BKg19Fvw.js:12546:23
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/cli-api.BKg19Fvw.js:12559:11 {
  code: 'PARSE_ERROR',
  pos: 1537
}

[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m[1m[41m Failed Suites 24 [49m[22m[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m

[41m[1m FAIL [22m[49m tests/integration/api.dataSources.native.test.ts[2m > [22mData Sources API - Native Catalog
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/api.dataSources.native.test.ts:[2m20:15[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[1/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.dataSources.native.test.ts[2m > [22mData Sources API - Native Catalog
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/api.dataSources.native.test.ts:[2m30:19[22m[39m
    [90m 28| [39m
    [90m 29| [39m    [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 30| [39m        [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m                  [31m^[39m
    [90m 31| [39m    })[33m;[39m
    [90m 32| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[2/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.expression-validation.test.ts[2m > [22mExpression Validation API Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/api.expression-validation.test.ts:[2m20:11[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[3/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.expression-validation.test.ts[2m > [22mExpression Validation API Integration Tests
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/api.expression-validation.test.ts:[2m76:15[22m[39m
    [90m 74| [39m
    [90m 75| [39m  [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 76| [39m    [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m              [31m^[39m
    [90m 77| [39m  })[33m;[39m
    [90m 78| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[4/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.projects.test.ts[2m > [22mProjects API Integration Tests
[31m[1mError[22m: expected 201 "Created", got 500 "Internal Server Error"[39m
[36m [2mâ¯[22m tests/integration/api.projects.test.ts:[2m66:8[22m[39m
    [90m 64| [39m        lastName[33m:[39m [32m"User"[39m[33m,[39m
    [90m 65| [39m      })
    [90m 66| [39m      [33m.[39m[34mexpect[39m([34m201[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m 67| [39m
    [90m 68| [39m    authToken [33m=[39m registerResponse[33m.[39mbody[33m.[39mtoken[33m;[39m
[90m [2mâ¯[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2mâ¯[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2mâ¯[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2mâ¯[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m156:7[22m[39m
[90m [2mâ¯[22m Test.Request.callback node_modules/superagent/lib/node/index.js:[2m857:3[22m[39m
[90m [2mâ¯[22m node_modules/superagent/lib/node/index.js:[2m1102:18[22m[39m
[90m [2mâ¯[22m IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:[2m21:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[5/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.runs.docx.test.ts[2m > [22mRuns API - DOCX Generation Integration Tests
[31m[1mError[22m: expected 201 "Created", got 403 "Forbidden"[39m
[36m [2mâ¯[22m tests/integration/api.runs.docx.test.ts:[2m140:8[22m[39m
    [90m138| [39m      [33m.[39m[34mfield[39m([32m'name'[39m[33m,[39m [32m'Invoice Template'[39m)
    [90m139| [39m      [33m.[39m[34mattach[39m([32m'file'[39m[33m,[39m templateBuffer[33m,[39m [32m'invoice-template.docx'[39m)
    [90m140| [39m      [33m.[39m[34mexpect[39m([34m201[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m141| [39m
    [90m142| [39m    templateId [33m=[39m templateResponse[33m.[39mbody[33m.[39mid[33m;[39m
[90m [2mâ¯[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2mâ¯[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2mâ¯[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2mâ¯[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m156:7[22m[39m
[90m [2mâ¯[22m Test.Request.callback node_modules/superagent/lib/node/index.js:[2m857:3[22m[39m
[90m [2mâ¯[22m node_modules/superagent/lib/node/index.js:[2m1102:18[22m[39m
[90m [2mâ¯[22m IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:[2m21:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[6/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.runs.graph.test.ts[2m > [22mStage 8: Runs API Integration Tests
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, default, $3, $4, default, $5, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project for Runs,Test Project for Runs,test-user-runs-stage8,48b490ca-fe20-41ea-895f-c5705c8f6a12,test-user-runs-stage8[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/api.runs.graph.test.ts:[2m156:23[22m[39m
    [90m154| [39m
    [90m155| [39m    [90m// Create project[39m
    [90m156| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(schema[33m.[39mprojects)[33m.[39m[34mvalues[39m({
    [90m   | [39m                      [31m^[39m
    [90m157| [39m      title[33m:[39m [32m"Test Project for Runs"[39m[33m,[39m
    [90m158| [39m      name[33m:[39m [32m"Test Project for Runs"[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/api.runs.graph.test.ts:[2m156:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 309, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(test-user-runs-stage8) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w36_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[7/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.templates-runs.test.ts[2m > [22mTemplates and Runs API Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m Module.setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/api.templates-runs.test.ts:[2m59:11[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[8/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.templates-runs.test.ts[2m > [22mTemplates and Runs API Integration Tests
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/api.templates-runs.test.ts:[2m85:15[22m[39m
    [90m 83| [39m
    [90m 84| [39m  [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 85| [39m    [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m              [31m^[39m
    [90m 86| [39m  })[33m;[39m
    [90m 87| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[9/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.workflows.test.ts[2m > [22mWorkflows API Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m Module.setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/api.workflows.test.ts:[2m42:11[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[10/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.workflows.test.ts[2m > [22mWorkflows API Integration Tests
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/api.workflows.test.ts:[2m52:15[22m[39m
    [90m 50| [39m
    [90m 51| [39m  [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 52| [39m    [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m              [31m^[39m
    [90m 53| [39m  })[33m;[39m
    [90m 54| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[11/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/dataBlocks.test.ts[2m > [22mData Block Integration Tests
[31m[1mError[22m: Failed query: insert into "datavault_databases" ("id", "tenant_id", "name", "description", "type", "config", "scope_type", "scope_id", "owner_type", "owner_uuid", "created_at", "updated_at") values (default, $1, $2, default, default, default, default, default, default, default, default, default) returning "id", "tenant_id", "name", "description", "type", "config", "scope_type", "scope_id", "owner_type", "owner_uuid", "created_at", "updated_at"
params: f2cb1093-6d6e-412b-9a7f-2f12f6445680,Test Database[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/dataBlocks.test.ts:[2m60:28[22m[39m
    [90m 58| [39m
    [90m 59| [39m        [90m// 2. Setup DataVault Schema[39m
    [90m 60| [39m        [35mconst[39m [database] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(datavaultDatabases)[33m.[39m[34mvalues[39m({
    [90m   | [39m                           [31m^[39m
    [90m 61| [39m            name[33m:[39m [32m'Test Database'[39m[33m,[39m
    [90m 62| [39m            tenantId[33m:[39m tenantId[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "datavault_databases" violates foreign key constraint "datavault_databases_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/dataBlocks.test.ts:[2m60:28[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 371, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f2cb1093-6d6e-412b-9a7f-2f12f6445680) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w41_v3', table: 'datavault_databases', dataType: undefined, constraint: 'datavault_databases_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[12/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault-v4-regression.test.ts[2m > [22mDataVault v4 Regression Tests
[31m[1mError[22m: Other user login failed: {"message":"Authentication failed","error":"auth_failed"}[39m
[36m [2mâ¯[22m tests/integration/datavault-v4-regression.test.ts:[2m148:13[22m[39m
    [90m146| [39m
    [90m147| [39m    [35mif[39m (otherLoginResponse[33m.[39mstatus [33m!==[39m [34m200[39m) {
    [90m148| [39m      throw new Error(`Other user login failed: ${JSON.stringify(otherâ€¦
    [90m   | [39m            [31m^[39m
    [90m149| [39m    }
    [90m150| [39m    otherUserCookie [33m=[39m otherLoginResponse[33m.[39mheaders[[32m"set-cookie"[39m][33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[13/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault.autonumber.test.ts[2m > [22mDataVault Autonumber Integration Tests
[31m[1mError[22m: Failed query: insert into "datavault_tables" ("id", "tenant_id", "owner_user_id", "database_id", "name", "slug", "description", "created_at", "updated_at") values (default, $1, $2, default, $3, $4, $5, default, default) returning "id", "tenant_id", "owner_user_id", "database_id", "name", "slug", "description", "created_at", "updated_at"
params: 521589a4-4716-4f42-a158-d3dad3f33128,,Autonumber Test Table,autonumber_test_table,Testing autonumber functionality[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m DatavaultTablesRepository.create server/repositories/BaseRepository.ts:[2m90:22[22m[39m
    [90m 88| [39m    [35mconst[39m database [33m=[39m [35mthis[39m[33m.[39m[34mgetDb[39m(tx)[33m;[39m
    [90m 89| [39m
    [90m 90| [39m    [35mconst[39m [record] [33m=[39m [35mawait[39m database
    [90m   | [39m                     [31m^[39m
    [90m 91| [39m      [33m.[39m[34minsert[39m([35mthis[39m[33m.[39mtable [35mas[39m any)
    [90m 92| [39m      [33m.[39m[34mvalues[39m(data [35mas[39m any)
[90m [2mâ¯[22m DatavaultTablesService.createTable server/services/DatavaultTablesService.ts:[2m171:19[22m[39m
[90m [2mâ¯[22m tests/integration/datavault.autonumber.test.ts:[2m29:19[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "datavault_tables" violates foreign key constraint "datavault_tables_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m DatavaultTablesRepository.create server/repositories/BaseRepository.ts:[2m90:22[22m[39m
[90m [2mâ¯[22m DatavaultTablesService.createTable server/services/DatavaultTablesService.ts:[2m171:19[22m[39m
[90m [2mâ¯[22m tests/integration/datavault.autonumber.test.ts:[2m29:19[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 359, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(521589a4-4716-4f42-a158-d3dad3f33128) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w26_v3', table: 'datavault_tables', dataType: undefined, constraint: 'datavault_tables_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[14/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault.permissions.test.ts[2m > [22mDataVault Table Permissions API (v4 Micro-Phase 6)
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/datavault.permissions.test.ts:[2m22:11[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[15/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault.permissions.test.ts[2m > [22mDataVault Table Permissions API (v4 Micro-Phase 6)
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/datavault.permissions.test.ts:[2m66:15[22m[39m
    [90m 64| [39m
    [90m 65| [39m  [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 66| [39m    [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m              [31m^[39m
    [90m 67| [39m  })[33m;[39m
    [90m 68| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[16/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/dynamic_options_workflow.test.ts[2m > [22mDynamic Options Integration Flow
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, default, default, default, default, default, default, default, default, $5, $6, $7, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Dynamic Options Test,Testing read -> choice flow,47e0e009-1fbb-4709-a17b-975c156bdf20,47e0e009-1fbb-4709-a17b-975c156bdf20,draft,user,47e0e009-1fbb-4709-a17b-975c156bdf20[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m WorkflowRepository.create server/repositories/BaseRepository.ts:[2m90:22[22m[39m
    [90m 88| [39m    [35mconst[39m database [33m=[39m [35mthis[39m[33m.[39m[34mgetDb[39m(tx)[33m;[39m
    [90m 89| [39m
    [90m 90| [39m    [35mconst[39m [record] [33m=[39m [35mawait[39m database
    [90m   | [39m                     [31m^[39m
    [90m 91| [39m      [33m.[39m[34minsert[39m([35mthis[39m[33m.[39mtable [35mas[39m any)
    [90m 92| [39m      [33m.[39m[34mvalues[39m(data [35mas[39m any)
[90m [2mâ¯[22m WorkflowRepository.create server/repositories/WorkflowRepository.ts:[2m25:22[22m[39m
[90m [2mâ¯[22m server/services/WorkflowService.ts:[2m173:24[22m[39m
[90m [2mâ¯[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2mâ¯[22m tests/integration/dynamic_options_workflow.test.ts:[2m41:26[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m WorkflowRepository.create server/repositories/BaseRepository.ts:[2m90:22[22m[39m
[90m [2mâ¯[22m WorkflowRepository.create server/repositories/WorkflowRepository.ts:[2m25:22[22m[39m
[90m [2mâ¯[22m server/services/WorkflowService.ts:[2m173:24[22m[39m
[90m [2mâ¯[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2mâ¯[22m tests/integration/dynamic_options_workflow.test.ts:[2m41:26[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(47e0e009-1fbb-4709-a17b-975c156bdf20) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w26_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[17/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/externalSends.test.ts[2m > [22mExternal Send Block Integration
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, $6, default, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 23fb3741-d0ce-41d5-b2c1-9e221757c9fe,ext-test-1768708823061@example.com,91f22734-e8f8-4372-a826-db24a7c49087,admin,owner,local[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/externalSends.test.ts:[2m38:24[22m[39m
    [90m 36| [39m        tenantId [33m=[39m tenant[33m.[39mid[33m;[39m
    [90m 37| [39m
    [90m 38| [39m        [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                       [31m^[39m
    [90m 39| [39m            id[33m:[39m [34muuidv4[39m()[33m,[39m
    [90m 40| [39m            email[33m:[39m [32m`ext-test-[39m[36m${[39m[33mDate[39m[33m.[39m[34mnow[39m()[36m}[39m[32m@example.com`[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/externalSends.test.ts:[2m38:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(91f22734-e8f8-4372-a826-db24a7c49087) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w46_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[18/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/intake.workflow.test.ts[2m > [22mIntake Workflow Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/intake.workflow.test.ts:[2m11:15[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[19/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/intake.workflow.test.ts[2m > [22mIntake Workflow Integration Tests
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/intake.workflow.test.ts:[2m21:19[22m[39m
    [90m 19| [39m
    [90m 20| [39m    [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 21| [39m        [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m                  [31m^[39m
    [90m 22| [39m    })[33m;[39m
    [90m 23| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[20/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/lifecycle-hooks-execution.test.ts[2m > [22mLifecycle Hooks Execution
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/lifecycle-hooks-execution.test.ts:[2m41:11[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[21/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/lifecycle-hooks-execution.test.ts[2m > [22mLifecycle Hooks Execution
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/lifecycle-hooks-execution.test.ts:[2m89:15[22m[39m
    [90m 87| [39m
    [90m 88| [39m  [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 89| [39m    [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m              [31m^[39m
    [90m 90| [39m  })[33m;[39m
    [90m 91| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-audit-fixes.test.ts[2m > [22mOrganization Audit Fixes
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict do nothing
params: 165b286f-e3c9-4252-b000-22f1675b4ce1,audit-user1@test.com,Audit User 1,62da92f3-35be-44b3-aa6d-3debbe628148,4253c76f-5103-491d-9a2a-91e4b797e435,audit-user2@test.com,Audit User 2,62da92f3-35be-44b3-aa6d-3debbe628148[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizations-audit-fixes.test.ts:[2m42:5[22m[39m
    [90m 40| [39m
    [90m 41| [39m    [90m// Create test users[39m
    [90m 42| [39m    [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m    [31m^[39m
    [90m 43| [39m      {
    [90m 44| [39m        id[33m:[39m user1Id[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizations-audit-fixes.test.ts:[2m42:5[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(62da92f3-35be-44b3-aa6d-3debbe628148) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[23/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-workflow.test.ts[2m > [22mOrganization Workflow Integration Tests
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default), ($9, $10, $11, default, default, default, $12, default, default, default, default, default, default, default, default, default, default, default) on conflict do nothing
params: ab4f6b2a-e31c-4c35-8822-63754644dbd0,org-owner@test.com,Org Owner,ba226ba1-82f2-44e4-a045-7c71af0d81e9,286af293-40e9-458f-a575-83713e74bd17,org-member@test.com,Org Member,ba226ba1-82f2-44e4-a045-7c71af0d81e9,b2cf86ec-179c-4299-99da-beb6ca0db87e,non-member@test.com,Non Member,ba226ba1-82f2-44e4-a045-7c71af0d81e9[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizations-workflow.test.ts:[2m50:5[22m[39m
    [90m 48| [39m
    [90m 49| [39m    [90m// Create test users[39m
    [90m 50| [39m    [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m    [31m^[39m
    [90m 51| [39m      {
    [90m 52| [39m        id[33m:[39m user1Id[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizations-workflow.test.ts:[2m50:5[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(ba226ba1-82f2-44e4-a045-7c71af0d81e9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w35_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[24/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/regression-REG-1.test.ts[2m > [22mREG-1: Workflow Logic Regression
[31m[1mError[22m: Failed query: insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values ($1, $2, default, $3, default, default, $4, default, default, default)
params: 93ac6b15-409f-44c4-9e56-fde03e602308,Regression Test Tenant,reg-test-93ac6b15-409f-44c4-9e56-fde03e602308,ac7eadb6-035f-4b2d-b0ce-d20815590766[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/regression-REG-1.test.ts:[2m56:9[22m[39m
    [90m 54| [39m
    [90m 55| [39m        tenantId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 56| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(organizations)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 57| [39m            id[33m:[39m tenantId[33m,[39m
    [90m 58| [39m            tenantId[33m:[39m rootTenantId[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "organizations" violates foreign key constraint "organizations_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/regression-REG-1.test.ts:[2m56:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 347, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(ac7eadb6-035f-4b2d-b0ce-d20815590766) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w25_v3', table: 'organizations', dataType: undefined, constraint: 'organizations_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[25/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/workflow_versioning.test.ts[2m > [22mWorkflow Versioning & Lineage
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values (default, $1, $2, default, default, default, $3, $4, $5, default, default, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: test_versioning_1768708817582@example.com,Versioning Tester,9eb02a4e-df59-4cc7-9d6c-f600d9d395ab,admin,owner[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/workflow_versioning.test.ts:[2m27:24[22m[39m
    [90m 25| [39m
    [90m 26| [39m        [90m// Create User (Needed for Project creator/owner)[39m
    [90m 27| [39m        [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                       [31m^[39m
    [90m 28| [39m            email[33m:[39m [32m`test_versioning_[39m[36m${[39m[33mDate[39m[33m.[39m[34mnow[39m()[36m}[39m[32m@example.com`[39m[33m,[39m
    [90m 29| [39m            fullName[33m:[39m [32m"Versioning Tester"[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/workflow_versioning.test.ts:[2m27:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(9eb02a4e-df59-4cc7-9d6c-f600d9d395ab) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w39_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[26/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/jwt.authentication.test.ts[2m > [22mJWT Authentication Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/auth/jwt.authentication.test.ts:[2m31:15[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[27/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/jwt.authentication.test.ts[2m > [22mJWT Authentication Integration Tests
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/auth/jwt.authentication.test.ts:[2m40:19[22m[39m
    [90m 38| [39m
    [90m 39| [39m    [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 40| [39m        [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m                  [31m^[39m
    [90m 41| [39m    })[33m;[39m
    [90m 42| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[28/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: UrwoQWYoaRYiFsDpBPmQ_,oauth-test@example.com,OAuth Tester,OAuth,Tester,84cee8c2-2ef4-46f8-9fe3-9ce4e7863770,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.callback.test.ts:[2m62:20[22m[39m
    [90m 60| [39m    testTenantId [33m=[39m tenant[33m.[39mid[33m;[39m
    [90m 61| [39m
    [90m 62| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 63| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 64| [39m      email[33m:[39m [32m'oauth-test@example.com'[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.callback.test.ts:[2m62:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(84cee8c2-2ef4-46f8-9fe3-9ce4e7863770) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w19_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[29/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/protected.routes.test.ts[2m > [22mProtected Routes Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/auth/protected.routes.test.ts:[2m31:15[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[30/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/session.management.integration.test.ts[2m > [22mSession Management Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/auth/session.management.integration.test.ts:[2m31:15[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[31/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/session.management.integration.test.ts[2m > [22mSession Management Integration Tests
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/auth/session.management.integration.test.ts:[2m40:19[22m[39m
    [90m 38| [39m
    [90m 39| [39m    [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 40| [39m        [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m                  [31m^[39m
    [90m 41| [39m    })[33m;[39m
    [90m 42| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[32/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/workflows/runtime-pipelines.test.ts[2m > [22mRuntime Pipelines Integration Tests
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, default, default, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: l0wDsraFIWBNhGWFIe03f,test-pipeline-user@example.com,8186bfba-4e98-4ed7-908e-f46e0798e354,admin,owner[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/workflows/runtime-pipelines.test.ts:[2m75:20[22m[39m
    [90m 73| [39m
    [90m 74| [39m    [90m// Create test user[39m
    [90m 75| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 76| [39m      id[33m:[39m testUserId[33m,[39m
    [90m 77| [39m      email[33m:[39m [32m'test-pipeline-user@example.com'[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/workflows/runtime-pipelines.test.ts:[2m75:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(8186bfba-4e98-4ed7-908e-f46e0798e354) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w46_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[33/354]âŽ¯[22m[39m


[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m[1m[41m Failed Tests 321 [49m[22m[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m

[41m[1m FAIL [22m[49m tests/integration/analytics_service.test.ts[2m > [22mAnalytics Service Integration[2m > [22mshould generate events and metrics on run completion
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'id')[39m
[36m [2mâ¯[22m tests/integration/analytics_service.test.ts:[2m64:57[22m[39m
    [90m 62| [39m        // Looking at RunService signature: createRun(workflowId: striâ€¦
    [90m 63| [39m
    [90m 64| [39m        const run = await runService.createRun(workflow.id, undefined,â€¦
    [90m   | [39m                                                        [31m^[39m
    [90m 65| [39m        [35mconst[39m runId [33m=[39m run[33m.[39mid[33m;[39m
    [90m 66| [39m        [35mconst[39m runToken [33m=[39m run[33m.[39mrunToken[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[34/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.snapshots.test.ts[2m > [22mStage 13: Workflow Snapshots & Versioning[2m > [22mshould maintain immutability of runs across versions
[31m[1mError[22m: Failed query: insert into "workflow_versions" ("id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at") values (default, $1, default, $2, default, $3, default, default, default, default, $4, $5, $6, default, default) returning "id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at"
params: ef4932fb-8eb1-4631-9ef1-5731ba808abe,2,{"nodes":[{"id":"q1","type":"question","config":{"key":"q1","question":"Version 2 Question (Updated)","type":"short_text"}}],"edges":[],"startNodeId":"q1"},test-user-id,true,2026-01-18T04:00:19.977Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/api.snapshots.test.ts:[2m202:28[22m[39m
    [90m200| [39m
    [90m201| [39m        [90m// 5. Publish Version 2[39m
    [90m202| [39m        const [version2] = await db.insert(schema.workflowVersions).vaâ€¦
    [90m   | [39m                           [31m^[39m
    [90m203| [39m            workflowId[33m,[39m
    [90m204| [39m            graphJson[33m:[39m graphV2[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "workflow_versions" violates foreign key constraint "workflow_versions_workflow_id_workflows_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/api.snapshots.test.ts:[2m202:28[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 375, severity: 'ERROR', code: '23503', detail: 'Key (workflow_id)=(ef4932fb-8eb1-4631-9ef1-5731ba808abe) is not present in table "workflows".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w32_v3', table: 'workflow_versions', dataType: undefined, constraint: 'workflow_versions_workflow_id_workflows_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[35/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mComplete Registration â†’ Login Flow[2m > [22mshould complete registration, verify email, then login
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m73:39[22m[39m
    [90m 71| [39m        })[33m;[39m
    [90m 72| [39m
    [90m 73| [39m      [34mexpect[39m(registerResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                                      [31m^[39m
    [90m 74| [39m      [34mexpect[39m(registerResponse[33m.[39mbody[33m.[39muser[33m.[39memailVerified)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
    [90m 75| [39m      [34mtrackUser[39m(registerResponse[33m.[39mbody[33m.[39muser[33m.[39mid)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[36/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mAccount Lockout Flow[2m > [22mshould lock account after 5 failed attempts, then unlock after waiting
[31m[1mAssertionError[22m: expected 401 to be 423 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 423[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m138:36[22m[39m
    [90m136| [39m        })[33m;[39m
    [90m137| [39m
    [90m138| [39m      [34mexpect[39m(lockedAttempt[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m423[39m)[33m;[39m
    [90m   | [39m                                   [31m^[39m
    [90m139| [39m      expect(lockedAttempt.body.message || lockedAttempt.body.error).tâ€¦
    [90m140| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[37/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mAccount Lockout Flow[2m > [22mshould record all login attempts
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: aedb4c42bdf333f067aa18ad4f73b36d,$2b$12$ZnT2DEEMSD.kv4.RcizNTuA1lgqsJzV51zyGoIz4x0uwvWn5r/3Se,2026-01-18T03:59:52.262Z,2026-01-18T03:59:52.262Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m161:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m161:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(aedb4c42bdf333f067aa18ad4f73b36d) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[38/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mMFA Enrollment and Login Flow[2m > [22mshould complete MFA setup and login with TOTP
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 1a3b5cb1d3d8835225b97ba4544e2f1a,$2b$12$MKcLOOjNJdyFPWZosuCc4eHgdrNdTK2BUKEig6Ru.AcQI2w3ONyJ.,2026-01-18T03:59:52.951Z,2026-01-18T03:59:52.951Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m182:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m182:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(1a3b5cb1d3d8835225b97ba4544e2f1a) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mMFA Enrollment and Login Flow[2m > [22mshould login with backup code when TOTP unavailable
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 9074c2cddb6aa2eb8ca7caa43fc15d6b,$2b$12$DLxEp91Cle3Z6.uTVbwWwOw5hvdEDHCkw3oR6bCEdBashNi3LtFge,2026-01-18T03:59:53.614Z,2026-01-18T03:59:53.614Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m253:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m253:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(9074c2cddb6aa2eb8ca7caa43fc15d6b) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[40/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mPassword Reset Flow[2m > [22mshould complete full password reset flow
[31m[1mAssertionError[22m: expected undefined to be defined[39m
[36m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m345:32[22m[39m
    [90m343| [39m      })[33m;[39m
    [90m344| [39m
    [90m345| [39m      [34mexpect[39m(resetTokenRecord)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m   | [39m                               [31m^[39m
    [90m346| [39m
    [90m347| [39m      // Since token is hashed, we need to use the service to generateâ€¦

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[41/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mPassword Reset Flow[2m > [22mshould invalidate all sessions after password reset
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: af293a7752bcbcbbf718b3e018f7ea78,$2b$12$wbAmQrtJHa.VbXSi4DW3nu9UfdHkUnXT.BDdbxVv/a2x1XHzPjrEe,2026-01-18T03:59:56.829Z,2026-01-18T03:59:56.829Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m383:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m383:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(af293a7752bcbcbbf718b3e018f7ea78) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[42/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mToken Refresh Flow[2m > [22mshould rotate refresh token on each use
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m439:40[22m[39m
    [90m437| [39m
    [90m438| [39m      const cookies = loginResponse.headers['set-cookie'] as unknown aâ€¦
    [90m439| [39m      let refreshTokenCookie = cookies.find(c => c.startsWith('refreshâ€¦
    [90m   | [39m                                       [31m^[39m
    [90m440| [39m
    [90m441| [39m      [34mexpect[39m(refreshTokenCookie)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[43/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mToken Refresh Flow[2m > [22mshould detect and prevent refresh token reuse (token theft)
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m473:44[22m[39m
    [90m471| [39m
    [90m472| [39m      const cookies = loginResponse.headers['set-cookie'] as unknown aâ€¦
    [90m473| [39m      const originalRefreshToken = cookies.find(c => c.startsWith('refâ€¦
    [90m   | [39m                                           [31m^[39m
    [90m474| [39m
    [90m475| [39m      [90m// Use token once (rotation happens)[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[44/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mSession Management Flow[2m > [22mshould list all active sessions
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 9cb9c7bd93dfcff95a8339760b5db77e,$2b$12$Hco/WyPj1zue4c6bpmrqW.Ws8DCh.lcCa5hGYy6.27Z1ZCWA0uXpi,2026-01-18T03:59:59.838Z,2026-01-18T03:59:59.838Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m507:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m507:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(9cb9c7bd93dfcff95a8339760b5db77e) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[45/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mSession Management Flow[2m > [22mshould revoke specific session
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 66c82f82c39e912f0d5c5486c201eb6c,$2b$12$dVBCtJTt8xqN/.FM/FcPnekIa0gusN7DA4etsp7VGlfPDth7RQgbe,2026-01-18T04:00:00.512Z,2026-01-18T04:00:00.512Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m534:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m534:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(66c82f82c39e912f0d5c5486c201eb6c) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[46/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/register[2m > [22mshould register a new user successfully
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m78:31[22m[39m
    [90m 76| [39m        })[33m;[39m
    [90m 77| [39m
    [90m 78| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m 79| [39m      expect((response.body).message).toContain("Registration successfâ€¦
    [90m 80| [39m      [34mexpect[39m((response[33m.[39mbody)[33m.[39mtoken)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[47/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/register[2m > [22mshould return 409 for duplicate email
[31m[1mAssertionError[22m: expected 500 to be 409 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 409[39m
[31m+ 500[39m

[36m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m139:31[22m[39m
    [90m137| [39m        [33m.[39m[34msend[39m({ email[33m,[39m password[33m,[39m firstName[33m:[39m [32m"Second"[39m })[33m;[39m
    [90m138| [39m
    [90m139| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m409[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m140| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoContain[39m([32m"already exists"[39m)[33m;[39m
    [90m141| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[48/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/register[2m > [22mshould set httpOnly refresh token cookie
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m151:31[22m[39m
    [90m149| [39m        [33m.[39m[34msend[39m({ email[33m,[39m password[33m,[39m firstName[33m:[39m [32m"Test"[39m })[33m;[39m
    [90m150| [39m
    [90m151| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m152| [39m      [34mexpect[39m(response[33m.[39mheaders[[32m'set-cookie'[39m])[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m153| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[49/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould login with valid credentials
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: c8d12bee48f57748416e69b4595e120b,$2b$12$fFzUieNm/jvD3.LPgvpLLO2AmLu76j38eRT0nFc7l33iWJ30OJA1m,2026-01-18T03:59:52.538Z,2026-01-18T03:59:52.538Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m164:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m164:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(c8d12bee48f57748416e69b4595e120b) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[50/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould return 401 for invalid password
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 9996a9538d28ec56c7f170acd74369a7,$2b$12$kS1WeEJtWwhBi5uyaSVRAuKGoq6kCNAQWVXznfv/h7/Ow5iQuMjvS,2026-01-18T03:59:53.197Z,2026-01-18T03:59:53.197Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m185:33[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m185:33[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(9996a9538d28ec56c7f170acd74369a7) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[51/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould return 403 for unverified email
[31m[1mAssertionError[22m: expected 401 to be 403 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 403[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m226:31[22m[39m
    [90m224| [39m        [33m.[39m[34msend[39m({ email[33m,[39m password })[33m;[39m
    [90m225| [39m
    [90m226| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m403[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m227| [39m      expect(response.body.message || response.body.error).toBeDefinedâ€¦
    [90m228| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[52/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould record failed login attempt
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: cca6f6d11b4f883b359cb070558d88c2,$2b$12$3Kv9.MuSmKcJd7SUEtoNF.02IHXkjFzvP6y9OK9FGH.I7Vl.07PGC,2026-01-18T03:59:55.895Z,2026-01-18T03:59:55.895Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m231:33[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m231:33[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(cca6f6d11b4f883b359cb070558d88c2) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[53/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould return requiresMfa=true for MFA-enabled users
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 731ebab3b9cb6f5e742c6f5ddaff3e64,$2b$12$PINFzT46a2HyyB2x0hBTn.LDtFxJ4in3gMG79JN8bwPMBEYvmdD62,2026-01-18T03:59:56.570Z,2026-01-18T03:59:56.570Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m252:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m252:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(731ebab3b9cb6f5e742c6f5ddaff3e64) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[54/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould lock account after 5 failed attempts
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 1ecc0e7fe5446c3860df340a43ba187c,$2b$12$mavDZ5j7RXvFLqtnCHD2gendpJ8p9EDJWOkNITKcf1L30D6YaIulO,2026-01-18T03:59:57.502Z,2026-01-18T03:59:57.502Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m266:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m266:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(1ecc0e7fe5446c3860df340a43ba187c) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[55/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/logout[2m > [22mshould logout and clear refresh token cookie
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: ee88b358baeb74adacac3061aa3ec457,$2b$12$a6b8q9.IFiEhIUJw.qLzhOT1j/3zIA2O4llYIopxSWthIIDmRAn5O,2026-01-18T03:59:58.404Z,2026-01-18T03:59:58.404Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m295:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m295:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(ee88b358baeb74adacac3061aa3ec457) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[56/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould refresh access token with valid refresh token
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 4cfaf525d923135dbcdfa04724df5b65,$2b$12$l9CrlxtzmLtMR4V6wy2soOEKFQ8TxOvnBBInw72UtGPLmeRtH2Ymy,2026-01-18T03:59:59.064Z,2026-01-18T03:59:59.064Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m325:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m325:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(4cfaf525d923135dbcdfa04724df5b65) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[57/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould rotate refresh token after use
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 2fd0955cd70f55997e890d5ea8de18b8,$2b$12$VI/eOiSw5Wc5Kdla1Il0TuaEmPaSz5KbMh.APzuraMaee8tgl8RAO,2026-01-18T03:59:59.709Z,2026-01-18T03:59:59.709Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m364:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m364:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(2fd0955cd70f55997e890d5ea8de18b8) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w15_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[58/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/forgot-password[2m > [22mshould send password reset email for existing user
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m406:31[22m[39m
    [90m404| [39m        [33m.[39m[34msend[39m({ email })[33m;[39m
    [90m405| [39m
    [90m406| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m407| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoContain[39m([32m"reset link"[39m)[33m;[39m
    [90m408| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[59/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/reset-password[2m > [22mshould reset password with valid token
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 812a436f93a8161c84c426047216b44a,$2b$12$1sGAJ9NS30A.BRbOCT/ghevXeImbGL2mB.KlWIiuJyiCPmbYr6vW2,2026-01-18T04:00:02.071Z,2026-01-18T04:00:02.071Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m423:56[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m423:56[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(812a436f93a8161c84c426047216b44a) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[60/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/reset-password[2m > [22mshould return 400 for weak new password
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: b4c613e44bc7fb59aa70c83d9944cfce,$2b$12$ENt5YT7QbT.SvshjYrVIVu9/Cgzu93ROuG5xp8KN/e/V48UKG1uuq,2026-01-18T04:00:02.793Z,2026-01-18T04:00:02.793Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m469:33[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m469:33[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(b4c613e44bc7fb59aa70c83d9944cfce) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[61/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mGET /api/auth/me[2m > [22mshould return current user for valid token
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m500:31[22m[39m
    [90m498| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m499| [39m
    [90m500| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m501| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39memail)[33m.[39m[34mtoBe[39m(email)[33m;[39m
    [90m502| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mid)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[62/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mMFA Routes[2m > [22mPOST /api/auth/mfa/verify-login[2m > [22mshould complete MFA login with valid TOTP code
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: 449d48917710f692c516acf8a50ac2e2,EFRS64ZGOA4U6JTNMNWGGQKLFFKHEYKNHFJCG2KKMVDWYNRWMM3A,true,2026-01-18T04:00:04.782Z,2026-01-18T04:00:04.782Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m523:57[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m523:57[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(449d48917710f692c516acf8a50ac2e2) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w22_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[63/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mMFA Routes[2m > [22mPOST /api/auth/mfa/verify-login[2m > [22mshould reject invalid MFA code
[31m[1mError[22m: [TEST UTILS] MFA Secret verification failed for 63448a99c98329efb5df023a38103018[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m228:22[22m[39m
    [90m226| [39m    where[33m:[39m [34meq[39m(mfaSecrets[33m.[39muserId[33m,[39m userData[33m.[39muserId)
    [90m227| [39m  })[33m;[39m
    [90m228| [39m  if (!check) {throw new Error(`[TEST UTILS] MFA Secret verification fâ€¦
    [90m   | [39m                     [31m^[39m
    [90m229| [39m  if (!check.enabled) {throw new Error(`[TEST UTILS] MFA Secret enableâ€¦
    [90m230| [39m  console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}â€¦
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m549:28[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[64/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mCollection Lifecycle[2m > [22mshould update a collection
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'description')[39m
[36m [2mâ¯[22m tests/integration/collections.e2e.test.ts:[2m109:22[22m[39m
    [90m107| [39m      })[33m;[39m
    [90m108| [39m
    [90m109| [39m      [34mexpect[39m(updated[33m.[39mdescription)[33m.[39m[34mtoBe[39m([32m'Updated customer database'[39m)[33m;[39m
    [90m   | [39m                     [31m^[39m
    [90m110| [39m    })[33m;[39m
    [90m111| [39m  })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[65/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mField Management[2m > [22mshould create text field
[31m[1mError[22m: Collection not found[39m
[36m [2mâ¯[22m CollectionFieldService.verifyCollectionExists server/services/CollectionFieldService.ts:[2m62:13[22m[39m
    [90m 60| [39m    const collection = await this.collectionRepo.findById(collectionIdâ€¦
    [90m 61| [39m    [35mif[39m ([33m![39mcollection) {
    [90m 62| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Collection not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m 63| [39m    }
    [90m 64| [39m  }
[90m [2mâ¯[22m CollectionFieldService.createField server/services/CollectionFieldService.ts:[2m163:5[22m[39m
[90m [2mâ¯[22m tests/integration/collections.e2e.test.ts:[2m115:21[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[66/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mField Management[2m > [22mshould create email field
[31m[1mError[22m: Collection not found[39m
[36m [2mâ¯[22m CollectionFieldService.verifyCollectionExists server/services/CollectionFieldService.ts:[2m62:13[22m[39m
    [90m 60| [39m    const collection = await this.collectionRepo.findById(collectionIdâ€¦
    [90m 61| [39m    [35mif[39m ([33m![39mcollection) {
    [90m 62| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Collection not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m 63| [39m    }
    [90m 64| [39m  }
[90m [2mâ¯[22m CollectionFieldService.createField server/services/CollectionFieldService.ts:[2m163:5[22m[39m
[90m [2mâ¯[22m tests/integration/collections.e2e.test.ts:[2m133:21[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[67/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mField Management[2m > [22mshould create number field
[31m[1mError[22m: Collection not found[39m
[36m [2mâ¯[22m CollectionFieldService.verifyCollectionExists server/services/CollectionFieldService.ts:[2m62:13[22m[39m
    [90m 60| [39m    const collection = await this.collectionRepo.findById(collectionIdâ€¦
    [90m 61| [39m    [35mif[39m ([33m![39mcollection) {
    [90m 62| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Collection not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m 63| [39m    }
    [90m 64| [39m  }
[90m [2mâ¯[22m CollectionFieldService.createField server/services/CollectionFieldService.ts:[2m163:5[22m[39m
[90m [2mâ¯[22m tests/integration/collections.e2e.test.ts:[2m146:21[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[68/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mField Management[2m > [22mshould create select field with options
[31m[1mError[22m: Collection not found[39m
[36m [2mâ¯[22m CollectionFieldService.verifyCollectionExists server/services/CollectionFieldService.ts:[2m62:13[22m[39m
    [90m 60| [39m    const collection = await this.collectionRepo.findById(collectionIdâ€¦
    [90m 61| [39m    [35mif[39m ([33m![39mcollection) {
    [90m 62| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Collection not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m 63| [39m    }
    [90m 64| [39m  }
[90m [2mâ¯[22m CollectionFieldService.createField server/services/CollectionFieldService.ts:[2m163:5[22m[39m
[90m [2mâ¯[22m tests/integration/collections.e2e.test.ts:[2m161:21[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[69/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mField Management[2m > [22mshould create boolean field
[31m[1mError[22m: Collection not found[39m
[36m [2mâ¯[22m CollectionFieldService.verifyCollectionExists server/services/CollectionFieldService.ts:[2m62:13[22m[39m
    [90m 60| [39m    const collection = await this.collectionRepo.findById(collectionIdâ€¦
    [90m 61| [39m    [35mif[39m ([33m![39mcollection) {
    [90m 62| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Collection not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m 63| [39m    }
    [90m 64| [39m  }
[90m [2mâ¯[22m CollectionFieldService.createField server/services/CollectionFieldService.ts:[2m163:5[22m[39m
[90m [2mâ¯[22m tests/integration/collections.e2e.test.ts:[2m178:21[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[70/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mField Management[2m > [22mshould list all fields
[31m[1mAssertionError[22m: expected +0 to be 5 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 5[39m
[31m+ 0[39m

[36m [2mâ¯[22m tests/integration/collections.e2e.test.ts:[2m195:29[22m[39m
    [90m193| [39m      const fields = await collectionFieldService.listFields(testColleâ€¦
    [90m194| [39m
    [90m195| [39m      [34mexpect[39m(fields[33m.[39mlength)[33m.[39m[34mtoBe[39m([34m5[39m)[33m;[39m
    [90m   | [39m                            [31m^[39m
    [90m196| [39m      [34mexpect[39m(fields[33m.[39m[34mmap[39m(f [33m=>[39m f[33m.[39mslug))[33m.[39m[34mtoEqual[39m([
    [90m197| [39m        [32m'first_name'[39m[33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[71/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mField Management[2m > [22mshould update field
[31m[1mError[22m: Field not found[39m
[36m [2mâ¯[22m CollectionFieldService.verifyFieldOwnership server/services/CollectionFieldService.ts:[2m73:13[22m[39m
    [90m 71| [39m
    [90m 72| [39m    [35mif[39m ([33m![39mfield) {
    [90m 73| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Field not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m 74| [39m    }
    [90m 75| [39m
[90m [2mâ¯[22m CollectionFieldService.updateField server/services/CollectionFieldService.ts:[2m206:5[22m[39m
[90m [2mâ¯[22m tests/integration/collections.e2e.test.ts:[2m206:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[72/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mRecord CRUD Operations[2m > [22mshould create a record
[31m[1mError[22m: Collection not found[39m
[36m [2mâ¯[22m RecordService.verifyCollectionExists server/services/RecordService.ts:[2m35:13[22m[39m
    [90m 33| [39m    const collection = await this.collectionRepo.findById(collectionIdâ€¦
    [90m 34| [39m    [35mif[39m ([33m![39mcollection) {
    [90m 35| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Collection not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m 36| [39m    }
    [90m 37| [39m  }
[90m [2mâ¯[22m RecordService.createRecord server/services/RecordService.ts:[2m214:5[22m[39m
[90m [2mâ¯[22m tests/integration/collections.e2e.test.ts:[2m219:22[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[73/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mRecord CRUD Operations[2m > [22mshould create multiple records
[31m[1mError[22m: Collection not found[39m
[36m [2mâ¯[22m RecordService.verifyCollectionExists server/services/RecordService.ts:[2m35:13[22m[39m
    [90m 33| [39m    const collection = await this.collectionRepo.findById(collectionIdâ€¦
    [90m 34| [39m    [35mif[39m ([33m![39mcollection) {
    [90m 35| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Collection not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m 36| [39m    }
    [90m 37| [39m  }
[90m [2mâ¯[22m RecordService.createRecord server/services/RecordService.ts:[2m214:5[22m[39m
[90m [2mâ¯[22m tests/integration/collections.e2e.test.ts:[2m241:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[74/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mRecord CRUD Operations[2m > [22mshould list records with pagination
[31m[1mAssertionError[22m: expected +0 to be 3 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 3[39m
[31m+ 0[39m

[36m [2mâ¯[22m tests/integration/collections.e2e.test.ts:[2m273:29[22m[39m
    [90m271| [39m      })[33m;[39m
    [90m272| [39m
    [90m273| [39m      [34mexpect[39m(result[33m.[39mlength)[33m.[39m[34mtoBe[39m([34m3[39m)[33m;[39m
    [90m   | [39m                            [31m^[39m
    [90m274| [39m    })[33m;[39m
    [90m275| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[75/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mRecord CRUD Operations[2m > [22mshould get a single record
[31m[1mError[22m: Record not found[39m
[36m [2mâ¯[22m RecordService.verifyRecordOwnership server/services/RecordService.ts:[2m51:13[22m[39m
    [90m 49| [39m
    [90m 50| [39m    [35mif[39m ([33m![39mrecord) {
    [90m 51| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Record not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m 52| [39m    }
    [90m 53| [39m
[90m [2mâ¯[22m tests/integration/collections.e2e.test.ts:[2m277:22[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[76/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mRecord CRUD Operations[2m > [22mshould update a record
[31m[1mError[22m: Record not found[39m
[36m [2mâ¯[22m RecordService.verifyRecordOwnership server/services/RecordService.ts:[2m51:13[22m[39m
    [90m 49| [39m
    [90m 50| [39m    [35mif[39m ([33m![39mrecord) {
    [90m 51| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Record not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m 52| [39m    }
    [90m 53| [39m
[90m [2mâ¯[22m RecordService.updateRecord server/services/RecordService.ts:[2m273:20[22m[39m
[90m [2mâ¯[22m tests/integration/collections.e2e.test.ts:[2m284:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[77/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mRecord CRUD Operations[2m > [22mshould find records by filters
[31m[1mAssertionError[22m: expected +0 to be 1 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 1[39m
[31m+ 0[39m

[36m [2mâ¯[22m tests/integration/collections.e2e.test.ts:[2m303:29[22m[39m
    [90m301| [39m      )[33m;[39m
    [90m302| [39m
    [90m303| [39m      [34mexpect[39m(result[33m.[39mlength)[33m.[39m[34mtoBe[39m([34m1[39m)[33m;[39m
    [90m   | [39m                            [31m^[39m
    [90m304| [39m      [34mexpect[39m((result[[34m0[39m][33m.[39mdata [35mas[39m any)[33m.[39mfirst_name)[33m.[39m[34mtoBe[39m([32m'Jane'[39m)[33m;[39m
    [90m305| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[78/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mRecord CRUD Operations[2m > [22mshould delete a record
[31m[1mError[22m: Record not found[39m
[36m [2mâ¯[22m RecordService.verifyRecordOwnership server/services/RecordService.ts:[2m51:13[22m[39m
    [90m 49| [39m
    [90m 50| [39m    [35mif[39m ([33m![39mrecord) {
    [90m 51| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Record not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m 52| [39m    }
    [90m 53| [39m
[90m [2mâ¯[22m RecordService.deleteRecord server/services/RecordService.ts:[2m298:5[22m[39m
[90m [2mâ¯[22m tests/integration/collections.e2e.test.ts:[2m308:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[79/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mCollection Stats[2m > [22mshould list collections with stats
[31m[1mAssertionError[22m: expected +0 to be 5 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 5[39m
[31m+ 0[39m

[36m [2mâ¯[22m tests/integration/collections.e2e.test.ts:[2m325:46[22m[39m
    [90m323| [39m      const customerCollection = collections.find(c => c.id === testCoâ€¦
    [90m324| [39m      [34mexpect[39m(customerCollection)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m325| [39m      [34mexpect[39m(customerCollection[33m![39m[33m.[39mfieldCount)[33m.[39m[34mtoBe[39m([34m5[39m)[33m;[39m
    [90m   | [39m                                             [31m^[39m
    [90m326| [39m      [34mexpect[39m([33mNumber[39m(customerCollection[33m![39m[33m.[39mrecordCount))[33m.[39m[34mtoBe[39m([34m2[39m)[33m;[39m
    [90m327| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[80/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests[2m > [22mData Validation[2m > [22mshould validate field types
[31m[1mError[22m: Unknown field 'first_name' - field does not exist in collection[39m
[36m [2mâ¯[22m RecordService.validateRecordData server/services/RecordService.ts:[2m87:15[22m[39m
    [90m 85| [39m
    [90m 86| [39m      [35mif[39m ([33m![39mfield) {
    [90m 87| [39m        throw new Error(`Unknown field '${slug}' - field does not exisâ€¦
    [90m   | [39m              [31m^[39m
    [90m 88| [39m      }
    [90m 89| [39m
[90m [2mâ¯[22m RecordService.createRecord server/services/RecordService.ts:[2m223:5[22m[39m
[90m [2mâ¯[22m tests/integration/collections.e2e.test.ts:[2m345:22[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[81/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/js_helpers.test.ts[2m > [22mDetailed Verification: JS Helper Availability[2m > [22mshould execute a JS block that uses helper functions
[31m[1mAssertionError[22m: expected undefined to be defined[39m
[36m [2mâ¯[22m tests/integration/js_helpers.test.ts:[2m185:28[22m[39m
    [90m183| [39m        )[33m;[39m
    [90m184| [39m
    [90m185| [39m        [34mexpect[39m(savedValue)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m   | [39m                           [31m^[39m
    [90m186| [39m        [35mconst[39m result [33m=[39m savedValue[33m.[39mvalue [35mas[39m any[33m;[39m
    [90m187| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[82/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould complete full MFA setup flow
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 605a62f5b7e496eaf2c298448e04cbcc,$2b$12$rWVgVCT9hnkmR4i8/RHU1O1B1BSQpbqYrEa8qGBdeiR1vI2v86pcC,2026-01-18T03:59:49.527Z,2026-01-18T03:59:49.527Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m59:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m59:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(605a62f5b7e496eaf2c298448e04cbcc) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[83/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould reject invalid TOTP code during setup
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: b55e2847c270a61827f1406793545b27,$2b$12$6PYTiavaXTvjLy5EC4ogzeNJIcwLJmKY1Br47EOb65tFPHLXcRfDe,2026-01-18T03:59:50.171Z,2026-01-18T03:59:50.171Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m125:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m125:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(b55e2847c270a61827f1406793545b27) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[84/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould not allow MFA setup if already enabled
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: 78d4c49fa2253ae81f747c63bb7f2e1f,LJLHIZ3FNNATGQZPHRSD45CHMNNHISLDFASDWVDQHRBXSYTJEV5Q,true,2026-01-18T03:59:50.940Z,2026-01-18T03:59:50.940Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m157:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m157:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(78d4c49fa2253ae81f747c63bb7f2e1f) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[85/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould generate unique backup codes
[31m[1mAssertionError[22m: expected +0 to be 10 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 10[39m
[31m+ 0[39m

[36m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m186:32[22m[39m
    [90m184| [39m      [90m// All codes should be unique[39m
    [90m185| [39m      [35mconst[39m uniqueCodes [33m=[39m [35mnew[39m [33mSet[39m(backupCodes)[33m;[39m
    [90m186| [39m      [34mexpect[39m(uniqueCodes[33m.[39msize)[33m.[39m[34mtoBe[39m([34m10[39m)[33m;[39m
    [90m   | [39m                               [31m^[39m
    [90m187| [39m    })[33m;[39m
    [90m188| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[86/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould store hashed backup codes
[31m[1mAssertionError[22m: expected [] to have a length of 10 but got +0[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 10[39m
[31m+ 0[39m

[36m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m208:27[22m[39m
    [90m206| [39m      })[33m;[39m
    [90m207| [39m
    [90m208| [39m      [34mexpect[39m(storedCodes)[33m.[39m[34mtoHaveLength[39m([34m10[39m)[33m;[39m
    [90m   | [39m                          [31m^[39m
    [90m209| [39m
    [90m210| [39m      [90m// Hashes should not match plain codes[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[87/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Login Flow[2m > [22mshould require MFA for enabled users
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: 20bdf98ca5beb0e11aa4c1c3ba243abd,N5DTC2K3H5EHG3ZYI5DFOZ22IRASUSJZFZJGQY3HEZKVI2ZQJB3A,true,2026-01-18T03:59:54.034Z,2026-01-18T03:59:54.034Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m220:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m220:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 322, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(20bdf98ca5beb0e11aa4c1c3ba243abd) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[88/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Login Flow[2m > [22mshould complete MFA login with valid TOTP
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: fb1a4f8899044ef2d152141085574831,MZHEQUREMY7HM7JEOR2HON3FNU2TAKJXHRPGG6KQNRWS6RTRM4XQ,true,2026-01-18T03:59:54.816Z,2026-01-18T03:59:54.816Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m234:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m234:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(fb1a4f8899044ef2d152141085574831) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[89/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Login Flow[2m > [22mshould reject invalid TOTP during login
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 96f06089b53bdd35704fd4ba5b5758db,$2b$12$j1HWr1P4qQiP1CVSTTAl.O5yZ.z0BSDRStwIMHCInh/fIIV2IuIxu,2026-01-18T03:59:55.485Z,2026-01-18T03:59:55.485Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m268:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m268:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(96f06089b53bdd35704fd4ba5b5758db) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[90/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Login Flow[2m > [22mshould accept TOTP codes within 60-second window
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 02fd0d85e5ec285a6bcbb57b5344fc7a,$2b$12$w3SaGypstEkGcbth7GIlTOQ3CqSf4GKIGArBeIzOf/pz.4abVmQMG,2026-01-18T03:59:56.106Z,2026-01-18T03:59:56.106Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m286:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m286:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(02fd0d85e5ec285a6bcbb57b5344fc7a) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w2_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[91/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Flow[2m > [22mshould login with valid backup code
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'id')[39m
[36m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m338:44[22m[39m
    [90m336| [39m
    [90m337| [39m      [35mconst[39m mfaSecret [33m=[39m [35mawait[39m db[33m.[39mquery[33m.[39mmfaSecrets[33m.[39m[34mfindFirst[39m({
    [90m338| [39m        where[33m:[39m [34meq[39m(mfaSecrets[33m.[39muserId[33m,[39m user[33m![39m[33m.[39mid)[33m,[39m
    [90m   | [39m                                           [31m^[39m
    [90m339| [39m      })[33m;[39m
    [90m340| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[92/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Flow[2m > [22mshould mark backup code as used
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: 4f93e36592b0e229f2b06639bbe3be79,EMTCMULEMUZXWSZXPA2XONJ4H5UV4JT5MNWTA2ZTFYYVCQLZJFWQ,true,2026-01-18T03:59:57.997Z,2026-01-18T03:59:57.997Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m370:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m370:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(4f93e36592b0e229f2b06639bbe3be79) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[93/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Flow[2m > [22mshould prevent backup code reuse
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 4f29a79fd7e96e32049e818b88c8a686,$2b$12$AhKHThNLAsjWp6nBRWVyyOlOD9xa9v8HryY8h0FkC0YlBHtw7qgvq,2026-01-18T03:59:58.674Z,2026-01-18T03:59:58.674Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m390:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m390:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(4f29a79fd7e96e32049e818b88c8a686) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[94/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Flow[2m > [22mshould try TOTP before backup code
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 7c37fa1681653045e466bf03ae84feee,$2b$12$t1q5j6oI7P9F.1QPSsoZhOGUy0lxBqObV4Myla8IBRm6/Am5TZoRC,2026-01-18T03:59:59.342Z,2026-01-18T03:59:59.342Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m452:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m452:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(7c37fa1681653045e466bf03ae84feee) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[95/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Status[2m > [22mshould return MFA status for user
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 806d0984457ac385d59b6f9c6ffbc76c,$2b$12$cMgKIuedPs2XMczfLJ6Yh.s30S1EHefCnwIzoEXFE0iwPxcb.PH0S,2026-01-18T04:00:00.008Z,2026-01-18T04:00:00.008Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m475:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m475:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(806d0984457ac385d59b6f9c6ffbc76c) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[96/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Status[2m > [22mshould return backup codes count for MFA users
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 839de7981446c52c4e26bb81927398c8,$2b$12$8..WiSok1b6UV9bMF/s4oOiq.Ph3j.m2mwcCyCbjgca0BByw0QCPy,2026-01-18T04:00:00.726Z,2026-01-18T04:00:00.726Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m492:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m492:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(839de7981446c52c4e26bb81927398c8) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[97/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Disable Flow[2m > [22mshould disable MFA with password verification
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: c755d1990e67544f23f9294cb9e64768,LA3E2TTXINTD6L2ULNUV2TSXJRYUYM2MNQVFIVKBGRADA6LNGQZQ,true,2026-01-18T04:00:01.510Z,2026-01-18T04:00:01.510Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m529:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m529:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 322, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(c755d1990e67544f23f9294cb9e64768) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[98/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Disable Flow[2m > [22mshould require correct password to disable MFA
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 31fe7b2ea7def662d755aae373b7623a,$2b$12$oGp63j8y0XwtL0GVhw6vH.JEH6x4I.tpK8kULZRBjQ37kpUj0IC7a,2026-01-18T04:00:02.212Z,2026-01-18T04:00:02.212Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m579:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m579:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(31fe7b2ea7def662d755aae373b7623a) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[99/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Regeneration[2m > [22mshould regenerate backup codes
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: fe82b5c3561e60e16b123289afabab94,$2b$12$rb9t42VSCvsZMQ//VSeLT.9PlorQ2EuvPA8dLGQHxLM.TwXup9YXi,2026-01-18T04:00:02.855Z,2026-01-18T04:00:02.855Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m613:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m613:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(fe82b5c3561e60e16b123289afabab94) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[100/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Regeneration[2m > [22mshould return error if MFA not enabled
[31m[1mAssertionError[22m: expected 401 to be 400 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 400[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m657:31[22m[39m
    [90m655| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mloginResponse[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m656| [39m
    [90m657| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m400[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m658| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoContain[39m([32m"not enabled"[39m)[33m;[39m
    [90m659| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[101/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mTenant-Level MFA Enforcement[2m > [22mshould enforce MFA for tenant users when required by tenant
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m684:36[22m[39m
    [90m682| [39m        [33m.[39m[34msend[39m({ email[33m,[39m password })[33m;[39m
    [90m683| [39m
    [90m684| [39m      [34mexpect[39m(loginResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                   [31m^[39m
    [90m685| [39m      [34mexpect[39m(loginResponse[33m.[39mbody[33m.[39mrequiresMfa)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m686| [39m      [34mexpect[39m(loginResponse[33m.[39mbody[33m.[39muserId)[33m.[39m[34mtoBe[39m(userId)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[102/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould create placeholder user for non-existent email
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2mâ¯[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2mâ¯[22m OrganizationService.createInvite server/services/OrganizationService.ts:[2m438:5[22m[39m
[90m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m81:28[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[103/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould create invite for existing user without creating placeholder
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould prevent duplicate pending invites
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould prevent inviting existing members
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould require admin access to create invite
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22macceptInvite[2m > [22mshould convert placeholder user to real user on accept
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22macceptInvite[2m > [22mshould verify email matches invite
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mgetPendingInvitesForUser[2m > [22mshould return pending invites for user email
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mgetPendingInvitesForUser[2m > [22mshould not return expired invites
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default)
params: 00000000-0000-0000-0000-000000000021,admin@test.com,Admin User,00000000-0000-0000-0000-000000000098,00000000-0000-0000-0000-000000000022,existing_1768708784069@test.com,Existing User,00000000-0000-0000-0000-000000000098[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m46:9[22m[39m
    [90m 44| [39m        await db.delete(users).where(inArray(users.id, [adminUserId, eâ€¦
    [90m 45| [39m
    [90m 46| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 47| [39m            { id: adminUserId, email: 'admin@test.com', fullName: 'Admâ€¦
    [90m 48| [39m            { id: existingUserId, email: existingUserEmail, fullName: â€¦

[31m[1mCaused by: error[22m: duplicate key value violates unique constraint "users_pkey"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m46:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 227, severity: 'ERROR', code: '23505', detail: 'Key (id)=(00000000-0000-0000-0000-000000000021) already exists.', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'users', dataType: undefined, constraint: 'users_pkey', file: 'nbtinsert.c', routine: '_bt_check_unique' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[104/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould set expiry to 7 days from now
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2mâ¯[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2mâ¯[22m OrganizationService.createInvite server/services/OrganizationService.ts:[2m438:5[22m[39m
[90m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m143:28[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[105/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22macceptInvite[2m > [22mshould accept invite and create membership
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mrevokeInvite[2m > [22mshould allow admin to revoke invite
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mrevokeInvite[2m > [22mshould prevent accepting revoked invite
[31m[1mError[22m: User must belong to a tenant to create organizations[39m
[36m [2mâ¯[22m OrganizationService.createOrganization server/services/OrganizationService.ts:[2m49:13[22m[39m
    [90m 47| [39m
    [90m 48| [39m    [35mif[39m ([33m![39muser[33m?.[39mtenantId) {
    [90m 49| [39m      throw new Error('User must belong to a tenant to create organizaâ€¦
    [90m   | [39m            [31m^[39m
    [90m 50| [39m    }
    [90m 51| [39m
[90m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m53:21[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[106/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22macceptInvite[2m > [22mshould reject expired invite
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2mâ¯[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2mâ¯[22m OrganizationService.createInvite server/services/OrganizationService.ts:[2m438:5[22m[39m
[90m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m216:34[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[107/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22macceptInvite[2m > [22mshould reject already accepted invite
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2mâ¯[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2mâ¯[22m OrganizationService.createInvite server/services/OrganizationService.ts:[2m438:5[22m[39m
[90m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m241:34[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[108/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mgetPendingInvitesForUser[2m > [22mshould not return accepted invites
[31m[1mError[22m: Failed query: insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values (default, $1, default, default, default, default, $2, $3, default, default) returning "id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at"
params: Invite Test Org,00000000-0000-0000-0000-000000000098,00000000-0000-0000-0000-000000000021[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m server/services/OrganizationService.ts:[2m54:21[22m[39m
    [90m 52| [39m    [35mreturn[39m db[33m.[39m[34mtransaction[39m([35masync[39m (tx) [33m=>[39m {
    [90m 53| [39m      [90m// Create organization with tenant scoping[39m
    [90m 54| [39m      [35mconst[39m [org] [33m=[39m [35mawait[39m tx
    [90m   | [39m                    [31m^[39m
    [90m 55| [39m        [33m.[39m[34minsert[39m(organizations)
    [90m 56| [39m        [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m53:21[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "organizations" violates foreign key constraint "organizations_created_by_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m server/services/OrganizationService.ts:[2m54:21[22m[39m
[90m [2mâ¯[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m53:21[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 367, severity: 'ERROR', code: '23503', detail: 'Key (created_by_user_id)=(00000000-0000-0000-0000-000000000021) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'organizations', dataType: undefined, constraint: 'organizations_created_by_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[109/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mcreateOrganization[2m > [22mshould create organization and auto-create admin membership
[31m[1mError[22m: Test setup failed: User 00000000-0000-0000-0000-000000000011 missing tenantId[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m54:19[22m[39m
    [90m 52| [39m        [35mif[39m ([33m![39muserCheck[33m?.[39mtenantId) {
    [90m 53| [39m            console.error('CRITICAL: User lookup failed validation in â€¦
    [90m 54| [39m            throw new Error(`Test setup failed: User ${testUserId1} miâ€¦
    [90m   | [39m                  [31m^[39m
    [90m 55| [39m        }
    [90m 56| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[110/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mgetUserOrganizations[2m > [22mshould return all organizations for user
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,c8e617fc-eef6-4632-ac7d-f194e2f0e1ea,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,c8e617fc-eef6-4632-ac7d-f194e2f0e1ea,c8e617fc-eef6-4632-ac7d-f194e2f0e1ea[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(c8e617fc-eef6-4632-ac7d-f194e2f0e1ea) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[111/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mgetUserOrganizations[2m > [22mshould return empty array for user with no memberships
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,b2d2545f-02a7-41ad-9eeb-602ae656007a,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,b2d2545f-02a7-41ad-9eeb-602ae656007a,b2d2545f-02a7-41ad-9eeb-602ae656007a[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(b2d2545f-02a7-41ad-9eeb-602ae656007a) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w2_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[112/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mupdateOrganization[2m > [22mshould allow admin to update organization
[31m[1mError[22m: Failed query: insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values (default, $1, default, default, default, default, $2, $3, default, default) returning "id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at"
params: Original Name Int,8bbf1843-a96f-4f79-85d1-4107b89f1c79,00000000-0000-0000-0000-000000000011[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m server/services/OrganizationService.ts:[2m54:21[22m[39m
    [90m 52| [39m    [35mreturn[39m db[33m.[39m[34mtransaction[39m([35masync[39m (tx) [33m=>[39m {
    [90m 53| [39m      [90m// Create organization with tenant scoping[39m
    [90m 54| [39m      [35mconst[39m [org] [33m=[39m [35mawait[39m tx
    [90m   | [39m                    [31m^[39m
    [90m 55| [39m        [33m.[39m[34minsert[39m(organizations)
    [90m 56| [39m        [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m122:25[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "organizations" violates foreign key constraint "organizations_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m server/services/OrganizationService.ts:[2m54:21[22m[39m
[90m [2mâ¯[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m122:25[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 347, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(8bbf1843-a96f-4f79-85d1-4107b89f1c79) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w16_v3', table: 'organizations', dataType: undefined, constraint: 'organizations_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[113/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mupdateOrganization[2m > [22mshould deny non-admin from updating organization
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,94bbdbcb-e8a1-4e5d-b67a-2429d7eba873,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,94bbdbcb-e8a1-4e5d-b67a-2429d7eba873,94bbdbcb-e8a1-4e5d-b67a-2429d7eba873[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(94bbdbcb-e8a1-4e5d-b67a-2429d7eba873) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[114/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mgetOrganizationMembers[2m > [22mshould return all members of organization
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,a4ab2028-6297-43ee-9edb-5f34433ae5b0,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,a4ab2028-6297-43ee-9edb-5f34433ae5b0,a4ab2028-6297-43ee-9edb-5f34433ae5b0[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(a4ab2028-6297-43ee-9edb-5f34433ae5b0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w17_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[115/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mpromoteMember[2m > [22mshould allow admin to promote member
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,ff61a24c-2d57-43b6-b159-807a28e67f2f,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,ff61a24c-2d57-43b6-b159-807a28e67f2f,ff61a24c-2d57-43b6-b159-807a28e67f2f[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(ff61a24c-2d57-43b6-b159-807a28e67f2f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w17_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[116/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mdemoteMember[2m > [22mshould allow admin to demote other admin
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,8ecd90e6-8590-4bc7-889a-96287e648834,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,8ecd90e6-8590-4bc7-889a-96287e648834,8ecd90e6-8590-4bc7-889a-96287e648834[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(8ecd90e6-8590-4bc7-889a-96287e648834) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[117/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mdemoteMember[2m > [22mshould prevent self-demotion
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,6206e3c5-59ef-431e-ae28-6c627533b0b3,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,6206e3c5-59ef-431e-ae28-6c627533b0b3,6206e3c5-59ef-431e-ae28-6c627533b0b3[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(6206e3c5-59ef-431e-ae28-6c627533b0b3) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[118/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mremoveMember[2m > [22mshould allow admin to remove member
[31m[1mError[22m: User must belong to a tenant to create organizations[39m
[36m [2mâ¯[22m OrganizationService.createOrganization server/services/OrganizationService.ts:[2m49:13[22m[39m
    [90m 47| [39m
    [90m 48| [39m    [35mif[39m ([33m![39muser[33m?.[39mtenantId) {
    [90m 49| [39m      throw new Error('User must belong to a tenant to create organizaâ€¦
    [90m   | [39m            [31m^[39m
    [90m 50| [39m    }
    [90m 51| [39m
[90m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m227:25[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[119/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mremoveMember[2m > [22mshould prevent self-removal
[31m[1mAssertionError[22m: expected [Function] to throw error including 'Cannot remove yourself' but got 'Access denied: Organization admin rolâ€¦'[39m

Expected: [32m"Cannot remove yourself"[39m
Received: [31m"Access denied: Organization admin role required"[39m

[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m249:13[22m[39m
    [90m247| [39m            testOrgId [33m=[39m org[33m.[39mid[33m;[39m
    [90m248| [39m
    [90m249| [39m            [35mawait[39m [34mexpect[39m(
    [90m   | [39m            [31m^[39m
    [90m250| [39m                organizationService.removeMember(org.id, testUserId1, â€¦
    [90m251| [39m            )[33m.[39mrejects[33m.[39m[34mtoThrow[39m([32m'Cannot remove yourself'[39m)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[120/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mleaveOrganization[2m > [22mshould allow member to leave organization
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,46d47c70-2347-4e0d-ac39-f76141128166,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,46d47c70-2347-4e0d-ac39-f76141128166,46d47c70-2347-4e0d-ac39-f76141128166[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(46d47c70-2347-4e0d-ac39-f76141128166) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w25_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[121/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mleaveOrganization[2m > [22mshould allow admin to leave organization
[31m[1mError[22m: User must belong to a tenant to create organizations[39m
[36m [2mâ¯[22m OrganizationService.createOrganization server/services/OrganizationService.ts:[2m49:13[22m[39m
    [90m 47| [39m
    [90m 48| [39m    [35mif[39m ([33m![39muser[33m?.[39mtenantId) {
    [90m 49| [39m      throw new Error('User must belong to a tenant to create organizaâ€¦
    [90m   | [39m            [31m^[39m
    [90m 50| [39m    }
    [90m 51| [39m
[90m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m272:25[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[122/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22misOrgMember[2m > [22mshould return true for org admin
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- true[39m
[31m+ false[39m

[36m [2mâ¯[22m tests/integration/ownershipAccess.test.ts:[2m126:24[22m[39m
    [90m124| [39m
    [90m125| [39m      [35mconst[39m isMember [33m=[39m [35mawait[39m [34misOrgMember[39m(userId1[33m,[39m orgId1)[33m;[39m
    [90m126| [39m      [34mexpect[39m(isMember)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m127| [39m    })[33m;[39m
    [90m128| [39m  })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[123/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22mcanManageOrg[2m > [22mshould return true for org admin
[31m[1mError[22m: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: 10000000-0000-0000-0000-000000000001,00000000-0000-0000-0000-000000000001,admin[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/ownershipAccess.test.ts:[2m132:7[22m[39m
    [90m130| [39m  [34mdescribe[39m([32m'canManageOrg'[39m[33m,[39m () [33m=>[39m {
    [90m131| [39m    [34mit[39m([32m'should return true for org admin'[39m[33m,[39m [35masync[39m () [33m=>[39m {
    [90m132| [39m      [35mawait[39m db[33m.[39m[34minsert[39m(organizationMemberships)[33m.[39m[34mvalues[39m({
    [90m   | [39m      [31m^[39m
    [90m133| [39m        orgId[33m:[39m orgId1[33m,[39m
    [90m134| [39m        userId[33m:[39m userId1[33m,[39m

[31m[1mCaused by: error[22m: duplicate key value violates unique constraint "org_membership_unique_idx"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/ownershipAccess.test.ts:[2m132:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 326, severity: 'ERROR', code: '23505', detail: 'Key (org_id, user_id)=(10000000-0000-0000-0000-000000000001, 00000000-0000-0000-0000-000000000001) already exists.', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'organization_memberships', dataType: undefined, constraint: 'org_membership_unique_idx', file: 'nbtinsert.c', routine: '_bt_check_unique' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[124/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22mgetUserOrgIds[2m > [22mshould return all org IDs for a user
[31m[1mError[22m: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default), (default, $4, $5, $6, default)
params: 10000000-0000-0000-0000-000000000001,00000000-0000-0000-0000-000000000001,member,10000000-0000-0000-0000-000000000002,00000000-0000-0000-0000-000000000001,admin[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/ownershipAccess.test.ts:[2m161:7[22m[39m
    [90m159| [39m  [34mdescribe[39m([32m'getUserOrgIds'[39m[33m,[39m () [33m=>[39m {
    [90m160| [39m    [34mit[39m([32m'should return all org IDs for a user'[39m[33m,[39m [35masync[39m () [33m=>[39m {
    [90m161| [39m      [35mawait[39m db[33m.[39m[34minsert[39m(organizationMemberships)[33m.[39m[34mvalues[39m([
    [90m   | [39m      [31m^[39m
    [90m162| [39m        { orgId[33m:[39m orgId1[33m,[39m userId[33m:[39m userId1[33m,[39m role[33m:[39m [32m'member'[39m }[33m,[39m
    [90m163| [39m        { orgId[33m:[39m orgId2[33m,[39m userId[33m:[39m userId1[33m,[39m role[33m:[39m [32m'admin'[39m }[33m,[39m

[31m[1mCaused by: error[22m: duplicate key value violates unique constraint "org_membership_unique_idx"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/ownershipAccess.test.ts:[2m161:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 326, severity: 'ERROR', code: '23505', detail: 'Key (org_id, user_id)=(10000000-0000-0000-0000-000000000001, 00000000-0000-0000-0000-000000000001) already exists.', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'organization_memberships', dataType: undefined, constraint: 'org_membership_unique_idx', file: 'nbtinsert.c', routine: '_bt_check_unique' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[125/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould list all active sessions for current user
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m78:30[22m[39m
    [90m 76| [39m      [35mconst[39m token [33m=[39m session3[33m.[39mbody[33m.[39mtoken[33m;[39m
    [90m 77| [39m      const cookies = (session3.headers as any)["set-cookie"] as strinâ€¦
    [90m 78| [39m      const cookie = cookies.find((c) => c.startsWith("refresh_token="â€¦
    [90m   | [39m                             [31m^[39m
    [90m 79| [39m
    [90m 80| [39m      [90m// List sessions[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[126/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould mark current session correctly
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 73e79c5ff369e62e49577abef6b5553b,$2b$12$LNlh3tcX23bACTxwxJP4w.B0cEoZrWhTHaJN3.xmq9x/iX5Roh7Um,2026-01-18T03:59:50.993Z,2026-01-18T03:59:50.993Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m105:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m105:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(73e79c5ff369e62e49577abef6b5553b) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[127/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould exclude revoked sessions
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: a324996487ee6a27c300c921c51e45d8,$2b$12$gxBLCgo8f4/EZMMpVJzcgegv98LhyG4QvDKJ03gKw7o/d9TMEu00i,2026-01-18T03:59:51.649Z,2026-01-18T03:59:51.649Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m135:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m135:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(a324996487ee6a27c300c921c51e45d8) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w19_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[128/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould order sessions by last used (most recent first)
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: be04992518786df49cffcf180eb4ee22,$2b$12$qw7f4T37NvQ2j0i8Ni/sVO0KVCwrmZeDyfCO5mrDEmyOMf9s4tCuy,2026-01-18T03:59:52.316Z,2026-01-18T03:59:52.316Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m167:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m167:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(be04992518786df49cffcf180eb4ee22) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[129/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould filter sessions by current user only
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 8da308968a900e91d122df5c959e946a,$2b$12$D/fFKVCJFnht4CJRGQ1tpeLlXCi.8sQ0OjX9kH/x4bi89pecsq7F2,2026-01-18T03:59:52.971Z,2026-01-18T03:59:52.971Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m198:21[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m198:21[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(8da308968a900e91d122df5c959e946a) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w0_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[130/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould revoke specific session
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: cb969875c1a67c8a974d80260fddb694,$2b$12$8H6N1arfXVLsEy6Ns2boMeheTpQFrJI1hM4UrdKFnOf/8PJD5VRIW,2026-01-18T03:59:57.226Z,2026-01-18T03:59:57.226Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m234:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m234:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(cb969875c1a67c8a974d80260fddb694) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[131/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould prevent revoking current session
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m289:30[22m[39m
    [90m287| [39m      [35mconst[39m token [33m=[39m login[33m.[39mbody[33m.[39mtoken[33m;[39m
    [90m288| [39m      [35mconst[39m cookies [33m=[39m (login[33m.[39mheaders [35mas[39m any)[[32m"set-cookie"[39m] [35mas[39m string[][33m;[39m
    [90m289| [39m      const cookie = cookies.find((c) => c.startsWith("refresh_token="â€¦
    [90m   | [39m                             [31m^[39m
    [90m290| [39m
    [90m291| [39m      [90m// Get sessions[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[132/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould return 404 for non-existent session
[31m[1mAssertionError[22m: expected 401 to be 404 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 404[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m323:31[22m[39m
    [90m321| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mlogin[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m322| [39m
    [90m323| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m404[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m324| [39m    })[33m;[39m
    [90m325| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[133/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould prevent revoking other user's session
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 13ee48caec0fa7fd776a126fafb4d46c,$2b$12$xb9HdbCZqzruIp6aFR8fh.ztl4BG8HaFurL6kfr0YvFJhiLHVotrS,2026-01-18T04:00:02.077Z,2026-01-18T04:00:02.077Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m329:21[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m329:21[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(13ee48caec0fa7fd776a126fafb4d46c) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[134/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould revoke all other sessions
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 7c7e8ef1f6b6fe3c5d79ea7abeb7f656,$2b$12$lfM0NLi4MnlgMM/al/8IaeLblutHv0nDjQFLQFcRKZ3g3ECTAwoYS,2026-01-18T04:00:03.424Z,2026-01-18T04:00:03.424Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m360:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m360:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(7c7e8ef1f6b6fe3c5d79ea7abeb7f656) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w16_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[135/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould keep current session active
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m406:30[22m[39m
    [90m404| [39m      [35mconst[39m token [33m=[39m currentLogin[33m.[39mbody[33m.[39mtoken[33m;[39m
    [90m405| [39m      const cookies = (currentLogin.headers as any)["set-cookie"] as sâ€¦
    [90m406| [39m      const cookie = cookies.find((c) => c.startsWith("refresh_token="â€¦
    [90m   | [39m                             [31m^[39m
    [90m407| [39m
    [90m408| [39m      [90m// Revoke all others[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[136/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould return 400 if no active session found
[31m[1mAssertionError[22m: expected 401 to be 400 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 400[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m444:31[22m[39m
    [90m442| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m443| [39m
    [90m444| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m400[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m445| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoContain[39m([32m"No active session"[39m)[33m;[39m
    [90m446| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[137/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould revoke all trusted devices
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m458:30[22m[39m
    [90m456| [39m      [35mconst[39m token [33m=[39m login[33m.[39mbody[33m.[39mtoken[33m;[39m
    [90m457| [39m      [35mconst[39m cookies [33m=[39m (login[33m.[39mheaders [35mas[39m any)[[32m"set-cookie"[39m] [35mas[39m string[][33m;[39m
    [90m458| [39m      const cookie = cookies.find((c) => c.startsWith("refresh_token="â€¦
    [90m   | [39m                             [31m^[39m
    [90m459| [39m
    [90m460| [39m      [90m// Trust a device[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[138/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mSession Security[2m > [22mshould include device metadata in sessions
[31m[1mTypeError[22m: Cannot read properties of undefined (reading '0')[39m
[36m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m526:37[22m[39m
    [90m524| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m525| [39m
    [90m526| [39m      [35mconst[39m session [33m=[39m response[33m.[39mbody[33m.[39msessions[[34m0[39m][33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m527| [39m
    [90m528| [39m      [34mexpect[39m(session[33m.[39mdeviceName)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[139/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mSession Security[2m > [22mshould not expose sensitive token data
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'token')[39m
[36m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m547:22[22m[39m
    [90m545| [39m
    [90m546| [39m      [90m// Should NOT include token hash or metadata[39m
    [90m547| [39m      [34mexpect[39m(session[33m.[39mtoken)[33m.[39m[34mtoBeUndefined[39m()[33m;[39m
    [90m   | [39m                     [31m^[39m
    [90m548| [39m      [34mexpect[39m(session[33m.[39mmetadata)[33m.[39m[34mtoBeUndefined[39m()[33m;[39m
    [90m549| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[140/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mSession Security[2m > [22mshould track session activity timestamps
[31m[1mTypeError[22m: Cannot read properties of undefined (reading '0')[39m
[36m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m563:37[22m[39m
    [90m561| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mlogin[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m562| [39m
    [90m563| [39m      [35mconst[39m session [33m=[39m response[33m.[39mbody[33m.[39msessions[[34m0[39m][33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m564| [39m
    [90m565| [39m      [34mexpect[39m(session[33m.[39mcreatedAt)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[141/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mProject Transfer[2m > [22mshould transfer user-owned project to org
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mProject Transfer[2m > [22mshould prevent transfer to org if user is not a member
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mProject Transfer[2m > [22mshould allow org member to transfer org-owned project to another org they belong to
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mWorkflow Transfer[2m > [22mshould detach workflow from project when transferring to different owner
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mWorkflow Transfer[2m > [22mshould keep workflow in project when transferring to same owner
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mDatabase Transfer[2m > [22mshould transfer database ownership
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mDatabase Transfer[2m > [22mshould allow org member to transfer org database
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mDatabase Transfer[2m > [22mshould prevent transfer to org if user is not a member
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mTransfer Validation[2m > [22mshould only allow transfer to self when targetOwnerType is user
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mTransfer Validation[2m > [22mshould allow transfer from user to self (org member transferring org asset to themselves)
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2mâ¯[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2mâ¯[22m OrganizationService.addMember server/services/OrganizationService.ts:[2m410:5[22m[39m
[90m [2mâ¯[22m tests/integration/transferOwnership.test.ts:[2m64:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[142/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mWorkflow Transfer[2m > [22mshould prevent non-member from transferring org workflow
[31m[1mError[22m: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: 75402028-c5b6-4e89-aad2-07d8672b1774,00000000-0000-0000-0000-000000000032,member[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m OrganizationService.addMember server/services/OrganizationService.ts:[2m420:5[22m[39m
    [90m418| [39m
    [90m419| [39m    [90m// Add membership[39m
    [90m420| [39m    [35mawait[39m db[33m.[39m[34minsert[39m(organizationMemberships)[33m.[39m[34mvalues[39m({
    [90m   | [39m    [31m^[39m
    [90m421| [39m      orgId[33m,[39m
    [90m422| [39m      userId[33m:[39m targetUserId[33m,[39m
[90m [2mâ¯[22m tests/integration/transferOwnership.test.ts:[2m64:9[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_org_id_organizations_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m OrganizationService.addMember server/services/OrganizationService.ts:[2m420:5[22m[39m
[90m [2mâ¯[22m tests/integration/transferOwnership.test.ts:[2m64:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 400, severity: 'ERROR', code: '23503', detail: 'Key (org_id)=(75402028-c5b6-4e89-aad2-07d8672b1774) is not present in table "organizations".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_org_id_organizations_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[143/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mPOST /api/auth/trust-device[2m > [22mshould trust current device
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 3b1102cd85d69160b91cead8c9ce85d1,$2b$12$S2GIk7WW.qXSRDWdSKWy0OaX7RUFMb/4pVTIap38cB9nBBzMZOie6,2026-01-18T03:59:49.532Z,2026-01-18T03:59:49.532Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m58:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m58:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(3b1102cd85d69160b91cead8c9ce85d1) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[144/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mPOST /api/auth/trust-device[2m > [22mshould set trust expiry to 30 days
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 5086e2e9b855de7c6aaf2ebe6efdb678,$2b$12$qkfJ2nUxU5HbaKi9jIe50.KWnXdEU4fSMPZ/snHWfHWCvMgkgd/mu,2026-01-18T03:59:50.176Z,2026-01-18T03:59:50.176Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m97:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m97:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(5086e2e9b855de7c6aaf2ebe6efdb678) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[145/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mPOST /api/auth/trust-device[2m > [22mshould update expiry if device already trusted
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 29199f95a547e59761a9907d26adbb5e,$2b$12$b2Tj5UEX3rWfMRh0b69Anu8M3hHaw4DsTAVZSaCQpIBz8Akz.BDRO,2026-01-18T03:59:50.815Z,2026-01-18T03:59:50.815Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m124:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m124:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(29199f95a547e59761a9907d26adbb5e) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[146/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould list all trusted devices
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: 8d0c17a0494beb094989b4c8735ccc6e,IU5HGURKOQSWWQCOOQ2WK5CCIR2TAI3YKFKE46ZZPNKFELZMNMYA,true,2026-01-18T03:59:51.599Z,2026-01-18T03:59:51.599Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m183:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m183:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 322, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(8d0c17a0494beb094989b4c8735ccc6e) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[147/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould mark current device
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: 9e84510f98d184475cd4d5dceb73357b,MUZWWPDUNZPFKPZDMRZCSVLEEZLUA5SQGJGUQOB6N5KU4I3IGYUQ,true,2026-01-18T03:59:52.365Z,2026-01-18T03:59:52.365Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m240:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m240:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 322, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(9e84510f98d184475cd4d5dceb73357b) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[148/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould exclude revoked devices
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 7898243ccc3f7dc612e8eb7888bd791f,$2b$12$4MTIK1gDtQ/FoRf/TEUSQOVHwrfqP8qo71/vvdkUoZGexFcU6iGRG,2026-01-18T03:59:53.031Z,2026-01-18T03:59:53.031Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m272:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m272:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(7898243ccc3f7dc612e8eb7888bd791f) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[149/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould exclude expired devices
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: fd1d8698edb6491caa18825bab431f15,$2b$12$wTRrEQ.DwlR2ZyuR1cZAMuLEW/DQ9lkMKs1pwecBjRu0zTn4LXsFS,2026-01-18T03:59:54.202Z,2026-01-18T03:59:54.202Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m305:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m305:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(fd1d8698edb6491caa18825bab431f15) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[150/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDELETE /api/auth/trusted-devices/:deviceId[2m > [22mshould revoke specific device
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: e96684ff29b225eeef5bcaa98831f329,MVZCYT23KJLGQJR3KRTSI2JUI4SXA5JWJZZEELS5HBJFU3BGHJWA,true,2026-01-18T03:59:54.947Z,2026-01-18T03:59:54.947Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m341:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m341:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 322, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(e96684ff29b225eeef5bcaa98831f329) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w0_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[151/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDELETE /api/auth/trusted-devices/:deviceId[2m > [22mshould return 404 for non-existent device
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 9332db4842ffb1bce6529fc86d3c6f60,$2b$12$vWdyGlSRLdjs.RhDzNrlwOmmcw4SlxKcWnQNvTKpoet7748j3JecO,2026-01-18T03:59:55.583Z,2026-01-18T03:59:55.583Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m391:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m391:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(9332db4842ffb1bce6529fc86d3c6f60) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[152/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDELETE /api/auth/trusted-devices/:deviceId[2m > [22mshould prevent revoking other user's device
[31m[1mError[22m: Failed query: insert into "mfa_backup_codes" ("id", "user_id", "code_hash", "used", "used_at", "created_at") values (default, $1, $2, $3, default, $4), (default, $5, $6, $7, default, $8), (default, $9, $10, $11, default, $12), (default, $13, $14, $15, default, $16), (default, $17, $18, $19, default, $20), (default, $21, $22, $23, default, $24), (default, $25, $26, $27, default, $28), (default, $29, $30, $31, default, $32), (default, $33, $34, $35, default, $36), (default, $37, $38, $39, default, $40)
params: d5849716d1c7535cc039f696d83d9622,$2b$10$WCtITkHWiuhIRoc0WNHsZ.jn2g03y392C7s./JdTgJe7vxzbTJQe6,false,2026-01-18T03:59:56.548Z,d5849716d1c7535cc039f696d83d9622,$2b$10$LrmRnzUA/m5.li/66ARG.uHJCZPBKyrKUABO9/77tNbui4hDGa8d.,false,2026-01-18T03:59:56.546Z,d5849716d1c7535cc039f696d83d9622,$2b$10$oXc63repCR6m7qxrsteqy.ZnkPCW7P3K2v0Hjle5Qgd349m43la1u,false,2026-01-18T03:59:56.546Z,d5849716d1c7535cc039f696d83d9622,$2b$10$ap3FgdzDadoyIMPX8SI2SOSwAAndKDIhLPkM1ibuBRUVKyIiONMa.,false,2026-01-18T03:59:56.602Z,d5849716d1c7535cc039f696d83d9622,$2b$10$TG900w5ztH7gauh4RtBdSuksSfHyF4f43UiCF0mRzpJLEYgEeHkBS,false,2026-01-18T03:59:56.546Z,d5849716d1c7535cc039f696d83d9622,$2b$10$xRS.3eaGwLjoxlR6GYpzCeSjSExAmCZIi71pnI4qWZj3qc4MHpCOW,false,2026-01-18T03:59:56.602Z,d5849716d1c7535cc039f696d83d9622,$2b$10$v3oMvx.zutGMAZwaAj9u2u8m61Be4jkhspMGaXMs96foEGQcsv3R2,false,2026-01-18T03:59:56.603Z,d5849716d1c7535cc039f696d83d9622,$2b$10$vWugrYDW0lKs.PooQEttWuSXHXF4OXQjDlHZhOqLaZ4ObvpWnqlYm,false,2026-01-18T03:59:56.603Z,d5849716d1c7535cc039f696d83d9622,$2b$10$XFu7XxhPGa.f8CIo86Uz1udWTSZG8dBwfTcWz9JJCntCOoUdCpU3u,false,2026-01-18T03:59:56.657Z,d5849716d1c7535cc039f696d83d9622,$2b$10$mQPWLIoxhqZojjWPUrexFOnTBEeAOvbJr/Q7IvK9oWilKOZ9oZGBC,false,2026-01-18T03:59:56.658Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m258:3[22m[39m
    [90m256| [39m  )[33m;[39m
    [90m257| [39m
    [90m258| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaBackupCodes)[33m.[39m[34mvalues[39m(hashedCodes)[33m;[39m
    [90m   | [39m  [31m^[39m
    [90m259| [39m
    [90m260| [39m  [35mreturn[39m {
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m410:21[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_backup_codes" violates foreign key constraint "mfa_backup_codes_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m258:3[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m410:21[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(d5849716d1c7535cc039f696d83d9622) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'mfa_backup_codes', dataType: undefined, constraint: 'mfa_backup_codes_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[153/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDevice Trust with MFA Login[2m > [22mshould skip MFA for trusted device
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: 292636ac112aeb2134f1eb608b27277d,MM2WKOD3PA2DUW3UJIUTU2BXMQTDGSTWOBUGITLEO5CDKUTBOJIQ,true,2026-01-18T03:59:57.428Z,2026-01-18T03:59:57.428Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m459:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m459:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 322, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(292636ac112aeb2134f1eb608b27277d) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[154/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDevice Trust with MFA Login[2m > [22mshould require MFA for untrusted device
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: cc7cf6c21cf8de53ecc2eb497a89f815,$2b$12$OFFzO3UWMAGNBpPD8nX8P.73oqr8jXRPCyfloAZ/bPV5HfphnvAyO,2026-01-18T03:59:58.075Z,2026-01-18T03:59:58.075Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m497:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m497:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(cc7cf6c21cf8de53ecc2eb497a89f815) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[155/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDevice Trust with MFA Login[2m > [22mshould update lastUsedAt on trusted device login
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: aa232c8bbc2e32f9f05d2feae326c92b,NFLFUVDRFZEXCIJJOBMEMV3HG5SH2TLGNEVFIKLGIYZU2VCWLM7Q,true,2026-01-18T03:59:58.814Z,2026-01-18T03:59:58.814Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m528:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m528:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 322, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(aa232c8bbc2e32f9f05d2feae326c92b) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w2_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[156/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mREPRO: ScriptEngine fails to resolve alias 'input_variable' when aliasMap is NOT provided
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, $6, default, default, default, default, default, default, default, default)
params: c56070d5-719b-416d-8a15-5fb8d7bdfbeb,safety - 4c75164b-99be-437e-a868-aeacb6bc25a6 @example.com,e63ce8d7-f892-4c80-a91b-5db1173d0066,admin,owner,local[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/variableSafety.test.ts:[2m51:9[22m[39m
    [90m 49| [39m
    [90m 50| [39m        userId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 51| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(usersSchema)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 52| [39m            id[33m:[39m userId[33m,[39m
    [90m 53| [39m            email[33m:[39m [32m`safety - [39m[36m${[39m[34muuidv4[39m()[36m}[39m[32m @example.com`[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/variableSafety.test.ts:[2m51:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(e63ce8d7-f892-4c80-a91b-5db1173d0066) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w16_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[157/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mScriptEngine resolves alias 'input_variable' when aliasMap is provided
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: 522a6ddb-48bb-4106-a32c-a7809648851e,Safety Workflow,aa50ae61-b353-45c6-8ec0-a732bd6f4afb,aa50ae61-b353-45c6-8ec0-a732bd6f4afb,2cefad0b-1ccf-42c0-be2a-79229722d65b,4a8c903e-54d5-41ac-aeae-2f3a3f76321e[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m
    [90m 73| [39m        workflowId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 74| [39m        versionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 75| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(workflowsSchema)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 76| [39m            id[33m:[39m workflowId[33m,[39m
    [90m 77| [39m            projectId[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(aa50ae61-b353-45c6-8ec0-a732bd6f4afb) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w25_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[158/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mREPRO: BlockRunner fails to resolve alias in CreateRecordConfig
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: c8ffd6bb-bb8c-4dd4-949e-ddf008a0953f,Safety Workflow,790ffcd2-c03f-493c-b089-51c3bad8a414,790ffcd2-c03f-493c-b089-51c3bad8a414,13a5e8c9-a40b-469b-a7f2-2b18d6c49370,61176c2c-3a5a-43f2-a7e9-6ef932db1523[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m
    [90m 73| [39m        workflowId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 74| [39m        versionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 75| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(workflowsSchema)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 76| [39m            id[33m:[39m workflowId[33m,[39m
    [90m 77| [39m            projectId[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/variableSafety.test.ts:[2m75:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(790ffcd2-c03f-493c-b089-51c3bad8a414) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w26_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[159/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mBlockRunner logic resolves alias with aliasMap
[31m[1mError[22m: Failed query: insert into "workflow_versions" ("id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at") values ($1, $2, default, $3, default, $4, default, default, default, default, $5, default, default, default, default)
params: 88afcdad-f8fc-4513-beda-3937ae7d6015,5465ed4a-f6dc-4801-bed7-f1122526e3ef,1,{},bd945b01-4890-4d5f-978c-af9fa3722ca8[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/variableSafety.test.ts:[2m84:9[22m[39m
    [90m 82| [39m        } [35mas[39m any)[33m;[39m
    [90m 83| [39m
    [90m 84| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(workflowVersionsSchema)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 85| [39m            id[33m:[39m versionId[33m,[39m
    [90m 86| [39m            workflowId[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "workflow_versions" violates foreign key constraint "workflow_versions_workflow_id_workflows_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/variableSafety.test.ts:[2m84:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 375, severity: 'ERROR', code: '23503', detail: 'Key (workflow_id)=(5465ed4a-f6dc-4801-bed7-f1122526e3ef) is not present in table "workflows".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w25_v3', table: 'workflow_versions', dataType: undefined, constraint: 'workflow_versions_workflow_id_workflows_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[160/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould create draft version on successful AI edit
[31m[1mError[22m: expected 200 "OK", got 400 "Bad Request"[39m
[36m [2mâ¯[22m tests/integration/ai/workflowEdit.test.ts:[2m183:8[22m[39m
    [90m181| [39m      })
    [90m182| [39m
    [90m183| [39m      [33m.[39m[34mexpect[39m([34m200[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m184| [39m
    [90m185| [39m    [34mexpect[39m(response[33m.[39mbody[33m.[39msuccess)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
[90m [2mâ¯[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2mâ¯[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2mâ¯[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2mâ¯[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2mâ¯[22m Server.<anonymous> node_modules/supertest/lib/test.js:[2m152:11[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[161/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould enforce draft mode (revert active workflow to draft)
[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould not create version when no changes detected (checksum match)
[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould reject unauthorized access
[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould reject unsafe DataVault operations
[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould handle multi-operation edits with tempId resolution
[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould create BEFORE and AFTER snapshots
[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22mshould rollback on validation failure
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, default, $2, $3, default, default, default, $4, default, default, default, default, default, default, $5, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,11ba025d-9803-4419-b835-377932e9df26,11ba025d-9803-4419-b835-377932e9df26,a6557cd1-22c7-4470-b72c-e797323e0317,active[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/ai/workflowEdit.test.ts:[2m137:24[22m[39m
    [90m135| [39m  [34mbeforeEach[39m([35masync[39m () [33m=>[39m {
    [90m136| [39m    [90m// Create fresh workflow for each test[39m
    [90m137| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m                       [31m^[39m
    [90m138| [39m      title[33m:[39m [32m'Test Workflow'[39m[33m,[39m
    [90m139| [39m      projectId[33m:[39m testProjectId[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/ai/workflowEdit.test.ts:[2m137:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(11ba025d-9803-4419-b835-377932e9df26) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w34_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[162/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/auth.middleware.integration.test.ts[2m > [22mAuth Middleware Integration Tests[2m > [22mrequireAuth Middleware[2m > [22mshould allow access with valid JWT Bearer token
[41m[1m FAIL [22m[49m tests/integration/auth/auth.middleware.integration.test.ts[2m > [22mAuth Middleware Integration Tests[2m > [22mrequireAuth Middleware[2m > [22mshould return 401 when no token provided
[41m[1m FAIL [22m[49m tests/integration/auth/auth.middleware.integration.test.ts[2m > [22mAuth Middleware Integration Tests[2m > [22mrequireAuth Middleware[2m > [22mshould return 401 with invalid token
[41m[1m FAIL [22m[49m tests/integration/auth/auth.middleware.integration.test.ts[2m > [22mAuth Middleware Integration Tests[2m > [22moptionalHybridAuth Middleware[2m > [22mshould authenticate with cookie if JWT not provided
[41m[1m FAIL [22m[49m tests/integration/auth/auth.middleware.integration.test.ts[2m > [22mAuth Middleware Integration Tests[2m > [22moptionalHybridAuth Middleware[2m > [22mshould proceed anonymously if no auth provided
[41m[1m FAIL [22m[49m tests/integration/auth/auth.middleware.integration.test.ts[2m > [22mAuth Middleware Integration Tests[2m > [22moptionalHybridAuth Middleware[2m > [22mshould proceed anonymously if both JWT and cookie are invalid
[41m[1m FAIL [22m[49m tests/integration/auth/auth.middleware.integration.test.ts[2m > [22mAuth Middleware Integration Tests[2m > [22mCookie Strategy Security[2m > [22mshould only allow safe methods for cookie auth
[41m[1m FAIL [22m[49m tests/integration/auth/auth.middleware.integration.test.ts[2m > [22mAuth Middleware Integration Tests[2m > [22mCookie Strategy Security[2m > [22mshould ignore cookies when Bearer token present
[41m[1m FAIL [22m[49m tests/integration/auth/auth.middleware.integration.test.ts[2m > [22mAuth Middleware Integration Tests[2m > [22mUser Context Attachment[2m > [22mshould attach userId to request
[41m[1m FAIL [22m[49m tests/integration/auth/auth.middleware.integration.test.ts[2m > [22mAuth Middleware Integration Tests[2m > [22mUser Context Attachment[2m > [22mshould attach userEmail to request
[41m[1m FAIL [22m[49m tests/integration/auth/auth.middleware.integration.test.ts[2m > [22mAuth Middleware Integration Tests[2m > [22mError Handling[2m > [22mshould return consistent error format for missing token
[41m[1m FAIL [22m[49m tests/integration/auth/auth.middleware.integration.test.ts[2m > [22mAuth Middleware Integration Tests[2m > [22mError Handling[2m > [22mshould return consistent error format for invalid token
[41m[1m FAIL [22m[49m tests/integration/auth/auth.middleware.integration.test.ts[2m > [22mAuth Middleware Integration Tests[2m > [22mError Handling[2m > [22mshould return consistent error format for expired token
[41m[1m FAIL [22m[49m tests/integration/auth/auth.middleware.integration.test.ts[2m > [22mAuth Middleware Integration Tests[2m > [22mError Handling[2m > [22mshould handle malformed JWT gracefully
[41m[1m FAIL [22m[49m tests/integration/auth/auth.middleware.integration.test.ts[2m > [22mAuth Middleware Integration Tests[2m > [22mError Handling[2m > [22mshould handle JWT with wrong algorithm
[31m[1mError[22m: expected 201 "Created", got 500 "Internal Server Error"[39m
[36m [2mâ¯[22m tests/integration/auth/auth.middleware.integration.test.ts:[2m60:14[22m[39m
    [90m 58| [39m            [33m.[39m[34mpost[39m([32m"/api/auth/register"[39m)
    [90m 59| [39m            [33m.[39m[34msend[39m(testUser)
    [90m 60| [39m            [33m.[39m[34mexpect[39m([34m201[39m)[33m;[39m
    [90m   | [39m             [31m^[39m
    [90m 61| [39m
    [90m 62| [39m        [35mconst[39m userId [33m=[39m registerRes[33m.[39mbody[33m.[39muser[33m.[39mid[33m;[39m
[90m [2mâ¯[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2mâ¯[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2mâ¯[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2mâ¯[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m156:7[22m[39m
[90m [2mâ¯[22m Test.Request.callback node_modules/superagent/lib/node/index.js:[2m857:3[22m[39m
[90m [2mâ¯[22m node_modules/superagent/lib/node/index.js:[2m1102:18[22m[39m
[90m [2mâ¯[22m IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:[2m21:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[163/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/auth.middleware.integration.test.ts[2m > [22mAuth Middleware Integration Tests[2m > [22mhybridAuth Middleware[2m > [22mshould authenticate with JWT Bearer token
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth/auth.middleware.integration.test.ts:[2m86:33[22m[39m
    [90m 84| [39m        }
    [90m 85| [39m
    [90m 86| [39m        [34mexpect[39m(loginRes[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                [31m^[39m
    [90m 87| [39m
    [90m 88| [39m        userToken [33m=[39m loginRes[33m.[39mbody[33m.[39mtoken[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[164/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/auth.middleware.integration.test.ts[2m > [22mAuth Middleware Integration Tests[2m > [22moptionalHybridAuth Middleware[2m > [22mshould authenticate with JWT if provided
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2mâ¯[22m tests/integration/auth/auth.middleware.integration.test.ts:[2m86:33[22m[39m
    [90m 84| [39m        }
    [90m 85| [39m
    [90m 86| [39m        [34mexpect[39m(loginRes[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                [31m^[39m
    [90m 87| [39m
    [90m 88| [39m        userToken [33m=[39m loginRes[33m.[39mbody[33m.[39mtoken[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[165/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould successfully authenticate with valid Google ID token
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth/oauth2.google.test.ts:[2m91:31[22m[39m
    [90m 89| [39m
    [90m 90| [39m      [90m// Verify response[39m
    [90m 91| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m 92| [39m      [34mexpect[39m(response[33m.[39mbody)[33m.[39m[34mtoMatchObject[39m({
    [90m 93| [39m        message[33m:[39m [32m'Authentication successful'[39m[33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[166/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould update existing user on subsequent logins
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default)
params: google-user-existing,existing@example.com,Old Name,Old,Name,c326c290-b0d6-4182-8393-5aa561f47b26,creator,viewer,google,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.google.test.ts:[2m218:7[22m[39m
    [90m216| [39m
    [90m217| [39m      [90m// Create existing user[39m
    [90m218| [39m      [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m      [31m^[39m
    [90m219| [39m        id[33m:[39m userId[33m,[39m
    [90m220| [39m        email[33m:[39m [32m'existing@example.com'[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.google.test.ts:[2m218:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(c326c290-b0d6-4182-8393-5aa561f47b26) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w16_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[167/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould create refresh token record in database
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth/oauth2.google.test.ts:[2m297:31[22m[39m
    [90m295| [39m        })[33m;[39m
    [90m296| [39m
    [90m297| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m298| [39m
    [90m299| [39m      [90m// Verify refresh token exists in database[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[168/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould support both "token" and "idToken" fields
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth/oauth2.google.test.ts:[2m332:31[22m[39m
    [90m330| [39m        })[33m;[39m
    [90m331| [39m
    [90m332| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m333| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoBe[39m([32m'Authentication successful'[39m)[33m;[39m
    [90m334| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[169/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould handle missing profile information gracefully
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth/oauth2.google.test.ts:[2m395:31[22m[39m
    [90m393| [39m        })[33m;[39m
    [90m394| [39m
    [90m395| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m396| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39muser)[33m.[39m[34mtoMatchObject[39m({
    [90m397| [39m        email[33m:[39m [32m'minimal@example.com'[39m[33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[170/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould list all active sessions for current user
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: DAkYkTQ4FJvamGh5FAGAM,session-test-b6gfFog0iiK34Gg1uIMnr@example.com,Session Test,Session,Test,69d44b32-7824-4361-bbcc-d41ebfd701d7,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(69d44b32-7824-4361-bbcc-d41ebfd701d7) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[171/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould mark current session as current
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: LQ3ub71VnDt4mWRuIkZX9,session-test-WvKzngo2uYbh31CrFirQF@example.com,Session Test,Session,Test,69d44b32-7824-4361-bbcc-d41ebfd701d7,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(69d44b32-7824-4361-bbcc-d41ebfd701d7) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[172/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould return empty array when user has no active sessions
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: eoUGFahWdnxCSpnDwG06b,session-test-WkVTdPHiUg8kGw5ye5RtN@example.com,Session Test,Session,Test,69d44b32-7824-4361-bbcc-d41ebfd701d7,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(69d44b32-7824-4361-bbcc-d41ebfd701d7) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[173/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould not include expired sessions
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: ZaoEMMUS1HtR_rDDFJeTl,session-test-ZgDyoQhH3LYSVP02JaH6M@example.com,Session Test,Session,Test,69d44b32-7824-4361-bbcc-d41ebfd701d7,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(69d44b32-7824-4361-bbcc-d41ebfd701d7) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[174/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould not include revoked sessions
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: -8m4mmN2xG25iPy3z690v,session-test-9pFPgi3bEMSMYu2WvYtEb@example.com,Session Test,Session,Test,69d44b32-7824-4361-bbcc-d41ebfd701d7,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(69d44b32-7824-4361-bbcc-d41ebfd701d7) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[175/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould parse device name from user agent
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: FJ6A-CMCZ33WIFnzf1BxS,session-test-WS-jtuk1QOQf49MpI5gc8@example.com,Session Test,Session,Test,69d44b32-7824-4361-bbcc-d41ebfd701d7,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(69d44b32-7824-4361-bbcc-d41ebfd701d7) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[176/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould return 401 for unauthenticated request
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: MXCaMcUWp6oQOF2JDZ6jn,session-test-iLibb5fy2sw_CIRvEYQdp@example.com,Session Test,Session,Test,69d44b32-7824-4361-bbcc-d41ebfd701d7,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(69d44b32-7824-4361-bbcc-d41ebfd701d7) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[177/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/:sessionId - Revoke Session[2m > [22mshould revoke a specific session
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: bauWhwncyA_J10H89l36E,session-test-qYp3LHf2ff9dS9vqLwK5U@example.com,Session Test,Session,Test,69d44b32-7824-4361-bbcc-d41ebfd701d7,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(69d44b32-7824-4361-bbcc-d41ebfd701d7) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[178/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/:sessionId - Revoke Session[2m > [22mshould return 404 for non-existent session
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: ZaIUh-I26MBULNOIpc5pd,session-test-_TDmrbkEUCTwpQWon1xqO@example.com,Session Test,Session,Test,69d44b32-7824-4361-bbcc-d41ebfd701d7,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(69d44b32-7824-4361-bbcc-d41ebfd701d7) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[179/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/:sessionId - Revoke Session[2m > [22mshould prevent revoking current session
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: BUZxGTcclPfjxKheV_6bR,session-test-Xi-3WggmIr2qaPAhDg5yY@example.com,Session Test,Session,Test,69d44b32-7824-4361-bbcc-d41ebfd701d7,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(69d44b32-7824-4361-bbcc-d41ebfd701d7) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[180/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/:sessionId - Revoke Session[2m > [22mshould prevent revoking another user's session
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: _Xp5c2KCxUb1usKiIpKL6,session-test-o1ApshIueJMXqf8h8aFeX@example.com,Session Test,Session,Test,69d44b32-7824-4361-bbcc-d41ebfd701d7,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(69d44b32-7824-4361-bbcc-d41ebfd701d7) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[181/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/:sessionId - Revoke Session[2m > [22mshould return 401 for unauthenticated request
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, default, default) returning "id", "user_id", "password_hash", "created_at", "updated_at"
params: kifPKNLXTYO9MhSRQRTyo,$2b$12$/HJWG.IIP6/ualVVn5cj0e12CLTw7cg9wFfgD9kwQFQe86jW1zL8W[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m UserCredentialsRepository.createCredentials server/repositories/UserCredentialsRepository.ts:[2m42:29[22m[39m
    [90m 40| [39m
    [90m 41| [39m    [35mtry[39m {
    [90m 42| [39m      [35mconst[39m [credentials] [33m=[39m [35mawait[39m database
    [90m   | [39m                            [31m^[39m
    [90m 43| [39m        [33m.[39m[34minsert[39m(userCredentials)
    [90m 44| [39m        [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m70:5[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m UserCredentialsRepository.createCredentials server/repositories/UserCredentialsRepository.ts:[2m42:29[22m[39m
[90m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m70:5[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 331, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(kifPKNLXTYO9MhSRQRTyo) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[182/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/all - Logout All Other Devices[2m > [22mshould revoke all sessions except current
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: eb4kPTDqia9n5kTI8Ynfg,session-test--4huoSJsTF5rebBJZEKv3@example.com,Session Test,Session,Test,69d44b32-7824-4361-bbcc-d41ebfd701d7,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(69d44b32-7824-4361-bbcc-d41ebfd701d7) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[183/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/all - Logout All Other Devices[2m > [22mshould revoke all trusted devices
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: o5v8XmTqS7Jot0-BldvX8,session-test-YR7Mxp2F3xlpevxEOTwA9@example.com,Session Test,Session,Test,69d44b32-7824-4361-bbcc-d41ebfd701d7,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(69d44b32-7824-4361-bbcc-d41ebfd701d7) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[184/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/all - Logout All Other Devices[2m > [22mshould return 400 when no active session found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: YbDqUkDux6w-OXz-HoqW0,session-test-H7QHOzu2U3jKXgmERRVEn@example.com,Session Test,Session,Test,69d44b32-7824-4361-bbcc-d41ebfd701d7,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(69d44b32-7824-4361-bbcc-d41ebfd701d7) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[185/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/all - Logout All Other Devices[2m > [22mshould return 401 for unauthenticated request
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: kYRKlXNscoDMiNqMgoAQc,session-test-fwZa8DyEjEAl7KPH0WDNd@example.com,Session Test,Session,Test,69d44b32-7824-4361-bbcc-d41ebfd701d7,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(69d44b32-7824-4361-bbcc-d41ebfd701d7) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[186/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mPOST /api/auth/trust-device[2m > [22mshould mark current device as trusted
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: j0EGGYff57i2gk_XDqj2C,session-test-ewrmGvwKkIf274mqNu3v7@example.com,Session Test,Session,Test,69d44b32-7824-4361-bbcc-d41ebfd701d7,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(69d44b32-7824-4361-bbcc-d41ebfd701d7) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[187/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mPOST /api/auth/trust-device[2m > [22mshould update existing trusted device expiry
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: THck31D0tnXBJY4OWrqn7,session-test-PTmgCw9fXU16EDLz1jJSN@example.com,Session Test,Session,Test,69d44b32-7824-4361-bbcc-d41ebfd701d7,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(69d44b32-7824-4361-bbcc-d41ebfd701d7) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[188/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould list all trusted devices
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: skM6gtKANCUK-gYXfPNUR,session-test-Mitee2Ab0taluTY9PogRG@example.com,Session Test,Session,Test,69d44b32-7824-4361-bbcc-d41ebfd701d7,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(69d44b32-7824-4361-bbcc-d41ebfd701d7) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[189/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould not include revoked devices
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: bzzHRay5KkN03CBNO1NZW,session-test-_of73Ax5BSq_aaew45RkM@example.com,Session Test,Session,Test,69d44b32-7824-4361-bbcc-d41ebfd701d7,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(69d44b32-7824-4361-bbcc-d41ebfd701d7) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[190/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mDELETE /api/auth/trusted-devices/:deviceId[2m > [22mshould revoke a trusted device
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: Sm8vxO8l_cithjnuQXEF6,session-test--jhzf-mKoq58l4ZKJZc5L@example.com,Session Test,Session,Test,69d44b32-7824-4361-bbcc-d41ebfd701d7,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(69d44b32-7824-4361-bbcc-d41ebfd701d7) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[191/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mDELETE /api/auth/trusted-devices/:deviceId[2m > [22mshould return 404 for non-existent device
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: AgKlUrDSi4XtsSK_q7X2n,session-test-AUpPiciyN5gEzSHd_fALO@example.com,Session Test,Session,Test,69d44b32-7824-4361-bbcc-d41ebfd701d7,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(69d44b32-7824-4361-bbcc-d41ebfd701d7) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[192/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mSession Metadata Tracking[2m > [22mshould track IP address for sessions
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: nJTUyEDqbXfUG5wDDYaQk,session-test-h4UnWq6gRP8AGgwbrnH9z@example.com,Session Test,Session,Test,69d44b32-7824-4361-bbcc-d41ebfd701d7,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(69d44b32-7824-4361-bbcc-d41ebfd701d7) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[193/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mSession Metadata Tracking[2m > [22mshould track user agent for sessions
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 1Y8g9p6AMRa9bnYQfORU-,session-test-DlyEma82I03jrY8aET7MG@example.com,Session Test,Session,Test,69d44b32-7824-4361-bbcc-d41ebfd701d7,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(69d44b32-7824-4361-bbcc-d41ebfd701d7) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[194/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mSession Metadata Tracking[2m > [22mshould update lastUsedAt on token refresh
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: kZaXDVNs-zbQQRkrx4ef2,session-test-iFGn-UCz2yOCRrUDrAKup@example.com,Session Test,Session,Test,69d44b32-7824-4361-bbcc-d41ebfd701d7,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(69d44b32-7824-4361-bbcc-d41ebfd701d7) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[195/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould refresh access token with valid refresh token
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: JRNfOgATUuhscUBrgJQyD,refresh-test-LdYoBjD22cne_5fHpadv_@example.com,Refresh Test,Refresh,Test,1280d571-f40b-442b-b2e8-4d3f41603859,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(1280d571-f40b-442b-b2e8-4d3f41603859) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[196/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould rotate refresh token after use
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: R7MyfwIrEk35YHFO6NqGF,refresh-test-9gpFG5-imUoWY1lUH8ead@example.com,Refresh Test,Refresh,Test,1280d571-f40b-442b-b2e8-4d3f41603859,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(1280d571-f40b-442b-b2e8-4d3f41603859) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[197/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould return 401 when refresh token is missing
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: Wfn7jGwJ_xDyg08jmDIEO,refresh-test-Sj5fR8rMgOLDP9YpFMSjz@example.com,Refresh Test,Refresh,Test,1280d571-f40b-442b-b2e8-4d3f41603859,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(1280d571-f40b-442b-b2e8-4d3f41603859) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[198/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould return 401 for invalid refresh token
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: OaY60f3iYaBkd-SmW_dUB,refresh-test-XYyV4LssxhUclugUMygGM@example.com,Refresh Test,Refresh,Test,1280d571-f40b-442b-b2e8-4d3f41603859,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(1280d571-f40b-442b-b2e8-4d3f41603859) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[199/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould return 401 for expired refresh token
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: wyzkpYGLoY5-AACwbfgB_,refresh-test--xorWy_ACU-gb858SBGcM@example.com,Refresh Test,Refresh,Test,1280d571-f40b-442b-b2e8-4d3f41603859,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(1280d571-f40b-442b-b2e8-4d3f41603859) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[200/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould return 401 for revoked refresh token
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: -0iOj7GlEo8NabxhYpIdV,refresh-test-HS6zGJt4ZcpxqiZgGXC9U@example.com,Refresh Test,Refresh,Test,1280d571-f40b-442b-b2e8-4d3f41603859,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(1280d571-f40b-442b-b2e8-4d3f41603859) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[201/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould return 401 when user is not found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: O-f1fGlIzBCbFp4bP6yaP,refresh-test-QRK2Lo1E90CcWL2U3JXA-@example.com,Refresh Test,Refresh,Test,1280d571-f40b-442b-b2e8-4d3f41603859,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(1280d571-f40b-442b-b2e8-4d3f41603859) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[202/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould update refresh token metadata on rotation
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: q7qzF2041dSRjjND5bFwq,refresh-test-qhSlj2Jkl-bsuwekhEnoH@example.com,Refresh Test,Refresh,Test,1280d571-f40b-442b-b2e8-4d3f41603859,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(1280d571-f40b-442b-b2e8-4d3f41603859) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[203/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould handle concurrent refresh token requests (token reuse detection)
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: RyeJTcqA98obSmr_zsYz8,refresh-test-s8XATQRpWI3i6zxPyrVTq@example.com,Refresh Test,Refresh,Test,1280d571-f40b-442b-b2e8-4d3f41603859,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(1280d571-f40b-442b-b2e8-4d3f41603859) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[204/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould set secure cookie in production
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: ZXCKAqugg5lR1tnJ9Vo5q,refresh-test-zlaNHnMEO0NfUXawa3KG1@example.com,Refresh Test,Refresh,Test,1280d571-f40b-442b-b2e8-4d3f41603859,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(1280d571-f40b-442b-b2e8-4d3f41603859) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[205/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould set proper cookie attributes
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: oD39h5tgwr32qRxf_bkxw,refresh-test-zJxokncsRC8wuXNQuiyz-@example.com,Refresh Test,Refresh,Test,1280d571-f40b-442b-b2e8-4d3f41603859,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(1280d571-f40b-442b-b2e8-4d3f41603859) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[206/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould include user role information in response
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: K7NevzFzOb43K8oC4bRp4,refresh-test-UZk8PZhtBELNh87B19QVg@example.com,Refresh Test,Refresh,Test,1280d571-f40b-442b-b2e8-4d3f41603859,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(1280d571-f40b-442b-b2e8-4d3f41603859) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[207/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Lifecycle[2m > [22mshould create refresh token on login
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: x_T3EHqgECGssxL2t-PLm,refresh-test-T4vrAqgfP8BqDL3pW0HRr@example.com,Refresh Test,Refresh,Test,1280d571-f40b-442b-b2e8-4d3f41603859,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(1280d571-f40b-442b-b2e8-4d3f41603859) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[208/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Lifecycle[2m > [22mshould revoke refresh token on logout
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: m6WoYtp2-K1FwQwlFYES8,refresh-test-Vnfz8XsROG-nGdpsTvZ6k@example.com,Refresh Test,Refresh,Test,1280d571-f40b-442b-b2e8-4d3f41603859,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(1280d571-f40b-442b-b2e8-4d3f41603859) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[209/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Lifecycle[2m > [22mshould handle logout without refresh token gracefully
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, default, default) returning "id", "user_id", "password_hash", "created_at", "updated_at"
params: WMTiwN0HxIvxfmkA08YhL,$2b$12$wtXqCZRSLZriIqlm6gjXuuaXQVqhkI8XgDyioN0L89lBAPIU8s31O[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m UserCredentialsRepository.createCredentials server/repositories/UserCredentialsRepository.ts:[2m42:29[22m[39m
    [90m 40| [39m
    [90m 41| [39m    [35mtry[39m {
    [90m 42| [39m      [35mconst[39m [credentials] [33m=[39m [35mawait[39m database
    [90m   | [39m                            [31m^[39m
    [90m 43| [39m        [33m.[39m[34minsert[39m(userCredentials)
    [90m 44| [39m        [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m72:5[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m UserCredentialsRepository.createCredentials server/repositories/UserCredentialsRepository.ts:[2m42:29[22m[39m
[90m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m72:5[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 332, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(WMTiwN0HxIvxfmkA08YhL) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[210/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Lifecycle[2m > [22mshould support multiple active refresh tokens per user
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: UM8ySZXJsSInXol4Sl8q3,refresh-test-TiZoFjq21TUhzdvuhwV6Y@example.com,Refresh Test,Refresh,Test,1280d571-f40b-442b-b2e8-4d3f41603859,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(1280d571-f40b-442b-b2e8-4d3f41603859) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[211/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Lifecycle[2m > [22mshould revoke all user tokens on password reset
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: EQq8tcyxql3JvvijiO37g,refresh-test-o5lNvP6b0zvRDuzR3BkpR@example.com,Refresh Test,Refresh,Test,1280d571-f40b-442b-b2e8-4d3f41603859,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(1280d571-f40b-442b-b2e8-4d3f41603859) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[212/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Security[2m > [22mshould use cryptographically strong random tokens
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, default, default) returning "id", "user_id", "password_hash", "created_at", "updated_at"
params: 4onlmpC6i8uhdAYnoYtAa,$2b$12$dK8g7GimY97KqQRASPLil.x36etLipKt7kfCXsCi7Os0aUGRI5LQy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m UserCredentialsRepository.createCredentials server/repositories/UserCredentialsRepository.ts:[2m42:29[22m[39m
    [90m 40| [39m
    [90m 41| [39m    [35mtry[39m {
    [90m 42| [39m      [35mconst[39m [credentials] [33m=[39m [35mawait[39m database
    [90m   | [39m                            [31m^[39m
    [90m 43| [39m        [33m.[39m[34minsert[39m(userCredentials)
    [90m 44| [39m        [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m72:5[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m UserCredentialsRepository.createCredentials server/repositories/UserCredentialsRepository.ts:[2m42:29[22m[39m
[90m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m72:5[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 332, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(4onlmpC6i8uhdAYnoYtAa) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w15_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[213/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Security[2m > [22mshould hash refresh tokens before storing in database
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, default, default) returning "id", "user_id", "password_hash", "created_at", "updated_at"
params: PAyaNlKnM8Sd58BR3h6SN,$2b$12$qI9n9WV1iX4rb3eM0iQc2.wWOrL/m3Xnkbw9gCp2XxoPZYlrL/MJC[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m UserCredentialsRepository.createCredentials server/repositories/UserCredentialsRepository.ts:[2m42:29[22m[39m
    [90m 40| [39m
    [90m 41| [39m    [35mtry[39m {
    [90m 42| [39m      [35mconst[39m [credentials] [33m=[39m [35mawait[39m database
    [90m   | [39m                            [31m^[39m
    [90m 43| [39m        [33m.[39m[34minsert[39m(userCredentials)
    [90m 44| [39m        [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m72:5[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m UserCredentialsRepository.createCredentials server/repositories/UserCredentialsRepository.ts:[2m42:29[22m[39m
[90m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m72:5[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 331, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(PAyaNlKnM8Sd58BR3h6SN) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[214/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Security[2m > [22mshould prevent refresh token reuse after rotation
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: tYyoBraHoMkuFHZwMO52h,refresh-test-9tn44h4uUuD6hYAuASicX@example.com,Refresh Test,Refresh,Test,1280d571-f40b-442b-b2e8-4d3f41603859,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(1280d571-f40b-442b-b2e8-4d3f41603859) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[215/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Security[2m > [22mshould validate token ownership
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 4e5lcCVk5WwzDp6UAsW_x,refresh-test-TdbTrKf3tFBgueqJFlgPw@example.com,Refresh Test,Refresh,Test,1280d571-f40b-442b-b2e8-4d3f41603859,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(1280d571-f40b-442b-b2e8-4d3f41603859) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[216/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mCookie Security[2m > [22mshould set HttpOnly flag to prevent XSS
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: pstihSFJhpRQMaCzYCO5a,refresh-test-r3DCE9vyDPtUwdS4PxopZ@example.com,Refresh Test,Refresh,Test,1280d571-f40b-442b-b2e8-4d3f41603859,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(1280d571-f40b-442b-b2e8-4d3f41603859) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[217/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mCookie Security[2m > [22mshould set SameSite=Strict to prevent CSRF
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 6Q3mW7mc5CdnuvsBmmarY,refresh-test-A-iURE57ABBY_hgJTTs-E@example.com,Refresh Test,Refresh,Test,1280d571-f40b-442b-b2e8-4d3f41603859,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(1280d571-f40b-442b-b2e8-4d3f41603859) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w2_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[218/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mCookie Security[2m > [22mshould set proper cookie path
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: H62hhceowRJpX7jff8GRh,refresh-test-BRuo5sjT470-Ila_9mI4p@example.com,Refresh Test,Refresh,Test,1280d571-f40b-442b-b2e8-4d3f41603859,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(1280d571-f40b-442b-b2e8-4d3f41603859) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[219/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mCookie Security[2m > [22mshould set appropriate expiry (30 days)
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 8vjEShYrNctKH-DucCgWz,refresh-test-PHrHFd97d__8G62dFAnUJ@example.com,Refresh Test,Refresh,Test,1280d571-f40b-442b-b2e8-4d3f41603859,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(1280d571-f40b-442b-b2e8-4d3f41603859) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w2_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[220/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mTemplate Key Resolution (New Path)[2m > [22mshould resolve template by key from workflowTemplates mapping
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 280f1916-6f08-4e7c-9c09-7dfeceaead32,test-1768708787199@example.com,Test User,Test,User,687f38e4-0b38-46b0-875b-7f499989f74a,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(687f38e4-0b38-46b0-875b-7f499989f74a) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[221/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mTemplate Key Resolution (New Path)[2m > [22mshould throw error if template key not found
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: ad818911-6b7c-43e7-be5f-ca3be3ecf45f,Test Project,Test Project,Test project for integration tests,8e21551a-1f9c-4645-ac9c-4f35cefd5659,55020fd5-44fe-42cd-8a27-a0071b60046c,8e21551a-1f9c-4645-ac9c-4f35cefd5659,8e21551a-1f9c-4645-ac9c-4f35cefd5659[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(8e21551a-1f9c-4645-ac9c-4f35cefd5659) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[222/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mTemplate Key Resolution (New Path)[2m > [22mshould store output in runOutputs table
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: 9d17ffb5-5a84-4d1d-a962-2d455b123274,Test Project,Test Project,Test project for integration tests,10939f33-afeb-419a-9a63-bb4c34139f90,42c3a6fc-49ec-4fcd-89f0-7ec1e7481719,10939f33-afeb-419a-9a63-bb4c34139f90,10939f33-afeb-419a-9a63-bb4c34139f90[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(10939f33-afeb-419a-9a63-bb4c34139f90) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[223/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mLegacy Template ID Path (Backward Compatibility)[2m > [22mshould resolve template by templateId directly
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 8e4addad-2bbc-4c2f-a6cd-b90b4f14b16d,test-1768708788900@example.com,Test User,Test,User,3886b5ba-ab0a-4f56-9675-266df24b4f04,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(3886b5ba-ab0a-4f56-9675-266df24b4f04) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[224/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mLegacy Template ID Path (Backward Compatibility)[2m > [22mshould throw error if templateId not found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 229c7497-a7a3-483b-acc5-72031d6759cb,test-1768708789405@example.com,Test User,Test,User,5874dfd3-afac-4a48-b1f1-91481a376abd,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(5874dfd3-afac-4a48-b1f1-91481a376abd) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[225/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mRendering Engine Selection[2m > [22mshould use docxRenderer2 by default (v2 engine)
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 8d4cdc33-c178-4af6-92f0-6824c14e856e,test-1768708789906@example.com,Test User,Test,User,0378104e-9a95-48cf-925c-73ff5969c6a7,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(0378104e-9a95-48cf-925c-73ff5969c6a7) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[226/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mRendering Engine Selection[2m > [22mshould use legacy engine when engine="legacy"
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: ba0e94fb-5ab3-4b98-b5fb-4f33deb60376,Test Project,Test Project,Test project for integration tests,3683cfc5-1ffb-410b-8652-667b1ffc51e1,8a5e85ce-f70c-45df-a47c-065b2ef3373d,3683cfc5-1ffb-410b-8652-667b1ffc51e1,3683cfc5-1ffb-410b-8652-667b1ffc51e1[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(3683cfc5-1ffb-410b-8652-667b1ffc51e1) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[227/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mPDF Generation[2m > [22mshould generate PDF when toPdf=true
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: ca359554-fdb6-4b4a-969a-3f6950098a1f,Test Project,Test Project,Test project for integration tests,1667cb1f-4f9b-4ffd-9ee9-45e94edbfa85,0a74139c-116b-466d-bf11-3e15e447c0de,1667cb1f-4f9b-4ffd-9ee9-45e94edbfa85,1667cb1f-4f9b-4ffd-9ee9-45e94edbfa85[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(1667cb1f-4f9b-4ffd-9ee9-45e94edbfa85) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[228/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mPDF Generation[2m > [22mshould default to DOCX when toPdf=false
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 81139ff4-0c70-4ca5-8c37-ecf428c8a062,test-1768708791575@example.com,Test User,Test,User,ce6889c8-23d4-4b43-9070-c9b4cac29e60,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(ce6889c8-23d4-4b43-9070-c9b4cac29e60) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w19_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[229/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mConditional Execution[2m > [22mshould skip execution when condition evaluates to false
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: a804a9f6-48c1-49da-8627-c3d5f9d59591,test-1768708792128@example.com,Test User,Test,User,1a47214c-41c0-445c-9620-fa2dd8377ad6,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(1a47214c-41c0-445c-9620-fa2dd8377ad6) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[230/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mConditional Execution[2m > [22mshould execute when condition evaluates to true
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 6474c831-d032-44b4-bb3c-5fddb19f8661,test-1768708792697@example.com,Test User,Test,User,54f593ce-3b68-41bf-baa6-dc19568c3cdf,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(54f593ce-3b68-41bf-baa6-dc19568c3cdf) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[231/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mBinding Resolution[2m > [22mshould resolve simple bindings
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: df5a6fb7-f479-4406-abb4-56f015252b51,test-1768708793239@example.com,Test User,Test,User,65bfc888-7c1e-4f95-91a0-77636b2272fd,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(65bfc888-7c1e-4f95-91a0-77636b2272fd) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[232/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mBinding Resolution[2m > [22mshould handle binding resolution errors gracefully
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: d897f2ae-b454-4bb1-a701-de3ed636f63f,Test Project,Test Project,Test project for integration tests,1a35ac48-cc68-4052-b569-011adaa705d5,5e3efdac-2b1d-42a8-88f1-a4ecff38fa20,1a35ac48-cc68-4052-b569-011adaa705d5,1a35ac48-cc68-4052-b569-011adaa705d5[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(1a35ac48-cc68-4052-b569-011adaa705d5) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[233/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mError Handling[2m > [22mshould record failed output in runOutputs table
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: bd600e30-ffbb-47ba-9240-8b6f3702a300,test-1768708794876@example.com,Test User,Test,User,044049ff-8baa-4c28-b732-105328d9aab8,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(044049ff-8baa-4c28-b732-105328d9aab8) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[234/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mError Handling[2m > [22mshould not throw errors (should return error in result)
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 454ffd02-565a-40b4-a1d1-752bfa20dda1,test-1768708796927@example.com,Test User,Test,User,063ce71c-c89a-4e45-8a94-1734a74fba1f,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(063ce71c-c89a-4e45-8a94-1734a74fba1f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[235/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mTenant Access Control[2m > [22mshould deny access to templates from different tenant
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: e06f3565-216f-4332-8753-3a3998c5461e,test-1768708797435@example.com,Test User,Test,User,4bb6ccb5-e9a1-4535-9699-e87ed18a25b0,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(4bb6ccb5-e9a1-4535-9699-e87ed18a25b0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[236/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mValidation[2m > [22mshould require either templateKey or templateId
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 5443b31f-4651-4fe6-b7cc-309b59383580,test-1768708798495@example.com,Test User,Test,User,0f1c06ed-abae-4883-91dc-3f8d679c1c9b,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(0f1c06ed-abae-4883-91dc-3f8d679c1c9b) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[237/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mcreate[2m > [22mshould create a workflow template mapping
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, default, $5, default, default, default, default, default, default, $6, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,Test workflow,b8c22599-d665-4338-831e-41ae4a8d9045,b8c22599-d665-4338-831e-41ae4a8d9045,a9a6d872-6204-4875-b6f3-7296302473a4,draft[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m
    [90m 50| [39m
    [90m 51| [39m    [90m// Create test workflow[39m
    [90m 52| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m db
    [90m   | [39m                       [31m^[39m
    [90m 53| [39m      [33m.[39m[34minsert[39m(workflows)
    [90m 54| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(b8c22599-d665-4338-831e-41ae4a8d9045) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[238/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mcreate[2m > [22mshould create non-primary mapping by default
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, default, $5, default, default, default, default, default, default, $6, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,Test workflow,c26185bd-03e1-40d1-b330-7e8793c04f48,c26185bd-03e1-40d1-b330-7e8793c04f48,962808fc-5129-4fd3-9d0d-7cc1567bdb3e,draft[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m
    [90m 50| [39m
    [90m 51| [39m    [90m// Create test workflow[39m
    [90m 52| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m db
    [90m   | [39m                       [31m^[39m
    [90m 53| [39m      [33m.[39m[34minsert[39m(workflows)
    [90m 54| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(c26185bd-03e1-40d1-b330-7e8793c04f48) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[239/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionId[2m > [22mshould find all templates for a workflow version
[31m[1mError[22m: Failed query: insert into "workflow_versions" ("id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at") values (default, $1, default, $2, $3, $4, default, $5, default, default, $6, default, default, default, default) returning "id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at"
params: 01d04460-50f5-4c34-af05-5d346dc68393,1,true,{},"Initial version",177c9015-5b51-4baa-b365-4c80142bf895[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m66:23[22m[39m
    [90m 64| [39m
    [90m 65| [39m    [90m// Create test workflow version[39m
    [90m 66| [39m    [35mconst[39m [version] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 67| [39m      [33m.[39m[34minsert[39m(workflowVersions)
    [90m 68| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "workflow_versions" violates foreign key constraint "workflow_versions_workflow_id_workflows_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m66:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 375, severity: 'ERROR', code: '23503', detail: 'Key (workflow_id)=(01d04460-50f5-4c34-af05-5d346dc68393) is not present in table "workflows".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'workflow_versions', dataType: undefined, constraint: 'workflow_versions_workflow_id_workflows_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[240/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionId[2m > [22mshould return empty array for version with no templates
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,26c0eaf5-674b-4f20-9800-69fd98d632ca,26c0eaf5-674b-4f20-9800-69fd98d632ca,26c0eaf5-674b-4f20-9800-69fd98d632ca[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(26c0eaf5-674b-4f20-9800-69fd98d632ca) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[241/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionId[2m > [22mshould order by createdAt desc (newest first)
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,ce349d88-6cd8-4134-a193-34036e3fab5d,ce349d88-6cd8-4134-a193-34036e3fab5d,ce349d88-6cd8-4134-a193-34036e3fab5d[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(ce349d88-6cd8-4134-a193-34036e3fab5d) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[242/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionAndKey[2m > [22mshould find mapping by workflow version and key
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,4bc3f8f2-1f33-4caa-ab13-52c29f297abc,4bc3f8f2-1f33-4caa-ab13-52c29f297abc,4bc3f8f2-1f33-4caa-ab13-52c29f297abc[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(4bc3f8f2-1f33-4caa-ab13-52c29f297abc) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[243/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionAndKey[2m > [22mshould return undefined for non-existent key
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,5c757529-e5c3-421b-8b65-609732c6d7df,5c757529-e5c3-421b-8b65-609732c6d7df,5c757529-e5c3-421b-8b65-609732c6d7df[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(5c757529-e5c3-421b-8b65-609732c6d7df) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[244/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindPrimaryByWorkflowVersionId[2m > [22mshould find primary template for workflow version
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,95a3379a-57ed-4afc-920e-2ac314454581,95a3379a-57ed-4afc-920e-2ac314454581,95a3379a-57ed-4afc-920e-2ac314454581[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(95a3379a-57ed-4afc-920e-2ac314454581) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[245/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindPrimaryByWorkflowVersionId[2m > [22mshould return undefined when no primary template exists
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, default, $5, default, default, default, default, default, default, $6, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,Test workflow,2923e156-615a-4be6-a4aa-f051efbc6e73,2923e156-615a-4be6-a4aa-f051efbc6e73,ec25109e-24d9-4ee5-9449-24724048065a,draft[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m
    [90m 50| [39m
    [90m 51| [39m    [90m// Create test workflow[39m
    [90m 52| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m db
    [90m   | [39m                       [31m^[39m
    [90m 53| [39m      [33m.[39m[34minsert[39m(workflows)
    [90m 54| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 327, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(2923e156-615a-4be6-a4aa-f051efbc6e73) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[246/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22msetPrimary[2m > [22mshould set a template as primary and unset others
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, default, $5, default, default, default, default, default, default, $6, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,Test workflow,8a9c6c19-b593-4740-91fd-996077368d0e,8a9c6c19-b593-4740-91fd-996077368d0e,666b76d2-7e2c-4ac6-924d-a83adf502ed3,draft[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m
    [90m 50| [39m
    [90m 51| [39m    [90m// Create test workflow[39m
    [90m 52| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m db
    [90m   | [39m                       [31m^[39m
    [90m 53| [39m      [33m.[39m[34minsert[39m(workflows)
    [90m 54| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 327, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(8a9c6c19-b593-4740-91fd-996077368d0e) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[247/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22msetPrimary[2m > [22mshould handle setting primary when none existed before
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,e6c20bc8-eda9-440d-b3b8-f5bebf16f4b7,e6c20bc8-eda9-440d-b3b8-f5bebf16f4b7,e6c20bc8-eda9-440d-b3b8-f5bebf16f4b7[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(e6c20bc8-eda9-440d-b3b8-f5bebf16f4b7) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[248/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22msetPrimary[2m > [22mshould not delete mapping if workflow version does not match
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,5e0115c7-6268-4d31-9ec7-c0ac9b4cc634,5e0115c7-6268-4d31-9ec7-c0ac9b4cc634,5e0115c7-6268-4d31-9ec7-c0ac9b4cc634[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(5e0115c7-6268-4d31-9ec7-c0ac9b4cc634) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[249/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mexistsByKey[2m > [22mshould return true if key exists in workflow version
[31m[1mError[22m: Failed query: insert into "templates" ("id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, default, default, default, default, default, default, default) returning "id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at"
params: 2b5457c9-bba6-47f2-9ea1-1ce4f17e091a,Template 2,Second test template,/uploads/template2.docx,docx[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m92:25[22m[39m
    [90m 90| [39m    testTemplateId1 [33m=[39m template1[33m.[39mid[33m;[39m
    [90m 91| [39m
    [90m 92| [39m    [35mconst[39m [template2] [33m=[39m [35mawait[39m db
    [90m   | [39m                        [31m^[39m
    [90m 93| [39m      [33m.[39m[34minsert[39m(templates)
    [90m 94| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "templates" violates foreign key constraint "templates_project_id_projects_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m92:25[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 337, severity: 'ERROR', code: '23503', detail: 'Key (project_id)=(2b5457c9-bba6-47f2-9ea1-1ce4f17e091a) is not present in table "projects".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'templates', dataType: undefined, constraint: 'templates_project_id_projects_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[250/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mexistsByKey[2m > [22mshould return false if key does not exist
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, default, $5, default, default, default, default, default, default, $6, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,Test workflow,460b25b5-751e-478e-b11e-9376a92f46d0,460b25b5-751e-478e-b11e-9376a92f46d0,3c159fab-0a4e-4a08-bca6-f695d5adeb89,draft[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m
    [90m 50| [39m
    [90m 51| [39m    [90m// Create test workflow[39m
    [90m 52| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m db
    [90m   | [39m                       [31m^[39m
    [90m 53| [39m      [33m.[39m[34minsert[39m(workflows)
    [90m 54| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(460b25b5-751e-478e-b11e-9376a92f46d0) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[251/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mexistsByKey[2m > [22mshould exclude specified id when checking existence
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,640ecb6a-423a-47ab-91f4-18f881b2d9ee,640ecb6a-423a-47ab-91f4-18f881b2d9ee,640ecb6a-423a-47ab-91f4-18f881b2d9ee[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(640ecb6a-423a-47ab-91f4-18f881b2d9ee) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[252/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mexistsByKey[2m > [22mshould return true if key exists on different mapping
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,48e6694f-f309-4870-9808-5f8b14cafd3e,48e6694f-f309-4870-9808-5f8b14cafd3e,48e6694f-f309-4870-9808-5f8b14cafd3e[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(48e6694f-f309-4870-9808-5f8b14cafd3e) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w2_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[253/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mupdate[2m > [22mshould update mapping fields
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,335803ac-8497-41ff-8ee3-d1aaa102f232,335803ac-8497-41ff-8ee3-d1aaa102f232,335803ac-8497-41ff-8ee3-d1aaa102f232[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(335803ac-8497-41ff-8ee3-d1aaa102f232) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[254/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindById[2m > [22mshould find mapping by id
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, default, $5, default, default, default, default, default, default, $6, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,Test workflow,30d437db-bb23-4d70-99dc-6727c483b9f5,30d437db-bb23-4d70-99dc-6727c483b9f5,4fe8a153-55b5-44f1-8625-c74a1c1aa08f,draft[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m
    [90m 50| [39m
    [90m 51| [39m    [90m// Create test workflow[39m
    [90m 52| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m db
    [90m   | [39m                       [31m^[39m
    [90m 53| [39m      [33m.[39m[34minsert[39m(workflows)
    [90m 54| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 327, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(30d437db-bb23-4d70-99dc-6727c483b9f5) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[255/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindById[2m > [22mshould return undefined for non-existent id
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,4df1a2f7-8fe0-4237-aa5a-9bb3babf7451,4df1a2f7-8fe0-4237-aa5a-9bb3babf7451,4df1a2f7-8fe0-4237-aa5a-9bb3babf7451[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(4df1a2f7-8fe0-4237-aa5a-9bb3babf7451) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w2_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[256/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22mhybridAuth[2m > [22mshould authenticate with JWT Bearer token
[31m[1mAssertionError[22m: expected "vi.fn()" to be called at least once[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m238:24[22m[39m
    [90m236| [39m      await hybridAuth(mockReq as unknown as Request, mockRes as unknoâ€¦
    [90m237| [39m
    [90m238| [39m      [34mexpect[39m(mockNext)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m239| [39m      [35mconst[39m authReq [33m=[39m mockReq [35mas[39m unknown [35mas[39m [33mAuthRequest[39m[33m;[39m
    [90m240| [39m      [34mexpect[39m(authReq[33m.[39muserId)[33m.[39m[34mtoBe[39m(mockUser[33m.[39mid)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[257/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22mhybridAuth[2m > [22mshould authenticate with refresh token cookie for GET requests
[31m[1mAssertionError[22m: expected "vi.fn()" to be called with arguments: [ 'user-123' ][90m

Number of calls: [1m0[22m
[31m[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m256:39[22m[39m
    [90m254| [39m
    [90m255| [39m      expect(authService.validateRefreshToken).toHaveBeenCalledWith(reâ€¦
    [90m256| [39m      expect(userRepository.findById).toHaveBeenCalledWith(mockUser.idâ€¦
    [90m   | [39m                                      [31m^[39m
    [90m257| [39m      [34mexpect[39m(mockNext)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m258| [39m      [35mconst[39m authReq [33m=[39m mockReq [35mas[39m unknown [35mas[39m [33mAuthRequest[39m[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[258/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22mhybridAuth[2m > [22mshould reject cookie auth for POST requests
[31m[1mAssertionError[22m: expected "vi.fn()" to be called with arguments: [ 401 ][90m

Number of calls: [1m0[22m
[31m[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m272:26[22m[39m
    [90m270| [39m
    [90m271| [39m      [34mexpect[39m(mockNext)[33m.[39mnot[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m272| [39m      [34mexpect[39m(statusMock)[33m.[39m[34mtoHaveBeenCalledWith[39m([34m401[39m)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m273| [39m      expect(authService.validateRefreshToken).not.toHaveBeenCalled();â€¦
    [90m274| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[259/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22mhybridAuth[2m > [22mshould prioritize JWT over cookie when both present
[31m[1mAssertionError[22m: expected "vi.fn()" to be called at least once[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m296:24[22m[39m
    [90m294| [39m      await hybridAuth(mockReq as unknown as Request, mockRes as unknoâ€¦
    [90m295| [39m
    [90m296| [39m      [34mexpect[39m(mockNext)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m297| [39m      [35mconst[39m authReq [33m=[39m mockReq [35mas[39m unknown [35mas[39m [33mAuthRequest[39m[33m;[39m
    [90m298| [39m      [90m// Should use JWT (mockUser), not cookie (mockUser2)[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[260/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22mhybridAuth[2m > [22mshould allow cookie auth only for safe methods
[31m[1mAssertionError[22m: expected "vi.fn()" to be called at least once[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m324:22[22m[39m
    [90m322| [39m
    [90m323| [39m        await hybridAuth(req as unknown as Request, res as unknown as â€¦
    [90m324| [39m        [34mexpect[39m(next)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                     [31m^[39m
    [90m325| [39m        expect(authService.validateRefreshToken).toHaveBeenCalledWith(â€¦
    [90m326| [39m        expect(userRepository.findById).toHaveBeenCalledWith(mockUser.â€¦

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[261/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22mhybridAuth[2m > [22mshould return 401 when no auth provided
[31m[1mAssertionError[22m: expected "vi.fn()" to be called with arguments: [ 401 ][90m

Number of calls: [1m0[22m
[31m[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m364:26[22m[39m
    [90m362| [39m
    [90m363| [39m      [34mexpect[39m(mockNext)[33m.[39mnot[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m364| [39m      [34mexpect[39m(statusMock)[33m.[39m[34mtoHaveBeenCalledWith[39m([34m401[39m)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m365| [39m    })[33m;[39m
    [90m366| [39m  })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[262/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22moptionalHybridAuth[2m > [22mshould authenticate with JWT
[31m[1mAssertionError[22m: expected "vi.fn()" to be called at least once[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m381:24[22m[39m
    [90m379| [39m      await optionalHybridAuth(mockReq as unknown as Request, mockRes â€¦
    [90m380| [39m
    [90m381| [39m      [34mexpect[39m(mockNext)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m382| [39m      [35mconst[39m authReq [33m=[39m mockReq [35mas[39m unknown [35mas[39m [33mAuthRequest[39m[33m;[39m
    [90m383| [39m      [34mexpect[39m(authReq[33m.[39muserId)[33m.[39m[34mtoBe[39m(mockUser[33m.[39mid)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[263/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22moptionalHybridAuth[2m > [22mshould authenticate with cookie for GET
[31m[1mAssertionError[22m: expected "vi.fn()" to be called at least once[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m400:24[22m[39m
    [90m398| [39m      await optionalHybridAuth(mockReq as unknown as Request, mockRes â€¦
    [90m399| [39m
    [90m400| [39m      [34mexpect[39m(mockNext)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m401| [39m      [35mconst[39m authReq [33m=[39m mockReq [35mas[39m unknown [35mas[39m [33mAuthRequest[39m[33m;[39m
    [90m402| [39m      [34mexpect[39m(authReq[33m.[39muserId)[33m.[39m[34mtoBe[39m(mockUser[33m.[39mid)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[264/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22moptionalHybridAuth[2m > [22mshould proceed without auth when none provided
[31m[1mAssertionError[22m: expected "vi.fn()" to be called at least once[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m413:24[22m[39m
    [90m411| [39m      await optionalHybridAuth(mockReq as unknown as Request, mockRes â€¦
    [90m412| [39m
    [90m413| [39m      [34mexpect[39m(mockNext)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m414| [39m      [35mconst[39m authReq [33m=[39m mockReq [35mas[39m unknown [35mas[39m [33mAuthRequest[39m[33m;[39m
    [90m415| [39m      [34mexpect[39m(authReq[33m.[39muserId)[33m.[39m[34mtoBeUndefined[39m()[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[265/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22moptionalHybridAuth[2m > [22mshould proceed even with invalid auth
[31m[1mAssertionError[22m: expected "vi.fn()" to be called at least once[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m435:24[22m[39m
    [90m433| [39m      await optionalHybridAuth(mockReq as unknown as Request, mockRes â€¦
    [90m434| [39m
    [90m435| [39m      [34mexpect[39m(mockNext)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m436| [39m      [35mconst[39m authReq [33m=[39m mockReq [35mas[39m unknown [35mas[39m [33mAuthRequest[39m[33m;[39m
    [90m437| [39m      [34mexpect[39m(authReq[33m.[39muserId)[33m.[39m[34mtoBeUndefined[39m()[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[266/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22mSecurity Edge Cases[2m > [22mshould not allow cookie auth for mutations (CSRF protection)
[31m[1mAssertionError[22m: expected "vi.fn()" to be called with arguments: [ 401 ][90m

Number of calls: [1m0[22m
[31m[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m479:28[22m[39m
    [90m477| [39m
    [90m478| [39m        [34mexpect[39m(next)[33m.[39mnot[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m479| [39m        [34mexpect[39m(res[33m.[39mstatus)[33m.[39m[34mtoHaveBeenCalledWith[39m([34m401[39m)[33m;[39m
    [90m   | [39m                           [31m^[39m
    [90m480| [39m        expect(authService.validateRefreshToken).not.toHaveBeenCalled(â€¦
    [90m481| [39m        vi[33m.[39m[34mclearAllMocks[39m()[33m;[39m [90m// Clear mocks for next iteration[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[267/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mPassword Reset[2m > [22mgeneratePasswordResetToken()[2m > [22mshould generate password reset token for existing user
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.generatePasswordResetToken server/services/AuthService.ts:[2m508:9[22m[39m
    [90m506| [39m
    [90m507| [39m        [35mawait[39m [34msendPasswordResetEmail[39m(email[33m,[39m plainToken)[33m;[39m
    [90m508| [39m        log[33m.[39m[34minfo[39m({ email }[33m,[39m [32m'Password reset email sent'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m509| [39m
    [90m510| [39m        [35mreturn[39m plainToken[33m;[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m671:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[268/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mPassword Reset[2m > [22mgeneratePasswordResetToken()[2m > [22mshould invalidate previous reset tokens
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.generatePasswordResetToken server/services/AuthService.ts:[2m508:9[22m[39m
    [90m506| [39m
    [90m507| [39m        [35mawait[39m [34msendPasswordResetEmail[39m(email[33m,[39m plainToken)[33m;[39m
    [90m508| [39m        log[33m.[39m[34minfo[39m({ email }[33m,[39m [32m'Password reset email sent'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m509| [39m
    [90m510| [39m        [35mreturn[39m plainToken[33m;[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m695:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[269/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mRefresh Token Management[2m > [22mrotateRefreshToken()[2m > [22mshould rotate valid token and return new one
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.rotateRefreshToken server/services/AuthService.ts:[2m396:9[22m[39m
    [90m394| [39m        [90m// DEBUG LOG[39m
    [90m395| [39m        [90m// logger is available as 'log' from imports[39m
    [90m396| [39m        log.info({ tokenHash, plainTokenLen: plainToken.length }, 'DEBâ€¦
    [90m   | [39m        [31m^[39m
    [90m397| [39m
    [90m398| [39m        [90m// Find token purely by hash to detect state[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m901:42[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[270/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mRefresh Token Management[2m > [22mrotateRefreshToken()[2m > [22mshould return null for unknown token
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.rotateRefreshToken server/services/AuthService.ts:[2m396:9[22m[39m
    [90m394| [39m        [90m// DEBUG LOG[39m
    [90m395| [39m        [90m// logger is available as 'log' from imports[39m
    [90m396| [39m        log.info({ tokenHash, plainTokenLen: plainToken.length }, 'DEBâ€¦
    [90m   | [39m        [31m^[39m
    [90m397| [39m
    [90m398| [39m        [90m// Find token purely by hash to detect state[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m914:42[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[271/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mRefresh Token Management[2m > [22mrotateRefreshToken()[2m > [22mshould revoke all tokens on reuse detection
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.rotateRefreshToken server/services/AuthService.ts:[2m396:9[22m[39m
    [90m394| [39m        [90m// DEBUG LOG[39m
    [90m395| [39m        [90m// logger is available as 'log' from imports[39m
    [90m396| [39m        log.info({ tokenHash, plainTokenLen: plainToken.length }, 'DEBâ€¦
    [90m   | [39m        [31m^[39m
    [90m397| [39m
    [90m398| [39m        [90m// Find token purely by hash to detect state[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m933:42[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[272/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mRefresh Token Management[2m > [22mrotateRefreshToken()[2m > [22mshould return null for expired token
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.rotateRefreshToken server/services/AuthService.ts:[2m396:9[22m[39m
    [90m394| [39m        [90m// DEBUG LOG[39m
    [90m395| [39m        [90m// logger is available as 'log' from imports[39m
    [90m396| [39m        log.info({ tokenHash, plainTokenLen: plainToken.length }, 'DEBâ€¦
    [90m   | [39m        [31m^[39m
    [90m397| [39m
    [90m398| [39m        [90m// Find token purely by hash to detect state[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m950:42[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[273/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mToken Cleanup[2m > [22mcleanupExpiredTokens()[2m > [22mshould cleanup expired refresh tokens
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.cleanupExpiredTokens server/services/AuthService.ts:[2m593:9[22m[39m
    [90m591| [39m        [35mawait[39m accountLockoutService[33m.[39m[34mcleanupOldAttempts[39m()[33m;[39m
    [90m592| [39m
    [90m593| [39m        log[33m.[39m[34minfo[39m([32m'Cleaned up expired tokens and old login attempts'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m594| [39m    }
    [90m595| [39m}
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m977:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[274/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mToken Cleanup[2m > [22mcleanupExpiredTokens()[2m > [22mshould cleanup expired password reset tokens
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.cleanupExpiredTokens server/services/AuthService.ts:[2m593:9[22m[39m
    [90m591| [39m        [35mawait[39m accountLockoutService[33m.[39m[34mcleanupOldAttempts[39m()[33m;[39m
    [90m592| [39m
    [90m593| [39m        log[33m.[39m[34minfo[39m([32m'Cleaned up expired tokens and old login attempts'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m594| [39m    }
    [90m595| [39m}
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m982:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[275/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mToken Cleanup[2m > [22mcleanupExpiredTokens()[2m > [22mshould cleanup expired email verification tokens
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.cleanupExpiredTokens server/services/AuthService.ts:[2m593:9[22m[39m
    [90m591| [39m        [35mawait[39m accountLockoutService[33m.[39m[34mcleanupOldAttempts[39m()[33m;[39m
    [90m592| [39m
    [90m593| [39m        log[33m.[39m[34minfo[39m([32m'Cleaned up expired tokens and old login attempts'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m594| [39m    }
    [90m595| [39m}
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m987:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[276/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mToken Cleanup[2m > [22mcleanupExpiredTokens()[2m > [22mshould cleanup old login attempts via accountLockoutService
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.cleanupExpiredTokens server/services/AuthService.ts:[2m593:9[22m[39m
    [90m591| [39m        [35mawait[39m accountLockoutService[33m.[39m[34mcleanupOldAttempts[39m()[33m;[39m
    [90m592| [39m
    [90m593| [39m        log[33m.[39m[34minfo[39m([32m'Cleaned up expired tokens and old login attempts'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m594| [39m    }
    [90m595| [39m}
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m993:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[277/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mIntegration Scenarios[2m > [22mComplete Authentication Flow[2m > [22mshould support full user authentication lifecycle
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.rotateRefreshToken server/services/AuthService.ts:[2m396:9[22m[39m
    [90m394| [39m        [90m// DEBUG LOG[39m
    [90m395| [39m        [90m// logger is available as 'log' from imports[39m
    [90m396| [39m        log.info({ tokenHash, plainTokenLen: plainToken.length }, 'DEBâ€¦
    [90m   | [39m        [31m^[39m
    [90m397| [39m
    [90m398| [39m        [90m// Find token purely by hash to detect state[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m1239:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[278/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mIntegration Scenarios[2m > [22mPassword Reset Flow[2m > [22mshould support complete password reset workflow
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.generatePasswordResetToken server/services/AuthService.ts:[2m508:9[22m[39m
    [90m506| [39m
    [90m507| [39m        [35mawait[39m [34msendPasswordResetEmail[39m(email[33m,[39m plainToken)[33m;[39m
    [90m508| [39m        log[33m.[39m[34minfo[39m({ email }[33m,[39m [32m'Password reset email sent'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m509| [39m
    [90m510| [39m        [35mreturn[39m plainToken[33m;[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m1259:28[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[279/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mIntegration Scenarios[2m > [22mPassword Reset Flow[2m > [22mshould prevent reuse of password reset tokens
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.generatePasswordResetToken server/services/AuthService.ts:[2m508:9[22m[39m
    [90m506| [39m
    [90m507| [39m        [35mawait[39m [34msendPasswordResetEmail[39m(email[33m,[39m plainToken)[33m;[39m
    [90m508| [39m        log[33m.[39m[34minfo[39m({ email }[33m,[39m [32m'Password reset email sent'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m509| [39m
    [90m510| [39m        [35mreturn[39m plainToken[33m;[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m1296:28[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[280/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22menqueue[2m > [22mshould enqueue a PDF conversion job
[31m[1mError[22m: Failed query: insert into "workflow_versions" ("id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at") values (default, $1, default, $2, $3, $4, default, $5, default, default, $6, default, default, default, default) returning "id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at"
params: 336d08a3-a69a-4c4c-aac6-f1411c01767b,1,true,{},"Initial version",9ac07a7b-aaaf-4a57-9d33-a6bd424f85d3[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m124:23[22m[39m
    [90m122| [39m
    [90m123| [39m    [90m// Create test workflow version[39m
    [90m124| [39m    [35mconst[39m [version] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m125| [39m      [33m.[39m[34minsert[39m(workflowVersions)
    [90m126| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "workflow_versions" violates foreign key constraint "workflow_versions_workflow_id_workflows_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m124:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 374, severity: 'ERROR', code: '23503', detail: 'Key (workflow_id)=(336d08a3-a69a-4c4c-aac6-f1411c01767b) is not present in table "workflows".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'workflow_versions', dataType: undefined, constraint: 'workflow_versions_workflow_id_workflows_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[281/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22menqueue[2m > [22mshould create output with empty storagePath initially
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,b0dc3b41-4822-4da9-8271-844e184e510f,320c3fb5-6a57-4e05-9b3b-4439cefa6aee,b0dc3b41-4822-4da9-8271-844e184e510f,b0dc3b41-4822-4da9-8271-844e184e510f[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(b0dc3b41-4822-4da9-8271-844e184e510f) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[282/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mgetJobStatus[2m > [22mshould return job status for pending job
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,bdfadaf6-d13c-407f-9571-1683c78a8a32,021dcd10-11fc-4e13-a465-411571b11452,bdfadaf6-d13c-407f-9571-1683c78a8a32,bdfadaf6-d13c-407f-9571-1683c78a8a32[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(bdfadaf6-d13c-407f-9571-1683c78a8a32) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[283/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mgetJobStatus[2m > [22mshould return null for non-existent job
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,9b6096e3-58c4-4e36-a014-6762c737fb6a,a291c123-145c-47f2-8c03-5623eb4eebbc,9b6096e3-58c4-4e36-a014-6762c737fb6a,9b6096e3-58c4-4e36-a014-6762c737fb6a[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(9b6096e3-58c4-4e36-a014-6762c737fb6a) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[284/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mgetJobStatus[2m > [22mshould parse attempt count from error field
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,3aea3a77-b8a9-439a-895b-f7be77bdc579,1a1513f7-e2e6-4ce9-b1ff-00fb87c95cc4,3aea3a77-b8a9-439a-895b-f7be77bdc579,3aea3a77-b8a9-439a-895b-f7be77bdc579[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(3aea3a77-b8a9-439a-895b-f7be77bdc579) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[285/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mconvertImmediate[2m > [22mshould convert DOCX to PDF immediately
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,fde5e5e1-883f-494f-a0e5-11854ca6f566,18c46481-ccbf-4499-b2e9-ac4a10242bd3,fde5e5e1-883f-494f-a0e5-11854ca6f566,fde5e5e1-883f-494f-a0e5-11854ca6f566[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(fde5e5e1-883f-494f-a0e5-11854ca6f566) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[286/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mconvertImmediate[2m > [22mshould handle conversion errors gracefully
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,6700639c-1cd4-4086-a2cc-7a7327b05c25,617e9103-4f92-4b0e-b49d-d54a9a9e714a,6700639c-1cd4-4086-a2cc-7a7327b05c25,6700639c-1cd4-4086-a2cc-7a7327b05c25[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(6700639c-1cd4-4086-a2cc-7a7327b05c25) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w19_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[287/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mService Lifecycle[2m > [22mshould start and stop service
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,a0e77b77-0251-4af5-a9eb-62c4cd7d55c6,05040d1e-b954-48fc-8f8d-9bd7c5d31b20,a0e77b77-0251-4af5-a9eb-62c4cd7d55c6,a0e77b77-0251-4af5-a9eb-62c4cd7d55c6[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 326, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(05040d1e-b954-48fc-8f8d-9bd7c5d31b20) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'projects', dataType: undefined, constraint: 'projects_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[288/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mService Lifecycle[2m > [22mshould not start if already running
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,31fa7340-6387-46a8-97eb-b28361914a02,0701f39f-af57-4435-b1c5-200b72b8a5cd,31fa7340-6387-46a8-97eb-b28361914a02,31fa7340-6387-46a8-97eb-b28361914a02[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(31fa7340-6387-46a8-97eb-b28361914a02) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[289/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mService Lifecycle[2m > [22mshould handle stop when not running
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,8f67eb06-5961-4ed1-9525-75ea4e180a57,7cdf9005-88bb-4474-a057-f7dbc07fda23,8f67eb06-5961-4ed1-9525-75ea4e180a57,8f67eb06-5961-4ed1-9525-75ea4e180a57[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(8f67eb06-5961-4ed1-9525-75ea4e180a57) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[290/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mQueue Processing[2m > [22mshould process pending jobs when queue is processed
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,278950be-2808-409a-83d3-e0c5e1bd0962,13888ec6-945f-47d6-a327-f7668793cf82,278950be-2808-409a-83d3-e0c5e1bd0962,278950be-2808-409a-83d3-e0c5e1bd0962[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(278950be-2808-409a-83d3-e0c5e1bd0962) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w15_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[291/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mQueue Processing[2m > [22mshould process multiple jobs in batch
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,c0934927-ba51-4e53-a0bc-0455cecd0756,5287f71a-a081-40e4-a1ca-7d41efb5fd0d,c0934927-ba51-4e53-a0bc-0455cecd0756,c0934927-ba51-4e53-a0bc-0455cecd0756[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(c0934927-ba51-4e53-a0bc-0455cecd0756) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[292/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mError Handling[2m > [22mshould handle missing DOCX output gracefully
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,7e97969e-7db6-45ab-ba54-ac6cb59280b6,a7b6f31d-1dff-497c-8672-de6fcb3a85c2,7e97969e-7db6-45ab-ba54-ac6cb59280b6,7e97969e-7db6-45ab-ba54-ac6cb59280b6[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(7e97969e-7db6-45ab-ba54-ac6cb59280b6) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w15_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[293/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mTransaction Support[2m > [22mshould support enqueue within transaction
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,b85bbd68-53ed-4c6c-bd49-4b43749d8102,59e7a937-af56-4c70-b7bd-91654367cc32,b85bbd68-53ed-4c6c-bd49-4b43749d8102,b85bbd68-53ed-4c6c-bd49-4b43749d8102[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(b85bbd68-53ed-4c6c-bd49-4b43749d8102) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[294/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mTransaction Support[2m > [22mshould support convertImmediate within transaction
[31m[1mError[22m: Failed query: insert into "workflow_versions" ("id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at") values (default, $1, default, $2, $3, $4, default, $5, default, default, $6, default, default, default, default) returning "id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at"
params: 30b79da8-63c4-41b1-91af-849c840dbdaa,1,true,{},"Initial version",f83c406e-dfe4-4a66-9535-cc1ce4231e38[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m124:23[22m[39m
    [90m122| [39m
    [90m123| [39m    [90m// Create test workflow version[39m
    [90m124| [39m    [35mconst[39m [version] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m125| [39m      [33m.[39m[34minsert[39m(workflowVersions)
    [90m126| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "workflow_versions" violates foreign key constraint "workflow_versions_workflow_id_workflows_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m124:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 374, severity: 'ERROR', code: '23503', detail: 'Key (workflow_id)=(30b79da8-63c4-41b1-91af-849c840dbdaa) is not present in table "workflows".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'workflow_versions', dataType: undefined, constraint: 'workflow_versions_workflow_id_workflows_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[295/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mshould throw error if template belongs to different project
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 7371471e-7c13-4cd9-b489-a4b011b5e699,test-1768708786763@example.com,Test User,Test,User,1ce7942b-67d8-4e4c-90c2-be8e24515de3,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(1ce7942b-67d8-4e4c-90c2-be8e24515de3) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[296/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mshould automatically unset other primaries when setting new primary
[31m[1mError[22m: Failed query: insert into "workflow_versions" ("id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at") values ($1, $2, default, $3, default, $4, default, default, default, default, $5, default, default, default, default) returning "id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at"
params: 71136c1c-b1bd-4845-bc8c-9cc87229f8f6,d259caaf-7b08-41c9-98cd-400bf043afcb,1,{},259c5034-7944-4237-932f-1059323ea61f[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m166:23[22m[39m
    [90m164| [39m      [33m.[39m[34mreturning[39m()[33m;[39m
    [90m165| [39m
    [90m166| [39m    [35mconst[39m [version] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m167| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mworkflowVersions)
    [90m168| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m53:35[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "workflow_versions" violates foreign key constraint "workflow_versions_workflow_id_workflows_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m166:23[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m53:35[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 374, severity: 'ERROR', code: '23503', detail: 'Key (workflow_id)=(d259caaf-7b08-41c9-98cd-400bf043afcb) is not present in table "workflows".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'workflow_versions', dataType: undefined, constraint: 'workflow_versions_workflow_id_workflows_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[297/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mlistTemplates[2m > [22mshould list all templates for workflow version
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 9e4a55dc-f79e-42c7-88f7-70c4646f31b3,test-1768708787982@example.com,Test User,Test,User,4127dd36-2a2d-4448-be7f-38d403e05872,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(4127dd36-2a2d-4448-be7f-38d403e05872) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[298/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mlistTemplates[2m > [22mshould return empty array for version with no templates
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 8d263811-477b-4645-979f-cb3826ee50a5,test-1768708788497@example.com,Test User,Test,User,6251f185-b415-4436-9e51-bf7ed64a2d7f,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(6251f185-b415-4436-9e51-bf7ed64a2d7f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[299/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetTemplateMapping[2m > [22mshould get template mapping by id and version
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: b58f6ac4-cd03-4de1-9a8e-e66b113acbf4,test-1768708789048@example.com,Test User,Test,User,079d9cec-5359-4894-9fbd-9ea7b58a430d,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(079d9cec-5359-4894-9fbd-9ea7b58a430d) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[300/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetTemplateMapping[2m > [22mshould throw error if mapping not found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 22627a35-235e-45ad-ac76-a79271f88aa6,test-1768708789545@example.com,Test User,Test,User,43bdc00d-770b-4244-9e01-bc7dd5f6e3eb,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(43bdc00d-770b-4244-9e01-bc7dd5f6e3eb) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[301/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetTemplateByKey[2m > [22mshould get template by key
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: df3cfec2-663b-4cfc-b46f-fd206bc8a992,test-1768708790059@example.com,Test User,Test,User,c3275f3f-2764-49b4-965b-8bd9ed51fb63,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(c3275f3f-2764-49b4-965b-8bd9ed51fb63) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[302/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetTemplateByKey[2m > [22mshould throw error if key not found
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, $3, $4, $5, default, $6, $7, $8, default, default, default, default, default, default, $9, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: 9653380a-d1c4-4069-a0dc-c14b39c9c356,Test Workflow,Test workflow,86f8f8d9-4144-4a39-8605-343e01eb6e89,86f8f8d9-4144-4a39-8605-343e01eb6e89,test-workflow-19d86677-3304-4a64-aa44-28920706b215,Test Workflow,af4b3817-9eec-4885-9953-c33b1add85ac,draft[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m151:24[22m[39m
    [90m149| [39m    }
    [90m150| [39m  )[33m:[39m [33mPromise[39m[33m<[39m[33mTestWorkflow[39m[33m>[39m {
    [90m151| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                       [31m^[39m
    [90m152| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mworkflows)
    [90m153| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m53:35[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m151:24[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m53:35[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 327, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(86f8f8d9-4144-4a39-8605-343e01eb6e89) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[303/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetPrimaryTemplate[2m > [22mshould get primary template for workflow version
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 9338f593-8165-4c73-ba05-8c8c7620b32b,test-1768708791221@example.com,Test User,Test,User,dcd94cf1-a1b7-454b-a4be-58545c71700a,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(dcd94cf1-a1b7-454b-a4be-58545c71700a) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[304/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetPrimaryTemplate[2m > [22mshould return null when no primary template exists
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: 6c85ee6e-b5fe-4eb8-9bde-887b6c343e6a,Test Project,Test Project,Test project for integration tests,0126b802-23e1-43b6-bf84-786a347360fb,a20712b0-efba-477a-8889-e6dfac3229c5,0126b802-23e1-43b6-bf84-786a347360fb,0126b802-23e1-43b6-bf84-786a347360fb[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(0126b802-23e1-43b6-bf84-786a347360fb) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[305/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould update mapping key
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 0ded198e-364b-46fe-81ce-3150c0d0f8fe,test-1768708792335@example.com,Test User,Test,User,7537c81d-ebe2-4735-b21d-4cd9668a399b,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(7537c81d-ebe2-4735-b21d-4cd9668a399b) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[306/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould update isPrimary flag
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 00d41f3f-edec-4056-944e-fea00de2bd1a,test-1768708792843@example.com,Test User,Test,User,99897c2f-9582-4061-8120-ded39fe3f6bb,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(99897c2f-9582-4061-8120-ded39fe3f6bb) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[307/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould throw error if new key already exists
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 80b59bde-5e25-4302-866f-20ba5577da67,test-1768708793371@example.com,Test User,Test,User,232e6d37-453a-4561-87b9-22b4b5670098,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(232e6d37-453a-4561-87b9-22b4b5670098) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[308/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould throw error if mapping not found
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, $3, $4, $5, default, $6, $7, $8, default, default, default, default, default, default, $9, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: 7207115f-0b34-46ab-b15e-1e9bfb99f8e8,Test Workflow,Test workflow,6c539dae-46b2-4002-a0e1-dfca6b593e81,6c539dae-46b2-4002-a0e1-dfca6b593e81,test-workflow-8ce10741-bc0f-455c-8695-58d5bce49b38,Test Workflow,69934813-6989-4075-a5fe-dd65fc28b2b1,draft[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m151:24[22m[39m
    [90m149| [39m    }
    [90m150| [39m  )[33m:[39m [33mPromise[39m[33m<[39m[33mTestWorkflow[39m[33m>[39m {
    [90m151| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                       [31m^[39m
    [90m152| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mworkflows)
    [90m153| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m53:35[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createWorkflow tests/helpers/testFactory.ts:[2m151:24[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m53:35[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 327, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(6c539dae-46b2-4002-a0e1-dfca6b593e81) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[309/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould unset other primaries when setting isPrimary to true
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: 84043f8e-cc8d-4b10-86f5-aa415faa4142,Test Project,Test Project,Test project for integration tests,a08a1b06-7ca9-4abd-aa7b-555f61682540,01179826-49d0-4e6e-b157-139259bafd06,a08a1b06-7ca9-4abd-aa7b-555f61682540,a08a1b06-7ca9-4abd-aa7b-555f61682540[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(a08a1b06-7ca9-4abd-aa7b-555f61682540) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[310/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mdetachTemplate[2m > [22mshould detach template from workflow version
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: a8751d0f-b8e8-4bfb-b607-56819c286986,test-1768708795572@example.com,Test User,Test,User,c840f9e0-890b-4d12-b8f6-519db2970836,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(c840f9e0-890b-4d12-b8f6-519db2970836) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w3_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[311/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mdetachTemplate[2m > [22mshould throw error if mapping not found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 8998118b-f7e5-446a-8d40-b8ba1ed65a0a,test-1768708796086@example.com,Test User,Test,User,e3074413-d88d-4dd8-8f2d-44828cfdcf42,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(e3074413-d88d-4dd8-8f2d-44828cfdcf42) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w2_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[312/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22msetPrimaryTemplate[2m > [22mshould set template as primary
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 9bef2b3c-ef2d-4cf0-9e24-507284261936,test-1768708796592@example.com,Test User,Test,User,92c685e7-3617-4497-9e28-049940733373,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(92c685e7-3617-4497-9e28-049940733373) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[313/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22msetPrimaryTemplate[2m > [22mshould throw error if mapping not found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: e024df1f-c16b-4e58-a943-64e419b9e73b,test-1768708797116@example.com,Test User,Test,User,3f2a4fa7-6223-4ec8-9bda-b7ba7df5ec62,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(3f2a4fa7-6223-4ec8-9bda-b7ba7df5ec62) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[314/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mtransaction support[2m > [22mshould support operations within a transaction
[31m[1mError[22m: Failed query: insert into "templates" ("id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, default, default, default, default, $7, default, default) returning "id", "project_id", "name", "description", "file_ref", "type", "helpers_version", "metadata", "mapping", "current_version", "last_modified_by", "created_at", "updated_at"
params: 1c0951f6-e52f-4802-b7b0-5133c6790957,470abe23-d346-43ff-805e-d296a4e33cbc,Template 1,First test template,/uploads/template1.docx,docx,71caa1c6-f305-4883-af34-d6ebc724a992[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTemplate tests/helpers/testFactory.ts:[2m235:24[22m[39m
    [90m233| [39m    overrides[33m?[39m[33m:[39m [33mPartial[39m[33m<[39m[35mtypeof[39m schema[33m.[39mtemplates[33m.[39m$inferInsert[33m>[39m
    [90m234| [39m  )[33m:[39m [33mPromise[39m[33m<[39m[33mTestTemplate[39m[33m>[39m {
    [90m235| [39m    [35mconst[39m [template] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                       [31m^[39m
    [90m236| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mtemplates)
    [90m237| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m66:37[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "templates" violates foreign key constraint "templates_project_id_projects_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTemplate tests/helpers/testFactory.ts:[2m235:24[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m66:37[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 336, severity: 'ERROR', code: '23503', detail: 'Key (project_id)=(470abe23-d346-43ff-805e-d296a4e33cbc) is not present in table "projects".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'templates', dataType: undefined, constraint: 'templates_project_id_projects_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[315/354]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mtransaction support[2m > [22mshould rollback on transaction error
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 4ad20cdd-2948-46a9-bd98-fa32fc9dfd2f,test-1768708798708@example.com,Test User,Test,User,8d29184c-bf58-48c3-8b93-de5553a93b74,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(8d29184c-bf58-48c3-8b93-de5553a93b74) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[316/354]âŽ¯[22m[39m


[2m Test Files [22m [1m[31m49 failed[39m[22m[2m | [22m[1m[32m107 passed[39m[22m[2m | [22m[33m1 skipped[39m[90m (157)[39m
[2m      Tests [22m [1m[31m321 failed[39m[22m[2m | [22m[1m[32m2012 passed[39m[22m[2m | [22m[33m307 skipped[39m[90m (2640)[39m
[2m   Start at [22m 21:59:40
[2m   Duration [22m 92.29s[2m (transform 29.47s, setup 20.43s, import 326.66s, tests 784.21s, environment 28.55s)[22m

