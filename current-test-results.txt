npm warn Unknown project config "puppeteer_skip_download". This will stop working in the next major version of npm.

> ezbuildr@1.0.0 test
> cross-env VITEST_INTEGRATION=true vitest run --coverage


[1m[46m RUN [49m[22m [36mv4.0.16 [39m[90mC:/Users/scoot/poll/VaultLogic[39m
      [2mCoverage enabled with [22m[33mv8[39m

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w10
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w10 (Reused: true)

{"level":30,"time":1768335766066,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335766161,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould create placeholder user for non-existent email
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:52:21 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335767844,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768335767842,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768335767853,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768335767857,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768335767859,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768335767859,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768335767887,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768335767889,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768335767892,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768335767902,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768335767923,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768335767942,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768335767942,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768335767962,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768335768098,"env":"test","module":"email-queue","jobId":"ebb9e6d3-02f3-4e32-ae11-704b3b312220","to":"newuser_1768335765585@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould create placeholder user for non-existent email
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:548:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:80:28
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w12
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w13
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w5
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w9
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w7
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w12 (Reused: true)

{"level":30,"time":1768335768392,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w13 (Reused: true)

{"level":30,"time":1768335768405,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w5 (Reused: true)

{"level":30,"time":1768335768411,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w9 (Reused: true)

{"level":30,"time":1768335768417,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w7 (Reused: true)

{"level":30,"time":1768335768418,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335768437,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335768455,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335768463,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768335768465,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335768480,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould complete full MFA setup flow
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335769434,"env":"test","module":"user-credentials-repository","userId":"b020cc43-1238-47ed-8ad2-193994f9647d","msg":"User credentials created"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335769460,"env":"test","module":"user-credentials-repository","userId":"100a9141-b246-442a-83b6-edc0f5b00063","msg":"User credentials created"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould create invite for existing user without creating placeholder
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:52:21 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for fa4bdb23d2b1096345c798e3a0098036

{"level":30,"time":1768335769537,"env":"test","module":"email-queue","jobId":"750b2582-28a0-4b69-b2ed-b12c21d84fb7","to":"test-1768335768968-49t6r@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335769569,"env":"test","module":"email-queue","jobId":"aadc7360-a2a5-4528-89d6-4e3291be7b66","to":"test-1768335769017-d1w5a@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335769595,"env":"test","module":"auth-routes","userId":"b020cc43-1238-47ed-8ad2-193994f9647d","email":"test-1768335768968-49t6r@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mComplete Registration â†’ Login Flow[2m > [22m[2mshould complete registration, verify email, then login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335769630,"env":"test","module":"auth-routes","userId":"100a9141-b246-442a-83b6-edc0f5b00063","email":"test-1768335769017-d1w5a@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335769923,"env":"test","module":"auth-routes","userId":"2f64b8225354c36ea411629a8e961937","msg":"User logged in successfully"}
{"level":30,"time":1768335769941,"env":"test","module":"auth-routes","userId":"05eaa055c0d9121c79531204ed434a12","msg":"User logged in successfully"}
{"level":30,"time":1768335769976,"env":"test","module":"audit-log-service","userId":"2f64b8225354c36ea411629a8e961937","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335769989,"env":"test","module":"audit-log-service","userId":"05eaa055c0d9121c79531204ed434a12","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335769996,"env":"test","module":"email-queue","jobId":"ba4cfa37-79ea-42c6-a84f-ad3595e0eeae","to":"existing_1768335765585@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
{"level":40,"time":1768335769997,"env":"test","module":"auth-routes","userId":"b020cc43-1238-47ed-8ad2-193994f9647d","email":"test-1768335768968-49t6r@example.com","msg":"Login blocked: email not verified"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mComplete Registration â†’ Login Flow[2m > [22m[2mshould complete registration, verify email, then login
[22m[39mLogin Failed DEBUG: EmailNotVerifiedError: Please verify your email before logging in. Check your inbox for the verification link.
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:86:11)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: [32m'AUTH_006'[39m,
  statusCode: [33m403[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768335769997,"env":"test","module":"auth-routes","error":{"name":"EmailNotVerifiedError","code":"AUTH_006","statusCode":403,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mComplete Registration â†’ Login Flow[2m > [22m[2mshould complete registration, verify email, then login
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould create invite for existing user without creating placeholder
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:548:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:99:28
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/register[2m > [22m[2mshould register a new user successfully
[22m[39mError deleting test user 100a9141-b246-442a-83b6-edc0f5b00063: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth.routes.real.test.ts:54:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335770340,"env":"test","module":"auth-routes","userId":"fa4bdb23d2b1096345c798e3a0098036","msg":"Login requires MFA verification"}
{"level":30,"time":1768335770452,"env":"test","module":"mfa-service","userId":"fa4bdb23d2b1096345c798e3a0098036","msg":"TOTP verification successful"}
{"level":30,"time":1768335770507,"env":"test","module":"auth-routes","userId":"fa4bdb23d2b1096345c798e3a0098036","msg":"MFA login successful"}
{"level":30,"time":1768335770529,"env":"test","module":"auth-routes","userId":"05eaa055c0d9121c79531204ed434a12","msg":"User logged in successfully"}
{"level":30,"time":1768335770575,"env":"test","module":"audit-log-service","userId":"05eaa055c0d9121c79531204ed434a12","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335770582,"env":"test","module":"auth-routes","userId":"b020cc43-1238-47ed-8ad2-193994f9647d","msg":"User logged in successfully"}
{"level":30,"time":1768335770597,"env":"test","module":"mfa-service","userId":"2f64b8225354c36ea411629a8e961937","count":10,"msg":"Stored backup codes"}
{"level":30,"time":1768335770597,"env":"test","module":"mfa-service","userId":"2f64b8225354c36ea411629a8e961937","msg":"Generated TOTP secret"}
{"level":30,"time":1768335770597,"env":"test","module":"auth-routes","userId":"2f64b8225354c36ea411629a8e961937","msg":"MFA setup initiated"}
{"level":30,"time":1768335770630,"env":"test","module":"audit-log-service","userId":"b020cc43-1238-47ed-8ad2-193994f9647d","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335770668,"env":"test","module":"auth-routes","userId":"fa4bdb23d2b1096345c798e3a0098036","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768335770892,"env":"test","module":"mfa-service","userId":"2f64b8225354c36ea411629a8e961937","msg":"MFA enabled successfully"}
{"level":30,"time":1768335770893,"env":"test","module":"auth-routes","userId":"2f64b8225354c36ea411629a8e961937","msg":"MFA enabled successfully"}
{"level":30,"time":1768335770940,"env":"test","module":"audit-log-service","userId":"2f64b8225354c36ea411629a8e961937","eventType":"mfa_enabled","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335770961,"env":"test","module":"user-credentials-repository","userId":"87b7ea84-2947-4593-aae8-018e7447e70b","msg":"User credentials created"}
{"level":30,"time":1768335771055,"env":"test","module":"email-queue","jobId":"753bfe8e-399f-40cf-841d-1fc835b00d39","to":"test-1768335770241-xyd0p@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335771092,"env":"test","module":"auth-routes","userId":"05eaa055c0d9121c79531204ed434a12","msg":"User logged in successfully"}
{"level":30,"time":1768335771103,"env":"test","module":"auth-routes","userId":"87b7ea84-2947-4593-aae8-018e7447e70b","email":"test-1768335770241-xyd0p@example.com","msg":"User registered"}
{"level":30,"time":1768335771139,"env":"test","module":"audit-log-service","userId":"05eaa055c0d9121c79531204ed434a12","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mComplete Registration â†’ Login Flow[2m > [22m[2mshould complete registration, verify email, then login
[22m[39mError deleting test user b020cc43-1238-47ed-8ad2-193994f9647d: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth.flows.real.test.ts:47:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335771245,"env":"test","module":"auth-routes","userId":"05eaa055c0d9121c79531204ed434a12","sessionCount":3,"msg":"Listed active sessions"}
[90mstderr[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39mError deleting test user fa4bdb23d2b1096345c798e3a0098036: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/trusted.devices.real.test.ts:45:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould prevent duplicate pending invites
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:52:21 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould complete full MFA setup flow
[22m[39mError deleting test user 2f64b8225354c36ea411629a8e961937: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/mfa.flow.real.test.ts:46:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/register[2m > [22m[2mshould return 409 for duplicate email
[22m[39mError deleting test user 87b7ea84-2947-4593-aae8-018e7447e70b: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth.routes.real.test.ts:54:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mError deleting test user 05eaa055c0d9121c79531204ed434a12: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/session.management.real.test.ts:44:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335771947,"env":"test","module":"email-queue","jobId":"15c6eba4-d998-4ff6-9f3d-b7d65f915c24","to":"newuser_1768335765585@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould prevent duplicate pending invites
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:548:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:118:13
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39m[TEST UTILS] MFA Secret verified for 69ebff91a5fec879df6628ab9109864d

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould reject invalid TOTP code during setup
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768335772321,"env":"test","module":"auth-routes","email":"test-1768335771179-r4zi1w@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768335772423,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335772443,"env":"test","module":"user-credentials-repository","userId":"dd94ad90-3cdd-4c65-bee2-29de0d69f680","msg":"User credentials created"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould mark current session correctly
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335772543,"env":"test","module":"email-queue","jobId":"fdb04378-1ec2-4fab-bba0-e7d794aa1f0f","to":"test-1768335771740-1t0rfn@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335772596,"env":"test","module":"auth-routes","userId":"dd94ad90-3cdd-4c65-bee2-29de0d69f680","email":"test-1768335771740-1t0rfn@example.com","msg":"User registered"}
{"level":30,"time":1768335772772,"env":"test","module":"auth-routes","userId":"025931d4f804f25b8704878eb370526e","msg":"User logged in successfully"}
{"level":30,"time":1768335772828,"env":"test","module":"audit-log-service","userId":"025931d4f804f25b8704878eb370526e","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768335772841,"env":"test","module":"auth-routes","email":"test-1768335771179-r4zi1w@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768335772869,"env":"test","module":"auth-routes","userId":"69ebff91a5fec879df6628ab9109864d","msg":"Login requires MFA verification"}
{"level":50,"time":1768335772942,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335772975,"env":"test","module":"mfa-service","userId":"69ebff91a5fec879df6628ab9109864d","msg":"TOTP verification successful"}
{"level":30,"time":1768335772983,"env":"test","module":"auth-routes","userId":"b4eafb8945c6c7c571d1028752b5cebe","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould login with valid credentials
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335773024,"env":"test","module":"auth-routes","userId":"69ebff91a5fec879df6628ab9109864d","msg":"MFA login successful"}
{"level":30,"time":1768335773031,"env":"test","module":"audit-log-service","userId":"b4eafb8945c6c7c571d1028752b5cebe","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould mark current session correctly
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335773195,"env":"test","module":"auth-routes","userId":"69ebff91a5fec879df6628ab9109864d","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":50,"time":1768335773340,"env":"test","module":"auth-routes","email":"test-1768335771179-r4zi1w@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768335773366,"env":"test","module":"mfa-service","userId":"025931d4f804f25b8704878eb370526e","count":10,"msg":"Stored backup codes"}
{"level":30,"time":1768335773366,"env":"test","module":"mfa-service","userId":"025931d4f804f25b8704878eb370526e","msg":"Generated TOTP secret"}
{"level":30,"time":1768335773366,"env":"test","module":"auth-routes","userId":"025931d4f804f25b8704878eb370526e","msg":"MFA setup initiated"}
{"level":50,"time":1768335773436,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768335773472,"env":"test","module":"mfa-service","userId":"025931d4f804f25b8704878eb370526e","msg":"Invalid TOTP token provided"}
{"level":30,"time":1768335773504,"env":"test","module":"auth-routes","userId":"05c8388c027323ec00ce77d02948d26e","msg":"User logged in successfully"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould prevent inviting existing members
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:52:21 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335773557,"env":"test","module":"auth-routes","userId":"b4eafb8945c6c7c571d1028752b5cebe","msg":"User logged in successfully"}
{"level":30,"time":1768335773558,"env":"test","module":"audit-log-service","userId":"05c8388c027323ec00ce77d02948d26e","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335773613,"env":"test","module":"audit-log-service","userId":"b4eafb8945c6c7c571d1028752b5cebe","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335773726,"env":"test","module":"auth-routes","userId":"b4eafb8945c6c7c571d1028752b5cebe","sessionCount":2,"msg":"Listed active sessions"}
[90mstderr[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39mError deleting test user 69ebff91a5fec879df6628ab9109864d: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/trusted.devices.real.test.ts:45:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":50,"time":1768335773856,"env":"test","module":"auth-routes","email":"test-1768335771179-r4zi1w@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":50,"time":1768335773948,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould reject invalid TOTP code during setup
[22m[39mError deleting test user 025931d4f804f25b8704878eb370526e: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/mfa.flow.real.test.ts:46:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould login with valid credentials
[22m[39mError deleting test user 05c8388c027323ec00ce77d02948d26e: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth.routes.real.test.ts:54:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould mark current session correctly
[22m[39mError deleting test user b4eafb8945c6c7c571d1028752b5cebe: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/session.management.real.test.ts:44:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":50,"time":1768335774387,"env":"test","module":"auth-routes","email":"test-1768335771179-r4zi1w@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for 53d1f20e92419d4293ba9ebec1311bf2

{"level":40,"time":1768335774588,"env":"test","module":"account-lockout","userId":"20fde893b9d96e86a12989984a098878","email":"test-1768335771179-r4zi1w@example.com","lockedUntil":"2026-01-13T20:37:54.540Z","msg":"Account locked due to too many failed attempts"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768335774588,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768335774686,"env":"test","module":"auth-routes","userId":"20fde893b9d96e86a12989984a098878","email":"test-1768335771179-r4zi1w@example.com","msg":"Login blocked: account locked"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: AccountLockedError: Account is locked until 2026-01-13T20:37:54.540Z
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:58:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: [32m'AUTH_005'[39m,
  statusCode: [33m423[39m,
  isOperational: [33mtrue[39m,
  lockedUntil: [35m2026-01-13T20:37:54.540Z[39m,
  remainingMinutes: [33m15[39m
}

{"level":50,"time":1768335774687,"env":"test","module":"auth-routes","error":{"name":"AccountLockedError","code":"AUTH_005","statusCode":423,"isOperational":true,"lockedUntil":"2026-01-13T20:37:54.540Z","remainingMinutes":15},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for invalid password
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould not allow MFA setup if already enabled
[22m[39m[TEST UTILS] MFA Secret verified for 232b0f763728fb95af892cc8c7a7f134

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould require admin access to create invite
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:52:21 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould exclude revoked sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould not allow MFA setup if already enabled
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768335775166,"env":"test","module":"auth-routes","email":"test-1768335774101-653g2e@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":50,"time":1768335775264,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for invalid password
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":30,"time":1768335775367,"env":"test","module":"auth-routes","userId":"53d1f20e92419d4293ba9ebec1311bf2","msg":"Login requires MFA verification"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mError deleting test user 20fde893b9d96e86a12989984a098878: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth.flows.real.test.ts:47:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335775466,"env":"test","module":"auth-routes","userId":"8f1ad306627012d6cd3cb733e0b4b1cc","msg":"User logged in successfully"}
{"level":30,"time":1768335775471,"env":"test","module":"mfa-service","userId":"53d1f20e92419d4293ba9ebec1311bf2","msg":"TOTP verification successful"}
{"level":30,"time":1768335775512,"env":"test","module":"audit-log-service","userId":"8f1ad306627012d6cd3cb733e0b4b1cc","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould exclude revoked sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335775526,"env":"test","module":"auth-routes","userId":"53d1f20e92419d4293ba9ebec1311bf2","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w6
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w8
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w3
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w4
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w14
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w0
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w2
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w11
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w1
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w6 (Reused: true)

{"level":30,"time":1768335775619,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w3 (Reused: true)

{"level":30,"time":1768335775633,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w4 (Reused: true)

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w14 (Reused: true)

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w0 (Reused: true)

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w8 (Reused: true)

{"level":30,"time":1768335775634,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335775633,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335775633,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335775634,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w2 (Reused: true)

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w11 (Reused: true)

{"level":30,"time":1768335775641,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335775641,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335775646,"env":"test","module":"auth-routes","userId":"232b0f763728fb95af892cc8c7a7f134","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w1 (Reused: true)

{"level":30,"time":1768335775649,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335775670,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335775680,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768335775680,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768335775682,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335775683,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768335775684,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335775685,"env":"test","module":"auth-routes","userId":"53d1f20e92419d4293ba9ebec1311bf2","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335775697,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768335775700,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335775707,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for invalid password
[22m[39mError deleting test user d318677ccf12f36e928bab07aa91dc22: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth.routes.real.test.ts:54:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for non-existent user
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould set expiry to 7 days from now
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:52:21 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335775940,"env":"test","module":"auth-routes","userId":"53d1f20e92419d4293ba9ebec1311bf2","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Trusted device expiry updated"}
{"level":30,"time":1768335776003,"env":"test","module":"auth-routes","userId":"8f1ad306627012d6cd3cb733e0b4b1cc","msg":"User logged in successfully"}
{"level":30,"time":1768335776058,"env":"test","module":"audit-log-service","userId":"8f1ad306627012d6cd3cb733e0b4b1cc","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768335776147,"env":"test","module":"auth-routes","email":"nonexistent@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":30,"time":1768335776179,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768335776183,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768335776190,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768335776197,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs
[Routes] E-Signature routes registered at /api/esign

[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould not allow MFA setup if already enabled
[22m[39mError deleting test user 232b0f763728fb95af892cc8c7a7f134: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/mfa.flow.real.test.ts:46:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335776203,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs
[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768335776186,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768335776187,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768335776192,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768335776197,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768335776197,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768335776197,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768335776197,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768335776191,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768335776192,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768335776198,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768335776203,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768335776203,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768335776203,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768335776203,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768335776209,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768335776211,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts[2m > [22m[2mTemplates and Runs API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs
[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768335776217,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768335776200,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768335776200,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768335776205,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768335776210,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768335776210,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768335776211,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768335776211,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768335776222,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768335776221,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768335776228,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768335776230,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768335776230,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/js_helpers.test.ts[2m > [22m[2mDetailed Verification: JS Helper Availability
[22m[39mðŸ“š API Documentation available at /api-docs
[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768335776218,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768335776218,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768335776223,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768335776229,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768335776230,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768335776230,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768335776230,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768335776238,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs
[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768335776244,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.snapshots.test.ts[2m > [22m[2mStage 13: Workflow Snapshots & Versioning
[22m[39mðŸ“š API Documentation available at /api-docs
[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768335776226,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768335776226,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768335776231,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768335776237,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768335776237,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768335776238,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768335776238,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768335776244,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts[2m > [22m[2mAI Document Assistant API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs
[Routes] E-Signature routes registered at /api/esign

{"level":50,"time":1768335776246,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for non-existent user
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:51:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":30,"time":1768335776249,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts[2m > [22m[2mLifecycle Hooks Execution
[22m[39mðŸ“š API Documentation available at /api-docs
[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768335776230,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768335776231,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768335776236,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768335776243,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768335776243,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768335776244,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768335776244,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768335776251,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs
[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768335776237,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768335776237,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768335776243,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768335776249,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768335776249,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768335776249,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768335776249,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768335776239,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768335776240,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768335776245,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768335776250,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768335776250,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768335776251,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768335776251,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768335776260,"env":"test","module":"auth-routes","userId":"8f1ad306627012d6cd3cb733e0b4b1cc","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768335776231,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768335776232,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768335776238,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768335776244,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768335776244,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768335776244,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768335776244,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts[2m > [22m[2mAI Document Assistant API Integration Tests[2m > [22m[2mPOST /api/ai/doc/analyze[2m > [22m[2mshould analyze a DOCX file and return variables
[22m[39mFAIL_STATUS: 500
FAIL_BODY: {}

{"level":30,"time":1768335776324,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335776325,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335776436,"env":"test","module":"email-queue","jobId":"e24db9be-e78e-4e58-a877-29e0b7c7a2fa","to":"newuser_1768335765585@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
{"level":50,"time":1768335776488,"env":"test","module":"auth-routes","email":"test-1768335775423-zwr74t@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
[90mstderr[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39mError deleting test user 53d1f20e92419d4293ba9ebec1311bf2: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/trusted.devices.real.test.ts:45:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":50,"time":1768335776524,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768335776538,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould set expiry to 7 days from now
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:548:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:142:28
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

 [31mâ¯[39m tests/integration/api.ai.doc.test.ts [2m([22m[2m4 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 1146[2mms[22m[39m
[31m       [31mÃ—[31m should analyze a DOCX file and return variables[39m[32m 43[2mms[22m[39m
[31m       [31mÃ—[31m should fail if no file is provided[39m[32m 10[2mms[22m[39m
       [32mâœ“[39m should suggest mappings between template and workflow variables[32m 18[2mms[22m[39m
       [32mâœ“[39m should return improvement suggestions[32m 5[2mms[22m[39m
{"level":30,"time":1768335776551,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335776552,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768335776597,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335776643,"env":"test","module":"user-credentials-repository","userId":"e1aec125-c42a-48e9-abb4-678b561b36d6","msg":"User credentials created"}
{"level":30,"time":1768335776681,"env":"test","module":"user-credentials-repository","userId":"eb2d5184-adbd-445d-b018-855dad02f4b1","msg":"User credentials created"}
{"level":30,"time":1768335776688,"env":"test","module":"user-credentials-repository","userId":"4687a362-fd3b-4484-b71f-f061562d2504","msg":"User credentials created"}
{"level":50,"time":1768335776694,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335776699,"env":"test","module":"user-credentials-repository","userId":"5b3cb19d-9cfe-41f2-9af5-6aea342de7e3","msg":"User credentials created"}
{"level":30,"time":1768335776731,"env":"test","module":"user-credentials-repository","userId":"4dd58307-af7b-4e58-a6a4-39f30d26a8dd","msg":"User credentials created"}
{"level":30,"time":1768335776740,"env":"test","module":"user-credentials-repository","userId":"64cd5471-8a64-468c-982d-b69e28728710","msg":"User credentials created"}
{"level":30,"time":1768335776745,"env":"test","module":"email-queue","jobId":"c009df47-0a9d-4282-98fe-691f835dc2b1","to":"test-1768335776249-7ob6ai@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335776750,"env":"test","module":"user-credentials-repository","userId":"9e063000-b514-41b0-abb7-9a6936dc110e","msg":"User credentials created"}
{"level":30,"time":1768335776790,"env":"test","module":"email-queue","jobId":"50188d9b-10a6-4ab6-aa32-5f4751f96c1a","to":"test-6Ub0WgSvcDMSSerobedPL@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335776794,"env":"test","module":"auth-routes","userId":"e1aec125-c42a-48e9-abb4-678b561b36d6","email":"test-1768335776249-7ob6ai@example.com","msg":"User registered"}
{"level":30,"time":1768335776795,"env":"test","module":"email-queue","jobId":"6c5d3c05-a5c8-450e-b56c-52b24c40f348","to":"test-9qqTKsaXwBpDqfIRa267m@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 403 for unverified email
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould exclude revoked sessions
[22m[39mError deleting test user 8f1ad306627012d6cd3cb733e0b4b1cc: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/session.management.real.test.ts:44:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335776800,"env":"test","module":"email-queue","jobId":"b7d69cbe-bfbe-4c61-8b98-8d7b86ae3420","to":"test-HiaDVjmtyrCn5TOGWkoHP@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
 [31mâ¯[39m tests/integration/js_helpers.test.ts [2m([22m[2m1 test[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 1368[2mms[22m[39m
[31m     [31mÃ—[31m should execute a JS block that uses helper functions[39m[32m 124[2mms[22m[39m
{"level":30,"time":1768335776827,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335776827,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335776834,"env":"test","module":"email-queue","jobId":"c8c97625-ca2a-4063-90f7-428e5b0b5b89","to":"test-cH4T3jdCUGqpI8-ceGPjw@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335776841,"env":"test","module":"email-queue","jobId":"ad6a92aa-f6db-4724-b9c2-75fa098c69ef","to":"test-Z64q5qd8bEy9S31dpsmbu@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335776849,"env":"test","module":"auth-routes","userId":"eb2d5184-adbd-445d-b018-855dad02f4b1","email":"test-6Ub0WgSvcDMSSerobedPL@example.com","msg":"User registered"}
{"level":30,"time":1768335776856,"env":"test","module":"auth-routes","userId":"5b3cb19d-9cfe-41f2-9af5-6aea342de7e3","email":"test-HiaDVjmtyrCn5TOGWkoHP@example.com","msg":"User registered"}
{"level":30,"time":1768335776857,"env":"test","module":"email-queue","jobId":"d543a723-e0a6-47d7-a8d9-8ca2cc98455e","to":"test-ckiu09KvM4Asbxxsv_6d4@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335776857,"env":"test","module":"auth-routes","userId":"4687a362-fd3b-4484-b71f-f061562d2504","email":"test-9qqTKsaXwBpDqfIRa267m@example.com","msg":"User registered"}
{"level":30,"time":1768335776892,"env":"test","module":"auth-routes","userId":"4dd58307-af7b-4e58-a6a4-39f30d26a8dd","email":"test-cH4T3jdCUGqpI8-ceGPjw@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould generate unique backup codes
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335776899,"env":"test","module":"auth-routes","userId":"64cd5471-8a64-468c-982d-b69e28728710","email":"test-Z64q5qd8bEy9S31dpsmbu@example.com","msg":"User registered"}
{"level":30,"time":1768335776909,"env":"test","module":"auth-routes","userId":"9e063000-b514-41b0-abb7-9a6936dc110e","email":"test-ckiu09KvM4Asbxxsv_6d4@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

{"level":50,"time":1768335776988,"env":"test","module":"auth-routes","email":"test-1768335775423-zwr74t@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":50,"time":1768335777089,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

 [31mâ¯[39m tests/integration/api.snapshots.test.ts [2m([22m[2m1 test[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 1626[2mms[22m[39m
[31m     [31mÃ—[31m should maintain immutability of runs across versions[39m[32m 273[2mms[22m[39m
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768335777175,"env":"test","module":"auth-routes","userId":"e1aec125-c42a-48e9-abb4-678b561b36d6","email":"test-1768335776249-7ob6ai@example.com","msg":"Login blocked: email not verified"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 403 for unverified email
[22m[39mLogin Failed DEBUG: EmailNotVerifiedError: Please verify your email before logging in. Check your inbox for the verification link.
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:86:11)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: [32m'AUTH_006'[39m,
  statusCode: [33m403[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768335777176,"env":"test","module":"auth-routes","error":{"name":"EmailNotVerifiedError","code":"AUTH_006","statusCode":403,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39m[TEST UTILS] MFA Secret verified for 62a619e594200aacb2925809cd7f0957

{"level":30,"time":1768335777384,"env":"test","module":"auth-routes","userId":"0f120366dbcf5394124020986e3c3f4c","msg":"User logged in successfully"}
{"level":30,"time":1768335777437,"env":"test","module":"audit-log-service","userId":"0f120366dbcf5394124020986e3c3f4c","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335777490,"env":"test","module":"user-credentials-repository","userId":"3afd6355-a994-4ccb-b141-d69d2aa8b855","msg":"User credentials created"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335777529,"env":"test","module":"user-credentials-repository","userId":"bc00e994-f2f2-492c-a79e-e3166401f111","msg":"User credentials created"}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

{"level":30,"time":1768335777570,"env":"test","module":"user-credentials-repository","userId":"c966919a-ba4d-479d-9487-87daf9f030d4","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould record failed login attempt
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335777591,"env":"test","module":"email-queue","jobId":"89d6d100-a045-41e2-bb89-5b103f9ea6f1","to":"session-test-KoEpXhr_0D1PzDmmifnXU@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335777596,"env":"test","module":"auth-routes","userId":"e97a483594bcabfa0b65047f32c11153","msg":"User logged in successfully"}
{"level":30,"time":1768335777624,"env":"test","module":"user-credentials-repository","userId":"7c2ddcc4-b9e0-46f3-a39b-b1cd5381c9d9","msg":"User credentials created"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335777631,"env":"test","module":"email-queue","jobId":"60ce7435-c463-4960-a9af-d456ff5ee27c","to":"protected-test-FgQeA0CuyDx0GVTY8hZsl@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335777642,"env":"test","module":"auth-routes","userId":"3afd6355-a994-4ccb-b141-d69d2aa8b855","email":"session-test-KoEpXhr_0D1PzDmmifnXU@example.com","msg":"User registered"}
{"level":30,"time":1768335777647,"env":"test","module":"audit-log-service","userId":"e97a483594bcabfa0b65047f32c11153","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335777672,"env":"test","module":"email-queue","jobId":"04215dbd-c61c-4b3f-87b6-28bfdfe10651","to":"jwt-test-X07WezwOIpFjvM5zhTGdr@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335777683,"env":"test","module":"auth-routes","userId":"bc00e994-f2f2-492c-a79e-e3166401f111","email":"protected-test-FgQeA0CuyDx0GVTY8hZsl@example.com","msg":"User registered"}
{"level":30,"time":1768335777721,"env":"test","module":"auth-routes","userId":"c966919a-ba4d-479d-9487-87daf9f030d4","email":"jwt-test-X07WezwOIpFjvM5zhTGdr@example.com","msg":"User registered"}
{"level":30,"time":1768335777728,"env":"test","module":"email-queue","jobId":"9d9fd791-a002-4adb-9577-2f8ddbc16e6c","to":"middleware-test-HaNTshYIoRQpoAC0d5KmE@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Creation and Tracking[2m > [22m[2mshould create refresh token on login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335777765,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335777766,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335777784,"env":"test","module":"auth-routes","userId":"7c2ddcc4-b9e0-46f3-a39b-b1cd5381c9d9","email":"middleware-test-HaNTshYIoRQpoAC0d5KmE@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould allow access with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mJWT Token Generation[2m > [22m[2mshould generate valid JWT token on successful login
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould allow access with valid JWT Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould accept invite and create membership
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:52:21 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335777952,"env":"test","module":"mfa-service","userId":"0f120366dbcf5394124020986e3c3f4c","count":10,"msg":"Stored backup codes"}
{"level":30,"time":1768335777952,"env":"test","module":"mfa-service","userId":"0f120366dbcf5394124020986e3c3f4c","msg":"Generated TOTP secret"}
{"level":30,"time":1768335777952,"env":"test","module":"auth-routes","userId":"0f120366dbcf5394124020986e3c3f4c","msg":"MFA setup initiated"}
{"level":30,"time":1768335777993,"env":"test","module":"auth-routes","userId":"b20e88c276adadb356d3f3cfef84cf55","msg":"User logged in successfully"}
{"level":50,"time":1768335778014,"env":"test","module":"auth-routes","email":"test-1768335777179-nsckwp@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768335778049,"env":"test","module":"audit-log-service","userId":"b20e88c276adadb356d3f3cfef84cf55","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768335778111,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould record failed login attempt
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

 [31mâ¯[39m tests/integration/lifecycle-hooks-execution.test.ts [2m([22m[2m15 tests[22m[2m | [22m[33m15 skipped[39m[2m)[22m[33m 2562[2mms[22m[39m
       [2m[90mâ†“[39m[22m should execute beforePage hook and capture console output
       [2m[90mâ†“[39m[22m should execute beforePage hook with mutation mode enabled
       [2m[90mâ†“[39m[22m should handle errors gracefully without breaking workflow
       [2m[90mâ†“[39m[22m should execute afterPage hook with user input data
       [2m[90mâ†“[39m[22m should execute Python afterPage hook
       [2m[90mâ†“[39m[22m should execute beforeFinalBlock hook before document generation
       [2m[90mâ†“[39m[22m should execute afterDocumentsGenerated hook for cleanup
       [2m[90mâ†“[39m[22m should timeout hook that exceeds timeoutMs limit
       [2m[90mâ†“[39m[22m should execute multiple hooks in correct order
       [2m[90mâ†“[39m[22m should list all hooks for a workflow
       [2m[90mâ†“[39m[22m should update a hook
       [2m[90mâ†“[39m[22m should delete a hook
       [2m[90mâ†“[39m[22m should test a hook with sample data
       [2m[90mâ†“[39m[22m should retrieve execution logs for a run
       [2m[90mâ†“[39m[22m should clear execution logs for a run
{"level":50,"time":1768335778144,"env":"test","error":{"code":1,"killed":false,"signal":null,"cmd":"qpdf --decrypt \"C:\\Users\\scoot\\AppData\\Local\\Temp\\locked-1768335778100.pdf\" \"C:\\Users\\scoot\\AppData\\Local\\Temp\\unlocked-1768335778100.pdf\"","stdout":"","stderr":"'qpdf' is not recognized as an internal or external command,\r\noperable program or batch file.\r\n"},"msg":"Failed to unlock PDF with qpdf"}
{"level":40,"time":1768335778144,"env":"test","msg":"Returning original PDF buffer due to unlock failure"}
{"level":50,"time":1768335778147,"env":"test","error":{},"msg":"Failed to extract PDF fields"}
{"level":50,"time":1768335778147,"env":"test","error":{"error":{"code":"INTERNAL_ERROR","message":""}},"msg":"PDF processing failed"}
{"level":50,"time":1768335778147,"env":"test","error":{"error":{"code":"VALIDATION_ERROR","message":""}},"body":{"name":"Test Template"},"params":{"projectId":"2154b3a5-5f2d-4cbd-82a2-9ee244b8f0fb"},"file":{"fieldname":"file","originalname":"test.pdf","encoding":"7bit","mimetype":"application/pdf","buffer":{"type":"Buffer","data":[37,80,68,70]},"size":4},"msg":"Error creating template"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335778157,"env":"test","module":"auth-routes","userId":"62a619e594200aacb2925809cd7f0957","msg":"Login requires MFA verification"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mError deleting test user e97a483594bcabfa0b65047f32c11153: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth.flows.real.test.ts:47:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":50,"time":1768335778254,"env":"test","error":{"error":{"code":"VALIDATION_ERROR","message":""}},"body":{"name":"Test Template"},"params":{"projectId":"2154b3a5-5f2d-4cbd-82a2-9ee244b8f0fb"},"msg":"Error creating template"}
{"level":30,"time":1768335778261,"env":"test","module":"mfa-service","userId":"62a619e594200aacb2925809cd7f0957","msg":"TOTP verification successful"}
{"level":30,"time":1768335778278,"env":"test","module":"auth-routes","userId":"3afd6355-a994-4ccb-b141-d69d2aa8b855","msg":"User logged in successfully"}
{"level":30,"time":1768335778315,"env":"test","module":"auth-routes","userId":"62a619e594200aacb2925809cd7f0957","msg":"MFA login successful"}
{"level":30,"time":1768335778342,"env":"test","module":"audit-log-service","userId":"3afd6355-a994-4ccb-b141-d69d2aa8b855","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335778358,"env":"test","module":"auth-routes","userId":"7c2ddcc4-b9e0-46f3-a39b-b1cd5381c9d9","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335778372,"env":"test","module":"auth-routes","userId":"c966919a-ba4d-479d-9487-87daf9f030d4","msg":"User logged in successfully"}
{"level":30,"time":1768335778379,"env":"test","module":"email-queue","jobId":"bdb250ef-1741-4517-87f1-f7ad08f51c09","to":"existing_1768335765585@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
{"level":30,"time":1768335778411,"env":"test","module":"auth-routes","userId":"bc00e994-f2f2-492c-a79e-e3166401f111","msg":"User logged in successfully"}
{"level":30,"time":1768335778423,"env":"test","module":"audit-log-service","userId":"7c2ddcc4-b9e0-46f3-a39b-b1cd5381c9d9","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335778427,"env":"test","module":"audit-log-service","userId":"c966919a-ba4d-479d-9487-87daf9f030d4","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335778460,"env":"test","module":"audit-log-service","userId":"bc00e994-f2f2-492c-a79e-e3166401f111","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould accept invite and create membership
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:548:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:164:34
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335778480,"env":"test","module":"auth-routes","userId":"62a619e594200aacb2925809cd7f0957","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould generate unique backup codes
[22m[39mError deleting test user 0f120366dbcf5394124020986e3c3f4c: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/mfa.flow.real.test.ts:46:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w16
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w16 (Reused: true)

{"level":30,"time":1768335778592,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335778635,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould record failed login attempt
[22m[39mError deleting test user 4563e87e864d694c9ffcf8e6fd5d470a: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth.routes.real.test.ts:54:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335778714,"env":"test","module":"auth-routes","userId":"b20e88c276adadb356d3f3cfef84cf55","msg":"User logged in successfully"}
{"level":30,"time":1768335778770,"env":"test","module":"audit-log-service","userId":"b20e88c276adadb356d3f3cfef84cf55","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335778857,"env":"test","module":"user-credentials-repository","userId":"603c34b4-836d-44ab-96b7-29dee54f3c0a","msg":"User credentials created"}
{"level":30,"time":1768335778860,"env":"test","module":"user-credentials-repository","userId":"527a9d6e-3019-47dc-bd97-744d0ae371a9","msg":"User credentials created"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w17
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":30,"time":1768335778955,"env":"test","module":"user-credentials-repository","userId":"5d1dfff7-a462-4d89-8265-dd81b44aaad5","msg":"User credentials created"}
{"level":30,"time":1768335778973,"env":"test","module":"email-queue","jobId":"a0e28599-4313-4cef-94f0-b7fec020fbf2","to":"jwt-test-ZWCRT_JqDU1wjdpOZNJjw@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335778973,"env":"test","module":"email-queue","jobId":"cfdc0251-799a-4300-9f7c-2b5777b87510","to":"session-test-sxCQpV0FoS7LGMw5V3Iox@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould complete MFA setup and login with TOTP
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335778978,"env":"test","module":"user-credentials-repository","userId":"8f22150f-c9b1-4621-94bc-668d1d65b52a","msg":"User credentials created"}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w17 (Reused: true)

{"level":30,"time":1768335778986,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335779000,"env":"test","module":"auth-routes","userId":"62a619e594200aacb2925809cd7f0957","msg":"Login requires MFA verification"}
{"level":30,"time":1768335779024,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335779034,"env":"test","module":"auth-routes","userId":"527a9d6e-3019-47dc-bd97-744d0ae371a9","email":"jwt-test-ZWCRT_JqDU1wjdpOZNJjw@example.com","msg":"User registered"}
{"level":30,"time":1768335779037,"env":"test","module":"auth-routes","userId":"603c34b4-836d-44ab-96b7-29dee54f3c0a","email":"session-test-sxCQpV0FoS7LGMw5V3Iox@example.com","msg":"User registered"}
{"level":30,"time":1768335779055,"env":"test","module":"email-queue","jobId":"2b353428-27af-4b2e-8c4a-637958f9424a","to":"protected-test-xAIq_EV-7HGzDRIukIHoC@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335779081,"env":"test","module":"email-queue","jobId":"0823769b-bddc-49fd-a6f3-79c88961e8ba","to":"middleware-test-5jSGPVp_n4Wq2D2c0bVow@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mJWT Token Generation[2m > [22m[2mshould include correct payload in JWT token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335779107,"env":"test","module":"auth-routes","userId":"5d1dfff7-a462-4d89-8265-dd81b44aaad5","email":"protected-test-xAIq_EV-7HGzDRIukIHoC@example.com","msg":"User registered"}
{"level":30,"time":1768335779108,"env":"test","module":"mfa-service","userId":"62a619e594200aacb2925809cd7f0957","msg":"TOTP verification successful"}
{"level":30,"time":1768335779133,"env":"test","module":"auth-routes","userId":"8f22150f-c9b1-4621-94bc-668d1d65b52a","email":"middleware-test-5jSGPVp_n4Wq2D2c0bVow@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Creation and Tracking[2m > [22m[2mshould track device metadata in session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335779160,"env":"test","module":"auth-routes","userId":"62a619e594200aacb2925809cd7f0957","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 when no token provided
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould reject access without Authorization header
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould accept invite and create membership
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.acceptInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:797:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:170:28
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335779272,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould store hashed backup codes
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335779313,"env":"test","module":"auth-routes","userId":"62a619e594200aacb2925809cd7f0957","deviceFingerprint":"091366faa1882b5c8dc1cba02126615a77a378274bbfd3375e821aa38bdd1b4f","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335779343,"env":"test","module":"auth-routes","userId":"b20e88c276adadb356d3f3cfef84cf55","msg":"User logged in successfully"}
{"level":30,"time":1768335779392,"env":"test","module":"audit-log-service","userId":"b20e88c276adadb356d3f3cfef84cf55","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335779452,"env":"test","module":"auth-routes","userId":"3c1eae01029cd0a050d4c41376f65853","msg":"User logged in successfully"}
{"level":30,"time":1768335779503,"env":"test","module":"auth-routes","userId":"b20e88c276adadb356d3f3cfef84cf55","sessionCount":3,"msg":"Listed active sessions"}
{"level":30,"time":1768335779505,"env":"test","module":"audit-log-service","userId":"3c1eae01029cd0a050d4c41376f65853","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return requiresMfa=true for MFA-enabled users
[22m[39m[TEST UTILS] MFA Secret verified for 66cc09479265f3aa7defa34dfb136516

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335779597,"env":"test","module":"auth-routes","userId":"527a9d6e-3019-47dc-bd97-744d0ae371a9","msg":"User logged in successfully"}
{"level":30,"time":1768335779645,"env":"test","module":"audit-log-service","userId":"527a9d6e-3019-47dc-bd97-744d0ae371a9","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335779668,"env":"test","module":"auth-routes","userId":"603c34b4-836d-44ab-96b7-29dee54f3c0a","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w15
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":30,"time":1768335779694,"env":"test","module":"auth-routes","userId":"8f22150f-c9b1-4621-94bc-668d1d65b52a","msg":"User logged in successfully"}
{"level":30,"time":1768335779720,"env":"test","module":"audit-log-service","userId":"603c34b4-836d-44ab-96b7-29dee54f3c0a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w15 (Reused: true)

{"level":30,"time":1768335779737,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335779744,"env":"test","module":"audit-log-service","userId":"8f22150f-c9b1-4621-94bc-668d1d65b52a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768335779750,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335779780,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335779791,"env":"test","module":"auth-routes","userId":"9d24da2218bcfbf83f72e4c57b454c56","msg":"User logged in successfully"}
{"level":30,"time":1768335779807,"env":"test","module":"auth-routes","userId":"5d1dfff7-a462-4d89-8265-dd81b44aaad5","msg":"User logged in successfully"}
{"level":30,"time":1768335779813,"env":"test","module":"auth-routes","userId":"62a619e594200aacb2925809cd7f0957","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return requiresMfa=true for MFA-enabled users
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould transfer user-owned project to org
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:56:21 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335779838,"env":"test","module":"audit-log-service","userId":"9d24da2218bcfbf83f72e4c57b454c56","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335779855,"env":"test","module":"audit-log-service","userId":"5d1dfff7-a462-4d89-8265-dd81b44aaad5","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768335779860,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335779919,"env":"test","module":"mfa-service","userId":"62a619e594200aacb2925809cd7f0957","msg":"TOTP verification successful"}
{"level":30,"time":1768335779972,"env":"test","module":"auth-routes","userId":"62a619e594200aacb2925809cd7f0957","msg":"MFA login successful"}
{"level":30,"time":1768335780041,"env":"test","module":"mfa-service","userId":"3c1eae01029cd0a050d4c41376f65853","count":10,"msg":"Stored backup codes"}
{"level":30,"time":1768335780041,"env":"test","module":"mfa-service","userId":"3c1eae01029cd0a050d4c41376f65853","msg":"Generated TOTP secret"}
{"level":30,"time":1768335780041,"env":"test","module":"auth-routes","userId":"3c1eae01029cd0a050d4c41376f65853","msg":"MFA setup initiated"}
{"level":30,"time":1768335780044,"env":"test","module":"user-credentials-repository","userId":"7c07e642-cbd7-4538-b78d-8bd3128683f7","msg":"User credentials created"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mError deleting test user b20e88c276adadb356d3f3cfef84cf55: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/session.management.real.test.ts:44:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335780083,"env":"test","module":"auth-routes","userId":"62a619e594200aacb2925809cd7f0957","deviceCount":2,"msg":"Listed trusted devices"}
{"level":30,"time":1768335780153,"env":"test","module":"user-credentials-repository","userId":"bab838c8-bba3-494a-ba71-b08b12b7a336","msg":"User credentials created"}
{"level":30,"time":1768335780153,"env":"test","module":"email-queue","jobId":"97ff2cc7-c436-4870-a248-d76b2f134d33","to":"jwt-test-tNyoZMH24xxpVPYf2VYsx@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335780173,"env":"test","module":"user-credentials-repository","userId":"7f1f683a-e18a-4973-bbd8-1e9e6daebf35","msg":"User credentials created"}
{"level":30,"time":1768335780207,"env":"test","module":"auth-routes","userId":"7c07e642-cbd7-4538-b78d-8bd3128683f7","email":"jwt-test-tNyoZMH24xxpVPYf2VYsx@example.com","msg":"User registered"}
{"level":30,"time":1768335780255,"env":"test","module":"email-queue","jobId":"b2773259-ccdb-42f6-ab13-a3caaec37686","to":"middleware-test-WRE_BJN15VWrzpQD1uRKJ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mJWT Token Generation[2m > [22m[2mshould set JWT expiry to 15 minutes
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335780273,"env":"test","module":"email-queue","jobId":"9360d2a9-26db-4ac7-a9dd-3f12110949be","to":"session-test-XFhxQs7jJRJDmT2N64kY4@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335780284,"env":"test","module":"user-credentials-repository","userId":"db0e9410-70e4-44b8-a390-a4a4b72aac62","msg":"User credentials created"}
{"level":30,"time":1768335780296,"env":"test","module":"auth-routes","userId":"66cc09479265f3aa7defa34dfb136516","msg":"Login requires MFA verification"}
{"level":30,"time":1768335780312,"env":"test","module":"auth-routes","userId":"bab838c8-bba3-494a-ba71-b08b12b7a336","email":"middleware-test-WRE_BJN15VWrzpQD1uRKJ@example.com","msg":"User registered"}
{"level":30,"time":1768335780323,"env":"test","module":"auth-routes","userId":"7f1f683a-e18a-4973-bbd8-1e9e6daebf35","email":"session-test-XFhxQs7jJRJDmT2N64kY4@example.com","msg":"User registered"}
{"level":30,"time":1768335780351,"env":"test","module":"mfa-service","userId":"3c1eae01029cd0a050d4c41376f65853","msg":"MFA enabled successfully"}
{"level":30,"time":1768335780352,"env":"test","module":"auth-routes","userId":"3c1eae01029cd0a050d4c41376f65853","msg":"MFA enabled successfully"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 with invalid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335780388,"env":"test","module":"email-queue","jobId":"cf502748-b2eb-46de-b718-8ae148ba9255","to":"protected-test-Pueyz6xxdYQWtntAOR469@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335780395,"env":"test","module":"mfa-service","userId":"9d24da2218bcfbf83f72e4c57b454c56","count":10,"msg":"Stored backup codes"}
{"level":30,"time":1768335780396,"env":"test","module":"mfa-service","userId":"9d24da2218bcfbf83f72e4c57b454c56","msg":"Generated TOTP secret"}
{"level":30,"time":1768335780396,"env":"test","module":"auth-routes","userId":"9d24da2218bcfbf83f72e4c57b454c56","msg":"MFA setup initiated"}
{"level":30,"time":1768335780401,"env":"test","module":"audit-log-service","userId":"3c1eae01029cd0a050d4c41376f65853","eventType":"mfa_enabled","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould complete MFA setup and login with TOTP
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Creation and Tracking[2m > [22m[2mshould create separate sessions for multiple device logins
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335780439,"env":"test","module":"auth-routes","userId":"db0e9410-70e4-44b8-a390-a4a4b72aac62","email":"protected-test-Pueyz6xxdYQWtntAOR469@example.com","msg":"User registered"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mcreateOrganization[2m > [22m[2mshould create organization and auto-create admin membership
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:73:25
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould reject access with empty Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39mError deleting test user 62a619e594200aacb2925809cd7f0957: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/trusted.devices.real.test.ts:45:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335780694,"env":"test","module":"user-credentials-repository","userId":"FFgAtHWX3DPZTwhp_3Kdv","msg":"User credentials created"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould convert placeholder user to real user on accept
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:52:21 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335780753,"env":"test","module":"auth-routes","userId":"7c07e642-cbd7-4538-b78d-8bd3128683f7","msg":"User logged in successfully"}
{"level":30,"time":1768335780778,"env":"test","module":"auth-service","tokenHash":"06f49b58deab5515976f87e7638aca37831d8fde2e61b173baf34150b36002de","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768335780804,"env":"test","module":"audit-log-service","userId":"7c07e642-cbd7-4538-b78d-8bd3128683f7","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return requiresMfa=true for MFA-enabled users
[22m[39mError deleting test user 66cc09479265f3aa7defa34dfb136516: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth.routes.real.test.ts:54:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335780880,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768335780881,"env":"test","module":"auth-routes","userId":"bab838c8-bba3-494a-ba71-b08b12b7a336","msg":"User logged in successfully"}
{"level":30,"time":1768335780899,"env":"test","module":"auth-routes","userId":"3c1eae01029cd0a050d4c41376f65853","msg":"Login requires MFA verification"}
{"level":30,"time":1768335780931,"env":"test","module":"audit-log-service","userId":"bab838c8-bba3-494a-ba71-b08b12b7a336","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768335780935,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335780948,"env":"test","module":"auth-routes","userId":"7f1f683a-e18a-4973-bbd8-1e9e6daebf35","msg":"User logged in successfully"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould store hashed backup codes
[22m[39mError deleting test user 9d24da2218bcfbf83f72e4c57b454c56: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/mfa.flow.real.test.ts:46:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335781002,"env":"test","module":"audit-log-service","userId":"7f1f683a-e18a-4973-bbd8-1e9e6daebf35","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Creation and Tracking[2m > [22m[2mshould create separate sessions for multiple device logins
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335781011,"env":"test","module":"mfa-service","userId":"3c1eae01029cd0a050d4c41376f65853","msg":"TOTP verification successful"}
{"level":30,"time":1768335781066,"env":"test","module":"auth-routes","userId":"3c1eae01029cd0a050d4c41376f65853","msg":"MFA login successful"}
{"level":30,"time":1768335781113,"env":"test","module":"auth-routes","userId":"db0e9410-70e4-44b8-a390-a4a4b72aac62","msg":"User logged in successfully"}
{"level":30,"time":1768335781163,"env":"test","module":"audit-log-service","userId":"db0e9410-70e4-44b8-a390-a4a4b72aac62","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768335781167,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335781208,"env":"test","module":"user-credentials-repository","userId":"8c0bfc9c-5be3-42d2-97c8-d442a8e946f7","msg":"User credentials created"}
{"level":30,"time":1768335781273,"env":"test","module":"email-queue","jobId":"348d2f08-b366-407e-8e76-51ab77228e5c","to":"newuser_1768335765585@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
{"level":30,"time":1768335781310,"env":"test","module":"email-queue","jobId":"c23729f4-934e-4bb1-9991-b93dd388225f","to":"jwt-test-vvObVQhax_3dLiM386jRm@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335781337,"env":"test","module":"user-credentials-repository","userId":"f594f66f-1ab2-46f2-88c5-20ba9c711d92","msg":"User credentials created"}
{"level":30,"time":1768335781350,"env":"test","module":"user-credentials-repository","userId":"dIW4Lgcm8IGS2OA2YxQzV","msg":"User credentials created"}
{"level":30,"time":1768335781362,"env":"test","module":"auth-routes","userId":"8c0bfc9c-5be3-42d2-97c8-d442a8e946f7","email":"jwt-test-vvObVQhax_3dLiM386jRm@example.com","msg":"User registered"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould convert placeholder user to real user on accept
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:548:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:193:34
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335781409,"env":"test","module":"auth-service","tokenHash":"137fe62e9a3d98938bb5a91fcb34d9f79e449db73dcde29f7ed982d0e9c0ba1d","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mJWT Token Validation[2m > [22m[2mshould accept valid JWT token on protected routes
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for f66b82ff0b076c7aab9e1cb390ddb7fe

{"level":30,"time":1768335781443,"env":"test","module":"email-queue","jobId":"50bec7cf-6cd5-40ee-a750-6c7f2fafc963","to":"middleware-test-spqdrCaCngobxQTf_ZTr_@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mgetUserOrganizations[2m > [22m[2mshould return all organizations for user
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:99:25
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335781494,"env":"test","module":"auth-routes","userId":"f594f66f-1ab2-46f2-88c5-20ba9c711d92","email":"middleware-test-spqdrCaCngobxQTf_ZTr_@example.com","msg":"User registered"}
{"level":30,"time":1768335781511,"env":"test","module":"auth-routes","userId":"7f1f683a-e18a-4973-bbd8-1e9e6daebf35","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 with expired token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335781564,"env":"test","module":"user-credentials-repository","userId":"4b172bcd-0105-48fe-ac38-fa07438b87db","msg":"User credentials created"}
{"level":30,"time":1768335781564,"env":"test","module":"audit-log-service","userId":"7f1f683a-e18a-4973-bbd8-1e9e6daebf35","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Creation and Tracking[2m > [22m[2mshould create separate sessions for multiple device logins
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould complete MFA setup and login with TOTP
[22m[39mError deleting test user 3c1eae01029cd0a050d4c41376f65853: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth.flows.real.test.ts:47:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335781683,"env":"test","module":"email-queue","jobId":"3e2f61a1-65fe-40e4-bc12-9f2197383fb4","to":"protected-test-ex_PnCI2knZRw00qpBxmo@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335781689,"env":"test","module":"auth-routes","userId":"bf6c8ee373aa34a61f9830421824eb2d","msg":"User logged in successfully"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould prevent transfer to org if user is not a member
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:56:21 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335781739,"env":"test","module":"auth-routes","userId":"4b172bcd-0105-48fe-ac38-fa07438b87db","email":"protected-test-ex_PnCI2knZRw00qpBxmo@example.com","msg":"User registered"}
{"level":30,"time":1768335781740,"env":"test","module":"audit-log-service","userId":"bf6c8ee373aa34a61f9830421824eb2d","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould require MFA for enabled users
[22m[39m[TEST UTILS] MFA Secret verified for 902a02b6768e2afbf86755434d9b7871

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould reject access with malformed Authorization header
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335781939,"env":"test","module":"auth-routes","userId":"8c0bfc9c-5be3-42d2-97c8-d442a8e946f7","msg":"User logged in successfully"}
{"level":30,"time":1768335781991,"env":"test","module":"audit-log-service","userId":"8c0bfc9c-5be3-42d2-97c8-d442a8e946f7","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768335782032,"env":"test","module":"auth-routes","email":"test-1768335780862-ggznnm@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768335782079,"env":"test","module":"user-credentials-repository","userId":"C3TquG09rbhHepRXhXjue","msg":"User credentials created"}
{"level":50,"time":1768335782101,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould require MFA for enabled users
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768335782107,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335782116,"env":"test","module":"auth-routes","userId":"f594f66f-1ab2-46f2-88c5-20ba9c711d92","msg":"User logged in successfully"}
{"level":50,"time":1768335782131,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335782146,"env":"test","module":"auth-routes","userId":"7f1f683a-e18a-4973-bbd8-1e9e6daebf35","msg":"User logged in successfully"}
{"level":30,"time":1768335782164,"env":"test","module":"audit-log-service","userId":"f594f66f-1ab2-46f2-88c5-20ba9c711d92","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335782198,"env":"test","module":"audit-log-service","userId":"7f1f683a-e18a-4973-bbd8-1e9e6daebf35","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould convert placeholder user to real user on accept
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.acceptInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:797:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:203:13
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335782257,"env":"test","module":"auth-routes","userId":"f66b82ff0b076c7aab9e1cb390ddb7fe","msg":"Login requires MFA verification"}
{"level":30,"time":1768335782261,"env":"test","module":"auth-routes","userId":"bf6c8ee373aa34a61f9830421824eb2d","msg":"User logged in successfully"}
{"level":30,"time":1768335782312,"env":"test","module":"audit-log-service","userId":"bf6c8ee373aa34a61f9830421824eb2d","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould login with backup code when TOTP unavailable
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335782361,"env":"test","module":"mfa-service","userId":"f66b82ff0b076c7aab9e1cb390ddb7fe","msg":"TOTP verification successful"}
{"level":30,"time":1768335782367,"env":"test","module":"auth-routes","userId":"4b172bcd-0105-48fe-ac38-fa07438b87db","msg":"User logged in successfully"}
{"level":30,"time":1768335782413,"env":"test","module":"auth-routes","userId":"f66b82ff0b076c7aab9e1cb390ddb7fe","msg":"MFA login successful"}
{"level":30,"time":1768335782419,"env":"test","module":"audit-log-service","userId":"4b172bcd-0105-48fe-ac38-fa07438b87db","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768335782422,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335782454,"env":"test","module":"user-credentials-repository","userId":"88j-m47WYtSizc5OwYMdF","msg":"User credentials created"}
{"level":30,"time":1768335782490,"env":"test","module":"user-credentials-repository","userId":"275a8ad3-c7bc-408b-915b-6db05e3e7fcf","msg":"User credentials created"}
{"level":30,"time":1768335782507,"env":"test","module":"auth-service","tokenHash":"2fe6f7ff0fa9bd1ee1eb2b4de4567a52a13546270f31f9607e884393806b0e0c","plainTokenLen":19,"msg":"DEBUG: rotateRefreshToken called"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould prevent transfer to org if user is not a member
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:130:30
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":50,"time":1768335782511,"env":"test","module":"auth-routes","email":"test-1768335780862-ggznnm@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":40,"time":1768335782558,"env":"test","module":"auth-service","tokenHash":"2fe6f7ff0fa9bd1ee1eb2b4de4567a52a13546270f31f9607e884393806b0e0c","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768335782567,"env":"test","module":"auth-routes","userId":"f66b82ff0b076c7aab9e1cb390ddb7fe","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768335782570,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335782571,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335782602,"env":"test","module":"auth-routes","userId":"902a02b6768e2afbf86755434d9b7871","msg":"Login requires MFA verification"}
{"level":30,"time":1768335782603,"env":"test","module":"email-queue","jobId":"5cd7f1df-3753-4388-82c2-808f329e4d08","to":"jwt-test-oG-pozpxTbFgknh5oZGUr@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768335782615,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335782643,"env":"test","module":"user-credentials-repository","userId":"db17844e-524d-49cb-ae71-fe351f504b97","msg":"User credentials created"}
{"level":30,"time":1768335782655,"env":"test","module":"auth-routes","userId":"275a8ad3-c7bc-408b-915b-6db05e3e7fcf","email":"jwt-test-oG-pozpxTbFgknh5oZGUr@example.com","msg":"User registered"}
{"level":30,"time":1768335782677,"env":"test","module":"auth-routes","userId":"f66b82ff0b076c7aab9e1cb390ddb7fe","deviceCount":1,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mJWT Token Validation[2m > [22m[2mshould accept request with missing Bearer prefix (lenient)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335782743,"env":"test","module":"email-queue","jobId":"791721e3-2d78-4356-a15e-4ec7befef201","to":"session-test-_UcD1ezFtiXAzzkmCmATj@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335782791,"env":"test","module":"auth-routes","userId":"db17844e-524d-49cb-ae71-fe351f504b97","email":"session-test-_UcD1ezFtiXAzzkmCmATj@example.com","msg":"User registered"}
{"level":30,"time":1768335782823,"env":"test","module":"auth-routes","userId":"ea270cf7141e3398de14c88467c46739","msg":"User logged in successfully"}
{"level":30,"time":1768335782864,"env":"test","module":"user-credentials-repository","userId":"9ddde545-f3b8-4075-bee5-27e8e08b6223","msg":"User credentials created"}
{"level":30,"time":1768335782873,"env":"test","module":"audit-log-service","userId":"ea270cf7141e3398de14c88467c46739","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335782879,"env":"test","module":"auth-routes","userId":"d017e08aaa9729063672b531bcde7604","msg":"User logged in successfully"}
 [31mâ¯[39m tests/integration/api.templates-runs.test.ts [2m([22m[2m15 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 7386[2mms[22m[39m
         [32mâœ“[39m should create template with file upload[32m 167[2mms[22m[39m
         [32mâœ“[39m should reject non-docx files[32m 153[2mms[22m[39m
         [32mâœ“[39m should reject without file[32m 107[2mms[22m[39m
         [33m[2mâœ“[22m[39m should list templates [33m 324[2mms[22m[39m
         [32mâœ“[39m should get template by ID[32m 257[2mms[22m[39m
         [32mâœ“[39m should extract placeholders[32m 264[2mms[22m[39m
         [33m[2mâœ“[22m[39m should update template name [33m 306[2mms[22m[39m
         [33m[2mâœ“[22m[39m should delete template [33m 416[2mms[22m[39m
         [32mâœ“[39m should execute workflow[32m 278[2mms[22m[39m
         [32mâœ“[39m should include logs in debug mode[32m 256[2mms[22m[39m
[31m         [31mÃ—[31m should reject without required permission[39m[32m 11[2mms[22m[39m
         [33m[2mâœ“[22m[39m should list runs [33m 370[2mms[22m[39m
         [33m[2mâœ“[22m[39m should filter by workflowId [33m 368[2mms[22m[39m
         [33m[2mâœ“[22m[39m should get run by ID [33m 418[2mms[22m[39m
         [33m[2mâœ“[22m[39m should get run logs [33m 478[2mms[22m[39m
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335782930,"env":"test","module":"audit-log-service","userId":"d017e08aaa9729063672b531bcde7604","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335782941,"env":"test","module":"auth-service","allTokensCount":2988,"sampleToken":"2b484d683e217a5794883c3321285a69f23da26d5e0f749725f993d77b121982","msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768335782970,"env":"test","module":"email-queue","jobId":"e0dfc987-a9e3-4d32-90b0-8146c92f5f56","to":"protected-test-qb4oppnELoGaPjyydMcwy@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335782982,"env":"test","module":"auth-routes","userId":"bf6c8ee373aa34a61f9830421824eb2d","sessionCount":2,"msg":"Listed active sessions"}
{"level":30,"time":1768335783020,"env":"test","module":"auth-routes","userId":"9ddde545-f3b8-4075-bee5-27e8e08b6223","email":"protected-test-qb4oppnELoGaPjyydMcwy@example.com","msg":"User registered"}
{"level":50,"time":1768335783024,"env":"test","module":"auth-routes","email":"test-1768335780862-ggznnm@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould reject access with wrong token type
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768335783129,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould require MFA for enabled users
[22m[39mError deleting test user 902a02b6768e2afbf86755434d9b7871: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/mfa.flow.real.test.ts:46:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mupdateOrganization[2m > [22m[2mshould allow admin to update organization
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:121:25
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

[90mstderr[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39mError deleting test user f66b82ff0b076c7aab9e1cb390ddb7fe: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/trusted.devices.real.test.ts:45:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335783238,"env":"test","module":"auth-routes","userId":"275a8ad3-c7bc-408b-915b-6db05e3e7fcf","msg":"User logged in successfully"}
{"level":30,"time":1768335783291,"env":"test","module":"audit-log-service","userId":"275a8ad3-c7bc-408b-915b-6db05e3e7fcf","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768335783317,"env":"test","module":"auth-middleware","error":{"name":"TokenExpiredError","code":"AUTH_002","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768335783318,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335783332,"env":"test","module":"user-credentials-repository","userId":"lztB0apVpJHlFRao7VQLc","msg":"User credentials created"}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

{"level":40,"time":1768335783396,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768335783396,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335783397,"env":"test","module":"auth-routes","userId":"db17844e-524d-49cb-ae71-fe351f504b97","msg":"User logged in successfully"}
{"level":30,"time":1768335783442,"env":"test","module":"auth-service","tokenHash":"719d4f34fd9de961e8180db389d381f3f2fb25ec3f7287005acb16280bd0a506","plainTokenLen":17,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768335783447,"env":"test","module":"audit-log-service","userId":"db17844e-524d-49cb-ae71-fe351f504b97","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335783470,"env":"test","module":"mfa-service","userId":"d017e08aaa9729063672b531bcde7604","count":10,"msg":"Stored backup codes"}
{"level":30,"time":1768335783470,"env":"test","module":"mfa-service","userId":"d017e08aaa9729063672b531bcde7604","msg":"Generated TOTP secret"}
{"level":30,"time":1768335783470,"env":"test","module":"auth-routes","userId":"d017e08aaa9729063672b531bcde7604","msg":"MFA setup initiated"}
{"level":40,"time":1768335783489,"env":"test","module":"auth-service","tokenHash":"719d4f34fd9de961e8180db389d381f3f2fb25ec3f7287005acb16280bd0a506","msg":"Security: Unknown refresh token used (Not Found in DB)"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mError deleting test user ea270cf7141e3398de14c88467c46739: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/session.management.real.test.ts:44:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject expired invite
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:52:21 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":50,"time":1768335783561,"env":"test","module":"auth-routes","email":"test-1768335780862-ggznnm@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":50,"time":1768335783660,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould allow org member to transfer org-owned project to another org they belong to
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:56:21 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335783720,"env":"test","module":"auth-routes","userId":"9ddde545-f3b8-4075-bee5-27e8e08b6223","msg":"User logged in successfully"}
{"level":30,"time":1768335783749,"env":"test","module":"user-credentials-repository","userId":"d6b328fc-8b8e-4068-872c-a9c0a49a7af7","msg":"User credentials created"}
{"level":30,"time":1768335783768,"env":"test","module":"audit-log-service","userId":"9ddde545-f3b8-4075-bee5-27e8e08b6223","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768335783775,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768335783775,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335783780,"env":"test","module":"mfa-service","userId":"d017e08aaa9729063672b531bcde7604","msg":"MFA enabled successfully"}
{"level":30,"time":1768335783780,"env":"test","module":"auth-routes","userId":"d017e08aaa9729063672b531bcde7604","msg":"MFA enabled successfully"}
{"level":30,"time":1768335783830,"env":"test","module":"audit-log-service","userId":"d017e08aaa9729063672b531bcde7604","eventType":"mfa_enabled","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould login with backup code when TOTP unavailable
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335783850,"env":"test","module":"email-queue","jobId":"c4958b7b-ad55-4f42-841d-91504529d8c3","to":"middleware-test-8HaXfAqMLmgrkWuBZQ4ty@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335783900,"env":"test","module":"auth-routes","userId":"d6b328fc-8b8e-4068-872c-a9c0a49a7af7","email":"middleware-test-8HaXfAqMLmgrkWuBZQ4ty@example.com","msg":"User registered"}
{"level":30,"time":1768335783940,"env":"test","module":"auth-routes","userId":"db17844e-524d-49cb-ae71-fe351f504b97","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould authenticate with JWT Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould complete MFA login with valid TOTP
[22m[39m[TEST UTILS] MFA Secret verified for c0bcf1e947e73d2f48ab5155a80682fa

{"level":30,"time":1768335783993,"env":"test","module":"audit-log-service","userId":"db17844e-524d-49cb-ae71-fe351f504b97","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for user
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39m[TEST UTILS] MFA Secret verified for 8f7ce4a7daee82aed87c64382512c51c

{"level":50,"time":1768335784073,"env":"test","module":"auth-routes","email":"test-1768335780862-ggznnm@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768335784097,"env":"test","module":"email-queue","jobId":"cb7f19d1-86c8-4ca8-8958-a790fbec34ea","to":"existing_1768335765585@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335784171,"env":"test","module":"auth-service","allTokensCount":2995,"sampleToken":"2b484d683e217a5794883c3321285a69f23da26d5e0f749725f993d77b121982","msg":"DEBUG: Tokens in DB"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject expired invite
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:548:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:215:34
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335784214,"env":"test","module":"user-credentials-repository","userId":"f447e0a5-9dc9-472f-b1fd-eb02f7620c01","msg":"User credentials created"}
[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould complete MFA login with valid TOTP
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768335784274,"env":"test","module":"account-lockout","userId":"1f84dc04457e5b24a43b5b797b6d232d","email":"test-1768335780862-ggznnm@example.com","lockedUntil":"2026-01-13T20:38:04.225Z","msg":"Account locked due to too many failed attempts"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768335784274,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335784312,"env":"test","module":"email-queue","jobId":"69bf1228-299b-4e4f-ac49-fd57b5689d17","to":"protected-test-E66lP7aXCrD-Dh1H4SDSg@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335784336,"env":"test","module":"auth-routes","userId":"d017e08aaa9729063672b531bcde7604","msg":"Login requires MFA verification"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mupdateOrganization[2m > [22m[2mshould deny non-admin from updating organization
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:138:25
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335784361,"env":"test","module":"auth-routes","userId":"f447e0a5-9dc9-472f-b1fd-eb02f7620c01","email":"protected-test-E66lP7aXCrD-Dh1H4SDSg@example.com","msg":"User registered"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mError deleting test user bf6c8ee373aa34a61f9830421824eb2d: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/session.management.real.test.ts:44:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":40,"time":1768335784373,"env":"test","module":"auth-routes","userId":"1f84dc04457e5b24a43b5b797b6d232d","email":"test-1768335780862-ggznnm@example.com","msg":"Login blocked: account locked"}
{"level":50,"time":1768335784374,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mLogin Failed DEBUG: AccountLockedError: Account is locked until 2026-01-13T20:38:04.225Z
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:58:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: [32m'AUTH_005'[39m,
  statusCode: [33m423[39m,
  isOperational: [33mtrue[39m,
  lockedUntil: [35m2026-01-13T20:38:04.225Z[39m,
  remainingMinutes: [33m15[39m
}

{"level":50,"time":1768335784373,"env":"test","module":"auth-routes","error":{"name":"AccountLockedError","code":"AUTH_005","statusCode":423,"isOperational":true,"lockedUntil":"2026-01-13T20:38:04.225Z","remainingMinutes":15},"msg":"Login failed"}
{"level":30,"time":1768335784437,"env":"test","module":"auth-routes","userId":"d6b328fc-8b8e-4068-872c-a9c0a49a7af7","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPOST Protected Routes[2m > [22m[2mshould allow POST with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335784484,"env":"test","module":"audit-log-service","userId":"d6b328fc-8b8e-4068-872c-a9c0a49a7af7","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768335784503,"env":"test","module":"auth-middleware","error":{"name":"TokenExpiredError","code":"AUTH_002","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768335784503,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335784519,"env":"test","module":"user-credentials-repository","userId":"ZJqUbtifhY4IF-uIeJk3h","msg":"User credentials created"}
{"level":30,"time":1768335784519,"env":"test","module":"auth-routes","userId":"db17844e-524d-49cb-ae71-fe351f504b97","msg":"User logged in successfully"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould allow org member to transfer org-owned project to another org they belong to
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:153:26
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335784553,"env":"test","module":"mfa-service","userId":"d017e08aaa9729063672b531bcde7604","msg":"Backup code verified and consumed"}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w19
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":30,"time":1768335784574,"env":"test","module":"audit-log-service","userId":"db17844e-524d-49cb-ae71-fe351f504b97","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335784607,"env":"test","module":"auth-routes","userId":"d017e08aaa9729063672b531bcde7604","msg":"MFA login successful"}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w19 (Reused: true)

{"level":30,"time":1768335784608,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould login with backup code when TOTP unavailable
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335784617,"env":"test","module":"auth-service","tokenHash":"666a194cf8d324a0cd1e2181fbabe27e9cb1b588e6abb6ebd5559d721bc40353","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768335784649,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":40,"time":1768335784665,"env":"test","module":"auth-service","userId":"ZJqUbtifhY4IF-uIeJk3h","tokenHash":"666a194cf8d324a0cd1e2181fbabe27e9cb1b588e6abb6ebd5559d721bc40353","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768335784691,"env":"test","module":"auth-routes","userId":"db17844e-524d-49cb-ae71-fe351f504b97","sessionCount":3,"msg":"Listed active sessions"}
[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w18
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":30,"time":1768335784761,"env":"test","module":"auth-routes","userId":"c0bcf1e947e73d2f48ab5155a80682fa","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w18 (Reused: true)

{"level":30,"time":1768335784802,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335784875,"env":"test","module":"mfa-service","userId":"c0bcf1e947e73d2f48ab5155a80682fa","msg":"TOTP verification successful"}
{"level":30,"time":1768335784881,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335784894,"env":"test","module":"auth-routes","userId":"8f7ce4a7daee82aed87c64382512c51c","msg":"Login requires MFA verification"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mError deleting test user 1f84dc04457e5b24a43b5b797b6d232d: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth.routes.real.test.ts:54:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335784927,"env":"test","module":"auth-routes","userId":"c0bcf1e947e73d2f48ab5155a80682fa","msg":"MFA login successful"}
{"level":30,"time":1768335785001,"env":"test","module":"mfa-service","userId":"8f7ce4a7daee82aed87c64382512c51c","msg":"TOTP verification successful"}
{"level":30,"time":1768335785039,"env":"test","module":"user-credentials-repository","userId":"95af0611-7fa2-40cf-b530-0ebf5dc21354","msg":"User credentials created"}
{"level":30,"time":1768335785054,"env":"test","module":"auth-routes","userId":"8f7ce4a7daee82aed87c64382512c51c","msg":"MFA login successful"}
{"level":30,"time":1768335785062,"env":"test","module":"auth-routes","userId":"f447e0a5-9dc9-472f-b1fd-eb02f7620c01","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335785113,"env":"test","module":"audit-log-service","userId":"f447e0a5-9dc9-472f-b1fd-eb02f7620c01","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335785115,"env":"test","module":"user-credentials-repository","userId":"58b0426c-d7b6-43a7-880d-0e03113f0cbc","msg":"User credentials created"}
{"level":30,"time":1768335785127,"env":"test","module":"user-credentials-repository","userId":"zNrVGEplYjXxiiZMCi-Nu","msg":"User credentials created"}
{"level":30,"time":1768335785140,"env":"test","module":"email-queue","jobId":"d8c82469-4384-43f1-8a3a-9f805c16127e","to":"middleware-test-40gZ8XkbuAYSTeTcq17qX@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335785164,"env":"test","module":"auth-routes","userId":"d017e08aaa9729063672b531bcde7604","msg":"Login requires MFA verification"}
{"level":30,"time":1768335785187,"env":"test","module":"auth-routes","userId":"95af0611-7fa2-40cf-b530-0ebf5dc21354","email":"middleware-test-40gZ8XkbuAYSTeTcq17qX@example.com","msg":"User registered"}
{"level":30,"time":1768335785214,"env":"test","module":"auth-routes","userId":"8f7ce4a7daee82aed87c64382512c51c","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768335785221,"env":"test","module":"email-queue","jobId":"79829a1a-effa-404f-8760-90b0fc2d313d","to":"session-test-KDa5gAnVhgXXlq1fVD4KC@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould authenticate with refresh token cookie (GET only)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335785249,"env":"test","module":"auth-service","tokenHash":"3e396a2b462dd6e76539f75dff5b30da22eba6db1bbf16cbf1a4f2dc1ab0d429","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768335785275,"env":"test","module":"auth-routes","userId":"58b0426c-d7b6-43a7-880d-0e03113f0cbc","email":"session-test-KDa5gAnVhgXXlq1fVD4KC@example.com","msg":"User registered"}
{"level":40,"time":1768335785302,"env":"test","module":"auth-service","tokenHash":"3e396a2b462dd6e76539f75dff5b30da22eba6db1bbf16cbf1a4f2dc1ab0d429","msg":"Security: Unknown refresh token used (Not Found in DB)"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mgetOrganizationMembers[2m > [22m[2mshould return all members of organization
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:159:25
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335785374,"env":"test","module":"auth-routes","userId":"8f7ce4a7daee82aed87c64382512c51c","deviceCount":0,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould mark current session correctly
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335785391,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768335785411,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.workflows.test.ts[2m > [22m[2mWorkflows API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs
[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768335785399,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768335785400,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768335785405,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768335785411,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768335785411,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768335785411,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768335785411,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould complete MFA login with valid TOTP
[22m[39mError deleting test user c0bcf1e947e73d2f48ab5155a80682fa: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/mfa.flow.real.test.ts:46:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335785501,"env":"test","module":"auth-service","allTokensCount":3005,"sampleToken":"2b484d683e217a5794883c3321285a69f23da26d5e0f749725f993d77b121982","msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768335785564,"env":"test","module":"user-credentials-repository","userId":"b0607f6f-6a8f-4990-844b-3f09f4e08e7a","msg":"User credentials created"}
{"level":30,"time":1768335785568,"env":"test","module":"auth-routes","userId":"d2bf79c23606c01e30c1c9e8eb35c462","msg":"User logged in successfully"}
{"level":40,"time":1768335785609,"env":"test","module":"auth-middleware","error":{"name":"TokenExpiredError","code":"AUTH_002","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768335785609,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335785622,"env":"test","module":"audit-log-service","userId":"d2bf79c23606c01e30c1c9e8eb35c462","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/logout[2m > [22m[2mshould logout and clear refresh token cookie
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335785661,"env":"test","module":"email-queue","jobId":"641eb814-f1c5-4b61-af0e-7d66b042e93e","to":"protected-test-evRbSXTu3zzR4UJdW67F-@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject already accepted invite
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:52:21 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335785712,"env":"test","module":"auth-routes","userId":"b0607f6f-6a8f-4990-844b-3f09f4e08e7a","email":"protected-test-evRbSXTu3zzR4UJdW67F-@example.com","msg":"User registered"}
{"level":30,"time":1768335785719,"env":"test","module":"auth-routes","userId":"95af0611-7fa2-40cf-b530-0ebf5dc21354","msg":"User logged in successfully"}
{"level":30,"time":1768335785771,"env":"test","module":"audit-log-service","userId":"95af0611-7fa2-40cf-b530-0ebf5dc21354","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768335785778,"env":"test","module":"mfa-service","userId":"d017e08aaa9729063672b531bcde7604","msg":"Invalid backup code provided"}
{"level":40,"time":1768335785778,"env":"test","module":"auth-routes","userId":"d017e08aaa9729063672b531bcde7604","msg":"MFA verification failed during login"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPOST Protected Routes[2m > [22m[2mshould reject POST without Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335785835,"env":"test","module":"user-credentials-repository","userId":"vL3moTVrXZp6agq7KXVIP","msg":"User credentials created"}
{"level":30,"time":1768335785858,"env":"test","module":"auth-routes","userId":"58b0426c-d7b6-43a7-880d-0e03113f0cbc","msg":"User logged in successfully"}
{"level":30,"time":1768335785889,"env":"test","module":"user-credentials-repository","userId":"954ef1b8-1572-4c6d-8069-f93b3c874213","msg":"User credentials created"}
{"level":30,"time":1768335785892,"env":"test","module":"auth-service","tokenHash":"c8815c799681421e913f0db7f12ce2d05870913269a5c314ad85a570c89e1a93","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768335785908,"env":"test","module":"audit-log-service","userId":"58b0426c-d7b6-43a7-880d-0e03113f0cbc","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould mark current session correctly
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39mError deleting test user 8f7ce4a7daee82aed87c64382512c51c: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/trusted.devices.real.test.ts:45:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335785987,"env":"test","module":"email-queue","jobId":"4335154e-437e-4fb2-84a1-8530490c2a1b","to":"test-o0TEmKoPFX7t2nFZMIL0Q@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould detach workflow from project when transferring to different owner
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:56:21 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335786044,"env":"test","module":"auth-routes","userId":"954ef1b8-1572-4c6d-8069-f93b3c874213","email":"test-o0TEmKoPFX7t2nFZMIL0Q@example.com","msg":"User registered"}
{"level":30,"time":1768335786096,"env":"test","module":"auth-routes","userId":"d2bf79c23606c01e30c1c9e8eb35c462","msg":"User logged in successfully"}
{"level":30,"time":1768335786109,"env":"test","module":"auth-routes","userId":"9707a1e0c486ee191322960faa6aee1a","msg":"User logged in successfully"}
{"level":30,"time":1768335786147,"env":"test","module":"audit-log-service","userId":"d2bf79c23606c01e30c1c9e8eb35c462","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335786160,"env":"test","module":"audit-log-service","userId":"9707a1e0c486ee191322960faa6aee1a","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335786239,"env":"test","module":"email-queue","jobId":"662e9372-2c1e-4d62-adcb-08dd1b3fa46e","to":"existing_1768335765585@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
{"level":30,"time":1768335786258,"env":"test","module":"auth-routes","userId":"d2bf79c23606c01e30c1c9e8eb35c462","sessionCount":2,"msg":"Listed active sessions"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould reject invalid TOTP during login
[22m[39m[TEST UTILS] MFA Secret verified for ef4303b227cb6aee7b3b87d01a0fb270

{"level":30,"time":1768335786301,"env":"test","module":"user-credentials-repository","userId":"4561ecbf-dea6-493e-afc9-853fee9ef651","msg":"User credentials created"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould login with backup code when TOTP unavailable
[22m[39mError deleting test user d017e08aaa9729063672b531bcde7604: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth.flows.real.test.ts:47:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335786332,"env":"test","module":"auth-routes","userId":"b0607f6f-6a8f-4990-844b-3f09f4e08e7a","msg":"User logged in successfully"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject already accepted invite
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:548:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:240:34
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335786381,"env":"test","module":"audit-log-service","userId":"b0607f6f-6a8f-4990-844b-3f09f4e08e7a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768335786385,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335786395,"env":"test","module":"auth-routes","userId":"58b0426c-d7b6-43a7-880d-0e03113f0cbc","msg":"User logged in successfully"}
{"level":30,"time":1768335786396,"env":"test","module":"email-queue","jobId":"380dc50e-87bf-4556-a6dd-13755b2a92af","to":"middleware-test-7xhT2jwSD_igNIcnGHAgt@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335786423,"env":"test","module":"auth-routes","userId":"d2bf79c23606c01e30c1c9e8eb35c462","sessionId":"265f037d-db18-44ff-b84e-09a3d15b0d8e","msg":"Session revoked"}
{"level":30,"time":1768335786449,"env":"test","module":"auth-routes","userId":"4561ecbf-dea6-493e-afc9-853fee9ef651","email":"middleware-test-7xhT2jwSD_igNIcnGHAgt@example.com","msg":"User registered"}
{"level":30,"time":1768335786449,"env":"test","module":"audit-log-service","userId":"58b0426c-d7b6-43a7-880d-0e03113f0cbc","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335786495,"env":"test","module":"user-credentials-repository","userId":"bReM8_Fwwpicb6iXYsrRM","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for POST requests (mutation-strict)
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould reject invalid TOTP during login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335786546,"env":"test","module":"user-credentials-repository","userId":"d223192a-b901-45c3-b5f3-79ade5d46a27","msg":"User credentials created"}
{"level":30,"time":1768335786551,"env":"test","module":"auth-service","tokenHash":"b11210a5ddee1db1b76f54cffdd90c477e6bce1517d8f173b652d7471f01b24a","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768335786552,"env":"test","module":"auth-routes","userId":"58b0426c-d7b6-43a7-880d-0e03113f0cbc","sessionCount":2,"msg":"Listed active sessions"}
{"level":30,"time":1768335786552,"env":"test","module":"auth-service","tokenHash":"b11210a5ddee1db1b76f54cffdd90c477e6bce1517d8f173b652d7471f01b24a","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768335786579,"env":"test","module":"auth-routes","userId":"d2bf79c23606c01e30c1c9e8eb35c462","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768335786649,"env":"test","module":"email-queue","jobId":"82d91b2a-c4cd-4a32-aef2-d850e0eb0512","to":"jwt-test-db1T3o_kf9U84rPERoZ6a@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for edaa6c2b0ba25ee433d7909401e8b099

{"level":30,"time":1768335786698,"env":"test","module":"auth-routes","userId":"d223192a-b901-45c3-b5f3-79ade5d46a27","email":"jwt-test-db1T3o_kf9U84rPERoZ6a@example.com","msg":"User registered"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mpromoteMember[2m > [22m[2mshould allow admin to promote member
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:178:25
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335786762,"env":"test","module":"user-credentials-repository","userId":"e121d54f-8163-4d32-b3e1-692697222e73","msg":"User credentials created"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/logout[2m > [22m[2mshould logout and clear refresh token cookie
[22m[39mError deleting test user 9707a1e0c486ee191322960faa6aee1a: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth.routes.real.test.ts:54:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":50,"time":1768335786864,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335786864,"env":"test","module":"email-queue","jobId":"a4988f35-f724-4029-8b6b-84b3c381fb73","to":"protected-test-OqvX7M4IhEObzauwKFYyQ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":40,"time":1768335786910,"env":"test","module":"auth-service","userId":"bReM8_Fwwpicb6iXYsrRM","tokenHash":"b11210a5ddee1db1b76f54cffdd90c477e6bce1517d8f173b652d7471f01b24a","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768335786915,"env":"test","module":"auth-routes","userId":"e121d54f-8163-4d32-b3e1-692697222e73","email":"protected-test-OqvX7M4IhEObzauwKFYyQ@example.com","msg":"User registered"}
{"level":30,"time":1768335786974,"env":"test","module":"user-credentials-repository","userId":"b66d64a5-9cd9-433a-b2bb-c8e76e58c2d1","msg":"User credentials created"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335787012,"env":"test","module":"auth-routes","userId":"4561ecbf-dea6-493e-afc9-853fee9ef651","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPOST Protected Routes[2m > [22m[2mshould reject POST with invalid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335787043,"env":"test","module":"auth-routes","userId":"ef4303b227cb6aee7b3b87d01a0fb270","msg":"Login requires MFA verification"}
{"level":30,"time":1768335787063,"env":"test","module":"audit-log-service","userId":"4561ecbf-dea6-493e-afc9-853fee9ef651","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768335787069,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335787076,"env":"test","module":"email-queue","jobId":"9f5e5aa4-316f-4594-aa5d-1603f8aa0193","to":"session-test-3GWyMB941VI83JfNV_DVI@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335787090,"env":"test","module":"user-credentials-repository","userId":"4c0893a6-8f55-4967-bf1e-7270a0cf696e","msg":"User credentials created"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject already accepted invite
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.acceptInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:797:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:247:13
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould revoke specific session
[22m[39mError deleting test user d2bf79c23606c01e30c1c9e8eb35c462: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/session.management.real.test.ts:44:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":40,"time":1768335787147,"env":"test","module":"mfa-service","userId":"ef4303b227cb6aee7b3b87d01a0fb270","msg":"TOTP verification failed"}
{"level":40,"time":1768335787147,"env":"test","module":"auth-routes","userId":"ef4303b227cb6aee7b3b87d01a0fb270","msg":"MFA verification failed during login"}
{"level":30,"time":1768335787155,"env":"test","module":"auth-routes","userId":"b66d64a5-9cd9-433a-b2bb-c8e76e58c2d1","email":"session-test-3GWyMB941VI83JfNV_DVI@example.com","msg":"User registered"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mpromoteMember[2m > [22m[2mshould allow admin to promote member
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.promoteMember (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:246:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:185:13
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335787192,"env":"test","module":"email-queue","jobId":"9dd11d2e-6cf6-4b2e-bba0-fd9acd958cc7","to":"viewer-1p5UOY3V9BBxyEMpUcnLL@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335787209,"env":"test","module":"email-queue","jobId":"7203373c-fd3d-4eec-8765-ee4a6edb7d3a","to":"test-1768335786318-a4vdcp@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335787209,"env":"test","module":"auth-service","email":"test-1768335786318-a4vdcp@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768335787243,"env":"test","module":"auth-routes","userId":"4c0893a6-8f55-4967-bf1e-7270a0cf696e","email":"viewer-1p5UOY3V9BBxyEMpUcnLL@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould not include revoked sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335787266,"env":"test","module":"user-credentials-repository","userId":"6a8137c5-dd60-4b9a-949f-38dc5e5e9bb1","msg":"User credentials created"}
{"level":30,"time":1768335787305,"env":"test","module":"user-credentials-repository","userId":"l1ie5lVbXgBGZRBr3lpmJ","msg":"User credentials created"}
{"level":40,"time":1768335787342,"env":"test","module":"rbac-middleware","userId":"4c0893a6-8f55-4967-bf1e-7270a0cf696e","userRole":"viewer","permission":"workflow:create","path":"/projects/21f73a8c-8b38-4d69-9a48-77e594f1977b/workflows","msg":"Permission denied"}
{"level":30,"time":1768335787359,"env":"test","module":"auth-service","tokenHash":"eca0dfd40c33bf5e2e4ddeca04135d48fd217cd2d8ef88d06eaab3d313702c4a","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768335787360,"env":"test","module":"email-queue","jobId":"d47a0f7c-5a61-46de-8d96-ed40170b909c","to":"user1-jTQTTdM900stEdD-jmMlh@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335787451,"env":"test","module":"auth-routes","userId":"6a8137c5-dd60-4b9a-949f-38dc5e5e9bb1","email":"user1-jTQTTdM900stEdD-jmMlh@example.com","msg":"User registered"}
{"level":30,"time":1768335787458,"env":"test","module":"user-credentials-repository","userId":"4881f673-a767-4900-8fad-bffb4afb1347","msg":"User credentials created"}
{"level":30,"time":1768335787460,"env":"test","module":"auth-routes","userId":"edaa6c2b0ba25ee433d7909401e8b099","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/refresh-token[2m > [22m[2mshould refresh access token with valid refresh token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335787506,"env":"test","module":"email-queue","jobId":"5824f05c-a5e1-4ce2-b393-dd53433469d1","to":"test-1768335786318-a4vdcp@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335787507,"env":"test","module":"auth-service","email":"test-1768335786318-a4vdcp@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768335787558,"env":"test","module":"auth-routes","userId":"e121d54f-8163-4d32-b3e1-692697222e73","msg":"User logged in successfully"}
{"level":30,"time":1768335787559,"env":"test","module":"email-queue","jobId":"ab698c43-a89d-4411-af5e-36cf43c536d1","to":"middleware-test-thHFVTIHQ2gsJOhJaw-yN@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335787563,"env":"test","module":"mfa-service","userId":"edaa6c2b0ba25ee433d7909401e8b099","msg":"TOTP verification successful"}
{"level":30,"time":1768335787608,"env":"test","module":"auth-routes","userId":"4881f673-a767-4900-8fad-bffb4afb1347","email":"middleware-test-thHFVTIHQ2gsJOhJaw-yN@example.com","msg":"User registered"}
{"level":30,"time":1768335787607,"env":"test","module":"audit-log-service","userId":"e121d54f-8163-4d32-b3e1-692697222e73","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768335787613,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335787615,"env":"test","module":"auth-routes","userId":"edaa6c2b0ba25ee433d7909401e8b099","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for PUT requests
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould reject invalid TOTP during login
[22m[39mError deleting test user ef4303b227cb6aee7b3b87d01a0fb270: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/mfa.flow.real.test.ts:46:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335787733,"env":"test","module":"auth-routes","userId":"b66d64a5-9cd9-433a-b2bb-c8e76e58c2d1","msg":"User logged in successfully"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould keep workflow in project when transferring to same owner
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:56:21 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335787772,"env":"test","module":"auth-routes","userId":"edaa6c2b0ba25ee433d7909401e8b099","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768335787785,"env":"test","module":"audit-log-service","userId":"b66d64a5-9cd9-433a-b2bb-c8e76e58c2d1","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould not include revoked sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking current session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335787840,"env":"test","module":"user-credentials-repository","userId":"419fad45-662a-42cc-9d65-dfa32c679a3d","msg":"User credentials created"}
{"level":30,"time":1768335787879,"env":"test","module":"user-credentials-repository","userId":"5E4RUFubzEUpDML0Gihc9","msg":"User credentials created"}
{"level":30,"time":1768335787893,"env":"test","module":"user-credentials-repository","userId":"8cf3dea680123f21308b8bcdac4e6e83","msg":"User password updated"}
{"level":30,"time":1768335787919,"env":"test","module":"auth-routes","userId":"edaa6c2b0ba25ee433d7909401e8b099","deviceCount":0,"msg":"Listed trusted devices"}
{"level":30,"time":1768335787936,"env":"test","module":"auth-service","tokenHash":"5bb99a1534cbb5551260159a3f1a9a3ae6df0db9f249e1bd7a535fbb523ee13d","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768335787946,"env":"test","module":"email-queue","jobId":"78c4e35a-d336-410b-9702-184557ca5b0a","to":"user2-Dkr4ZhPqfvGogyNC3Zbuv@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335787961,"env":"test","module":"auth-routes","userId":"3f5179493b6ae977b700353dc390716a","msg":"User logged in successfully"}
{"level":30,"time":1768335787995,"env":"test","module":"auth-routes","userId":"419fad45-662a-42cc-9d65-dfa32c679a3d","email":"user2-Dkr4ZhPqfvGogyNC3Zbuv@example.com","msg":"User registered"}
{"level":30,"time":1768335788001,"env":"test","module":"user-credentials-repository","userId":"b8b76cee-497a-4372-bce8-0057098d3515","msg":"User credentials created"}
{"level":30,"time":1768335788016,"env":"test","module":"audit-log-service","userId":"3f5179493b6ae977b700353dc390716a","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335788024,"env":"test","module":"auth-service","tokenHash":"9adf947740d6ca094dec3378a243b46e4beeea5d565e69efd25c04f05953271a","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768335788047,"env":"test","module":"audit-log-service","userId":"8cf3dea680123f21308b8bcdac4e6e83","eventType":"password_reset","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mPassword Reset Flow[2m > [22m[2mshould complete full password reset flow
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335788102,"env":"test","module":"email-queue","jobId":"1fdfde58-87bf-4f07-9450-6a3edad6249d","to":"protected-test--uM2_pdfFFyZPg0vwPh8B@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335788142,"env":"test","module":"auth-routes","userId":"4881f673-a767-4900-8fad-bffb4afb1347","msg":"User logged in successfully"}
{"level":30,"time":1768335788155,"env":"test","module":"auth-routes","userId":"b8b76cee-497a-4372-bce8-0057098d3515","email":"protected-test--uM2_pdfFFyZPg0vwPh8B@example.com","msg":"User registered"}
{"level":30,"time":1768335788193,"env":"test","module":"audit-log-service","userId":"4881f673-a767-4900-8fad-bffb4afb1347","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768335788199,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPUT Protected Routes[2m > [22m[2mshould allow PUT with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335788266,"env":"test","module":"auth-routes","userId":"b66d64a5-9cd9-433a-b2bb-c8e76e58c2d1","msg":"User logged in successfully"}
{"level":30,"time":1768335788302,"env":"test","module":"auth-routes","userId":"88764572b748b602b5ca4685d7e0dccd","msg":"User logged in successfully"}
{"level":30,"time":1768335788315,"env":"test","module":"audit-log-service","userId":"b66d64a5-9cd9-433a-b2bb-c8e76e58c2d1","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335788355,"env":"test","module":"audit-log-service","userId":"88764572b748b602b5ca4685d7e0dccd","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould verify email matches invite
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:52:21 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mdemoteMember[2m > [22m[2mshould allow admin to demote other admin
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:196:25
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":50,"time":1768335788423,"env":"test","module":"auth-routes","email":"test-1768335786318-a4vdcp@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768335788425,"env":"test","module":"auth-routes","userId":"b66d64a5-9cd9-433a-b2bb-c8e76e58c2d1","sessionCount":2,"msg":"Listed active sessions"}
{"level":30,"time":1768335788456,"env":"test","module":"user-credentials-repository","userId":"C33P3c83ZYFJPBmXn_t6O","msg":"User credentials created"}
{"level":30,"time":1768335788465,"env":"test","module":"auth-routes","userId":"88764572b748b602b5ca4685d7e0dccd","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768335788473,"env":"test","module":"user-credentials-repository","userId":"4cd8a88e-097e-4650-8742-6acc8a5708aa","msg":"User credentials created"}
[90mstderr[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39mError deleting test user edaa6c2b0ba25ee433d7909401e8b099: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/trusted.devices.real.test.ts:45:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould accept TOTP codes within 60-second window
[22m[39m[TEST UTILS] MFA Secret verified for 57058b610a69cfa853c5f15e086c683b

{"level":30,"time":1768335788505,"env":"test","module":"auth-service","tokenHash":"a947d0dd79e53119502f49d0d0e3f49d3a4f68f68cb1ffec10adcb3eb6d59aca","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":50,"time":1768335788530,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mPassword Reset Flow[2m > [22m[2mshould complete full password reset flow
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mPassword Reset Flow[2m > [22m[2mshould complete full password reset flow
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335788571,"env":"test","module":"email-queue","jobId":"51d885b1-0950-4b24-8280-dc5e8e7daa4a","to":"jwt-test-xORf6KpmEjv0D3z0Mkrpc@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335788579,"env":"test","module":"user-credentials-repository","userId":"c6cc1b9d-81b2-48fe-aa4d-f26970bfb8a7","msg":"User credentials created"}
{"level":30,"time":1768335788585,"env":"test","module":"auth-routes","userId":"b66d64a5-9cd9-433a-b2bb-c8e76e58c2d1","sessionId":"25471ba4-1a6b-4bc1-aadf-b648dac3c8fe","msg":"Session revoked"}
{"level":30,"time":1768335788623,"env":"test","module":"auth-routes","userId":"4cd8a88e-097e-4650-8742-6acc8a5708aa","email":"jwt-test-xORf6KpmEjv0D3z0Mkrpc@example.com","msg":"User registered"}
{"level":50,"time":1768335788626,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335788682,"env":"test","module":"email-queue","jobId":"c08d96c4-f447-4b07-89be-9c64d6b4578a","to":"middleware-test-UCfkIKQXEZtaMSIj4Q3f9@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335788693,"env":"test","module":"auth-routes","userId":"b66d64a5-9cd9-433a-b2bb-c8e76e58c2d1","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768335788734,"env":"test","module":"auth-routes","userId":"c6cc1b9d-81b2-48fe-aa4d-f26970bfb8a7","email":"middleware-test-UCfkIKQXEZtaMSIj4Q3f9@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould accept TOTP codes within 60-second window
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/refresh-token[2m > [22m[2mshould refresh access token with valid refresh token
[22m[39mError deleting test user 3f5179493b6ae977b700353dc390716a: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth.routes.real.test.ts:54:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335788784,"env":"test","module":"auth-routes","userId":"b8b76cee-497a-4372-bce8-0057098d3515","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for DELETE requests
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335788840,"env":"test","module":"audit-log-service","userId":"b8b76cee-497a-4372-bce8-0057098d3515","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mdemoteMember[2m > [22m[2mshould allow admin to demote other admin
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.demoteMember (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:294:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:203:13
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335788924,"env":"test","module":"email-queue","jobId":"4469447f-f69b-4f59-98db-b8e565b01290","to":"existing_1768335765585@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
{"level":30,"time":1768335789004,"env":"test","module":"user-credentials-repository","userId":"9b39fdaa-f7a9-4fec-80ff-7c1e1ea71f95","msg":"User credentials created"}
{"level":30,"time":1768335789017,"env":"test","module":"auth-routes","userId":"8cf3dea680123f21308b8bcdac4e6e83","msg":"User logged in successfully"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould verify email matches invite
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:548:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:256:34
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335789029,"env":"test","module":"user-credentials-repository","userId":"eTKIjKc7Gdvuxjfw-VEJ0","msg":"User credentials created"}
{"level":30,"time":1768335789067,"env":"test","module":"audit-log-service","userId":"8cf3dea680123f21308b8bcdac4e6e83","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335789081,"env":"test","module":"user-credentials-repository","userId":"ed2b53a1-ca2b-4aaf-86e0-61c426a4bdad","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22m[2mOAuth2 Token Refresh Flow[2m > [22m[2mRefresh Token Lifecycle[2m > [22m[2mshould create refresh token on login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335789108,"env":"test","module":"email-queue","jobId":"8f243a6f-ce02-437e-8137-e6e569db1d67","to":"jwt-test-sI2NRVmnwLa4BLJHmbNZi@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking current session
[22m[39mError deleting test user 88764572b748b602b5ca4685d7e0dccd: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/session.management.real.test.ts:44:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335789156,"env":"test","module":"auth-routes","userId":"9b39fdaa-f7a9-4fec-80ff-7c1e1ea71f95","email":"jwt-test-sI2NRVmnwLa4BLJHmbNZi@example.com","msg":"User registered"}
{"level":30,"time":1768335789182,"env":"test","module":"email-queue","jobId":"d26cc449-3f25-470d-a330-cd2da5fd997c","to":"session-test-ZOR2S-8m160uIw9_eIgAG@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mHybrid Authentication Strategy[2m > [22m[2mshould allow GET requests with cookie auth only
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335789231,"env":"test","module":"auth-routes","userId":"57058b610a69cfa853c5f15e086c683b","msg":"Login requires MFA verification"}
{"level":30,"time":1768335789239,"env":"test","module":"auth-routes","userId":"ed2b53a1-ca2b-4aaf-86e0-61c426a4bdad","email":"session-test-ZOR2S-8m160uIw9_eIgAG@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for ee0c495b449ea461b8796dceb83aa655

{"level":30,"time":1768335789267,"env":"test","module":"auth-routes","userId":"c6cc1b9d-81b2-48fe-aa4d-f26970bfb8a7","msg":"User logged in successfully"}
{"level":30,"time":1768335789319,"env":"test","module":"audit-log-service","userId":"c6cc1b9d-81b2-48fe-aa4d-f26970bfb8a7","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768335789325,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335789330,"env":"test","module":"mfa-service","userId":"57058b610a69cfa853c5f15e086c683b","msg":"TOTP verification successful"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335789374,"env":"test","module":"user-credentials-repository","userId":"a17c9f21-4eea-4cd5-967c-1dd30d7d162f","msg":"User credentials created"}
{"level":30,"time":1768335789381,"env":"test","module":"auth-routes","userId":"57058b610a69cfa853c5f15e086c683b","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould accept TOTP codes within 60-second window
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/refresh-token[2m > [22m[2mshould rotate refresh token after use
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould prevent non-member from transferring org workflow
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:56:21 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335789492,"env":"test","module":"email-queue","jobId":"29ab8730-b7bf-4907-bb68-c9cd0afbbd76","to":"protected-test-euqz8WT-qmH14WOdEiHtz@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335789543,"env":"test","module":"auth-routes","userId":"a17c9f21-4eea-4cd5-967c-1dd30d7d162f","email":"protected-test-euqz8WT-qmH14WOdEiHtz@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mPassword Reset Flow[2m > [22m[2mshould complete full password reset flow
[22m[39mError deleting test user 8cf3dea680123f21308b8bcdac4e6e83: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth.flows.real.test.ts:47:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPUT Protected Routes[2m > [22m[2mshould reject PUT without Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335789672,"env":"test","module":"auth-routes","userId":"eTKIjKc7Gdvuxjfw-VEJ0","msg":"User logged in successfully"}
{"level":30,"time":1768335789707,"env":"test","module":"auth-routes","userId":"9b39fdaa-f7a9-4fec-80ff-7c1e1ea71f95","msg":"User logged in successfully"}
{"level":30,"time":1768335789721,"env":"test","module":"user-credentials-repository","userId":"f2ca0fb2-e423-439e-901c-c1c9c7ed9ab0","msg":"User credentials created"}
{"level":30,"time":1768335789727,"env":"test","module":"audit-log-service","userId":"eTKIjKc7Gdvuxjfw-VEJ0","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335789760,"env":"test","module":"audit-log-service","userId":"9b39fdaa-f7a9-4fec-80ff-7c1e1ea71f95","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould return 404 for non-existent session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335789828,"env":"test","module":"email-queue","jobId":"1a8b0b15-dd23-4a84-b995-6687a14fc472","to":"middleware-test-XuqnTKAxgP3oWi8C0rOhq@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335789832,"env":"test","module":"auth-routes","userId":"ed2b53a1-ca2b-4aaf-86e0-61c426a4bdad","msg":"User logged in successfully"}
{"level":30,"time":1768335789872,"env":"test","module":"auth-routes","userId":"57058b610a69cfa853c5f15e086c683b","msg":"Login requires MFA verification"}
{"level":30,"time":1768335789886,"env":"test","module":"auth-routes","userId":"f2ca0fb2-e423-439e-901c-c1c9c7ed9ab0","email":"middleware-test-XuqnTKAxgP3oWi8C0rOhq@example.com","msg":"User registered"}
{"level":30,"time":1768335789886,"env":"test","module":"audit-log-service","userId":"ed2b53a1-ca2b-4aaf-86e0-61c426a4bdad","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould allow cookie auth for HEAD requests
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335789971,"env":"test","module":"auth-routes","userId":"a96419ad3d465231f63ba028596df7a5","msg":"User logged in successfully"}
{"level":30,"time":1768335789976,"env":"test","module":"mfa-service","userId":"57058b610a69cfa853c5f15e086c683b","msg":"TOTP verification successful"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335790027,"env":"test","module":"auth-routes","userId":"57058b610a69cfa853c5f15e086c683b","msg":"MFA login successful"}
{"level":30,"time":1768335790027,"env":"test","module":"audit-log-service","userId":"a96419ad3d465231f63ba028596df7a5","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335790031,"env":"test","module":"auth-service","tokenHash":"8662d00e80504e824301bb353664d164b3a1f33244c54cbff451d858643f606a","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768335790040,"env":"test","module":"auth-routes","userId":"ee0c495b449ea461b8796dceb83aa655","msg":"Login requires MFA verification"}
{"level":30,"time":1768335790107,"env":"test","module":"user-credentials-repository","userId":"JWvu3bjPMhZGybkYGCeU7","msg":"User credentials created"}
{"level":30,"time":1768335790146,"env":"test","module":"mfa-service","userId":"ee0c495b449ea461b8796dceb83aa655","msg":"TOTP verification successful"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mdemoteMember[2m > [22m[2mshould prevent self-demotion
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:212:25
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335790198,"env":"test","module":"auth-routes","userId":"ee0c495b449ea461b8796dceb83aa655","msg":"MFA login successful"}
{"level":30,"time":1768335790204,"env":"test","module":"auth-routes","userId":"a17c9f21-4eea-4cd5-967c-1dd30d7d162f","msg":"User logged in successfully"}
{"level":30,"time":1768335790242,"env":"test","module":"auth-service","tokenHash":"8662d00e80504e824301bb353664d164b3a1f33244c54cbff451d858643f606a","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768335790258,"env":"test","module":"audit-log-service","userId":"a17c9f21-4eea-4cd5-967c-1dd30d7d162f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768335790264,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768335790292,"env":"test","module":"auth-service","userId":"a96419ad3d465231f63ba028596df7a5","tokenHash":"8662d00e80504e824301bb353664d164b3a1f33244c54cbff451d858643f606a","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768335790294,"env":"test","module":"auth-routes","userId":"9ef6b097c040112dd7a58b71264ebc5a","msg":"User logged in successfully"}
{"level":30,"time":1768335790305,"env":"test","module":"user-credentials-repository","userId":"613d4573-d88e-457d-900c-9b30c76f2dba","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mPassword Reset Flow[2m > [22m[2mshould invalidate all sessions after password reset
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335790350,"env":"test","module":"audit-log-service","userId":"9ef6b097c040112dd7a58b71264ebc5a","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335790356,"env":"test","module":"auth-routes","userId":"ee0c495b449ea461b8796dceb83aa655","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768335790413,"env":"test","module":"email-queue","jobId":"ee9335cc-47e0-461d-be88-1a87c3761ec9","to":"jwt-test-UKsC6PqwwK0wbHOaf7Hu3@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335790413,"env":"test","module":"auth-routes","userId":"f2ca0fb2-e423-439e-901c-c1c9c7ed9ab0","msg":"User logged in successfully"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject invalid token
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:52:21 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335790466,"env":"test","module":"auth-routes","userId":"613d4573-d88e-457d-900c-9b30c76f2dba","email":"jwt-test-UKsC6PqwwK0wbHOaf7Hu3@example.com","msg":"User registered"}
{"level":30,"time":1768335790466,"env":"test","module":"auth-routes","userId":"ee0c495b449ea461b8796dceb83aa655","deviceCount":1,"msg":"Listed trusted devices"}
{"level":30,"time":1768335790466,"env":"test","module":"audit-log-service","userId":"f2ca0fb2-e423-439e-901c-c1c9c7ed9ab0","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768335790470,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335790483,"env":"test","module":"auth-routes","userId":"ed2b53a1-ca2b-4aaf-86e0-61c426a4bdad","msg":"User logged in successfully"}
{"level":30,"time":1768335790535,"env":"test","module":"audit-log-service","userId":"ed2b53a1-ca2b-4aaf-86e0-61c426a4bdad","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Login Flow[2m > [22m[2mshould accept TOTP codes within 60-second window
[22m[39mError deleting test user 57058b610a69cfa853c5f15e086c683b: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/mfa.flow.real.test.ts:46:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335790593,"env":"test","module":"user-credentials-repository","userId":"r_dhxv94lDLv_3GavKPEn","msg":"User credentials created"}
{"level":30,"time":1768335790631,"env":"test","module":"auth-routes","userId":"ee0c495b449ea461b8796dceb83aa655","deviceId":"801f71ff-503b-49ed-b54f-2daf32cfef05","msg":"Trusted device revoked"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335790662,"env":"test","module":"user-credentials-repository","userId":"273158c8-ba13-48ed-96ef-432829e346f1","msg":"User credentials created"}
{"level":30,"time":1768335790759,"env":"test","module":"email-queue","jobId":"310179ba-fdcc-482e-9fc4-4811415fbb57","to":"protected-test-LIJUZeW88fcicDWfWFwRa@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335790793,"env":"test","module":"auth-routes","userId":"ee0c495b449ea461b8796dceb83aa655","deviceCount":0,"msg":"Listed trusted devices"}
{"level":30,"time":1768335790810,"env":"test","module":"auth-routes","userId":"273158c8-ba13-48ed-96ef-432829e346f1","email":"protected-test-LIJUZeW88fcicDWfWFwRa@example.com","msg":"User registered"}
{"level":30,"time":1768335790829,"env":"test","module":"auth-routes","userId":"d3585bcf9858c7e51b50fe3459888b57","msg":"User logged in successfully"}
{"level":30,"time":1768335790882,"env":"test","module":"audit-log-service","userId":"d3585bcf9858c7e51b50fe3459888b57","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mDELETE Protected Routes[2m > [22m[2mshould allow DELETE with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/refresh-token[2m > [22m[2mshould rotate refresh token after use
[22m[39mError deleting test user a96419ad3d465231f63ba028596df7a5: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth.routes.real.test.ts:54:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould return 404 for non-existent session
[22m[39mError deleting test user 9ef6b097c040112dd7a58b71264ebc5a: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/session.management.real.test.ts:44:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335790977,"env":"test","module":"user-credentials-repository","userId":"IYmfVFXL1BiNSM9_NSFPp","msg":"User credentials created"}
{"level":30,"time":1768335791000,"env":"test","module":"user-credentials-repository","userId":"a196b216-e7fd-47a9-ae92-0094fd3fc14a","msg":"User credentials created"}
{"level":30,"time":1768335791094,"env":"test","module":"email-queue","jobId":"28e59b96-175d-48d8-a8b1-81156e235742","to":"test-1768335789619-5d897@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335791094,"env":"test","module":"auth-service","email":"test-1768335789619-5d897@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768335791102,"env":"test","module":"email-queue","jobId":"0720969e-f50f-4bbc-8d56-78398d3dab19","to":"middleware-test-UeqWA79usaKL6Bp0ewWLa@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335791121,"env":"test","module":"auth-routes","userId":"ed2b53a1-ca2b-4aaf-86e0-61c426a4bdad","msg":"User logged in successfully"}
{"level":30,"time":1768335791155,"env":"test","module":"auth-routes","userId":"a196b216-e7fd-47a9-ae92-0094fd3fc14a","email":"middleware-test-UeqWA79usaKL6Bp0ewWLa@example.com","msg":"User registered"}
{"level":30,"time":1768335791168,"env":"test","module":"audit-log-service","userId":"ed2b53a1-ca2b-4aaf-86e0-61c426a4bdad","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mremoveMember[2m > [22m[2mshould allow admin to remove member
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:226:25
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mDatabase Transfer[2m > [22m[2mshould transfer database ownership
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:56:21 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould prioritize JWT over cookie when both present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335791275,"env":"test","module":"auth-routes","userId":"ed2b53a1-ca2b-4aaf-86e0-61c426a4bdad","sessionCount":3,"msg":"Listed active sessions"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould login with valid backup code
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39mError deleting test user ee0c495b449ea461b8796dceb83aa655: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/trusted.devices.real.test.ts:45:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335791454,"env":"test","module":"auth-routes","userId":"273158c8-ba13-48ed-96ef-432829e346f1","msg":"User logged in successfully"}
{"level":30,"time":1768335791468,"env":"test","module":"user-credentials-repository","userId":"d3585bcf9858c7e51b50fe3459888b57","msg":"User password updated"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mgetPendingInvitesForUser[2m > [22m[2mshould return pending invites for user email
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:52:21 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335791504,"env":"test","module":"audit-log-service","userId":"273158c8-ba13-48ed-96ef-432829e346f1","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335791518,"env":"test","module":"user-credentials-repository","userId":"tM9tDqTa58CmagJeXuPPE","msg":"User credentials created"}
{"level":30,"time":1768335791622,"env":"test","module":"audit-log-service","userId":"d3585bcf9858c7e51b50fe3459888b57","eventType":"password_reset","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mremoveMember[2m > [22m[2mshould allow admin to remove member
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.removeMember (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:341:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:233:13
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335791665,"env":"test","module":"user-credentials-repository","userId":"9b4b4934-7136-4c84-bd85-ea7ad674c959","msg":"User credentials created"}
{"level":30,"time":1768335791699,"env":"test","module":"auth-routes","userId":"a196b216-e7fd-47a9-ae92-0094fd3fc14a","msg":"User logged in successfully"}
{"level":30,"time":1768335791757,"env":"test","module":"audit-log-service","userId":"a196b216-e7fd-47a9-ae92-0094fd3fc14a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335791776,"env":"test","module":"user-credentials-repository","userId":"fb05e7da-eb0e-45eb-9985-ba405dbb915f","msg":"User credentials created"}
{"level":30,"time":1768335791777,"env":"test","module":"email-queue","jobId":"1cd9c392-b2a1-4ea8-9659-03335dd24779","to":"session-test-1nuSlGZDaNjDoH85_mmqv@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335791796,"env":"test","module":"auth-routes","userId":"ac9c83f93ff7522ff8b45fd6b78dd1a1","msg":"User logged in successfully"}
{"level":30,"time":1768335791828,"env":"test","module":"auth-routes","userId":"9b4b4934-7136-4c84-bd85-ea7ad674c959","email":"session-test-1nuSlGZDaNjDoH85_mmqv@example.com","msg":"User registered"}
{"level":30,"time":1768335791827,"env":"test","module":"email-queue","jobId":"96c539ac-e4dc-40b5-b32f-389ba2a90363","to":"test-1768335790917-8gg92@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335791828,"env":"test","module":"auth-service","email":"test-1768335790917-8gg92@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768335791847,"env":"test","module":"audit-log-service","userId":"ac9c83f93ff7522ff8b45fd6b78dd1a1","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335791879,"env":"test","module":"email-queue","jobId":"070b4a4d-1a11-42e6-82d5-7aaa6ce6a3bc","to":"jwt-test-Kk2oULjhO2KeOIh_T6Lrc@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335791931,"env":"test","module":"auth-routes","userId":"fb05e7da-eb0e-45eb-9985-ba405dbb915f","email":"jwt-test-Kk2oULjhO2KeOIh_T6Lrc@example.com","msg":"User registered"}
{"level":50,"time":1768335791936,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould refresh access token using refresh token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335792014,"env":"test","module":"email-queue","jobId":"3cc70607-6141-48bf-81f7-7b34a0232848","to":"existing_1768335765585@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking other user's session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335792060,"env":"test","module":"user-credentials-repository","userId":"fd509f80-3343-438c-a67f-64a915140499","msg":"User credentials created"}
{"level":30,"time":1768335792118,"env":"test","module":"user-credentials-repository","userId":"YvsyX-3IFDrCTIQSzml9A","msg":"User credentials created"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mgetPendingInvitesForUser[2m > [22m[2mshould return pending invites for user email
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:548:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:277:34
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335792138,"env":"test","module":"user-credentials-repository","userId":"6ffb3481-e263-4429-8cba-d0fabc8ec8e2","msg":"User credentials created"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39m[TEST UTILS] MFA Secret verified for 3a9d83b8ee22b31f5162ce022de4ee01

{"level":30,"time":1768335792163,"env":"test","module":"email-queue","jobId":"b2e24f14-e3bc-44c7-8a9e-e09960b58cc0","to":"protected-test-DspgpFKANUc7sZLmlUuO1@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335792214,"env":"test","module":"auth-routes","userId":"fd509f80-3343-438c-a67f-64a915140499","email":"protected-test-DspgpFKANUc7sZLmlUuO1@example.com","msg":"User registered"}
{"level":30,"time":1768335792239,"env":"test","module":"email-queue","jobId":"abd0055d-eb5b-4423-88a0-eb11e773585a","to":"user2-iFuQO9YjhTf8fMsDrrGNo@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335792290,"env":"test","module":"auth-routes","userId":"6ffb3481-e263-4429-8cba-d0fabc8ec8e2","email":"user2-iFuQO9YjhTf8fMsDrrGNo@example.com","msg":"User registered"}
{"level":30,"time":1768335792343,"env":"test","module":"user-credentials-repository","userId":"107f2d9b-327c-4269-9ae5-efa3fe093f8e","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould prioritize JWT over cookie when both present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335792350,"env":"test","module":"mfa-service","userId":"ac9c83f93ff7522ff8b45fd6b78dd1a1","count":10,"msg":"Stored backup codes"}
{"level":30,"time":1768335792350,"env":"test","module":"mfa-service","userId":"ac9c83f93ff7522ff8b45fd6b78dd1a1","msg":"Generated TOTP secret"}
{"level":30,"time":1768335792350,"env":"test","module":"auth-routes","userId":"ac9c83f93ff7522ff8b45fd6b78dd1a1","msg":"MFA setup initiated"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/forgot-password[2m > [22m[2mshould send password reset email for existing user
[22m[39mError deleting test user a16b9d2b904f5b074ab1b04bb65b4740: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth.routes.real.test.ts:54:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mPassword Reset Flow[2m > [22m[2mshould invalidate all sessions after password reset
[22m[39mError deleting test user d3585bcf9858c7e51b50fe3459888b57: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth.flows.real.test.ts:47:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335792445,"env":"test","module":"email-queue","jobId":"c5db0ac8-ab75-4c72-91db-3fddd09cb279","to":"session-test-U8AHt0IH7kUfSq17O_Sf0@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335792465,"env":"test","module":"auth-routes","userId":"fb05e7da-eb0e-45eb-9985-ba405dbb915f","msg":"User logged in successfully"}
{"level":30,"time":1768335792496,"env":"test","module":"auth-routes","userId":"107f2d9b-327c-4269-9ae5-efa3fe093f8e","email":"session-test-U8AHt0IH7kUfSq17O_Sf0@example.com","msg":"User registered"}
{"level":30,"time":1768335792510,"env":"test","module":"audit-log-service","userId":"fb05e7da-eb0e-45eb-9985-ba405dbb915f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335792525,"env":"test","module":"auth-routes","userId":"27718e47c8e065d667e419e92a877f08","msg":"User logged in successfully"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mDatabase Transfer[2m > [22m[2mshould allow org member to transfer org database
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:56:21 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335792574,"env":"test","module":"audit-log-service","userId":"27718e47c8e065d667e419e92a877f08","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking other user's session
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mDELETE Protected Routes[2m > [22m[2mshould reject DELETE without Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335792648,"env":"test","module":"mfa-service","userId":"ac9c83f93ff7522ff8b45fd6b78dd1a1","msg":"MFA enabled successfully"}
{"level":30,"time":1768335792648,"env":"test","module":"auth-routes","userId":"ac9c83f93ff7522ff8b45fd6b78dd1a1","msg":"MFA enabled successfully"}
{"level":30,"time":1768335792699,"env":"test","module":"audit-log-service","userId":"ac9c83f93ff7522ff8b45fd6b78dd1a1","eventType":"mfa_enabled","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould login with valid backup code
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335792807,"env":"test","module":"auth-routes","userId":"6ffb3481-e263-4429-8cba-d0fabc8ec8e2","msg":"User logged in successfully"}
{"level":30,"time":1768335792855,"env":"test","module":"audit-log-service","userId":"6ffb3481-e263-4429-8cba-d0fabc8ec8e2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335792879,"env":"test","module":"auth-routes","userId":"3a9d83b8ee22b31f5162ce022de4ee01","msg":"Login requires MFA verification"}
{"level":30,"time":1768335792979,"env":"test","module":"mfa-service","userId":"3a9d83b8ee22b31f5162ce022de4ee01","msg":"TOTP verification successful"}
{"level":30,"time":1768335793036,"env":"test","module":"auth-routes","userId":"3a9d83b8ee22b31f5162ce022de4ee01","msg":"MFA login successful"}
{"level":30,"time":1768335793067,"env":"test","module":"auth-routes","userId":"499132d163159736d81afa60bc471921","msg":"User logged in successfully"}
{"level":30,"time":1768335793078,"env":"test","module":"auth-routes","userId":"107f2d9b-327c-4269-9ae5-efa3fe093f8e","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould rotate refresh token on each use
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335793114,"env":"test","module":"audit-log-service","userId":"499132d163159736d81afa60bc471921","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335793127,"env":"test","module":"audit-log-service","userId":"107f2d9b-327c-4269-9ae5-efa3fe093f8e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335793159,"env":"test","module":"auth-routes","userId":"fd509f80-3343-438c-a67f-64a915140499","msg":"User logged in successfully"}
{"level":30,"time":1768335793172,"env":"test","module":"auth-routes","userId":"ac9c83f93ff7522ff8b45fd6b78dd1a1","msg":"Login requires MFA verification"}
{"level":30,"time":1768335793213,"env":"test","module":"auth-routes","userId":"27718e47c8e065d667e419e92a877f08","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768335793213,"env":"test","module":"audit-log-service","userId":"fd509f80-3343-438c-a67f-64a915140499","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768335793218,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mremoveMember[2m > [22m[2mshould prevent self-removal
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:242:25
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335793332,"env":"test","module":"email-queue","jobId":"ca598978-5142-4bf5-966a-e0b0d3130298","to":"test-1768335792730-xy8vb@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335793333,"env":"test","module":"user-credentials-repository","userId":"b233a99f-224a-44cc-80e1-300b60d00c72","msg":"User credentials created"}
{"level":30,"time":1768335793332,"env":"test","module":"auth-service","email":"test-1768335792730-xy8vb@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768335793381,"env":"test","module":"mfa-service","userId":"ac9c83f93ff7522ff8b45fd6b78dd1a1","msg":"Backup code verified and consumed"}
{"level":30,"time":1768335793426,"env":"test","module":"email-queue","jobId":"5299b71a-8012-475e-9b86-20ce1f4c4811","to":"middleware-test-dqPA7hEiq-AuNBdHnJm_q@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335793432,"env":"test","module":"auth-routes","userId":"ac9c83f93ff7522ff8b45fd6b78dd1a1","msg":"MFA login successful"}
{"level":30,"time":1768335793474,"env":"test","module":"auth-routes","userId":"b233a99f-224a-44cc-80e1-300b60d00c72","email":"middleware-test-dqPA7hEiq-AuNBdHnJm_q@example.com","msg":"User registered"}
{"level":30,"time":1768335793515,"env":"test","module":"auth-service","tokenHash":"399edb40ba560590b51ac0699e76bbda04b36d580dadb41c4e66a85a062df5ba","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould return 401 when no auth provided
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335793552,"env":"test","module":"auth-routes","userId":"e8abaf2f7f712dc24d1f9ed88d384409","msg":"User logged in successfully"}
{"level":30,"time":1768335793597,"env":"test","module":"user-credentials-repository","userId":"c18de100-c820-4484-a915-93850d6291ce","msg":"User credentials created"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mgetPendingInvitesForUser[2m > [22m[2mshould not return expired invites
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:52:21 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335793606,"env":"test","module":"audit-log-service","userId":"e8abaf2f7f712dc24d1f9ed88d384409","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335793610,"env":"test","module":"auth-service","tokenHash":"2b1f16e77448fe87912d5e0e3f951ff4fb6f769c508c08a28735aae4457c65dd","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768335793611,"env":"test","module":"auth-routes","userId":"107f2d9b-327c-4269-9ae5-efa3fe093f8e","msg":"User logged in successfully"}
[90mstderr[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39mError deleting test user 3a9d83b8ee22b31f5162ce022de4ee01: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/trusted.devices.real.test.ts:45:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335793666,"env":"test","module":"audit-log-service","userId":"107f2d9b-327c-4269-9ae5-efa3fe093f8e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335793694,"env":"test","module":"email-queue","jobId":"4879f0fd-3f7c-4869-a90b-e901a48201d0","to":"protected-test-wv3aRz0yhKpoYFbQfWj--@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335793698,"env":"test","module":"user-credentials-repository","userId":"ea50603be2af41b55768c6ea26135954","msg":"User password updated"}
{"level":30,"time":1768335793742,"env":"test","module":"auth-routes","userId":"c18de100-c820-4484-a915-93850d6291ce","email":"protected-test-wv3aRz0yhKpoYFbQfWj--@example.com","msg":"User registered"}
{"level":30,"time":1768335793775,"env":"test","module":"auth-routes","userId":"107f2d9b-327c-4269-9ae5-efa3fe093f8e","sessionCount":2,"msg":"Listed active sessions"}
{"level":30,"time":1768335793806,"env":"test","module":"auth-service","tokenHash":"3961fd8b161e0076d99f48e2a341ccf5cdcde6304dfe276e6c7bf021ed4d3040","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768335793842,"env":"test","module":"audit-log-service","userId":"ea50603be2af41b55768c6ea26135954","eventType":"password_reset","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/reset-password[2m > [22m[2mshould reset password with valid token
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking other user's session
[22m[39mError deleting test user 499132d163159736d81afa60bc471921: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/session.management.real.test.ts:44:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335793889,"env":"test","workflowId":"35353881-6835-4e8d-bd99-d340d8e82643","userId":"954ef1b8-1572-4c6d-8069-f93b3c874213","sectionsCount":1,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":30,"time":1768335793927,"env":"test","module":"auth-routes","userId":"107f2d9b-327c-4269-9ae5-efa3fe093f8e","sessionId":"6c3ce409-385c-4433-bf95-2368d590e18a","msg":"Session revoked"}
{"level":30,"time":1768335793930,"env":"test","module":"auth-service","tokenHash":"0d54f616bf4988b421f4e98e56ac2650cc2b979296096625f43a985b33b93e1d","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768335793978,"env":"test","module":"auth-service","userId":"107f2d9b-327c-4269-9ae5-efa3fe093f8e","tokenHash":"0d54f616bf4988b421f4e98e56ac2650cc2b979296096625f43a985b33b93e1d","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould login with valid backup code
[22m[39mError deleting test user ac9c83f93ff7522ff8b45fd6b78dd1a1: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/mfa.flow.real.test.ts:46:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335793991,"env":"test","module":"auth-routes","userId":"b233a99f-224a-44cc-80e1-300b60d00c72","msg":"User logged in successfully"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mDatabase Transfer[2m > [22m[2mshould prevent transfer to org if user is not a member
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:56:21 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335794019,"env":"test","module":"auth-service","tokenHash":"418f3cd0fe5010ebbb4999bc2a2426358bf727327ebdca371ec21a018f6792fe","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768335794041,"env":"test","module":"audit-log-service","userId":"b233a99f-224a-44cc-80e1-300b60d00c72","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768335794045,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPATCH Protected Routes[2m > [22m[2mshould allow PATCH with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335794099,"env":"test","module":"user-credentials-repository","userId":"7ee72e0b-4665-4345-a834-add9e42a0d9d","msg":"User credentials created"}
{"level":30,"time":1768335794204,"env":"test","module":"email-queue","jobId":"f5f2b622-5d3f-4379-8ab6-9c15ec5f6d31","to":"jwt-test-UKEQKIpTVjeijdpcLCwHV@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335794251,"env":"test","module":"auth-routes","userId":"7ee72e0b-4665-4345-a834-add9e42a0d9d","email":"jwt-test-UKEQKIpTVjeijdpcLCwHV@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould rotate refresh token on use
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335794335,"env":"test","module":"auth-routes","userId":"ea50603be2af41b55768c6ea26135954","msg":"User logged in successfully"}
{"level":30,"time":1768335794386,"env":"test","module":"audit-log-service","userId":"ea50603be2af41b55768c6ea26135954","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/reset-password[2m > [22m[2mshould reset password with valid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335794413,"env":"test","module":"user-credentials-repository","userId":"459f5fc5-a830-4bae-90ad-a22eb2301361","msg":"User credentials created"}
{"level":30,"time":1768335794420,"env":"test","module":"email-queue","jobId":"8fb8d8e4-abbe-4b41-ab7e-c660fa3b989e","to":"existing_1768335765585@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
{"level":30,"time":1768335794425,"env":"test","module":"user-credentials-repository","userId":"dd334d99-31f1-4efc-a874-fd289a80fd54","msg":"User credentials created"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 309229eb3408c5bb210376eb3797eadd

{"level":30,"time":1768335794514,"env":"test","module":"email-queue","jobId":"95c072a4-30be-41b3-8724-d35713a6b5e1","to":"session-test-USAE-WUAFxLBVsTWPMZ3I@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mgetPendingInvitesForUser[2m > [22m[2mshould not return expired invites
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:548:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:293:34
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335794527,"env":"test","module":"email-queue","jobId":"7ae1e23c-2b60-4c58-8113-80030e43a503","to":"middleware-test-Fdd2g4XRgq6qj8scZEHoU@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335794565,"env":"test","module":"auth-routes","userId":"459f5fc5-a830-4bae-90ad-a22eb2301361","email":"session-test-USAE-WUAFxLBVsTWPMZ3I@example.com","msg":"User registered"}
{"level":30,"time":1768335794577,"env":"test","module":"auth-routes","userId":"dd334d99-31f1-4efc-a874-fd289a80fd54","email":"middleware-test-Fdd2g4XRgq6qj8scZEHoU@example.com","msg":"User registered"}
{"level":30,"time":1768335794581,"env":"test","module":"auth-routes","userId":"c18de100-c820-4484-a915-93850d6291ce","msg":"User logged in successfully"}
{"level":30,"time":1768335794629,"env":"test","module":"audit-log-service","userId":"c18de100-c820-4484-a915-93850d6291ce","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould return 401 when both JWT and cookie are invalid
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mleaveOrganization[2m > [22m[2mshould allow member to leave organization
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:256:25
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking current session
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking other user's session
[22m[39mError deleting test user 27718e47c8e065d667e419e92a877f08: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/session.management.real.test.ts:44:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":50,"time":1768335794759,"env":"test","module":"auth-routes","email":"test-1768335792730-xy8vb@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould mark backup code as used
[22m[39m[TEST UTILS] MFA Secret verified for b5d4c06ea818373c07e9dee697f966cd

{"level":30,"time":1768335794763,"env":"test","module":"auth-routes","userId":"7ee72e0b-4665-4345-a834-add9e42a0d9d","msg":"User logged in successfully"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould rotate refresh token on each use
[22m[39mError deleting test user e8abaf2f7f712dc24d1f9ed88d384409: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth.flows.real.test.ts:47:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mDatabase Transfer[2m > [22m[2mshould prevent transfer to org if user is not a member
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:326:30
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335794816,"env":"test","module":"audit-log-service","userId":"7ee72e0b-4665-4345-a834-add9e42a0d9d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335794819,"env":"test","module":"auth-service","tokenHash":"0d82ae354c9b378d8a8f1c319d8da2d0e3c51806945f330930af34fc4ba30a7f","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":50,"time":1768335794867,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/reset-password[2m > [22m[2mshould reset password with valid token
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":30,"time":1768335794998,"env":"test","workflowId":"ec8764c2-da13-4766-ad41-f9803e74b07b","userId":"954ef1b8-1572-4c6d-8069-f93b3c874213","sectionsCount":1,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":30,"time":1768335795024,"env":"test","module":"auth-service","tokenHash":"0d82ae354c9b378d8a8f1c319d8da2d0e3c51806945f330930af34fc4ba30a7f","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768335795073,"env":"test","module":"auth-service","userId":"7ee72e0b-4665-4345-a834-add9e42a0d9d","tokenHash":"0d82ae354c9b378d8a8f1c319d8da2d0e3c51806945f330930af34fc4ba30a7f","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768335795114,"env":"test","module":"auth-routes","userId":"dd334d99-31f1-4efc-a874-fd289a80fd54","msg":"User logged in successfully"}
{"level":30,"time":1768335795122,"env":"test","module":"auth-service","tokenHash":"695cc608adeca2c56519f2b0248e3f0a44158d35e70b4e4b0ff7f9e74dd88e1d","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768335795149,"env":"test","module":"auth-routes","userId":"459f5fc5-a830-4bae-90ad-a22eb2301361","msg":"User logged in successfully"}
{"level":30,"time":1768335795162,"env":"test","module":"audit-log-service","userId":"dd334d99-31f1-4efc-a874-fd289a80fd54","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768335795166,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768335795170,"env":"test","module":"auth-service","userId":"7ee72e0b-4665-4345-a834-add9e42a0d9d","tokenHash":"695cc608adeca2c56519f2b0248e3f0a44158d35e70b4e4b0ff7f9e74dd88e1d","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for c46dcd47dc231834e3ed06021fc3a40b

{"level":30,"time":1768335795203,"env":"test","module":"audit-log-service","userId":"459f5fc5-a830-4bae-90ad-a22eb2301361","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335795309,"env":"test","module":"auth-routes","userId":"459f5fc5-a830-4bae-90ad-a22eb2301361","sessionCount":1,"msg":"Listed active sessions"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/reset-password[2m > [22m[2mshould reset password with valid token
[22m[39mError deleting test user ea50603be2af41b55768c6ea26135954: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth.routes.real.test.ts:54:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould detect and prevent refresh token reuse (token theft)
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335795552,"env":"test","module":"user-credentials-repository","userId":"38907b0f-9e7d-43ad-a012-d83de8b53aa1","msg":"User credentials created"}
{"level":30,"time":1768335795597,"env":"test","module":"user-credentials-repository","userId":"2e3ac1bd-89c7-45f8-8b8c-caafb5098c3c","msg":"User credentials created"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould mark backup code as used
[22m[39mError deleting test user b5d4c06ea818373c07e9dee697f966cd: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/mfa.flow.real.test.ts:46:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335795658,"env":"test","module":"email-queue","jobId":"95b098fd-a0b0-4756-b78b-747914820109","to":"middleware-test-feOdnfo-TEzGKUHcy_JTL@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768335795669,"env":"test","error":{},"workflowId":"8dff4f02-525f-4d97-ab12-f361b78f0cef","userId":"954ef1b8-1572-4c6d-8069-f93b3c874213","projectId":"00000000-0000-0000-0000-000000000000","msg":"Error moving workflow"}
{"level":30,"time":1768335795682,"env":"test","module":"user-credentials-repository","userId":"934f8d0c-691c-4662-819f-97f3e19dae3d","msg":"User credentials created"}
{"level":30,"time":1768335795711,"env":"test","module":"auth-routes","userId":"38907b0f-9e7d-43ad-a012-d83de8b53aa1","email":"middleware-test-feOdnfo-TEzGKUHcy_JTL@example.com","msg":"User registered"}
{"level":30,"time":1768335795717,"env":"test","module":"email-queue","jobId":"d9a20805-a7d5-4429-ba78-38d73025471f","to":"jwt-test-5jt3125vVyIMtkxHCKcfv@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould authenticate with JWT if provided
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335795773,"env":"test","module":"auth-routes","userId":"2e3ac1bd-89c7-45f8-8b8c-caafb5098c3c","email":"jwt-test-5jt3125vVyIMtkxHCKcfv@example.com","msg":"User registered"}
{"level":30,"time":1768335795790,"env":"test","module":"email-queue","jobId":"5bea8977-87a5-4251-85ed-df4dd1c34fc6","to":"protected-test-oZa1_WcFY3MGynOlm5ujw@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335795804,"env":"test","module":"user-credentials-repository","userId":"07ee3be2-eb9a-41a8-b106-323b6d903b69","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould detect token reuse and revoke all user tokens
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335795851,"env":"test","module":"auth-routes","userId":"934f8d0c-691c-4662-819f-97f3e19dae3d","email":"protected-test-oZa1_WcFY3MGynOlm5ujw@example.com","msg":"User registered"}
{"level":30,"time":1768335795872,"env":"test","module":"auth-routes","userId":"2a9f9be31dadf6a272b5c7587011ad12","msg":"User logged in successfully"}
{"level":30,"time":1768335795907,"env":"test","module":"email-queue","jobId":"5422e156-f241-4d20-ba44-ebed3b09857a","to":"session-test-0O74Mnf9g0xzHeYEXTf_U@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335795921,"env":"test","module":"audit-log-service","userId":"2a9f9be31dadf6a272b5c7587011ad12","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335795956,"env":"test","module":"auth-routes","userId":"834d95dd4dd89ac5bdb4658d5f261480","msg":"User logged in successfully"}
{"level":30,"time":1768335795959,"env":"test","module":"auth-routes","userId":"07ee3be2-eb9a-41a8-b106-323b6d903b69","email":"session-test-0O74Mnf9g0xzHeYEXTf_U@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPATCH Protected Routes[2m > [22m[2mshould reject PATCH without Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335795968,"env":"test","module":"auth-routes","userId":"309229eb3408c5bb210376eb3797eadd","msg":"Login requires MFA verification"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mleaveOrganization[2m > [22m[2mshould allow admin to leave organization
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationService.test.ts:271:25
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mgetPendingInvitesForUser[2m > [22m[2mshould not return accepted invites
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:52:21 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335796007,"env":"test","module":"audit-log-service","userId":"834d95dd4dd89ac5bdb4658d5f261480","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335796011,"env":"test","module":"auth-service","tokenHash":"d246681f2b5108d5e10f3dc320acf4e1d50bc8cdd4f00f9b4f962421d5ad25d6","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mTransfer Validation[2m > [22m[2mshould only allow transfer to self when targetOwnerType is user
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:56:21 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335796083,"env":"test","module":"mfa-service","userId":"309229eb3408c5bb210376eb3797eadd","msg":"TOTP verification successful"}
{"level":30,"time":1768335796137,"env":"test","module":"auth-routes","userId":"309229eb3408c5bb210376eb3797eadd","msg":"MFA login successful"}
{"level":50,"time":1768335796145,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335796208,"env":"test","module":"auth-service","tokenHash":"d246681f2b5108d5e10f3dc320acf4e1d50bc8cdd4f00f9b4f962421d5ad25d6","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768335796230,"env":"test","module":"auth-routes","userId":"38907b0f-9e7d-43ad-a012-d83de8b53aa1","msg":"User logged in successfully"}
{"level":40,"time":1768335796254,"env":"test","module":"auth-service","userId":"834d95dd4dd89ac5bdb4658d5f261480","tokenHash":"d246681f2b5108d5e10f3dc320acf4e1d50bc8cdd4f00f9b4f962421d5ad25d6","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768335796286,"env":"test","module":"audit-log-service","userId":"38907b0f-9e7d-43ad-a012-d83de8b53aa1","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335796290,"env":"test","module":"auth-routes","userId":"309229eb3408c5bb210376eb3797eadd","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768335796307,"env":"test","module":"auth-routes","userId":"2e3ac1bd-89c7-45f8-8b8c-caafb5098c3c","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould prevent backup code reuse
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335796342,"env":"test","module":"email-queue","jobId":"acfe6c1c-2b39-43ad-b472-c18e329b96ab","to":"test-1768335795773-3mj4yr@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335796343,"env":"test","module":"auth-service","email":"test-1768335795773-3mj4yr@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768335796356,"env":"test","module":"audit-log-service","userId":"2e3ac1bd-89c7-45f8-8b8c-caafb5098c3c","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould detect token reuse and revoke all user tokens
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335796394,"env":"test","module":"auth-routes","userId":"309229eb3408c5bb210376eb3797eadd","deviceCount":1,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335796409,"env":"test","module":"auth-routes","userId":"2a9f9be31dadf6a272b5c7587011ad12","msg":"User logged in successfully"}
{"level":30,"time":1768335796451,"env":"test","module":"user-credentials-repository","userId":"18336182-b0a6-4f63-aa2e-b68d3d45a344","msg":"User credentials created"}
{"level":30,"time":1768335796458,"env":"test","module":"audit-log-service","userId":"2a9f9be31dadf6a272b5c7587011ad12","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335796491,"env":"test","module":"email-queue","jobId":"37c47582-b679-4d81-84fb-c2456cb7909f","to":"existing_1768335765585@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
{"level":30,"time":1768335796491,"env":"test","module":"auth-routes","userId":"934f8d0c-691c-4662-819f-97f3e19dae3d","msg":"User logged in successfully"}
{"level":30,"time":1768335796545,"env":"test","module":"audit-log-service","userId":"934f8d0c-691c-4662-819f-97f3e19dae3d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768335796548,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335796559,"env":"test","module":"email-queue","jobId":"fe870e9a-a5a2-4298-bab0-94171f7a8597","to":"user2-05joojqt5cLhNK3IENcYc@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335796580,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335796581,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mgetPendingInvitesForUser[2m > [22m[2mshould not return accepted invites
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:548:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:311:34
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335796613,"env":"test","module":"auth-routes","userId":"18336182-b0a6-4f63-aa2e-b68d3d45a344","email":"user2-05joojqt5cLhNK3IENcYc@example.com","msg":"User registered"}
 [32mâœ“[39m tests/integration/organizationService.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 18059[2mms[22m[39m
       [33m[2mâœ“[22m[39m should create organization and auto-create admin membership [33m 1165[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return all organizations for user [33m 1025[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return empty array for user with no memberships [33m 372[2mms[22m[39m
       [33m[2mâœ“[22m[39m should allow admin to update organization [33m 1313[2mms[22m[39m
       [33m[2mâœ“[22m[39m should deny non-admin from updating organization [33m 1191[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return all members of organization [33m 1169[2mms[22m[39m
       [33m[2mâœ“[22m[39m should allow admin to promote member [33m 1897[2mms[22m[39m
       [33m[2mâœ“[22m[39m should allow admin to demote other admin [33m 1686[2mms[22m[39m
       [33m[2mâœ“[22m[39m should prevent self-demotion [33m 1068[2mms[22m[39m
       [33m[2mâœ“[22m[39m should allow admin to remove member [33m 1737[2mms[22m[39m
       [33m[2mâœ“[22m[39m should prevent self-removal [33m 1324[2mms[22m[39m
       [33m[2mâœ“[22m[39m should allow member to leave organization [33m 1725[2mms[22m[39m
       [33m[2mâœ“[22m[39m should allow admin to leave organization [33m 1367[2mms[22m[39m
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould not allow revoking other users sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335796813,"env":"test","module":"auth-routes","userId":"22da0ef9c660c53330431d25c808e968","msg":"User logged in successfully"}
{"level":30,"time":1768335796833,"env":"test","module":"auth-routes","userId":"2e3ac1bd-89c7-45f8-8b8c-caafb5098c3c","msg":"User logged in successfully"}
{"level":30,"time":1768335796867,"env":"test","module":"audit-log-service","userId":"22da0ef9c660c53330431d25c808e968","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335796877,"env":"test","module":"auth-routes","userId":"c46dcd47dc231834e3ed06021fc3a40b","msg":"Login requires MFA verification"}
{"level":30,"time":1768335796888,"env":"test","module":"audit-log-service","userId":"2e3ac1bd-89c7-45f8-8b8c-caafb5098c3c","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335796892,"env":"test","module":"auth-service","tokenHash":"1846d00ef8f8f3d6da88b4ab04875ce45b98f6ede917a06bbb9e7cbb8947701f","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

{"level":30,"time":1768335796916,"env":"test","module":"intake-service","runId":"e2ac5004-00d9-4ab9-b63c-ce689049e05c","slug":"hybrid-jwt-L3aQVcjRxYp8E4XJHYY5i","userId":"38907b0f-9e7d-43ad-a012-d83de8b53aa1","msg":"Created intake run"}
{"level":30,"time":1768335796927,"env":"test","module":"auth-routes","userId":"2a9f9be31dadf6a272b5c7587011ad12","msg":"User logged in successfully"}
{"level":30,"time":1768335796933,"env":"test","module":"user-credentials-repository","userId":"1123289a-b952-4fdd-beb1-f9074c76bd2b","msg":"User credentials created"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould detect and prevent refresh token reuse (token theft)
[22m[39mError deleting test user 834d95dd4dd89ac5bdb4658d5f261480: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth.flows.real.test.ts:47:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/reset-password[2m > [22m[2mshould return 400 for weak new password
[22m[39mError deleting test user 4f8f07694b45901fe83c46218b01bebc: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth.routes.real.test.ts:54:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335796976,"env":"test","module":"audit-log-service","userId":"2a9f9be31dadf6a272b5c7587011ad12","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335796981,"env":"test","module":"mfa-service","userId":"c46dcd47dc231834e3ed06021fc3a40b","msg":"TOTP verification successful"}
{"level":30,"time":1768335796988,"env":"test","module":"user-credentials-repository","userId":"7a3b72f1-6b11-489a-8617-38c9e2ac94a4","msg":"User credentials created"}
{"level":30,"time":1768335797035,"env":"test","module":"auth-routes","userId":"c46dcd47dc231834e3ed06021fc3a40b","msg":"MFA login successful"}
{"level":30,"time":1768335797034,"env":"test","module":"email-queue","jobId":"8f1f2402-578c-4ab0-98eb-58bff678d160","to":"protected-test-sFHK9XgZS-X8e0eflzJ5-@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335797083,"env":"test","module":"auth-routes","userId":"1123289a-b952-4fdd-beb1-f9074c76bd2b","email":"protected-test-sFHK9XgZS-X8e0eflzJ5-@example.com","msg":"User registered"}
{"level":30,"time":1768335797091,"env":"test","module":"email-queue","jobId":"ede47c0b-1363-422d-9024-9a07f4a6f91e","to":"test-workflows-2RWVqGC0ozYcq21ZoZUuo@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335797093,"env":"test","module":"auth-service","tokenHash":"1846d00ef8f8f3d6da88b4ab04875ce45b98f6ede917a06bbb9e7cbb8947701f","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768335797142,"env":"test","module":"auth-service","userId":"2e3ac1bd-89c7-45f8-8b8c-caafb5098c3c","tokenHash":"1846d00ef8f8f3d6da88b4ab04875ce45b98f6ede917a06bbb9e7cbb8947701f","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768335797144,"env":"test","module":"auth-routes","userId":"7a3b72f1-6b11-489a-8617-38c9e2ac94a4","email":"test-workflows-2RWVqGC0ozYcq21ZoZUuo@example.com","msg":"User registered"}
{"level":30,"time":1768335797149,"env":"test","module":"auth-routes","userId":"18336182-b0a6-4f63-aa2e-b68d3d45a344","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle Bearer token with extra spaces
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335797197,"env":"test","module":"auth-service","tokenHash":"35a957997193a7de899082eed1e9b39ae5d1ff727a011abd231fc439d5b2fc06","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768335797201,"env":"test","module":"audit-log-service","userId":"18336182-b0a6-4f63-aa2e-b68d3d45a344","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768335797247,"env":"test","module":"auth-service","userId":"2e3ac1bd-89c7-45f8-8b8c-caafb5098c3c","tokenHash":"35a957997193a7de899082eed1e9b39ae5d1ff727a011abd231fc439d5b2fc06","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mTransfer Validation[2m > [22m[2mshould allow transfer from user to self (org member transferring org asset to themselves)
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:56:21 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335797308,"env":"test","module":"auth-routes","userId":"18336182-b0a6-4f63-aa2e-b68d3d45a344","sessionCount":2,"msg":"Listed active sessions"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould not allow revoking other users sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335797314,"env":"test","module":"user-credentials-repository","userId":"c05b53ae-2d6a-4eca-a102-938b33470804","msg":"User credentials created"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mgetPendingInvitesForUser[2m > [22m[2mshould not return accepted invites
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.acceptInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:797:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:317:13
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":50,"time":1768335797345,"env":"test","error":{},"workflowId":"184eda02-da7d-47b7-a505-07cde625212f","userId":"7a3b72f1-6b11-489a-8617-38c9e2ac94a4","projectId":"a83d7f48-6bf2-44bb-aeb4-23933d7c6a25","msg":"Error moving workflow"}
{"level":30,"time":1768335797366,"env":"test","module":"mfa-service","userId":"22da0ef9c660c53330431d25c808e968","count":10,"msg":"Stored backup codes"}
{"level":30,"time":1768335797366,"env":"test","module":"mfa-service","userId":"22da0ef9c660c53330431d25c808e968","msg":"Generated TOTP secret"}
{"level":30,"time":1768335797366,"env":"test","module":"auth-routes","userId":"22da0ef9c660c53330431d25c808e968","msg":"MFA setup initiated"}
{"level":30,"time":1768335797419,"env":"test","module":"email-queue","jobId":"105b8ed0-f4db-4a8a-9ffd-d283cd8c9679","to":"middleware-test-nc1KsCfhs8bi_OxyMnmKA@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335797469,"env":"test","module":"auth-routes","userId":"c05b53ae-2d6a-4eca-a102-938b33470804","email":"middleware-test-nc1KsCfhs8bi_OxyMnmKA@example.com","msg":"User registered"}
{"level":30,"time":1768335797469,"env":"test","module":"auth-routes","userId":"2a9f9be31dadf6a272b5c7587011ad12","msg":"User logged in successfully"}
{"level":30,"time":1768335797517,"env":"test","module":"audit-log-service","userId":"2a9f9be31dadf6a272b5c7587011ad12","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould authenticate with cookie if JWT not provided
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould list all active sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335797642,"env":"test","module":"user-credentials-repository","userId":"K-z0TA1qeg59IvQ7KiY77","msg":"User credentials created"}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mGET /api/auth/me[2m > [22m[2mshould return current user for valid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335797674,"env":"test","module":"auth-routes","userId":"2a9f9be31dadf6a272b5c7587011ad12","msg":"All other sessions revoked"}
{"level":30,"time":1768335797674,"env":"test","module":"mfa-service","userId":"22da0ef9c660c53330431d25c808e968","msg":"MFA enabled successfully"}
{"level":30,"time":1768335797674,"env":"test","module":"user-credentials-repository","userId":"cc94322a-7593-4bf7-8ef9-fd1a5a104e03","msg":"User credentials created"}
{"level":30,"time":1768335797674,"env":"test","module":"auth-routes","userId":"22da0ef9c660c53330431d25c808e968","msg":"MFA enabled successfully"}
[90mstderr[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39mError deleting test user c46dcd47dc231834e3ed06021fc3a40b: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/trusted.devices.real.test.ts:45:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335797708,"env":"test","module":"auth-routes","userId":"1123289a-b952-4fdd-beb1-f9074c76bd2b","msg":"User logged in successfully"}
{"level":30,"time":1768335797723,"env":"test","module":"audit-log-service","userId":"2a9f9be31dadf6a272b5c7587011ad12","eventType":"all_sessions_revoked","ipAddress":"::ffff:127.0.0.1","hasMetadata":false,"msg":"Security event logged"}
{"level":30,"time":1768335797722,"env":"test","module":"audit-log-service","userId":"22da0ef9c660c53330431d25c808e968","eventType":"mfa_enabled","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould prevent backup code reuse
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335797759,"env":"test","module":"audit-log-service","userId":"1123289a-b952-4fdd-beb1-f9074c76bd2b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768335797764,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768335797764,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335797769,"env":"test","module":"email-queue","jobId":"f2e9f1e3-cc40-40e4-ab1c-69a2ef4cd087","to":"jwt-test-cvwGxrzbkEzWrf6FJSn4T@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335797795,"env":"test","module":"auth-routes","userId":"07ee3be2-eb9a-41a8-b106-323b6d903b69","msg":"User logged in successfully"}
{"level":30,"time":1768335797818,"env":"test","module":"auth-routes","userId":"cc94322a-7593-4bf7-8ef9-fd1a5a104e03","email":"jwt-test-cvwGxrzbkEzWrf6FJSn4T@example.com","msg":"User registered"}
{"level":30,"time":1768335797824,"env":"test","module":"auth-routes","userId":"2a9f9be31dadf6a272b5c7587011ad12","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768335797845,"env":"test","module":"audit-log-service","userId":"07ee3be2-eb9a-41a8-b106-323b6d903b69","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768335797851,"env":"test","error":{"issues":[{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["projectId"]}],"name":"ZodError"},"workflowId":"5a1ce4b7-a2b5-4f02-84af-697b52922c68","userId":"954ef1b8-1572-4c6d-8069-f93b3c874213","projectId":"invalid-uuid","msg":"Error moving workflow"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mLogout Flow[2m > [22m[2mshould revoke refresh token on logout
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335798008,"env":"test","module":"auth-routes","userId":"c05b53ae-2d6a-4eca-a102-938b33470804","msg":"User logged in successfully"}
{"level":30,"time":1768335798060,"env":"test","module":"audit-log-service","userId":"c05b53ae-2d6a-4eca-a102-938b33470804","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335798117,"env":"test","module":"user-credentials-repository","userId":"TYSlKJdfbEesx0aTRfVMP","msg":"User credentials created"}
{"level":30,"time":1768335798141,"env":"test","module":"auth-routes","userId":"6c08b77d109734d64855114e6d38a72e","msg":"User logged in successfully"}
{"level":30,"time":1768335798147,"env":"test","module":"auth-routes","userId":"291f5c388986d4afbcf9ec9f7f9167cc","msg":"User logged in successfully"}
{"level":30,"time":1768335798165,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768335798165,"env":"test","module":"user-credentials-repository","userId":"8c3b2278-155c-42ae-a466-f797ccd07e89","msg":"User credentials created"}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335798165,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335798170,"env":"test","module":"auth-service","tokenHash":"b435ece39ac4bfcb2c98f7e2ef5cc73c7b91a398a51dee24be873fe9852da18b","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768335798190,"env":"test","module":"audit-log-service","userId":"6c08b77d109734d64855114e6d38a72e","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335798198,"env":"test","module":"audit-log-service","userId":"291f5c388986d4afbcf9ec9f7f9167cc","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould list all active sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335798218,"env":"test","module":"auth-routes","userId":"22da0ef9c660c53330431d25c808e968","msg":"Login requires MFA verification"}
 [32mâœ“[39m tests/integration/transferOwnership.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 20038[2mms[22m[39m
       [33m[2mâœ“[22m[39m should transfer user-owned project to org [33m 2197[2mms[22m[39m
       [33m[2mâœ“[22m[39m should prevent transfer to org if user is not a member [33m 1662[2mms[22m[39m
       [33m[2mâœ“[22m[39m should allow org member to transfer org-owned project to another org they belong to [33m 2374[2mms[22m[39m
       [33m[2mâœ“[22m[39m should detach workflow from project when transferring to different owner [33m 1999[2mms[22m[39m
       [33m[2mâœ“[22m[39m should keep workflow in project when transferring to same owner [33m 1738[2mms[22m[39m
       [33m[2mâœ“[22m[39m should prevent non-member from transferring org workflow [33m 1704[2mms[22m[39m
       [33m[2mâœ“[22m[39m should transfer database ownership [33m 1081[2mms[22m[39m
       [33m[2mâœ“[22m[39m should allow org member to transfer org database [33m 1446[2mms[22m[39m
       [33m[2mâœ“[22m[39m should prevent transfer to org if user is not a member [33m 1990[2mms[22m[39m
       [33m[2mâœ“[22m[39m should only allow transfer to self when targetOwnerType is user [33m 1252[2mms[22m[39m
       [33m[2mâœ“[22m[39m should allow transfer from user to self (org member transferring org asset to themselves) [33m 1559[2mms[22m[39m
{"level":30,"time":1768335798273,"env":"test","module":"email-queue","jobId":"709668cc-38cc-4060-b92c-50734dc0d10c","to":"protected-test-xy46XkFQercRPYnZBOaqt@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335798329,"env":"test","module":"auth-routes","userId":"8c3b2278-155c-42ae-a466-f797ccd07e89","email":"protected-test-xy46XkFQercRPYnZBOaqt@example.com","msg":"User registered"}
{"level":30,"time":1768335798334,"env":"test","module":"user-credentials-repository","userId":"b06a7aca-517d-403f-bce4-a55ad9549826","msg":"User credentials created"}
{"level":30,"time":1768335798353,"env":"test","module":"auth-routes","userId":"cc94322a-7593-4bf7-8ef9-fd1a5a104e03","msg":"User logged in successfully"}
{"level":50,"time":1768335798358,"env":"test","error":{"issues":[{"code":"invalid_type","expected":"string","received":"undefined","path":["projectId"],"message":"Required"}],"name":"ZodError"},"workflowId":"bb34440b-fadd-4f60-a404-9ed337653b1f","userId":"954ef1b8-1572-4c6d-8069-f93b3c874213","msg":"Error moving workflow"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all other sessions
[22m[39mError deleting test user 2a9f9be31dadf6a272b5c7587011ad12: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/session.management.real.test.ts:44:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335798386,"env":"test","module":"auth-service","tokenHash":"b435ece39ac4bfcb2c98f7e2ef5cc73c7b91a398a51dee24be873fe9852da18b","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768335798400,"env":"test","module":"audit-log-service","userId":"cc94322a-7593-4bf7-8ef9-fd1a5a104e03","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335798435,"env":"test","module":"mfa-service","userId":"22da0ef9c660c53330431d25c808e968","msg":"Backup code verified and consumed"}
{"level":40,"time":1768335798438,"env":"test","module":"auth-service","userId":"TYSlKJdfbEesx0aTRfVMP","tokenHash":"b435ece39ac4bfcb2c98f7e2ef5cc73c7b91a398a51dee24be873fe9852da18b","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle very long invalid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335798439,"env":"test","module":"email-queue","jobId":"4e10e6c2-d05a-4680-955e-1713b5a53380","to":"session-test-OHlFpYoKXYCk-nsHWQvJ0@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335798458,"env":"test","module":"auth-service","tokenHash":"d03f4bfde57725ec24b4732ab8bad7dc11c7262a5320350a6a59637c72c274b5","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768335798486,"env":"test","module":"auth-routes","userId":"22da0ef9c660c53330431d25c808e968","msg":"MFA login successful"}
{"level":30,"time":1768335798494,"env":"test","module":"auth-routes","userId":"b06a7aca-517d-403f-bce4-a55ad9549826","email":"session-test-OHlFpYoKXYCk-nsHWQvJ0@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould prevent backup code reuse
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768335798507,"env":"test","module":"auth-service","userId":"cc94322a-7593-4bf7-8ef9-fd1a5a104e03","tokenHash":"d03f4bfde57725ec24b4732ab8bad7dc11c7262a5320350a6a59637c72c274b5","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
[90mstderr[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39mError deleting test user 309229eb3408c5bb210376eb3797eadd: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/trusted.devices.real.test.ts:45:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

{"level":30,"time":1768335798575,"env":"test","module":"intake-service","runId":"940923f9-2ec0-496c-9927-da2408ba9557","slug":"hybrid-cookie-ssggBxU646qRWP9X9UoDP","msg":"Created intake run"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould return 404 for non-existent session ID
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335798684,"env":"test","module":"auth-routes","userId":"291f5c388986d4afbcf9ec9f7f9167cc","msg":"User logged in successfully"}
{"level":30,"time":1768335798736,"env":"test","module":"audit-log-service","userId":"291f5c388986d4afbcf9ec9f7f9167cc","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mrevokeInvite[2m > [22m[2mshould allow admin to revoke invite
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:52:21 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335798767,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mGET /api/auth/me[2m > [22m[2mshould return current user for valid token
[22m[39mError deleting test user 6c08b77d109734d64855114e6d38a72e: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth.routes.real.test.ts:54:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":50,"time":1768335798820,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768335798825,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335798830,"env":"test","module":"user-credentials-repository","userId":"xz0ZXIIkUre7k2_u98wtf","msg":"User credentials created"}
{"level":30,"time":1768335798850,"env":"test","module":"auth-routes","userId":"291f5c388986d4afbcf9ec9f7f9167cc","sessionCount":2,"msg":"Listed active sessions"}
{"level":30,"time":1768335798966,"env":"test","module":"user-credentials-repository","userId":"333aa149-a4ec-4499-a3a1-dc7755b431ed","msg":"User credentials created"}
{"level":30,"time":1768335798979,"env":"test","module":"auth-routes","userId":"8c3b2278-155c-42ae-a466-f797ccd07e89","msg":"User logged in successfully"}
{"level":30,"time":1768335798993,"env":"test","module":"user-credentials-repository","userId":"708a09be-22b8-4862-b30c-06d24ce104bc","msg":"User credentials created"}
{"level":30,"time":1768335799030,"env":"test","module":"audit-log-service","userId":"8c3b2278-155c-42ae-a466-f797ccd07e89","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768335799034,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335799038,"env":"test","module":"auth-routes","userId":"22da0ef9c660c53330431d25c808e968","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould keep current session active
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335799063,"env":"test","module":"email-queue","jobId":"85c5a135-5aa3-4a63-9d60-768255bf2477","to":"jwt-test-Z23Jjki379Y2FuPGdr8zu@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335799093,"env":"test","module":"email-queue","jobId":"de2268ee-3d24-4438-989b-8ec69d64c69f","to":"middleware-test-lMLIrfLXs7Spf8Oa96i1g@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335799093,"env":"test","module":"auth-routes","userId":"b06a7aca-517d-403f-bce4-a55ad9549826","msg":"User logged in successfully"}
{"level":30,"time":1768335799111,"env":"test","module":"auth-routes","userId":"333aa149-a4ec-4499-a3a1-dc7755b431ed","email":"jwt-test-Z23Jjki379Y2FuPGdr8zu@example.com","msg":"User registered"}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335799146,"env":"test","module":"auth-routes","userId":"708a09be-22b8-4862-b30c-06d24ce104bc","email":"middleware-test-lMLIrfLXs7Spf8Oa96i1g@example.com","msg":"User registered"}
{"level":30,"time":1768335799148,"env":"test","module":"audit-log-service","userId":"b06a7aca-517d-403f-bce4-a55ad9549826","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mLogout Flow[2m > [22m[2mshould clear refresh token cookie on logout
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335799196,"env":"test","module":"user-credentials-repository","userId":"ba98d872-2039-49a9-a99d-138c4fda1ebe","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould proceed anonymously if no auth provided
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335799258,"env":"test","module":"email-queue","jobId":"87c9f922-c61b-44d9-8569-ea75c4c3d870","to":"existing_1768335765585@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
{"level":30,"time":1768335799297,"env":"test","module":"email-queue","jobId":"c5c3548c-57d6-45e0-a2e6-410dc8a782c5","to":"test-workflows-HXGtpUay4PsPQ-aJijzDd@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39m[TEST UTILS] MFA Secret verified for 77079c77d864eca81530dc201495619a

{"level":30,"time":1768335799320,"env":"test","module":"user-credentials-repository","userId":"FIST96QThjyNIVWSf6-jX","msg":"User credentials created"}
{"level":30,"time":1768335799352,"env":"test","module":"auth-routes","userId":"ba98d872-2039-49a9-a99d-138c4fda1ebe","email":"test-workflows-HXGtpUay4PsPQ-aJijzDd@example.com","msg":"User registered"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mrevokeInvite[2m > [22m[2mshould allow admin to revoke invite
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:548:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:327:34
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335799370,"env":"test","module":"auth-service","tokenHash":"eda98eef66d1896421f66a05aa0261b273b7793ee1968080927099cd045020bb","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould list all active sessions
[22m[39mError deleting test user 291f5c388986d4afbcf9ec9f7f9167cc: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth.flows.real.test.ts:47:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

[90mstdout[2m | tests/integration/api.workflows.test.ts[2m > [22m[2mWorkflows API Integration Tests[2m > [22m[2mPUT /api/workflows/:id/move[2m > [22m[2mshould reject move to project user does not have access to
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335799422,"env":"test","module":"user-credentials-repository","userId":"04250321-9a98-44b7-b1e1-7278d98ad9f0","msg":"User credentials created"}
{"level":30,"time":1768335799520,"env":"test","module":"email-queue","jobId":"8aa9c4ea-954c-4dfb-b4a8-62ae334ef139","to":"protected-test-KCou8uXBMD7epXip7eJwR@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335799549,"env":"test","module":"auth-routes","userId":"bcd604996a2d685957b4ace8f4505743","msg":"User logged in successfully"}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w21
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":30,"time":1768335799568,"env":"test","module":"auth-routes","userId":"04250321-9a98-44b7-b1e1-7278d98ad9f0","email":"protected-test-KCou8uXBMD7epXip7eJwR@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335799600,"env":"test","module":"audit-log-service","userId":"bcd604996a2d685957b4ace8f4505743","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w21 (Reused: true)

{"level":30,"time":1768335799605,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould keep current session active
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335799609,"env":"test","module":"user-credentials-repository","userId":"e53c2cb5-89d0-4cbb-b6db-c5a68939355b","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould complete MFA login with valid TOTP code
[22m[39m[TEST UTILS] MFA Secret verified for a0130b05e1e9c829eb3d1f99754ceb33

{"level":30,"time":1768335799637,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335799661,"env":"test","module":"auth-routes","userId":"333aa149-a4ec-4499-a3a1-dc7755b431ed","msg":"User logged in successfully"}
{"level":40,"time":1768335799664,"env":"test","module":"mfa-service","userId":"22da0ef9c660c53330431d25c808e968","msg":"Invalid backup code provided"}
{"level":40,"time":1768335799664,"env":"test","module":"auth-routes","userId":"22da0ef9c660c53330431d25c808e968","msg":"MFA verification failed during login"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle empty Authorization header
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335799701,"env":"test","module":"auth-routes","userId":"708a09be-22b8-4862-b30c-06d24ce104bc","msg":"User logged in successfully"}
{"level":30,"time":1768335799709,"env":"test","module":"email-queue","jobId":"f15d4d39-a1f8-4ac3-9405-ad46e7b8f96c","to":"session-test-qp6cZrHYCz5jQLQphg5jP@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335799709,"env":"test","module":"audit-log-service","userId":"333aa149-a4ec-4499-a3a1-dc7755b431ed","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335799749,"env":"test","module":"audit-log-service","userId":"708a09be-22b8-4862-b30c-06d24ce104bc","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335799763,"env":"test","module":"auth-routes","userId":"e53c2cb5-89d0-4cbb-b6db-c5a68939355b","email":"session-test-qp6cZrHYCz5jQLQphg5jP@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all sessions except current
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould complete MFA login with valid TOTP code
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mrevokeInvite[2m > [22m[2mshould allow admin to revoke invite
[22m[39mFailed to write audit log: error: insert or update on table "audit_logs" violates foreign key constraint "audit_logs_workspace_id_workspaces_id_fk"
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.revokeInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:840:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:333:13
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m341[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'23503'[39m,
  detail: [32m'Key (workspace_id)=(00000000-0000-0000-0000-000000000098) is not present in table "workspaces".'[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [32m'public'[39m,
  table: [32m'audit_logs'[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [32m'audit_logs_workspace_id_workspaces_id_fk'[39m,
  file: [32m'ri_triggers.c'[39m,
  line: [32m'2599'[39m,
  routine: [32m'ri_ReportViolation'[39m
}

{"level":30,"time":1768335799917,"env":"test","module":"user-credentials-repository","userId":"3NRFxm9zbbahw6B7R6a2x","msg":"User credentials created"}
{"level":30,"time":1768335799924,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335799925,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/services/WorkflowTemplateService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 15792[2mms[22m[39m
       [33m[2mâœ“[22m[39m should throw error if template belongs to different project [33m 603[2mms[22m[39m
       [33m[2mâœ“[22m[39m should automatically unset other primaries when setting new primary [33m 1017[2mms[22m[39m
         [33m[2mâœ“[22m[39m should list all templates for workflow version [33m 779[2mms[22m[39m
         [33m[2mâœ“[22m[39m should return empty array for version with no templates [33m 574[2mms[22m[39m
         [33m[2mâœ“[22m[39m should get template mapping by id and version [33m 665[2mms[22m[39m
         [33m[2mâœ“[22m[39m should throw error if mapping not found [33m 505[2mms[22m[39m
         [33m[2mâœ“[22m[39m should get template by key [33m 672[2mms[22m[39m
         [33m[2mâœ“[22m[39m should throw error if key not found [33m 527[2mms[22m[39m
         [33m[2mâœ“[22m[39m should get primary template for workflow version [33m 750[2mms[22m[39m
         [33m[2mâœ“[22m[39m should return null when no primary template exists [33m 638[2mms[22m[39m
         [33m[2mâœ“[22m[39m should update mapping key [33m 730[2mms[22m[39m
         [33m[2mâœ“[22m[39m should update isPrimary flag [33m 778[2mms[22m[39m
         [33m[2mâœ“[22m[39m should throw error if new key already exists [33m 755[2mms[22m[39m
         [33m[2mâœ“[22m[39m should throw error if mapping not found [33m 520[2mms[22m[39m
         [33m[2mâœ“[22m[39m should unset other primaries when setting isPrimary to true [33m 1049[2mms[22m[39m
         [33m[2mâœ“[22m[39m should detach template from workflow version [33m 711[2mms[22m[39m
         [33m[2mâœ“[22m[39m should throw error if mapping not found [33m 512[2mms[22m[39m
         [33m[2mâœ“[22m[39m should set template as primary [33m 955[2mms[22m[39m
         [33m[2mâœ“[22m[39m should throw error if mapping not found [33m 531[2mms[22m[39m
         [33m[2mâœ“[22m[39m should support operations within a transaction [33m 755[2mms[22m[39m
         [33m[2mâœ“[22m[39m should rollback on transaction error [33m 735[2mms[22m[39m
{"level":30,"time":1768335799945,"env":"test","module":"auth-routes","userId":"ba98d872-2039-49a9-a99d-138c4fda1ebe","msg":"User logged in successfully"}
{"level":30,"time":1768335799968,"env":"test","module":"auth-service","tokenHash":"1742077aef77cc871a0e7f4964d33a45f072a328496fa2e1483e768cbecc9cd6","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768335799998,"env":"test","module":"audit-log-service","userId":"ba98d872-2039-49a9-a99d-138c4fda1ebe","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335800038,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335800038,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335800090,"env":"test","module":"auth-routes","userId":"77079c77d864eca81530dc201495619a","msg":"Login requires MFA verification"}
{"level":30,"time":1768335800098,"env":"test","module":"auth-routes","userId":"bcd604996a2d685957b4ace8f4505743","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335800153,"env":"test","module":"audit-log-service","userId":"bcd604996a2d685957b4ace8f4505743","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335800192,"env":"test","module":"auth-routes","userId":"04250321-9a98-44b7-b1e1-7278d98ad9f0","msg":"User logged in successfully"}
{"level":30,"time":1768335800198,"env":"test","module":"mfa-service","userId":"77079c77d864eca81530dc201495619a","msg":"TOTP verification successful"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould prevent backup code reuse
[22m[39mError deleting test user 22da0ef9c660c53330431d25c808e968: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/mfa.flow.real.test.ts:46:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335800239,"env":"test","module":"audit-log-service","userId":"04250321-9a98-44b7-b1e1-7278d98ad9f0","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768335800244,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335800254,"env":"test","module":"auth-routes","userId":"77079c77d864eca81530dc201495619a","msg":"MFA login successful"}
{"level":30,"time":1768335800261,"env":"test","module":"intake-service","runId":"0175b9f8-fca6-4e68-8f22-07511583ce29","slug":"hybrid-anon-EqD85XhissVJxRrnUenyE","msg":"Created intake run"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768335800308,"env":"test","module":"auth-routes","userId":"bcd604996a2d685957b4ace8f4505743","msg":"All other sessions revoked"}
 [32mâœ“[39m tests/integration/auth/jwt.authentication.test.ts [2m([22m[2m27 tests[22m[2m)[22m[33m 24853[2mms[22m[39m
       [33m[2mâœ“[22m[39m should generate valid JWT token on successful login [33m 1301[2mms[22m[39m
       [33m[2mâœ“[22m[39m should include correct payload in JWT token [33m 1215[2mms[22m[39m
       [33m[2mâœ“[22m[39m should set JWT expiry to 15 minutes [33m 1159[2mms[22m[39m
       [33m[2mâœ“[22m[39m should accept valid JWT token on protected routes [33m 1291[2mms[22m[39m
       [33m[2mâœ“[22m[39m should accept request with missing Bearer prefix (lenient) [33m 1282[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject expired JWT token [33m 1107[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return token_expired error code for expired tokens [33m 1105[2mms[22m[39m
       [33m[2mâœ“[22m[39m should exchange valid session cookie for JWT token [33m 700[2mms[22m[39m
       [33m[2mâœ“[22m[39m should prefer Bearer token over cookie when both present [33m 1231[2mms[22m[39m
       [33m[2mâœ“[22m[39m should fall back to cookie if Bearer token is invalid [33m 531[2mms[22m[39m
       [33m[2mâœ“[22m[39m should allow GET requests with cookie auth only [33m 1290[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject POST requests with cookie auth only (mutation-strict) [33m 553[2mms[22m[39m
       [33m[2mâœ“[22m[39m should allow anonymous access to public workflows [33m 459[2mms[22m[39m
       [33m[2mâœ“[22m[39m should attach user info if authenticated on optional auth routes [33m 461[2mms[22m[39m
       [33m[2mâœ“[22m[39m should refresh access token using refresh token [33m 2329[2mms[22m[39m
       [33m[2mâœ“[22m[39m should rotate refresh token on use [33m 1500[2mms[22m[39m
       [33m[2mâœ“[22m[39m should detect token reuse and revoke all user tokens [33m 2075[2mms[22m[39m
       [33m[2mâœ“[22m[39m should revoke refresh token on logout [33m 1260[2mms[22m[39m
       [33m[2mâœ“[22m[39m should clear refresh token cookie on logout [33m 1210[2mms[22m[39m
{"level":30,"time":1768335800360,"env":"test","module":"audit-log-service","userId":"bcd604996a2d685957b4ace8f4505743","eventType":"all_sessions_revoked","ipAddress":"::ffff:127.0.0.1","hasMetadata":false,"msg":"Security event logged"}
{"level":50,"time":1768335800360,"env":"test","error":{},"workflowId":"8725b559-a4ae-4e8a-8233-6d5f5b326877","userId":"954ef1b8-1572-4c6d-8069-f93b3c874213","projectId":"46f5b80a-02f4-40ec-a610-95273fb63586","msg":"Error moving workflow"}
{"level":30,"time":1768335800358,"env":"test","module":"auth-routes","userId":"e53c2cb5-89d0-4cbb-b6db-c5a68939355b","msg":"User logged in successfully"}
{"level":30,"time":1768335800371,"env":"test","module":"auth-routes","userId":"a0130b05e1e9c829eb3d1f99754ceb33","msg":"Login requires MFA verification"}
{"level":30,"time":1768335800408,"env":"test","module":"auth-routes","userId":"77079c77d864eca81530dc201495619a","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768335800409,"env":"test","module":"audit-log-service","userId":"e53c2cb5-89d0-4cbb-b6db-c5a68939355b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all sessions except current
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335800469,"env":"test","module":"auth-service","tokenHash":"0a2eedeed4ec236e244a1be228eeef4b40dd6c1269a14236b77a62907dcac275","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768335800478,"env":"test","module":"mfa-service","userId":"a0130b05e1e9c829eb3d1f99754ceb33","msg":"TOTP verification successful"}
{"level":30,"time":1768335800527,"env":"test","module":"user-credentials-repository","userId":"FiPW62Ko-_UFP9vXzJ18z","msg":"User credentials created"}
{"level":30,"time":1768335800526,"env":"test","module":"auth-routes","userId":"a0130b05e1e9c829eb3d1f99754ceb33","msg":"MFA login successful"}
{"level":30,"time":1768335800582,"env":"test","module":"auth-service","tokenHash":"7caef7af2b2e13157938a196b0b0d020151d434d7c0ed3b9939c95ee25a6c120","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768335800636,"env":"test","module":"auth-routes","userId":"8d46cde6f52854682013779494411735","msg":"User logged in successfully"}
{"level":30,"time":1768335800668,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335800669,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335800679,"env":"test","module":"user-credentials-repository","userId":"0a2bc83b-49d8-4941-9b20-b51540211e00","msg":"User credentials created"}
{"level":30,"time":1768335800683,"env":"test","module":"user-credentials-repository","userId":"5b638e81-c942-41ae-824e-04b20e12d411","msg":"User credentials created"}
{"level":30,"time":1768335800692,"env":"test","module":"audit-log-service","userId":"8d46cde6f52854682013779494411735","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768335800783,"env":"test","module":"email-queue","jobId":"c38a0418-ec38-4a97-ac5e-45a67685e237","to":"middleware-test-n35QARS1yMzY8beXpA9os@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335800787,"env":"test","module":"email-queue","jobId":"d1553a3b-f5fa-4432-827f-a6779371fbc6","to":"protected-test-x9Q5LTGwsqMQ2mMK-7FHt@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335800834,"env":"test","module":"auth-routes","userId":"0a2bc83b-49d8-4941-9b20-b51540211e00","email":"middleware-test-n35QARS1yMzY8beXpA9os@example.com","msg":"User registered"}
{"level":30,"time":1768335800839,"env":"test","module":"auth-routes","userId":"5b638e81-c942-41ae-824e-04b20e12d411","email":"protected-test-x9Q5LTGwsqMQ2mMK-7FHt@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould proceed anonymously if both JWT and cookie are invalid
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335800909,"env":"test","module":"auth-routes","userId":"e53c2cb5-89d0-4cbb-b6db-c5a68939355b","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle Authorization header with only Bearer
[22m[39mDEBUG: LOGIN HANDLER HIT

 [32mâœ“[39m tests/integration/api.workflows.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 16312[2mms[22m[39m
       [33m[2mâœ“[22m[39m should create a new draft workflow [33m 371[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject without permission [33m 661[2mms[22m[39m
       [33m[2mâœ“[22m[39m should list workflows [33m 511[2mms[22m[39m
       [33m[2mâœ“[22m[39m should filter by status [33m 520[2mms[22m[39m
       [33m[2mâœ“[22m[39m should search by name [33m 871[2mms[22m[39m
       [33m[2mâœ“[22m[39m should update draft workflow [33m 680[2mms[22m[39m
       [33m[2mâœ“[22m[39m should not allow editing published workflow [33m 830[2mms[22m[39m
       [33m[2mâœ“[22m[39m should publish workflow [33m 733[2mms[22m[39m
       [33m[2mâœ“[22m[39m should list workflow versions [33m 900[2mms[22m[39m
       [33m[2mâœ“[22m[39m should move workflow to a project [33m 1553[2mms[22m[39m
       [33m[2mâœ“[22m[39m should move workflow to Main Folder (projectId = null) [33m 1105[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject move to non-existent project [33m 622[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject move without authentication [33m 476[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject move of workflow user does not own [33m 1200[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject move with invalid projectId format [33m 506[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject move without projectId in body [33m 507[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject move to project user does not have access to [33m 2003[2mms[22m[39m
{"level":30,"time":1768335800958,"env":"test","module":"auth-routes","userId":"77079c77d864eca81530dc201495619a","msg":"Login from trusted device - MFA skipped"}
{"level":30,"time":1768335800959,"env":"test","module":"audit-log-service","userId":"e53c2cb5-89d0-4cbb-b6db-c5a68939355b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all sessions except current
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335801010,"env":"test","module":"auth-routes","userId":"77079c77d864eca81530dc201495619a","msg":"User logged in successfully"}
{"level":30,"time":1768335801062,"env":"test","module":"audit-log-service","userId":"77079c77d864eca81530dc201495619a","eventType":"login_success","ipAddress":"192.168.1.100","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould try TOTP before backup code
[22m[39m[TEST UTILS] MFA Secret verified for d950f9f04d49da11a307eafa57f7a113

[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould complete MFA login with valid TOTP code
[22m[39mError deleting test user a0130b05e1e9c829eb3d1f99754ceb33: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth.routes.real.test.ts:54:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335801146,"env":"test","module":"user-credentials-repository","userId":"5M5UAsABxu2oXIJGdYYJT","msg":"User credentials created"}
{"level":30,"time":1768335801197,"env":"test","module":"auth-routes","userId":"8d46cde6f52854682013779494411735","msg":"User logged in successfully"}
{"level":30,"time":1768335801202,"env":"test","module":"auth-service","tokenHash":"aa5ed48e2e2a1d508e46284e7dc66666db7d025b6bb6d1ffecec0ef4afce4917","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould keep current session active
[22m[39mError deleting test user bcd604996a2d685957b4ace8f4505743: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/session.management.real.test.ts:44:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335801252,"env":"test","module":"audit-log-service","userId":"8d46cde6f52854682013779494411735","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335801360,"env":"test","module":"auth-routes","userId":"8d46cde6f52854682013779494411735","sessionCount":2,"msg":"Listed active sessions"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mrevokeInvite[2m > [22m[2mshould prevent accepting revoked invite
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:52:21 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould try TOTP before backup code
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335801432,"env":"test","module":"auth-routes","userId":"0a2bc83b-49d8-4941-9b20-b51540211e00","msg":"User logged in successfully"}
{"level":30,"time":1768335801484,"env":"test","module":"audit-log-service","userId":"0a2bc83b-49d8-4941-9b20-b51540211e00","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335801496,"env":"test","module":"auth-routes","userId":"e53c2cb5-89d0-4cbb-b6db-c5a68939355b","msg":"User logged in successfully"}
{"level":30,"time":1768335801509,"env":"test","module":"auth-routes","userId":"5b638e81-c942-41ae-824e-04b20e12d411","msg":"User logged in successfully"}
{"level":30,"time":1768335801518,"env":"test","module":"auth-routes","userId":"8d46cde6f52854682013779494411735","sessionId":"2fc7a75b-5017-4514-a4e8-5db446961b7b","msg":"Session revoked"}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335801549,"env":"test","module":"audit-log-service","userId":"e53c2cb5-89d0-4cbb-b6db-c5a68939355b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768335801565,"env":"test","module":"audit-log-service","userId":"5b638e81-c942-41ae-824e-04b20e12d411","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768335801572,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335801598,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335801599,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39mError deleting test user 77079c77d864eca81530dc201495619a: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/trusted.devices.real.test.ts:45:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335801638,"env":"test","module":"auth-routes","userId":"8d46cde6f52854682013779494411735","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768335801702,"env":"test","module":"auth-routes","userId":"e53c2cb5-89d0-4cbb-b6db-c5a68939355b","msg":"All other sessions revoked"}
{"level":30,"time":1768335801757,"env":"test","module":"audit-log-service","userId":"e53c2cb5-89d0-4cbb-b6db-c5a68939355b","eventType":"all_sessions_revoked","ipAddress":"::1","hasMetadata":false,"msg":"Security event logged"}
{"level":30,"time":1768335801761,"env":"test","module":"auth-service","tokenHash":"0775e6e43b3e34571ff80eb11c35d09f455e1cfac77ca63a75270e46ec2a78cb","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
 [32mâœ“[39m tests/integration/auth/oauth2.token-refresh.test.ts [2m([22m[2m25 tests[22m[2m)[22m[33m 22304[2mms[22m[39m
       [33m[2mâœ“[22m[39m should refresh access token with valid refresh token [33m 669[2mms[22m[39m
       [33m[2mâœ“[22m[39m should rotate refresh token after use [33m 721[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 401 when refresh token is missing [33m 400[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 401 for invalid refresh token [33m 814[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 401 for expired refresh token [33m 1228[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 401 for revoked refresh token [33m 540[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 401 when user is not found [33m 789[2mms[22m[39m
       [33m[2mâœ“[22m[39m should update refresh token metadata on rotation [33m 637[2mms[22m[39m
       [33m[2mâœ“[22m[39m should handle concurrent refresh token requests (token reuse detection) [33m 829[2mms[22m[39m
       [33m[2mâœ“[22m[39m should set secure cookie in production [33m 589[2mms[22m[39m
       [33m[2mâœ“[22m[39m should set proper cookie attributes [33m 578[2mms[22m[39m
       [33m[2mâœ“[22m[39m should include user role information in response [33m 574[2mms[22m[39m
       [33m[2mâœ“[22m[39m should create refresh token on login [33m 1068[2mms[22m[39m
       [33m[2mâœ“[22m[39m should revoke refresh token on logout [33m 485[2mms[22m[39m
       [33m[2mâœ“[22m[39m should handle logout without refresh token gracefully [33m 385[2mms[22m[39m
       [33m[2mâœ“[22m[39m should support multiple active refresh tokens per user [33m 534[2mms[22m[39m
       [33m[2mâœ“[22m[39m should revoke all user tokens on password reset [33m 605[2mms[22m[39m
       [33m[2mâœ“[22m[39m should use cryptographically strong random tokens [33m 5526[2mms[22m[39m
       [33m[2mâœ“[22m[39m should hash refresh tokens before storing in database [33m 480[2mms[22m[39m
       [33m[2mâœ“[22m[39m should prevent refresh token reuse after rotation [33m 698[2mms[22m[39m
       [33m[2mâœ“[22m[39m should validate token ownership [33m 493[2mms[22m[39m
       [33m[2mâœ“[22m[39m should set HttpOnly flag to prevent XSS [33m 591[2mms[22m[39m
       [33m[2mâœ“[22m[39m should set SameSite=Strict to prevent CSRF [33m 589[2mms[22m[39m
       [33m[2mâœ“[22m[39m should set proper cookie path [33m 616[2mms[22m[39m
       [33m[2mâœ“[22m[39m should set appropriate expiry (30 days) [33m 613[2mms[22m[39m
{"level":30,"time":1768335801871,"env":"test","module":"email-queue","jobId":"b3312369-7ad7-498f-b7c7-7964ff1bc15e","to":"existing_1768335765585@test.com","subject":"You've been invited to join Invite Test Org","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould reject invalid MFA code
[22m[39m[TEST UTILS] MFA Secret verified for ad77127e82279b943e4caa1b068143f2

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

{"level":30,"time":1768335801941,"env":"test","module":"auth-routes","userId":"d950f9f04d49da11a307eafa57f7a113","msg":"Login requires MFA verification"}
{"level":30,"time":1768335801964,"env":"test","module":"auth-service","tokenHash":"1bd1df043cee701910fcf4188a2242977806036aafbd7cb9c890d30256827396","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould return 400 if no active session found
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mrevokeInvite[2m > [22m[2mshould prevent accepting revoked invite
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:548:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:343:34
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335801981,"env":"test","module":"intake-service","runId":"2e91667e-d85d-41f7-9c6a-12690f278293","slug":"hybrid-invalid-aX44ZyuIiyh46Gqr9aniA","msg":"Created intake run"}
{"level":30,"time":1768335801999,"env":"test","module":"user-credentials-repository","userId":"f6d88072-bdc0-496e-9e37-d01f1c7711be","msg":"User credentials created"}
{"level":40,"time":1768335802017,"env":"test","module":"auth-service","userId":"e53c2cb5-89d0-4cbb-b6db-c5a68939355b","tokenHash":"1bd1df043cee701910fcf4188a2242977806036aafbd7cb9c890d30256827396","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768335802044,"env":"test","module":"mfa-service","userId":"d950f9f04d49da11a307eafa57f7a113","msg":"TOTP verification successful"}
{"level":30,"time":1768335802078,"env":"test","module":"auth-service","tokenHash":"78557d9aad3ef88d72f2d7d64c911fdc77fc25d60be30dd744c24f2ef3733186","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768335802096,"env":"test","module":"auth-routes","userId":"d950f9f04d49da11a307eafa57f7a113","msg":"MFA login successful"}
{"level":30,"time":1768335802102,"env":"test","module":"email-queue","jobId":"68c1971e-e558-4e75-99e2-0d3eb0a5cbf5","to":"protected-test-ld47RCA0odgozY5PfxQtH@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":40,"time":1768335802125,"env":"test","module":"auth-service","userId":"e53c2cb5-89d0-4cbb-b6db-c5a68939355b","tokenHash":"78557d9aad3ef88d72f2d7d64c911fdc77fc25d60be30dd744c24f2ef3733186","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768335802153,"env":"test","module":"auth-routes","userId":"f6d88072-bdc0-496e-9e37-d01f1c7711be","email":"protected-test-ld47RCA0odgozY5PfxQtH@example.com","msg":"User registered"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mError deleting test user 8d46cde6f52854682013779494411735: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth.flows.real.test.ts:47:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335802178,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335802178,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle multiple Authorization headers
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w23
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":40,"time":1768335802292,"env":"test","module":"mfa-service","userId":"ad77127e82279b943e4caa1b068143f2","msg":"TOTP verification failed"}
{"level":40,"time":1768335802292,"env":"test","module":"auth-routes","userId":"ad77127e82279b943e4caa1b068143f2","msg":"MFA verification failed during login"}
 [32mâœ“[39m tests/integration/auth.flows.real.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 34221[2mms[22m[39m
       [33m[2mâœ“[22m[39m should complete registration, verify email, then login [33m 2211[2mms[22m[39m
       [33m[2mâœ“[22m[39m should lock account after 5 failed attempts, then unlock after waiting [33m 4244[2mms[22m[39m
       [33m[2mâœ“[22m[39m should record all login attempts [33m 2815[2mms[22m[39m
       [33m[2mâœ“[22m[39m should complete MFA setup and login with TOTP [33m 3391[2mms[22m[39m
       [33m[2mâœ“[22m[39m should login with backup code when TOTP unavailable [33m 4690[2mms[22m[39m
       [33m[2mâœ“[22m[39m should complete full password reset flow [33m 3301[2mms[22m[39m
       [33m[2mâœ“[22m[39m should invalidate all sessions after password reset [33m 2774[2mms[22m[39m
       [33m[2mâœ“[22m[39m should rotate refresh token on each use [33m 2371[2mms[22m[39m
       [33m[2mâœ“[22m[39m should detect and prevent refresh token reuse (token theft) [33m 2184[2mms[22m[39m
       [33m[2mâœ“[22m[39m should list all active sessions [33m 2449[2mms[22m[39m
       [33m[2mâœ“[22m[39m should revoke specific session [33m 2781[2mms[22m[39m
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w23 (Reused: true)

{"level":30,"time":1768335802318,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335802365,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335802399,"env":"test","module":"user-credentials-repository","userId":"ce1bb8cd-e6ca-4f47-b0aa-d73ca84552c1","msg":"User credentials created"}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w20
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39m[TEST UTILS] MFA Secret verified for 6ef30937a14e99c5b054cecf2801969b

{"level":30,"time":1768335802464,"env":"test","module":"auth-routes","userId":"1fcf2a843871d97d855f1b89597956a6","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w20 (Reused: true)

{"level":30,"time":1768335802497,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335802498,"env":"test","module":"email-queue","jobId":"edcc72c8-8bd1-466a-9762-f4ad0ca8e1c9","to":"middleware-test-221HObFCu_du1XRzI-czf@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335802512,"env":"test","module":"audit-log-service","userId":"1fcf2a843871d97d855f1b89597956a6","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mrevokeInvite[2m > [22m[2mshould prevent accepting revoked invite
[22m[39mFailed to write audit log: error: insert or update on table "audit_logs" violates foreign key constraint "audit_logs_workspace_id_workspaces_id_fk"
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.revokeInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:840:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:349:13
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m341[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'23503'[39m,
  detail: [32m'Key (workspace_id)=(00000000-0000-0000-0000-000000000098) is not present in table "workspaces".'[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [32m'public'[39m,
  table: [32m'audit_logs'[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [32m'audit_logs_workspace_id_workspaces_id_fk'[39m,
  file: [32m'ri_triggers.c'[39m,
  line: [32m'2599'[39m,
  routine: [32m'ri_ReportViolation'[39m
}

{"level":30,"time":1768335802543,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335802546,"env":"test","module":"auth-routes","userId":"ce1bb8cd-e6ca-4f47-b0aa-d73ca84552c1","email":"middleware-test-221HObFCu_du1XRzI-czf@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mCookie Strategy Security[2m > [22m[2mshould only allow safe methods for cookie auth
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335802607,"env":"test","module":"user-credentials-repository","userId":"e711fe3c-914e-4cdd-be03-d7eaab9acd1f","msg":"User credentials created"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould try TOTP before backup code
[22m[39mError deleting test user d950f9f04d49da11a307eafa57f7a113: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/mfa.flow.real.test.ts:46:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335802706,"env":"test","module":"email-queue","jobId":"ae00028e-f761-428f-9d75-d717f21d0f2f","to":"session-test-nkB8ZiSeGOC8JYc_WNLJi@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335802757,"env":"test","module":"auth-routes","userId":"e711fe3c-914e-4cdd-be03-d7eaab9acd1f","email":"session-test-nkB8ZiSeGOC8JYc_WNLJi@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335802828,"env":"test","module":"auth-routes","userId":"f6d88072-bdc0-496e-9e37-d01f1c7711be","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w24
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould reject invalid MFA code
[22m[39mError deleting test user ad77127e82279b943e4caa1b068143f2: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth.routes.real.test.ts:54:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335802839,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335802840,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all trusted devices
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335802829,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w24 (Reused: true)

{"level":30,"time":1768335802882,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335802880,"env":"test","module":"audit-log-service","userId":"f6d88072-bdc0-496e-9e37-d01f1c7711be","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768335802886,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335802932,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

 [32mâœ“[39m tests/integration/auth.routes.real.test.ts [2m([22m[2m26 tests[22m[2m)[22m[33m 34883[2mms[22m[39m
       [33m[2mâœ“[22m[39m should register a new user successfully [33m 1208[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 409 for duplicate email [33m 1499[2mms[22m[39m
       [33m[2mâœ“[22m[39m should set httpOnly refresh token cookie [33m 858[2mms[22m[39m
       [33m[2mâœ“[22m[39m should login with valid credentials [33m 1502[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 401 for invalid password [33m 1705[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 401 for non-existent user [33m 443[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 403 for unverified email [33m 930[2mms[22m[39m
       [33m[2mâœ“[22m[39m should record failed login attempt [33m 1529[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return requiresMfa=true for MFA-enabled users [33m 2153[2mms[22m[39m
       [33m[2mâœ“[22m[39m should lock account after 5 failed attempts [33m 4059[2mms[22m[39m
       [33m[2mâœ“[22m[39m should logout and clear refresh token cookie [33m 1842[2mms[22m[39m
       [33m[2mâœ“[22m[39m should refresh access token with valid refresh token [33m 2021[2mms[22m[39m
       [33m[2mâœ“[22m[39m should rotate refresh token after use [33m 2128[2mms[22m[39m
       [33m[2mâœ“[22m[39m should send password reset email for existing user [33m 1465[2mms[22m[39m
       [33m[2mâœ“[22m[39m should not reveal if email exists (security) [33m 349[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reset password with valid token [33m 2664[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 400 for invalid token [33m 379[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 400 for weak new password [33m 1203[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return current user for valid token [33m 1840[2mms[22m[39m
         [33m[2mâœ“[22m[39m should complete MFA login with valid TOTP code [33m 2260[2mms[22m[39m
         [33m[2mâœ“[22m[39m should reject invalid MFA code [33m 1752[2mms[22m[39m
{"level":30,"time":1768335803066,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts[2m > [22m[2mDataVault v4 Regression Tests
[22m[39mðŸ“š API Documentation available at /api-docs
[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768335803091,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768335803076,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768335803077,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768335803084,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768335803091,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768335803091,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768335803091,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768335803091,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768335803117,"env":"test","module":"auth-routes","userId":"ce1bb8cd-e6ca-4f47-b0aa-d73ca84552c1","msg":"User logged in successfully"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould return 400 if no active session found
[22m[39mError deleting test user 1fcf2a843871d97d855f1b89597956a6: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/session.management.real.test.ts:44:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335803170,"env":"test","module":"audit-log-service","userId":"ce1bb8cd-e6ca-4f47-b0aa-d73ca84552c1","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335803232,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335803232,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/organizationInvites.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 37640[2mms[22m[39m
       [33m[2mâœ“[22m[39m should create placeholder user for non-existent email [33m 2034[2mms[22m[39m
       [33m[2mâœ“[22m[39m should create invite for existing user without creating placeholder [33m 1867[2mms[22m[39m
       [33m[2mâœ“[22m[39m should prevent duplicate pending invites [33m 2159[2mms[22m[39m
       [33m[2mâœ“[22m[39m should prevent inviting existing members [33m 1321[2mms[22m[39m
       [33m[2mâœ“[22m[39m should require admin access to create invite [33m 1025[2mms[22m[39m
       [33m[2mâœ“[22m[39m should set expiry to 7 days from now [33m 1963[2mms[22m[39m
       [33m[2mâœ“[22m[39m should accept invite and create membership [33m 2835[2mms[22m[39m
       [33m[2mâœ“[22m[39m should convert placeholder user to real user on accept [33m 2848[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject expired invite [33m 2112[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject already accepted invite [33m 2748[2mms[22m[39m
       [33m[2mâœ“[22m[39m should verify email matches invite [33m 1975[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject invalid token [33m 1104[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return pending invites for user email [33m 2097[2mms[22m[39m
       [33m[2mâœ“[22m[39m should not return expired invites [33m 2370[2mms[22m[39m
       [33m[2mâœ“[22m[39m should not return accepted invites [33m 2772[2mms[22m[39m
       [33m[2mâœ“[22m[39m should allow admin to revoke invite [33m 2642[2mms[22m[39m
       [33m[2mâœ“[22m[39m should prevent accepting revoked invite [33m 2620[2mms[22m[39m
{"level":30,"time":1768335803308,"env":"test","module":"auth-routes","userId":"6ef30937a14e99c5b054cecf2801969b","msg":"Login requires MFA verification"}
{"level":50,"time":1768335803326,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335803349,"env":"test","module":"user-credentials-repository","userId":"df3aaf4f-851c-4a9b-b4e9-2e0fdecb36c6","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w22
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":30,"time":1768335803382,"env":"test","module":"auth-routes","userId":"e711fe3c-914e-4cdd-be03-d7eaab9acd1f","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w22 (Reused: true)

{"level":30,"time":1768335803402,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Status[2m > [22m[2mshould return MFA status for user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335803422,"env":"test","module":"mfa-service","userId":"6ef30937a14e99c5b054cecf2801969b","msg":"TOTP verification successful"}
{"level":30,"time":1768335803436,"env":"test","module":"audit-log-service","userId":"e711fe3c-914e-4cdd-be03-d7eaab9acd1f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335803452,"env":"test","module":"email-queue","jobId":"ca0a2b99-5609-4681-83ad-6b7e106eda70","to":"protected-test-jLnkki1_qJrgy79EJmWQH@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335803456,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335803471,"env":"test","module":"auth-routes","userId":"6ef30937a14e99c5b054cecf2801969b","msg":"MFA login successful"}
{"level":30,"time":1768335803503,"env":"test","module":"auth-routes","userId":"df3aaf4f-851c-4a9b-b4e9-2e0fdecb36c6","email":"protected-test-jLnkki1_qJrgy79EJmWQH@example.com","msg":"User registered"}
{"level":30,"time":1768335803530,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts[2m > [22m[2mDataVault v4 Regression Tests
[22m[39mLogin Status: [33m200[39m
Login Body: {
  "message": "Authentication successful",
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiJnb29nbGUtdXNlci1pZCIsImVtYWlsIjoidGVzdHVzZXJAZXhhbXBsZS5jb20iLCJ0ZW5hbnRJZCI6IjE5MGI5ZTg1LTJkYzktNDM5MC1iM2M1LTI4ZmE0ZDQ3ZmZlMCIsInJvbGUiOiJhZG1pbiIsInRlbmFudFJvbGUiOiJvd25lciIsImlhdCI6MTc2ODMzNTgwMywiZXhwIjoxNzY4MzM2NzAzfQ.q9kWqH9UcfpAsoJozASkzcEKbrmMVCtWmbc31pHx2VY",
  "user": {
    "id": "google-user-id",
    "email": "testuser@example.com",
    "firstName": null,
    "lastName": null,
    "profileImageUrl": null,
    "tenantId": "190b9e85-2dc9-4390-b3c5-28fa4d47ffe0",
    "role": "admin",
    "tenantRole": "owner"
  }
}

[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:56:17 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335803617,"env":"test","module":"auth-routes","userId":"e711fe3c-914e-4cdd-be03-d7eaab9acd1f","deviceFingerprint":"377ad01217b8c93ca52518d515505c47ab7553fab66d6fddaa60af67802c5a4c","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould reject token with SQL injection attempt
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335803631,"env":"test","module":"auth-routes","userId":"6ef30937a14e99c5b054cecf2801969b","deviceFingerprint":"10fa3aea039bf6fec7b6bcb982cbed1cc6ab844dd3c0879bec32baefb2997b52","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335803760,"env":"test","module":"auth","email":"other@example.com","msg":"OAuth2 login successful"}
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w25
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":30,"time":1768335803765,"env":"test","module":"user-credentials-repository","userId":"ad04475a-0718-43b7-a850-4da21358620b","msg":"User credentials created"}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768335803790,"env":"test","module":"auth-routes","userId":"e711fe3c-914e-4cdd-be03-d7eaab9acd1f","msg":"All other sessions revoked"}
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w25 (Reused: true)

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335803845,"env":"test","module":"audit-log-service","userId":"e711fe3c-914e-4cdd-be03-d7eaab9acd1f","eventType":"all_sessions_revoked","ipAddress":"::1","hasMetadata":false,"msg":"Security event logged"}
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335803874,"env":"test","module":"email-queue","jobId":"c62e6fd2-bf52-47f8-9d9c-465020a4d5a8","to":"middleware-test-Lc51uD7BNjWAYecI7cE2h@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all trusted devices
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335803928,"env":"test","module":"auth-routes","userId":"ad04475a-0718-43b7-a850-4da21358620b","email":"middleware-test-Lc51uD7BNjWAYecI7cE2h@example.com","msg":"User registered"}
{"level":30,"time":1768335803928,"env":"test","module":"auth-routes","userId":"fbc238e6bbe34afd25cec5fc9c31ec0d","msg":"User logged in successfully"}
{"level":30,"time":1768335803953,"env":"test","module":"auth-routes","userId":"e711fe3c-914e-4cdd-be03-d7eaab9acd1f","deviceCount":0,"msg":"Listed trusted devices"}
{"level":30,"time":1768335803978,"env":"test","module":"audit-log-service","userId":"fbc238e6bbe34afd25cec5fc9c31ec0d","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mCookie Strategy Security[2m > [22m[2mshould ignore cookies when Bearer token present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335804160,"env":"test","module":"auth-routes","userId":"6ef30937a14e99c5b054cecf2801969b","msg":"Login requires MFA verification"}
{"level":30,"time":1768335804167,"env":"test","module":"auth-routes","userId":"df3aaf4f-851c-4a9b-b4e9-2e0fdecb36c6","msg":"User logged in successfully"}
{"level":30,"time":1768335804216,"env":"test","module":"audit-log-service","userId":"df3aaf4f-851c-4a9b-b4e9-2e0fdecb36c6","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768335804221,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335804359,"env":"test","module":"user-credentials-repository","userId":"a4c38712-4c89-4170-93a4-3b9423335c8d","msg":"User credentials created"}
{"level":30,"time":1768335804396,"env":"test","module":"auth-routes","userId":"6fc5eb8d80f064fe37901d51983b6584","msg":"User logged in successfully"}
{"level":30,"time":1768335804413,"env":"test","module":"user-credentials-repository","userId":"2Tl2SdSHTOhUy1oXapoMo","msg":"User credentials created"}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335804447,"env":"test","module":"audit-log-service","userId":"6fc5eb8d80f064fe37901d51983b6584","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335804459,"env":"test","module":"email-queue","jobId":"4588568f-04c7-4dd9-9c5d-28704add216f","to":"session-test-ByCkFDwxT68YwW1qoGauw@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335804479,"env":"test","module":"auth-routes","userId":"ad04475a-0718-43b7-a850-4da21358620b","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w26
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":30,"time":1768335804508,"env":"test","module":"auth-routes","userId":"a4c38712-4c89-4170-93a4-3b9423335c8d","email":"session-test-ByCkFDwxT68YwW1qoGauw@example.com","msg":"User registered"}
{"level":30,"time":1768335804533,"env":"test","module":"audit-log-service","userId":"ad04475a-0718-43b7-a850-4da21358620b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w26 (Reused: true)

{"level":30,"time":1768335804542,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335804592,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335804601,"env":"test","module":"auth-routes","userId":"6fc5eb8d80f064fe37901d51983b6584","deviceFingerprint":"5704edd074e9c212893f0aacd3ccb4ea052539cb69bd3f923d88aab5ed5844f1","msg":"Device marked as trusted"}
{"level":50,"time":1768335804616,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335804638,"env":"test","module":"user-credentials-repository","userId":"4e3ce383-9f42-4ae1-9a73-272a610d59f3","msg":"User credentials created"}
{"level":30,"time":1768335804640,"env":"test","module":"auth-routes","userId":"2Tl2SdSHTOhUy1oXapoMo","sessionCount":2,"msg":"Listed active sessions"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Status[2m > [22m[2mshould return MFA status for user
[22m[39mError deleting test user fbc238e6bbe34afd25cec5fc9c31ec0d: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/mfa.flow.real.test.ts:46:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

[90mstderr[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39mError deleting test user 6ef30937a14e99c5b054cecf2801969b: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/trusted.devices.real.test.ts:45:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335804736,"env":"test","module":"email-queue","jobId":"cd62b10c-9a44-4879-8feb-8ccf0416d03c","to":"protected-test-lUco4Zsr_GZpbt3yqrP8-@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335804755,"env":"test","module":"auth-routes","userId":"6fc5eb8d80f064fe37901d51983b6584","msg":"All other sessions revoked"}
{"level":30,"time":1768335804786,"env":"test","module":"auth-routes","userId":"4e3ce383-9f42-4ae1-9a73-272a610d59f3","email":"protected-test-lUco4Zsr_GZpbt3yqrP8-@example.com","msg":"User registered"}
{"level":30,"time":1768335804810,"env":"test","module":"audit-log-service","userId":"6fc5eb8d80f064fe37901d51983b6584","eventType":"all_sessions_revoked","ipAddress":"::ffff:127.0.0.1","hasMetadata":false,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould reject token with XSS attempt
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335804964,"env":"test","module":"user-credentials-repository","userId":"3b2c0248-ba7b-4d50-9b27-43c5cb714e2b","msg":"User credentials created"}
{"level":30,"time":1768335805050,"env":"test","module":"user-credentials-repository","userId":"c0a4a2db-ef13-4d24-97ca-352522ffe9bc","msg":"User credentials created"}
{"level":30,"time":1768335805062,"env":"test","module":"email-queue","jobId":"1767ca7a-be7f-42ea-bf2a-2872ee486bd8","to":"cookie-test-96TXWwzYHxVe5bKWy4u_y@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335805062,"env":"test","module":"user-credentials-repository","userId":"2rillGbMYprtoc9sldib6","msg":"User credentials created"}
{"level":30,"time":1768335805112,"env":"test","module":"auth-routes","userId":"3b2c0248-ba7b-4d50-9b27-43c5cb714e2b","email":"cookie-test-96TXWwzYHxVe5bKWy4u_y@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335805159,"env":"test","module":"email-queue","jobId":"c0a280ca-3dba-45f4-ada6-86c0d54e2d3b","to":"session-test-oQrQmWWdE19eCgFpOWLlI@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335805166,"env":"test","module":"auth-routes","userId":"2rillGbMYprtoc9sldib6","sessionCount":1,"msg":"Listed active sessions"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mCookie Strategy Security[2m > [22m[2mshould ignore cookies when Bearer token present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335805213,"env":"test","module":"auth-routes","userId":"c0a4a2db-ef13-4d24-97ca-352522ffe9bc","email":"session-test-oQrQmWWdE19eCgFpOWLlI@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Expiration[2m > [22m[2mshould reject refresh token after 30 days
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w27
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all trusted devices
[22m[39mError deleting test user 6fc5eb8d80f064fe37901d51983b6584: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/session.management.real.test.ts:44:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w27 (Reused: true)

{"level":30,"time":1768335805427,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335805451,"env":"test","module":"email-queue","jobId":"c08c90dd-4b65-44c4-9b7a-680f480d15e5","to":"audit-user2@test.com","subject":"You've been invited to join Test Org Audit","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Status[2m > [22m[2mshould return backup codes count for MFA users
[22m[39m[TEST UTILS] MFA Secret verified for b3883353db229fdb122c689c36d3a42c

{"level":30,"time":1768335805473,"env":"test","module":"auth-routes","userId":"4e3ce383-9f42-4ae1-9a73-272a610d59f3","msg":"User logged in successfully"}
{"level":30,"time":1768335805476,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335805526,"env":"test","module":"audit-log-service","userId":"4e3ce383-9f42-4ae1-9a73-272a610d59f3","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768335805532,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335805536,"env":"test","module":"user-credentials-repository","userId":"PPMadYncQaSDzMmdRnq45","msg":"User credentials created"}
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #2: Invite acceptance race condition[2m > [22m[2mshould prevent double-acceptance via transaction
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:548:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:162:22
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39m[TEST UTILS] MFA Secret verified for 87daf67aa1a55a6e763ec6d2b32d02eb

{"level":30,"time":1768335805634,"env":"test","module":"auth-routes","userId":"PPMadYncQaSDzMmdRnq45","sessionCount":0,"msg":"Listed active sessions"}
{"level":30,"time":1768335805707,"env":"test","module":"auth-routes","userId":"3b2c0248-ba7b-4d50-9b27-43c5cb714e2b","msg":"User logged in successfully"}
{"level":30,"time":1768335805758,"env":"test","module":"audit-log-service","userId":"3b2c0248-ba7b-4d50-9b27-43c5cb714e2b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mComplete Organization Workflow[2m > [22m[2mStep 1: Create organization
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:90:19
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335805820,"env":"test","module":"auth-routes","userId":"c0a4a2db-ef13-4d24-97ca-352522ffe9bc","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Status[2m > [22m[2mshould return backup codes count for MFA users
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768335805841,"env":"test","error":{},"msg":"Error creating DataVault row"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335805874,"env":"test","module":"audit-log-service","userId":"c0a4a2db-ef13-4d24-97ca-352522ffe9bc","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335805946,"env":"test","module":"user-credentials-repository","userId":"093594b9-46d7-418e-a959-90531c9224b2","msg":"User credentials created"}
{"level":30,"time":1768335805978,"env":"test","module":"auth-service","tokenHash":"b5b8e482cfbde1d1cd06388b628aa00f56eb1225bbc8dd0aea37759de6f36b4e","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768335805982,"env":"test","module":"user-credentials-repository","userId":"UbKxY54Zekk2VSIYJIcpz","msg":"User credentials created"}
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #2: Invite acceptance race condition[2m > [22m[2mshould prevent double-acceptance via transaction
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.acceptInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:797:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:169:7
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":40,"time":1768335806030,"env":"test","module":"auth-service","userId":"c0a4a2db-ef13-4d24-97ca-352522ffe9bc","msg":"Security: Expired refresh token used"}
{"level":30,"time":1768335806044,"env":"test","module":"email-queue","jobId":"c1507f3a-796a-418e-86a0-7c551ea8800e","to":"protected-test-BfrQfh6yB8FsrCVwd5hsy@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335806087,"env":"test","module":"auth-routes","userId":"UbKxY54Zekk2VSIYJIcpz","sessionCount":0,"msg":"Listed active sessions"}
{"level":30,"time":1768335806093,"env":"test","module":"auth-routes","userId":"093594b9-46d7-418e-a959-90531c9224b2","email":"protected-test-BfrQfh6yB8FsrCVwd5hsy@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould handle user with single session gracefully
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Payload Validation[2m > [22m[2mshould reject token with missing userId
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335806278,"env":"test","module":"user-credentials-repository","userId":"73de7539-1cf5-400d-a6ed-e0f8422ed449","msg":"User credentials created"}
{"level":30,"time":1768335806313,"env":"test","module":"email-queue","jobId":"9d8b97e8-8d39-4fae-a2a5-65625b9ce994","to":"org-member@test.com","subject":"You've been invited to join Test Organization","msg":"Email added to queue"}
{"level":30,"time":1768335806324,"env":"test","module":"auth-routes","userId":"b3883353db229fdb122c689c36d3a42c","msg":"Login requires MFA verification"}
{"level":30,"time":1768335806364,"env":"test","module":"auth-routes","userId":"87daf67aa1a55a6e763ec6d2b32d02eb","msg":"Login requires MFA verification"}
{"level":30,"time":1768335806379,"env":"test","module":"email-queue","jobId":"da07fbb2-c5ef-4e4f-ab3c-7e0551b82844","to":"middleware-test-62L0MXGnCkWGaPO0pNgbO@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mComplete Organization Workflow[2m > [22m[2mStep 2: Invite member via email
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:548:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:115:22
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335806430,"env":"test","module":"auth-routes","userId":"73de7539-1cf5-400d-a6ed-e0f8422ed449","email":"middleware-test-62L0MXGnCkWGaPO0pNgbO@example.com","msg":"User registered"}
{"level":30,"time":1768335806440,"env":"test","module":"user-credentials-repository","userId":"472696b1-e159-4cc9-922f-77004908bb92","msg":"User credentials created"}
{"level":30,"time":1768335806445,"env":"test","module":"user-credentials-repository","userId":"MoCteLwoiR_X_75tKWErO","msg":"User credentials created"}
{"level":30,"time":1768335806468,"env":"test","module":"mfa-service","userId":"87daf67aa1a55a6e763ec6d2b32d02eb","msg":"TOTP verification successful"}
{"level":30,"time":1768335806479,"env":"test","module":"mfa-service","userId":"b3883353db229fdb122c689c36d3a42c","msg":"TOTP verification successful"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mUser Context Attachment[2m > [22m[2mshould attach userId to request
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335806517,"env":"test","module":"auth-routes","userId":"87daf67aa1a55a6e763ec6d2b32d02eb","msg":"MFA login successful"}
{"level":30,"time":1768335806536,"env":"test","module":"auth-routes","userId":"b3883353db229fdb122c689c36d3a42c","msg":"MFA login successful"}
{"level":30,"time":1768335806544,"env":"test","module":"email-queue","jobId":"a422652d-4b36-489b-8347-94c5a0b8e369","to":"session-test-aECGBDacj3LwurdQ9pPfU@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335806597,"env":"test","module":"auth-routes","userId":"7d81a424e30c559f12d5b1fc1b64b48a","msg":"User logged in successfully"}
{"level":30,"time":1768335806597,"env":"test","module":"auth-routes","userId":"472696b1-e159-4cc9-922f-77004908bb92","email":"session-test-aECGBDacj3LwurdQ9pPfU@example.com","msg":"User registered"}
{"level":30,"time":1768335806599,"env":"test","module":"auth-routes","userId":"MoCteLwoiR_X_75tKWErO","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768335806614,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768335806649,"env":"test","module":"audit-log-service","userId":"7d81a424e30c559f12d5b1fc1b64b48a","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335806670,"env":"test","module":"auth-routes","userId":"87daf67aa1a55a6e763ec6d2b32d02eb","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mConcurrent Session Handling[2m > [22m[2mshould handle multiple concurrent logins
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mConcurrent Session Handling[2m > [22m[2mshould handle multiple concurrent logins
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mConcurrent Session Handling[2m > [22m[2mshould handle multiple concurrent logins
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335806749,"env":"test","module":"auth-routes","userId":"093594b9-46d7-418e-a959-90531c9224b2","msg":"User logged in successfully"}
{"level":30,"time":1768335806804,"env":"test","module":"auth-routes","userId":"7d81a424e30c559f12d5b1fc1b64b48a","msg":"All other sessions revoked"}
{"level":30,"time":1768335806803,"env":"test","module":"audit-log-service","userId":"093594b9-46d7-418e-a959-90531c9224b2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335806859,"env":"test","module":"audit-log-service","userId":"7d81a424e30c559f12d5b1fc1b64b48a","eventType":"all_sessions_revoked","ipAddress":"::ffff:127.0.0.1","hasMetadata":false,"msg":"Security event logged"}
{"level":30,"time":1768335806865,"env":"test","module":"email-queue","jobId":"4ef76c20-7b3f-42a5-833d-c3d4a5df2fbb","to":"email-test@example.com","subject":"You've been invited to join Test Org Audit","msg":"Email added to queue"}
{"level":30,"time":1768335806939,"env":"test","module":"user-credentials-repository","userId":"jRMvJhLN-xz4Btf5lHAud","msg":"User credentials created"}
{"level":30,"time":1768335806957,"env":"test","module":"auth-routes","userId":"7d81a424e30c559f12d5b1fc1b64b48a","sessionCount":1,"msg":"Listed active sessions"}
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #3: Invite email failure rollback[2m > [22m[2mshould not create invite if email fails
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:548:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:190:22
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335806972,"env":"test","module":"auth-routes","userId":"73de7539-1cf5-400d-a6ed-e0f8422ed449","msg":"User logged in successfully"}
{"level":30,"time":1768335807025,"env":"test","module":"audit-log-service","userId":"73de7539-1cf5-400d-a6ed-e0f8422ed449","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335807041,"env":"test","module":"auth-routes","userId":"jRMvJhLN-xz4Btf5lHAud","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768335807188,"env":"test","module":"auth-routes","userId":"472696b1-e159-4cc9-922f-77004908bb92","msg":"User logged in successfully"}
{"level":30,"time":1768335807201,"env":"test","module":"user-credentials-repository","userId":"c285985f-3e3d-448a-8b38-33392ac9fb72","msg":"User credentials created"}
[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mComplete Organization Workflow[2m > [22m[2mStep 3: Accept invite
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.acceptInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:797:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:139:22
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335807241,"env":"test","module":"audit-log-service","userId":"472696b1-e159-4cc9-922f-77004908bb92","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Status[2m > [22m[2mshould return backup codes count for MFA users
[22m[39mError deleting test user b3883353db229fdb122c689c36d3a42c: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/mfa.flow.real.test.ts:46:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335807301,"env":"test","module":"email-queue","jobId":"c0395f3d-95b8-4b0a-a64a-320dd614ea73","to":"protected-test-QcK2l1HiUNE10iQZ60eBe@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335807348,"env":"test","module":"auth-routes","userId":"c285985f-3e3d-448a-8b38-33392ac9fb72","email":"protected-test-QcK2l1HiUNE10iQZ60eBe@example.com","msg":"User registered"}
{"level":30,"time":1768335807356,"env":"test","module":"auth-routes","userId":"87daf67aa1a55a6e763ec6d2b32d02eb","msg":"Login from trusted device - MFA skipped"}
{"level":30,"time":1768335807379,"env":"test","module":"user-credentials-repository","userId":"hS1ajkGFxHOI8jpkClKb6","msg":"User credentials created"}
{"level":50,"time":1768335807382,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335807405,"env":"test","module":"auth-routes","userId":"87daf67aa1a55a6e763ec6d2b32d02eb","msg":"User logged in successfully"}
{"level":30,"time":1768335807456,"env":"test","module":"audit-log-service","userId":"87daf67aa1a55a6e763ec6d2b32d02eb","eventType":"login_success","ipAddress":"192.168.1.100","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Payload Validation[2m > [22m[2mshould reject token with non-existent userId
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335807505,"env":"test","module":"auth-routes","userId":"472696b1-e159-4cc9-922f-77004908bb92","msg":"User logged in successfully"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould handle user with single session gracefully
[22m[39mError deleting test user 7d81a424e30c559f12d5b1fc1b64b48a: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/session.management.real.test.ts:44:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335807519,"env":"test","module":"auth-routes","userId":"472696b1-e159-4cc9-922f-77004908bb92","msg":"User logged in successfully"}
{"level":30,"time":1768335807527,"env":"test","module":"user-credentials-repository","userId":"916ac571-d94b-4590-abfc-7aada7c43939","msg":"User credentials created"}
{"level":30,"time":1768335807555,"env":"test","module":"audit-log-service","userId":"472696b1-e159-4cc9-922f-77004908bb92","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335807572,"env":"test","module":"audit-log-service","userId":"472696b1-e159-4cc9-922f-77004908bb92","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335807628,"env":"test","module":"email-queue","jobId":"dc50d07d-a145-43a2-a288-d913b25492f3","to":"middleware-test-ggirSGQdovEUHuLGyQZFv@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335807681,"env":"test","module":"auth-routes","userId":"916ac571-d94b-4590-abfc-7aada7c43939","email":"middleware-test-ggirSGQdovEUHuLGyQZFv@example.com","msg":"User registered"}
{"level":30,"time":1768335807722,"env":"test","module":"user-credentials-repository","userId":"MGe8_pStXb-yzV374boY5","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mUser Context Attachment[2m > [22m[2mshould attach userEmail to request
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335807824,"env":"test","module":"email-queue","jobId":"8dcbc718-66b9-48ad-8757-f433fab8dd41","to":"expired-test@example.com","subject":"You've been invited to join Test Org Audit","msg":"Email added to queue"}
{"level":30,"time":1768335807919,"env":"test","module":"auth-routes","userId":"MGe8_pStXb-yzV374boY5","sessionId":"8dcc0a58-f262-4bd2-bfe2-cb134b1ed269","msg":"Session revoked"}
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #5: Expired invites[2m > [22m[2mshould allow re-invite after invite expires
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:548:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:213:23
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335807998,"env":"test","module":"auth-routes","userId":"c285985f-3e3d-448a-8b38-33392ac9fb72","msg":"User logged in successfully"}
{"level":30,"time":1768335808019,"env":"test","module":"user-credentials-repository","userId":"335434d0-52b6-4301-8447-6251261fb2a5","msg":"User credentials created"}
{"level":30,"time":1768335808050,"env":"test","module":"audit-log-service","userId":"c285985f-3e3d-448a-8b38-33392ac9fb72","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstderr[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39mError deleting test user 87daf67aa1a55a6e763ec6d2b32d02eb: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/trusted.devices.real.test.ts:45:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335808055,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335808056,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Disable Flow[2m > [22m[2mshould disable MFA with password verification
[22m[39m[TEST UTILS] MFA Secret verified for 15258fcb11a85ef9cb5e9a2a39966d23

{"level":30,"time":1768335808121,"env":"test","module":"email-queue","jobId":"ec7c1fc5-fcdb-479d-ae27-98bc79dedb79","to":"session-test-1jR2M9X0P0I4NfV_vcSLp@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335808172,"env":"test","module":"auth-routes","userId":"335434d0-52b6-4301-8447-6251261fb2a5","email":"session-test-1jR2M9X0P0I4NfV_vcSLp@example.com","msg":"User registered"}
 [32mâœ“[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 40080[2mms[22m[39m
       [33m[2mâœ“[22m[39m should trust current device [33m 2252[2mms[22m[39m
       [33m[2mâœ“[22m[39m should set trust expiry to 30 days [33m 2496[2mms[22m[39m
       [33m[2mâœ“[22m[39m should update expiry if device already trusted [33m 2759[2mms[22m[39m
       [33m[2mâœ“[22m[39m should list all trusted devices [33m 4103[2mms[22m[39m
       [33m[2mâœ“[22m[39m should mark current device [33m 2604[2mms[22m[39m
       [33m[2mâœ“[22m[39m should exclude revoked devices [33m 2692[2mms[22m[39m
       [33m[2mâœ“[22m[39m should exclude expired devices [33m 2548[2mms[22m[39m
       [33m[2mâœ“[22m[39m should revoke specific device [33m 2873[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 404 for non-existent device [33m 2292[2mms[22m[39m
       [33m[2mâœ“[22m[39m should prevent revoking other user's device [33m 4897[2mms[22m[39m
       [33m[2mâœ“[22m[39m should skip MFA for trusted device [33m 3100[2mms[22m[39m
       [33m[2mâœ“[22m[39m should require MFA for untrusted device [33m 3074[2mms[22m[39m
       [33m[2mâœ“[22m[39m should update lastUsedAt on trusted device login [33m 3344[2mms[22m[39m
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould include device metadata in sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335808232,"env":"test","module":"auth-routes","userId":"916ac571-d94b-4590-abfc-7aada7c43939","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mConcurrent Session Handling[2m > [22m[2mshould handle concurrent token refreshes
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335808285,"env":"test","module":"audit-log-service","userId":"916ac571-d94b-4590-abfc-7aada7c43939","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335808329,"env":"test","module":"user-credentials-repository","userId":"JXq2vhbEKzhPcQTwopk68","msg":"User credentials created"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Disable Flow[2m > [22m[2mshould disable MFA with password verification
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts[2m > [22m[2mDataVault v4 Regression Tests[2m > [22m[2mRow Notes[2m > [22m[2mshould create a note for a row
[22m[39mCreated note: 595f7ad9-d902-433a-92fc-421208455d8e tenantId: 190b9e85-2dc9-4390-b3c5-28fa4d47ffe0 userId: google-user-id

{"level":30,"time":1768335808559,"env":"test","module":"user-credentials-repository","userId":"41df7e22-502d-4122-8a2e-6ab737f28d7e","msg":"User credentials created"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768335808658,"env":"test","module":"email-queue","jobId":"d5753896-7bad-404b-a4db-41ca1775854d","to":"protected-test-nFXVQGVBqC5eevO5NQ33X@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335808665,"env":"test","module":"user-credentials-repository","userId":"uMhE0rVMjORrlyZwhzrJU","msg":"User credentials created"}
{"level":30,"time":1768335808694,"env":"test","module":"auth-routes","userId":"5cf19e6c6934949b59aab6736ae68641","msg":"User logged in successfully"}
{"level":30,"time":1768335808707,"env":"test","module":"auth-routes","userId":"41df7e22-502d-4122-8a2e-6ab737f28d7e","email":"protected-test-nFXVQGVBqC5eevO5NQ33X@example.com","msg":"User registered"}
{"level":30,"time":1768335808745,"env":"test","module":"auth-routes","userId":"335434d0-52b6-4301-8447-6251261fb2a5","msg":"User logged in successfully"}
{"level":30,"time":1768335808753,"env":"test","module":"audit-log-service","userId":"5cf19e6c6934949b59aab6736ae68641","eventType":"login_success","ipAddress":"192.168.1.100","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335808780,"env":"test","module":"email-queue","jobId":"b9ff56b1-33fd-46bd-b894-d2af56c3b24f","to":"expired-test@example.com","subject":"You've been invited to join Test Org Audit","msg":"Email added to queue"}
{"level":30,"time":1768335808780,"env":"test","module":"user-credentials-repository","userId":"c2d5e2ba-5145-42b3-92a4-c7b2373464b4","msg":"User credentials created"}
{"level":30,"time":1768335808792,"env":"test","module":"audit-log-service","userId":"335434d0-52b6-4301-8447-6251261fb2a5","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335808797,"env":"test","module":"auth-service","tokenHash":"09b96e9426a10477f5ac39a7d8091471025f1cfd05f07f3f64780249a79bf22b","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mCross-User Authorization[2m > [22m[2mshould not allow user to access another user's resources
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335808848,"env":"test","module":"auth-routes","userId":"15258fcb11a85ef9cb5e9a2a39966d23","msg":"Login requires MFA verification"}
{"level":30,"time":1768335808860,"env":"test","module":"auth-routes","userId":"5cf19e6c6934949b59aab6736ae68641","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768335808882,"env":"test","module":"email-queue","jobId":"41e7f204-09b1-4818-928d-21bcbf70d631","to":"middleware-test-rbCrh3-zZ7ZM55g_RbxVZ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #5: Expired invites[2m > [22m[2mshould allow re-invite after invite expires
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:548:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:222:23
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335808938,"env":"test","module":"auth-routes","userId":"c2d5e2ba-5145-42b3-92a4-c7b2373464b4","email":"middleware-test-rbCrh3-zZ7ZM55g_RbxVZ@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts[2m > [22m[2mDataVault v4 Regression Tests[2m > [22m[2mRow Notes[2m > [22m[2mshould get all notes for a row
[22m[39mCreated note: 48a80619-9f84-4a22-88fa-3d4b49db8506 tenantId: 190b9e85-2dc9-4390-b3c5-28fa4d47ffe0 userId: google-user-id

{"level":30,"time":1768335808958,"env":"test","module":"mfa-service","userId":"15258fcb11a85ef9cb5e9a2a39966d23","msg":"TOTP verification successful"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould return consistent error format for missing token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335809007,"env":"test","module":"auth-service","tokenHash":"09b96e9426a10477f5ac39a7d8091471025f1cfd05f07f3f64780249a79bf22b","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768335809009,"env":"test","module":"auth-routes","userId":"15258fcb11a85ef9cb5e9a2a39966d23","msg":"MFA login successful"}
{"level":40,"time":1768335809057,"env":"test","module":"auth-service","userId":"335434d0-52b6-4301-8447-6251261fb2a5","tokenHash":"09b96e9426a10477f5ac39a7d8091471025f1cfd05f07f3f64780249a79bf22b","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768335809065,"env":"test","workflowId":"6189d8ee-7643-484b-9cae-f232366513ef","userId":"da9e9f12-84fb-4a9c-8f3e-b00cb606d605","sectionsCount":1,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts[2m > [22m[2mDataVault v4 Regression Tests[2m > [22m[2mRow Notes[2m > [22m[2mshould get all notes for a row
[22m[39mCreated note: a5a43a1e-9861-41ad-89fd-4a4e0aa8abbc tenantId: 190b9e85-2dc9-4390-b3c5-28fa4d47ffe0 userId: google-user-id

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335809113,"env":"test","module":"auth-service","tokenHash":"8519aa537773525c4cf64c9f3c43c8e1d5c034dec4325893ac7086aa5de15ed7","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768335809148,"env":"test","module":"user-credentials-repository","userId":"gOh5WRZs_zqiev3AgUGXV","msg":"User credentials created"}
{"level":40,"time":1768335809160,"env":"test","module":"auth-service","userId":"335434d0-52b6-4301-8447-6251261fb2a5","tokenHash":"8519aa537773525c4cf64c9f3c43c8e1d5c034dec4325893ac7086aa5de15ed7","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768335809345,"env":"test","module":"auth-routes","userId":"41df7e22-502d-4122-8a2e-6ab737f28d7e","msg":"User logged in successfully"}
{"level":30,"time":1768335809396,"env":"test","module":"audit-log-service","userId":"41df7e22-502d-4122-8a2e-6ab737f28d7e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould include device metadata in sessions
[22m[39mError deleting test user 5cf19e6c6934949b59aab6736ae68641: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/session.management.real.test.ts:44:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335809466,"env":"test","workflowId":"6189d8ee-7643-484b-9cae-f232366513ef","userId":"ca1b8eaa-ea45-40f5-94ce-5943a759d67e","sectionsCount":1,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":30,"time":1768335809471,"env":"test","module":"auth-routes","userId":"c2d5e2ba-5145-42b3-92a4-c7b2373464b4","msg":"User logged in successfully"}
{"level":30,"time":1768335809472,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335809473,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335809538,"env":"test","module":"mfa-service","userId":"15258fcb11a85ef9cb5e9a2a39966d23","msg":"MFA disabled"}
{"level":30,"time":1768335809538,"env":"test","module":"audit-log-service","userId":"c2d5e2ba-5145-42b3-92a4-c7b2373464b4","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335809538,"env":"test","module":"auth-routes","userId":"15258fcb11a85ef9cb5e9a2a39966d23","msg":"MFA disabled by user"}
{"level":50,"time":1768335809542,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

{"level":30,"time":1768335809586,"env":"test","module":"audit-log-service","userId":"15258fcb11a85ef9cb5e9a2a39966d23","eventType":"mfa_disabled","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts[2m > [22m[2mDataVault v4 Regression Tests[2m > [22m[2mRow Notes[2m > [22m[2mshould delete a note
[22m[39mCreated note: 1c117523-ce7d-4336-830e-4024609f0d19 tenantId: 190b9e85-2dc9-4390-b3c5-28fa4d47ffe0 userId: google-user-id

{"level":30,"time":1768335809688,"env":"test","module":"user-credentials-repository","userId":"6m-3LmPW_xGqxYVxx1MYC","msg":"User credentials created"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Disable Flow[2m > [22m[2mshould disable MFA with password verification
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768335809692,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
 [32mâœ“[39m tests/integration/auth/session.management.integration.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 34282[2mms[22m[39m
       [33m[2mâœ“[22m[39m should create refresh token on login [33m 1347[2mms[22m[39m
       [33m[2mâœ“[22m[39m should track device metadata in session [33m 1366[2mms[22m[39m
       [33m[2mâœ“[22m[39m should create separate sessions for multiple device logins [33m 2475[2mms[22m[39m
       [33m[2mâœ“[22m[39m should list all active sessions for user [33m 2444[2mms[22m[39m
       [33m[2mâœ“[22m[39m should mark current session correctly [33m 1859[2mms[22m[39m
       [33m[2mâœ“[22m[39m should not include revoked sessions [33m 2140[2mms[22m[39m
       [33m[2mâœ“[22m[39m should order sessions by last used (most recent first) [33m 2582[2mms[22m[39m
       [33m[2mâœ“[22m[39m should require authentication [33m 661[2mms[22m[39m
       [33m[2mâœ“[22m[39m should revoke specific session [33m 2096[2mms[22m[39m
       [33m[2mâœ“[22m[39m should prevent revoking current session [33m 1381[2mms[22m[39m
       [33m[2mâœ“[22m[39m should not allow revoking other users sessions [33m 2530[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 404 for non-existent session ID [33m 1262[2mms[22m[39m
       [33m[2mâœ“[22m[39m should revoke all sessions except current [33m 2973[2mms[22m[39m
       [33m[2mâœ“[22m[39m should revoke all trusted devices [33m 1776[2mms[22m[39m
       [33m[2mâœ“[22m[39m should require active session [33m 662[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject refresh token after 30 days [33m 1414[2mms[22m[39m
       [33m[2mâœ“[22m[39m should handle multiple concurrent logins [33m 1589[2mms[22m[39m
       [33m[2mâœ“[22m[39m should handle concurrent token refreshes [33m 1591[2mms[22m[39m
{"level":30,"time":1768335809799,"env":"test","module":"user-credentials-repository","userId":"ef293b12-0ae5-4312-8b50-d39fe9a5d7a3","msg":"User credentials created"}
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #7: Delete organization[2m > [22m[2mshould allow last admin to delete empty organization
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:242:19
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335809903,"env":"test","module":"email-queue","jobId":"b5e2bd7a-e8b2-40ed-85d9-863d45b958ad","to":"user2-dNRxr6wIwohpfY944vldd@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335809936,"env":"test","module":"user-credentials-repository","userId":"9f35e8e9-9fda-4722-80ad-cc21112f6c44","msg":"User credentials created"}
{"level":30,"time":1768335809954,"env":"test","module":"auth-routes","userId":"ef293b12-0ae5-4312-8b50-d39fe9a5d7a3","email":"user2-dNRxr6wIwohpfY944vldd@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mCross-User Authorization[2m > [22m[2mshould not allow user to access another user's resources
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335810026,"env":"test","module":"user-credentials-repository","userId":"vSKWZX1hWAvC93YVvofJk","msg":"User credentials created"}
{"level":30,"time":1768335810034,"env":"test","module":"email-queue","jobId":"9370c3ad-89b0-4012-8fc9-4e3be38935b9","to":"middleware-test-nap-6KzMIzsMmc5KvRlf2@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w28
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":30,"time":1768335810085,"env":"test","module":"auth-routes","userId":"9f35e8e9-9fda-4722-80ad-cc21112f6c44","email":"middleware-test-nap-6KzMIzsMmc5KvRlf2@example.com","msg":"User registered"}
[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould not expose sensitive token data
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w28 (Reused: true)

{"level":30,"time":1768335810124,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould return consistent error format for invalid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335810162,"env":"test","module":"auth-routes","userId":"15258fcb11a85ef9cb5e9a2a39966d23","msg":"User logged in successfully"}
{"level":30,"time":1768335810202,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335810212,"env":"test","module":"audit-log-service","userId":"15258fcb11a85ef9cb5e9a2a39966d23","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768335810260,"env":"test","error":{"error":{"code":"INTERNAL_ERROR","message":""}},"msg":"Failed to render template"}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts[2m > [22m[2mDataVault v4 Regression Tests[2m > [22m[2mRow Notes[2m > [22m[2mshould not allow deleting notes by other users
[22m[39mCreated note: f82683ff-10a2-4dd5-a461-665cec318eed tenantId: 190b9e85-2dc9-4390-b3c5-28fa4d47ffe0 userId: google-user-id

{"level":30,"time":1768335810492,"env":"test","module":"auth-routes","userId":"vSKWZX1hWAvC93YVvofJk","msg":"All other sessions revoked"}
{"level":30,"time":1768335810539,"env":"test","module":"audit-log-service","userId":"vSKWZX1hWAvC93YVvofJk","eventType":"all_sessions_revoked","ipAddress":"::ffff:127.0.0.1","hasMetadata":false,"msg":"Security event logged"}
{"level":30,"time":1768335810548,"env":"test","module":"auth-routes","userId":"ef293b12-0ae5-4312-8b50-d39fe9a5d7a3","msg":"User logged in successfully"}
{"level":50,"time":1768335810573,"env":"test","error":{},"msg":"Error deleting row note"}
{"level":30,"time":1768335810601,"env":"test","module":"auth-routes","userId":"68aafe45c970529be235c6adc1843579","msg":"User logged in successfully"}
{"level":30,"time":1768335810600,"env":"test","module":"audit-log-service","userId":"ef293b12-0ae5-4312-8b50-d39fe9a5d7a3","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335810626,"env":"test","module":"auth-routes","userId":"9f35e8e9-9fda-4722-80ad-cc21112f6c44","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts[2m > [22m[2mDataVault Autonumber Integration Tests[2m > [22m[2mshould generate basic autonumber without prefix
[22m[39mRow 1 Basic Autonumber: 0001
Row 2 Basic Autonumber: 0002

{"level":30,"time":1768335810652,"env":"test","module":"audit-log-service","userId":"68aafe45c970529be235c6adc1843579","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768335810662,"env":"test","module":"rbac-middleware","userId":"ef293b12-0ae5-4312-8b50-d39fe9a5d7a3","userRole":"viewer","permission":"project:delete","path":"/7b8eed5f-e694-427a-8b9e-1bb612b0ea4d","msg":"Permission denied"}
{"level":30,"time":1768335810678,"env":"test","module":"audit-log-service","userId":"9f35e8e9-9fda-4722-80ad-cc21112f6c44","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768335810682,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335810706,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mComplete Organization Workflow[2m > [22m[2mStep 14: Remove member from org
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.removeMember (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:341:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:283:7
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335810725,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts[2m > [22m[2mDataVault Table Permissions API (v4 Micro-Phase 6)
[22m[39mðŸ“š API Documentation available at /api-docs
[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768335810714,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768335810715,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768335810719,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768335810724,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768335810724,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768335810725,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768335810725,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Disable Flow[2m > [22m[2mshould disable MFA with password verification
[22m[39mError deleting test user 15258fcb11a85ef9cb5e9a2a39966d23: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/mfa.flow.real.test.ts:46:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335810758,"env":"test","module":"auth-routes","userId":"68aafe45c970529be235c6adc1843579","sessionCount":1,"msg":"Listed active sessions"}
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #7: Delete organization[2m > [22m[2mshould prevent deletion if org owns assets
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:260:19
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335810909,"env":"test","module":"user-credentials-repository","userId":"cJUyHRvpIlHYSiI5QTuk3","msg":"User credentials created"}
{"level":30,"time":1768335811056,"env":"test","module":"user-credentials-repository","userId":"651ef22e-b27a-47c8-8825-ab4a64e0e00a","msg":"User credentials created"}
{"level":30,"time":1768335811079,"env":"test","module":"user-credentials-repository","userId":"6e9e5d6c-d382-4a6e-8852-3d28863909e2","msg":"User credentials created"}
{"level":30,"time":1768335811114,"env":"test","module":"auth-routes","userId":"cJUyHRvpIlHYSiI5QTuk3","msg":"All other sessions revoked"}
{"level":30,"time":1768335811157,"env":"test","module":"email-queue","jobId":"1562f3cc-6d66-4c4a-9c8e-5d6e1d4af265","to":"protected-test-Df8xGwrd8YR3WcNKYojpp@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335811166,"env":"test","module":"audit-log-service","userId":"cJUyHRvpIlHYSiI5QTuk3","eventType":"all_sessions_revoked","ipAddress":"::ffff:127.0.0.1","hasMetadata":false,"msg":"Security event logged"}
{"level":30,"time":1768335811177,"env":"test","module":"email-queue","jobId":"81407bf1-74bd-428d-9dba-04cd17f74b48","to":"middleware-test-H5wCCE1WrZ4e846HayEeG@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335811197,"env":"test","module":"user-credentials-repository","userId":"07b4d007-b494-4011-b495-83ed0c2d5582","msg":"User credentials created"}
{"level":30,"time":1768335811208,"env":"test","module":"auth-routes","userId":"651ef22e-b27a-47c8-8825-ab4a64e0e00a","email":"protected-test-Df8xGwrd8YR3WcNKYojpp@example.com","msg":"User registered"}
{"level":30,"time":1768335811226,"env":"test","module":"auth-routes","userId":"6e9e5d6c-d382-4a6e-8852-3d28863909e2","email":"middleware-test-H5wCCE1WrZ4e846HayEeG@example.com","msg":"User registered"}
[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w30
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w29
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould return consistent error format for expired token
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w30 (Reused: true)

[90mstderr[2m | tests/unit/services/AuthService.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): Error: [vitest] No "closeDatabase" export is defined on the "../../../server/db" mock. Did you forget to return it from "vi.mock"?
If you need to partially mock a module, you can use "importOriginal" helper inside:

    at VitestMocker.createError [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:311:17[90m)[39m
    at Object.get [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:384:16[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:139:34
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m {
  codeFrame: [32m'vi.mock(import("../../../server/db"), async (importOriginal) => {\n'[39m +
    [32m'  const actual = await importOriginal()\n'[39m +
    [32m'  return {\n'[39m +
    [32m'    ...actual,\n'[39m +
    [32m'    // your mocked methods\n'[39m +
    [32m'  }\n'[39m +
    [32m'})'[39m
}

[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould not expose sensitive token data
[22m[39mError deleting test user 68aafe45c970529be235c6adc1843579: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/session.management.real.test.ts:44:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335811305,"env":"test","module":"email-queue","jobId":"5473dcce-88b5-4328-b831-90adc299cc9a","to":"test-B3Va09jY19UA1VObfU1eR@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w29 (Reused: true)

{"level":30,"time":1768335811311,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mUser Context Injection[2m > [22m[2mshould inject userId into request context
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335811351,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335811362,"env":"test","module":"auth-routes","userId":"07b4d007-b494-4011-b495-83ed0c2d5582","email":"test-B3Va09jY19UA1VObfU1eR@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Disable Flow[2m > [22m[2mshould require correct password to disable MFA
[22m[39m[TEST UTILS] MFA Secret verified for 0667cbfe7e52b8858e96be7575442270

{"level":30,"time":1768335811544,"env":"test","module":"user-credentials-repository","userId":"54rXHqIEiuANWMLnu-UVo","msg":"User credentials created"}
{"level":30,"time":1768335811680,"env":"test","workflowId":"6189d8ee-7643-484b-9cae-f232366513ef","userId":"da9e9f12-84fb-4a9c-8f3e-b00cb606d605","sectionsCount":1,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":30,"time":1768335811787,"env":"test","module":"auth-routes","userId":"6e9e5d6c-d382-4a6e-8852-3d28863909e2","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Disable Flow[2m > [22m[2mshould require correct password to disable MFA
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335811836,"env":"test","module":"audit-log-service","userId":"6e9e5d6c-d382-4a6e-8852-3d28863909e2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768335811894,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335811898,"env":"test","module":"user-credentials-repository","userId":"NWXIH-IQga6LeBKX25VqM","msg":"User credentials created"}
{"level":30,"time":1768335811901,"env":"test","module":"auth-routes","userId":"651ef22e-b27a-47c8-8825-ab4a64e0e00a","msg":"User logged in successfully"}
{"level":50,"time":1768335811902,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335811926,"env":"test","module":"user-credentials-repository","userId":"ca2cb206-8030-400b-a632-78084daf4414","msg":"User credentials created"}
{"level":30,"time":1768335811951,"env":"test","module":"audit-log-service","userId":"651ef22e-b27a-47c8-8825-ab4a64e0e00a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould track session activity timestamps
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335812030,"env":"test","module":"email-queue","jobId":"6fd984f1-48c8-4eb8-b683-ba23514f5ef2","to":"test-bhTubCm99NmdMaPZ6OCPU@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335812084,"env":"test","module":"auth-routes","userId":"ca2cb206-8030-400b-a632-78084daf4414","email":"test-bhTubCm99NmdMaPZ6OCPU@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts[2m > [22m[2mDataVault Table Permissions API (v4 Micro-Phase 6)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335812178,"env":"test","module":"email-queue","jobId":"3ac549f7-dd2c-4974-9a3b-5381752ffce4","to":"duplicate@test.com","subject":"You've been invited to join Test Organization","msg":"Email added to queue"}
{"level":30,"time":1768335812235,"env":"test","module":"user-credentials-repository","userId":"0XX9bmCitPo_6qHbyV8nS","msg":"User credentials created"}
[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mEdge Cases and Security[2m > [22m[2mCannot invite same email twice (pending invite exists)
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:548:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:321:23
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335812291,"env":"test","module":"auth-routes","userId":"0667cbfe7e52b8858e96be7575442270","msg":"Login requires MFA verification"}
{"level":30,"time":1768335812332,"env":"test","module":"auth-routes","userId":"0XX9bmCitPo_6qHbyV8nS","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Device marked as trusted"}
{"level":30,"time":1768335812386,"env":"test","module":"user-credentials-repository","userId":"41481037-6e36-45be-8198-973959f47c08","msg":"User credentials created"}
{"level":30,"time":1768335812399,"env":"test","module":"mfa-service","userId":"0667cbfe7e52b8858e96be7575442270","msg":"TOTP verification successful"}
{"level":30,"time":1768335812405,"env":"test","module":"email-queue","jobId":"03d6cc9b-0af8-45dd-b520-be9616cf3a19","to":"placeholder-test@example.com","subject":"You've been invited to join Test Org Audit","msg":"Email added to queue"}
{"level":30,"time":1768335812452,"env":"test","module":"auth-routes","userId":"0667cbfe7e52b8858e96be7575442270","msg":"MFA login successful"}
{"level":30,"time":1768335812471,"env":"test","module":"auth-routes","userId":"60f2f68768cce01496f4940d5a221ef8","msg":"User logged in successfully"}
{"level":30,"time":1768335812496,"env":"test","module":"email-queue","jobId":"c44546fa-5bad-4ed0-acc6-c1afc88b8003","to":"protected-test-koCk8Ux93Uho8jSSWcG01@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #8: Placeholder user cleanup[2m > [22m[2mshould cleanup placeholder user when invite is revoked
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:548:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:293:22
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335812528,"env":"test","module":"audit-log-service","userId":"60f2f68768cce01496f4940d5a221ef8","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335812543,"env":"test","module":"auth-routes","userId":"41481037-6e36-45be-8198-973959f47c08","email":"protected-test-koCk8Ux93Uho8jSSWcG01@example.com","msg":"User registered"}
{"level":30,"time":1768335812629,"env":"test","module":"auth-routes","userId":"60f2f68768cce01496f4940d5a221ef8","sessionCount":1,"msg":"Listed active sessions"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mUser Context Injection[2m > [22m[2mshould inject tenantId into request context
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335812644,"env":"test","module":"auth-routes","userId":"ca2cb206-8030-400b-a632-78084daf4414","msg":"User logged in successfully"}
{"level":40,"time":1768335812650,"env":"test","workflowId":"73345d34-847a-43c2-b3d5-2b9eb2ea06d2","msg":"No current or pinned version found for workflow, run might be unstable"}
{"level":30,"time":1768335812695,"env":"test","module":"audit-log-service","userId":"ca2cb206-8030-400b-a632-78084daf4414","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335812708,"env":"test","module":"user-credentials-repository","userId":"w53PTlk_4mzBbdXFhxyDE","msg":"User credentials created"}
{"level":30,"time":1768335812831,"env":"test","module":"auth-routes","userId":"w53PTlk_4mzBbdXFhxyDE","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Device marked as trusted"}
{"level":40,"time":1768335812943,"env":"test","module":"auth-middleware","error":{"name":"TokenExpiredError","code":"AUTH_002","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768335812944,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768335812984,"env":"test","module":"auth-routes","userId":"w53PTlk_4mzBbdXFhxyDE","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Trusted device expiry updated"}
{"level":50,"time":1768335812989,"env":"test","error":{"length":137,"name":"error","severity":"ERROR","code":"22P02","where":"unnamed portal parameter $2 = '...'","file":"uuid.c","line":"138","routine":"string_to_uuid"},"input":{"runId":"7c29531c-514b-44a1-8be5-e06dbaaf2bfc","workflowId":"73345d34-847a-43c2-b3d5-2b9eb2ea06d2","versionId":"draft","type":"run.start","timestamp":"2026-01-13T20:23:32.936Z","isPreview":false,"payload":{"accessMode":"anonymous"}},"msg":"Failed to record analytics event"}
{"level":30,"time":1768335813019,"env":"test","module":"email-queue","jobId":"0ba15b9f-018d-460d-8ecd-c86858aa0716","to":"expired@test.com","subject":"You've been invited to join Test Organization","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #8: Placeholder user cleanup[2m > [22m[2mshould cleanup placeholder user when invite is revoked
[22m[39mCleaned up placeholder user df7eafd0-9342-415a-b5d0-2fcb885692a6 (no pending invites or memberships)

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts[2m > [22m[2mDataVault v4 Regression Tests[2m > [22m[2mTable Permissions[2m > [22m[2mshould update table permission role
[22m[39mUpdate permission failed: {
  id: [32m'dd837fe7-3ff3-46e3-9bf5-058499f1e098'[39m,
  tableId: [32m'3125ceb2-a9f7-4124-8c51-37dbd0caecc7'[39m,
  userId: [32m'other-user-id'[39m,
  role: [32m'write'[39m,
  createdAt: [32m'2026-01-13T20:23:34.030Z'[39m
}

{"level":30,"time":1768335813089,"env":"test","module":"user-credentials-repository","userId":"1cbbe46a-d6cd-47bd-97d9-50c35b7f9cc3","msg":"User credentials created"}
[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mEdge Cases and Security[2m > [22m[2mCannot accept expired invite
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:548:7)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:346:22
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335813180,"env":"test","module":"auth-routes","userId":"41481037-6e36-45be-8198-973959f47c08","msg":"User logged in successfully"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould track session activity timestamps
[22m[39mError deleting test user 60f2f68768cce01496f4940d5a221ef8: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/session.management.real.test.ts:44:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335813182,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335813182,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335813194,"env":"test","module":"email-queue","jobId":"4f4343b5-6cce-415d-ad0b-bd2c5e125d26","to":"test-z9LczYSKNOxqglaFkS5pO@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335813237,"env":"test","module":"audit-log-service","userId":"41481037-6e36-45be-8198-973959f47c08","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335813244,"env":"test","module":"auth-routes","userId":"1cbbe46a-d6cd-47bd-97d9-50c35b7f9cc3","email":"test-z9LczYSKNOxqglaFkS5pO@example.com","msg":"User registered"}
{"level":30,"time":1768335813267,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335813268,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/session.management.real.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 45225[2mms[22m[39m
       [33m[2mâœ“[22m[39m should list all active sessions for current user [33m 2772[2mms[22m[39m
       [33m[2mâœ“[22m[39m should mark current session correctly [33m 2481[2mms[22m[39m
       [33m[2mâœ“[22m[39m should exclude revoked sessions [33m 2533[2mms[22m[39m
       [33m[2mâœ“[22m[39m should order sessions by last used (most recent first) [33m 3265[2mms[22m[39m
       [33m[2mâœ“[22m[39m should filter sessions by current user only [33m 4303[2mms[22m[39m
       [33m[2mâœ“[22m[39m should revoke specific session [33m 2752[2mms[22m[39m
       [33m[2mâœ“[22m[39m should prevent revoking current session [33m 1998[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 404 for non-existent session [33m 1830[2mms[22m[39m
       [33m[2mâœ“[22m[39m should prevent revoking other user's session [33m 3739[2mms[22m[39m
       [33m[2mâœ“[22m[39m should revoke all other sessions [33m 3678[2mms[22m[39m
       [33m[2mâœ“[22m[39m should keep current session active [33m 2861[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 400 if no active session found [33m 1887[2mms[22m[39m
       [33m[2mâœ“[22m[39m should revoke all trusted devices [33m 2285[2mms[22m[39m
       [33m[2mâœ“[22m[39m should handle user with single session gracefully [33m 2106[2mms[22m[39m
       [33m[2mâœ“[22m[39m should include device metadata in sessions [33m 1897[2mms[22m[39m
       [33m[2mâœ“[22m[39m should not expose sensitive token data [33m 1895[2mms[22m[39m
       [33m[2mâœ“[22m[39m should track session activity timestamps [33m 1877[2mms[22m[39m
 [32mâœ“[39m tests/unit/repositories/WorkflowTemplateRepository.test.ts [2m([22m[2m19 tests[22m[2m)[22m[33m 14113[2mms[22m[39m
       [33m[2mâœ“[22m[39m should create a workflow template mapping [33m 636[2mms[22m[39m
       [33m[2mâœ“[22m[39m should create non-primary mapping by default [33m 622[2mms[22m[39m
       [33m[2mâœ“[22m[39m should find all templates for a workflow version [33m 719[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return empty array for version with no templates [33m 606[2mms[22m[39m
       [33m[2mâœ“[22m[39m should order by createdAt desc (newest first) [33m 733[2mms[22m[39m
       [33m[2mâœ“[22m[39m should find mapping by workflow version and key [33m 677[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return undefined for non-existent key [33m 629[2mms[22m[39m
       [33m[2mâœ“[22m[39m should find primary template for workflow version [33m 742[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return undefined when no primary template exists [33m 666[2mms[22m[39m
       [33m[2mâœ“[22m[39m should set a template as primary and unset others [33m 849[2mms[22m[39m
       [33m[2mâœ“[22m[39m should handle setting primary when none existed before [33m 848[2mms[22m[39m
       [33m[2mâœ“[22m[39m should not delete mapping if workflow version does not match [33m 853[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return true if key exists in workflow version [33m 664[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return false if key does not exist [33m 602[2mms[22m[39m
       [33m[2mâœ“[22m[39m should exclude specified id when checking existence [33m 660[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return true if key exists on different mapping [33m 716[2mms[22m[39m
       [33m[2mâœ“[22m[39m should update mapping fields [33m 655[2mms[22m[39m
       [33m[2mâœ“[22m[39m should find mapping by id [33m 647[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return undefined for non-existent id [33m 597[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.permissions.test.ts[2m > [22m[2mDataVault Table Permissions API (v4 Micro-Phase 6)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335813331,"env":"test","module":"user-credentials-repository","userId":"f768009a-3c70-44c3-8295-d0124d832fba","msg":"User credentials created"}
{"level":30,"time":1768335813356,"env":"test","module":"user-credentials-repository","userId":"6zsG07Dw1rMR6xM33pQjh","msg":"User credentials created"}
{"level":30,"time":1768335813435,"env":"test","module":"email-queue","jobId":"e661e6a5-5563-4c03-9da6-15267b66b20f","to":"middleware-test-QXmIWoDWPuHqrX0V2vTFS@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335813459,"env":"test","module":"auth-routes","userId":"6zsG07Dw1rMR6xM33pQjh","deviceCount":2,"msg":"Listed trusted devices"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Disable Flow[2m > [22m[2mshould require correct password to disable MFA
[22m[39mError deleting test user 0667cbfe7e52b8858e96be7575442270: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/mfa.flow.real.test.ts:46:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335813488,"env":"test","module":"auth-routes","userId":"f768009a-3c70-44c3-8295-d0124d832fba","email":"middleware-test-QXmIWoDWPuHqrX0V2vTFS@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould handle malformed JWT gracefully
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

{"level":30,"time":1768335813680,"env":"test","module":"user-credentials-repository","userId":"04f6b656-c597-4bda-9790-f67b75048824","msg":"User credentials created"}
{"level":30,"time":1768335813777,"env":"test","module":"email-queue","jobId":"252ff6dd-cb7b-4227-9d80-16f9fe6e7b9c","to":"protected-test-Gn-PGoDh15ORdAq2V-w8S@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335813799,"env":"test","module":"user-credentials-repository","userId":"uAKzAIgX-DGvoDBZ9Z-RX","msg":"User credentials created"}
{"level":30,"time":1768335813829,"env":"test","module":"auth-routes","userId":"1cbbe46a-d6cd-47bd-97d9-50c35b7f9cc3","msg":"User logged in successfully"}
{"level":30,"time":1768335813830,"env":"test","module":"auth-routes","userId":"04f6b656-c597-4bda-9790-f67b75048824","email":"protected-test-Gn-PGoDh15ORdAq2V-w8S@example.com","msg":"User registered"}
{"level":30,"time":1768335813882,"env":"test","module":"audit-log-service","userId":"1cbbe46a-d6cd-47bd-97d9-50c35b7f9cc3","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mEdge Cases and Security[2m > [22m[2mCannot transfer workflow to org user is not a member of
[22m[39mFailed to write audit log: error: invalid input syntax for type uuid: ""
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:20:13)
    at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:69:7
    at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:142:22[90m)[39m
    at OrganizationService.createOrganization (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:48:12)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:371:20
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m129[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'22P02'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [32m"unnamed portal parameter $1 = ''"[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'uuid.c'[39m,
  line: [32m'138'[39m,
  routine: [32m'string_to_uuid'[39m
}

{"level":30,"time":1768335813897,"env":"test","module":"auth-routes","userId":"uAKzAIgX-DGvoDBZ9Z-RX","deviceCount":0,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mUser Context Injection[2m > [22m[2mshould inject role into request context
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768335814021,"env":"test","error":{},"msg":"Error granting table permission"}
{"level":30,"time":1768335814040,"env":"test","module":"auth-routes","userId":"f768009a-3c70-44c3-8295-d0124d832fba","msg":"User logged in successfully"}
{"level":30,"time":1768335814095,"env":"test","module":"audit-log-service","userId":"f768009a-3c70-44c3-8295-d0124d832fba","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768335814100,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768335814100,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335814254,"env":"test","module":"user-credentials-repository","userId":"4V5KYFXR2DeYrvZvWWZbS","msg":"User credentials created"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Regeneration[2m > [22m[2mshould regenerate backup codes
[22m[39m[TEST UTILS] MFA Secret verified for 4336e5debec67e5aa34794a6601b1c18

{"level":30,"time":1768335814288,"env":"test","module":"user-credentials-repository","userId":"8299c512-3128-40d4-953e-bfe200970e8d","msg":"User credentials created"}
{"level":30,"time":1768335814395,"env":"test","module":"email-queue","jobId":"75c6cc73-1eac-434b-b35e-30ccad82192f","to":"test-LZExfCVsKJ7tn6ilXxPZV@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335814403,"env":"test","module":"auth-routes","userId":"4V5KYFXR2DeYrvZvWWZbS","deviceId":"539c5731-e6d6-4ccd-ac15-1bb836ec8a8f","msg":"Trusted device revoked"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335814447,"env":"test","module":"auth-routes","userId":"8299c512-3128-40d4-953e-bfe200970e8d","email":"test-LZExfCVsKJ7tn6ilXxPZV@example.com","msg":"User registered"}
{"level":30,"time":1768335814499,"env":"test","module":"auth-routes","userId":"04f6b656-c597-4bda-9790-f67b75048824","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts[2m > [22m[2mDataVault Table Permissions API (v4 Micro-Phase 6)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335814525,"env":"test","module":"user-credentials-repository","userId":"94cc6100-c52d-4878-ab5c-fee5c2a00cf4","msg":"User credentials created"}
{"level":30,"time":1768335814549,"env":"test","module":"audit-log-service","userId":"04f6b656-c597-4bda-9790-f67b75048824","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Regeneration[2m > [22m[2mshould regenerate backup codes
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335814642,"env":"test","module":"email-queue","jobId":"da981ee9-82c8-40a7-80db-8bbc52f7b63f","to":"middleware-test-OOnGvf36wliRTriqLPIdo@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768335814645,"env":"test","error":{"length":137,"name":"error","severity":"ERROR","code":"22P02","where":"unnamed portal parameter $2 = '...'","file":"uuid.c","line":"138","routine":"string_to_uuid"},"input":{"runId":"7c29531c-514b-44a1-8be5-e06dbaaf2bfc","workflowId":"73345d34-847a-43c2-b3d5-2b9eb2ea06d2","versionId":"draft","type":"block.start","blockId":"0d37cdce-7118-4dac-b5b9-52e6c74b1e37","pageId":"4abcf69c-0495-4d2c-a5cd-a5f2badd084e","timestamp":"2026-01-13T20:23:34.592Z","isPreview":false,"payload":{"blockType":"write"}},"msg":"Failed to record analytics event"}
{"level":30,"time":1768335814700,"env":"test","module":"auth-routes","userId":"94cc6100-c52d-4878-ab5c-fee5c2a00cf4","email":"middleware-test-OOnGvf36wliRTriqLPIdo@example.com","msg":"User registered"}
{"level":30,"time":1768335814703,"env":"test","module":"write-runner","operation":"write_start","mode":"create","config":{"mode":"create","tableId":"65b322c2-e254-43e4-a3f4-37a4779a855f","dataSourceId":"ac8e55eb-fff4-43eb-a61a-3d8914219856","columnMappings":[{"value":"{{de2ea45f-2b7a-471a-8794-a48a0dc26c97}}","columnId":"0c99f4d5-e42c-4be5-a328-0f28b82056d6"}]},"tableId":"65b322c2-e254-43e4-a3f4-37a4779a855f","preview":false,"msg":"Starting write execution"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould handle JWT with wrong algorithm
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335814779,"env":"test","module":"user-credentials-repository","userId":"YoMdk09IUOgTmC9OHbygc","msg":"User credentials created"}
{"level":30,"time":1768335814791,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335814791,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335814840,"env":"test","msg":"DB: closing pool..."}
 [32mâœ“[39m tests/integration/organizations-audit-fixes.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 12931[2mms[22m[39m
       [33m[2mâœ“[22m[39m should cascade ownership to workflow runs when project is transferred [33m 1328[2mms[22m[39m
       [33m[2mâœ“[22m[39m should prevent double-acceptance via transaction [33m 1421[2mms[22m[39m
       [33m[2mâœ“[22m[39m should not create invite if email fails [33m 950[2mms[22m[39m
       [33m[2mâœ“[22m[39m should allow re-invite after invite expires [33m 1971[2mms[22m[39m
       [33m[2mâœ“[22m[39m should allow last admin to delete empty organization [33m 1008[2mms[22m[39m
       [33m[2mâœ“[22m[39m should prevent deletion if org owns assets [33m 1559[2mms[22m[39m
       [33m[2mâœ“[22m[39m should cleanup placeholder user when invite is revoked [33m 1402[2mms[22m[39m
       [33m[2mâœ“[22m[39m should fail fast on non-existent org [33m 789[2mms[22m[39m
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335814841,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/organizations-workflow.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 10751[2mms[22m[39m
       [33m[2mâœ“[22m[39m Step 1: Create organization [33m 665[2mms[22m[39m
       [33m[2mâœ“[22m[39m Step 2: Invite member via email [33m 888[2mms[22m[39m
       [33m[2mâœ“[22m[39m Step 3: Accept invite [33m 872[2mms[22m[39m
       [33m[2mâœ“[22m[39m Step 4: Create workflow owned by user [33m 622[2mms[22m[39m
       [33m[2mâœ“[22m[39m Step 5: Transfer workflow to organization [33m 309[2mms[22m[39m
       [33m[2mâœ“[22m[39m Step 6: Org member (user2) can access workflow [33m 550[2mms[22m[39m
       [33m[2mâœ“[22m[39m Step 16: Re-add member and verify access restored [33m 717[2mms[22m[39m
       [33m[2mâœ“[22m[39m Cannot invite same email twice (pending invite exists) [33m 843[2mms[22m[39m
       [33m[2mâœ“[22m[39m Cannot accept expired invite [33m 758[2mms[22m[39m
       [33m[2mâœ“[22m[39m Cannot transfer workflow to org user is not a member of [33m 912[2mms[22m[39m
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w31
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w31 (Reused: true)

{"level":30,"time":1768335814970,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335815005,"env":"test","module":"user-credentials-repository","userId":"9aa78406-45c3-4107-96c4-c1be113ca4a3","msg":"User credentials created"}
{"level":30,"time":1768335815013,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335815092,"env":"test","module":"auth-routes","userId":"8299c512-3128-40d4-953e-bfe200970e8d","msg":"User logged in successfully"}
{"level":30,"time":1768335815123,"env":"test","module":"auth-routes","userId":"4336e5debec67e5aa34794a6601b1c18","msg":"Login requires MFA verification"}
{"level":30,"time":1768335815133,"env":"test","module":"email-queue","jobId":"6ae17554-cac9-4a90-b31f-35ef899064fe","to":"protected-test-EIuEOc2VtrVS6-iYN8D7m@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335815134,"env":"test","module":"user-credentials-repository","userId":"DhkL0_nwgxoFgeYMWbDvq","msg":"User credentials created"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

{"level":30,"time":1768335815168,"env":"test","module":"audit-log-service","userId":"8299c512-3128-40d4-953e-bfe200970e8d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335815187,"env":"test","module":"auth-routes","userId":"9aa78406-45c3-4107-96c4-c1be113ca4a3","email":"protected-test-EIuEOc2VtrVS6-iYN8D7m@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

{"level":30,"time":1768335815240,"env":"test","module":"mfa-service","userId":"4336e5debec67e5aa34794a6601b1c18","msg":"TOTP verification successful"}
{"level":50,"time":1768335815267,"env":"test","error":{"length":137,"name":"error","severity":"ERROR","code":"22P02","where":"unnamed portal parameter $2 = '...'","file":"uuid.c","line":"138","routine":"string_to_uuid"},"input":{"runId":"7c29531c-514b-44a1-8be5-e06dbaaf2bfc","workflowId":"73345d34-847a-43c2-b3d5-2b9eb2ea06d2","versionId":"draft","type":"block.complete","blockId":"0d37cdce-7118-4dac-b5b9-52e6c74b1e37","pageId":"4abcf69c-0495-4d2c-a5cd-a5f2badd084e","timestamp":"2026-01-13T20:23:35.217Z","isPreview":false,"payload":{"blockType":"write"}},"msg":"Failed to record analytics event"}
{"level":30,"time":1768335815290,"env":"test","module":"auth-routes","userId":"94cc6100-c52d-4878-ab5c-fee5c2a00cf4","msg":"User logged in successfully"}
{"level":30,"time":1768335815292,"env":"test","module":"auth-routes","userId":"4336e5debec67e5aa34794a6601b1c18","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mRate Limiting on Protected Routes[2m > [22m[2mshould not apply general rate limiting to authenticated requests
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335815341,"env":"test","module":"audit-log-service","userId":"94cc6100-c52d-4878-ab5c-fee5c2a00cf4","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768335815347,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768335815347,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts[2m > [22m[2mDataVault Autonumber Integration Tests
[22m[39mError cleaning up table: Error: Table not found
    at DatavaultTablesService.verifyTenantOwnership (C:/Users/scoot/poll/VaultLogic/server/services/DatavaultTablesService.ts:150:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at DatavaultTablesService.deleteTable (C:/Users/scoot/poll/VaultLogic/server/services/DatavaultTablesService.ts:290:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/datavault.autonumber.test.ts:90:9

{"level":30,"time":1768335815382,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335815383,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/datavault.autonumber.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 12951[2mms[22m[39m
     [33m[2mâœ“[22m[39m should generate basic autonumber without prefix [33m 1094[2mms[22m[39m
     [33m[2mâœ“[22m[39m should generate autonumber with prefix [33m 1104[2mms[22m[39m
     [33m[2mâœ“[22m[39m should generate autonumber with yearly reset format [33m 1107[2mms[22m[39m
     [33m[2mâœ“[22m[39m should be atomic and prevent race conditions [33m 904[2mms[22m[39m
     [33m[2mâœ“[22m[39m should prevent manual updates to autonumber values [33m 1573[2mms[22m[39m
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w32
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w32 (Reused: true)

{"level":30,"time":1768335815540,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335815573,"env":"test","module":"user-credentials-repository","userId":"PjW7DVPNhAKxVgTGXUCZG","msg":"User credentials created"}
{"level":30,"time":1768335815573,"env":"test","module":"user-credentials-repository","userId":"221c9810-b989-4e56-b3fe-6afa33db8e27","msg":"User credentials created"}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335815583,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768335815644,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335815645,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335815681,"env":"test","module":"email-queue","jobId":"ffdfd205-59e6-4237-86a7-7ba0e8d025ba","to":"test-tlIWzC6pCnW4sRgTmVH85@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335815717,"env":"test","module":"mfa-service","userId":"4336e5debec67e5aa34794a6601b1c18","count":10,"msg":"Stored backup codes"}
{"level":30,"time":1768335815717,"env":"test","module":"mfa-service","userId":"4336e5debec67e5aa34794a6601b1c18","msg":"Regenerated backup codes"}
{"level":30,"time":1768335815717,"env":"test","module":"auth-routes","userId":"4336e5debec67e5aa34794a6601b1c18","msg":"Backup codes regenerated"}
{"level":30,"time":1768335815731,"env":"test","module":"auth-routes","userId":"221c9810-b989-4e56-b3fe-6afa33db8e27","email":"test-tlIWzC6pCnW4sRgTmVH85@example.com","msg":"User registered"}
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":50,"time":1768335815782,"env":"test","error":{"issues":[{"received":"invalid_type","code":"invalid_enum_value","options":["text","number","boolean","date","datetime","email","phone","url","json","auto_number","autonumber","reference","select","multiselect"],"path":["type"],"message":"Invalid enum value. Expected 'text' | 'number' | 'boolean' | 'date' | 'datetime' | 'email' | 'phone' | 'url' | 'json' | 'auto_number' | 'autonumber' | 'reference' | 'select' | 'multiselect', received 'invalid_type'"}],"name":"ZodError"},"msg":"Error creating DataVault column"}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts[2m > [22m[2mDataVault Table Permissions API (v4 Micro-Phase 6)
[22m[39mDEBUG: LOGIN HANDLER HIT

 [32mâœ“[39m tests/unit/services/PdfQueueService.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 12427[2mms[22m[39m
       [33m[2mâœ“[22m[39m should enqueue a PDF conversion job [33m 717[2mms[22m[39m
       [33m[2mâœ“[22m[39m should create output with empty storagePath initially [33m 693[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return job status for pending job [33m 661[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return null for non-existent job [33m 616[2mms[22m[39m
       [33m[2mâœ“[22m[39m should parse attempt count from error field [33m 663[2mms[22m[39m
       [33m[2mâœ“[22m[39m should convert DOCX to PDF immediately [33m 720[2mms[22m[39m
       [33m[2mâœ“[22m[39m should handle conversion errors gracefully [33m 704[2mms[22m[39m
       [33m[2mâœ“[22m[39m should start and stop service [33m 865[2mms[22m[39m
       [33m[2mâœ“[22m[39m should not start if already running [33m 552[2mms[22m[39m
       [33m[2mâœ“[22m[39m should handle stop when not running [33m 572[2mms[22m[39m
       [33m[2mâœ“[22m[39m should process pending jobs when queue is processed [33m 999[2mms[22m[39m
       [33m[2mâœ“[22m[39m should process multiple jobs in batch [33m 1237[2mms[22m[39m
       [33m[2mâœ“[22m[39m should handle missing DOCX output gracefully [33m 757[2mms[22m[39m
       [33m[2mâœ“[22m[39m should support enqueue within transaction [33m 823[2mms[22m[39m
       [33m[2mâœ“[22m[39m should support convertImmediate within transaction [33m 804[2mms[22m[39m
[90mstdout[2m | tests/unit/services/AuthService.test.ts[2m > [22m[2mAuthService[2m > [22m[2mJWT Token Management[2m > [22m[2mverifyToken()[2m > [22m[2mshould throw error for invalid token signature
[22m[39mDEBUG: verifyToken threw: Invalid or malformed token InvalidTokenError

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335815882,"env":"test","module":"auth-routes","userId":"9aa78406-45c3-4107-96c4-c1be113ca4a3","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

{"level":30,"time":1768335815938,"env":"test","module":"audit-log-service","userId":"9aa78406-45c3-4107-96c4-c1be113ca4a3","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
 [32mâœ“[39m tests/integration/auth/auth.middleware.integration.test.ts [2m([22m[2m27 tests[22m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 40460[2mms[22m[39m
       [33m[2mâœ“[22m[39m should allow access with valid JWT Bearer token [33m 1357[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 401 when no token provided [33m 1208[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 401 with invalid token [33m 1185[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 401 with expired token [33m 2386[2mms[22m[39m
       [33m[2mâœ“[22m[39m should authenticate with JWT Bearer token [33m 1263[2mms[22m[39m
       [33m[2mâœ“[22m[39m should authenticate with refresh token cookie (GET only) [33m 1336[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject cookie auth for POST requests (mutation-strict) [33m 1147[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject cookie auth for PUT requests [33m 1130[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject cookie auth for DELETE requests [33m 1126[2mms[22m[39m
       [33m[2mâœ“[22m[39m should allow cookie auth for HEAD requests [33m 1294[2mms[22m[39m
       [33m[2mâœ“[22m[39m should prioritize JWT over cookie when both present [33m 2341[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 401 when no auth provided [33m 1084[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 401 when both JWT and cookie are invalid [33m 1121[2mms[22m[39m
       [33m[2mâœ“[22m[39m should authenticate with JWT if provided [33m 1750[2mms[22m[39m
       [33m[2mâœ“[22m[39m should authenticate with cookie if JWT not provided [33m 1660[2mms[22m[39m
       [33m[2mâœ“[22m[39m should proceed anonymously if no auth provided [33m 1685[2mms[22m[39m
       [33m[2mâœ“[22m[39m should proceed anonymously if both JWT and cookie are invalid [33m 1720[2mms[22m[39m
       [33m[2mâœ“[22m[39m should only allow safe methods for cookie auth [33m 1345[2mms[22m[39m
       [33m[2mâœ“[22m[39m should ignore cookies when Bearer token present [33m 2540[2mms[22m[39m
       [33m[2mâœ“[22m[39m should attach userId to request [33m 1262[2mms[22m[39m
       [33m[2mâœ“[22m[39m should attach userEmail to request [33m 1262[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return consistent error format for missing token [33m 1151[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return consistent error format for invalid token [33m 1141[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return consistent error format for expired token [33m 2261[2mms[22m[39m
       [33m[2mâœ“[22m[39m should handle malformed JWT gracefully [33m 1156[2mms[22m[39m
       [33m[2mâœ“[22m[39m should handle JWT with wrong algorithm [33m 1247[2mms[22m[39m
{"level":30,"time":1768335816026,"env":"test","module":"user-credentials-repository","userId":"xeX2dlcbh1EUzi4xuvLtM","msg":"User credentials created"}
{"level":40,"time":1768335816106,"env":"test","workflowId":"b5ea3020-ab08-4ccf-b7d3-12b0d1159445","msg":"No current or pinned version found for workflow, run might be unstable"}
{"level":30,"time":1768335816132,"env":"test","module":"auth-service","email":"reset@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768335816137,"env":"test","module":"auth-service","email":"reset@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768335816174,"env":"test","module":"auth-service","tokenHash":"0f45e858fbc4176cdf4e411f88281edefc390ae5afe7df0f44cd9297f0a64580","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768335816185,"env":"test","workflowId":"85b440fd-b228-4d09-bd4f-5d849147e4e4","userId":"97bf4ae4-0e39-455f-b964-644b02ef5464","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335816177,"env":"test","module":"auth-service","tokenHash":"9206c2394794b8fc97fcd896f95e40028ab7a15c10279446c23fbdd4b4ae7a1e","plainTokenLen":13,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768335816177,"env":"test","module":"auth-service","tokenHash":"9206c2394794b8fc97fcd896f95e40028ab7a15c10279446c23fbdd4b4ae7a1e","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768335816177,"env":"test","module":"auth-service","allTokensCount":0,"msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768335816179,"env":"test","module":"auth-service","tokenHash":"0f45e858fbc4176cdf4e411f88281edefc390ae5afe7df0f44cd9297f0a64580","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768335816180,"env":"test","module":"auth-service","userId":"user-123","tokenHash":"0f45e858fbc4176cdf4e411f88281edefc390ae5afe7df0f44cd9297f0a64580","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768335816183,"env":"test","module":"auth-service","tokenHash":"0f45e858fbc4176cdf4e411f88281edefc390ae5afe7df0f44cd9297f0a64580","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768335816183,"env":"test","module":"auth-service","userId":"user-123","msg":"Security: Expired refresh token used"}
{"level":30,"time":1768335816191,"env":"test","module":"auth-service","msg":"Cleaned up expired tokens and old login attempts"}
{"level":30,"time":1768335816194,"env":"test","module":"auth-service","msg":"Cleaned up expired tokens and old login attempts"}
{"level":30,"time":1768335816196,"env":"test","module":"auth-service","msg":"Cleaned up expired tokens and old login attempts"}
{"level":30,"time":1768335816199,"env":"test","module":"auth-service","msg":"Cleaned up expired tokens and old login attempts"}
[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768335816227,"env":"test","module":"auth-service","tokenHash":"28a131649d03c352971244b3e0a304b53e80e05077e1e4f3ce7c4f4a15840bf2","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts[2m > [22m[2mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22m[2mshould create draft version on successful AI edit
[22m[39mDEBUG: Instantiating GoogleGenerativeAI
DEBUG: Getting model
DEBUG: Building system prompt
DEBUG: Building workflow context
DEBUG: Workflow context built
DEBUG: About to build full prompt. Parts: { s: [32m'string'[39m, w: [32m'string'[39m, u: [32m'string'[39m }
DEBUG: Full prompt built. Length: [33m4128[39m

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w34
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":30,"time":1768335816326,"env":"test","module":"auth-routes","userId":"221c9810-b989-4e56-b3fe-6afa33db8e27","msg":"User logged in successfully"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Regeneration[2m > [22m[2mshould regenerate backup codes
[22m[39mError deleting test user 4336e5debec67e5aa34794a6601b1c18: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/mfa.flow.real.test.ts:46:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w34 (Reused: true)

{"level":30,"time":1768335816359,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335816377,"env":"test","module":"audit-log-service","userId":"221c9810-b989-4e56-b3fe-6afa33db8e27","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335816409,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768335816450,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335816450,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768335816480,"env":"test","error":{"length":137,"name":"error","severity":"ERROR","code":"22P02","where":"unnamed portal parameter $2 = '...'","file":"uuid.c","line":"138","routine":"string_to_uuid"},"input":{"runId":"89291f23-06f2-4853-bd7f-c18798e9186c","workflowId":"b5ea3020-ab08-4ccf-b7d3-12b0d1159445","versionId":"draft","type":"run.start","timestamp":"2026-01-13T20:23:36.422Z","isPreview":false,"payload":{"accessMode":"anonymous"}},"msg":"Failed to record analytics event"}
{"level":30,"time":1768335816488,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335816488,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768335816507,"env":"test","error":{},"msg":"Error creating DataVault row"}
 [32mâœ“[39m tests/unit/engine/templateNode.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 11534[2mms[22m[39m
       [33m[2mâœ“[22m[39m should resolve template by key from workflowTemplates mapping [33m 714[2mms[22m[39m
       [33m[2mâœ“[22m[39m should throw error if template key not found [33m 576[2mms[22m[39m
       [33m[2mâœ“[22m[39m should store output in runOutputs table [33m 748[2mms[22m[39m
       [33m[2mâœ“[22m[39m should resolve template by templateId directly [33m 564[2mms[22m[39m
       [33m[2mâœ“[22m[39m should throw error if templateId not found [33m 574[2mms[22m[39m
       [33m[2mâœ“[22m[39m should use docxRenderer2 by default (v2 engine) [33m 631[2mms[22m[39m
       [33m[2mâœ“[22m[39m should use legacy engine when engine="legacy" [33m 559[2mms[22m[39m
       [33m[2mâœ“[22m[39m should generate PDF when toPdf=true [33m 707[2mms[22m[39m
       [33m[2mâœ“[22m[39m should default to DOCX when toPdf=false [33m 725[2mms[22m[39m
       [33m[2mâœ“[22m[39m should skip execution when condition evaluates to false [33m 518[2mms[22m[39m
       [33m[2mâœ“[22m[39m should execute when condition evaluates to true [33m 560[2mms[22m[39m
       [33m[2mâœ“[22m[39m should resolve simple bindings [33m 558[2mms[22m[39m
       [33m[2mâœ“[22m[39m should handle binding resolution errors gracefully [33m 516[2mms[22m[39m
       [33m[2mâœ“[22m[39m should record failed output in runOutputs table [33m 698[2mms[22m[39m
       [33m[2mâœ“[22m[39m should not throw errors (should return error in result) [33m 702[2mms[22m[39m
       [33m[2mâœ“[22m[39m should deny access to templates from different tenant [33m 594[2mms[22m[39m
       [33m[2mâœ“[22m[39m should require either templateKey or templateId [33m 508[2mms[22m[39m
 [32mâœ“[39m tests/integration/auth/oauth2.sessions.test.ts [2m([22m[2m25 tests[22m[2m)[22m[33m 13567[2mms[22m[39m
       [33m[2mâœ“[22m[39m should list all active sessions for current user [33m 593[2mms[22m[39m
       [33m[2mâœ“[22m[39m should mark current session as current [33m 518[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return empty array when user has no active sessions [33m 467[2mms[22m[39m
       [33m[2mâœ“[22m[39m should not include expired sessions [33m 453[2mms[22m[39m
       [33m[2mâœ“[22m[39m should not include revoked sessions [33m 512[2mms[22m[39m
       [33m[2mâœ“[22m[39m should parse device name from user agent [33m 442[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 401 for unauthenticated request [33m 341[2mms[22m[39m
       [33m[2mâœ“[22m[39m should revoke a specific session [33m 589[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 404 for non-existent session [33m 362[2mms[22m[39m
       [33m[2mâœ“[22m[39m should prevent revoking current session [33m 489[2mms[22m[39m
       [33m[2mâœ“[22m[39m should prevent revoking another user's session [33m 533[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 401 for unauthenticated request [33m 335[2mms[22m[39m
       [33m[2mâœ“[22m[39m should revoke all sessions except current [33m 892[2mms[22m[39m
       [33m[2mâœ“[22m[39m should revoke all trusted devices [33m 628[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 400 when no active session found [33m 335[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 401 for unauthenticated request [33m 354[2mms[22m[39m
         [33m[2mâœ“[22m[39m should mark current device as trusted [33m 475[2mms[22m[39m
         [33m[2mâœ“[22m[39m should update existing trusted device expiry [33m 654[2mms[22m[39m
         [33m[2mâœ“[22m[39m should list all trusted devices [33m 429[2mms[22m[39m
         [33m[2mâœ“[22m[39m should not include revoked devices [33m 437[2mms[22m[39m
         [33m[2mâœ“[22m[39m should revoke a trusted device [33m 557[2mms[22m[39m
         [33m[2mâœ“[22m[39m should return 404 for non-existent device [33m 328[2mms[22m[39m
       [33m[2mâœ“[22m[39m should track IP address for sessions [33m 453[2mms[22m[39m
       [33m[2mâœ“[22m[39m should track user agent for sessions [33m 436[2mms[22m[39m
       [33m[2mâœ“[22m[39m should update lastUsedAt on token refresh [33m 813[2mms[22m[39m
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335816650,"env":"test","workflowId":"85b440fd-b228-4d09-bd4f-5d849147e4e4","userId":"97bf4ae4-0e39-455f-b964-644b02ef5464","sectionsCount":1,"stepsCount":1,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":30,"time":1768335816781,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335816782,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335816864,"env":"test","module":"user-credentials-repository","userId":"c759f379-a2c9-42da-b775-8647910bf52b","msg":"User credentials created"}
{"level":30,"time":1768335816869,"env":"test","module":"version-service","workflowId":"85b440fd-b228-4d09-bd4f-5d849147e4e4","versionId":"07c25968-8b35-4e9f-96b5-ff2255f4ca9d","userId":"97bf4ae4-0e39-455f-b964-644b02ef5464","versionNumber":1,"msg":"Created draft version"}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768335816965,"env":"test","module":"email-queue","jobId":"29f8f419-52fe-414f-a619-0685aa2f8778","to":"protected-test-NQyp2mhR_qfTZODb5MSgv@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335816978,"env":"test","module":"ai-workflow-edit-routes","workflowId":"85b440fd-b228-4d09-bd4f-5d849147e4e4","versionId":"07c25968-8b35-4e9f-96b5-ff2255f4ca9d","opsCount":2,"msg":"AI edit completed"}
{"level":30,"time":1768335817017,"env":"test","module":"auth-routes","userId":"c759f379-a2c9-42da-b775-8647910bf52b","email":"protected-test-NQyp2mhR_qfTZODb5MSgv@example.com","msg":"User registered"}
{"level":50,"time":1768335817029,"env":"test","error":{},"msg":"Error fetching DataVault table"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Regeneration[2m > [22m[2mshould return error if MFA not enabled
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mMixed Auth Scenarios[2m > [22m[2mshould handle request with both Bearer token and cookies
[22m[39mDEBUG: LOGIN HANDLER HIT

 [32mâœ“[39m tests/integration/datavault-v4-regression.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 14755[2mms[22m[39m
       [33m[2mâœ“[22m[39m should create a select column with options [33m 489[2mms[22m[39m
       [33m[2mâœ“[22m[39m should create a multiselect column with options [33m 464[2mms[22m[39m
       [33m[2mâœ“[22m[39m should validate select value against options [33m 1173[2mms[22m[39m
       [33m[2mâœ“[22m[39m should validate multiselect values as array [33m 872[2mms[22m[39m
       [33m[2mâœ“[22m[39m should create an autonumber column with sequence [33m 470[2mms[22m[39m
       [33m[2mâœ“[22m[39m should format autonumber with prefix [33m 946[2mms[22m[39m
       [33m[2mâœ“[22m[39m should create a note for a row [33m 410[2mms[22m[39m
       [33m[2mâœ“[22m[39m should get all notes for a row [33m 717[2mms[22m[39m
       [33m[2mâœ“[22m[39m should delete a note [33m 707[2mms[22m[39m
       [33m[2mâœ“[22m[39m should not allow deleting notes by other users [33m 614[2mms[22m[39m
       [33m[2mâœ“[22m[39m should create an API token [33m 347[2mms[22m[39m
       [33m[2mâœ“[22m[39m should revoke (delete) an API token [33m 546[2mms[22m[39m
       [33m[2mâœ“[22m[39m should grant table permission [33m 367[2mms[22m[39m
       [33m[2mâœ“[22m[39m should update table permission role [33m 530[2mms[22m[39m
       [33m[2mâœ“[22m[39m should revoke table permission [33m 625[2mms[22m[39m
       [33m[2mâœ“[22m[39m should enforce RBAC - only owners can manage permissions [33m 308[2mms[22m[39m
       [33m[2mâœ“[22m[39m should paginate rows efficiently [33m 1499[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return user-friendly error for missing required fields [33m 731[2mms[22m[39m
{"level":30,"time":1768335817259,"env":"test","workflowId":"f4a33350-3c6d-42c3-b40e-97e1f880dce6","userId":"97bf4ae4-0e39-455f-b964-644b02ef5464","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":50,"time":1768335817289,"env":"test","error":{},"msg":"Error updating DataVault table"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts[2m > [22m[2mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22m[2mshould enforce draft mode (revert active workflow to draft)
[22m[39mDEBUG: Instantiating GoogleGenerativeAI
DEBUG: Getting model
DEBUG: Building system prompt
DEBUG: Building workflow context
DEBUG: Workflow context built
DEBUG: About to build full prompt. Parts: { s: [32m'string'[39m, w: [32m'string'[39m, u: [32m'string'[39m }
DEBUG: Full prompt built. Length: [33m4099[39m

{"level":30,"time":1768335817391,"env":"test","module":"writeback-execution-service","runId":"062d3974-7510-4345-a807-542c17f15db0","workflowId":"57d81f60-02f7-4f41-ac20-4fb826ca70fd","msg":"Executing writeback mappings for completed run"}
{"level":50,"time":1768335817398,"env":"test","error":{},"msg":"Error updating DataVault table"}
[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335817438,"env":"test","module":"writeback-execution-service","runId":"062d3974-7510-4345-a807-542c17f15db0","workflowId":"57d81f60-02f7-4f41-ac20-4fb826ca70fd","mappingCount":1,"msg":"Found writeback mappings"}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w35
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w35 (Reused: true)

{"level":30,"time":1768335817496,"env":"test","msg":"DB: initializing... Local"}
{"level":50,"time":1768335817504,"env":"test","error":{},"msg":"Error deleting DataVault table"}
{"level":30,"time":1768335817545,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335817581,"env":"test","module":"auth-routes","userId":"2422dbdfe1d5d1dbed832703b82443bf","msg":"User logged in successfully"}
{"level":50,"time":1768335817607,"env":"test","error":{},"msg":"Error deleting DataVault table"}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335817636,"env":"test","module":"writeback-execution-service","runId":"062d3974-7510-4345-a807-542c17f15db0","workflowId":"57d81f60-02f7-4f41-ac20-4fb826ca70fd","mappingId":"11b9cf12-a844-4acf-939e-5f7d5cc9098a","tableId":"29b0962c-add8-4697-8cf7-e97c57910a87","msg":"Executing writeback mapping"}
{"level":30,"time":1768335817636,"env":"test","module":"audit-log-service","userId":"2422dbdfe1d5d1dbed832703b82443bf","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335817676,"env":"test","module":"auth-routes","userId":"c759f379-a2c9-42da-b775-8647910bf52b","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768335817705,"env":"test","error":{},"msg":"Error deleting DataVault table"}
{"level":30,"time":1768335817713,"env":"test","workflowId":"f4a33350-3c6d-42c3-b40e-97e1f880dce6","userId":"97bf4ae4-0e39-455f-b964-644b02ef5464","sectionsCount":1,"stepsCount":1,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":30,"time":1768335817713,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768335817723,"env":"test","module":"audit-log-service","userId":"c759f379-a2c9-42da-b775-8647910bf52b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mMixed Auth Scenarios[2m > [22m[2mshould handle request with both Bearer token and cookies
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768335817922,"env":"test","error":{},"msg":"Error fetching table permissions"}
{"level":30,"time":1768335817924,"env":"test","module":"version-service","workflowId":"f4a33350-3c6d-42c3-b40e-97e1f880dce6","versionId":"736f8e13-74db-4a24-9c0a-8a9211d834e6","userId":"97bf4ae4-0e39-455f-b964-644b02ef5464","versionNumber":1,"msg":"Created draft version"}
{"level":50,"time":1768335817951,"env":"test","error":{"length":137,"name":"error","severity":"ERROR","code":"22P02","where":"unnamed portal parameter $2 = '...'","file":"uuid.c","line":"138","routine":"string_to_uuid"},"input":{"runId":"89291f23-06f2-4853-bd7f-c18798e9186c","workflowId":"b5ea3020-ab08-4ccf-b7d3-12b0d1159445","versionId":"draft","type":"block.start","blockId":"7bbb4710-daef-4f31-b9a4-98e24d7d121e","pageId":"d0bcb5c9-e1dd-409a-bf50-f232a8234b2d","timestamp":"2026-01-13T20:23:37.903Z","isPreview":false,"payload":{"blockType":"query"}},"msg":"Failed to record analytics event"}
{"level":30,"time":1768335818003,"env":"test","workflowId":"b5ea3020-ab08-4ccf-b7d3-12b0d1159445","queryId":"9d8ed88a-3411-4173-9121-d14945569ad1","outputVar":"my_results","msg":"Executing query block"}
{"level":30,"time":1768335818017,"env":"test","module":"ai-workflow-edit-routes","workflowId":"f4a33350-3c6d-42c3-b40e-97e1f880dce6","versionId":"736f8e13-74db-4a24-9c0a-8a9211d834e6","opsCount":2,"msg":"AI edit completed"}
{"level":50,"time":1768335818022,"env":"test","error":{},"msg":"Error fetching table permissions"}
{"level":30,"time":1768335818056,"env":"test","module":"writeback-execution-service","runId":"062d3974-7510-4345-a807-542c17f15db0","workflowId":"57d81f60-02f7-4f41-ac20-4fb826ca70fd","mappingId":"11b9cf12-a844-4acf-939e-5f7d5cc9098a","columnCount":3,"msg":"Successfully created DataVault row"}
{"level":30,"time":1768335818056,"env":"test","module":"writeback-execution-service","runId":"062d3974-7510-4345-a807-542c17f15db0","workflowId":"57d81f60-02f7-4f41-ac20-4fb826ca70fd","rowsCreated":1,"errorCount":0,"msg":"Writeback execution completed"}
{"level":30,"time":1768335818230,"env":"test","workflowId":"5fece3ee-f34f-45a5-bf3d-81cbf7114520","userId":"97bf4ae4-0e39-455f-b964-644b02ef5464","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":30,"time":1768335818287,"env":"test","module":"auth-routes","userId":"c759f379-a2c9-42da-b775-8647910bf52b","msg":"User logged in successfully"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Regeneration[2m > [22m[2mshould return error if MFA not enabled
[22m[39mError deleting test user 2422dbdfe1d5d1dbed832703b82443bf: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/mfa.flow.real.test.ts:46:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts[2m > [22m[2mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22m[2mshould not create version when no changes detected (checksum match)
[22m[39mDEBUG: Instantiating GoogleGenerativeAI
DEBUG: Getting model
DEBUG: Building system prompt
DEBUG: Building workflow context
DEBUG: Workflow context built
DEBUG: About to build full prompt. Parts: { s: [32m'string'[39m, w: [32m'string'[39m, u: [32m'string'[39m }
DEBUG: Full prompt built. Length: [33m4094[39m

{"level":30,"time":1768335818338,"env":"test","module":"auth-service","tokenHash":"82d1e0354c3579937cd978fd9d435c7ea098781eb9ae13cbca9b81a939fcdd26","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768335818340,"env":"test","module":"audit-log-service","userId":"c759f379-a2c9-42da-b775-8647910bf52b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768335818342,"env":"test","module":"auth-service","email":"reset@example.com","msg":"Password reset email sent"}
{"level":50,"time":1768335818350,"env":"test","error":{"length":137,"name":"error","severity":"ERROR","code":"22P02","where":"unnamed portal parameter $2 = '...'","file":"uuid.c","line":"138","routine":"string_to_uuid"},"input":{"runId":"89291f23-06f2-4853-bd7f-c18798e9186c","workflowId":"b5ea3020-ab08-4ccf-b7d3-12b0d1159445","versionId":"draft","type":"block.complete","blockId":"7bbb4710-daef-4f31-b9a4-98e24d7d121e","pageId":"d0bcb5c9-e1dd-409a-bf50-f232a8234b2d","timestamp":"2026-01-13T20:23:38.300Z","isPreview":false,"payload":{"blockType":"query"}},"msg":"Failed to record analytics event"}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

{"level":50,"time":1768335818666,"env":"test","error":{},"msg":"Error granting table permission"}
{"level":30,"time":1768335818690,"env":"test","workflowId":"5fece3ee-f34f-45a5-bf3d-81cbf7114520","userId":"97bf4ae4-0e39-455f-b964-644b02ef5464","sectionsCount":1,"stepsCount":1,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":50,"time":1768335818710,"env":"test","error":{"length":137,"name":"error","severity":"ERROR","code":"22P02","where":"unnamed portal parameter $2 = '...'","file":"uuid.c","line":"138","routine":"string_to_uuid"},"input":{"runId":"89291f23-06f2-4853-bd7f-c18798e9186c","workflowId":"b5ea3020-ab08-4ccf-b7d3-12b0d1159445","versionId":"draft","type":"block.start","blockId":"827af409-fef1-4052-b04f-a014c720af96","pageId":"d0bcb5c9-e1dd-409a-bf50-f232a8234b2d","timestamp":"2026-01-13T20:23:38.350Z","isPreview":false,"payload":{"blockType":"validate"}},"msg":"Failed to record analytics event"}
{"level":50,"time":1768335818771,"env":"test","error":{},"msg":"Error granting table permission"}
{"level":30,"time":1768335818825,"env":"test","module":"user-credentials-repository","userId":"c1202cb4-4d66-4122-a780-ba84138d75e5","msg":"User credentials created"}
{"level":30,"time":1768335818887,"env":"test","module":"version-service","workflowId":"5fece3ee-f34f-45a5-bf3d-81cbf7114520","versionId":"dbd47e95-933c-4d17-92be-42279708d5b6","userId":"97bf4ae4-0e39-455f-b964-644b02ef5464","versionNumber":1,"msg":"Created draft version"}
{"level":30,"time":1768335818890,"env":"test","module":"auth-service","email":"reset@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768335818925,"env":"test","module":"email-queue","jobId":"3af6af41-60f2-445f-a2e9-5649881f1a41","to":"protected-test-94vAgz3hMsfMmyQc6EGR7@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335818976,"env":"test","module":"auth-routes","userId":"c1202cb4-4d66-4122-a780-ba84138d75e5","email":"protected-test-94vAgz3hMsfMmyQc6EGR7@example.com","msg":"User registered"}
{"level":30,"time":1768335818991,"env":"test","module":"ai-workflow-edit-routes","workflowId":"5fece3ee-f34f-45a5-bf3d-81cbf7114520","versionId":"dbd47e95-933c-4d17-92be-42279708d5b6","opsCount":2,"msg":"AI edit completed"}
{"level":30,"time":1768335819004,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335819055,"env":"test","module":"writeback-execution-service","runId":"1b0526f0-8165-4e17-b02b-f742be8f9f38","workflowId":"57d81f60-02f7-4f41-ac20-4fb826ca70fd","msg":"Executing writeback mappings for completed run"}
{"level":50,"time":1768335819066,"env":"test","error":{"length":137,"name":"error","severity":"ERROR","code":"22P02","where":"unnamed portal parameter $2 = '...'","file":"uuid.c","line":"138","routine":"string_to_uuid"},"input":{"runId":"89291f23-06f2-4853-bd7f-c18798e9186c","workflowId":"b5ea3020-ab08-4ccf-b7d3-12b0d1159445","versionId":"draft","type":"block.complete","blockId":"827af409-fef1-4052-b04f-a014c720af96","pageId":"d0bcb5c9-e1dd-409a-bf50-f232a8234b2d","timestamp":"2026-01-13T20:23:38.711Z","isPreview":false,"payload":{"blockType":"validate"}},"msg":"Failed to record analytics event"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mMixed Auth Scenarios[2m > [22m[2mshould prioritize Bearer token over cookie when both present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335819111,"env":"test","module":"writeback-execution-service","runId":"1b0526f0-8165-4e17-b02b-f742be8f9f38","workflowId":"57d81f60-02f7-4f41-ac20-4fb826ca70fd","mappingCount":1,"msg":"Found writeback mappings"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mTenant-Level MFA Enforcement[2m > [22m[2mshould enforce MFA for tenant users when required by tenant
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335819147,"env":"test","workflowId":"5fece3ee-f34f-45a5-bf3d-81cbf7114520","userId":"97bf4ae4-0e39-455f-b964-644b02ef5464","sectionsCount":1,"stepsCount":1,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":30,"time":1768335819200,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":50,"time":1768335819235,"env":"test","error":{},"msg":"Error revoking table permission"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts[2m > [22m[2mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22m[2mshould not create version when no changes detected (checksum match)
[22m[39mDEBUG: Instantiating GoogleGenerativeAI
DEBUG: Getting model
DEBUG: Building system prompt
DEBUG: Building workflow context
DEBUG: Workflow context built
DEBUG: About to build full prompt. Parts: { s: [32m'string'[39m, w: [32m'string'[39m, u: [32m'string'[39m }
DEBUG: Full prompt built. Length: [33m4188[39m

{"level":30,"time":1768335819314,"env":"test","module":"writeback-execution-service","runId":"1b0526f0-8165-4e17-b02b-f742be8f9f38","workflowId":"57d81f60-02f7-4f41-ac20-4fb826ca70fd","mappingId":"11b9cf12-a844-4acf-939e-5f7d5cc9098a","tableId":"29b0962c-add8-4697-8cf7-e97c57910a87","msg":"Executing writeback mapping"}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w38
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w38 (Reused: true)

{"level":30,"time":1768335819369,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335819423,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335819451,"env":"test","workflowId":"5fece3ee-f34f-45a5-bf3d-81cbf7114520","userId":"97bf4ae4-0e39-455f-b964-644b02ef5464","sectionsCount":1,"stepsCount":1,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":30,"time":1768335819552,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335819553,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335819614,"env":"test","module":"ai-workflow-edit-routes","workflowId":"5fece3ee-f34f-45a5-bf3d-81cbf7114520","msg":"AI made no changes (checksum match)"}
{"level":30,"time":1768335819697,"env":"test","module":"auth-routes","userId":"c1202cb4-4d66-4122-a780-ba84138d75e5","msg":"User logged in successfully"}
{"level":30,"time":1768335819728,"env":"test","module":"auth-routes","userId":"dd461f9b9dd465d416f3732db7fac05b","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335819743,"env":"test","module":"writeback-execution-service","runId":"1b0526f0-8165-4e17-b02b-f742be8f9f38","workflowId":"57d81f60-02f7-4f41-ac20-4fb826ca70fd","mappingId":"11b9cf12-a844-4acf-939e-5f7d5cc9098a","columnCount":3,"msg":"Successfully created DataVault row"}
{"level":30,"time":1768335819743,"env":"test","module":"writeback-execution-service","runId":"1b0526f0-8165-4e17-b02b-f742be8f9f38","workflowId":"57d81f60-02f7-4f41-ac20-4fb826ca70fd","rowsCreated":1,"errorCount":0,"msg":"Writeback execution completed"}
{"level":30,"time":1768335819743,"env":"test","runId":"1b0526f0-8165-4e17-b02b-f742be8f9f38","rowsCreated":1,"msg":"DataVault writeback completed"}
{"level":30,"time":1768335819744,"env":"test","runId":"1b0526f0-8165-4e17-b02b-f742be8f9f38","service":"DocumentGenerationService","msg":"Starting document generation for run"}
{"level":30,"time":1768335819748,"env":"test","module":"audit-log-service","userId":"c1202cb4-4d66-4122-a780-ba84138d75e5","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mMixed Auth Scenarios[2m > [22m[2mshould prioritize Bearer token over cookie when both present
[22m[39mDEBUG: LOGIN HANDLER HIT

 [32mâœ“[39m tests/integration/dataBlocks.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 8680[2mms[22m[39m
     [33m[2mâœ“[22m[39m should write data to DataVault via WriteBlock [33m 3405[2mms[22m[39m
     [33m[2mâœ“[22m[39m should query data from DataVault via QueryBlock and use in Logic [33m 3673[2mms[22m[39m
{"level":50,"time":1768335819774,"env":"test","error":{},"msg":"Error updating DataVault table"}
 [32mâœ“[39m tests/unit/services/AuthService.test.ts [2m([22m[2m113 tests[22m[2m)[22m[33m 8892[2mms[22m[39m
         [33m[2mâœ“[22m[39m should generate different hashes for same password [33m 480[2mms[22m[39m
         [33m[2mâœ“[22m[39m should return true for correct password [33m 475[2mms[22m[39m
         [33m[2mâœ“[22m[39m should return false for incorrect password [33m 459[2mms[22m[39m
         [33m[2mâœ“[22m[39m should be case-sensitive [33m 484[2mms[22m[39m
         [33m[2mâœ“[22m[39m should handle empty password comparison [33m 478[2mms[22m[39m
         [33m[2mâœ“[22m[39m should throw error for expired token [33m 1104[2mms[22m[39m
         [33m[2mâœ“[22m[39m should handle password with special characters [33m 520[2mms[22m[39m
         [33m[2mâœ“[22m[39m should handle password with newlines and tabs [33m 556[2mms[22m[39m
         [33m[2mâœ“[22m[39m should reject password with null bytes (if validation exists) [33m 514[2mms[22m[39m
         [33m[2mâœ“[22m[39m should support complete password reset workflow [33m 548[2mms[22m[39m
         [33m[2mâœ“[22m[39m should compare password in reasonable time (< 500ms) [33m 589[2mms[22m[39m
{"level":30,"time":1768335819835,"env":"test","workflowId":"6e41b111-eebd-4cbf-afa3-cdde350252c7","userId":"97bf4ae4-0e39-455f-b964-644b02ef5464","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":40,"time":1768335819848,"env":"test","runId":"1b0526f0-8165-4e17-b02b-f742be8f9f38","service":"DocumentGenerationService","allSections":[{"id":"879d4e24-b09d-41da-a409-6cf38438bae8","config":{}}],"runId":"1b0526f0-8165-4e17-b02b-f742be8f9f38","msg":"No Final Documents sections found, skipping generation. This might cause the frontend to hang."}
{"level":30,"time":1768335819848,"env":"test","runId":"1b0526f0-8165-4e17-b02b-f742be8f9f38","msg":"Documents generated successfully"}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w39
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w39 (Reused: true)

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts[2m > [22m[2mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22m[2mshould reject unsafe DataVault operations
[22m[39mDEBUG: Instantiating GoogleGenerativeAI
DEBUG: Getting model
DEBUG: Building system prompt
DEBUG: Building workflow context
DEBUG: Workflow context built
DEBUG: About to build full prompt. Parts: { s: [32m'string'[39m, w: [32m'string'[39m, u: [32m'string'[39m }
DEBUG: Full prompt built. Length: [33m4090[39m

{"level":50,"time":1768335819947,"env":"test","module":"ai-workflow-edit-routes","errors":["Validation failed for datavault.dropTable: Invalid operation schema: Invalid discriminator value. Expected 'workflow.setMetadata' | 'section.create' | 'section.update' | 'section.delete' | 'section.reorder' | 'step.create' | 'step.update' | 'step.delete' | 'step.move' | 'step.setVisibleIf' | 'step.setRequired' | 'logicRule.create' | 'logicRule.update' | 'logicRule.delete' | 'document.add' | 'document.update' | 'document.setConditional' | 'document.bindFields' | 'datavault.createTable' | 'datavault.addColumns' | 'datavault.createWritebackMapping'"],"workflowId":"6e41b111-eebd-4cbf-afa3-cdde350252c7","msg":"Failed to apply some AI operations"}
{"level":50,"time":1768335820079,"env":"test","error":{},"msg":"Error updating DataVault table"}
{"level":30,"time":1768335820104,"env":"test","workflowId":"7871e820-32cf-43bf-a4f6-f1a225d4c9f4","userId":"97bf4ae4-0e39-455f-b964-644b02ef5464","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":30,"time":1768335820139,"env":"test","msg":"Simulating External Send","destination":"Test Webhook","payload":{"message":"Hello Preview"}}
{"level":50,"time":1768335820139,"env":"test","error":{"length":137,"name":"error","severity":"ERROR","code":"22P02","where":"unnamed portal parameter $2 = '...'","file":"uuid.c","line":"138","routine":"string_to_uuid"},"input":{"runId":"1b0526f0-8165-4e17-b02b-f742be8f9f38","workflowId":"57d81f60-02f7-4f41-ac20-4fb826ca70fd","versionId":"draft","type":"workflow.complete","timestamp":"2026-01-13T20:23:40.088Z","isPreview":false,"payload":{"durationMs":1248,"stepCount":2}},"msg":"Failed to record analytics event"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts[2m > [22m[2mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22m[2mshould handle multi-operation edits with tempId resolution
[22m[39mDEBUG: Instantiating GoogleGenerativeAI
DEBUG: Getting model
DEBUG: Building system prompt
DEBUG: Building workflow context
DEBUG: Workflow context built
DEBUG: About to build full prompt. Parts: { s: [32m'string'[39m, w: [32m'string'[39m, u: [32m'string'[39m }
DEBUG: Full prompt built. Length: [33m4168[39m

[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mTenant-Level MFA Enforcement[2m > [22m[2mshould enforce MFA for tenant users when required by tenant
[22m[39mError deleting test user dd461f9b9dd465d416f3732db7fac05b: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/mfa.flow.real.test.ts:684:7
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

{"level":30,"time":1768335820315,"env":"test","module":"auth-routes","userId":"c1202cb4-4d66-4122-a780-ba84138d75e5","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/analytics_service.test.ts[2m > [22m[2mAnalytics Service Integration
[22m[39mMANUAL PATCH: Applied FK fix for workflow_run_events AND workflow_run_metrics

{"level":30,"time":1768335820359,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335820360,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335820366,"env":"test","module":"audit-log-service","userId":"c1202cb4-4d66-4122-a780-ba84138d75e5","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768335820682,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768335820749,"env":"test","workflowId":"7871e820-32cf-43bf-a4f6-f1a225d4c9f4","userId":"97bf4ae4-0e39-455f-b964-644b02ef5464","sectionsCount":1,"stepsCount":2,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
 [32mâœ“[39m tests/integration/datavault.permissions.test.ts [2m([22m[2m22 tests[22m[2m)[22m[33m 10671[2mms[22m[39m
       [33m[2mâœ“[22m[39m should allow owner to update existing permission (upsert) [33m 319[2mms[22m[39m
       [33m[2mâœ“[22m[39m should allow owner to revoke permissions [33m 302[2mms[22m[39m
       [33m[2mâœ“[22m[39m should enforce read is read-only [33m 305[2mms[22m[39m
{"level":30,"time":1768335820831,"env":"test","module":"user-credentials-repository","userId":"28e2dc5a-ae54-4007-9367-3e6327ff1bf8","msg":"User credentials created"}
{"level":30,"time":1768335820931,"env":"test","module":"email-queue","jobId":"ccc12121-9bd7-4979-9bb4-ef8ee90e6fce","to":"user2-RixESPAPyMIeEtKO-zUiM@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335820959,"env":"test","module":"version-service","workflowId":"7871e820-32cf-43bf-a4f6-f1a225d4c9f4","versionId":"10c953d1-3035-46d0-8064-67b3d1f37434","userId":"97bf4ae4-0e39-455f-b964-644b02ef5464","versionNumber":1,"msg":"Created draft version"}
{"level":30,"time":1768335820982,"env":"test","module":"auth-routes","userId":"28e2dc5a-ae54-4007-9367-3e6327ff1bf8","email":"user2-RixESPAPyMIeEtKO-zUiM@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mMixed Auth Scenarios[2m > [22m[2mshould prioritize Bearer token over cookie when both present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768335821058,"env":"test","module":"ai-workflow-edit-routes","workflowId":"7871e820-32cf-43bf-a4f6-f1a225d4c9f4","versionId":"10c953d1-3035-46d0-8064-67b3d1f37434","opsCount":4,"msg":"AI edit completed"}
{"level":30,"time":1768335821063,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335821064,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/ownershipAccess.test.ts [2m([22m[2m19 tests[22m[2m)[22m[33m 5184[2mms[22m[39m
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335821149,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mTenant-Level MFA Enforcement[2m > [22m[2mshould enforce MFA for tenant users when required by tenant
[22m[39mError deleting test user dd461f9b9dd465d416f3732db7fac05b: error: relation "surveys" does not exist
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at deleteTestUser (C:/Users/scoot/poll/VaultLogic/tests/helpers/testUtils.ts:73:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/mfa.flow.real.test.ts:46:9 {
  length: [33m106[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42P01'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'13'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'parse_relation.c'[39m,
  line: [32m'1449'[39m,
  routine: [32m'parserOpenTable'[39m
}

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335821177,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768335821178,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335821243,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":50,"time":1768335821273,"env":"test","error":{"length":137,"name":"error","severity":"ERROR","code":"22P02","where":"unnamed portal parameter $2 = '...'","file":"uuid.c","line":"138","routine":"string_to_uuid"},"input":{"runId":"d5f0c51a-8f1c-4a61-8fc3-15ce72775763","workflowId":"e8f1d15e-1de6-462c-b89c-50d451efa91f","versionId":"draft","type":"block.start","blockId":"18b4f8af-4936-462b-8b81-793a0f666688","pageId":"dce3e3d0-ae4c-44fe-8698-29905fb75b7a","timestamp":"2026-01-13T20:23:41.222Z","isPreview":false,"payload":{"blockType":"external_send"}},"msg":"Failed to record analytics event"}
{"level":30,"time":1768335821326,"env":"test","workflowId":"a443beae-89ff-48a5-a9f4-8a5362397560","userId":"97bf4ae4-0e39-455f-b964-644b02ef5464","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
 [32mâœ“[39m tests/integration/mfa.flow.real.test.ts [2m([22m[2m20 tests[22m[2m)[22m[33m 53206[2mms[22m[39m
       [33m[2mâœ“[22m[39m should complete full MFA setup flow [33m 2568[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject invalid TOTP code during setup [33m 2481[2mms[22m[39m
       [33m[2mâœ“[22m[39m should not allow MFA setup if already enabled [33m 2145[2mms[22m[39m
       [33m[2mâœ“[22m[39m should generate unique backup codes [33m 2310[2mms[22m[39m
       [33m[2mâœ“[22m[39m should store hashed backup codes [33m 2490[2mms[22m[39m
       [33m[2mâœ“[22m[39m should require MFA for enabled users [33m 2156[2mms[22m[39m
       [33m[2mâœ“[22m[39m should complete MFA login with valid TOTP [33m 2313[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject invalid TOTP during login [33m 2238[2mms[22m[39m
       [33m[2mâœ“[22m[39m should accept TOTP codes within 60-second window [33m 2884[2mms[22m[39m
       [33m[2mâœ“[22m[39m should login with valid backup code [33m 3392[2mms[22m[39m
       [33m[2mâœ“[22m[39m should mark backup code as used [33m 1660[2mms[22m[39m
       [33m[2mâœ“[22m[39m should prevent backup code reuse [33m 4555[2mms[22m[39m
       [33m[2mâœ“[22m[39m should try TOTP before backup code [33m 2437[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return MFA status for user [33m 2008[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return backup codes count for MFA users [33m 2646[2mms[22m[39m
       [33m[2mâœ“[22m[39m should disable MFA with password verification [33m 3459[2mms[22m[39m
       [33m[2mâœ“[22m[39m should require correct password to disable MFA [33m 2721[2mms[22m[39m
       [33m[2mâœ“[22m[39m should regenerate backup codes [33m 2862[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return error if MFA not enabled [33m 1961[2mms[22m[39m
       [33m[2mâœ“[22m[39m should enforce MFA for tenant users when required by tenant [33m 2883[2mms[22m[39m
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts[2m > [22m[2mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22m[2mshould create BEFORE and AFTER snapshots
[22m[39mDEBUG: Instantiating GoogleGenerativeAI
DEBUG: Getting model
DEBUG: Building system prompt
DEBUG: Building workflow context
DEBUG: Workflow context built
DEBUG: About to build full prompt. Parts: { s: [32m'string'[39m, w: [32m'string'[39m, u: [32m'string'[39m }
DEBUG: Full prompt built. Length: [33m4093[39m

{"level":30,"time":1768335821432,"env":"test","msg":"External Send Completed","destination":"Test Webhook","success":true,"status":200}
{"level":50,"time":1768335821483,"env":"test","error":{"length":137,"name":"error","severity":"ERROR","code":"22P02","where":"unnamed portal parameter $2 = '...'","file":"uuid.c","line":"138","routine":"string_to_uuid"},"input":{"runId":"d5f0c51a-8f1c-4a61-8fc3-15ce72775763","workflowId":"e8f1d15e-1de6-462c-b89c-50d451efa91f","versionId":"draft","type":"block.complete","blockId":"18b4f8af-4936-462b-8b81-793a0f666688","pageId":"dce3e3d0-ae4c-44fe-8698-29905fb75b7a","timestamp":"2026-01-13T20:23:41.432Z","isPreview":false,"payload":{"blockType":"external_send"}},"msg":"Failed to record analytics event"}
{"level":30,"time":1768335821568,"env":"test","module":"auth-routes","userId":"28e2dc5a-ae54-4007-9367-3e6327ff1bf8","msg":"User logged in successfully"}
{"level":30,"time":1768335821617,"env":"test","module":"audit-log-service","userId":"28e2dc5a-ae54-4007-9367-3e6327ff1bf8","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

{"level":30,"time":1768335821775,"env":"test","workflowId":"a443beae-89ff-48a5-a9f4-8a5362397560","userId":"97bf4ae4-0e39-455f-b964-644b02ef5464","sectionsCount":1,"stepsCount":1,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":30,"time":1768335821850,"env":"test","module":"writeback-execution-service","runId":"19ef58fe-59f0-4f11-acea-09d63eecbb30","workflowId":"6fccb65d-0df1-4c10-86b0-d303fdc6c041","msg":"Executing writeback mappings for completed run"}
{"level":30,"time":1768335821873,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335821873,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335821901,"env":"test","runId":"19ef58fe-59f0-4f11-acea-09d63eecbb30","service":"DocumentGenerationService","msg":"Starting document generation for run"}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w41
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":30,"time":1768335821961,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335821961,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w41 (Reused: true)

{"level":30,"time":1768335821963,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335821967,"env":"test","module":"version-service","workflowId":"a443beae-89ff-48a5-a9f4-8a5362397560","versionId":"0f74646c-37da-4996-b393-6fd5363e3146","userId":"97bf4ae4-0e39-455f-b964-644b02ef5464","versionNumber":1,"msg":"Created draft version"}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

{"level":40,"time":1768335821996,"env":"test","runId":"19ef58fe-59f0-4f11-acea-09d63eecbb30","service":"DocumentGenerationService","allSections":[],"runId":"19ef58fe-59f0-4f11-acea-09d63eecbb30","msg":"No Final Documents sections found, skipping generation. This might cause the frontend to hang."}
{"level":30,"time":1768335821996,"env":"test","runId":"19ef58fe-59f0-4f11-acea-09d63eecbb30","msg":"Documents generated successfully"}
 [32mâœ“[39m tests/integration/workflows/runtime-pipelines.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 6788[2mms[22m[39m
       [33m[2mâœ“[22m[39m should create DataVault row on workflow completion [33m 918[2mms[22m[39m
       [33m[2mâœ“[22m[39m should execute writebacks via RunService.completeRun() [33m 2476[2mms[22m[39m
{"level":30,"time":1768335822009,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

 [32mâœ“[39m tests/integration/externalSends.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 4921[2mms[22m[39m
     [33m[2mâœ“[22m[39m PREVIEW MODE: Should simulate send and NOT call fetch [33m 1561[2mms[22m[39m
     [33m[2mâœ“[22m[39m LIVE MODE: Should call fetch with mapped payload [33m 1343[2mms[22m[39m
{"level":30,"time":1768335822067,"env":"test","module":"ai-workflow-edit-routes","workflowId":"a443beae-89ff-48a5-a9f4-8a5362397560","versionId":"0f74646c-37da-4996-b393-6fd5363e3146","opsCount":2,"msg":"AI edit completed"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

{"level":30,"time":1768335822171,"env":"test","module":"user-credentials-repository","userId":"a5d7e65f-603d-4b5c-af01-0f8d07b093cc","msg":"User credentials created"}
{"level":30,"time":1768335822288,"env":"test","module":"email-queue","jobId":"b68473fc-88fc-4fc3-968f-a1d3be0ecf30","to":"protected-test-GCFkeFyYLnKKTRCdbHG3E@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335822341,"env":"test","module":"auth-routes","userId":"a5d7e65f-603d-4b5c-af01-0f8d07b093cc","email":"protected-test-GCFkeFyYLnKKTRCdbHG3E@example.com","msg":"User registered"}
{"level":30,"time":1768335822442,"env":"test","workflowId":"c2e3c8f6-2ecc-4934-a834-6745f40e8b22","userId":"97bf4ae4-0e39-455f-b964-644b02ef5464","sectionsCount":1,"stepsCount":1,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mOptional Auth Routes[2m > [22m[2mshould allow unauthenticated access to optional auth routes
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts[2m > [22m[2mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22m[2mshould rollback on validation failure
[22m[39mDEBUG: Instantiating GoogleGenerativeAI
DEBUG: Getting model
DEBUG: Building system prompt
DEBUG: Building workflow context
DEBUG: Workflow context built
DEBUG: About to build full prompt. Parts: { s: [32m'string'[39m, w: [32m'string'[39m, u: [32m'string'[39m }
DEBUG: Full prompt built. Length: [33m4182[39m

{"level":50,"time":1768335822596,"env":"test","module":"ai-workflow-edit-routes","errors":["Validation failed for step.create: Step alias 'email' already exists"],"workflowId":"c2e3c8f6-2ecc-4934-a834-6745f40e8b22","msg":"Failed to apply some AI operations"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w33
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w33 (Reused: true)

{"level":30,"time":1768335822713,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335822763,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335823049,"env":"test","module":"auth-routes","userId":"a5d7e65f-603d-4b5c-af01-0f8d07b093cc","msg":"User logged in successfully"}
{"level":30,"time":1768335823065,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335823066,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335823097,"env":"test","module":"audit-log-service","userId":"a5d7e65f-603d-4b5c-af01-0f8d07b093cc","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

 [32mâœ“[39m tests/integration/ai/workflowEdit.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 8547[2mms[22m[39m
     [33m[2mâœ“[22m[39m should create draft version on successful AI edit [33m 1355[2mms[22m[39m
     [33m[2mâœ“[22m[39m should enforce draft mode (revert active workflow to draft) [33m 1035[2mms[22m[39m
     [33m[2mâœ“[22m[39m should not create version when no changes detected (checksum match) [33m 1545[2mms[22m[39m
     [33m[2mâœ“[22m[39m should handle multi-operation edits with tempId resolution [33m 1217[2mms[22m[39m
     [33m[2mâœ“[22m[39m should create BEFORE and AFTER snapshots [33m 954[2mms[22m[39m
     [33m[2mâœ“[22m[39m should rollback on validation failure [33m 578[2mms[22m[39m
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768335823299,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768335823328,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs
[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768335823309,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768335823310,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768335823317,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768335823327,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768335823327,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768335823327,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768335823327,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

{"level":30,"time":1768335823609,"env":"test","module":"intake-service","runId":"14c54b13-26f4-4820-825f-2b3c710a8d75","slug":"public-A9gAsRtWvzXoFJsMBVyq_","msg":"Created intake run"}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335823657,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768335823658,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

 [32mâœ“[39m tests/integration/analytics_service.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 4769[2mms[22m[39m
     [33m[2mâœ“[22m[39m should generate events and metrics on run completion [33m 2941[2mms[22m[39m
[90mstdout[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests
[22m[39m[Shim] Request to /api/auth/google, Session User ID: undefined

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w36
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w36 (Reused: true)

{"level":30,"time":1768335824088,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768335824103,"env":"test","module":"user-credentials-repository","userId":"0197eeea-380e-4b63-be0f-c7bdc88c2f18","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w44
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":30,"time":1768335824175,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w44 (Reused: true)

{"level":30,"time":1768335824191,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335824202,"env":"test","module":"email-queue","jobId":"72e534b7-a7b9-49c2-a22a-c83ceb9c43f1","to":"protected-test-4C_QAMz8oVmZvHwFe4qU4@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests[2m > [22m[2mGET /api/runs[2m > [22m[2mshould list all runs with pagination
[22m[39m[Shim] Request to /api/runs, Session User ID: test-user-runs-stage8

{"level":30,"time":1768335824254,"env":"test","module":"auth-routes","userId":"0197eeea-380e-4b63-be0f-c7bdc88c2f18","email":"protected-test-4C_QAMz8oVmZvHwFe4qU4@example.com","msg":"User registered"}
{"level":30,"time":1768335824265,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests[2m > [22m[2mGET /api/runs[2m > [22m[2mshould filter runs by status
[22m[39m[Shim] Request to /api/runs, Session User ID: test-user-runs-stage8

[90mstdout[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests[2m > [22m[2mGET /api/runs[2m > [22m[2mshould filter runs by workflow
[22m[39m[Shim] Request to /api/runs, Session User ID: test-user-runs-stage8

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mOptional Auth Routes[2m > [22m[2mshould enhance optional auth routes with user context when authenticated
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests[2m > [22m[2mGET /api/runs[2m > [22m[2mshould filter runs by project
[22m[39m[Shim] Request to /api/runs, Session User ID: test-user-runs-stage8

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests[2m > [22m[2mGET /api/runs[2m > [22m[2mshould filter runs by date range
[22m[39m[Shim] Request to /api/runs, Session User ID: test-user-runs-stage8

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w37
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests[2m > [22m[2mGET /api/runs[2m > [22m[2mshould search runs by query string
[22m[39m[Shim] Request to /api/runs, Session User ID: test-user-runs-stage8

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w37 (Reused: true)

{"level":30,"time":1768335824544,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests[2m > [22m[2mGET /api/runs/:id[2m > [22m[2mshould get run by ID with all details
[22m[39m[Shim] Request to /api/runs/37dd8679-5df9-4bfa-8ab9-eb02ef6c4caa, Session User ID: test-user-runs-stage8

{"level":30,"time":1768335824600,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w46
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":30,"time":1768335824708,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests[2m > [22m[2mGET /api/runs/:id[2m > [22m[2mshould return 404 for non-existent run
[22m[39m[Shim] Request to /api/runs/00000000-0000-0000-0000-000000000000, Session User ID: test-user-runs-stage8

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w46 (Reused: true)

{"level":30,"time":1768335824720,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335824730,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/intake.workflow.test.ts[2m > [22m[2mIntake Workflow Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs
[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768335824717,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768335824718,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768335824723,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768335824729,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768335824729,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768335824729,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768335824729,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768335824767,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests[2m > [22m[2mGET /api/runs/:id/logs[2m > [22m[2mshould get logs for a run
[22m[39m[Shim] Request to /api/runs/37dd8679-5df9-4bfa-8ab9-eb02ef6c4caa/logs, Session User ID: test-user-runs-stage8

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w42
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests[2m > [22m[2mPOST /api/runs/:id/rerun[2m > [22m[2mshould re-run workflow with same inputs
[22m[39m[Shim] Request to /api/runs/37dd8679-5df9-4bfa-8ab9-eb02ef6c4caa/rerun, Session User ID: test-user-runs-stage8

{"level":30,"time":1768335824937,"env":"test","module":"auth-routes","userId":"0197eeea-380e-4b63-be0f-c7bdc88c2f18","msg":"User logged in successfully"}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w42 (Reused: true)

{"level":30,"time":1768335824993,"env":"test","module":"audit-log-service","userId":"0197eeea-380e-4b63-be0f-c7bdc88c2f18","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstderr[2m | tests/ui/datavault/EditableCell.test.tsx[2m > [22m[2mEditableCell Component[2m > [22m[2mError Handling[2m > [22m[2mreverts value on save error
[22m[39mFailed to save cell: Error: Network error
    at C:/Users/scoot/poll/VaultLogic/tests/ui/datavault/EditableCell.test.tsx:204:36
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

[90mstderr[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests[2m > [22m[2mPOST /api/runs/:id/rerun[2m > [22m[2mshould re-run workflow with same inputs
[22m[39m[DEBUG Question] Node start executed. Key: start, Value: undefined. Context keys: 4

{"level":30,"time":1768335825155,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768335825183,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts[2m > [22m[2mRuns API - DOCX Generation Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs
[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768335825168,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768335825168,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768335825176,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768335825182,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768335825182,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768335825183,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768335825183,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests[2m > [22m[2mPOST /api/runs/:id/rerun[2m > [22m[2mshould re-run workflow with override inputs
[22m[39m[Shim] Request to /api/runs/37dd8679-5df9-4bfa-8ab9-eb02ef6c4caa/rerun, Session User ID: test-user-runs-stage8

{"level":30,"time":1768335825357,"env":"test","module":"user-credentials-repository","userId":"fb6716c1-c5df-4622-b52a-3d28b487f1d8","msg":"User credentials created"}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

{"level":30,"time":1768335825417,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1768335825464,"env":"test","module":"email-queue","jobId":"2b3e88ce-80c3-495d-b595-e559c4d8c428","to":"test-G3fDm8vjNgdYJgNWPNEp8@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstderr[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests[2m > [22m[2mPOST /api/runs/:id/rerun[2m > [22m[2mshould re-run workflow with override inputs
[22m[39m[DEBUG Question] Node start executed. Key: start, Value: undefined. Context keys: 4

[90mstderr[2m | tests/ui/datavault/EditableCell.test.tsx[2m > [22m[2mEditableCell Component[2m > [22m[2mError Handling[2m > [22m[2mdisplays error indicator on save failure
[22m[39mFailed to save cell: Error: Network error
    at C:/Users/scoot/poll/VaultLogic/tests/ui/datavault/EditableCell.test.tsx:220:36
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

{"level":30,"time":1768335825513,"env":"test","module":"intake-service","runId":"900645fe-265a-4b50-aede-42be7d05cda4","slug":"optional-I_JYhLboGP1HHjB3jOLR9","userId":"0197eeea-380e-4b63-be0f-c7bdc88c2f18","msg":"Created intake run"}
{"level":30,"time":1768335825519,"env":"test","module":"auth-routes","userId":"fb6716c1-c5df-4622-b52a-3d28b487f1d8","email":"test-G3fDm8vjNgdYJgNWPNEp8@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests[2m > [22m[2mPOST /api/runs/:id/rerun[2m > [22m[2mshould return 404 for non-existent run
[22m[39m[Shim] Request to /api/runs/00000000-0000-0000-0000-000000000000/rerun, Session User ID: test-user-runs-stage8

{"level":50,"time":1768335825666,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:165:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
{"level":50,"time":1768335825667,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:165:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google authentication failed"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests[2m > [22m[2mGET /api/runs/export.csv[2m > [22m[2mshould export runs to CSV
[22m[39m[Shim] Request to /api/runs/export.csv, Session User ID: test-user-runs-stage8

{"level":40,"time":1768335825723,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768335825723,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:89:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:155:23"},"msg":"Google token verification failed"}
{"level":50,"time":1768335825723,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:89:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:155:23"},"msg":"Google authentication failed"}
{"level":30,"time":1768335825826,"env":"test","module":"user-credentials-repository","userId":"6656e233-304f-4f92-9085-cd750741fcd2","msg":"User credentials created"}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w47
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335825883,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w47 (Reused: true)

{"level":40,"time":1768335825911,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":30,"time":1768335825934,"env":"test","module":"email-queue","jobId":"ad559145-d6ab-49c0-ab15-f862cd58158e","to":"test-docx-oMxw6V0WQhVNxAcNEoFbc@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335825950,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w40
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":30,"time":1768335825977,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335825978,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/ui/datavault/EditableCell.test.tsx[2m > [22m[2mEditableCell Component[2m > [22m[2mBoolean Type (Checkbox)[2m > [22m[2mshows loading spinner when saving checkbox
[22m[39mWarning: An update to EditableCell inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at EditableCell (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/EditableCell.tsx:12:25)

{"level":30,"time":1768335825992,"env":"test","module":"auth-routes","userId":"6656e233-304f-4f92-9085-cd750741fcd2","email":"test-docx-oMxw6V0WQhVNxAcNEoFbc@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w40 (Reused: true)

{"level":30,"time":1768335826018,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335826067,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335826068,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335826079,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w43
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":30,"time":1768335826138,"env":"test","module":"auth","email":"existing@example.com","msg":"OAuth2 login successful"}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w43 (Reused: true)

 [32mâœ“[39m tests/integration/collections.e2e.test.ts [2m([22m[2m22 tests[22m[2m)[22m[33m 4578[2mms[22m[39m
       [33m[2mâœ“[22m[39m should create multiple records [33m 401[2mms[22m[39m
[90mstdout[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests[2m > [22m[2mGET /api/runs/export.csv[2m > [22m[2mshould export runs with filters applied
[22m[39m[Shim] Request to /api/runs/export.csv, Session User ID: test-user-runs-stage8

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w45
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstderr[2m | tests/integration/api.runs.docx.test.ts[2m > [22m[2mRuns API - DOCX Generation Integration Tests
[22m[39mDeprecated method ".compile", view upgrade guide : https://docxtemplater.com/docs/api/#upgrade-guide, stack : Error: 
    at deprecatedMethod (C:\Users\scoot\poll\VaultLogic\node_modules\docxtemplater\js\docxtemplater.js:184:167)
    at Docxtemplater.compile (C:\Users\scoot\poll\VaultLogic\node_modules\docxtemplater\js\docxtemplater.js:475:7)
    at TemplateScanner.validateBuffer (C:/Users/scoot/poll/VaultLogic/server/services/document/TemplateScanner.ts:190:13)
    at TemplateScanner.scanAndFix (C:/Users/scoot/poll/VaultLogic/server/services/document/TemplateScanner.ts:69:22)
    at C:/Users/scoot/poll/VaultLogic/server/api/templates.ts:328:52
    at processTicksAndRejections (node:internal/process/task_queues:103:5)

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w45 (Reused: true)

 [32mâœ“[39m tests/integration/auth/protected.routes.test.ts [2m([22m[2m33 tests[22m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 50792[2mms[22m[39m
       [33m[2mâœ“[22m[39m should allow access with valid Bearer token [33m 1398[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject access without Authorization header [33m 1345[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject access with empty Bearer token [33m 1307[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject access with malformed Authorization header [33m 1254[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject access with wrong token type [33m 1353[2mms[22m[39m
       [33m[2mâœ“[22m[39m should allow POST with valid Bearer token [33m 1396[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject POST without Bearer token [33m 1213[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject POST with invalid token [33m 1229[2mms[22m[39m
       [33m[2mâœ“[22m[39m should allow PUT with valid Bearer token [33m 1383[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject PUT without Bearer token [33m 1267[2mms[22m[39m
       [33m[2mâœ“[22m[39m should allow DELETE with valid Bearer token [33m 1407[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject DELETE without Bearer token [33m 1546[2mms[22m[39m
       [33m[2mâœ“[22m[39m should allow PATCH with valid Bearer token [33m 2084[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject PATCH without Bearer token [33m 1247[2mms[22m[39m
       [33m[2mâœ“[22m[39m should handle Bearer token with extra spaces [33m 1215[2mms[22m[39m
       [33m[2mâœ“[22m[39m should handle very long invalid token [33m 1270[2mms[22m[39m
       [33m[2mâœ“[22m[39m should handle empty Authorization header [33m 1210[2mms[22m[39m
       [33m[2mâœ“[22m[39m should handle Authorization header with only Bearer [33m 1328[2mms[22m[39m
       [33m[2mâœ“[22m[39m should handle multiple Authorization headers [33m 1316[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject token with SQL injection attempt [33m 1333[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject token with XSS attempt [33m 1310[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject token with missing userId [33m 1280[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject token with non-existent userId [33m 1346[2mms[22m[39m
       [33m[2mâœ“[22m[39m should not allow user to access another user's resources [33m 2505[2mms[22m[39m
       [33m[2mâœ“[22m[39m should inject userId into request context [33m 1346[2mms[22m[39m
       [33m[2mâœ“[22m[39m should inject tenantId into request context [33m 1282[2mms[22m[39m
       [33m[2mâœ“[22m[39m should inject role into request context [33m 1310[2mms[22m[39m
       [33m[2mâœ“[22m[39m should not apply general rate limiting to authenticated requests [33m 1813[2mms[22m[39m
       [33m[2mâœ“[22m[39m should handle request with both Bearer token and cookies [33m 1978[2mms[22m[39m
       [33m[2mâœ“[22m[39m should prioritize Bearer token over cookie when both present [33m 3337[2mms[22m[39m
       [33m[2mâœ“[22m[39m should allow unauthenticated access to optional auth routes [33m 1929[2mms[22m[39m
       [33m[2mâœ“[22m[39m should enhance optional auth routes with user context when authenticated [33m 1956[2mms[22m[39m
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w48
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w48 (Reused: true)

{"level":30,"time":1768335826516,"env":"test","msg":"DB: initializing... Local"}
{"level":40,"time":1768335826525,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests[2m > [22m[2mGET /api/runs/compare[2m > [22m[2mshould compare two runs
[22m[39m[Shim] Request to /api/runs/compare, Session User ID: test-user-runs-stage8

{"level":30,"time":1768335826575,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335826583,"env":"test","module":"auth","email":"refresh@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1768335826602,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335826603,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335826660,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768335826700,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.projects.test.ts[2m > [22m[2mProjects API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs
[Routes] E-Signature routes registered at /api/esign

 [32mâœ“[39m tests/ui/datavault/EditableCell.test.tsx [2m([22m[2m29 tests[22m[2m)[22m[33m 7232[2mms[22m[39m
       [33m[2mâœ“[22m[39m shows double-click hint on hover [33m 478[2mms[22m[39m
       [33m[2mâœ“[22m[39m saves on blur [33m 771[2mms[22m[39m
       [33m[2mâœ“[22m[39m cancels edit on Escape key press [33m 310[2mms[22m[39m
       [33m[2mâœ“[22m[39m reverts value on save error [33m 466[2mms[22m[39m
       [33m[2mâœ“[22m[39m displays error indicator on save failure [33m 442[2mms[22m[39m
{"level":30,"time":1768335826671,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768335826684,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768335826691,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768335826699,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768335826700,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768335826700,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768335826700,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768335826959,"env":"test","workflowId":"1c97e136-cf8c-40eb-bcf0-848a61bdf8b7","userId":"fb6716c1-c5df-4622-b52a-3d28b487f1d8","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests[2m > [22m[2mGET /api/runs/compare[2m > [22m[2mshould identify changed input keys
[22m[39m[Shim] Request to /api/runs/compare, Session User ID: test-user-runs-stage8

{"level":30,"time":1768335826993,"env":"test","module":"auth","email":"idtoken@example.com","msg":"OAuth2 login successful"}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335827039,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests[2m > [22m[2mGET /api/runs/compare[2m > [22m[2mshould return 404 if run A not found
[22m[39m[Shim] Request to /api/runs/compare, Session User ID: test-user-runs-stage8

{"level":30,"time":1768335827105,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests[2m > [22m[2mGET /api/runs/compare[2m > [22m[2mshould return 404 if run B not found
[22m[39m[Shim] Request to /api/runs/compare, Session User ID: test-user-runs-stage8

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335827179,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335827232,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335827312,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335827330,"env":"test","module":"user-credentials-repository","userId":"f25096fd-6f13-4623-bee1-cc91ba822f42","msg":"User credentials created"}
{"level":30,"time":1768335827378,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstderr[2m | tests/integration/api.runs.docx.test.ts[2m > [22m[2mRuns API - DOCX Generation Integration Tests[2m > [22m[2mPOST /api/workflows/:id/run - Template Node Execution[2m > [22m[2mshould execute workflow with template node and generate DOCX
[22m[39mDeprecated method ".setData", view upgrade guide : https://docxtemplater.com/docs/api/#upgrade-guide, stack : Error: 
    at deprecatedMethod (C:\Users\scoot\poll\VaultLogic\node_modules\docxtemplater\js\docxtemplater.js:184:167)
    at Docxtemplater.setData (C:\Users\scoot\poll\VaultLogic\node_modules\docxtemplater\js\docxtemplater.js:694:7)
    at renderDocx2 (C:/Users/scoot/poll/VaultLogic/server/services/docxRenderer2.ts:150:9)
    at executeTemplateNode (C:/Users/scoot/poll/VaultLogic/server/engine/nodes/template.ts:199:28)
    at executeNode (C:/Users/scoot/poll/VaultLogic/server/engine/registry.ts:163:14)
    at runGraph (C:/Users/scoot/poll/VaultLogic/server/engine/index.ts:275:30)
    at C:/Users/scoot/poll/VaultLogic/server/api/runs.ts:112:24

{"level":30,"time":1768335827425,"env":"test","module":"auth","email":"minimal@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1768335827429,"env":"test","module":"email-queue","jobId":"36740e72-d06e-4f5c-8058-75f95fb3020d","to":"test-projects-6v7aGcrMPRsdRkTG7F0yY@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768335827490,"env":"test","module":"auth-routes","userId":"f25096fd-6f13-4623-bee1-cc91ba822f42","email":"test-projects-6v7aGcrMPRsdRkTG7F0yY@example.com","msg":"User registered"}
{"level":50,"time":1768335827529,"env":"test","module":"auth","err":{"type":"Error","message":"Token verification failed","stack":"Error: Token verification failed\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:425:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests[2m > [22m[2mRBAC and Tenant Isolation[2m > [22m[2mshould enforce tenant isolation on runs list
[22m[39m[Shim] Request to /api/runs, Session User ID: test-user-runs-stage8

{"level":40,"time":1768335827590,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768335827590,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:89:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
{"level":30,"time":1768335827634,"env":"test","connectionId":"02928833-aefe-48f5-ac47-ea134d364e10","projectId":"86199c91-3bfb-4608-8aad-6c3e6c49098e","name":"Test OAuth2 Connection","type":"oauth2_3leg","msg":"Connection created:"}
{"level":50,"time":1768335827645,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token payload","stack":"Error: Invalid token payload\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:85:25)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
{"level":50,"time":1768335827690,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould validate expression after debounce
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

{"level":30,"time":1768335827712,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335827713,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests
[22m[39mCleanup error (non-fatal): error: syntax error at or near "="
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/api.runs.graph.test.ts:252:9 {
  length: [33m90[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'42601'[39m,
  detail: [90mundefined[39m,
  hint: [90mundefined[39m,
  position: [32m'32'[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [90mundefined[39m,
  table: [90mundefined[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [90mundefined[39m,
  file: [32m'scan.l'[39m,
  line: [32m'1244'[39m,
  routine: [32m'scanner_yyerror'[39m
}

{"level":30,"time":1768335827783,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335827783,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/auth/oauth2.google.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 4087[2mms[22m[39m
       [33m[2mâœ“[22m[39m should successfully authenticate with valid Google ID token [33m 606[2mms[22m[39m
       [33m[2mâœ“[22m[39m should update existing user on subsequent logins [33m 463[2mms[22m[39m
       [33m[2mâœ“[22m[39m should create refresh token record in database [33m 447[2mms[22m[39m
       [33m[2mâœ“[22m[39m should support both "token" and "idToken" fields [33m 359[2mms[22m[39m
       [33m[2mâœ“[22m[39m should handle missing profile information gracefully [33m 384[2mms[22m[39m
{"level":30,"time":1768335827911,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstderr[2m | tests/integration/api.runs.docx.test.ts[2m > [22m[2mRuns API - DOCX Generation Integration Tests[2m > [22m[2mPOST /api/workflows/:id/run - Template Node Execution[2m > [22m[2mshould handle missing template data gracefully
[22m[39mDeprecated method ".setData", view upgrade guide : https://docxtemplater.com/docs/api/#upgrade-guide, stack : Error: 
    at deprecatedMethod (C:\Users\scoot\poll\VaultLogic\node_modules\docxtemplater\js\docxtemplater.js:184:167)
    at Docxtemplater.setData (C:\Users\scoot\poll\VaultLogic\node_modules\docxtemplater\js\docxtemplater.js:694:7)
    at renderDocx2 (C:/Users/scoot/poll/VaultLogic/server/services/docxRenderer2.ts:150:9)
    at executeTemplateNode (C:/Users/scoot/poll/VaultLogic/server/engine/nodes/template.ts:199:28)
    at executeNode (C:/Users/scoot/poll/VaultLogic/server/engine/registry.ts:163:14)
    at runGraph (C:/Users/scoot/poll/VaultLogic/server/engine/index.ts:275:30)
    at C:/Users/scoot/poll/VaultLogic/server/api/runs.ts:112:24

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould return validation errors for invalid expression
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

{"level":30,"time":1768335828023,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335828024,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/variableSafety.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 3799[2mms[22m[39m
     [33m[2mâœ“[22m[39m REPRO: ScriptEngine fails to resolve alias 'input_variable' when aliasMap is NOT provided [33m 641[2mms[22m[39m
     [33m[2mâœ“[22m[39m ScriptEngine resolves alias 'input_variable' when aliasMap is provided [33m 615[2mms[22m[39m
     [33m[2mâœ“[22m[39m REPRO: BlockRunner fails to resolve alias in CreateRecordConfig [33m 591[2mms[22m[39m
     [33m[2mâœ“[22m[39m BlockRunner logic resolves alias with aliasMap [33m 598[2mms[22m[39m
[90mstdout[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould return validation errors for invalid expression
[22m[39mValidation Result DEBUG: {"ok":false,"errors":[{"message":"Unknown identifier: unknown_var","start":{"line":0,"col":0},"end":{"line":0,"col":11}}]}
IsValid DEBUG: [33mfalse[39m

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould debounce validation calls
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

 [32mâœ“[39m tests/integration/api.runs.graph.test.ts [2m([22m[2m19 tests[22m[2m)[22m[33m 5534[2mms[22m[39m
       [33m[2mâœ“[22m[39m should re-run workflow with same inputs [33m 385[2mms[22m[39m
       [33m[2mâœ“[22m[39m should re-run workflow with override inputs [33m 317[2mms[22m[39m
       [33m[2mâœ“[22m[39m should export runs to CSV [33m 515[2mms[22m[39m
       [33m[2mâœ“[22m[39m should export runs with filters applied [33m 326[2mms[22m[39m
       [33m[2mâœ“[22m[39m should compare two runs [33m 443[2mms[22m[39m
       [33m[2mâœ“[22m[39m should enforce tenant isolation on runs list [33m 514[2mms[22m[39m
[90mstderr[2m | tests/integration/api.runs.docx.test.ts[2m > [22m[2mRuns API - DOCX Generation Integration Tests[2m > [22m[2mGET /api/runs/:id/download - Download Generated DOCX
[22m[39mDeprecated method ".setData", view upgrade guide : https://docxtemplater.com/docs/api/#upgrade-guide, stack : Error: 
    at deprecatedMethod (C:\Users\scoot\poll\VaultLogic\node_modules\docxtemplater\js\docxtemplater.js:184:167)
    at Docxtemplater.setData (C:\Users\scoot\poll\VaultLogic\node_modules\docxtemplater\js\docxtemplater.js:694:7)
    at renderDocx2 (C:/Users/scoot/poll/VaultLogic/server/services/docxRenderer2.ts:150:9)
    at executeTemplateNode (C:/Users/scoot/poll/VaultLogic/server/engine/nodes/template.ts:199:28)
    at executeNode (C:/Users/scoot/poll/VaultLogic/server/engine/registry.ts:163:14)
    at runGraph (C:/Users/scoot/poll/VaultLogic/server/engine/index.ts:275:30)
    at C:/Users/scoot/poll/VaultLogic/server/api/runs.ts:112:24

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould not validate when workflowId or nodeId is missing
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould not validate when workflowId or nodeId is missing
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression validation integration[2m > [22m[2mshould validate helper functions in expressions
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335828689,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335828690,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression validation integration[2m > [22m[2mshould validate complex expressions with multiple helpers
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768335828778,"env":"test","connectionId":"734d3eb8-0b9a-4f8b-897f-5c3d9210ef80","projectId":"86199c91-3bfb-4608-8aad-6c3e6c49098e","name":"Status Test Connection","type":"oauth2_3leg","msg":"Connection created:"}
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression validation integration[2m > [22m[2mshould handle syntax errors
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w52
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w52 (Reused: true)

{"level":30,"time":1768335829055,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/integration/api.runs.docx.test.ts[2m > [22m[2mRuns API - DOCX Generation Integration Tests
[22m[39mCleanup error (non-fatal): error: update or delete on table "users" violates foreign key constraint "runs_created_by_users_id_fk" on table "runs"
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/api.runs.docx.test.ts:195:9 {
  length: [33m311[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'23503'[39m,
  detail: [32m'Key (id)=(6656e233-304f-4f92-9085-cd750741fcd2) is still referenced from table "runs".'[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [32m'public'[39m,
  table: [32m'runs'[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [32m'runs_created_by_users_id_fk'[39m,
  file: [32m'ri_triggers.c'[39m,
  line: [32m'2612'[39m,
  routine: [32m'ri_ReportViolation'[39m
}

{"level":30,"time":1768335829070,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768335829070,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/intake.workflow.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 5058[2mms[22m[39m
     [33m[2mâœ“[22m[39m should allow designating a workflow as Intake [33m 1214[2mms[22m[39m
     [33m[2mâœ“[22m[39m should allow linking a downstream workflow to an intake workflow [33m 1398[2mms[22m[39m
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression Editor component behavior[2m > [22m[2mshould update validation when expression changes
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

{"level":30,"time":1768335829101,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression Editor component behavior[2m > [22m[2mshould update validation when expression changes
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

{"level":30,"time":1768335829467,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335829468,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335829568,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335829569,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/auth/oauth2.callback.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 3424[2mms[22m[39m
       [33m[2mâœ“[22m[39m should initiate OAuth2 3-legged flow and generate authorization URL [33m 410[2mms[22m[39m
       [33m[2mâœ“[22m[39m should track OAuth2 connection status [33m 371[2mms[22m[39m
 [32mâœ“[39m tests/integration/api.runs.docx.test.ts [2m([22m[2m6 tests[22m[2m)[22m[33m 4995[2mms[22m[39m
       [33m[2mâœ“[22m[39m should execute workflow with template node and generate DOCX [33m 581[2mms[22m[39m
       [33m[2mâœ“[22m[39m should handle missing template data gracefully [33m 355[2mms[22m[39m
 [31mâ¯[39m tests/ui/expression-editor.test.tsx [2m([22m[2m10 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 4239[2mms[22m[39m
       [32mâœ“[39m should initialize with null validation result[32m 33[2mms[22m[39m
[31m       [31mÃ—[31m should validate expression after debounce[39m[32m 287[2mms[22m[39m
       [32mâœ“[39m should return validation errors for invalid expression[32m 152[2mms[22m[39m
       [32mâœ“[39m should debounce validation calls[32m 217[2mms[22m[39m
       [32mâœ“[39m should not validate when workflowId or nodeId is missing[32m 159[2mms[22m[39m
       [32mâœ“[39m should validate helper functions in expressions[32m 202[2mms[22m[39m
       [32mâœ“[39m should validate complex expressions with multiple helpers[32m 130[2mms[22m[39m
       [32mâœ“[39m should handle syntax errors[32m 270[2mms[22m[39m
       [32mâœ“[39m should handle empty expressions[32m 3[2mms[22m[39m
       [33m[2mâœ“[22m[39m should update validation when expression changes [33m 478[2mms[22m[39m
{"level":30,"time":1768335829747,"env":"test","module":"user-credentials-repository","userId":"4fe9cd11-e7b5-4339-8603-a8c4c3e02621","msg":"User credentials created"}
{"level":30,"time":1768335829848,"env":"test","module":"email-queue","jobId":"57683bdf-b186-4b42-8149-6172cbc51e93","to":"other-SW0auhl-t4_635E3tMBmL@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335829896,"env":"test","module":"auth-routes","userId":"4fe9cd11-e7b5-4339-8603-a8c4c3e02621","email":"other-SW0auhl-t4_635E3tMBmL@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335830287,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335830289,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

 [32mâœ“[39m tests/integration/api.projects.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 4754[2mms[22m[39m
       [33m[2mâœ“[22m[39m should soft-delete project [33m 321[2mms[22m[39m
       [33m[2mâœ“[22m[39m should not allow cross-tenant access [33m 887[2mms[22m[39m
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w55
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w55 (Reused: true)

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w50
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":30,"time":1768335830922,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335830969,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w50 (Reused: true)

{"level":30,"time":1768335831029,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335831030,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335831040,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335831041,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/collab.client.test.tsx [2m([22m[2m17 tests[22m[2m)[22m[33m 5234[2mms[22m[39m
     [33m[2mâœ“[22m[39m should add a comment [33m 1201[2mms[22m[39m
     [33m[2mâœ“[22m[39m should allow comment owner to delete their comment [33m 514[2mms[22m[39m
 [32mâœ“[39m tests/ui/runs.components.test.tsx [2m([22m[2m19 tests[22m[2m)[22m[33m 6598[2mms[22m[39m
       [33m[2mâœ“[22m[39m should show download options for successful runs [33m 1628[2mms[22m[39m
       [33m[2mâœ“[22m[39m should call onChange when status filter changes [33m 1165[2mms[22m[39m
       [33m[2mâœ“[22m[39m should call onChange when search is submitted [33m 314[2mms[22m[39m
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w58
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w58 (Reused: true)

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w51
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w51 (Reused: true)

{"level":40,"time":1768335831519,"env":"test","msg":"Failed to parse legacy string condition: \"trigger == \", defaulting to visible"}
{"level":40,"time":1768335831519,"env":"test","msg":"Failed to parse legacy string condition: \"trigger == \", defaulting to visible"}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstderr[2m | tests/integration/regression-REG-1.test.ts[2m > [22m[2mREG-1: Workflow Logic Regression
[22m[39mCleanup error: error: update or delete on table "users" violates foreign key constraint "workflow_versions_created_by_users_id_fk" on table "workflow_versions"
    at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/regression-REG-1.test.ts:79:13 {
  length: [33m376[39m,
  severity: [32m'ERROR'[39m,
  code: [32m'23503'[39m,
  detail: [32m'Key (id)=(38ae88de-0c17-401e-8c8b-496fcc971314) is still referenced from table "workflow_versions".'[39m,
  hint: [90mundefined[39m,
  position: [90mundefined[39m,
  internalPosition: [90mundefined[39m,
  internalQuery: [90mundefined[39m,
  where: [90mundefined[39m,
  schema: [32m'public'[39m,
  table: [32m'workflow_versions'[39m,
  column: [90mundefined[39m,
  dataType: [90mundefined[39m,
  constraint: [32m'workflow_versions_created_by_users_id_fk'[39m,
  file: [32m'ri_triggers.c'[39m,
  line: [32m'2612'[39m,
  routine: [32m'ri_ReportViolation'[39m
}

{"level":30,"time":1768335831586,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768335831586,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/integration/regression-REG-1.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 3014[2mms[22m[39m
       [33m[2mâœ“[22m[39m should block Next when required visible question is empty [33m 315[2mms[22m[39m
       [33m[2mâœ“[22m[39m should NOT block Next when required question is hidden [33m 338[2mms[22m[39m
       [33m[2mâœ“[22m[39m should block when required becomes visible and is empty [33m 325[2mms[22m[39m
       [33m[2mâœ“[22m[39m should skip hidden required page entirely [33m 406[2mms[22m[39m
       [33m[2mâœ“[22m[39m should enforce required on visible page [33m 389[2mms[22m[39m
{"level":30,"time":1768335831915,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w59
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335831920,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335831942,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w59 (Reused: true)

{"level":30,"time":1768335832028,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

 [32mâœ“[39m tests/unit/components/datavault/TableGridView.test.tsx [2m([22m[2m9 tests[22m[2m)[22m[33m 6283[2mms[22m[39m
     [33m[2mâœ“[22m[39m loads table schema and rows [33m 847[2mms[22m[39m
     [33m[2mâœ“[22m[39m enters edit mode on double click [33m 527[2mms[22m[39m
     [33m[2mâœ“[22m[39m updates cell value on blur [33m 1306[2mms[22m[39m
     [33m[2mâœ“[22m[39m renders delete button for each row [33m 636[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w60
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w60 (Reused: true)

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335832350,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335832442,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335832445,"env":"test","blockId":"faede2ec-22d5-4b91-9f50-fd5894384e00","virtualStepId":"6c9379cd-4a66-450a-91e6-9215c0accecb","outputVar":"userList","msg":"Created read table block with virtual step"}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335832536,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768335832617,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768335832864,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335832865,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/dynamic_options_workflow.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 2478[2mms[22m[39m
     [33m[2mâœ“[22m[39m should successfully configure a workflow with Read Table -> Dynamic Choice [33m 406[2mms[22m[39m
{"level":30,"time":1768335832974,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335833152,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335833294,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335833344,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768335833403,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstderr[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx[2m > [22m[2mTableGridView - Drag & Drop[2m > [22m[2mrenders DndContext wrapper
[22m[39mWarning: validateDOMNesting(...): <th> cannot appear as a child of <div>.
    at th
    at SortableColumnHeader (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/SortableColumnHeader.tsx:12:33)
    at div
    at SortableContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:26:23)
    at tr
    at thead
    at table
    at div
    at DndContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:18:18)
    at div
    at div
    at TableGridView (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/TableGridView.tsx:32:26)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
Warning: validateDOMNesting(...): <div> cannot appear as a child of <tr>.
    at div
    at SortableContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:26:23)
    at tr
    at thead
    at table
    at div
    at DndContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:18:18)
    at div
    at div
    at TableGridView (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/TableGridView.tsx:32:26)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w53
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w53 (Reused: true)

{"level":30,"time":1768335833857,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335833858,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/shared/validation/Validator.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 2230[2mms[22m[39m
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

{"level":30,"time":1768335833983,"env":"test","warnings":["Python code does not call emit(). Script will not produce output."],"msg":"Script validation warnings"}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335833985,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768335833986,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/ScriptEngine.test.ts [2m([22m[2m26 tests[22m[2m | [22m[33m4 skipped[39m[2m)[22m[33m 2481[2mms[22m[39m
[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w49
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w49 (Reused: true)

{"level":30,"time":1768335834207,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w57
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335834265,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w57 (Reused: true)

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w65
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w65 (Reused: true)

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

{"level":30,"time":1768335834787,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w63
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

{"level":30,"time":1768335834817,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.expression-validation.test.ts[2m > [22m[2mExpression Validation API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs
[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768335834798,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768335834800,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768335834809,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768335834816,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768335834816,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768335834817,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768335834817,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w63 (Reused: true)

{"level":30,"time":1768335834852,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335834883,"env":"test","msg":"DB: initializing... Local"}
{"level":40,"time":1768335834919,"env":"test","error":{},"msg":"libreoffice-convert not available, trying system LibreOffice"}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335834924,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768335834939,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":40,"time":1768335835058,"env":"test","error":{"code":1,"killed":false,"signal":null,"cmd":"libreoffice --headless --convert-to pdf --outdir \"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs\" \"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs\\simple-template-1768335834771.docx\"","stdout":"","stderr":"'libreoffice' is not recognized as an internal or external command,\r\noperable program or batch file.\r\n"},"msg":"System LibreOffice conversion failed"}
{"level":40,"time":1768335835058,"env":"test","error":{"error":{"code":"INTERNAL_ERROR","message":""}},"msg":"PDF conversion failed"}
{"level":30,"time":1768335835063,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335835063,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/docxRenderer.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 4315[2mms[22m[39m
       [33m[2mâœ“[22m[39m should render a template with simple data [33m 675[2mms[22m[39m
       [33m[2mâœ“[22m[39m should use formatters in templates [33m 313[2mms[22m[39m
       [33m[2mâœ“[22m[39m should attempt PDF conversion when requested [33m 444[2mms[22m[39m
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w62
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w62 (Reused: true)

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335835296,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335835347,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335835348,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335835443,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

 [32mâœ“[39m tests/ui/datavault/TableCard.test.tsx [2m([22m[2m8 tests[22m[2m)[22m[33m 4965[2mms[22m[39m
     [33m[2mâœ“[22m[39m should render table name and description [33m 522[2mms[22m[39m
     [33m[2mâœ“[22m[39m should call onDelete when delete button is clicked [33m 2133[2mms[22m[39m
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w61
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":30,"time":1768335835472,"env":"test","module":"user-credentials-repository","userId":"001f06e9-8aec-468c-b9de-a89c40db5f75","msg":"User credentials created"}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w61 (Reused: true)

{"level":30,"time":1768335835584,"env":"test","module":"email-queue","jobId":"b40ed31a-0478-48ec-be42-69e89dd7b147","to":"test-T6984tG5zMS87jifWhjPF@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335835642,"env":"test","module":"auth-routes","userId":"001f06e9-8aec-468c-b9de-a89c40db5f75","email":"test-T6984tG5zMS87jifWhjPF@example.com","msg":"User registered"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768335835693,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335835816,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335835908,"env":"test","module":"version-service","workflowId":"659d0cab-cab8-48c9-95c8-b8b6b303c878","versionId":"3babbc7b-55b4-401a-96b4-ad5508279866","userId":"c19c810a-6d43-4d43-9716-547307547d7c","versionNumber":1,"msg":"Published new version"}
{"level":30,"time":1768335835953,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335835954,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w66
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w66 (Reused: true)

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w67
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

 [32mâœ“[39m tests/unit/components/datavault/TableGridViewDragDrop.test.tsx [2m([22m[2m7 tests[22m[2m)[22m[33m 5098[2mms[22m[39m
     [33m[2mâœ“[22m[39m renders DndContext wrapper [33m 311[2mms[22m[39m
     [33m[2mâœ“[22m[39m displays columns with type icons [33m 560[2mms[22m[39m
     [33m[2mâœ“[22m[39m displays columns in order based on orderIndex [33m 980[2mms[22m[39m
     [33m[2mâœ“[22m[39m maintains column order after successful reorder [33m 550[2mms[22m[39m
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w67 (Reused: true)

{"level":30,"time":1768335836117,"env":"test","module":"version-service","workflowId":"659d0cab-cab8-48c9-95c8-b8b6b303c878","versionId":"c3318773-0817-4e38-89d4-96809504235d","userId":"c19c810a-6d43-4d43-9716-547307547d7c","versionNumber":2,"msg":"Published new version"}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335836248,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w56
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":30,"time":1768335836278,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335836279,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w56 (Reused: true)

 [32mâœ“[39m tests/unit/components/datavault/SortableColumnHeader.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 2518[2mms[22m[39m
{"level":50,"time":1768335836371,"env":"test","module":"workflow-patch-service","error":{},"op":{"op":"datavault.createTable","databaseId":"db-123","name":"Submissions","columns":[{"name":"email","type":"text"},{"name":"submitted_at","type":"date"}]},"msg":"Failed to apply operation"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":50,"time":1768335836371,"env":"test","module":"workflow-patch-service","error":{},"op":{"op":"datavault.addColumns","tableId":"table-123","columns":[{"name":"phone","type":"text"}]},"msg":"Failed to apply operation"}
{"level":50,"time":1768335836374,"env":"test","module":"workflow-patch-service","error":{},"op":{"op":"step.create","sectionRef":"temp-section-1","type":"short_text","title":"Field 1","alias":"field1"},"msg":"Failed to apply operation"}
{"level":50,"time":1768335836384,"env":"test","module":"workflow-patch-service","error":{},"op":{"op":"document.bindFields","id":"template-123","bindings":{"client_name":"nonExistentAlias"}},"msg":"Failed to apply operation"}
{"level":30,"time":1768335836387,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768335836388,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335836392,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

 [32mâœ“[39m tests/unit/services/WorkflowPatchService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 2156[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768335836632,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335836633,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768335836641,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
 [32mâœ“[39m tests/integration/workflow_versioning.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2267[2mms[22m[39m
     [33m[2mâœ“[22m[39m should create a version and populate changelog [33m 421[2mms[22m[39m
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335836698,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335836775,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w68
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

{"level":50,"time":1768335836815,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w68 (Reused: true)

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w64
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":30,"time":1768335836936,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335836937,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w64 (Reused: true)

{"level":50,"time":1768335836994,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
 [32mâœ“[39m tests/ui/blocks/SendDataToTableBlockEditor.test.tsx [2m([22m[2m12 tests[22m[2m)[22m[33m 2473[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w69
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":30,"time":1768335837045,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335837046,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335837081,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w69 (Reused: true)

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768335837144,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

 [32mâœ“[39m tests/unit/components/datavault/CellRenderer.test.tsx [2m([22m[2m12 tests[22m[2m)[22m[33m 4002[2mms[22m[39m
     [33m[2mâœ“[22m[39m renders boolean value as Yes/No [33m 695[2mms[22m[39m
{"level":30,"time":1768335837262,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335837262,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335837315,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w70
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":30,"time":1768335837424,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w70 (Reused: true)

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335837461,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

{"level":30,"time":1768335837527,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335837551,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335837553,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/ui/datavault/ColumnTypeIcon.test.tsx [2m([22m[2m27 tests[22m[2m)[22m[33m 2589[2mms[22m[39m
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335837681,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335837732,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335837733,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335837753,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

 [32mâœ“[39m tests/integration/api.expression-validation.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 3515[2mms[22m[39m
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

 [32mâœ“[39m tests/unit/HelperLibrary.test.ts [2m([22m[2m60 tests[22m[2m)[22m[33m 2181[2mms[22m[39m
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w71
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w72
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w71 (Reused: true)

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w72 (Reused: true)

{"level":30,"time":1768335838008,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335838010,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/workflows/validation.test.ts [2m([22m[2m66 tests[22m[2m)[22m[33m 2435[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w73
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w73 (Reused: true)

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w74
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335838280,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w74 (Reused: true)

{"level":30,"time":1768335838314,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335838314,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/conditions/conditionEvaluation.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 1969[2mms[22m[39m
{"level":30,"time":1768335838444,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335838450,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

{"level":30,"time":1768335838555,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335838681,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

{"level":30,"time":1768335838762,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335838876,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335838956,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335839069,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335839117,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstderr[2m | tests/unit/shared/conditionEvaluator.test.ts[2m > [22m[2mconditionEvaluator[2m > [22m[2mComparison operators[2m > [22m[2mUnknown operator[2m > [22m[2mshould default to true and log warning
[22m[39mUnknown operator: unknown_operator

{"level":30,"time":1768335839128,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w54
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335839129,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

 [32mâœ“[39m tests/unit/shared/conditionEvaluator.test.ts [2m([22m[2m70 tests[22m[2m)[22m[33m 2521[2mms[22m[39m
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w54 (Reused: true)

{"level":30,"time":1768335839178,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w77
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w78
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w77 (Reused: true)

{"level":30,"time":1768335839251,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w78 (Reused: true)

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335839252,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335839267,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335839277,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/unit/client/choice-utils.test.ts[2m > [22m[2mchoice-utils[2m > [22m[2mhandles missing content gracefully
[22m[39m[generateOptionsFromList] Invalid list data: [1mnull[22m

{"level":30,"time":1768335839304,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335839305,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/client/choice-utils.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 2365[2mms[22m[39m
{"level":30,"time":1768335839355,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335839382,"env":"test","msg":"DB: initializing... Local"}
 [32mâœ“[39m tests/ui/common/Breadcrumbs.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 2844[2mms[22m[39m
{"level":30,"time":1768335839435,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335839477,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335839478,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335839506,"env":"test","module":"ai-service","estimatedInputTokens":18,"estimatedOutputTokens":36,"sectionCount":0,"msg":"Attempting single-shot workflow revision"}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335839507,"env":"test","module":"ai-service","event":"ai_request_started","provider":"gemini","model":"gemini-2.0-flash-exp","taskType":"workflow_revision","promptTokens":812,"maxTokens":8192,"msg":"AI request started"}
{"level":30,"time":1768335839508,"env":"test","module":"ai-service","event":"ai_request_success","provider":"gemini","model":"gemini-2.0-flash-exp","taskType":"workflow_revision","promptTokens":812,"responseTokens":66,"totalTokens":878,"durationMs":1,"estimatedCostUSD":0.00010760000000000001,"attempts":1,"msg":"AI request succeeded"}
{"level":30,"time":1768335839511,"env":"test","module":"ai-service","duration":5,"workflowId":"123","changeCount":1,"msg":"AI workflow revision succeeded"}
{"level":30,"time":1768335839515,"env":"test","module":"ai-service","estimatedInputTokens":18,"estimatedOutputTokens":36,"sectionCount":0,"msg":"Attempting single-shot workflow revision"}
{"level":30,"time":1768335839515,"env":"test","module":"ai-service","event":"ai_request_started","provider":"gemini","model":"gemini-2.0-flash-exp","taskType":"workflow_revision","promptTokens":812,"maxTokens":8192,"msg":"AI request started"}
{"level":30,"time":1768335839515,"env":"test","module":"ai-service","event":"ai_request_success","provider":"gemini","model":"gemini-2.0-flash-exp","taskType":"workflow_revision","promptTokens":812,"responseTokens":45,"totalTokens":857,"durationMs":0,"estimatedCostUSD":0.00009920000000000001,"attempts":1,"msg":"AI request succeeded"}
{"level":30,"time":1768335839516,"env":"test","module":"ai-service","duration":1,"workflowId":"123","changeCount":0,"msg":"AI workflow revision succeeded"}
{"level":30,"time":1768335839516,"env":"test","module":"ai-service","estimatedInputTokens":18,"estimatedOutputTokens":36,"sectionCount":0,"msg":"Attempting single-shot workflow revision"}
{"level":30,"time":1768335839516,"env":"test","module":"ai-service","event":"ai_request_started","provider":"gemini","model":"gemini-2.0-flash-exp","taskType":"workflow_revision","promptTokens":811,"maxTokens":8192,"msg":"AI request started"}
{"level":30,"time":1768335839518,"env":"test","module":"ai-service","event":"ai_request_success","provider":"gemini","model":"gemini-2.0-flash-exp","taskType":"workflow_revision","promptTokens":811,"responseTokens":4,"totalTokens":815,"durationMs":2,"estimatedCostUSD":0.0000827,"attempts":1,"msg":"AI request succeeded"}
{"level":40,"time":1768335839518,"env":"test","module":"ai-service","lastChar":"N","last50":"I am not JSON","msg":"Response does not end with closing brace/bracket"}
{"level":50,"time":1768335839518,"env":"test","module":"ai-service","responseLength":13,"estimatedTokens":4,"responseSuffix":"I am not JSON","msg":"Detected truncated AI response - workflow too large for single-shot revision"}
{"level":50,"time":1768335839518,"env":"test","module":"ai-service","error":{"code":"RESPONSE_TRUNCATED","estimatedTokens":4,"responseLength":13},"duration":2,"msg":"AI workflow revision failed"}
{"level":40,"time":1768335839518,"env":"test","module":"ai-service","estimatedInputTokens":18,"estimatedOutputTokens":36,"actualOutputTokens":4,"responseLength":13,"msg":"Single-shot revision truncated - automatically retrying with chunking"}
{"level":30,"time":1768335839519,"env":"test","module":"ai-service","event":"ai_request_started","provider":"gemini","model":"gemini-2.0-flash-exp","taskType":"workflow_revision","promptTokens":811,"maxTokens":8192,"msg":"AI request started"}
{"level":30,"time":1768335839519,"env":"test","module":"ai-service","event":"ai_request_success","provider":"gemini","model":"gemini-2.0-flash-exp","taskType":"workflow_revision","promptTokens":811,"responseTokens":4,"totalTokens":815,"durationMs":0,"estimatedCostUSD":0.0000827,"attempts":1,"msg":"AI request succeeded"}
{"level":40,"time":1768335839519,"env":"test","module":"ai-service","lastChar":"N","last50":"I am not JSON","msg":"Response does not end with closing brace/bracket"}
{"level":50,"time":1768335839519,"env":"test","module":"ai-service","responseLength":13,"estimatedTokens":4,"responseSuffix":"I am not JSON","msg":"Detected truncated AI response - workflow too large for single-shot revision"}
{"level":50,"time":1768335839519,"env":"test","module":"ai-service","error":{"code":"RESPONSE_TRUNCATED","estimatedTokens":4,"responseLength":13},"duration":0,"msg":"AI workflow revision failed"}
{"level":50,"time":1768335839519,"env":"test","module":"ai-service","duration":3,"error":{"code":"RESPONSE_TRUNCATED","estimatedTokens":4,"responseLength":13},"msg":"AI workflow revision failed"}
{"level":30,"time":1768335839521,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768335839522,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/services/AIService.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2091[2mms[22m[39m
 [32mâœ“[39m tests/ui/datavault/DatabaseSettingsPage.test.tsx [2m([22m[2m7 tests[22m[2m)[22m[33m 3840[2mms[22m[39m
     [33m[2mâœ“[22m[39m should render database settings page with breadcrumbs [33m 728[2mms[22m[39m
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w79
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":30,"time":1768335839643,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335839644,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w79 (Reused: true)

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w80
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

 [32mâœ“[39m tests/integration/session.management.test.ts [2m([22m[2m22 tests[22m[2m)[22m[33m 2163[2mms[22m[39m
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w80 (Reused: true)

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

{"level":30,"time":1768335839847,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts[2m > [22m[2mData Sources API - Native Catalog
[22m[39mðŸ“š API Documentation available at /api-docs
[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768335839873,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768335839858,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768335839859,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768335839865,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768335839872,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768335839872,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768335839873,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768335839873,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768335839953,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335839954,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335839972,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335839973,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/api.ai.test.ts [2m([22m[2m32 tests[22m[2m)[22m[33m 2141[2mms[22m[39m
 [32mâœ“[39m tests/unit/utils/conditionalLogic.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 2353[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w81
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w81 (Reused: true)

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335840467,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335840499,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335840516,"env":"test","module":"user-credentials-repository","userId":"830bf95c-487c-4b77-8309-4a17bdd92c35","msg":"User credentials created"}
{"level":30,"time":1768335840585,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335840599,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335840622,"env":"test","module":"email-queue","jobId":"6c67a4dc-25f1-47d5-ac77-274db5d8d7e7","to":"test-ZDk6EIJ5S9Dw6BmzAxCqP@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768335840684,"env":"test","module":"auth-routes","userId":"830bf95c-487c-4b77-8309-4a17bdd92c35","email":"test-ZDk6EIJ5S9Dw6BmzAxCqP@example.com","msg":"User registered"}
[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w82
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w82 (Reused: true)

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w83
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w83 (Reused: true)

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335841112,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335841119,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335841120,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335841158,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w76
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":30,"time":1768335841186,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335841187,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/mfa.flow.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 2371[2mms[22m[39m
{"level":30,"time":1768335841202,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335841218,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w76 (Reused: true)

 [32mâœ“[39m tests/integration/intake.portal.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 2427[2mms[22m[39m
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w84
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w84 (Reused: true)

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w87
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w87 (Reused: true)

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w86
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w88
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w86 (Reused: true)

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w88 (Reused: true)

{"level":30,"time":1768335841625,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w85
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335841673,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w85 (Reused: true)

{"level":30,"time":1768335841789,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335841790,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335841797,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335841798,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335841822,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335841822,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/auth.routes.test.ts [2m([22m[2m41 tests[22m[2m)[22m[33m 2611[2mms[22m[39m
 [32mâœ“[39m tests/unit/WorkflowChangeAnalyzer.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 2568[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w75
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335842107,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w75 (Reused: true)

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

 [32mâœ“[39m tests/integration/api.dataSources.native.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 3123[2mms[22m[39m
     [33m[2mâœ“[22m[39m should list databases and databases' tables in the catalog [33m 408[2mms[22m[39m
{"level":30,"time":1768335842202,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335842281,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768335842282,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335842300,"env":"test","msg":"DB: initializing... Local"}
 [32mâœ“[39m tests/unit/WorkflowOptimizationService.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 2417[2mms[22m[39m
{"level":30,"time":1768335842369,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335842393,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335842451,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335842484,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335842583,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335842604,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335842632,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335842670,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335842689,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335842691,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335842696,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335842760,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335842777,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335842778,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335842798,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w90
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

 [32mâœ“[39m tests/unit/client/list-choice-options.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 2340[2mms[22m[39m
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w89
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w90 (Reused: true)

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w89 (Reused: true)

{"level":30,"time":1768335842952,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335842952,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/utils/variableResolver.test.ts [2m([22m[2m20 tests[22m[2m)[22m[33m 2533[2mms[22m[39m
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768335843125,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK initialized successfully"}
{"level":30,"time":1768335843129,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768335843130,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335843125,"env":"test","module":"telemetry","msg":"Prometheus metrics initialized"}
{"level":30,"time":1768335843127,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768335843181,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK shut down successfully"}
 [32mâœ“[39m tests/unit/engine/Performance.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2193[2mms[22m[39m
{"level":40,"time":1768335843247,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":30,"time":1768335843249,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335843249,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

 [32mâœ“[39m tests/unit/workflow/QueryBlock.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2154[2mms[22m[39m
{"level":30,"time":1768335843292,"env":"test","msg":"DB: initializing... Local"}
{"level":40,"time":1768335843322,"env":"test","module":"rbac-middleware","path":"/api/workflows","permission":"workflow:create","msg":"Unauthenticated user attempted to access protected resource"}
[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335843353,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768335843365,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335843365,"env":"test","msg":"DB: pool closed."}
{"level":40,"time":1768335843327,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","permission":"workflow:create","path":"/api/workflows","msg":"Permission denied"}
{"level":40,"time":1768335843329,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":null,"permission":"workflow:view","path":"/api/workflows","msg":"Permission denied"}
{"level":40,"time":1768335843330,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","permissions":["workflow:create","workflow:edit","workflow:delete"],"path":"/api/workflows","msg":"Permission denied (none of required permissions)"}
{"level":40,"time":1768335843333,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"builder","permissions":["workflow:edit","workflow:delete"],"path":"/api/workflows","msg":"Permission denied (missing some required permissions)"}
{"level":40,"time":1768335843335,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","requiredRoles":["owner","builder"],"path":"/api/admin","msg":"Role check failed"}
{"level":40,"time":1768335843336,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":null,"requiredRoles":["owner"],"path":"/api/admin","msg":"Role check failed"}
{"level":40,"time":1768335843338,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"builder","requiredRoles":["owner"],"path":"/api/test","msg":"Role check failed"}
{"level":40,"time":1768335843340,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"runner","requiredRoles":["owner","builder"],"path":"/api/test","msg":"Role check failed"}
{"level":40,"time":1768335843342,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","requiredRoles":["owner","builder","runner"],"path":"/api/test","msg":"Role check failed"}
{"level":40,"time":1768335843346,"env":"test","module":"rbac-middleware","path":"/api/test","permission":"workflow:view","msg":"Unauthenticated user attempted to access protected resource"}
{"level":40,"time":1768335843346,"env":"test","module":"rbac-middleware","userId":"user-123","permission":"workflow:view","path":"/api/test","msg":"Permission denied"}
{"level":40,"time":1768335843347,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"invalid-role","permission":"workflow:view","path":"/api/test","msg":"Permission denied"}
{"level":30,"time":1768335843347,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768335843386,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w92
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

 [32mâœ“[39m tests/unit/utils/conditionalLogic-simple.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2201[2mms[22m[39m
{"level":30,"time":1768335843398,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK initialized successfully"}
{"level":30,"time":1768335843398,"env":"test","module":"telemetry","msg":"Prometheus metrics initialized"}
{"level":30,"time":1768335843399,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":40,"time":1768335843419,"env":"test","module":"metrics-routes","ip":"::ffff:127.0.0.1","msg":"Unauthorized metrics access attempt"}
 [32mâœ“[39m tests/unit/middleware/rbac.test.ts [2m([22m[2m44 tests[22m[2m)[22m[33m 2290[2mms[22m[39m
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w91
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":40,"time":1768335843296,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":40,"time":1768335843301,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":40,"time":1768335843326,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":40,"time":1768335843331,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":30,"time":1768335843443,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768335843444,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w92 (Reused: true)

{"level":30,"time":1768335843478,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK shut down successfully"}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335843479,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768335843480,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w91 (Reused: true)

 [32mâœ“[39m tests/unit/isolatedVmBridge.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 2231[2mms[22m[39m
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w93
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w94
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w93 (Reused: true)

 [32mâœ“[39m tests/integration/metrics.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 2803[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w94 (Reused: true)

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335844009,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335844070,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335844144,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335844200,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335844219,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335844220,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

 [32mâœ“[39m tests/ui/datavault/TemplateCard.test.tsx [2m([22m[2m6 tests[22m[2m)[22m[33m 2739[2mms[22m[39m
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w95
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w95 (Reused: true)

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w96
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w96 (Reused: true)

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335844634,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335844664,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335844700,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335844714,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335844723,"env":"test","msg":"DB: initializing... Local"}
{"level":40,"time":1768335844740,"env":"test","module":"auth-middleware","path":"/test","msg":"No authorization token provided"}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335844751,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":50,"time":1768335844752,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768335844754,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768335844754,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768335844755,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768335844755,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768335844756,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768335844758,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768335844760,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768335844760,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768335844760,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768335844761,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768335844762,"env":"test","module":"auth-middleware","path":"/test","msg":"No authorization token provided"}
{"level":30,"time":1768335844762,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768335844763,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335844768,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335844769,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335844777,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335844787,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

 [32mâœ“[39m tests/unit/utils/encryption.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 2406[2mms[22m[39m
 [32mâœ“[39m tests/unit/middleware/auth.middleware.test.ts [2m([22m[2m22 tests[22m[2m)[22m[33m 2376[2mms[22m[39m
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w98
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w99
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w101
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w98 (Reused: true)

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w99 (Reused: true)

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w101 (Reused: true)

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w100
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w100 (Reused: true)

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w102
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w97
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w97 (Reused: true)

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w102 (Reused: true)

{"level":30,"time":1768335845324,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335845325,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335845363,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335845364,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768335845366,"env":"test","status":401,"statusText":"Unauthorized","error":"Invalid client credentials","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token request failed"}
{"level":30,"time":1768335845367,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335845368,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/workflows/conditionTruthTable.test.ts [2m([22m[2m51 tests[22m[2m)[22m[33m 2347[2mms[22m[39m
{"level":50,"time":1768335845367,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768335845369,"env":"test","data":{"token_type":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768335845371,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768335845378,"env":"test","data":{"access_token":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768335845378,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768335845381,"env":"test","error":"Network error: ECONNREFUSED","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
 [32mâœ“[39m tests/unit/shared/validation/stepConfigSchemas.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 2141[2mms[22m[39m
 [32mâœ“[39m tests/unit/services/RunExecutionCoordinator.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 2173[2mms[22m[39m
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w103
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":50,"time":1768335845489,"env":"test","error":"Invalid credentials","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":50,"time":1768335845490,"env":"test","error":"ECONNREFUSED","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768335845492,"env":"test","status":400,"statusText":"Bad Request","error":"Invalid grant_type","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768335845492,"env":"test","error":"OAuth2 token request failed: 400 Bad Request","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768335845493,"env":"test","status":401,"statusText":"Unauthorized","error":"Client authentication failed","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768335845493,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768335845493,"env":"test","status":403,"statusText":"Forbidden","error":"Access denied","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768335845494,"env":"test","error":"OAuth2 token request failed: 403 Forbidden","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768335845494,"env":"test","status":500,"statusText":"Internal Server Error","error":"Server error","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768335845494,"env":"test","error":"OAuth2 token request failed: 500 Internal Server Error","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768335845495,"env":"test","error":"Unexpected token in JSON","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768335845495,"env":"test","error":"Request timeout","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":30,"time":1768335845497,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768335845497,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335845500,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w103 (Reused: true)

 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 2588[2mms[22m[39m
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335845585,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335845696,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335845780,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335846077,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335846118,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335846149,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335846150,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335846164,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335846168,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335846167,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768335846206,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

 [32mâœ“[39m tests/unit/services/repeater.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 2205[2mms[22m[39m
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335846234,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768335846242,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335846256,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w105
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335846306,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w105 (Reused: true)

{"level":30,"time":1768335846348,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335846349,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/ui/builder.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 2245[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w104
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768335846481,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w104 (Reused: true)

{"level":30,"time":1768335846549,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335846621,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335846673,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335846778,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768335846781,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335846782,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335846779,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts[2m > [22m[2mIntakeQuestionVisibilityService[2m > [22m[2mHelper methods[2m > [22m[2mshould get visible question count
[22m[39mMOCK SETUP DONE. Mock questions: [
  {
    id: [32m'q1'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q1'[39m,
    order: [33m0[39m,
    isVirtual: [33mfalse[39m,
    alias: [32m'show'[39m,
    visibleIf: [1mnull[22m
  },
  {
    id: [32m'q2'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q2'[39m,
    order: [33m1[39m,
    isVirtual: [33mfalse[39m,
    visibleIf: { op: [32m'equals'[39m, left: [36m[Object][39m, right: [36m[Object][39m }
  },
  {
    id: [32m'q3'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q3'[39m,
    order: [33m2[39m,
    isVirtual: [33mfalse[39m,
    visibleIf: [1mnull[22m
  }
]
Calling getVisibleQuestionCount...

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts[2m > [22m[2mIntakeQuestionVisibilityService[2m > [22m[2mHelper methods[2m > [22m[2mshould get visible question count
[22m[39mCOUNT RESULT: [33m0[39m
Mock called times: [33m1[39m
Mock last call args: [ [ [32m'section1'[39m ] ]

{"level":50,"time":1768335846797,"env":"test","module":"intake-question-visibility","error":{},"questionId":"q1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating visibleIf condition"}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335846799,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768335846799,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335846809,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335846810,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/listPipeline.semantics.test.ts [2m([22m[2m70 tests[22m[2m)[22m[33m 2193[2mms[22m[39m
 [32mâœ“[39m tests/unit/services/intakeQuestionVisibility.test.ts [2m([22m[2m19 tests[22m[2m)[22m[33m 2082[2mms[22m[39m
 [32mâœ“[39m tests/unit/captcha.service.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 2302[2mms[22m[39m
{"level":30,"time":1768335846887,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768335846894,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/engine.expr.test.ts [2m([22m[2m26 tests[22m[2m)[22m[33m 2223[2mms[22m[39m
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w107
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

 [32mâœ“[39m tests/unit/services/docxHelpers.test.ts [2m([22m[2m39 tests[22m[2m)[22m[33m 2265[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w107 (Reused: true)

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w106
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":50,"time":1768335847086,"env":"test","module":"intake-navigation","error":{},"pageId":"page1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating visibleIf condition"}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w106 (Reused: true)

{"level":50,"time":1768335847086,"env":"test","module":"intake-navigation","error":{},"pageId":"page1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating skipIf condition"}
{"level":30,"time":1768335847088,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768335847089,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/services/intakeNavigation.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 2380[2mms[22m[39m
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335847187,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335847216,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335847217,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w108
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":30,"time":1768335847249,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

 [32mâœ“[39m tests/ui/blocks/SendDataBlockEditorRouting.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 2201[2mms[22m[39m
[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w108 (Reused: true)

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335847378,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335847430,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w110
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w110 (Reused: true)

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w111
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w111 (Reused: true)

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/ListTools.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

{"level":30,"time":1768335847791,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335847793,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/services/TemplateAnalysisService.test.ts [2m([22m[2m27 tests[22m[2m)[22m[33m 1934[2mms[22m[39m
{"level":30,"time":1768335847961,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335847962,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335848086,"env":"test","msg":"DB: initializing... Local"}
 [32mâœ“[39m tests/unit/services/docxRenderer2.test.ts [2m([22m[2m27 tests[22m[2m)[22m[33m 2008[2mms[22m[39m
[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w109
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":30,"time":1768335848223,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w109 (Reused: true)

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335848327,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335848372,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335848472,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335848670,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335848742,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335848668,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335848823,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335848825,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/utils/pagination.test.ts [2m([22m[2m24 tests[22m[2m)[22m[33m 2315[2mms[22m[39m
{"level":30,"time":1768335848966,"env":"test","module":"ai-service","event":"ai_request_started","provider":"openai","model":"gpt-4-turbo-preview","taskType":"workflow_generation","promptTokens":1212,"maxTokens":8000,"msg":"AI request started"}
[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335848967,"env":"test","module":"ai-service","event":"ai_request_success","provider":"openai","model":"gpt-4-turbo-preview","taskType":"workflow_generation","promptTokens":1212,"responseTokens":91,"totalTokens":1303,"durationMs":0,"estimatedCostUSD":0.014849999999999999,"attempts":1,"msg":"AI request succeeded"}
{"level":30,"time":1768335848971,"env":"test","module":"workflow-quality-validator","overall":99,"breakdown":{"aliases":100,"types":100,"structure":100,"ux":95,"completeness":100,"validation":100},"issuesCount":1,"passed":true,"msg":"Workflow quality validation completed"}
{"level":30,"time":1768335848972,"env":"test","module":"ai-service","duration":7,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":99,"qualityBreakdown":{"aliases":100,"types":100,"structure":100,"ux":95,"completeness":100,"validation":100},"qualityPassed":true,"issuesCount":1,"msg":"AI workflow generation succeeded"}
{"level":30,"time":1768335848982,"env":"test","module":"ai-service","event":"ai_request_started","provider":"openai","model":"gpt-4-turbo-preview","taskType":"workflow_generation","promptTokens":1201,"maxTokens":8000,"msg":"AI request started"}
{"level":30,"time":1768335848983,"env":"test","module":"ai-service","event":"ai_request_success","provider":"openai","model":"gpt-4-turbo-preview","taskType":"workflow_generation","promptTokens":1201,"responseTokens":49,"totalTokens":1250,"durationMs":1,"estimatedCostUSD":0.013479999999999999,"attempts":1,"msg":"AI request succeeded"}
{"level":50,"time":1768335848984,"env":"test","module":"ai-service","error":{"code":"VALIDATION_ERROR","troubleshooting":"ðŸ”§ Troubleshooting Steps:\n1. The AI response structure doesn't match our expected format\n2. This may indicate:\n   - A breaking change in the AI model behavior\n   - The model is struggling with the complexity of the request\n3. Try simplifying your workflow or request\n4. If this persists, please report this issue with the workflow details"},"duration":2,"msg":"AI workflow generation failed"}
{"level":30,"time":1768335848987,"env":"test","module":"ai-service","event":"ai_request_started","provider":"openai","model":"gpt-4-turbo-preview","taskType":"workflow_generation","promptTokens":1201,"maxTokens":8000,"msg":"AI request started"}
{"level":30,"time":1768335848987,"env":"test","module":"ai-service","event":"ai_request_success","provider":"openai","model":"gpt-4-turbo-preview","taskType":"workflow_generation","promptTokens":1201,"responseTokens":68,"totalTokens":1269,"durationMs":0,"estimatedCostUSD":0.01405,"attempts":1,"msg":"AI request succeeded"}
{"level":50,"time":1768335848988,"env":"test","module":"ai-service","error":{"code":"VALIDATION_ERROR","troubleshooting":"ðŸ”§ Troubleshooting Steps:\n1. The AI response structure doesn't match our expected format\n2. This may indicate:\n   - A breaking change in the AI model behavior\n   - The model is struggling with the complexity of the request\n3. Try simplifying your workflow or request\n4. If this persists, please report this issue with the workflow details"},"duration":1,"msg":"AI workflow generation failed"}
{"level":30,"time":1768335848991,"env":"test","module":"ai-service","event":"ai_request_started","provider":"openai","model":"gpt-4-turbo-preview","taskType":"workflow_generation","promptTokens":1201,"maxTokens":8000,"msg":"AI request started"}
{"level":30,"time":1768335848991,"env":"test","module":"ai-service","event":"ai_request_success","provider":"openai","model":"gpt-4-turbo-preview","taskType":"workflow_generation","promptTokens":1201,"responseTokens":89,"totalTokens":1290,"durationMs":0,"estimatedCostUSD":0.014679999999999999,"attempts":1,"msg":"AI request succeeded"}
{"level":50,"time":1768335848992,"env":"test","module":"ai-service","error":{"code":"VALIDATION_ERROR","troubleshooting":"ðŸ”§ Troubleshooting Steps:\n1. The AI response structure doesn't match our expected format\n2. This may indicate:\n   - A breaking change in the AI model behavior\n   - The model is struggling with the complexity of the request\n3. Try simplifying your workflow or request\n4. If this persists, please report this issue with the workflow details"},"duration":1,"msg":"AI workflow generation failed"}
{"level":30,"time":1768335848995,"env":"test","module":"ai-service","event":"ai_request_started","provider":"openai","model":"gpt-4-turbo-preview","taskType":"workflow_generation","promptTokens":1201,"maxTokens":8000,"msg":"AI request started"}
{"level":40,"time":1768335848996,"env":"test","module":"ai-service","attempt":0,"waitMs":1000,"msg":"Rate limit hit, retrying..."}
{"level":40,"time":1768335848996,"env":"test","module":"ai-service","attempt":1,"waitMs":2000,"msg":"Rate limit hit, retrying..."}
{"level":40,"time":1768335848996,"env":"test","module":"ai-service","attempt":2,"waitMs":4000,"msg":"Rate limit hit, retrying..."}
{"level":40,"time":1768335848996,"env":"test","module":"ai-service","attempt":3,"waitMs":8000,"msg":"Rate limit hit, retrying..."}
{"level":40,"time":1768335848996,"env":"test","module":"ai-service","attempt":4,"waitMs":16000,"msg":"Rate limit hit, retrying..."}
{"level":40,"time":1768335848996,"env":"test","module":"ai-service","attempt":5,"waitMs":32000,"msg":"Rate limit hit, retrying..."}
{"level":50,"time":1768335848996,"env":"test","module":"ai-service","event":"ai_request_failed","provider":"openai","model":"gpt-4-turbo-preview","taskType":"workflow_generation","errorType":"RATE_LIMIT","durationMs":1,"attempts":7,"msg":"AI request failed: rate limit"}
{"level":50,"time":1768335848996,"env":"test","module":"ai-service","error":{"code":"RATE_LIMIT","details":{"originalError":"Rate limit exceeded","retryAfterSeconds":60},"troubleshooting":"ðŸ”§ Troubleshooting Steps:\n1. You've hit the AI provider's rate limit\n2. Solutions:\n   - Wait 60 seconds and try again\n   - Check your API key quota at your provider's dashboard\n   - Consider upgrading your API plan for higher limits\n   - If using free tier, you may need to wait until limits reset"},"duration":1,"msg":"AI workflow generation failed"}
{"level":30,"time":1768335848999,"env":"test","module":"ai-service","event":"ai_request_started","provider":"openai","model":"gpt-4-turbo-preview","taskType":"workflow_generation","promptTokens":1201,"maxTokens":8000,"msg":"AI request started"}
{"level":30,"time":1768335848999,"env":"test","module":"ai-service","event":"ai_request_success","provider":"openai","model":"gpt-4-turbo-preview","taskType":"workflow_generation","promptTokens":1201,"responseTokens":6,"totalTokens":1207,"durationMs":0,"estimatedCostUSD":0.01219,"attempts":1,"msg":"AI request succeeded"}
{"level":50,"time":1768335848999,"env":"test","module":"ai-service","error":{},"duration":0,"msg":"AI workflow generation failed"}
{"level":30,"time":1768335849005,"env":"test","module":"ai-service","event":"ai_request_started","provider":"anthropic","model":"claude-3-5-sonnet-20241022","taskType":"workflow_generation","promptTokens":1212,"maxTokens":8000,"msg":"AI request started"}
{"level":30,"time":1768335849005,"env":"test","module":"ai-service","event":"ai_request_success","provider":"anthropic","model":"claude-3-5-sonnet-20241022","taskType":"workflow_generation","promptTokens":1212,"responseTokens":68,"totalTokens":1280,"durationMs":0,"estimatedCostUSD":0.004656,"attempts":1,"msg":"AI request succeeded"}
{"level":30,"time":1768335849006,"env":"test","module":"workflow-quality-validator","overall":100,"breakdown":{"aliases":100,"types":100,"structure":100,"ux":100,"completeness":100,"validation":100},"issuesCount":0,"passed":true,"msg":"Workflow quality validation completed"}
{"level":30,"time":1768335849006,"env":"test","module":"ai-service","duration":1,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":100,"qualityBreakdown":{"aliases":100,"types":100,"structure":100,"ux":100,"completeness":100,"validation":100},"qualityPassed":true,"issuesCount":0,"msg":"AI workflow generation succeeded"}
{"level":30,"time":1768335849009,"env":"test","module":"ai-service","event":"ai_request_started","provider":"anthropic","model":"claude-3-5-sonnet-20241022","taskType":"workflow_generation","promptTokens":1201,"maxTokens":8000,"msg":"AI request started"}
{"level":30,"time":1768335849009,"env":"test","module":"ai-service","event":"ai_request_success","provider":"anthropic","model":"claude-3-5-sonnet-20241022","taskType":"workflow_generation","promptTokens":1201,"responseTokens":33,"totalTokens":1234,"durationMs":0,"estimatedCostUSD":0.004098,"attempts":1,"msg":"AI request succeeded"}
{"level":30,"time":1768335849009,"env":"test","module":"workflow-quality-validator","overall":96,"breakdown":{"aliases":100,"types":100,"structure":80,"ux":100,"completeness":90,"validation":100},"issuesCount":2,"passed":true,"msg":"Workflow quality validation completed"}
{"level":30,"time":1768335849009,"env":"test","module":"ai-service","duration":0,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":96,"qualityBreakdown":{"aliases":100,"types":100,"structure":80,"ux":100,"completeness":90,"validation":100},"qualityPassed":true,"issuesCount":2,"msg":"AI workflow generation succeeded"}
{"level":30,"time":1768335849013,"env":"test","module":"ai-service","event":"ai_request_started","provider":"openai","model":"gpt-4-turbo-preview","taskType":"binding_suggestion","promptTokens":258,"maxTokens":4000,"msg":"AI request started"}
{"level":30,"time":1768335849013,"env":"test","module":"ai-service","event":"ai_request_success","provider":"openai","model":"gpt-4-turbo-preview","taskType":"binding_suggestion","promptTokens":258,"responseTokens":44,"totalTokens":302,"durationMs":0,"estimatedCostUSD":0.0039,"attempts":1,"msg":"AI request succeeded"}
{"level":30,"time":1768335849014,"env":"test","module":"ai-service","duration":1,"suggestionsCount":1,"msg":"AI binding suggestion succeeded"}
{"level":30,"time":1768335849015,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768335849015,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/ai.service.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 2205[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768335849197,"env":"test","workflowId":"123e4567-e89b-12d3-a456-426614174000","userId":"user-123","sectionsCount":2,"stepsCount":0,"logicRulesCount":1,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/services/WorkflowService.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 2116[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return workflow if user is the creator [33m 1605[2mms[22m[39m
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w112
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstderr[2m | tests/unit/shared/workflowLogic.test.ts[2m > [22m[2mworkflowLogic[2m > [22m[2mevaluateRules[2m > [22m[2mOperators[2m > [22m[2mUnknown operator[2m > [22m[2mshould return false and log warning for unknown operator
[22m[39mUnknown operator: unknown_operator

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w112 (Reused: true)

{"level":30,"time":1768335849309,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335849321,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335849322,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335849328,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335849329,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335849354,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

 [32mâœ“[39m tests/unit/shared/workflowLogic.test.ts [2m([22m[2m65 tests[22m[2m)[22m[33m 2304[2mms[22m[39m
 [32mâœ“[39m tests/unit/shared/validation/PageValidator.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2738[2mms[22m[39m
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w115
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w115 (Reused: true)

{"level":30,"time":1768335849931,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335849979,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/services/MfaService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 2373[2mms[22m[39m
         [33m[2mâœ“[22m[39m should generate TOTP secret, QR code, and backup codes [33m 309[2mms[22m[39m
         [33m[2mâœ“[22m[39m should try multiple codes if first doesn't match [33m 386[2mms[22m[39m
{"level":30,"time":1768335850325,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335850326,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/analytics_preservation.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 1486[2mms[22m[39m
     [33m[2mâœ“[22m[39m should preserve lifetime user count when a user is deleted [33m 456[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w118
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w114
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w118 (Reused: true)

{"level":30,"time":1768335850511,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w114 (Reused: true)

{"level":30,"time":1768335850519,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335850555,"env":"test","module":"ai-controller","userId":"user-123","workflowId":"123e4567-e89b-12d3-a456-426614174000","msg":"AI workflow revision job enqueued"}
{"level":30,"time":1768335850569,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335850571,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335850618,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":50,"time":1768335850628,"env":"test","module":"ai-controller","error":{"issues":[{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["workflowId"]},{"code":"invalid_type","expected":"object","received":"undefined","path":["currentWorkflow"],"message":"Required"},{"code":"invalid_type","expected":"string","received":"undefined","path":["userInstruction"],"message":"Required"}],"name":"ZodError"},"msg":"Failed to enqueue AI revision job"}
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335850644,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768335850663,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335850669,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/api.ai.revise.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 1192[2mms[22m[39m
[90mstdout[2m | tests/ListTools.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w116
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/ListTools.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w116 (Reused: true)

{"level":30,"time":1768335851084,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ListTools.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335851143,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts[2m > [22m[2mDatavaultColumnsService[2m > [22m[2mgetColumns[2m > [22m[2mshould throw 404 if table not found
[22m[39m[DEBUG] Table not found: 660e8400-e29b-41d4-a716-446655440001

{"level":30,"time":1768335851205,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335851205,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

 [32mâœ“[39m tests/unit/schema/documentEngine.test.ts [2m([22m[2m33 tests[22m[2m)[22m[33m 1296[2mms[22m[39m
{"level":30,"time":1768335851300,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335851300,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

 [32mâœ“[39m tests/unit/services/DatavaultColumnsService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 1350[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w119
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w119 (Reused: true)

{"level":30,"time":1768335851437,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335851482,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w120
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w120 (Reused: true)

{"level":30,"time":1768335851578,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335851669,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":40,"time":1768335851675,"env":"test","sourceListVar":"nonexistent_list","inputKey":"nonexistent_list","msg":"Input list not found, treating as empty array"}
[90mstdout[2m | tests/ListTools.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335851677,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768335851679,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

{"level":30,"time":1768335851677,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
 [32mâœ“[39m tests/ListTools.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 1118[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768335852016,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335852017,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w124
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

 [32mâœ“[39m tests/integration/datavault.api-tokens.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 1083[2mms[22m[39m
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w124 (Reused: true)

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w122
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335852154,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w122 (Reused: true)

{"level":30,"time":1768335852185,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335852211,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335852232,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768335852269,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335852319,"env":"test","module":"ai-controller","userId":"user-123","workflowId":"123e4567-e89b-12d3-a456-426614174000","descriptionLength":26,"msg":"AI logic generation requested"}
{"level":30,"time":1768335852320,"env":"test","module":"ai-controller","userId":"user-123","workflowId":"123e4567-e89b-12d3-a456-426614174000","duration":3,"changeCount":0,"msg":"AI logic generation succeeded"}
{"level":30,"time":1768335852338,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768335852356,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768335852369,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335852370,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

 [32mâœ“[39m tests/unit/api.ai.logic.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 1282[2mms[22m[39m
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335852762,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335852763,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w117
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

 [32mâœ“[39m tests/unit/schema/collections.test.ts [2m([22m[2m34 tests[22m[2m)[22m[33m 1139[2mms[22m[39m
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w117 (Reused: true)

{"level":30,"time":1768335852842,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335852870,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335852871,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

 [32mâœ“[39m tests/integration/branding.routes.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 1169[2mms[22m[39m
{"level":30,"time":1768335852955,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w127
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w127 (Reused: true)

{"level":30,"time":1768335853201,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335853251,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w126
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w126 (Reused: true)

{"level":30,"time":1768335853336,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w128
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":30,"time":1768335853438,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w128 (Reused: true)

{"level":30,"time":1768335853478,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould skip question when condition is false
[22m[39m[DEBUG Question] Node q1 executed. Key: has_code, Value: false. Context keys: 3

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould execute question when condition is true
[22m[39m[DEBUG Question] Node q1 executed. Key: has_code, Value: true. Context keys: 4

{"level":30,"time":1768335853535,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould execute question when condition is true
[22m[39m[DEBUG Question] Node q2 executed. Key: code, Value: ABC123. Context keys: 5

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould skip compute node when condition is false
[22m[39m[DEBUG Question] Node q1 executed. Key: amount, Value: 0. Context keys: 3

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould execute compute node when condition is true
[22m[39m[DEBUG Question] Node q1 executed. Key: amount, Value: 100. Context keys: 3

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould handle complex workflow with multiple conditions
[22m[39m[DEBUG Question] Node q1 executed. Key: has_code, Value: false. Context keys: 4

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould handle complex workflow with multiple conditions
[22m[39m[DEBUG Question] Node q3 executed. Key: amount, Value: 1000. Context keys: 5

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mDebug Mode[2m > [22m[2mshould return trace when debug is enabled
[22m[39m[DEBUG Question] Node q1 executed. Key: name, Value: John. Context keys: 3

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mDebug Mode[2m > [22m[2mshould not return trace when debug is disabled
[22m[39m[DEBUG Question] Node q1 executed. Key: name, Value: John. Context keys: 3

{"level":30,"time":1768335853648,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335853649,"env":"test","msg":"DB: pool closed."}
{"level":40,"time":1768335853771,"env":"test","hookId":"hook-1","hookName":"Hook 1","error":"Test error","msg":"LifecycleHookService: Hook execution failed"}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":50,"time":1768335853776,"env":"test","error":{},"workflowId":"workflow-1","runId":"run-1","phase":"beforePage","msg":"LifecycleHookService: Failed to execute hooks for phase"}
{"level":30,"time":1768335853782,"env":"test","hookId":"hook-1","workflowId":"workflow-1","phase":"beforePage","msg":"LifecycleHookService: Created lifecycle hook"}
{"level":30,"time":1768335853790,"env":"test","hookId":"hook-1","workflowId":"workflow-1","msg":"LifecycleHookService: Updated lifecycle hook"}
{"level":30,"time":1768335853794,"env":"test","hookId":"hook-1","workflowId":"workflow-1","msg":"LifecycleHookService: Deleted lifecycle hook"}
{"level":30,"time":1768335853800,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768335853801,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/LifecycleHookService.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 1099[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

 [32mâœ“[39m tests/unit/engine.run-conditions.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 1345[2mms[22m[39m
{"level":30,"time":1768335853993,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335853994,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335854076,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768335854077,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

 [32mâœ“[39m tests/unit/repositories/DatavaultTablesRepository.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 1129[2mms[22m[39m
 [32mâœ“[39m tests/unit/services/StepService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 1139[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w125
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w125 (Reused: true)

{"level":30,"time":1768335854425,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335854505,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w121
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w131
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w121 (Reused: true)

{"level":30,"time":1768335854711,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w131 (Reused: true)

{"level":30,"time":1768335854739,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w132
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335854763,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335854789,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w132 (Reused: true)

{"level":30,"time":1768335854815,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335854865,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

{"level":30,"time":1768335855081,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335855082,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w133
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w133 (Reused: true)

{"level":30,"time":1768335855220,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

 [32mâœ“[39m tests/unit/debug_import.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 1179[2mms[22m[39m
{"level":30,"time":1768335855288,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335855327,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335855328,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335855338,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335855338,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335855400,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335855401,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/services/RecordService.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 1106[2mms[22m[39m
 [32mâœ“[39m tests/unit/services/DataSourceService.test.ts [2m([22m[2m9 tests[22m[2m)[22m[33m 1065[2mms[22m[39m
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w129
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w129 (Reused: true)

{"level":30,"time":1768335855524,"env":"test","msg":"DB: initializing... Local"}
 [32mâœ“[39m tests/integration/datavault.routes.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 1137[2mms[22m[39m
{"level":30,"time":1768335855585,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w123
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w123 (Reused: true)

{"level":30,"time":1768335855737,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w134
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w135
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w135 (Reused: true)

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w134 (Reused: true)

{"level":30,"time":1768335855826,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335855828,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768335855827,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335855843,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335855844,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335855875,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335855879,"env":"test","msg":"DB: initialized flag set."}
 [32mâœ“[39m tests/unit/repositories/DocumentTemplateRepository.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 1106[2mms[22m[39m
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w130
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":30,"time":1768335856155,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335856156,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w130 (Reused: true)

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335856166,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

{"level":30,"time":1768335856233,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

 [32mâœ“[39m tests/unit/workflow/PreviewExecution.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 1113[2mms[22m[39m
{"level":30,"time":1768335856373,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335856374,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335856417,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335856417,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335856455,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335856456,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/services/CollectionService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 1064[2mms[22m[39m
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w136
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

 [32mâœ“[39m tests/unit/services/DatavaultTablesService.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 1120[2mms[22m[39m
 [32mâœ“[39m tests/integration/datavault.row-notes.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 1132[2mms[22m[39m
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w136 (Reused: true)

{"level":30,"time":1768335856580,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w138
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":30,"time":1768335856635,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w138 (Reused: true)

{"level":30,"time":1768335856657,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335856711,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w137
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstderr[2m | tests/unit/debugging/Lineage.test.ts[2m > [22m[2mDebug & Lineage[2m > [22m[2mshould generate execution trace with lineage
[22m[39m[DEBUG Question] Node q1 executed. Key: userName, Value: Alice. Context keys: 3

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335856801,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w143
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

{"level":30,"time":1768335856802,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w137 (Reused: true)

{"level":30,"time":1768335856816,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w143 (Reused: true)

[90mstderr[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): Error: [vitest] No "closeDatabase" export is defined on the "../../server/db" mock. Did you forget to return it from "vi.mock"?
If you need to partially mock a module, you can use "importOriginal" helper inside:

    at VitestMocker.createError [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:311:17[90m)[39m
    at Object.get [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:384:16[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:139:34
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m {
  codeFrame: [32m'vi.mock(import("../../server/db"), async (importOriginal) => {\n'[39m +
    [32m'  const actual = await importOriginal()\n'[39m +
    [32m'  return {\n'[39m +
    [32m'    ...actual,\n'[39m +
    [32m'    // your mocked methods\n'[39m +
    [32m'  }\n'[39m +
    [32m'})'[39m
}

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335856878,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w139
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

 [32mâœ“[39m tests/unit/BlockRunner.validate.test.ts [2m([22m[2m7 tests[22m[2m)[22m[33m 505[2mms[22m[39m
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w139 (Reused: true)

{"level":30,"time":1768335856929,"env":"test","msg":"DB: initializing... Local"}
 [32mâœ“[39m tests/unit/debugging/Lineage.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 1151[2mms[22m[39m
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335856980,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768335857189,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335857190,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768335857263,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768335857264,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/lib/queries/QueryRunner.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 1091[2mms[22m[39m
[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

 [32mâœ“[39m tests/unit/services/CollectionFieldService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 1101[2mms[22m[39m
[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

{"level":30,"time":1768335857429,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335857430,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w140
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

 [32mâœ“[39m tests/unit/services/DocumentTemplateService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 1099[2mms[22m[39m
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w140 (Reused: true)

{"level":30,"time":1768335857533,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335857534,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768335857534,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

 [32mâœ“[39m tests/services/EmailTemplateMetadataService.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 1073[2mms[22m[39m
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335857596,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w141
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w142
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w141 (Reused: true)

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w142 (Reused: true)

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

{"level":30,"time":1768335857823,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335857872,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w147
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w147 (Reused: true)

[90mstderr[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): Error: [vitest] No "closeDatabase" export is defined on the "../../../server/db" mock. Did you forget to return it from "vi.mock"?
If you need to partially mock a module, you can use "importOriginal" helper inside:

    at VitestMocker.createError [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:311:17[90m)[39m
    at Object.get [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:384:16[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:139:34
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m {
  codeFrame: [32m'vi.mock(import("../../../server/db"), async (importOriginal) => {\n'[39m +
    [32m'  const actual = await importOriginal()\n'[39m +
    [32m'  return {\n'[39m +
    [32m'    ...actual,\n'[39m +
    [32m'    // your mocked methods\n'[39m +
    [32m'  }\n'[39m +
    [32m'})'[39m
}

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335857968,"env":"test","module":"write-runner","operation":"write_start","mode":"create","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"create","columnMappings":[{"columnId":"col-first","value":"{{ firstName }}"},{"columnId":"col-last","value":"Doe"},{"columnId":"col-age","value":"{{ age }}"}]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
{"level":30,"time":1768335857977,"env":"test","module":"write-runner","operation":"write_start","mode":"create","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"create","columnMappings":[]},"tableId":"table-users","preview":true,"msg":"Starting write execution"}
[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335857977,"env":"test","module":"write-runner","operation":"write_preview_simulated","values":{},"msg":"Simulating write in preview mode"}
{"level":30,"time":1768335857978,"env":"test","module":"write-runner","operation":"write_start","mode":"update","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"test@example.com","columnMappings":[{"columnId":"col-status","value":"Active"}]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
{"level":30,"time":1768335857980,"env":"test","module":"write-runner","operation":"write_start","mode":"update","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"missing@example.com","columnMappings":[]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
{"level":50,"time":1768335857980,"env":"test","module":"write-runner","error":{},"config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"missing@example.com","columnMappings":[]},"msg":"Write execution failed"}
 [32mâœ“[39m tests/unit/services/PortalAuthService.test.ts [2m([22m[2m42 tests[22m[2m)[22m[33m 651[2mms[22m[39m
 [32mâœ“[39m tests/unit/writes/WriteRunner.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 513[2mms[22m[39m
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w113
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w113 (Reused: true)

{"level":30,"time":1768335858119,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768335858128,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335858128,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/repositories/DatavaultColumnsRepository.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 1084[2mms[22m[39m
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mâœ… Database initialized for tests
â© Schema reused, skipping migrations.

{"level":30,"time":1768335858179,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w144
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w144 (Reused: true)

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768335858425,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335858426,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/services/BrandingService.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 1186[2mms[22m[39m
 [32mâœ“[39m tests/unit/services/AccountLockoutService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 548[2mms[22m[39m
[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w150
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w150 (Reused: true)

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/services/Guardrail.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 515[2mms[22m[39m
[90mstdout[2m | tests/unit/collab.server.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768335858752,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts[2m > [22m[2mPersonalization API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs
[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768335858763,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768335858764,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768335858773,"env":"test","module":"documents-routes","msg":"Document routes registered"}
[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w151
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w146
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w145
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w151 (Reused: true)

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w146 (Reused: true)

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

{"level":30,"time":1768335858867,"env":"test","msg":"External Send Completed","destination":"My Webhook","success":true,"status":200}
[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335858875,"env":"test","msg":"Simulating External Send","destination":"Test","payload":{}}
[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w145 (Reused: true)

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w148
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/external/ExternalSendRunner.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 500[2mms[22m[39m
 [32mâœ“[39m tests/unit/services/AuditLogService.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 500[2mms[22m[39m
 [32mâœ“[39m tests/unit/repositories/DatavaultRowsRepository.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 529[2mms[22m[39m
[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w148 (Reused: true)

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/services/BrandingService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 531[2mms[22m[39m
[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w149
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w149 (Reused: true)

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335859233,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768335859234,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/services/EmailTemplateMetadataService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 529[2mms[22m[39m
 [32mâœ“[39m tests/integration/api.ai.personalization.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 1647[2mms[22m[39m
[90mstdout[2m | tests/unit/collab.server.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w152
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w152 (Reused: true)

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/engine/FinalBlockSnapshot.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 489[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w153
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w153 (Reused: true)

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/services/DatavaultRowsService.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 528[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w154
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w154 (Reused: true)

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [2m[90mâ†“[39m[22m tests/unit/collab.server.test.ts [2m([22m[2m14 tests[22m[2m | [22m[33m14 skipped[39m[2m)[22m
 [32mâœ“[39m tests/unit/services/DatavaultReferenceColumns.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 467[2mms[22m[39m

[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m[1m[41m Failed Suites 1 [49m[22m[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m

[41m[1m FAIL [22m[49m tests/integration/lifecycle-hooks-execution.test.ts[2m > [22mLifecycle Hooks Execution
[31m[1merror[22m: null value in column "creator_id" of relation "workflows" violates not-null constraint[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m83:22[22m[39m
[36m [2mâ¯[22m tests/integration/lifecycle-hooks-execution.test.ts:[2m43:24[22m[39m
    [90m 41| [39m
    [90m 42| [39m    [90m// Create workflow with section and step[39m
    [90m 43| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m(
    [90m   | [39m                       [31m^[39m
    [90m 44| [39m      [34mcreateTestWorkflow[39m({
    [90m 45| [39m        projectId[33m:[39m ctx[33m.[39mprojectId[33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[1/7]âŽ¯[22m[39m


[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m[1m[41m Failed Tests 6 [49m[22m[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m

[41m[1m FAIL [22m[49m tests/integration/api.ai.doc.test.ts[2m > [22mAI Document Assistant API Integration Tests[2m > [22mPOST /api/ai/doc/analyze[2m > [22mshould analyze a DOCX file and return variables
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2mâ¯[22m tests/integration/api.ai.doc.test.ts:[2m143:37[22m[39m
    [90m141| [39m                } catch (e) { console.log("FAIL_BODY: " + response.texâ€¦
    [90m142| [39m            }
    [90m143| [39m            [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m144| [39m
    [90m145| [39m            [34mexpect[39m(response[33m.[39mbody[33m.[39mdata)[33m.[39m[34mtoHaveProperty[39m([32m"variables"[39m)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[2/7]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.ai.doc.test.ts[2m > [22mAI Document Assistant API Integration Tests[2m > [22mPOST /api/ai/doc/analyze[2m > [22mshould fail if no file is provided
[31m[1mError[22m: expected 400 "Bad Request", got 500 "Internal Server Error"[39m
[36m [2mâ¯[22m tests/integration/api.ai.doc.test.ts:[2m168:18[22m[39m
    [90m166| [39m            [35mawait[39m [34mrequest[39m(baseURL)
    [90m167| [39m                [33m.[39m[34mpost[39m([32m"/api/ai/doc/analyze"[39m)
    [90m168| [39m                [33m.[39m[34mexpect[39m([34m400[39m)[33m;[39m
    [90m   | [39m                 [31m^[39m
    [90m169| [39m        })[33m;[39m
    [90m170| [39m    })[33m;[39m
[90m [2mâ¯[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2mâ¯[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2mâ¯[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2mâ¯[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m156:7[22m[39m
[90m [2mâ¯[22m Test.Request.callback node_modules/superagent/lib/node/index.js:[2m857:3[22m[39m
[90m [2mâ¯[22m IncomingMessage.<anonymous> node_modules/superagent/lib/node/index.js:[2m1102:18[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[3/7]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.snapshots.test.ts[2m > [22mStage 13: Workflow Snapshots & Versioning[2m > [22mshould maintain immutability of runs across versions
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/api.snapshots.test.ts:[2m199:37[22m[39m
    [90m197| [39m        [90m// 7. Verify Run 1 still sees Version 1 Question[39m
    [90m198| [39m        [35mconst[39m run1Response [33m=[39m [35mawait[39m agent[33m.[39m[35mget[39m([32m`/api/runs/[39m[36m${[39mrun1[33m.[39mid[36m}[39m[32m`[39m)[33m;[39m
    [90m199| [39m        [34mexpect[39m(run1Response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m200| [39m        [35mconst[39m run1Graph [33m=[39m run1Response[33m.[39mbody[33m.[39mworkflowVersion[33m.[39mgraphJson[33m;[39m
    [90m201| [39m        expect(run1Graph.nodes[0].config.question).toBe('Version 1 Queâ€¦

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[4/7]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.templates-runs.test.ts[2m > [22mTemplates and Runs API Integration Tests[2m > [22mRuns API[2m > [22mPOST /api/workflows/:id/run[2m > [22mshould reject without required permission
[31m[1mError[22m: expected 201 "Created", got 400 "Bad Request"[39m
[36m [2mâ¯[22m tests/integration/api.templates-runs.test.ts:[2m289:12[22m[39m
    [90m287| [39m          [33m.[39m[34mpost[39m([32m"/api/auth/register"[39m)
    [90m288| [39m          [33m.[39m[34msend[39m({ email[33m:[39m viewerEmail[33m,[39m password[33m:[39m [32m"TestPassword123"[39m })
    [90m289| [39m          [33m.[39m[34mexpect[39m([34m201[39m)[33m;[39m
    [90m   | [39m           [31m^[39m
    [90m290| [39m
    [90m291| [39m        [35mawait[39m db[33m.[39m[34mupdate[39m(schema[33m.[39musers)
[90m [2mâ¯[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2mâ¯[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2mâ¯[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2mâ¯[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m156:7[22m[39m
[90m [2mâ¯[22m Test.Request.callback node_modules/superagent/lib/node/index.js:[2m857:3[22m[39m
[90m [2mâ¯[22m node_modules/superagent/lib/node/index.js:[2m1102:18[22m[39m
[90m [2mâ¯[22m IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:[2m21:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[5/7]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/js_helpers.test.ts[2m > [22mDetailed Verification: JS Helper Availability[2m > [22mshould execute a JS block that uses helper functions
[31m[1mAssertionError[22m: expected 401 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/js_helpers.test.ts:[2m136:31[22m[39m
    [90m134| [39m        [90m// 3. Create a Run[39m
    [90m135| [39m        const runRes = await agent.post(`/api/workflows/${workflowId}/â€¦
    [90m136| [39m        [34mexpect[39m(runRes[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m [90m// 201 Created[39m
    [90m   | [39m                              [31m^[39m
    [90m137| [39m        [35mconst[39m runId [33m=[39m runRes[33m.[39mbody[33m.[39mid[33m;[39m
    [90m138| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[6/7]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/ui/expression-editor.test.tsx[2m > [22mExpression Editor Hooks[2m > [22museExpressionValidation[2m > [22mshould validate expression after debounce
[31m[1mAssertionError[22m: expected null not to be null

Ignored nodes: comments, script, style
[36m<html>[31m
  [36m<head />[31m
  [36m<body>[31m
    [36m<div />[31m
  [36m</body>[31m
[36m</html>[31m[39m
[36m [2mâ¯[22m timeout tests/ui/expression-editor.test.tsx:[2m74:55[22m[39m
    [90m 72| [39m      [35mawait[39m [34mwaitFor[39m(
    [90m 73| [39m        () [33m=>[39m {
    [90m 74| [39m          [34mexpect[39m(result[33m.[39mcurrent[33m.[39mvalidationResult)[33m.[39mnot[33m.[39m[34mtoBeNull[39m()[33m;[39m
    [90m   | [39m                                                      [31m^[39m
    [90m 75| [39m        }[33m,[39m
    [90m 76| [39m        { timeout[33m:[39m [34m200[39m }
[90m [2mâ¯[22m runWithExpensiveErrorDiagnosticsDisabled node_modules/@testing-library/dom/dist/config.js:[2m47:12[22m[39m
[90m [2mâ¯[22m checkCallback node_modules/@testing-library/dom/dist/wait-for.js:[2m124:77[22m[39m
[90m [2mâ¯[22m Timeout.checkRealTimersCallback node_modules/@testing-library/dom/dist/wait-for.js:[2m118:16[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[7/7]âŽ¯[22m[39m


[2m Test Files [22m [1m[31m6 failed[39m[22m[2m | [22m[1m[32m149 passed[39m[22m[2m | [22m[33m1 skipped[39m[90m (156)[39m
[2m      Tests [22m [1m[31m6 failed[39m[22m[2m | [22m[1m[32m2593 passed[39m[22m[2m | [22m[33m35 skipped[39m[90m (2634)[39m
[2m   Start at [22m 14:22:41
[2m   Duration [22m 106.42s[2m (transform 62.62s, setup 24.03s, import 351.83s, tests 931.74s, environment 28.48s)[22m

