npm warn Unknown project config "puppeteer_skip_download". This will stop working in the next major version of npm.

[1m[46m RUN [49m[22m [36mv4.0.16 [39m[90mC:/Users/scoot/poll/VaultLogic[39m

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768329401950,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768329401972,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

stderr | tests/integration/analytics_service.test.ts > Analytics Service Integration
MANUAL PATCH FAILED error: insert or update on table "workflow_run_events" violates foreign key constraint "workflow_run_events_run_id_workflow_runs_id_fk"
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/analytics_service.test.ts:20:13 {
  length: 368,
  severity: 'ERROR',
  code: '23503',
  detail: 'Key (run_id)=(e3d9b8a7-c81c-4d27-9e34-1a20aaa70925) is not present in table "workflow_runs".',
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: 'public',
  table: 'workflow_run_events',
  column: undefined,
  dataType: undefined,
  constraint: 'workflow_run_events_run_id_workflow_runs_id_fk',
  file: 'ri_triggers.c',
  line: '2599',
  routine: 'ri_ReportViolation'
}

{"level":30,"time":1768329404656,"env":"test","module":"writeback-execution-service","runId":"bf5bddb4-77d7-4568-b1c7-2e400a87a040","workflowId":"5205e086-f6f0-4a1c-a2b9-e23049a85d33","msg":"Executing writeback mappings for completed run"}
{"level":30,"time":1768329404706,"env":"test","runId":"bf5bddb4-77d7-4568-b1c7-2e400a87a040","service":"DocumentGenerationService","msg":"Starting document generation for run"}
{"level":40,"time":1768329404799,"env":"test","runId":"bf5bddb4-77d7-4568-b1c7-2e400a87a040","service":"DocumentGenerationService","allSections":[],"runId":"bf5bddb4-77d7-4568-b1c7-2e400a87a040","msg":"No Final Documents sections found, skipping generation. This might cause the frontend to hang."}
{"level":30,"time":1768329404799,"env":"test","runId":"bf5bddb4-77d7-4568-b1c7-2e400a87a040","msg":"Documents generated successfully"}
{"level":50,"time":1768329405135,"env":"test","error":{"length":345,"name":"error","severity":"ERROR","code":"23503","detail":"Key (run_id)=(bf5bddb4-77d7-4568-b1c7-2e400a87a040) is not present in table \"runs\".","schema":"public","table":"workflow_run_metrics","constraint":"workflow_run_metrics_run_id_runs_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"},"runId":"bf5bddb4-77d7-4568-b1c7-2e400a87a040","msg":"Failed to aggregate run metrics"}
{"level":30,"time":1768329406433,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768329406434,"env":"test","msg":"DB: pool closed."}
 [31mÎ“Â¥Â»[39m tests/integration/analytics_service.test.ts [2m([22m[2m1 test[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 4485[2mms[22m[39m
[31m     [31mâ”œÃ¹[31m should generate events and metrics on run completion[39m[33m 2848[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/analytics_service.test.ts > Analytics Service Integration > should generate events and metrics on run completion
AssertionError: expected +0 to be 1 // Object.is equality

- Expected
+ Received

- 1
+ 0

 Î“Â¥Â» tests/integration/analytics_service.test.ts:95:32
     93| 
     94|         const metrics = await db.select().from(workflowRunMetrics).wheÎ“Ã‡Âª
     95|         expect(metrics.length).toBe(1);
       |                                ^
     96|         expect(metrics[0].completed).toBe(true);
     97|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/1]Î“Ã„Â»


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m   Start at [22m 12:36:39
[2m   Duration [22m 6.83s[2m (transform 917ms, setup 154ms, import 1.81s, tests 4.49s, environment 0ms)[22m

