npm warn Unknown project config "puppeteer_skip_download". This will stop working in the next major version of npm.

[1m[46m RUN [49m[22m [36mv4.0.16 [39m[90mC:/Users/scoot/poll/VaultLogic[39m

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w0

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0,public

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0%2Cpublic

{"level":30,"time":1768481134182,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768481134205,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“Â£Ã  Enforced search_path: test_schema_w0, public

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“Â£Ã  Database initialized. Current schema: test_schema_w0
â‰¡Æ’Ã¶Ã¤ Running test migrations (manual file mode due to broken journal)...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0000_daffy_roughhouse.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0001_remove_participants.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0002_add_mode_columns.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0003_add_step_aliases.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in 0003_add_step_aliases.sql (Error: column "alias" of relation "steps" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0004_add_teams_and_acls.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in 0004_add_teams_and_acls.sql (Error: column "owner_id" of relation "projects" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0005_add_transform_block_phases.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in 0005_add_transform_block_phases.sql (Error: column "phase" of relation "transform_blocks" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0006_add_updated_at_columns.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0007_add_js_question_type.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0007_lying_namor.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in 0007_lying_namor.sql (Error: relation "sections" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0008_add_virtual_steps_for_transform_blocks.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0009_add_multi_tenant_data_model.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0009_real_vapor.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in 0009_real_vapor.sql (Error: constraint "workflow_run_events_run_id_workflow_runs_id_fk" for relation "workflow_run_events" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0010_add_external_connections_and_secret_types.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in 0010_add_external_connections_and_secret_types.sql (Error: type "secret_type" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0010_nullable_creator_owner.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0011_add_trace_and_error_to_runs.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0012_add_analytics_sli_tables.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in 0012_add_analytics_sli_tables.sql (Error: type "metrics_event_type" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0013_add_intake_portal_columns.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0014_add_workflow_versioning_columns.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0015_add_intake_config.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0016_add_review_and_esign_tables.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0017_add_connections_table.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0018_add_branding_and_domains.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0019_add_collections_datastore.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0020_add_collection_block_types.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0021_add_page_conditions.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in 0021_add_page_conditions.sql (Error: column "visible_if" of relation "sections" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0022_add_question_conditions.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in 0022_add_question_conditions.sql (Error: column "visible_if" of relation "steps" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0023_add_repeater_type.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0024_add_document_engine_tables.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in 0024_add_document_engine_tables.sql (Error: type "output_status" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0024_add_performance_indexes.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0025_fix_workflows_missing_columns.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0026_fix_schema_inconsistencies.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0027_fix_metrics_rollups_unique_index.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0028_fix_workflow_status_enum.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0029_add_datavault_tables.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in 0029_add_datavault_tables.sql (Error: type "datavault_column_type" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0030_add_auto_number_column_type.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0031_fix_survey_status_enum.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0032_add_primary_key_and_unique_columns.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in 0032_add_primary_key_and_unique_columns.sql (Error: column "is_primary_key" of relation "datavault_columns" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0033_add_datavault_databases.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in 0033_add_datavault_databases.sql (Error: type "datavault_scope_type" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0034_add_reference_columns.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0035_add_datavault_sequences.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0036_add_column_descriptions.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0036_add_reference_cascade_policy.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0037_add_column_width.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0038_add_row_archiving.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0039_add_select_multiselect_columns.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0040_add_autonumber_enhancements.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in 0040_add_autonumber_enhancements.sql (Error: type "autonumber_reset_policy" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0041_add_datavault_row_notes.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0042_add_datavault_api_tokens.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in 0042_add_datavault_api_tokens.sql (Error: relation "idx_datavault_api_tokens_database_id" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0043_add_datavault_table_permissions.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in 0043_add_datavault_table_permissions.sql (Error: type "datavault_table_role" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0044_add_step_default_values.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0045_sync_project_created_by.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0046_add_final_documents_step_type.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0046_fix_workflow_runs_section_constraint.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0047_add_run_generated_documents_table.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0048_fix_autonumber_function.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0048_sync_project_tenant_from_creator.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0049_add_format_to_autonumber.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0049_add_sections_config_column.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0050_add_workflow_snapshots.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in 0050_add_workflow_snapshots.sql (Error: relation "workflow_snapshots" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0051_add_new_block_types.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0051_add_snapshot_version_hash.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in 0051_add_snapshot_version_hash.sql (Error: column "version_hash" of relation "workflow_snapshots" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0052_add_scripting_system.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in 0052_add_scripting_system.sql (Error: type "lifecycle_hook_phase" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0053_upgrade_data_sources.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0054_create_workflow_queries.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0055_add_query_block_support.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in 0055_add_query_block_support.sql (Error: column "virtual_step_id" of relation "blocks" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0056_add_datavault_block_types.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0057_add_step_values_composite_index.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0058_add_logic_rules_indexes.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0059_add_performance_indexes.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0060_flashy_jimmy_woo.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in 0060_flashy_jimmy_woo.sql (Error: column "is_placeholder" of relation "users" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0061_optimize_query_performance.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0062_archive_and_remove_surveys.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying 0063_fix_ai_settings.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in 0063_fix_ai_settings.sql (Error: enum label "github" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying add_invite_email_tracking.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying add_organization_ownership.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying add_organization_tenant_scoping.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying add_performance_indexes.sql...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Partial failure in add_performance_indexes.sql (Error: relation "step_values_run_step_unique" already exists), retrying statement-by-statement...

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m   Applying add_runs_ownership.sql...

stderr | tests/integration/ai/workflowEdit.test.ts
Î“Â¥Ã® FAILED MIGRATION add_runs_ownership.sql: relation "workflowRuns" does not exist
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: relation "workflowRuns" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg-pool\index.js:45:11
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:185:19 {
  length: 110,
  severity: 'ERROR',
  code: '42P01',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'namespace.c',
  line: '637',
  routine: 'RangeVarGetRelidExtended'
}

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mDEBUG: Existing functions: [
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy"
    ],
    "proargtypes": "2950 2950 2950 25 23 25",
    "signature": "public.datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy"
    ],
    "proargtypes": "2950 2950 2950 25 23 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text)"
  },
  {
    "proname": "datavault_get_next_autonumber",
    "proargnames": [
      "p_tenant_id",
      "p_table_id",
      "p_column_id",
      "p_prefix",
      "p_padding",
      "p_reset_policy",
      "p_format"
    ],
    "proargtypes": "2950 2950 2950 25 23 25 25",
    "signature": "datavault_get_next_autonumber(uuid,uuid,uuid,text,integer,text,text)"
  }
]

{"level":30,"time":1768481208186,"env":"test","workflowId":"f3a6db14-b81c-4417-a27d-b5efb779f8cb","userId":"546379af-623c-4e8b-a65f-ee2785aa544c","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts[2m > [22m[2mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22m[2mshould create draft version on successful AI edit
[22m[39mDEBUG: Instantiating GoogleGenerativeAI
DEBUG: Getting model
DEBUG: Building system prompt
DEBUG: Building workflow context
DEBUG: Workflow context built
DEBUG: About to build full prompt. Parts: { s: [32m'string'[39m, w: [32m'string'[39m, u: [32m'string'[39m }
DEBUG: Full prompt built. Length: [33m1685[39m

{"level":30,"time":1768481208622,"env":"test","workflowId":"f3a6db14-b81c-4417-a27d-b5efb779f8cb","userId":"546379af-623c-4e8b-a65f-ee2785aa544c","sectionsCount":1,"stepsCount":1,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":50,"time":1768481208776,"env":"test","module":"ai-workflow-edit-routes","error":{},"workflowId":"f3a6db14-b81c-4417-a27d-b5efb779f8cb","msg":"Error in AI workflow edit"}
{"level":30,"time":1768481208974,"env":"test","workflowId":"f836642b-e20c-472d-9aac-7acd33258466","userId":"546379af-623c-4e8b-a65f-ee2785aa544c","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts[2m > [22m[2mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22m[2mshould enforce draft mode (revert active workflow to draft)
[22m[39mDEBUG: Instantiating GoogleGenerativeAI
DEBUG: Getting model
DEBUG: Building system prompt
DEBUG: Building workflow context
DEBUG: Workflow context built
DEBUG: About to build full prompt. Parts: { s: [32m'string'[39m, w: [32m'string'[39m, u: [32m'string'[39m }
DEBUG: Full prompt built. Length: [33m1656[39m

{"level":30,"time":1768481209394,"env":"test","workflowId":"f836642b-e20c-472d-9aac-7acd33258466","userId":"546379af-623c-4e8b-a65f-ee2785aa544c","sectionsCount":1,"stepsCount":1,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":50,"time":1768481209542,"env":"test","module":"ai-workflow-edit-routes","error":{},"workflowId":"f836642b-e20c-472d-9aac-7acd33258466","msg":"Error in AI workflow edit"}
{"level":30,"time":1768481209687,"env":"test","workflowId":"e9a616f0-5149-4a1e-a3cd-3b1d10190bda","userId":"546379af-623c-4e8b-a65f-ee2785aa544c","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts[2m > [22m[2mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22m[2mshould not create version when no changes detected (checksum match)
[22m[39mDEBUG: Instantiating GoogleGenerativeAI
DEBUG: Getting model
DEBUG: Building system prompt
DEBUG: Building workflow context
DEBUG: Workflow context built
DEBUG: About to build full prompt. Parts: { s: [32m'string'[39m, w: [32m'string'[39m, u: [32m'string'[39m }
DEBUG: Full prompt built. Length: [33m1651[39m

{"level":30,"time":1768481210108,"env":"test","workflowId":"e9a616f0-5149-4a1e-a3cd-3b1d10190bda","userId":"546379af-623c-4e8b-a65f-ee2785aa544c","sectionsCount":1,"stepsCount":1,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":50,"time":1768481210245,"env":"test","module":"ai-workflow-edit-routes","error":{},"workflowId":"e9a616f0-5149-4a1e-a3cd-3b1d10190bda","msg":"Error in AI workflow edit"}
{"level":30,"time":1768481210439,"env":"test","workflowId":"99286524-6e35-4150-884f-f4fc234686d4","userId":"546379af-623c-4e8b-a65f-ee2785aa544c","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts[2m > [22m[2mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22m[2mshould reject unsafe DataVault operations
[22m[39mDEBUG: Instantiating GoogleGenerativeAI
DEBUG: Getting model
DEBUG: Building system prompt
DEBUG: Building workflow context
DEBUG: Workflow context built
DEBUG: About to build full prompt. Parts: { s: [32m'string'[39m, w: [32m'string'[39m, u: [32m'string'[39m }
DEBUG: Full prompt built. Length: [33m1647[39m

{"level":50,"time":1768481210535,"env":"test","module":"ai-workflow-edit-routes","errors":["Validation failed for datavault.dropTable: Invalid operation schema: Invalid discriminator value. Expected 'workflow.setMetadata' | 'section.create' | 'section.update' | 'section.delete' | 'section.reorder' | 'step.create' | 'step.update' | 'step.delete' | 'step.move' | 'step.setVisibleIf' | 'step.setRequired' | 'logicRule.create' | 'logicRule.update' | 'logicRule.delete' | 'document.add' | 'document.update' | 'document.setConditional' | 'document.bindFields' | 'datavault.createTable' | 'datavault.addColumns' | 'datavault.createWritebackMapping'"],"workflowId":"99286524-6e35-4150-884f-f4fc234686d4","msg":"Failed to apply some AI operations"}
{"level":30,"time":1768481210686,"env":"test","workflowId":"527a4dea-29bb-4c0a-8499-72adae5a7bc5","userId":"546379af-623c-4e8b-a65f-ee2785aa544c","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts[2m > [22m[2mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22m[2mshould handle multi-operation edits with tempId resolution
[22m[39mDEBUG: Instantiating GoogleGenerativeAI
DEBUG: Getting model
DEBUG: Building system prompt
DEBUG: Building workflow context
DEBUG: Workflow context built
DEBUG: About to build full prompt. Parts: { s: [32m'string'[39m, w: [32m'string'[39m, u: [32m'string'[39m }
DEBUG: Full prompt built. Length: [33m1725[39m

{"level":30,"time":1768481211304,"env":"test","workflowId":"527a4dea-29bb-4c0a-8499-72adae5a7bc5","userId":"546379af-623c-4e8b-a65f-ee2785aa544c","sectionsCount":1,"stepsCount":2,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":50,"time":1768481211453,"env":"test","module":"ai-workflow-edit-routes","error":{},"workflowId":"527a4dea-29bb-4c0a-8499-72adae5a7bc5","msg":"Error in AI workflow edit"}
{"level":30,"time":1768481211595,"env":"test","workflowId":"83b8c7a4-3e55-4eb6-9bc6-2cc47bc512b9","userId":"546379af-623c-4e8b-a65f-ee2785aa544c","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts[2m > [22m[2mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22m[2mshould create BEFORE and AFTER snapshots
[22m[39mDEBUG: Instantiating GoogleGenerativeAI
DEBUG: Getting model
DEBUG: Building system prompt
DEBUG: Building workflow context
DEBUG: Workflow context built
DEBUG: About to build full prompt. Parts: { s: [32m'string'[39m, w: [32m'string'[39m, u: [32m'string'[39m }
DEBUG: Full prompt built. Length: [33m1650[39m

{"level":30,"time":1768481212025,"env":"test","workflowId":"83b8c7a4-3e55-4eb6-9bc6-2cc47bc512b9","userId":"546379af-623c-4e8b-a65f-ee2785aa544c","sectionsCount":1,"stepsCount":1,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
{"level":50,"time":1768481212162,"env":"test","module":"ai-workflow-edit-routes","error":{},"workflowId":"83b8c7a4-3e55-4eb6-9bc6-2cc47bc512b9","msg":"Error in AI workflow edit"}
{"level":30,"time":1768481212455,"env":"test","workflowId":"34370be3-2db4-4ffe-aba1-7454c030cec4","userId":"546379af-623c-4e8b-a65f-ee2785aa544c","sectionsCount":1,"stepsCount":1,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts[2m > [22m[2mPOST /api/workflows/:workflowId/ai/edit - Integration Test[2m > [22m[2mshould rollback on validation failure
[22m[39mDEBUG: Instantiating GoogleGenerativeAI
DEBUG: Getting model
DEBUG: Building system prompt
DEBUG: Building workflow context
DEBUG: Workflow context built
DEBUG: About to build full prompt. Parts: { s: [32m'string'[39m, w: [32m'string'[39m, u: [32m'string'[39m }
DEBUG: Full prompt built. Length: [33m1739[39m

{"level":50,"time":1768481212593,"env":"test","module":"ai-workflow-edit-routes","errors":["Validation failed for step.create: Step alias 'email' already exists"],"workflowId":"34370be3-2db4-4ffe-aba1-7454c030cec4","msg":"Failed to apply some AI operations"}
{"level":30,"time":1768481213033,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768481213034,"env":"test","msg":"DB: pool closed."}
 [31mÎ“Â¥Â»[39m tests/integration/ai/workflowEdit.test.ts [2m([22m[2m8 tests[22m[2m | [22m[31m5 failed[39m[2m)[22m[33m 79333[2mms[22m[39m
[31m     [31mâ”œÃ¹[31m should create draft version on successful AI edit[39m[33m 1057[2mms[22m[39m
[31m     [31mâ”œÃ¹[31m should enforce draft mode (revert active workflow to draft)[39m[33m 763[2mms[22m[39m
[31m     [31mâ”œÃ¹[31m should not create version when no changes detected (checksum match)[39m[33m 702[2mms[22m[39m
     [32mÎ“Â£Ã´[39m should reject unauthorized access[32m 52[2mms[22m[39m
     [32mÎ“Â£Ã´[39m should reject unsafe DataVault operations[32m 239[2mms[22m[39m
[31m     [31mâ”œÃ¹[31m should handle multi-operation edits with tempId resolution[39m[33m 917[2mms[22m[39m
[31m     [31mâ”œÃ¹[31m should create BEFORE and AFTER snapshots[39m[33m 709[2mms[22m[39m
     [33m[2mÎ“Â£Ã´[22m[39m should rollback on validation failure [33m 523[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 5 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/ai/workflowEdit.test.ts > POST /api/workflows/:workflowId/ai/edit - Integration Test > should create draft version on successful AI edit
Error: expected 200 "OK", got 500 "Internal Server Error"
 Î“Â¥Â» tests/integration/ai/workflowEdit.test.ts:182:8
    180|         },
    181|       })
    182|       .expect(200);
       |        ^
    183| 
    184|     expect(response.body.success).toBe(true);
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» Server.<anonymous> node_modules/supertest/lib/test.js:152:11

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/5]Î“Ã„Â»

 FAIL  tests/integration/ai/workflowEdit.test.ts > POST /api/workflows/:workflowId/ai/edit - Integration Test > should enforce draft mode (revert active workflow to draft)
Error: expected 200 "OK", got 500 "Internal Server Error"
 Î“Â¥Â» tests/integration/ai/workflowEdit.test.ts:222:8
    220|         userMessage: 'Add a phone number field',
    221|       })
    222|       .expect(200);
       |        ^
    223| 
    224|     // Verify workflow is now draft
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» Server.<anonymous> node_modules/supertest/lib/test.js:152:11

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/5]Î“Ã„Â»

 FAIL  tests/integration/ai/workflowEdit.test.ts > POST /api/workflows/:workflowId/ai/edit - Integration Test > should not create version when no changes detected (checksum match)
Error: expected 200 "OK", got 500 "Internal Server Error"
 Î“Â¥Â» tests/integration/ai/workflowEdit.test.ts:239:8
    237|         userMessage: 'Add contact section',
    238|       })
    239|       .expect(200);
       |        ^
    240| 
    241|     const versionId1 = response1.body.data.versionId;
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» Server.<anonymous> node_modules/supertest/lib/test.js:152:11

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/5]Î“Ã„Â»

 FAIL  tests/integration/ai/workflowEdit.test.ts > POST /api/workflows/:workflowId/ai/edit - Integration Test > should handle multi-operation edits with tempId resolution
Error: expected 200 "OK", got 500 "Internal Server Error"
 Î“Â¥Â» tests/integration/ai/workflowEdit.test.ts:393:8
    391|         userMessage: 'Add emergency contact section with name and phonÎ“Ã‡Âª
    392|       })
    393|       .expect(200);
       |        ^
    394| 
    395|     expect(response.body.success).toBe(true);
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» Server.<anonymous> node_modules/supertest/lib/test.js:152:11

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/5]Î“Ã„Â»

 FAIL  tests/integration/ai/workflowEdit.test.ts > POST /api/workflows/:workflowId/ai/edit - Integration Test > should create BEFORE and AFTER snapshots
Error: expected 200 "OK", got 500 "Internal Server Error"
 Î“Â¥Â» tests/integration/ai/workflowEdit.test.ts:430:8
    428|         userMessage: 'Add a simple field',
    429|       })
    430|       .expect(200);
       |        ^
    431| 
    432|     const versionId = response.body.data.versionId;
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» Server.<anonymous> node_modules/supertest/lib/test.js:152:11

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/5]Î“Ã„Â»


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m5 failed[39m[22m[2m | [22m[1m[32m3 passed[39m[22m[90m (8)[39m
[2m   Start at [22m 06:45:32
[2m   Duration [22m 81.03s[2m (transform 623ms, setup 164ms, import 1.13s, tests 79.33s, environment 0ms)[22m

