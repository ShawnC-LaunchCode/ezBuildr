npm warn Unknown project config "puppeteer_skip_download". This will stop working in the next major version of npm.

> ezbuildr@1.0.0 test
> cross-env VITEST_INTEGRATION=true vitest run --coverage --run


[1m[46m RUN [49m[22m [36mv4.0.16 [39m[90mC:/Users/scoot/poll/VaultLogic[39m
      [2mCoverage enabled with [22m[33mv8[39m

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w4

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w4,public

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w11

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w4 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w4%2Cpublic

{"level":30,"time":1768495824264,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w8

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w13

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w11,public

[90mstderr[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w8,public

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w13,public

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w11 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w11%2Cpublic

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495824380,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495824380,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w8 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w8%2Cpublic

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w10

{"level":30,"time":1768495824406,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w13 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w13%2Cpublic

{"level":30,"time":1768495824412,"env":"test","msg":"DB: initializing... Local"}
 [31m‚ùØ[39m tests/unit/repositories/WorkflowTemplateRepository.test.ts [2m([22m[2m19 tests[22m[2m | [22m[31m19 failed[39m[2m)[22m[33m 684[2mms[22m[39m
[31m       [31m√ó[31m should create a workflow template mapping[39m[32m 5[2mms[22m[39m
[31m       [31m√ó[31m should create non-primary mapping by default[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should find all templates for a workflow version[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should return empty array for version with no templates[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should order by createdAt desc (newest first)[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should find mapping by workflow version and key[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should return undefined for non-existent key[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should find primary template for workflow version[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should return undefined when no primary template exists[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should set a template as primary and unset others[39m[32m 19[2mms[22m[39m
[31m       [31m√ó[31m should handle setting primary when none existed before[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should not delete mapping if workflow version does not match[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should return true if key exists in workflow version[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should return false if key does not exist[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should exclude specified id when checking existence[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should return true if key exists on different mapping[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should update mapping fields[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should find mapping by id[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should return undefined for non-existent id[39m[32m 1[2mms[22m[39m
[90mstderr[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstderr[2m | tests/integration/organizationService.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/integration/organizationInvites.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495824500,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495824501,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w10,public

 [31m‚ùØ[39m tests/unit/services/PdfQueueService.test.ts [2m([22m[2m15 tests[22m[2m | [22m[33m15 skipped[39m[2m)[22m[33m 597[2mms[22m[39m
       [2m[90m‚Üì[39m[22m should enqueue a PDF conversion job
       [2m[90m‚Üì[39m[22m should create output with empty storagePath initially
       [2m[90m‚Üì[39m[22m should return job status for pending job
       [2m[90m‚Üì[39m[22m should return null for non-existent job
       [2m[90m‚Üì[39m[22m should parse attempt count from error field
       [2m[90m‚Üì[39m[22m should convert DOCX to PDF immediately
       [2m[90m‚Üì[39m[22m should handle conversion errors gracefully
       [2m[90m‚Üì[39m[22m should start and stop service
       [2m[90m‚Üì[39m[22m should not start if already running
       [2m[90m‚Üì[39m[22m should handle stop when not running
       [2m[90m‚Üì[39m[22m should process pending jobs when queue is processed
       [2m[90m‚Üì[39m[22m should process multiple jobs in batch
       [2m[90m‚Üì[39m[22m should handle missing DOCX output gracefully
       [2m[90m‚Üì[39m[22m should support enqueue within transaction
       [2m[90m‚Üì[39m[22m should support convertImmediate within transaction
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495824514,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495824514,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w10 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w10%2Cpublic

 [31m‚ùØ[39m tests/integration/organizationService.test.ts [2m([22m[2m13 tests[22m[2m | [22m[31m13 failed[39m[2m)[22m[33m 626[2mms[22m[39m
[31m       [31m√ó[31m should create organization and auto-create admin membership[39m[32m 5[2mms[22m[39m
[31m       [31m√ó[31m should return all organizations for user[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should return empty array for user with no memberships[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should allow admin to update organization[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should deny non-admin from updating organization[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should return all members of organization[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should allow admin to promote member[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should allow admin to demote other admin[39m[32m 0[2mms[22m[39m
[31m       [31m√ó[31m should prevent self-demotion[39m[32m 0[2mms[22m[39m
[31m       [31m√ó[31m should allow admin to remove member[39m[32m 0[2mms[22m[39m
[31m       [31m√ó[31m should prevent self-removal[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should allow member to leave organization[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should allow admin to leave organization[39m[32m 0[2mms[22m[39m
{"level":30,"time":1768495824553,"env":"test","msg":"DB: initializing... Local"}
 [31m‚ùØ[39m tests/integration/organizationInvites.test.ts [2m([22m[2m17 tests[22m[2m | [22m[31m17 failed[39m[2m)[22m[33m 634[2mms[22m[39m
[31m       [31m√ó[31m should create placeholder user for non-existent email[39m[32m 4[2mms[22m[39m
[31m       [31m√ó[31m should create invite for existing user without creating placeholder[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should prevent duplicate pending invites[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should prevent inviting existing members[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should require admin access to create invite[39m[32m 0[2mms[22m[39m
[31m       [31m√ó[31m should set expiry to 7 days from now[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should accept invite and create membership[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should convert placeholder user to real user on accept[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should reject expired invite[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should reject already accepted invite[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should verify email matches invite[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should reject invalid token[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should return pending invites for user email[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should not return expired invites[39m[32m 0[2mms[22m[39m
[31m       [31m√ó[31m should not return accepted invites[39m[32m 0[2mms[22m[39m
[31m       [31m√ó[31m should allow admin to revoke invite[39m[32m 0[2mms[22m[39m
[31m       [31m√ó[31m should prevent accepting revoked invite[39m[32m 0[2mms[22m[39m
[90mstderr[2m | tests/unit/engine/templateNode.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w5

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w1

{"level":30,"time":1768495824664,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495824664,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/unit/engine/templateNode.test.ts [2m([22m[2m17 tests[22m[2m | [22m[31m17 failed[39m[2m)[22m[33m 636[2mms[22m[39m
[31m       [31m√ó[31m should resolve template by key from workflowTemplates mapping[39m[32m 9[2mms[22m[39m
[31m       [31m√ó[31m should throw error if template key not found[39m[32m 3[2mms[22m[39m
[31m       [31m√ó[31m should store output in runOutputs table[39m[32m 2[2mms[22m[39m
[31m       [31m√ó[31m should resolve template by templateId directly[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should throw error if templateId not found[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should use docxRenderer2 by default (v2 engine)[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should use legacy engine when engine="legacy"[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should generate PDF when toPdf=true[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should default to DOCX when toPdf=false[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should skip execution when condition evaluates to false[39m[32m 2[2mms[22m[39m
[31m       [31m√ó[31m should execute when condition evaluates to true[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should resolve simple bindings[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should handle binding resolution errors gracefully[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should record failed output in runOutputs table[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should not throw errors (should return error in result)[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should deny access to templates from different tenant[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should require either templateKey or templateId[39m[32m 1[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w5,public

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w1,public

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w5 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w5%2Cpublic

{"level":30,"time":1768495824795,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w1 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w1%2Cpublic

{"level":30,"time":1768495824801,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495824860,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495824860,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/integration/transferOwnership.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

 [31m‚ùØ[39m tests/integration/datavault.autonumber.test.ts [2m([22m[2m5 tests[22m[2m | [22m[33m5 skipped[39m[2m)[22m[33m 605[2mms[22m[39m
     [2m[90m‚Üì[39m[22m should generate basic autonumber without prefix
     [2m[90m‚Üì[39m[22m should generate autonumber with prefix
     [2m[90m‚Üì[39m[22m should generate autonumber with yearly reset format
     [2m[90m‚Üì[39m[22m should be atomic and prevent race conditions
     [2m[90m‚Üì[39m[22m should prevent manual updates to autonumber values
{"level":30,"time":1768495824950,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495824951,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/integration/transferOwnership.test.ts [2m([22m[2m11 tests[22m[2m | [22m[31m11 failed[39m[2m)[22m[33m 694[2mms[22m[39m
[31m       [31m√ó[31m should transfer user-owned project to org[39m[32m 11[2mms[22m[39m
[31m       [31m√ó[31m should prevent transfer to org if user is not a member[39m[32m 2[2mms[22m[39m
[31m       [31m√ó[31m should allow org member to transfer org-owned project to another org they belong to[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should detach workflow from project when transferring to different owner[39m[32m 2[2mms[22m[39m
[31m       [31m√ó[31m should keep workflow in project when transferring to same owner[39m[32m 2[2mms[22m[39m
[31m       [31m√ó[31m should prevent non-member from transferring org workflow[39m[32m 0[2mms[22m[39m
[31m       [31m√ó[31m should transfer database ownership[39m[32m 0[2mms[22m[39m
[31m       [31m√ó[31m should allow org member to transfer org database[39m[32m 0[2mms[22m[39m
[31m       [31m√ó[31m should prevent transfer to org if user is not a member[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should only allow transfer to self when targetOwnerType is user[39m[32m 6[2mms[22m[39m
[31m       [31m√ó[31m should allow transfer from user to self (org member transferring org asset to themselves)[39m[32m 1[2mms[22m[39m
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w14

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w14,public

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w14 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w14%2Cpublic

{"level":30,"time":1768495825351,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

{"level":30,"time":1768495825432,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495825433,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

 [31m‚ùØ[39m tests/integration/auth/oauth2.google.test.ts [2m([22m[2m14 tests[22m[2m | [22m[33m14 skipped[39m[2m)[22m[33m 697[2mms[22m[39m
       [2m[90m‚Üì[39m[22m should successfully authenticate with valid Google ID token
       [2m[90m‚Üì[39m[22m should return 400 when ID token is missing
       [2m[90m‚Üì[39m[22m should return 403 when Origin header is invalid
       [2m[90m‚Üì[39m[22m should return 401 when Google token verification fails
       [2m[90m‚Üì[39m[22m should return 401 when email is not verified by Google
       [2m[90m‚Üì[39m[22m should update existing user on subsequent logins
       [2m[90m‚Üì[39m[22m should create refresh token record in database
       [2m[90m‚Üì[39m[22m should support both "token" and "idToken" fields
       [2m[90m‚Üì[39m[22m should respect rate limiting
       [2m[90m‚Üì[39m[22m should handle missing profile information gracefully
       [2m[90m‚Üì[39m[22m should verify valid Google ID token
       [2m[90m‚Üì[39m[22m should throw error when token verification fails
       [2m[90m‚Üì[39m[22m should throw error when email is not verified
       [2m[90m‚Üì[39m[22m should throw error when payload is null
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

{"level":30,"time":1768495826323,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768495826326,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768495826328,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768495826348,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768495826391,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768495826409,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w17

{"level":30,"time":1768495826520,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w17,public

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w17 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w17%2Cpublic

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w3

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w2

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w12

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w6

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w7

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w9

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w18

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w0

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w3,public

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w2,public

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w12,public

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w6,public

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w7,public

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w9,public

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w18,public

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w3 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w3%2Cpublic

{"level":30,"time":1768495827063,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w2 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w2%2Cpublic

{"level":30,"time":1768495827072,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w12 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w12%2Cpublic

{"level":30,"time":1768495827080,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w6 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w6%2Cpublic

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w7 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w7%2Cpublic

{"level":30,"time":1768495827088,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768495827089,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w0,public

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w9 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w9%2Cpublic

{"level":30,"time":1768495827099,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w18 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w18%2Cpublic

[90mstderr[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w0 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w0%2Cpublic

{"level":30,"time":1768495827140,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768495827142,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstderr[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/integration/auth.flows.real.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495827143,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/integration/auth.routes.real.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w15

[90mstderr[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495827197,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495827198,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768495827239,"env":"test","module":"auth-routes","error":{},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":50,"time":1768495827265,"env":"test","module":"auth-routes","error":{},"msg":"Registration failed"}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w20

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w15,public

 [31m‚ùØ[39m tests/integration/auth/oauth2.token-refresh.test.ts [2m([22m[2m25 tests[22m[2m | [22m[33m25 skipped[39m[2m)[22m[33m 628[2mms[22m[39m
       [2m[90m‚Üì[39m[22m should refresh access token with valid refresh token
       [2m[90m‚Üì[39m[22m should rotate refresh token after use
       [2m[90m‚Üì[39m[22m should return 401 when refresh token is missing
       [2m[90m‚Üì[39m[22m should return 401 for invalid refresh token
       [2m[90m‚Üì[39m[22m should return 401 for expired refresh token
       [2m[90m‚Üì[39m[22m should return 401 for revoked refresh token
       [2m[90m‚Üì[39m[22m should return 401 when user is not found
       [2m[90m‚Üì[39m[22m should update refresh token metadata on rotation
       [2m[90m‚Üì[39m[22m should handle concurrent refresh token requests (token reuse detection)
       [2m[90m‚Üì[39m[22m should set secure cookie in production
       [2m[90m‚Üì[39m[22m should set proper cookie attributes
       [2m[90m‚Üì[39m[22m should include user role information in response
       [2m[90m‚Üì[39m[22m should create refresh token on login
       [2m[90m‚Üì[39m[22m should revoke refresh token on logout
       [2m[90m‚Üì[39m[22m should handle logout without refresh token gracefully
       [2m[90m‚Üì[39m[22m should support multiple active refresh tokens per user
       [2m[90m‚Üì[39m[22m should revoke all user tokens on password reset
       [2m[90m‚Üì[39m[22m should use cryptographically strong random tokens
       [2m[90m‚Üì[39m[22m should hash refresh tokens before storing in database
       [2m[90m‚Üì[39m[22m should prevent refresh token reuse after rotation
       [2m[90m‚Üì[39m[22m should validate token ownership
       [2m[90m‚Üì[39m[22m should set HttpOnly flag to prevent XSS
       [2m[90m‚Üì[39m[22m should set SameSite=Strict to prevent CSRF
       [2m[90m‚Üì[39m[22m should set proper cookie path
       [2m[90m‚Üì[39m[22m should set appropriate expiry (30 days)
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w16

 [31m‚ùØ[39m tests/integration/auth/oauth2.sessions.test.ts [2m([22m[2m25 tests[22m[2m | [22m[33m25 skipped[39m[2m)[22m[33m 622[2mms[22m[39m
       [2m[90m‚Üì[39m[22m should list all active sessions for current user
       [2m[90m‚Üì[39m[22m should mark current session as current
       [2m[90m‚Üì[39m[22m should return empty array when user has no active sessions
       [2m[90m‚Üì[39m[22m should not include expired sessions
       [2m[90m‚Üì[39m[22m should not include revoked sessions
       [2m[90m‚Üì[39m[22m should parse device name from user agent
       [2m[90m‚Üì[39m[22m should return 401 for unauthenticated request
       [2m[90m‚Üì[39m[22m should revoke a specific session
       [2m[90m‚Üì[39m[22m should return 404 for non-existent session
       [2m[90m‚Üì[39m[22m should prevent revoking current session
       [2m[90m‚Üì[39m[22m should prevent revoking another user's session
       [2m[90m‚Üì[39m[22m should return 401 for unauthenticated request
       [2m[90m‚Üì[39m[22m should revoke all sessions except current
       [2m[90m‚Üì[39m[22m should revoke all trusted devices
       [2m[90m‚Üì[39m[22m should return 400 when no active session found
       [2m[90m‚Üì[39m[22m should return 401 for unauthenticated request
         [2m[90m‚Üì[39m[22m should mark current device as trusted
         [2m[90m‚Üì[39m[22m should update existing trusted device expiry
         [2m[90m‚Üì[39m[22m should list all trusted devices
         [2m[90m‚Üì[39m[22m should not include revoked devices
         [2m[90m‚Üì[39m[22m should revoke a trusted device
         [2m[90m‚Üì[39m[22m should return 404 for non-existent device
       [2m[90m‚Üì[39m[22m should track IP address for sessions
       [2m[90m‚Üì[39m[22m should track user agent for sessions
       [2m[90m‚Üì[39m[22m should update lastUsedAt on token refresh
{"level":50,"time":1768495827319,"env":"test","module":"auth-routes","error":{},"msg":"Registration failed"}
{"level":50,"time":1768495827331,"env":"test","module":"auth-routes","error":{},"msg":"Registration failed"}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w15 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w15%2Cpublic

{"level":30,"time":1768495827352,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w20,public

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w16,public

[90mstderr[2m | tests/integration/variableSafety.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/integration/variableSafety.test.ts[2m > [22m[2mVariable Schema Safety & Resolution
[22m[39mCleanup error (non-critical): Error: Database not initialized. Call await initializeDatabase() first.
    at Object.get (C:/Users/scoot/poll/VaultLogic/server/db.ts:113:13)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/variableSafety.test.ts:140:26
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at runHook [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1514:51[90m)[39m
    at callSuiteHook [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1520:25[90m)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1826:36
    at Traces.$ [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m

{"level":30,"time":1768495827421,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495827422,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w20 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w20%2Cpublic

{"level":30,"time":1768495827428,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w16 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w16%2Cpublic

{"level":30,"time":1768495827448,"env":"test","msg":"DB: initializing... Local"}
 [31m‚ùØ[39m tests/integration/variableSafety.test.ts [2m([22m[2m4 tests[22m[2m | [22m[31m4 failed[39m[2m)[22m[33m 634[2mms[22m[39m
[31m     [31m√ó[31m REPRO: ScriptEngine fails to resolve alias 'input_variable' when aliasMap is NOT provided[39m[32m 4[2mms[22m[39m
[31m     [31m√ó[31m ScriptEngine resolves alias 'input_variable' when aliasMap is provided[39m[32m 1[2mms[22m[39m
[31m     [31m√ó[31m REPRO: BlockRunner fails to resolve alias in CreateRecordConfig[39m[32m 1[2mms[22m[39m
[31m     [31m√ó[31m BlockRunner logic resolves alias with aliasMap[39m[32m 1[2mms[22m[39m
[90mstderr[2m | tests/integration/regression-REG-1.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/integration/regression-REG-1.test.ts[2m > [22m[2mREG-1: Workflow Logic Regression
[22m[39mCleanup error: Error: Database not initialized. Call await initializeDatabase() first.
    at Object.get (C:/Users/scoot/poll/VaultLogic/server/db.ts:113:13)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/regression-REG-1.test.ts:85:22
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at runHook [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1514:51[90m)[39m
    at callSuiteHook [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1520:25[90m)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1826:36
    at Traces.$ [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m

[90mstderr[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495827507,"env":"test","msg":"DB: closing pool..."}
[90mstderr[2m | tests/integration/ai/workflowEdit.test.ts[2m > [22m[2mPOST /api/workflows/:workflowId/ai/edit - Integration Test
[22m[39m‚ö†Ô∏è Skipping auditLogs cleanup: auditLogs or testUserId is undefined { auditLogs: [33mtrue[39m, testUserId: [90mundefined[39m }

{"level":30,"time":1768495827511,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495827511,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495827522,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768495827515,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

 [31m‚ùØ[39m tests/integration/ai/workflowEdit.test.ts [2m([22m[2m8 tests[22m[2m | [22m[33m8 skipped[39m[2m)[22m[33m 607[2mms[22m[39m
     [2m[90m‚Üì[39m[22m should create draft version on successful AI edit
     [2m[90m‚Üì[39m[22m should enforce draft mode (revert active workflow to draft)
     [2m[90m‚Üì[39m[22m should not create version when no changes detected (checksum match)
     [2m[90m‚Üì[39m[22m should reject unauthorized access
     [2m[90m‚Üì[39m[22m should reject unsafe DataVault operations
     [2m[90m‚Üì[39m[22m should handle multi-operation edits with tempId resolution
     [2m[90m‚Üì[39m[22m should create BEFORE and AFTER snapshots
     [2m[90m‚Üì[39m[22m should rollback on validation failure
 [31m‚ùØ[39m tests/integration/regression-REG-1.test.ts [2m([22m[2m8 tests[22m[2m | [22m[33m8 skipped[39m[2m)[22m[33m 650[2mms[22m[39m
       [2m[90m‚Üì[39m[22m should block Next when required visible question is empty
       [2m[90m‚Üì[39m[22m should NOT block Next when required question is hidden
       [2m[90m‚Üì[39m[22m should block when required becomes visible and is empty
       [2m[90m‚Üì[39m[22m should skip hidden required page entirely
       [2m[90m‚Üì[39m[22m should enforce required on visible page
       [2m[90m‚Üì[39m[22m should evaluate visibility consistently across modes
       [2m[90m‚Üì[39m[22m should handle malformed visibility expression gracefully
       [2m[90m‚Üì[39m[22m should handle missing variable in visibility expression
{"level":50,"time":1768495827603,"env":"test","module":"workflow-patch-service","error":{},"op":{"op":"datavault.createTable","databaseId":"db-123","name":"Submissions","columns":[{"name":"email","type":"text"},{"name":"submitted_at","type":"date"}]},"msg":"Failed to apply operation"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":50,"time":1768495827617,"env":"test","module":"workflow-patch-service","error":{},"op":{"op":"step.create","sectionRef":"temp-section-1","type":"short_text","title":"Field 1","alias":"field1"},"msg":"Failed to apply operation"}
{"level":50,"time":1768495827627,"env":"test","module":"workflow-patch-service","error":{},"op":{"op":"document.bindFields","id":"template-123","bindings":{"client_name":"nonExistentAlias"}},"msg":"Failed to apply operation"}
{"level":30,"time":1768495827633,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495827634,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/unit/services/WorkflowPatchService.test.ts [2m([22m[2m21 tests[22m[2m | [22m[31m3 failed[39m[2m)[22m[33m 1553[2mms[22m[39m
       [32m‚úì[39m should resolve section tempId to real UUID when creating step[32m 16[2mms[22m[39m
       [32m‚úì[39m should handle multi-level tempId references[32m 2[2mms[22m[39m
       [32m‚úì[39m should reject duplicate step alias on create[32m 1[2mms[22m[39m
       [32m‚úì[39m should allow same alias on update of same step[32m 1[2mms[22m[39m
       [32m‚úì[39m should reject duplicate alias on update to different step[32m 1[2mms[22m[39m
       [32m‚úì[39m should reject completely unknown operation[32m 2[2mms[22m[39m
       [32m‚úì[39m should reject malformed operation (missing required fields)[32m 1[2mms[22m[39m
       [32m‚úì[39m should reject unsafe DataVault operations (dropTable)[32m 1[2mms[22m[39m
       [32m‚úì[39m should reject unsafe DataVault operations (dropColumn)[32m 1[2mms[22m[39m
       [32m‚úì[39m should reject unsafe DataVault operations (deleteRows)[32m 0[2mms[22m[39m
       [32m‚úì[39m should reject unsafe DataVault operations (updateRowData)[32m 0[2mms[22m[39m
[31m       [31m√ó[31m should allow safe DataVault operations (createTable, addColumns)[39m[32m 13[2mms[22m[39m
       [32m‚úì[39m should rollback all ops if any op fails[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should clear tempId mappings between batch calls[39m[32m 1[2mms[22m[39m
       [32m‚úì[39m should create visibility rule on step[32m 2[2mms[22m[39m
       [32m‚úì[39m should parse complex condition expressions[32m 1[2mms[22m[39m
       [32m‚úì[39m should attach document to workflow (document.add)[32m 2[2mms[22m[39m
       [32m‚úì[39m should bind document fields to workflow variables (document.bindFields)[32m 3[2mms[22m[39m
[31m       [31m√ó[31m should reject binding to non-existent step alias[39m[32m 1[2mms[22m[39m
       [32m‚úì[39m should create DataVault table with columns (datavault.createTable)[32m 2[2mms[22m[39m
       [32m‚úì[39m should create writeback mapping (datavault.createWritebackMapping)[32m 2[2mms[22m[39m
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for non-existent user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768495827953,"env":"test","module":"auth-routes","error":{},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for non-existent user
[22m[39mLogin Failed DEBUG: Error: Database not initialized. Call await initializeDatabase() first.
    at Object.get (C:/Users/scoot/poll/VaultLogic/server/db.ts:113:13)
    at UserRepository.findByEmail (C:/Users/scoot/poll/VaultLogic/server/repositories/UserRepository.ts:25:8)
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:48:37)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:26
    at Layer.handle [as handle_request] [90m(C:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mexpress[24m\lib\router\layer.js:95:5[90m)[39m
    at next [90m(C:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mexpress[24m\lib\router\route.js:149:13[90m)[39m
    at isTest.windowMs (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:194:47)
    at Layer.handle [as handle_request] [90m(C:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mexpress[24m\lib\router\layer.js:95:5[90m)[39m
    at next [90m(C:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mexpress[24m\lib\router\route.js:149:13[90m)[39m
    at Route.dispatch [90m(C:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mexpress[24m\lib\router\route.js:119:3[90m)[39m

{"level":50,"time":1768495827973,"env":"test","module":"auth-routes","error":{},"msg":"Registration failed"}
[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495827984,"env":"test","msg":"DB: initializing... Local"}
{"level":50,"time":1768495827999,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 403 for unverified email
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768495828035,"env":"test","module":"auth-routes","error":{},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 403 for unverified email
[22m[39mLogin Failed DEBUG: Error: Database not initialized. Call await initializeDatabase() first.
    at Object.get (C:/Users/scoot/poll/VaultLogic/server/db.ts:113:13)
    at UserRepository.findByEmail (C:/Users/scoot/poll/VaultLogic/server/repositories/UserRepository.ts:25:8)
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:48:37)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:26
    at Layer.handle [as handle_request] [90m(C:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mexpress[24m\lib\router\layer.js:95:5[90m)[39m
    at next [90m(C:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mexpress[24m\lib\router\route.js:149:13[90m)[39m
    at isTest.windowMs (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:194:47)
    at Layer.handle [as handle_request] [90m(C:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mexpress[24m\lib\router\layer.js:95:5[90m)[39m
    at next [90m(C:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mexpress[24m\lib\router\route.js:149:13[90m)[39m
    at Route.dispatch [90m(C:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mexpress[24m\lib\router\route.js:119:3[90m)[39m

[90mstderr[2m | tests/unit/ai.service.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495828164,"env":"test","module":"workflow-quality-validator","overall":99,"breakdown":{"aliases":100,"types":100,"structure":100,"ux":95,"completeness":100,"validation":100},"issuesCount":1,"passed":true,"msg":"Workflow quality validation completed"}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495828164,"env":"test","module":"ai-service","duration":6,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":99,"qualityBreakdown":{"aliases":100,"types":100,"structure":100,"ux":95,"completeness":100,"validation":100},"qualityPassed":true,"issuesCount":1,"msg":"AI workflow generation succeeded"}
{"level":50,"time":1768495828170,"env":"test","module":"ai-service","error":{"code":"VALIDATION_ERROR","troubleshooting":"üîß Troubleshooting Steps:\n1. The AI response structure doesn't match our expected format\n2. This may indicate:\n   - A breaking change in the AI model behavior\n   - The model is struggling with the complexity of the request\n3. Try simplifying your workflow or request\n4. If this persists, please report this issue with the workflow details"},"duration":2,"msg":"AI workflow generation failed"}
{"level":50,"time":1768495828174,"env":"test","module":"ai-service","error":{"code":"VALIDATION_ERROR","troubleshooting":"üîß Troubleshooting Steps:\n1. The AI response structure doesn't match our expected format\n2. This may indicate:\n   - A breaking change in the AI model behavior\n   - The model is struggling with the complexity of the request\n3. Try simplifying your workflow or request\n4. If this persists, please report this issue with the workflow details"},"duration":1,"msg":"AI workflow generation failed"}
{"level":50,"time":1768495828177,"env":"test","module":"ai-service","error":{"code":"VALIDATION_ERROR","troubleshooting":"üîß Troubleshooting Steps:\n1. The AI response structure doesn't match our expected format\n2. This may indicate:\n   - A breaking change in the AI model behavior\n   - The model is struggling with the complexity of the request\n3. Try simplifying your workflow or request\n4. If this persists, please report this issue with the workflow details"},"duration":1,"msg":"AI workflow generation failed"}
{"level":40,"time":1768495828181,"env":"test","module":"ai-service","attempt":0,"retryAfter":1000,"error":"Rate limit exceeded","msg":"Retrying AI request..."}
{"level":40,"time":1768495828181,"env":"test","module":"ai-service","attempt":1,"retryAfter":2000,"error":"Rate limit exceeded","msg":"Retrying AI request..."}
{"level":40,"time":1768495828182,"env":"test","module":"ai-service","attempt":2,"retryAfter":4000,"error":"Rate limit exceeded","msg":"Retrying AI request..."}
{"level":50,"time":1768495828182,"env":"test","module":"ai-service","event":"ai_request_failed","provider":"openai","model":"gpt-4-turbo-preview","taskType":"workflow_generation","errorType":"RATE_LIMIT","durationMs":1,"attempts":4,"msg":"AI request failed: rate limit"}
{"level":50,"time":1768495828182,"env":"test","module":"ai-service","error":{"code":"RATE_LIMIT","details":{"originalError":"Rate limit exceeded","retryAfterSeconds":60},"troubleshooting":"üîß Troubleshooting Steps:\n1. You've hit the AI provider's rate limit\n2. Solutions:\n   - Wait 60 seconds and try again\n   - Check your API key quota at your provider's dashboard\n   - Consider upgrading your API plan for higher limits\n   - If using free tier, you may need to wait until limits reset"},"duration":1,"msg":"AI workflow generation failed"}
{"level":50,"time":1768495828184,"env":"test","module":"ai-service","error":{},"duration":0,"msg":"AI workflow generation failed"}
{"level":30,"time":1768495828189,"env":"test","module":"workflow-quality-validator","overall":100,"breakdown":{"aliases":100,"types":100,"structure":100,"ux":100,"completeness":100,"validation":100},"issuesCount":0,"passed":true,"msg":"Workflow quality validation completed"}
{"level":30,"time":1768495828190,"env":"test","module":"ai-service","duration":1,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":100,"qualityBreakdown":{"aliases":100,"types":100,"structure":100,"ux":100,"completeness":100,"validation":100},"qualityPassed":true,"issuesCount":0,"msg":"AI workflow generation succeeded"}
{"level":30,"time":1768495828290,"env":"test","module":"workflow-quality-validator","overall":96,"breakdown":{"aliases":100,"types":100,"structure":80,"ux":100,"completeness":90,"validation":100},"issuesCount":2,"passed":true,"msg":"Workflow quality validation completed"}
{"level":30,"time":1768495828290,"env":"test","module":"ai-service","duration":1,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":96,"qualityBreakdown":{"aliases":100,"types":100,"structure":80,"ux":100,"completeness":90,"validation":100},"qualityPassed":true,"issuesCount":2,"msg":"AI workflow generation succeeded"}
{"level":30,"time":1768495828318,"env":"test","module":"ai-service","duration":1,"suggestionsCount":1,"msg":"AI binding suggestion succeeded"}
{"level":30,"time":1768495828319,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495828320,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/ai.service.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 1767[2mms[22m[39m
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w21

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w21,public

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w21 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w21%2Cpublic

{"level":30,"time":1768495828819,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768495828901,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstderr[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495828912,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495828912,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/integration/auth/oauth2.callback.test.ts [2m([22m[2m16 tests[22m[2m | [22m[33m16 skipped[39m[2m)[22m[33m 634[2mms[22m[39m
       [2m[90m‚Üì[39m[22m should initiate OAuth2 3-legged flow and generate authorization URL
       [2m[90m‚Üì[39m[22m should include optional scope in authorization URL
       [2m[90m‚Üì[39m[22m should validate valid OAuth2 state token
       [2m[90m‚Üì[39m[22m should reject invalid OAuth2 state token
       [2m[90m‚Üì[39m[22m should reject expired OAuth2 state token
       [2m[90m‚Üì[39m[22m should clean up OAuth2 state after use
       [2m[90m‚Üì[39m[22m should handle callback with missing state parameter
       [2m[90m‚Üì[39m[22m should handle callback with missing code parameter
       [2m[90m‚Üì[39m[22m should handle OAuth2 provider error responses
       [2m[90m‚Üì[39m[22m should track OAuth2 connection status
       [2m[90m‚Üì[39m[22m should store OAuth2 state in connection metadata
       [2m[90m‚Üì[39m[22m should use cryptographically secure random state
       [2m[90m‚Üì[39m[22m should prevent state reuse after validation
       [2m[90m‚Üì[39m[22m should include PKCE support metadata in state record
       [2m[90m‚Üì[39m[22m should validate redirect URI matches allowed URIs
       [2m[90m‚Üì[39m[22m should encode redirect URI in authorization URL
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w24

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w24,public

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w23

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w24 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w24%2Cpublic

{"level":30,"time":1768495829470,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w23,public

[90mstderr[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495829534,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495829534,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w23 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w23%2Cpublic

{"level":30,"time":1768495829573,"env":"test","msg":"DB: initializing... Local"}
 [31m‚ùØ[39m tests/integration/dynamic_options_workflow.test.ts [2m([22m[2m1 test[22m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 625[2mms[22m[39m
     [2m[90m‚Üì[39m[22m should successfully configure a workflow with Read Table -> Dynamic Choice
[90mstderr[2m | tests/integration/workflow_versioning.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495829631,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495829634,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

 [31m‚ùØ[39m tests/integration/workflow_versioning.test.ts [2m([22m[2m3 tests[22m[2m | [22m[33m3 skipped[39m[2m)[22m[33m 631[2mms[22m[39m
     [2m[90m‚Üì[39m[22m should diff two versions correctly
     [2m[90m‚Üì[39m[22m should create a version and populate changelog
     [2m[90m‚Üì[39m[22m should track execution lineage via snapshot
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w27

{"level":30,"time":1768495830020,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495830020,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w27,public

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w27 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w27%2Cpublic

{"level":30,"time":1768495830097,"env":"test","msg":"DB: initializing... Local"}
{"level":50,"time":1768495830142,"env":"test","module":"auth-routes","error":{},"msg":"Forgot password error"}
 [31m‚ùØ[39m tests/integration/auth.flows.real.test.ts [2m([22m[2m11 tests[22m[2m | [22m[31m11 failed[39m[2m)[22m[33m 3474[2mms[22m[39m
[31m       [31m√ó[31m should complete registration, verify email, then login[39m[32m 97[2mms[22m[39m
[31m       [31m√ó[31m should lock account after 5 failed attempts, then unlock after waiting[39m[32m 275[2mms[22m[39m
[31m       [31m√ó[31m should record all login attempts[39m[32m 262[2mms[22m[39m
[31m       [31m√ó[31m should complete MFA setup and login with TOTP[39m[33m 313[2mms[22m[39m
[31m       [31m√ó[31m should login with backup code when TOTP unavailable[39m[32m 267[2mms[22m[39m
[31m       [31m√ó[31m should complete full password reset flow[39m[32m 256[2mms[22m[39m
[31m       [31m√ó[31m should invalidate all sessions after password reset[39m[32m 249[2mms[22m[39m
[31m       [31m√ó[31m should rotate refresh token on each use[39m[32m 266[2mms[22m[39m
[31m       [31m√ó[31m should detect and prevent refresh token reuse (token theft)[39m[32m 298[2mms[22m[39m
[31m       [31m√ó[31m should list all active sessions[39m[32m 286[2mms[22m[39m
[31m       [31m√ó[31m should revoke specific session[39m[32m 275[2mms[22m[39m
[90mstderr[2m | tests/integration/collections.e2e.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495830155,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495830156,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/integration/collections.e2e.test.ts [2m([22m[2m22 tests[22m[2m | [22m[33m22 skipped[39m[2m)[22m[33m 683[2mms[22m[39m
       [2m[90m‚Üì[39m[22m should create a collection
       [2m[90m‚Üì[39m[22m should list collections
       [2m[90m‚Üì[39m[22m should get a collection by ID
       [2m[90m‚Üì[39m[22m should update a collection
       [2m[90m‚Üì[39m[22m should create text field
       [2m[90m‚Üì[39m[22m should create email field
       [2m[90m‚Üì[39m[22m should create number field
       [2m[90m‚Üì[39m[22m should create select field with options
       [2m[90m‚Üì[39m[22m should create boolean field
       [2m[90m‚Üì[39m[22m should list all fields
       [2m[90m‚Üì[39m[22m should update field
       [2m[90m‚Üì[39m[22m should create a record
       [2m[90m‚Üì[39m[22m should create multiple records
       [2m[90m‚Üì[39m[22m should list records with pagination
       [2m[90m‚Üì[39m[22m should get a single record
       [2m[90m‚Üì[39m[22m should update a record
       [2m[90m‚Üì[39m[22m should find records by filters
       [2m[90m‚Üì[39m[22m should delete a record
       [2m[90m‚Üì[39m[22m should list collections with stats
       [2m[90m‚Üì[39m[22m should enforce required fields
       [2m[90m‚Üì[39m[22m should validate field types
       [2m[90m‚Üì[39m[22m should delete collection (cascade fields and records)
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w26

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w28

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w26,public

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w26 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w26%2Cpublic

{"level":30,"time":1768495830374,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w28,public

[90mstderr[2m | tests/integration/externalSends.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495830432,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495830432,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768495830441,"env":"test","module":"auth-routes","error":{},"msg":"Reset password error"}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w19

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w28 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w28%2Cpublic

{"level":30,"time":1768495830455,"env":"test","msg":"DB: initializing... Local"}
 [31m‚ùØ[39m tests/integration/externalSends.test.ts [2m([22m[2m2 tests[22m[2m | [22m[33m2 skipped[39m[2m)[22m[33m 653[2mms[22m[39m
     [2m[90m‚Üì[39m[22m PREVIEW MODE: Should simulate send and NOT call fetch
     [2m[90m‚Üì[39m[22m LIVE MODE: Should call fetch with mapped payload
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes
[22m[39mCleanup error: Error: Database not initialized. Call await initializeDatabase() first.
    at Object.get (C:/Users/scoot/poll/VaultLogic/server/db.ts:113:13)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:94:18
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at runHook [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1514:51[90m)[39m
    at callSuiteHook [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1520:25[90m)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1826:36
    at Traces.$ [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495830511,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495830512,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w19,public

 [31m‚ùØ[39m tests/integration/organizations-audit-fixes.test.ts [2m([22m[2m8 tests[22m[2m | [22m[33m8 skipped[39m[2m)[22m[33m 596[2mms[22m[39m
       [2m[90m‚Üì[39m[22m should cascade ownership to workflow runs when project is transferred
       [2m[90m‚Üì[39m[22m should prevent double-acceptance via transaction
       [2m[90m‚Üì[39m[22m should not create invite if email fails
       [2m[90m‚Üì[39m[22m should allow re-invite after invite expires
       [2m[90m‚Üì[39m[22m should allow last admin to delete empty organization
       [2m[90m‚Üì[39m[22m should prevent deletion if org owns assets
       [2m[90m‚Üì[39m[22m should cleanup placeholder user when invite is revoked
       [2m[90m‚Üì[39m[22m should fail fast on non-existent org
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w19 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w19%2Cpublic

{"level":30,"time":1768495830590,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:148:9

{"level":30,"time":1768495830707,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495830707,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w29

 [31m‚ùØ[39m tests/integration/workflows/runtime-pipelines.test.ts [2m([22m[2m4 tests[22m[2m | [22m[33m4 skipped[39m[2m)[22m[33m 686[2mms[22m[39m
       [2m[90m‚Üì[39m[22m should create DataVault row on workflow completion
       [2m[90m‚Üì[39m[22m should execute writebacks via RunService.completeRun()
       [2m[90m‚Üì[39m[22m should skip document generation when visibleIf condition is false
       [2m[90m‚Üì[39m[22m should generate document when visibleIf condition is true
{"level":30,"time":1768495830876,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495830877,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w29,public

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w29 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w29%2Cpublic

{"level":30,"time":1768495830962,"env":"test","msg":"DB: initializing... Local"}
 [31m‚ùØ[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m13 failed[39m[2m)[22m[33m 4330[2mms[22m[39m
[31m       [31m√ó[31m should trust current device[39m[33m 310[2mms[22m[39m
[31m       [31m√ó[31m should set trust expiry to 30 days[39m[32m 248[2mms[22m[39m
[31m       [31m√ó[31m should update expiry if device already trusted[39m[32m 250[2mms[22m[39m
       [32m‚úì[39m should require authentication[32m 34[2mms[22m[39m
[31m       [31m√ó[31m should list all trusted devices[39m[33m 310[2mms[22m[39m
[31m       [31m√ó[31m should mark current device[39m[33m 313[2mms[22m[39m
[31m       [31m√ó[31m should exclude revoked devices[39m[33m 323[2mms[22m[39m
[31m       [31m√ó[31m should exclude expired devices[39m[33m 306[2mms[22m[39m
[31m       [31m√ó[31m should revoke specific device[39m[32m 289[2mms[22m[39m
[31m       [31m√ó[31m should return 404 for non-existent device[39m[32m 246[2mms[22m[39m
[31m       [31m√ó[31m should prevent revoking other user's device[39m[32m 271[2mms[22m[39m
[31m       [31m√ó[31m should skip MFA for trusted device[39m[32m 248[2mms[22m[39m
[31m       [31m√ó[31m should require MFA for untrusted device[39m[33m 301[2mms[22m[39m
[31m       [31m√ó[31m should update lastUsedAt on trusted device login[39m[32m 254[2mms[22m[39m
[90mstderr[2m | tests/integration/organizations-workflow.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests
[22m[39mCleanup error: Error: Database not initialized. Call await initializeDatabase() first.
    at Object.get (C:/Users/scoot/poll/VaultLogic/server/db.ts:113:13)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:83:16
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at runHook [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1514:51[90m)[39m
    at callSuiteHook [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1520:25[90m)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1826:36
    at Traces.$ [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w25

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495831026,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495831037,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768495831067,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768495831074,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
 [31m‚ùØ[39m tests/integration/organizations-workflow.test.ts [2m([22m[2m23 tests[22m[2m | [22m[33m23 skipped[39m[2m)[22m[33m 670[2mms[22m[39m
       [2m[90m‚Üì[39m[22m Step 1: Create organization
       [2m[90m‚Üì[39m[22m Step 2: Invite member via email
       [2m[90m‚Üì[39m[22m Step 3: Accept invite
       [2m[90m‚Üì[39m[22m Step 4: Create workflow owned by user
       [2m[90m‚Üì[39m[22m Step 5: Transfer workflow to organization
       [2m[90m‚Üì[39m[22m Step 6: Org member (user2) can access workflow
       [2m[90m‚Üì[39m[22m Step 7: Org member (user2) can update workflow
       [2m[90m‚Üì[39m[22m Step 8: Org admin (user1) can still access workflow after transfer
       [2m[90m‚Üì[39m[22m Step 9: Non-member (user3) CANNOT access org workflow
       [2m[90m‚Üì[39m[22m Step 10: Non-member (user3) CANNOT update org workflow
       [2m[90m‚Üì[39m[22m Step 11: Non-member (user3) CANNOT transfer org workflow
       [2m[90m‚Üì[39m[22m Step 12: Org member can see workflow in list
       [2m[90m‚Üì[39m[22m Step 13: Non-member CANNOT see workflow in list
       [2m[90m‚Üì[39m[22m Step 14: Remove member from org
       [2m[90m‚Üì[39m[22m Step 15: Removed member (user2) can no longer access workflow
       [2m[90m‚Üì[39m[22m Step 16: Re-add member and verify access restored
       [2m[90m‚Üì[39m[22m Cannot invite same email twice (pending invite exists)
       [2m[90m‚Üì[39m[22m Cannot accept expired invite
       [2m[90m‚Üì[39m[22m Cannot transfer workflow to org user is not a member of
       [2m[90m‚Üì[39m[22m Member cannot promote themselves to admin
       [2m[90m‚Üì[39m[22m Member cannot remove admin
       [2m[90m‚Üì[39m[22m Only members can view organization details
       [2m[90m‚Üì[39m[22m Only members can view organization members list
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w25,public

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w25 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w25%2Cpublic

{"level":30,"time":1768495831206,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/integration/analytics_service.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:148:9

[90mstderr[2m | tests/integration/analytics_service.test.ts[2m > [22m[2mAnalytics Service Integration
[22m[39mMANUAL PATCH FAILED Error: Database not initialized. Call await initializeDatabase() first.
    at Object.get (C:/Users/scoot/poll/VaultLogic/server/db.ts:113:13)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/analytics_service.test.ts:20:22
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at runHook [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1514:51[90m)[39m
    at callSuiteHook [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1520:25[90m)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1796:58
    at Traces.$ [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runSuite [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1796:31[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495831300,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495831301,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w30

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w30,public

 [31m‚ùØ[39m tests/integration/analytics_service.test.ts [2m([22m[2m1 test[22m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 737[2mms[22m[39m
     [2m[90m‚Üì[39m[22m should generate events and metrics on run completion
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w30 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w30%2Cpublic

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495831504,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/unit/schema/collections.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768495831621,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495831622,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/unit/schema/collections.test.ts [2m([22m[2m34 tests[22m[2m | [22m[31m8 failed[39m[2m)[22m[33m 723[2mms[22m[39m
       [32m‚úì[39m should have correct table name[32m 3[2mms[22m[39m
       [32m‚úì[39m should have required columns[32m 2[2mms[22m[39m
       [32m‚úì[39m should have correct table name[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should have required columns[39m[32m 15[2mms[22m[39m
       [32m‚úì[39m should have correct table name[32m 0[2mms[22m[39m
       [32m‚úì[39m should have required columns[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should have all expected field types[39m[32m 1[2mms[22m[39m
         [32m‚úì[39m should validate valid collection data[32m 2[2mms[22m[39m
         [32m‚úì[39m should require tenantId, name, and slug[32m 1[2mms[22m[39m
         [32m‚úì[39m should omit id, createdAt, and updatedAt[32m 1[2mms[22m[39m
         [32m‚úì[39m should allow description to be null[32m 0[2mms[22m[39m
[31m         [31m√ó[31m should validate valid field data[39m[32m 5[2mms[22m[39m
         [32m‚úì[39m should require collectionId, name, slug, and type[32m 0[2mms[22m[39m
[31m         [31m√ó[31m should validate field type enum[39m[32m 1[2mms[22m[39m
         [32m‚úì[39m should reject invalid field type[32m 0[2mms[22m[39m
[31m         [31m√ó[31m should allow options for select types[39m[32m 3[2mms[22m[39m
[31m         [31m√ó[31m should allow defaultValue[39m[32m 1[2mms[22m[39m
         [32m‚úì[39m should validate valid record data[32m 1[2mms[22m[39m
         [32m‚úì[39m should require tenantId, collectionId, and data[32m 0[2mms[22m[39m
         [32m‚úì[39m should allow empty data object[32m 1[2mms[22m[39m
         [32m‚úì[39m should allow createdBy and updatedBy to be null[32m 1[2mms[22m[39m
         [32m‚úì[39m should allow complex nested data structures[32m 0[2mms[22m[39m
       [32m‚úì[39m should enforce unique slug per tenant for collections[32m 0[2mms[22m[39m
       [32m‚úì[39m should enforce unique slug per collection for fields[32m 0[2mms[22m[39m
       [32m‚úì[39m should cascade delete fields when collection is deleted[32m 0[2mms[22m[39m
       [32m‚úì[39m should cascade delete records when collection is deleted[32m 0[2mms[22m[39m
       [32m‚úì[39m should cascade delete records when tenant is deleted[32m 0[2mms[22m[39m
       [32m‚úì[39m should set null on createdBy/updatedBy when user is deleted[32m 0[2mms[22m[39m
[31m       [31m√ó[31m should support JSONB for field options[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should support JSONB for field default values[39m[32m 1[2mms[22m[39m
       [32m‚úì[39m should support JSONB for record data with fieldSlug ‚Üí value mapping[32m 0[2mms[22m[39m
       [32m‚úì[39m should correctly infer Collection type[32m 0[2mms[22m[39m
       [32m‚úì[39m should correctly infer CollectionField type[32m 0[2mms[22m[39m
       [32m‚úì[39m should correctly infer CollectionRecord type[32m 0[2mms[22m[39m
{"level":30,"time":1768495831716,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495831717,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w32

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w32,public

 [31m‚ùØ[39m tests/integration/auth.routes.real.test.ts [2m([22m[2m26 tests[22m[2m | [22m[31m21 failed[39m[2m)[22m[33m 5169[2mms[22m[39m
[31m       [31m√ó[31m should register a new user successfully[39m[32m 99[2mms[22m[39m
       [32m‚úì[39m should return 400 for invalid email format[32m 18[2mms[22m[39m
       [32m‚úì[39m should return 400 for weak password[32m 6[2mms[22m[39m
[31m       [31m√ó[31m should return 409 for duplicate email[39m[32m 15[2mms[22m[39m
[31m       [31m√ó[31m should set httpOnly refresh token cookie[39m[32m 26[2mms[22m[39m
[31m       [31m√ó[31m should login with valid credentials[39m[32m 286[2mms[22m[39m
[31m       [31m√ó[31m should return 401 for invalid password[39m[32m 294[2mms[22m[39m
[31m       [31m√ó[31m should return 401 for non-existent user[39m[32m 37[2mms[22m[39m
[31m       [31m√ó[31m should return 403 for unverified email[39m[32m 75[2mms[22m[39m
[31m       [31m√ó[31m should record failed login attempt[39m[32m 281[2mms[22m[39m
[31m       [31m√ó[31m should return requiresMfa=true for MFA-enabled users[39m[32m 282[2mms[22m[39m
[31m       [31m√ó[31m should lock account after 5 failed attempts[39m[32m 287[2mms[22m[39m
[31m       [31m√ó[31m should logout and clear refresh token cookie[39m[32m 296[2mms[22m[39m
[31m       [31m√ó[31m should refresh access token with valid refresh token[39m[33m 322[2mms[22m[39m
       [32m‚úì[39m should return 401 for missing refresh token[32m 55[2mms[22m[39m
[31m       [31m√ó[31m should rotate refresh token after use[39m[32m 296[2mms[22m[39m
[31m       [31m√ó[31m should send password reset email for existing user[39m[32m 271[2mms[22m[39m
[31m       [31m√ó[31m should not reveal if email exists (security)[39m[32m 12[2mms[22m[39m
[31m       [31m√ó[31m should reset password with valid token[39m[32m 292[2mms[22m[39m
[31m       [31m√ó[31m should return 400 for invalid token[39m[32m 7[2mms[22m[39m
[31m       [31m√ó[31m should return 400 for weak new password[39m[32m 271[2mms[22m[39m
[31m       [31m√ó[31m should return current user for valid token[39m[33m 348[2mms[22m[39m
       [32m‚úì[39m should return 401 for missing token[32m 7[2mms[22m[39m
       [32m‚úì[39m should return 401 for invalid token[32m 6[2mms[22m[39m
[31m         [31m√ó[31m should complete MFA login with valid TOTP code[39m[33m 319[2mms[22m[39m
[31m         [31m√ó[31m should reject invalid MFA code[39m[33m 321[2mms[22m[39m
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w32 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w32%2Cpublic

{"level":30,"time":1768495831867,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/integration/analytics_preservation.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495831927,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495831935,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495831935,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

 [31m‚ùØ[39m tests/integration/analytics_preservation.test.ts [2m([22m[2m1 test[22m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 663[2mms[22m[39m
     [2m[90m‚Üì[39m[22m should preserve lifetime user count when a user is deleted
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w22

{"level":30,"time":1768495832323,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495832324,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w22,public

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w22 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w22%2Cpublic

{"level":30,"time":1768495832475,"env":"test","msg":"DB: initializing... Local"}
 [31m‚ùØ[39m tests/integration/session.management.real.test.ts [2m([22m[2m18 tests[22m[2m | [22m[31m17 failed[39m[2m)[22m[33m 5698[2mms[22m[39m
[31m       [31m√ó[31m should list all active sessions for current user[39m[32m 257[2mms[22m[39m
[31m       [31m√ó[31m should mark current session correctly[39m[32m 257[2mms[22m[39m
[31m       [31m√ó[31m should exclude revoked sessions[39m[32m 294[2mms[22m[39m
[31m       [31m√ó[31m should order sessions by last used (most recent first)[39m[33m 443[2mms[22m[39m
[31m       [31m√ó[31m should filter sessions by current user only[39m[33m 335[2mms[22m[39m
       [32m‚úì[39m should return 401 for unauthenticated request[32m 66[2mms[22m[39m
[31m       [31m√ó[31m should revoke specific session[39m[33m 303[2mms[22m[39m
[31m       [31m√ó[31m should prevent revoking current session[39m[32m 283[2mms[22m[39m
[31m       [31m√ó[31m should return 404 for non-existent session[39m[33m 310[2mms[22m[39m
[31m       [31m√ó[31m should prevent revoking other user's session[39m[32m 273[2mms[22m[39m
[31m       [31m√ó[31m should revoke all other sessions[39m[32m 278[2mms[22m[39m
[31m       [31m√ó[31m should keep current session active[39m[32m 285[2mms[22m[39m
[31m       [31m√ó[31m should return 400 if no active session found[39m[32m 261[2mms[22m[39m
[31m       [31m√ó[31m should revoke all trusted devices[39m[32m 269[2mms[22m[39m
[31m       [31m√ó[31m should handle user with single session gracefully[39m[33m 313[2mms[22m[39m
[31m       [31m√ó[31m should include device metadata in sessions[39m[32m 263[2mms[22m[39m
[31m       [31m√ó[31m should not expose sensitive token data[39m[32m 281[2mms[22m[39m
[31m       [31m√ó[31m should track session activity timestamps[39m[32m 286[2mms[22m[39m
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w33

[90mstderr[2m | tests/integration/dataBlocks.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:148:9

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495832590,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w33,public

{"level":30,"time":1768495832590,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w33 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w33%2Cpublic

{"level":30,"time":1768495832644,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495832696,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495832696,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstderr[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495832768,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495832769,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/integration/dataBlocks.test.ts [2m([22m[2m2 tests[22m[2m | [22m[33m2 skipped[39m[2m)[22m[33m 720[2mms[22m[39m
     [2m[90m‚Üì[39m[22m should write data to DataVault via WriteBlock
     [2m[90m‚Üì[39m[22m should query data from DataVault via QueryBlock and use in Logic
 [31m‚ùØ[39m tests/unit/services/WorkflowTemplateService.test.ts [2m([22m[2m21 tests[22m[2m | [22m[31m21 failed[39m[2m)[22m[33m 689[2mms[22m[39m
[31m       [31m√ó[31m should throw error if template belongs to different project[39m[32m 8[2mms[22m[39m
[31m       [31m√ó[31m should automatically unset other primaries when setting new primary[39m[32m 2[2mms[22m[39m
[31m         [31m√ó[31m should list all templates for workflow version[39m[32m 1[2mms[22m[39m
[31m         [31m√ó[31m should return empty array for version with no templates[39m[32m 1[2mms[22m[39m
[31m         [31m√ó[31m should get template mapping by id and version[39m[32m 1[2mms[22m[39m
[31m         [31m√ó[31m should throw error if mapping not found[39m[32m 1[2mms[22m[39m
[31m         [31m√ó[31m should get template by key[39m[32m 26[2mms[22m[39m
[31m         [31m√ó[31m should throw error if key not found[39m[32m 1[2mms[22m[39m
[31m         [31m√ó[31m should get primary template for workflow version[39m[32m 1[2mms[22m[39m
[31m         [31m√ó[31m should return null when no primary template exists[39m[32m 1[2mms[22m[39m
[31m         [31m√ó[31m should update mapping key[39m[32m 2[2mms[22m[39m
[31m         [31m√ó[31m should update isPrimary flag[39m[32m 1[2mms[22m[39m
[31m         [31m√ó[31m should throw error if new key already exists[39m[32m 1[2mms[22m[39m
[31m         [31m√ó[31m should throw error if mapping not found[39m[32m 1[2mms[22m[39m
[31m         [31m√ó[31m should unset other primaries when setting isPrimary to true[39m[32m 1[2mms[22m[39m
[31m         [31m√ó[31m should detach template from workflow version[39m[32m 1[2mms[22m[39m
[31m         [31m√ó[31m should throw error if mapping not found[39m[32m 1[2mms[22m[39m
[31m         [31m√ó[31m should set template as primary[39m[32m 1[2mms[22m[39m
[31m         [31m√ó[31m should throw error if mapping not found[39m[32m 1[2mms[22m[39m
[31m         [31m√ó[31m should support operations within a transaction[39m[32m 1[2mms[22m[39m
[31m         [31m√ó[31m should rollback on transaction error[39m[32m 1[2mms[22m[39m
 [31m‚ùØ[39m tests/integration/mfa.flow.real.test.ts [2m([22m[2m20 tests[22m[2m | [22m[31m20 failed[39m[2m)[22m[33m 6149[2mms[22m[39m
[31m       [31m√ó[31m should complete full MFA setup flow[39m[32m 262[2mms[22m[39m
[31m       [31m√ó[31m should reject invalid TOTP code during setup[39m[32m 258[2mms[22m[39m
[31m       [31m√ó[31m should not allow MFA setup if already enabled[39m[32m 285[2mms[22m[39m
[31m       [31m√ó[31m should generate unique backup codes[39m[32m 292[2mms[22m[39m
[31m       [31m√ó[31m should store hashed backup codes[39m[33m 322[2mms[22m[39m
[31m       [31m√ó[31m should require MFA for enabled users[39m[32m 259[2mms[22m[39m
[31m       [31m√ó[31m should complete MFA login with valid TOTP[39m[32m 250[2mms[22m[39m
[31m       [31m√ó[31m should reject invalid TOTP during login[39m[32m 275[2mms[22m[39m
[31m       [31m√ó[31m should accept TOTP codes within 60-second window[39m[33m 339[2mms[22m[39m
[31m       [31m√ó[31m should login with valid backup code[39m[32m 257[2mms[22m[39m
[31m       [31m√ó[31m should mark backup code as used[39m[32m 254[2mms[22m[39m
[31m       [31m√ó[31m should prevent backup code reuse[39m[32m 287[2mms[22m[39m
[31m       [31m√ó[31m should try TOTP before backup code[39m[32m 297[2mms[22m[39m
[31m       [31m√ó[31m should return MFA status for user[39m[33m 321[2mms[22m[39m
[31m       [31m√ó[31m should return backup codes count for MFA users[39m[33m 327[2mms[22m[39m
[31m       [31m√ó[31m should disable MFA with password verification[39m[32m 257[2mms[22m[39m
[31m       [31m√ó[31m should require correct password to disable MFA[39m[33m 346[2mms[22m[39m
[31m       [31m√ó[31m should regenerate backup codes[39m[32m 300[2mms[22m[39m
[31m       [31m√ó[31m should return error if MFA not enabled[39m[33m 310[2mms[22m[39m
[31m       [31m√ó[31m should enforce MFA for tenant users when required by tenant[39m[32m 2[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/integration/api.snapshots.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstderr[2m | tests/integration/api.expression-validation.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstderr[2m | tests/integration/api.runs.docx.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstderr[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstderr[2m | tests/integration/api.projects.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/integration/api.runs.graph.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/integration/api.templates-runs.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/integration/api.workflows.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstderr[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstderr[2m | tests/unit/api.ai.revise.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstderr[2m | tests/integration/datavault.permissions.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstderr[2m | tests/integration/intake.workflow.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/unit/api.ai.logic.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/integration/js_helpers.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstderr[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w54

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w54,public

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w54 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w54%2Cpublic

{"level":30,"time":1768495838267,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/integration/ownershipAccess.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495838355,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495838356,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/integration/ownershipAccess.test.ts [2m([22m[2m19 tests[22m[2m | [22m[31m14 failed[39m[2m)[22m[33m 632[2mms[22m[39m
       [32m‚úì[39m should allow access to user-owned asset by owner[32m 3[2mms[22m[39m
       [32m‚úì[39m should deny access to user-owned asset by non-owner[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should allow access to org-owned asset by org member[39m[32m 3[2mms[22m[39m
[31m       [31m√ó[31m should deny access to org-owned asset by non-member[39m[32m 1[2mms[22m[39m
       [32m‚úì[39m should allow access to null ownership (legacy data)[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should return true for org member[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should return false for non-member[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should return true for org admin[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should return true for org admin[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should return false for org member (non-admin)[39m[32m 0[2mms[22m[39m
[31m       [31m√ó[31m should return false for non-member[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should return all org IDs for a user[39m[32m 0[2mms[22m[39m
[31m       [31m√ó[31m should return empty array for user with no memberships[39m[32m 4[2mms[22m[39m
       [32m‚úì[39m should allow creating user-owned asset if ownerUuid matches userId[32m 1[2mms[22m[39m
       [32m‚úì[39m should deny creating user-owned asset if ownerUuid does not match userId[32m 0[2mms[22m[39m
[31m       [31m√ó[31m should allow creating org-owned asset if user is member[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should deny creating org-owned asset if user is not member[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should not allow member of org1 to access org2-owned assets[39m[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should allow member of multiple orgs to access all their org assets[39m[32m 1[2mms[22m[39m
[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/unit/debug_import.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstderr[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w55

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w55,public

[90mstderr[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w55 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w55%2Cpublic

[90mstderr[2m | tests/unit/services/AuthService.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): Error: [vitest] No "closeDatabase" export is defined on the "../../../server/db" mock. Did you forget to return it from "vi.mock"?
If you need to partially mock a module, you can use "importOriginal" helper inside:

    at VitestMocker.createError [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:311:17[90m)[39m
    at Object.get [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:384:16[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:144:34
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m {
  codeFrame: [32m'vi.mock(import("../../../server/db"), async (importOriginal) => {\n'[39m +
    [32m'  const actual = await importOriginal()\n'[39m +
    [32m'  return {\n'[39m +
    [32m'    ...actual,\n'[39m +
    [32m'    // your mocked methods\n'[39m +
    [32m'  }\n'[39m +
    [32m'})'[39m
}

[90mstderr[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstderr[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w65

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w65,public

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w65 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w65%2Cpublic

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w59

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w59,public

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w59 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w59%2Cpublic

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w56

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495841946,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w56,public

[90mstderr[2m | tests/unit/docxRenderer.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w56 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w56%2Cpublic

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

{"level":40,"time":1768495842570,"env":"test","error":{},"msg":"PDF conversion failed"}
{"level":30,"time":1768495842644,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495842645,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w66

 [32m‚úì[39m tests/unit/docxRenderer.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 2459[2mms[22m[39m
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w66,public

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w66 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w66%2Cpublic

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w61

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w67

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w61,public

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w61 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w61%2Cpublic

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w67,public

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w68

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w58

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w67 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w67%2Cpublic

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w60

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w62

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w68,public

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w58,public

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w60,public

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w62,public

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w68 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w68%2Cpublic

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w58 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w58%2Cpublic

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w60 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w60%2Cpublic

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w57

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w63

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w62 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w62%2Cpublic

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w64

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w57,public

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w63,public

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w64,public

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w57 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w57%2Cpublic

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w63 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w63%2Cpublic

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w64 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w64%2Cpublic

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495844055,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495844077,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768495844079,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495844177,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/ui/expression-editor.test.tsx
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495844239,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould validate expression after debounce
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstderr[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495844361,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495844362,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/services/AuthService.test.ts[2m > [22m[2mAuthService[2m > [22m[2mJWT Token Management[2m > [22m[2mverifyToken()[2m > [22m[2mshould throw error for invalid token signature
[22m[39mDEBUG: verifyToken threw: Invalid or malformed token InvalidTokenError

[90mstderr[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/integration/metrics.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould return validation errors for invalid expression
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

{"level":30,"time":1768495844503,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495844504,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495844515,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495844545,"env":"test","msg":"DB: initializing... Local"}
 [32m‚úì[39m tests/ui/blocks/SendDataToTableBlockEditor.test.tsx [2m([22m[2m12 tests[22m[2m)[22m[33m 2123[2mms[22m[39m
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495844596,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/unit/collab.client.test.tsx
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould return validation errors for invalid expression
[22m[39mValidation Result DEBUG: {"ok":false,"errors":[{"message":"Unknown identifier: unknown_var","start":{"line":0,"col":0},"end":{"line":0,"col":11}}]}
IsValid DEBUG: [33mfalse[39m

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould debounce validation calls
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstderr[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx[2m > [22m[2mTableGridView - Drag & Drop[2m > [22m[2mrenders DndContext wrapper
[22m[39mWarning: validateDOMNesting(...): <th> cannot appear as a child of <div>.
    at th
    at SortableColumnHeader (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/SortableColumnHeader.tsx:12:33)
    at div
    at SortableContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:26:23)
    at tr
    at thead
    at table
    at div
    at DndContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:18:18)
    at div
    at div
    at TableGridView (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/TableGridView.tsx:32:26)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
Warning: validateDOMNesting(...): <div> cannot appear as a child of <tr>.
    at div
    at SortableContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:26:23)
    at tr
    at thead
    at table
    at div
    at DndContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:18:18)
    at div
    at div
    at TableGridView (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/TableGridView.tsx:32:26)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495844699,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768495844720,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495844720,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK initialized successfully"}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495844721,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768495844720,"env":"test","module":"telemetry","msg":"Prometheus metrics initialized"}
{"level":30,"time":1768495844723,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstderr[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495844770,"env":"test","module":"auth-service","email":"reset@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768495844780,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK shut down successfully"}
{"level":30,"time":1768495844775,"env":"test","module":"auth-service","email":"reset@example.com","msg":"Password reset email sent"}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495844812,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768495844819,"env":"test","module":"auth-service","tokenHash":"0f45e858fbc4176cdf4e411f88281edefc390ae5afe7df0f44cd9297f0a64580","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
 [32m‚úì[39m tests/ui/common/Breadcrumbs.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 2442[2mms[22m[39m
[90mstderr[2m | tests/ui/runs.components.test.tsx
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495844875,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK initialized successfully"}
{"level":30,"time":1768495844875,"env":"test","module":"telemetry","msg":"Prometheus metrics initialized"}
{"level":30,"time":1768495844876,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":40,"time":1768495844882,"env":"test","module":"metrics-routes","ip":"::ffff:127.0.0.1","msg":"Unauthorized metrics access attempt"}
{"level":30,"time":1768495844821,"env":"test","module":"auth-service","tokenHash":"9206c2394794b8fc97fcd896f95e40028ab7a15c10279446c23fbdd4b4ae7a1e","plainTokenLen":13,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768495844821,"env":"test","module":"auth-service","tokenHash":"9206c2394794b8fc97fcd896f95e40028ab7a15c10279446c23fbdd4b4ae7a1e","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768495844821,"env":"test","module":"auth-service","allTokensCount":0,"msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768495844823,"env":"test","module":"auth-service","tokenHash":"0f45e858fbc4176cdf4e411f88281edefc390ae5afe7df0f44cd9297f0a64580","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768495844823,"env":"test","module":"auth-service","userId":"user-123","tokenHash":"0f45e858fbc4176cdf4e411f88281edefc390ae5afe7df0f44cd9297f0a64580","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768495844826,"env":"test","module":"auth-service","tokenHash":"0f45e858fbc4176cdf4e411f88281edefc390ae5afe7df0f44cd9297f0a64580","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768495844826,"env":"test","module":"auth-service","userId":"user-123","msg":"Security: Expired refresh token used"}
{"level":30,"time":1768495844849,"env":"test","module":"auth-service","msg":"Cleaned up expired tokens and old login attempts"}
{"level":30,"time":1768495844851,"env":"test","module":"auth-service","msg":"Cleaned up expired tokens and old login attempts"}
{"level":30,"time":1768495844852,"env":"test","module":"auth-service","msg":"Cleaned up expired tokens and old login attempts"}
{"level":30,"time":1768495844854,"env":"test","module":"auth-service","msg":"Cleaned up expired tokens and old login attempts"}
{"level":30,"time":1768495844894,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK shut down successfully"}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495844895,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495844895,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould not validate when workflowId or nodeId is missing
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould not validate when workflowId or nodeId is missing
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

 [32m‚úì[39m tests/integration/metrics.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 2154[2mms[22m[39m
     [33m[2m‚úì[22m[39m should expose /metrics endpoint [33m 318[2mms[22m[39m
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression validation integration[2m > [22m[2mshould validate helper functions in expressions
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression validation integration[2m > [22m[2mshould validate complex expressions with multiple helpers
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression validation integration[2m > [22m[2mshould handle syntax errors
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression Editor component behavior[2m > [22m[2mshould update validation when expression changes
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768495845665,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression Editor component behavior[2m > [22m[2mshould update validation when expression changes
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

{"level":30,"time":1768495845835,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495845835,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495845837,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768495845835,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768495845909,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768495845912,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/ui/datavault/DatabaseSettingsPage.test.tsx [2m([22m[2m7 tests[22m[2m)[22m[33m 2997[2mms[22m[39m
     [33m[2m‚úì[22m[39m should render database settings page with breadcrumbs [33m 502[2mms[22m[39m
 [32m‚úì[39m tests/unit/components/datavault/CellRenderer.test.tsx [2m([22m[2m12 tests[22m[2m)[22m[33m 2946[2mms[22m[39m
     [33m[2m‚úì[22m[39m renders boolean value as Yes/No [33m 566[2mms[22m[39m
 [32m‚úì[39m tests/ui/expression-editor.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 5280[2mms[22m[39m
{"level":30,"time":1768495846082,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495846111,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w69

{"level":30,"time":1768495846177,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495846178,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w69,public

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w71

 [32m‚úì[39m tests/unit/components/datavault/TableGridViewDragDrop.test.tsx [2m([22m[2m7 tests[22m[2m)[22m[33m 3407[2mms[22m[39m
     [33m[2m‚úì[22m[39m displays columns in order based on orderIndex [33m 613[2mms[22m[39m
     [33m[2m‚úì[22m[39m maintains column order after successful reorder [33m 329[2mms[22m[39m
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w69 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w69%2Cpublic

 [32m‚úì[39m tests/ui/datavault/TableCard.test.tsx [2m([22m[2m8 tests[22m[2m)[22m[33m 3715[2mms[22m[39m
     [33m[2m‚úì[22m[39m should call onDelete when delete button is clicked [33m 1436[2mms[22m[39m
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w71,public

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w72

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w71 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w71%2Cpublic

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w72,public

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w72 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w72%2Cpublic

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

{"level":30,"time":1768495847132,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495847149,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w73

 [32m‚úì[39m tests/unit/collab.client.test.tsx [2m([22m[2m17 tests[22m[2m)[22m[33m 4468[2mms[22m[39m
     [33m[2m‚úì[22m[39m should add a comment [33m 806[2mms[22m[39m
     [33m[2m‚úì[22m[39m should allow comment owner to delete their comment [33m 547[2mms[22m[39m
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w73,public

{"level":30,"time":1768495847337,"env":"test","module":"auth-service","tokenHash":"94cf67b182150b4b21de0805ac4c10715f0e1d39f7ec2382ac9d2dc4a6059ea8","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768495847341,"env":"test","module":"auth-service","email":"reset@example.com","msg":"Password reset email sent"}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w73 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w73%2Cpublic

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495847396,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495847460,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495847477,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w75

[90mstderr[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":50,"time":1768495847559,"env":"test","status":401,"statusText":"Unauthorized","error":"Invalid client credentials","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token request failed"}
[90mstderr[2m | tests/integration/api.ai.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":50,"time":1768495847567,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768495847575,"env":"test","data":{"token_type":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768495847577,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768495847578,"env":"test","data":{"access_token":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768495847578,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768495847580,"env":"test","error":"Network error: ECONNREFUSED","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":30,"time":1768495847595,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495847595,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w75,public

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w75 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w75%2Cpublic

{"level":50,"time":1768495847686,"env":"test","error":"Invalid credentials","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":50,"time":1768495847687,"env":"test","error":"ECONNREFUSED","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768495847689,"env":"test","status":400,"statusText":"Bad Request","error":"Invalid grant_type","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768495847689,"env":"test","error":"OAuth2 token request failed: 400 Bad Request","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768495847689,"env":"test","status":401,"statusText":"Unauthorized","error":"Client authentication failed","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768495847690,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768495847690,"env":"test","status":403,"statusText":"Forbidden","error":"Access denied","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768495847690,"env":"test","error":"OAuth2 token request failed: 403 Forbidden","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768495847690,"env":"test","status":500,"statusText":"Internal Server Error","error":"Server error","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768495847690,"env":"test","error":"OAuth2 token request failed: 500 Internal Server Error","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768495847691,"env":"test","error":"Unexpected token in JSON","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768495847691,"env":"test","error":"Request timeout","tokenUrl":"‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢","msg":"OAuth2 token fetch error"}
{"level":30,"time":1768495847692,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495847693,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/api.ai.test.ts [2m([22m[2m32 tests[22m[2m)[22m[33m 1645[2mms[22m[39m
 [32m‚úì[39m tests/integration/auth/oauth2.client-credentials.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 1853[2mms[22m[39m
[90mstderr[2m | tests/ui/datavault/EditableCell.test.tsx[2m > [22m[2mEditableCell Component[2m > [22m[2mError Handling[2m > [22m[2mreverts value on save error
[22m[39mFailed to save cell: Error: Network error
    at C:/Users/scoot/poll/VaultLogic/tests/ui/datavault/EditableCell.test.tsx:206:36
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

{"level":30,"time":1768495847777,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495847778,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w76

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w77

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w76,public

 [32m‚úì[39m tests/ui/datavault/TemplateCard.test.tsx [2m([22m[2m6 tests[22m[2m)[22m[33m 2104[2mms[22m[39m
{"level":30,"time":1768495847909,"env":"test","module":"auth-service","email":"reset@example.com","msg":"Password reset email sent"}
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w76 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w76%2Cpublic

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w77,public

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w77 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w77%2Cpublic

[90mstderr[2m | tests/ui/datavault/EditableCell.test.tsx[2m > [22m[2mEditableCell Component[2m > [22m[2mError Handling[2m > [22m[2mdisplays error indicator on save failure
[22m[39mFailed to save cell: Error: Network error
    at C:/Users/scoot/poll/VaultLogic/tests/ui/datavault/EditableCell.test.tsx:222:36
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495848385,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w70

[90mstderr[2m | tests/integration/mfa.flow.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495848456,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w78

{"level":30,"time":1768495848477,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495848481,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w70,public

{"level":30,"time":1768495848458,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

 [32m‚úì[39m tests/integration/mfa.flow.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 1688[2mms[22m[39m
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w70 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w70%2Cpublic

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w78,public

[90mstderr[2m | tests/ui/datavault/EditableCell.test.tsx[2m > [22m[2mEditableCell Component[2m > [22m[2mBoolean Type (Checkbox)[2m > [22m[2mshows loading spinner when saving checkbox
[22m[39mWarning: An update to EditableCell inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at EditableCell (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/EditableCell.tsx:12:25)

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w78 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w78%2Cpublic

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

 [32m‚úì[39m tests/unit/components/datavault/TableGridView.test.tsx [2m([22m[2m9 tests[22m[2m)[22m[33m 5753[2mms[22m[39m
     [33m[2m‚úì[22m[39m loads table schema and rows [33m 780[2mms[22m[39m
     [33m[2m‚úì[22m[39m enters edit mode on double click [33m 585[2mms[22m[39m
     [33m[2m‚úì[22m[39m updates cell value on blur [33m 1201[2mms[22m[39m
     [33m[2m‚úì[22m[39m renders delete button for each row [33m 494[2mms[22m[39m
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495848738,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495848805,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495848806,"env":"test","msg":"DB: pool closed."}
{"level":40,"time":1768495848808,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":40,"time":1768495848836,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":40,"time":1768495848849,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":40,"time":1768495848856,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":40,"time":1768495848859,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
{"level":30,"time":1768495848869,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495848870,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/services/AuthService.test.ts [2m([22m[2m113 tests[22m[2m)[22m[33m 10318[2mms[22m[39m
         [33m[2m‚úì[22m[39m should generate different hashes for same password [33m 531[2mms[22m[39m
         [33m[2m‚úì[22m[39m should return true for correct password [33m 628[2mms[22m[39m
         [33m[2m‚úì[22m[39m should return false for incorrect password [33m 585[2mms[22m[39m
         [33m[2m‚úì[22m[39m should be case-sensitive [33m 615[2mms[22m[39m
         [33m[2m‚úì[22m[39m should handle empty password comparison [33m 502[2mms[22m[39m
         [33m[2m‚úì[22m[39m should throw error for expired token [33m 1126[2mms[22m[39m
         [33m[2m‚úì[22m[39m should handle password with special characters [33m 633[2mms[22m[39m
         [33m[2m‚úì[22m[39m should handle password with only spaces [33m 335[2mms[22m[39m
         [33m[2m‚úì[22m[39m should handle password with newlines and tabs [33m 566[2mms[22m[39m
         [33m[2m‚úì[22m[39m should reject password with null bytes (if validation exists) [33m 631[2mms[22m[39m
         [33m[2m‚úì[22m[39m should support complete password reset workflow [33m 563[2mms[22m[39m
         [33m[2m‚úì[22m[39m should compare password in reasonable time (< 500ms) [33m 619[2mms[22m[39m
 [32m‚úì[39m tests/unit/isolatedVmBridge.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 1736[2mms[22m[39m
 [32m‚úì[39m tests/ui/runs.components.test.tsx [2m([22m[2m19 tests[22m[2m)[22m[33m 5959[2mms[22m[39m
       [33m[2m‚úì[22m[39m should render runs table with correct columns [33m 324[2mms[22m[39m
       [33m[2m‚úì[22m[39m should show download options for successful runs [33m 1602[2mms[22m[39m
       [33m[2m‚úì[22m[39m should call onChange when status filter changes [33m 769[2mms[22m[39m
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w79

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w80

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w79,public

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495849084,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w80,public

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495849121,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w79 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w79%2Cpublic

[90mstderr[2m | tests/unit/services/repeater.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w80 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w80%2Cpublic

{"level":30,"time":1768495849163,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495849164,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w81

[90mstderr[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

 [32m‚úì[39m tests/unit/services/repeater.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 1761[2mms[22m[39m
{"level":30,"time":1768495849243,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495849243,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768495849269,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495849270,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w81,public

 [32m‚úì[39m tests/unit/workflows/conditionTruthTable.test.ts [2m([22m[2m51 tests[22m[2m)[22m[33m 1826[2mms[22m[39m
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w81 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w81%2Cpublic

 [32m‚úì[39m tests/ui/datavault/EditableCell.test.tsx [2m([22m[2m29 tests[22m[2m)[22m[33m 7890[2mms[22m[39m
       [33m[2m‚úì[22m[39m shows double-click hint on hover [33m 560[2mms[22m[39m
       [33m[2m‚úì[22m[39m saves on blur [33m 449[2mms[22m[39m
       [33m[2m‚úì[22m[39m saves on Enter key press [33m 523[2mms[22m[39m
       [33m[2m‚úì[22m[39m cancels edit on Escape key press [33m 465[2mms[22m[39m
       [33m[2m‚úì[22m[39m reverts value on save error [33m 487[2mms[22m[39m
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495849682,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w74

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w82

[90mstderr[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495849777,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495849777,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w74,public

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

 [32m‚úì[39m tests/unit/WorkflowOptimizationService.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 1742[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w82,public

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495849859,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39müîí Test Schema Isolated: test_schema_w74 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w74%2Cpublic

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w83

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w82 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w82%2Cpublic

[90mstderr[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w83,public

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w83 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w83%2Cpublic

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495850146,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495850206,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w84

{"level":30,"time":1768495850233,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495850234,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495850264,"env":"test","msg":"DB: initializing... Local"}
 [32m‚úì[39m tests/ui/blocks/SendDataBlockEditorRouting.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 1648[2mms[22m[39m
[90mstderr[2m | tests/unit/engine.expr.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w84,public

{"level":30,"time":1768495850314,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w85

{"level":30,"time":1768495850314,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495850316,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495850317,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":40,"time":1768495850339,"env":"test","module":"auth-middleware","path":"/test","msg":"No authorization token provided"}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w84 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w84%2Cpublic

 [32m‚úì[39m tests/unit/engine.expr.test.ts [2m([22m[2m26 tests[22m[2m)[22m[33m 1715[2mms[22m[39m
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w86

{"level":50,"time":1768495850355,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768495850360,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768495850361,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768495850362,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768495850362,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768495850363,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768495850366,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768495850369,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768495850369,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768495850370,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768495850370,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768495850372,"env":"test","module":"auth-middleware","path":"/test","msg":"No authorization token provided"}
{"level":30,"time":1768495850373,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495850374,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/components/datavault/SortableColumnHeader.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 2370[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w85,public

 [32m‚úì[39m tests/unit/middleware/auth.middleware.test.ts [2m([22m[2m22 tests[22m[2m)[22m[33m 1582[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w85 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w85%2Cpublic

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w86,public

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w86 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w86%2Cpublic

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w88

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w89

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w88,public

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w87

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w88 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w88%2Cpublic

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w89,public

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w87,public

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w89 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w89%2Cpublic

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w87 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w87%2Cpublic

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495850864,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstderr[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w90

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495851128,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/unit/shared/conditionEvaluator.test.ts[2m > [22m[2mconditionEvaluator[2m > [22m[2mComparison operators[2m > [22m[2mUnknown operator[2m > [22m[2mshould default to true and log warning
[22m[39mUnknown operator: unknown_operator

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495851137,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w90,public

{"level":30,"time":1768495851161,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495851161,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w90 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w90%2Cpublic

[90mstderr[2m | tests/unit/client/choice-utils.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/unit/client/choice-utils.test.ts[2m > [22m[2mchoice-utils[2m > [22m[2mhandles missing content gracefully
[22m[39m[generateOptionsFromList] Invalid list data: [1mnull[22m

{"level":30,"time":1768495851243,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495851244,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/client/choice-utils.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 1764[2mms[22m[39m
 [32m‚úì[39m tests/unit/shared/conditionEvaluator.test.ts [2m([22m[2m70 tests[22m[2m)[22m[33m 1859[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495851386,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w91

{"level":30,"time":1768495851404,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495851405,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/unit/utils/encryption.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

 [32m‚úì[39m tests/ui/datavault/ColumnTypeIcon.test.tsx [2m([22m[2m27 tests[22m[2m)[22m[33m 2169[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w94

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w91,public

{"level":30,"time":1768495851497,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495851498,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w91 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w91%2Cpublic

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495851566,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w94,public

 [32m‚úì[39m tests/unit/utils/encryption.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 1662[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w94 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w94%2Cpublic

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w92

[90mstderr[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495851687,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495851688,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

 [32m‚úì[39m tests/unit/utils/conditionalLogic-simple.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 1769[2mms[22m[39m
{"level":30,"time":1768495851729,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w92,public

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w92 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w92%2Cpublic

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495851806,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/integration/auth.routes.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495851872,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w93

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstderr[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495851875,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495851876,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495851916,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495851916,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/auth.routes.test.ts [2m([22m[2m41 tests[22m[2m)[22m[33m 1722[2mms[22m[39m
[90mstderr[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w93,public

{"level":30,"time":1768495851966,"env":"test","msg":"DB: closing pool..."}
 [32m‚úì[39m tests/unit/utils/variableResolver.test.ts [2m([22m[2m20 tests[22m[2m)[22m[33m 1984[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495851966,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

 [32m‚úì[39m tests/unit/utils/conditionalLogic.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 1706[2mms[22m[39m
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w93 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w93%2Cpublic

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495852067,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstderr[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495852230,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495852231,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/conditions/conditionEvaluation.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 1953[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495852321,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/unit/engine/Performance.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495852432,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495852433,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w95

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

 [32m‚úì[39m tests/unit/engine/Performance.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 1814[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w96

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w95,public

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495852582,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w95 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w95%2Cpublic

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w96,public

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w96 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w96%2Cpublic

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w98

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495852690,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstderr[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495852759,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495852759,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

{"level":30,"time":1768495852769,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495852770,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w98,public

 [32m‚úì[39m tests/unit/services/docxHelpers.test.ts [2m([22m[2m39 tests[22m[2m)[22m[33m 1829[2mms[22m[39m
 [32m‚úì[39m tests/unit/shared/validation/PageValidator.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 1678[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w97

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w98 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w98%2Cpublic

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w97,public

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w97 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w97%2Cpublic

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495852994,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstderr[2m | tests/integration/intake.portal.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495853061,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495853061,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495853083,"env":"test","msg":"DB: initializing... Local"}
 [32m‚úì[39m tests/integration/intake.portal.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 1851[2mms[22m[39m
[90mstderr[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495853182,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495853184,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/workflow/QueryBlock.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 1708[2mms[22m[39m
[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w101

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w101,public

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w101 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w101%2Cpublic

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w99

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w102

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w100

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m‚úÖ OpenAPI specification loaded successfully

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w99,public

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w103

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w102,public

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w99 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w99%2Cpublic

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w100,public

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w102 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w102%2Cpublic

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w103,public

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w100 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w100%2Cpublic

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w103 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w103%2Cpublic

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495853696,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w104

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495853746,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

{"level":30,"time":1768495853811,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495853812,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w104,public

 [32m‚úì[39m tests/unit/shared/validation/stepConfigSchemas.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 1729[2mms[22m[39m
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w104 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w104%2Cpublic

{"level":30,"time":1768495853887,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495853887,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w31

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

 [32m‚úì[39m tests/unit/listPipeline.semantics.test.ts [2m([22m[2m70 tests[22m[2m)[22m[33m 1888[2mms[22m[39m
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495854005,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w31,public

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w31 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w31%2Cpublic

{"level":30,"time":1768495854079,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/ui/builder.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495854092,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495854093,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w106

 [32m‚úì[39m tests/ui/builder.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 1835[2mms[22m[39m
[90mstderr[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:148:9

{"level":30,"time":1768495854149,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495854160,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w106,public

[90mstderr[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts[2m > [22m[2mPersonalization API Integration Tests
[22m[39müìö API Documentation available at /api-docs
[Routes] E-Signature routes registered at /api/esign

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495854163,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768495854164,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768495854199,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768495854227,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495854227,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w105

[90mstderr[2m | tests/unit/shared/workflowLogic.test.ts[2m > [22m[2mworkflowLogic[2m > [22m[2mevaluateRules[2m > [22m[2mOperators[2m > [22m[2mUnknown operator[2m > [22m[2mshould return false and log warning for unknown operator
[22m[39mUnknown operator: unknown_operator

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w106 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w106%2Cpublic

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495854251,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495854251,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w105,public

 [32m‚úì[39m tests/unit/shared/workflowLogic.test.ts [2m([22m[2m65 tests[22m[2m)[22m[33m 1841[2mms[22m[39m
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w105 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w105%2Cpublic

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w107

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495854471,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w108

[90mstderr[2m | tests/unit/middleware/rbac.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w107,public

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w107 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w107%2Cpublic

{"level":40,"time":1768495854593,"env":"test","module":"rbac-middleware","path":"/api/workflows","permission":"workflow:create","msg":"Unauthenticated user attempted to access protected resource"}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w108,public

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w108 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w108%2Cpublic

{"level":30,"time":1768495854650,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":40,"time":1768495854598,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","permission":"workflow:create","path":"/api/workflows","msg":"Permission denied"}
{"level":40,"time":1768495854600,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":null,"permission":"workflow:view","path":"/api/workflows","msg":"Permission denied"}
{"level":40,"time":1768495854602,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","permissions":["workflow:create","workflow:edit","workflow:delete"],"path":"/api/workflows","msg":"Permission denied (none of required permissions)"}
{"level":40,"time":1768495854604,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"builder","permissions":["workflow:edit","workflow:delete"],"path":"/api/workflows","msg":"Permission denied (missing some required permissions)"}
{"level":40,"time":1768495854607,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","requiredRoles":["owner","builder"],"path":"/api/admin","msg":"Role check failed"}
{"level":40,"time":1768495854608,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":null,"requiredRoles":["owner"],"path":"/api/admin","msg":"Role check failed"}
{"level":40,"time":1768495854609,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"builder","requiredRoles":["owner"],"path":"/api/test","msg":"Role check failed"}
{"level":40,"time":1768495854611,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"runner","requiredRoles":["owner","builder"],"path":"/api/test","msg":"Role check failed"}
{"level":40,"time":1768495854613,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","requiredRoles":["owner","builder","runner"],"path":"/api/test","msg":"Role check failed"}
{"level":40,"time":1768495854644,"env":"test","module":"rbac-middleware","path":"/api/test","permission":"workflow:view","msg":"Unauthenticated user attempted to access protected resource"}
{"level":40,"time":1768495854645,"env":"test","module":"rbac-middleware","userId":"user-123","permission":"workflow:view","path":"/api/test","msg":"Permission denied"}
{"level":40,"time":1768495854650,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"invalid-role","permission":"workflow:view","path":"/api/test","msg":"Permission denied"}
{"level":30,"time":1768495854651,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495854652,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/integration/api.ai.personalization.test.ts [2m([22m[2m3 tests[22m[2m | [22m[33m3 skipped[39m[2m)[22m[33m 693[2mms[22m[39m
       [2m[90m‚Üì[39m[22m should rewrite text based on user settings
       [2m[90m‚Üì[39m[22m should generate help text
       [2m[90m‚Üì[39m[22m should update user settings
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495854698,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/unit/captcha.service.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495854743,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

{"level":30,"time":1768495854766,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstderr[2m | tests/unit/ScriptEngine.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495854767,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495854783,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768495854809,"env":"test","warnings":["Python code does not call emit(). Script will not produce output."],"msg":"Script validation warnings"}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495854812,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495854812,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/middleware/rbac.test.ts [2m([22m[2m44 tests[22m[2m)[22m[33m 1802[2mms[22m[39m
[90mstderr[2m | tests/unit/HelperLibrary.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

 [32m‚úì[39m tests/unit/ScriptEngine.test.ts [2m([22m[2m26 tests[22m[2m | [22m[33m4 skipped[39m[2m)[22m[33m 1818[2mms[22m[39m
[90mstderr[2m | tests/integration/session.management.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495854916,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768495854952,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495854953,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/captcha.service.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 1734[2mms[22m[39m
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstderr[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

 [32m‚úì[39m tests/unit/HelperLibrary.test.ts [2m([22m[2m60 tests[22m[2m)[22m[33m 1841[2mms[22m[39m
{"level":30,"time":1768495855005,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768495855005,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768495854984,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495854984,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/WorkflowChangeAnalyzer.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 1668[2mms[22m[39m
 [32m‚úì[39m tests/integration/session.management.test.ts [2m([22m[2m22 tests[22m[2m)[22m[33m 1944[2mms[22m[39m
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w110

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495855341,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w110,public

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w110 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w110%2Cpublic

[90mstderr[2m | tests/unit/workflows/validation.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495855489,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495855489,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w111

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495855598,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w111,public

[90mstderr[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

 [32m‚úì[39m tests/unit/workflows/validation.test.ts [2m([22m[2m66 tests[22m[2m)[22m[33m 1872[2mms[22m[39m
[90mstderr[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts[2m > [22m[2mIntakeQuestionVisibilityService[2m > [22m[2mHelper methods[2m > [22m[2mshould get visible question count
[22m[39mMOCK SETUP DONE. Mock questions: [
  {
    id: [32m'q1'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q1'[39m,
    order: [33m0[39m,
    isVirtual: [33mfalse[39m,
    alias: [32m'show'[39m,
    visibleIf: [1mnull[22m
  },
  {
    id: [32m'q2'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q2'[39m,
    order: [33m1[39m,
    isVirtual: [33mfalse[39m,
    visibleIf: { op: [32m'equals'[39m, left: [36m[Object][39m, right: [36m[Object][39m }
  },
  {
    id: [32m'q3'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q3'[39m,
    order: [33m2[39m,
    isVirtual: [33mfalse[39m,
    visibleIf: [1mnull[22m
  }
]
Calling getVisibleQuestionCount...

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts[2m > [22m[2mIntakeQuestionVisibilityService[2m > [22m[2mHelper methods[2m > [22m[2mshould get visible question count
[22m[39mCOUNT RESULT: [33m0[39m
Mock called times: [33m1[39m
Mock last call args: [ [ [32m'section1'[39m ] ]

{"level":50,"time":1768495855725,"env":"test","module":"intake-question-visibility","error":{},"questionId":"q1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating visibleIf condition"}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495855727,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495855727,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w111 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w111%2Cpublic

 [32m‚úì[39m tests/unit/BlockRunner.validate.test.ts [2m([22m[2m7 tests[22m[2m)[22m[33m 1907[2mms[22m[39m
 [32m‚úì[39m tests/unit/services/intakeQuestionVisibility.test.ts [2m([22m[2m19 tests[22m[2m)[22m[33m 1784[2mms[22m[39m
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495855821,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

{"level":30,"time":1768495855962,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495855963,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/services/RunExecutionCoordinator.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 1891[2mms[22m[39m
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w109

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w112

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w109,public

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w112,public

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w109 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w109%2Cpublic

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w112 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w112%2Cpublic

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w117

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w114

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w113

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w117,public

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w117 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w117%2Cpublic

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w114,public

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîë add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w113,public

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w114 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w114%2Cpublic

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495856474,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w113 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w113%2Cpublic

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstderr[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w119

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w119,public

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495856694,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495856695,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w119 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w119%2Cpublic

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

 [32m‚úì[39m tests/unit/client/list-choice-options.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 1853[2mms[22m[39m
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495857092,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495857206,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495857207,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495857227,"env":"test","msg":"DB: initializing... Local"}
 [32m‚úì[39m tests/unit/shared/validation/Validator.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 2118[2mms[22m[39m
[90mstderr[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495857307,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768495857331,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495857332,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

 [32m‚úì[39m tests/unit/services/docxRenderer2.test.ts [2m([22m[2m27 tests[22m[2m)[22m[33m 1763[2mms[22m[39m
{"level":30,"time":1768495857425,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495857425,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495857448,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w115

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w116

 [32m‚úì[39m tests/unit/services/TemplateAnalysisService.test.ts [2m([22m[2m27 tests[22m[2m)[22m[33m 1823[2mms[22m[39m
[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w115,public

[90mstderr[2m | tests/unit/utils/pagination.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w116,public

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w118

{"level":30,"time":1768495857606,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w115 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w115%2Cpublic

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

{"level":30,"time":1768495857607,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w116 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w116%2Cpublic

{"level":30,"time":1768495857622,"env":"test","msg":"DB: initializing... Local"}
 [32m‚úì[39m tests/unit/utils/pagination.test.ts [2m([22m[2m24 tests[22m[2m)[22m[33m 1782[2mms[22m[39m
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495857659,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w118,public

[90mstderr[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495857701,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495857702,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w118 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w118%2Cpublic

{"level":50,"time":1768495857728,"env":"test","module":"intake-navigation","error":{},"pageId":"page1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating visibleIf condition"}
{"level":30,"time":1768495857728,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/repositories/DatavaultTablesRepository.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 850[2mms[22m[39m
{"level":50,"time":1768495857729,"env":"test","module":"intake-navigation","error":{},"pageId":"page1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating skipIf condition"}
{"level":30,"time":1768495857730,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495857731,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstderr[2m | tests/unit/services/CollectionService.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

 [32m‚úì[39m tests/unit/services/intakeNavigation.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 1864[2mms[22m[39m
{"level":30,"time":1768495857838,"env":"test","workflowId":"123e4567-e89b-12d3-a456-426614174000","userId":"user-123","sectionsCount":2,"stepsCount":0,"logicRulesCount":1,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495857878,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495857879,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/services/WorkflowService.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 2028[2mms[22m[39m
       [33m[2m‚úì[22m[39m should return workflow if user is the creator [33m 1423[2mms[22m[39m
 [32m‚úì[39m tests/unit/services/CollectionService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 778[2mms[22m[39m
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495858007,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/unit/services/AIService.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495858106,"env":"test","module":"ai-service","estimatedInputTokens":18,"estimatedOutputTokens":36,"sectionCount":0,"msg":"Attempting single-shot workflow revision"}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495858108,"env":"test","module":"gemini-provider","event":"ai_request_success","provider":"gemini","model":"gemini-2.0-flash-exp","taskType":"workflow_revision","promptTokens":812,"responseTokens":66,"durationMs":1,"estimatedCostUSD":0.00010760000000000001,"msg":"Gemini request succeeded"}
{"level":30,"time":1768495858111,"env":"test","module":"ai-service","duration":5,"workflowId":"123","changeCount":1,"msg":"AI workflow revision succeeded"}
{"level":30,"time":1768495858115,"env":"test","module":"ai-service","estimatedInputTokens":18,"estimatedOutputTokens":36,"sectionCount":0,"msg":"Attempting single-shot workflow revision"}
{"level":30,"time":1768495858116,"env":"test","module":"gemini-provider","event":"ai_request_success","provider":"gemini","model":"gemini-2.0-flash-exp","taskType":"workflow_revision","promptTokens":812,"responseTokens":45,"durationMs":0,"estimatedCostUSD":0.00009920000000000001,"msg":"Gemini request succeeded"}
{"level":30,"time":1768495858116,"env":"test","module":"ai-service","duration":0,"workflowId":"123","changeCount":0,"msg":"AI workflow revision succeeded"}
{"level":30,"time":1768495858117,"env":"test","module":"ai-service","estimatedInputTokens":18,"estimatedOutputTokens":36,"sectionCount":0,"msg":"Attempting single-shot workflow revision"}
{"level":30,"time":1768495858118,"env":"test","module":"gemini-provider","event":"ai_request_success","provider":"gemini","model":"gemini-2.0-flash-exp","taskType":"workflow_revision","promptTokens":811,"responseTokens":4,"durationMs":1,"estimatedCostUSD":0.0000827,"msg":"Gemini request succeeded"}
{"level":40,"time":1768495858118,"env":"test","module":"ai-provider","lastChar":"N","last50":"I am not JSON","msg":"Response does not end with closing brace/bracket"}
{"level":50,"time":1768495858118,"env":"test","module":"ai-service","responseLength":13,"estimatedTokens":4,"responseSuffix":"I am not JSON","msg":"Detected truncated AI response - workflow too large for single-shot revision"}
{"level":50,"time":1768495858118,"env":"test","module":"ai-service","error":{"code":"RESPONSE_TRUNCATED","estimatedTokens":4,"responseLength":13},"duration":1,"msg":"AI workflow revision failed"}
{"level":40,"time":1768495858118,"env":"test","module":"ai-service","estimatedInputTokens":18,"estimatedOutputTokens":36,"actualOutputTokens":4,"responseLength":13,"msg":"Single-shot revision truncated - automatically retrying with chunking"}
{"level":30,"time":1768495858119,"env":"test","module":"gemini-provider","event":"ai_request_success","provider":"gemini","model":"gemini-2.0-flash-exp","taskType":"workflow_revision","promptTokens":811,"responseTokens":4,"durationMs":0,"estimatedCostUSD":0.0000827,"msg":"Gemini request succeeded"}
{"level":40,"time":1768495858120,"env":"test","module":"ai-provider","lastChar":"N","last50":"I am not JSON","msg":"Response does not end with closing brace/bracket"}
{"level":50,"time":1768495858120,"env":"test","module":"ai-service","responseLength":13,"estimatedTokens":4,"responseSuffix":"I am not JSON","msg":"Detected truncated AI response - workflow too large for single-shot revision"}
{"level":50,"time":1768495858120,"env":"test","module":"ai-service","error":{"code":"RESPONSE_TRUNCATED","estimatedTokens":4,"responseLength":13},"duration":1,"msg":"AI workflow revision failed"}
{"level":50,"time":1768495858120,"env":"test","module":"ai-service","duration":3,"error":{"code":"RESPONSE_TRUNCATED","estimatedTokens":4,"responseLength":13},"msg":"AI workflow revision failed"}
{"level":30,"time":1768495858122,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495858123,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w122

 [32m‚úì[39m tests/unit/services/AIService.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 1947[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w122,public

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w122 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w122%2Cpublic

{"level":30,"time":1768495858304,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495858387,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495858388,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

 [32m‚úì[39m tests/unit/services/DataSourceService.test.ts [2m([22m[2m9 tests[22m[2m)[22m[33m 798[2mms[22m[39m
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w123

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w123,public

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w123 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w123%2Cpublic

{"level":30,"time":1768495858658,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495858747,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495858748,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/repositories/DatavaultColumnsRepository.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 634[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }

 [32m‚úì[39m tests/unit/services/MfaService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 2209[2mms[22m[39m
         [33m[2m‚úì[22m[39m should try multiple codes if first doesn't match [33m 315[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w124

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w124,public

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w124 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w124%2Cpublic

{"level":30,"time":1768495859455,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts[2m > [22m[2mDatavaultColumnsService[2m > [22m[2mgetColumns[2m > [22m[2mshould throw 404 if table not found
[22m[39m[DEBUG] Table not found: 660e8400-e29b-41d4-a716-446655440001

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495859575,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495859576,"env":"test","msg":"DB: pool closed."}
 [31m‚ùØ[39m tests/unit/services/DatavaultColumnsService.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 732[2mms[22m[39m
       [32m‚úì[39m should get all columns for a table[32m 24[2mms[22m[39m
       [32m‚úì[39m should throw 404 if table not found[32m 9[2mms[22m[39m
       [32m‚úì[39m should create column with generated slug[32m 2[2mms[22m[39m
       [32m‚úì[39m should ensure unique slug by appending counter[32m 3[2mms[22m[39m
       [32m‚úì[39m should use provided slug if given[32m 1[2mms[22m[39m
       [32m‚úì[39m should update column[32m 1[2mms[22m[39m
       [32m‚úì[39m should throw error if trying to change column type[32m 1[2mms[22m[39m
[31m       [31m√ó[31m should delete column[39m[32m 6[2mms[22m[39m
       [32m‚úì[39m should reorder columns[32m 3[2mms[22m[39m
       [32m‚úì[39m should create select column with valid options[32m 1[2mms[22m[39m
       [32m‚úì[39m should create multiselect column with valid options[32m 1[2mms[22m[39m
       [32m‚úì[39m should reject select column without options[32m 1[2mms[22m[39m
       [32m‚úì[39m should reject options with duplicate values[32m 1[2mms[22m[39m
       [32m‚úì[39m should reject options without label or value[32m 1[2mms[22m[39m
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w125

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w125,public

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w125 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w125%2Cpublic

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768495859887,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w121

[90mstderr[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495859986,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495859987,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w127

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w121,public

 [32m‚úì[39m tests/unit/schema/documentEngine.test.ts [2m([22m[2m33 tests[22m[2m)[22m[33m 687[2mms[22m[39m
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w121 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w121%2Cpublic

{"level":30,"time":1768495860045,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/ListTools.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w127,public

[90mstderr[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:148:9

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w120

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w127 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w127%2Cpublic

{"level":30,"time":1768495860158,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768495860168,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495860168,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w128

[90mstderr[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w120,public

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495860230,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495860231,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w120 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w120%2Cpublic

{"level":30,"time":1768495860274,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w128,public

 [32m‚úì[39m tests/services/EmailTemplateMetadataService.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 706[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w129

 [32m‚úì[39m tests/unit/workflow/PreviewExecution.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 706[2mms[22m[39m
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w128 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w128%2Cpublic

{"level":30,"time":1768495860350,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:148:9

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould skip question when condition is false
[22m[39m[DEBUG Question] Node q1 executed. Key: has_code, Value: false. Context keys: 3

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould execute question when condition is true
[22m[39m[DEBUG Question] Node q1 executed. Key: has_code, Value: true. Context keys: 4

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould execute question when condition is true
[22m[39m[DEBUG Question] Node q2 executed. Key: code, Value: ABC123. Context keys: 5

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould skip compute node when condition is false
[22m[39m[DEBUG Question] Node q1 executed. Key: amount, Value: 0. Context keys: 3

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould execute compute node when condition is true
[22m[39m[DEBUG Question] Node q1 executed. Key: amount, Value: 100. Context keys: 3

[90mstderr[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould handle complex workflow with multiple conditions
[22m[39m[DEBUG Question] Node q1 executed. Key: has_code, Value: false. Context keys: 4

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould handle complex workflow with multiple conditions
[22m[39m[DEBUG Question] Node q3 executed. Key: amount, Value: 1000. Context keys: 5

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mDebug Mode[2m > [22m[2mshould return trace when debug is enabled
[22m[39m[DEBUG Question] Node q1 executed. Key: name, Value: John. Context keys: 3

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mDebug Mode[2m > [22m[2mshould not return trace when debug is disabled
[22m[39m[DEBUG Question] Node q1 executed. Key: name, Value: John. Context keys: 3

{"level":30,"time":1768495860413,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w129,public

{"level":30,"time":1768495860414,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768495860471,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495860472,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w129 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w129%2Cpublic

{"level":30,"time":1768495860491,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w132

 [32m‚úì[39m tests/unit/services/CollectionFieldService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 724[2mms[22m[39m
[90mstderr[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495860578,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495860579,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/engine.run-conditions.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 748[2mms[22m[39m
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w132,public

 [32m‚úì[39m tests/unit/services/DatavaultTablesService.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 666[2mms[22m[39m
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w130

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w131

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w132 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w132%2Cpublic

{"level":30,"time":1768495860662,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w133

[90mstderr[2m | tests/services/BrandingService.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w134

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w130,public

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w131,public

{"level":30,"time":1768495860757,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w133,public

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w130 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w130%2Cpublic

{"level":30,"time":1768495860787,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w131 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w131%2Cpublic

{"level":30,"time":1768495860793,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768495860758,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w134,public

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w133 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w133%2Cpublic

{"level":30,"time":1768495860833,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/unit/services/StepService.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w134 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w134%2Cpublic

{"level":30,"time":1768495860874,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768495860876,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495860877,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768495860885,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstderr[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495860886,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768495860922,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495860923,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

 [32m‚úì[39m tests/services/BrandingService.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 716[2mms[22m[39m
 [32m‚úì[39m tests/unit/lib/queries/QueryRunner.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 670[2mms[22m[39m
 [32m‚úì[39m tests/unit/services/StepService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 629[2mms[22m[39m
 [32m‚úì[39m tests/unit/services/DocumentTemplateService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 639[2mms[22m[39m
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495861021,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495861022,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/repositories/DocumentTemplateRepository.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 717[2mms[22m[39m
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w135

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w135,public

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w135 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w135%2Cpublic

{"level":30,"time":1768495861486,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/unit/services/RecordService.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495861589,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495861590,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/services/RecordService.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 689[2mms[22m[39m
[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üóÇÔ∏è backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üì° add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w136

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w136,public

[90mstdout[2m | tests/ListTools.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w136 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w136%2Cpublic

{"level":30,"time":1768495862200,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/ListTools.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w146

[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/ListTools.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":40,"time":1768495862337,"env":"test","sourceListVar":"nonexistent_list","inputKey":"nonexistent_list","msg":"Input list not found, treating as empty array"}
{"level":30,"time":1768495862339,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495862339,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

 [32m‚úì[39m tests/ListTools.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 775[2mms[22m[39m
[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w146,public

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w146 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w146%2Cpublic

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

{"level":30,"time":1768495862453,"env":"test","msg":"External Send Completed","destination":"My Webhook","success":true,"status":200}
[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495862460,"env":"test","msg":"Simulating External Send","destination":"Test","payload":{}}
 [32m‚úì[39m tests/unit/external/ExternalSendRunner.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 584[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w126

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w126,public

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w126 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w126%2Cpublic

{"level":30,"time":1768495862882,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/integration/datavault.routes.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w149

{"level":30,"time":1768495862972,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495862973,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w147

[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w149,public

[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w149 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w149%2Cpublic

[90mstderr[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): Error: [vitest] No "closeDatabase" export is defined on the "../../../server/db" mock. Did you forget to return it from "vi.mock"?
If you need to partially mock a module, you can use "importOriginal" helper inside:

    at VitestMocker.createError [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:311:17[90m)[39m
    at Object.get [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:384:16[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:144:34
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m {
  codeFrame: [32m'vi.mock(import("../../../server/db"), async (importOriginal) => {\n'[39m +
    [32m'  const actual = await importOriginal()\n'[39m +
    [32m'  return {\n'[39m +
    [32m'    ...actual,\n'[39m +
    [32m'    // your mocked methods\n'[39m +
    [32m'  }\n'[39m +
    [32m'})'[39m
}

{"level":30,"time":1768495863121,"env":"test","module":"write-runner","operation":"write_start","mode":"create","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"create","columnMappings":[{"columnId":"col-first","value":"{{ firstName }}"},{"columnId":"col-last","value":"Doe"},{"columnId":"col-age","value":"{{ age }}"}]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w147,public

{"level":30,"time":1768495863128,"env":"test","module":"write-runner","operation":"write_start","mode":"create","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"create","columnMappings":[]},"tableId":"table-users","preview":true,"msg":"Starting write execution"}
{"level":30,"time":1768495863129,"env":"test","module":"write-runner","operation":"write_preview_simulated","values":{},"msg":"Simulating write in preview mode"}
{"level":30,"time":1768495863130,"env":"test","module":"write-runner","operation":"write_start","mode":"update","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"test@example.com","columnMappings":[{"columnId":"col-status","value":"Active"}]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
{"level":30,"time":1768495863132,"env":"test","module":"write-runner","operation":"write_start","mode":"update","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"missing@example.com","columnMappings":[]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
{"level":50,"time":1768495863132,"env":"test","module":"write-runner","error":{},"config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"missing@example.com","columnMappings":[]},"msg":"Write execution failed"}
 [32m‚úì[39m tests/integration/datavault.routes.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 715[2mms[22m[39m
 [32m‚úì[39m tests/unit/writes/WriteRunner.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 663[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w147 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w147%2Cpublic

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w141

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

 [32m‚úì[39m tests/unit/services/Guardrail.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 639[2mms[22m[39m
[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w145

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w142

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w138

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w141,public

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w145,public

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w141 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w141%2Cpublic

{"level":30,"time":1768495863338,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w142,public

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w138,public

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w145 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w145%2Cpublic

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstderr[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w148

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w142 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w142%2Cpublic

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495863407,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495863408,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w138 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w138%2Cpublic

{"level":30,"time":1768495863416,"env":"test","msg":"DB: initializing... Local"}
 [32m‚úì[39m tests/unit/services/EmailTemplateMetadataService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 568[2mms[22m[39m
[90mstderr[2m | tests/integration/branding.routes.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w148,public

 [32m‚úì[39m tests/integration/datavault.api-tokens.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 622[2mms[22m[39m
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495863525,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768495863525,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w148 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w148%2Cpublic

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/services/AccountLockoutService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 560[2mms[22m[39m
[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w144

 [32m‚úì[39m tests/integration/branding.routes.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 684[2mms[22m[39m
[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w143

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w144,public

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }

 [32m‚úì[39m tests/unit/services/PortalAuthService.test.ts [2m([22m[2m42 tests[22m[2m)[22m[33m 789[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w144 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w144%2Cpublic

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üîê encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w143,public

{"level":40,"time":1768495863781,"env":"test","hookId":"hook-1","hookName":"Hook 1","error":"Test error","msg":"LifecycleHookService: Hook execution failed"}
[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":50,"time":1768495863786,"env":"test","error":{},"workflowId":"workflow-1","runId":"run-1","phase":"beforePage","msg":"LifecycleHookService: Failed to execute hooks for phase"}
{"level":30,"time":1768495863789,"env":"test","hookId":"hook-1","workflowId":"workflow-1","phase":"beforePage","msg":"LifecycleHookService: Created lifecycle hook"}
{"level":30,"time":1768495863796,"env":"test","hookId":"hook-1","workflowId":"workflow-1","msg":"LifecycleHookService: Updated lifecycle hook"}
{"level":30,"time":1768495863799,"env":"test","hookId":"hook-1","workflowId":"workflow-1","msg":"LifecycleHookService: Deleted lifecycle hook"}
[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w143 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w143%2Cpublic

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/LifecycleHookService.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 586[2mms[22m[39m
 [32m‚úì[39m tests/unit/services/BrandingService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 574[2mms[22m[39m
[90mstdout[2m | tests/unit/collab.server.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w139

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w151

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w150

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w137

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w139,public

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w151,public

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w139 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w139%2Cpublic

{"level":30,"time":1768495864686,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w151 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w151%2Cpublic

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w150,public

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w137,public

 [32m‚úì[39m tests/unit/services/AuditLogService.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 550[2mms[22m[39m
[90mstderr[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:148:9

[90mstderr[2m | tests/unit/debugging/Lineage.test.ts[2m > [22m[2mDebug & Lineage[2m > [22m[2mshould generate execution trace with lineage
[22m[39m[DEBUG Question] Node q1 executed. Key: userName, Value: Alice. Context keys: 3

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w150 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w150%2Cpublic

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w137 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w137%2Cpublic

{"level":30,"time":1768495864777,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495864777,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768495864778,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/services/DatavaultReferenceColumns.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 573[2mms[22m[39m
[90mstderr[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495864862,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495864863,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/unit/debugging/Lineage.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 640[2mms[22m[39m
[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w152

 [32m‚úì[39m tests/integration/datavault.row-notes.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 625[2mms[22m[39m
[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w152,public

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w152 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w152%2Cpublic

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w153

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w154

 [32m‚úì[39m tests/unit/engine/FinalBlockSnapshot.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 537[2mms[22m[39m
[90mstdout[2m | tests/unit/collab.server.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w153,public

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w154,public

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w153 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w153%2Cpublic

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w154 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w154%2Cpublic

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39m‚ö†Ô∏è DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39müßπ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39müßπ Cleaning up test environment...

 [32m‚úì[39m tests/unit/repositories/DatavaultRowsRepository.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 596[2mms[22m[39m
 [32m‚úì[39m tests/unit/services/DatavaultRowsService.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 538[2mms[22m[39m
 [2m[90m‚Üì[39m[22m tests/unit/collab.server.test.ts [2m([22m[2m14 tests[22m[2m | [22m[33m14 skipped[39m[2m)[22m
{"level":30,"time":1768495866039,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m‚úÖ OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w140

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): -c search_path=test_schema_w140,public

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39müîí Test Schema Isolated: test_schema_w140 (Reused: false)
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&options=-c+search_path%3Dtest_schema_w140%2Cpublic

{"level":30,"time":1768495867727,"env":"test","msg":"DB: initializing... Local"}
[90mstderr[2m | tests/integration/api.ai.doc.test.ts
[22m[39m‚ö†Ô∏è Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading 'notNull')
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:50
    at Array.reduce (<anonymous>)
    at one [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:196:22[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/shared/schema/relations.ts:659:13
    at Relations.config [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:183:22[90m)[39m
    at extractTablesRelationalConfig [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/relations.js:154:32[90m)[39m
    at construct [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:39:26[90m)[39m
    at drizzle [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/driver.js:74:10[90m)[39m
    at initializeDatabase (C:/Users/scoot/poll/VaultLogic/server/db.ts:60:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768495867766,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768495867785,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts[2m > [22m[2mAI Document Assistant API Integration Tests
[22m[39müìö API Documentation available at /api-docs
[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768495867774,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768495867775,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768495867780,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768495867784,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768495867784,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768495867785,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768495867785,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":40,"time":1768495867806,"env":"test","error":{},"msg":"Deterministic DOCX extraction failed"}
{"level":30,"time":1768495867838,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39müßπ Cleaning up test environment...

{"level":30,"time":1768495867839,"env":"test","msg":"DB: pool closed."}
 [32m‚úì[39m tests/integration/api.ai.doc.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 653[2mms[22m[39m

[31m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[39m[1m[41m Failed Suites 39 [49m[22m[31m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[39m

[41m[1m FAIL [22m[49m tests/integration/analytics_preservation.test.ts[2m > [22mAnalytics Preservation
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'notNull')[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/relations.js:[2m196:50[22m[39m
[90m [2m‚ùØ[22m one node_modules/drizzle-orm/relations.js:[2m196:22[22m[39m
[36m [2m‚ùØ[22m shared/schema/relations.ts:[2m659:13[22m[39m
    [90m657| [39m        references[33m:[39m [projects[33m.[39mid][33m,[39m
    [90m658| [39m    })[33m,[39m
    [90m659| [39m    secret[33m:[39m [34mone[39m(secrets[33m,[39m {
    [90m   | [39m            [31m^[39m
    [90m660| [39m        fields[33m:[39m [externalConnections[33m.[39msecretId][33m,[39m
    [90m661| [39m        references[33m:[39m [secrets[33m.[39mid][33m,[39m
[90m [2m‚ùØ[22m Relations.config node_modules/drizzle-orm/relations.js:[2m183:22[22m[39m
[90m [2m‚ùØ[22m extractTablesRelationalConfig node_modules/drizzle-orm/relations.js:[2m154:32[22m[39m
[90m [2m‚ùØ[22m construct node_modules/drizzle-orm/node-postgres/driver.js:[2m39:26[22m[39m
[90m [2m‚ùØ[22m drizzle node_modules/drizzle-orm/node-postgres/driver.js:[2m74:10[22m[39m
[90m [2m‚ùØ[22m initializeDatabase server/db.ts:[2m60:11[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[1/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/analytics_service.test.ts[2m > [22mAnalytics Service Integration
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/analytics_service.test.ts:[2m35:35[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[2/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.ai.personalization.test.ts[2m > [22mPersonalization API Integration Tests
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/api.ai.personalization.test.ts:[2m63:18[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[3/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.dataSources.native.test.ts[2m [ tests/integration/api.dataSources.native.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/api.expression-validation.test.ts[2m [ tests/integration/api.expression-validation.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/api.projects.test.ts[2m [ tests/integration/api.projects.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/api.runs.docx.test.ts[2m [ tests/integration/api.runs.docx.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/api.runs.graph.test.ts[2m [ tests/integration/api.runs.graph.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/api.snapshots.test.ts[2m [ tests/integration/api.snapshots.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/api.templates-runs.test.ts[2m [ tests/integration/api.templates-runs.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/api.workflows.test.ts[2m [ tests/integration/api.workflows.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/datavault-v4-regression.test.ts[2m [ tests/integration/datavault-v4-regression.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/datavault.permissions.test.ts[2m [ tests/integration/datavault.permissions.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/intake.workflow.test.ts[2m [ tests/integration/intake.workflow.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/js_helpers.test.ts[2m [ tests/integration/js_helpers.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/lifecycle-hooks-execution.test.ts[2m [ tests/integration/lifecycle-hooks-execution.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/auth/auth.middleware.integration.test.ts[2m [ tests/integration/auth/auth.middleware.integration.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/auth/jwt.authentication.test.ts[2m [ tests/integration/auth/jwt.authentication.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/auth/protected.routes.test.ts[2m [ tests/integration/auth/protected.routes.test.ts ][22m
[41m[1m FAIL [22m[49m tests/integration/auth/session.management.integration.test.ts[2m [ tests/integration/auth/session.management.integration.test.ts ][22m
[31m[1mTypeError[22m: () => ({
      getGenerativeModel: __vite_ssr_import_0__.vi.fn().mockReturnValue({
        generateContent: __v...<omitted>...}) is not a constructor[39m
[36m [2m‚ùØ[22m new DocumentAIAssistService server/lib/ai/DocumentAIAssistService.ts:[2m43:26[22m[39m
    [90m 41| [39m        [35mconst[39m apiKey [33m=[39m process[33m.[39menv[33m.[39m[33mGEMINI_API_KEY[39m[33m;[39m
    [90m 42| [39m        [35mif[39m (apiKey) {
    [90m 43| [39m            [35mthis[39m[33m.[39mgenAI [33m=[39m [35mnew[39m [33mGoogleGenerativeAI[39m(apiKey)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m 44| [39m            const model = process.env.GEMINI_MODEL || "gemini-2.0-flas‚Ä¶
    [90m 45| [39m            [35mthis[39m[33m.[39mmodel [33m=[39m [35mthis[39m[33m.[39mgenAI[33m.[39m[34mgetGenerativeModel[39m({ model })[33m;[39m
[90m [2m‚ùØ[22m server/lib/ai/DocumentAIAssistService.ts:[2m258:40[22m[39m
[90m [2m‚ùØ[22m server/routes/ai.doc.routes.ts:[2m5:1[22m[39m
[90m [2m‚ùØ[22m server/routes/index.ts:[2m9:1[22m[39m
[90m [2m‚ùØ[22m server/routes.ts:[2m11:1[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[4/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/collections.e2e.test.ts:[2m28:31[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[5/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/dataBlocks.test.ts[2m > [22mData Block Integration Tests
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/dataBlocks.test.ts:[2m43:35[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[6/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault.autonumber.test.ts[2m > [22mDataVault Autonumber Integration Tests
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/datavault.autonumber.test.ts:[2m22:30[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[7/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/dynamic_options_workflow.test.ts[2m > [22mDynamic Options Integration Flow
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/dynamic_options_workflow.test.ts:[2m24:35[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[8/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/externalSends.test.ts[2m > [22mExternal Send Block Integration
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/externalSends.test.ts:[2m35:35[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[9/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-audit-fixes.test.ts[2m > [22mOrganization Audit Fixes
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/organizations-audit-fixes.test.ts:[2m36:14[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[10/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-workflow.test.ts[2m > [22mOrganization Workflow Integration Tests
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/organizations-workflow.test.ts:[2m44:14[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[11/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/regression-REG-1.test.ts[2m > [22mREG-1: Workflow Logic Regression
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/regression-REG-1.test.ts:[2m50:18[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[12/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/workflow_versioning.test.ts[2m > [22mWorkflow Versioning & Lineage
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/workflow_versioning.test.ts:[2m20:35[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[13/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/api.ai.logic.test.ts[2m [ tests/unit/api.ai.logic.test.ts ][22m
[41m[1m FAIL [22m[49m tests/unit/api.ai.revise.test.ts[2m [ tests/unit/api.ai.revise.test.ts ][22m
[41m[1m FAIL [22m[49m tests/unit/debug_import.test.ts[2m [ tests/unit/debug_import.test.ts ][22m
[31m[1mTypeError[22m: () => ({
      getGenerativeModel: __vite_ssr_import_0__.vi.fn().mockReturnValue({
        generateContent: __v...<omitted>...}) is not a constructor[39m
[36m [2m‚ùØ[22m new GeminiService server/services/geminiService.ts:[2m27:18[22m[39m
    [90m 25| [39m    }
    [90m 26| [39m
    [90m 27| [39m    [35mthis[39m[33m.[39mgenAI [33m=[39m [35mnew[39m [33mGoogleGenerativeAI[39m(apiKey)[33m;[39m
    [90m   | [39m                 [31m^[39m
    [90m 28| [39m    // Use configurable Gemini model from env, fallback to gemini-2.0-‚Ä¶
    [90m 29| [39m    [35mconst[39m model [33m=[39m process[33m.[39menv[33m.[39m[33mGEMINI_MODEL[39m [33m||[39m [32m"gemini-2.0-flash"[39m[33m;[39m
[90m [2m‚ùØ[22m server/services/geminiService.ts:[2m299:30[22m[39m
[90m [2m‚ùØ[22m server/controllers/AiController.ts:[2m16:1[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[14/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/ai/workflowEdit.test.ts:[2m106:31[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[15/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/auth/oauth2.callback.test.ts:[2m56:31[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[16/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/auth/oauth2.google.test.ts:[2m36:31[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[17/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/auth/oauth2.sessions.test.ts:[2m42:31[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[18/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m44:31[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[19/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/workflows/runtime-pipelines.test.ts[2m > [22mRuntime Pipelines Integration Tests
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/workflows/runtime-pipelines.test.ts:[2m67:8[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[20/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/workflows/runtime-pipelines.test.ts[2m > [22mRuntime Pipelines Integration Tests
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/workflows/runtime-pipelines.test.ts:[2m228:14[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[21/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'notNull')[39m
[90m [2m‚ùØ[22m node_modules/drizzle-orm/relations.js:[2m196:50[22m[39m
[90m [2m‚ùØ[22m one node_modules/drizzle-orm/relations.js:[2m196:22[22m[39m
[36m [2m‚ùØ[22m shared/schema/relations.ts:[2m659:13[22m[39m
    [90m657| [39m        references[33m:[39m [projects[33m.[39mid][33m,[39m
    [90m658| [39m    })[33m,[39m
    [90m659| [39m    secret[33m:[39m [34mone[39m(secrets[33m,[39m {
    [90m   | [39m            [31m^[39m
    [90m660| [39m        fields[33m:[39m [externalConnections[33m.[39msecretId][33m,[39m
    [90m661| [39m        references[33m:[39m [secrets[33m.[39mid][33m,[39m
[90m [2m‚ùØ[22m Relations.config node_modules/drizzle-orm/relations.js:[2m183:22[22m[39m
[90m [2m‚ùØ[22m extractTablesRelationalConfig node_modules/drizzle-orm/relations.js:[2m154:32[22m[39m
[90m [2m‚ùØ[22m construct node_modules/drizzle-orm/node-postgres/driver.js:[2m39:26[22m[39m
[90m [2m‚ùØ[22m drizzle node_modules/drizzle-orm/node-postgres/driver.js:[2m74:10[22m[39m
[90m [2m‚ùØ[22m Module.initializeDatabase server/db.ts:[2m60:11[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[22/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'stop')[39m
[36m [2m‚ùØ[22m tests/unit/services/PdfQueueService.test.ts:[2m163:13[22m[39m
    [90m161| [39m  [34mafterAll[39m(() [33m=>[39m {
    [90m162| [39m    [90m// Ensure service is stopped[39m
    [90m163| [39m    service[33m.[39m[34mstop[39m()[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m164| [39m  })[33m;[39m
    [90m165| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[23/308]‚éØ[22m[39m


[31m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[39m[1m[41m Failed Tests 210 [49m[22m[31m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mComplete Registration ‚Üí Login Flow[2m > [22mshould complete registration, verify email, then login
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m73:39[22m[39m
    [90m 71| [39m        })[33m;[39m
    [90m 72| [39m
    [90m 73| [39m      [34mexpect[39m(registerResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                                      [31m^[39m
    [90m 74| [39m      [34mexpect[39m(registerResponse[33m.[39mbody[33m.[39muser[33m.[39memailVerified)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
    [90m 75| [39m      [34mtrackUser[39m(registerResponse[33m.[39mbody[33m.[39muser[33m.[39mid)[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[24/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mAccount Lockout Flow[2m > [22mshould lock account after 5 failed attempts, then unlock after waiting
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m105:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[25/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mAccount Lockout Flow[2m > [22mshould record all login attempts
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m161:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[26/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mMFA Enrollment and Login Flow[2m > [22mshould complete MFA setup and login with TOTP
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m182:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[27/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mMFA Enrollment and Login Flow[2m > [22mshould login with backup code when TOTP unavailable
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m253:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[28/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mPassword Reset Flow[2m > [22mshould complete full password reset flow
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m324:56[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[29/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mPassword Reset Flow[2m > [22mshould invalidate all sessions after password reset
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m383:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[30/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mToken Refresh Flow[2m > [22mshould rotate refresh token on each use
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m430:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[31/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mToken Refresh Flow[2m > [22mshould detect and prevent refresh token reuse (token theft)
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m464:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[32/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mSession Management Flow[2m > [22mshould list all active sessions
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m507:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[33/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mSession Management Flow[2m > [22mshould revoke specific session
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.flows.real.test.ts:[2m534:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[34/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/register[2m > [22mshould register a new user successfully
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m78:31[22m[39m
    [90m 76| [39m        })[33m;[39m
    [90m 77| [39m
    [90m 78| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m 79| [39m      expect((response.body).message).toContain("Registration successf‚Ä¶
    [90m 80| [39m      [34mexpect[39m((response[33m.[39mbody)[33m.[39mtoken)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[35/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/register[2m > [22mshould return 409 for duplicate email
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m129:29[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[36/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/register[2m > [22mshould set httpOnly refresh token cookie
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m151:31[22m[39m
    [90m149| [39m        [33m.[39m[34msend[39m({ email[33m,[39m password[33m,[39m firstName[33m:[39m [32m"Test"[39m })[33m;[39m
    [90m150| [39m
    [90m151| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m152| [39m      [34mexpect[39m(response[33m.[39mheaders[[32m'set-cookie'[39m])[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m153| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[37/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould login with valid credentials
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m164:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[38/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould return 401 for invalid password
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m185:33[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[39/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould return 401 for non-existent user
[31m[1mAssertionError[22m: expected 500 to be 401 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 401[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m208:31[22m[39m
    [90m206| [39m        })[33m;[39m
    [90m207| [39m
    [90m208| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m401[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m209| [39m      expect(response.body.message || response.body.error).toBeDefined‚Ä¶
    [90m210| [39m    })[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[40/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould return 403 for unverified email
[31m[1mAssertionError[22m: expected 500 to be 403 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 403[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m226:31[22m[39m
    [90m224| [39m        [33m.[39m[34msend[39m({ email[33m,[39m password })[33m;[39m
    [90m225| [39m
    [90m226| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m403[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m227| [39m      expect(response.body.message || response.body.error).toBeDefined‚Ä¶
    [90m228| [39m    })[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[41/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould record failed login attempt
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m231:33[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[42/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould return requiresMfa=true for MFA-enabled users
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m252:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[43/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould lock account after 5 failed attempts
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m266:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[44/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/logout[2m > [22mshould logout and clear refresh token cookie
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m295:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[45/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould refresh access token with valid refresh token
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m325:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[46/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould rotate refresh token after use
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m364:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[47/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/forgot-password[2m > [22mshould send password reset email for existing user
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m399:33[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[48/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/forgot-password[2m > [22mshould not reveal if email exists (security)
[31m[1mAssertionError[22m: expected 500 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m416:31[22m[39m
    [90m414| [39m
    [90m415| [39m      [90m// Should return 200 even if email doesn't exist[39m
    [90m416| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m417| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoContain[39m([32m"reset link"[39m)[33m;[39m
    [90m418| [39m    })[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[49/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/reset-password[2m > [22mshould reset password with valid token
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m423:56[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[50/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/reset-password[2m > [22mshould return 400 for invalid token
[31m[1mAssertionError[22m: expected 500 to be 400 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 400[39m
[31m+ 500[39m

[36m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m465:31[22m[39m
    [90m463| [39m        })[33m;[39m
    [90m464| [39m
    [90m465| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m400[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m466| [39m    })[33m;[39m
    [90m467| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[51/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/reset-password[2m > [22mshould return 400 for weak new password
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m469:33[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[52/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mGET /api/auth/me[2m > [22mshould return current user for valid token
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m487:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[53/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mMFA Routes[2m > [22mPOST /api/auth/mfa/verify-login[2m > [22mshould complete MFA login with valid TOTP code
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m523:57[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[54/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mMFA Routes[2m > [22mPOST /api/auth/mfa/verify-login[2m > [22mshould reject invalid MFA code
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/auth.routes.real.test.ts:[2m549:28[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[55/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould complete full MFA setup flow
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m59:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[56/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould reject invalid TOTP code during setup
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m125:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[57/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould not allow MFA setup if already enabled
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m157:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[58/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould generate unique backup codes
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m171:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[59/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould store hashed backup codes
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m190:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[60/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Login Flow[2m > [22mshould require MFA for enabled users
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m220:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[61/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Login Flow[2m > [22mshould complete MFA login with valid TOTP
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m234:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[62/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Login Flow[2m > [22mshould reject invalid TOTP during login
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m268:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[63/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Login Flow[2m > [22mshould accept TOTP codes within 60-second window
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m286:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[64/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Flow[2m > [22mshould login with valid backup code
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m318:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[65/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Flow[2m > [22mshould mark backup code as used
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m370:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[66/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Flow[2m > [22mshould prevent backup code reuse
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m390:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[67/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Flow[2m > [22mshould try TOTP before backup code
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m452:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[68/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Status[2m > [22mshould return MFA status for user
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m475:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[69/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Status[2m > [22mshould return backup codes count for MFA users
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m492:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[70/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Disable Flow[2m > [22mshould disable MFA with password verification
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m529:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[71/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Disable Flow[2m > [22mshould require correct password to disable MFA
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m579:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[72/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Regeneration[2m > [22mshould regenerate backup codes
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m613:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[73/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Regeneration[2m > [22mshould return error if MFA not enabled
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m646:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[74/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mTenant-Level MFA Enforcement[2m > [22mshould enforce MFA for tenant users when required by tenant
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/mfa.flow.real.test.ts:[2m665:16[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[75/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould create placeholder user for non-existent email
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould create invite for existing user without creating placeholder
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould prevent duplicate pending invites
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould prevent inviting existing members
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould require admin access to create invite
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould set expiry to 7 days from now
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22macceptInvite[2m > [22mshould accept invite and create membership
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22macceptInvite[2m > [22mshould convert placeholder user to real user on accept
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22macceptInvite[2m > [22mshould reject expired invite
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22macceptInvite[2m > [22mshould reject already accepted invite
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22macceptInvite[2m > [22mshould verify email matches invite
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22macceptInvite[2m > [22mshould reject invalid token
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mgetPendingInvitesForUser[2m > [22mshould return pending invites for user email
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mgetPendingInvitesForUser[2m > [22mshould not return expired invites
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mgetPendingInvitesForUser[2m > [22mshould not return accepted invites
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mrevokeInvite[2m > [22mshould allow admin to revoke invite
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mrevokeInvite[2m > [22mshould prevent accepting revoked invite
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/organizationInvites.test.ts:[2m31:18[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[76/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mcreateOrganization[2m > [22mshould create organization and auto-create admin membership
[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mgetUserOrganizations[2m > [22mshould return all organizations for user
[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mgetUserOrganizations[2m > [22mshould return empty array for user with no memberships
[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mupdateOrganization[2m > [22mshould allow admin to update organization
[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mupdateOrganization[2m > [22mshould deny non-admin from updating organization
[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mgetOrganizationMembers[2m > [22mshould return all members of organization
[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mpromoteMember[2m > [22mshould allow admin to promote member
[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mdemoteMember[2m > [22mshould allow admin to demote other admin
[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mdemoteMember[2m > [22mshould prevent self-demotion
[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mremoveMember[2m > [22mshould allow admin to remove member
[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mremoveMember[2m > [22mshould prevent self-removal
[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mleaveOrganization[2m > [22mshould allow member to leave organization
[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mleaveOrganization[2m > [22mshould allow admin to leave organization
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/organizationService.test.ts:[2m27:35[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[77/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22mcanAccessAsset[2m > [22mshould allow access to org-owned asset by org member
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/ownershipAccess.test.ts:[2m72:16[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[78/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22mcanAccessAsset[2m > [22mshould deny access to org-owned asset by non-member
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m isOrgMember server/utils/ownershipAccess.ts:[2m63:6[22m[39m
[90m [2m‚ùØ[22m canAccessAsset server/utils/ownershipAccess.ts:[2m48:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/ownershipAccess.test.ts:[2m83:31[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[79/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22misOrgMember[2m > [22mshould return true for org member
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/ownershipAccess.test.ts:[2m95:16[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[80/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22misOrgMember[2m > [22mshould return false for non-member
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m isOrgMember server/utils/ownershipAccess.ts:[2m63:6[22m[39m
[90m [2m‚ùØ[22m tests/integration/ownershipAccess.test.ts:[2m106:30[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[81/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22misOrgMember[2m > [22mshould return true for org admin
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/ownershipAccess.test.ts:[2m111:16[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[82/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22mcanManageOrg[2m > [22mshould return true for org admin
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/ownershipAccess.test.ts:[2m124:16[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[83/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22mcanManageOrg[2m > [22mshould return false for org member (non-admin)
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/ownershipAccess.test.ts:[2m135:16[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[84/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22mcanManageOrg[2m > [22mshould return false for non-member
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m canManageOrg server/utils/ownershipAccess.ts:[2m85:6[22m[39m
[90m [2m‚ùØ[22m tests/integration/ownershipAccess.test.ts:[2m146:31[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[85/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22mgetUserOrgIds[2m > [22mshould return all org IDs for a user
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/ownershipAccess.test.ts:[2m153:16[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[86/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22mgetUserOrgIds[2m > [22mshould return empty array for user with no memberships
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m getUserOrgIds server/utils/ownershipAccess.ts:[2m108:6[22m[39m
[90m [2m‚ùØ[22m tests/integration/ownershipAccess.test.ts:[2m165:28[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[87/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22mcanCreateWithOwnership[2m > [22mshould allow creating org-owned asset if user is member
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/ownershipAccess.test.ts:[2m182:16[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[88/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22mcanCreateWithOwnership[2m > [22mshould deny creating org-owned asset if user is not member
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m isOrgMember server/utils/ownershipAccess.ts:[2m63:6[22m[39m
[90m [2m‚ùØ[22m canCreateWithOwnership server/utils/ownershipAccess.ts:[2m160:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/ownershipAccess.test.ts:[2m193:31[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[89/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22mCross-org Access Control[2m > [22mshould not allow member of org1 to access org2-owned assets
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/ownershipAccess.test.ts:[2m200:16[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[90/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22mCross-org Access Control[2m > [22mshould allow member of multiple orgs to access all their org assets
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/ownershipAccess.test.ts:[2m211:16[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[91/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould list all active sessions for current user
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m57:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[92/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould mark current session correctly
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m105:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[93/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould exclude revoked sessions
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m135:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[94/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould order sessions by last used (most recent first)
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m167:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[95/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould filter sessions by current user only
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m198:21[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[96/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould revoke specific session
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m234:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[97/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould prevent revoking current session
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m280:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[98/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould return 404 for non-existent session
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m312:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[99/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould prevent revoking other user's session
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m327:21[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[100/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould revoke all other sessions
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m360:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[101/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould keep current session active
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m394:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[102/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould return 400 if no active session found
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m430:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[103/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould revoke all trusted devices
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m449:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[104/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould handle user with single session gracefully
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m481:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[105/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mSession Security[2m > [22mshould include device metadata in sessions
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m511:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[106/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mSession Security[2m > [22mshould not expose sensitive token data
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m533:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[107/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mSession Security[2m > [22mshould track session activity timestamps
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m tests/integration/session.management.real.test.ts:[2m552:43[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[108/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mProject Transfer[2m > [22mshould transfer user-owned project to org
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mProject Transfer[2m > [22mshould prevent transfer to org if user is not a member
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mProject Transfer[2m > [22mshould allow org member to transfer org-owned project to another org they belong to
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mWorkflow Transfer[2m > [22mshould detach workflow from project when transferring to different owner
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mWorkflow Transfer[2m > [22mshould keep workflow in project when transferring to same owner
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mWorkflow Transfer[2m > [22mshould prevent non-member from transferring org workflow
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mDatabase Transfer[2m > [22mshould transfer database ownership
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mDatabase Transfer[2m > [22mshould allow org member to transfer org database
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mDatabase Transfer[2m > [22mshould prevent transfer to org if user is not a member
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mTransfer Validation[2m > [22mshould only allow transfer to self when targetOwnerType is user
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mTransfer Validation[2m > [22mshould allow transfer from user to self (org member transferring org asset to themselves)
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/transferOwnership.test.ts:[2m42:18[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[109/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mPOST /api/auth/trust-device[2m > [22mshould trust current device
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m58:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[110/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mPOST /api/auth/trust-device[2m > [22mshould set trust expiry to 30 days
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m97:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[111/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mPOST /api/auth/trust-device[2m > [22mshould update expiry if device already trusted
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m124:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[112/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould list all trusted devices
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m183:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[113/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould mark current device
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m240:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[114/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould exclude revoked devices
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m272:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[115/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould exclude expired devices
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m305:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[116/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDELETE /api/auth/trusted-devices/:deviceId[2m > [22mshould revoke specific device
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m341:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[117/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDELETE /api/auth/trusted-devices/:deviceId[2m > [22mshould return 404 for non-existent device
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m391:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[118/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDELETE /api/auth/trusted-devices/:deviceId[2m > [22mshould prevent revoking other user's device
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m410:21[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[119/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDevice Trust with MFA Login[2m > [22mshould skip MFA for trusted device
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m459:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[120/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDevice Trust with MFA Login[2m > [22mshould require MFA for untrusted device
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m497:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[121/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDevice Trust with MFA Login[2m > [22mshould update lastUsedAt on trusted device login
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m createTestUser tests/helpers/testUtils.ts:[2m151:12[22m[39m
[90m [2m‚ùØ[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2m‚ùØ[22m tests/integration/trusted.devices.real.test.ts:[2m528:55[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[122/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mREPRO: ScriptEngine fails to resolve alias 'input_variable' when aliasMap is NOT provided
[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mScriptEngine resolves alias 'input_variable' when aliasMap is provided
[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mREPRO: BlockRunner fails to resolve alias in CreateRecordConfig
[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mBlockRunner logic resolves alias with aliasMap
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/integration/variableSafety.test.ts:[2m44:18[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[123/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mTemplate Key Resolution (New Path)[2m > [22mshould resolve template by key from workflowTemplates mapping
[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mTemplate Key Resolution (New Path)[2m > [22mshould throw error if template key not found
[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mTemplate Key Resolution (New Path)[2m > [22mshould store output in runOutputs table
[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mLegacy Template ID Path (Backward Compatibility)[2m > [22mshould resolve template by templateId directly
[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mLegacy Template ID Path (Backward Compatibility)[2m > [22mshould throw error if templateId not found
[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mRendering Engine Selection[2m > [22mshould use docxRenderer2 by default (v2 engine)
[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mRendering Engine Selection[2m > [22mshould use legacy engine when engine="legacy"
[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mPDF Generation[2m > [22mshould generate PDF when toPdf=true
[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mPDF Generation[2m > [22mshould default to DOCX when toPdf=false
[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mConditional Execution[2m > [22mshould skip execution when condition evaluates to false
[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mConditional Execution[2m > [22mshould execute when condition evaluates to true
[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mBinding Resolution[2m > [22mshould resolve simple bindings
[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mBinding Resolution[2m > [22mshould handle binding resolution errors gracefully
[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mError Handling[2m > [22mshould record failed output in runOutputs table
[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mError Handling[2m > [22mshould not throw errors (should return error in result)
[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mTenant Access Control[2m > [22mshould deny access to templates from different tenant
[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mValidation[2m > [22mshould require either templateKey or templateId
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m getDb server/db.ts:[2m92:11[22m[39m
    [90m 90| [39m[35mfunction[39m [34mgetDb[39m() {
    [90m 91| [39m  [35mif[39m ([33m![39mdbInitialized) {
    [90m 92| [39m    throw new Error("Database not initialized. Call await initializeDa‚Ä¶
    [90m   | [39m          [31m^[39m
    [90m 93| [39m  }
    [90m 94| [39m  [35mreturn[39m _db[33m;[39m
[90m [2m‚ùØ[22m new TestFactory tests/helpers/testFactory.ts:[2m79:25[22m[39m
[90m [2m‚ùØ[22m Module.createTestFactory tests/helpers/testFactory.ts:[2m459:10[22m[39m
[90m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m78:15[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[124/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mTemplate Key Resolution (New Path)[2m > [22mshould resolve template by key from workflowTemplates mapping
[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mTemplate Key Resolution (New Path)[2m > [22mshould throw error if template key not found
[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mTemplate Key Resolution (New Path)[2m > [22mshould store output in runOutputs table
[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mLegacy Template ID Path (Backward Compatibility)[2m > [22mshould resolve template by templateId directly
[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mLegacy Template ID Path (Backward Compatibility)[2m > [22mshould throw error if templateId not found
[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mRendering Engine Selection[2m > [22mshould use docxRenderer2 by default (v2 engine)
[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mRendering Engine Selection[2m > [22mshould use legacy engine when engine="legacy"
[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mPDF Generation[2m > [22mshould generate PDF when toPdf=true
[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mPDF Generation[2m > [22mshould default to DOCX when toPdf=false
[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mConditional Execution[2m > [22mshould skip execution when condition evaluates to false
[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mConditional Execution[2m > [22mshould execute when condition evaluates to true
[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mBinding Resolution[2m > [22mshould resolve simple bindings
[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mBinding Resolution[2m > [22mshould handle binding resolution errors gracefully
[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mError Handling[2m > [22mshould record failed output in runOutputs table
[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mError Handling[2m > [22mshould not throw errors (should return error in result)
[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mTenant Access Control[2m > [22mshould deny access to templates from different tenant
[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mValidation[2m > [22mshould require either templateKey or templateId
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2m‚ùØ[22m tests/unit/engine/templateNode.test.ts:[2m125:19[22m[39m
    [90m123| [39m  [34mafterEach[39m([35masync[39m () [33m=>[39m {
    [90m124| [39m    [90m// Cleanup using factory (respects foreign key order)[39m
    [90m125| [39m    [35mawait[39m factory[33m.[39m[34mcleanup[39m({ tenantIds[33m:[39m [testTenantId] })[33m;[39m
    [90m   | [39m                  [31m^[39m
    [90m126| [39m  })[33m;[39m
    [90m127| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[125/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mcreate[2m > [22mshould create a workflow template mapping
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mcreate[2m > [22mshould create non-primary mapping by default
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionId[2m > [22mshould find all templates for a workflow version
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionId[2m > [22mshould return empty array for version with no templates
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionId[2m > [22mshould order by createdAt desc (newest first)
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionAndKey[2m > [22mshould find mapping by workflow version and key
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionAndKey[2m > [22mshould return undefined for non-existent key
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindPrimaryByWorkflowVersionId[2m > [22mshould find primary template for workflow version
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindPrimaryByWorkflowVersionId[2m > [22mshould return undefined when no primary template exists
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22msetPrimary[2m > [22mshould set a template as primary and unset others
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22msetPrimary[2m > [22mshould handle setting primary when none existed before
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22msetPrimary[2m > [22mshould not delete mapping if workflow version does not match
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mexistsByKey[2m > [22mshould return true if key exists in workflow version
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mexistsByKey[2m > [22mshould return false if key does not exist
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mexistsByKey[2m > [22mshould exclude specified id when checking existence
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mexistsByKey[2m > [22mshould return true if key exists on different mapping
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mupdate[2m > [22mshould update mapping fields
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindById[2m > [22mshould find mapping by id
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindById[2m > [22mshould return undefined for non-existent id
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m29:8[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[126/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mcreate[2m > [22mshould create a workflow template mapping
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mcreate[2m > [22mshould create non-primary mapping by default
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionId[2m > [22mshould find all templates for a workflow version
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionId[2m > [22mshould return empty array for version with no templates
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionId[2m > [22mshould order by createdAt desc (newest first)
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionAndKey[2m > [22mshould find mapping by workflow version and key
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionAndKey[2m > [22mshould return undefined for non-existent key
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindPrimaryByWorkflowVersionId[2m > [22mshould find primary template for workflow version
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindPrimaryByWorkflowVersionId[2m > [22mshould return undefined when no primary template exists
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22msetPrimary[2m > [22mshould set a template as primary and unset others
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22msetPrimary[2m > [22mshould handle setting primary when none existed before
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22msetPrimary[2m > [22mshould not delete mapping if workflow version does not match
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mexistsByKey[2m > [22mshould return true if key exists in workflow version
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mexistsByKey[2m > [22mshould return false if key does not exist
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mexistsByKey[2m > [22mshould exclude specified id when checking existence
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mexistsByKey[2m > [22mshould return true if key exists on different mapping
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mupdate[2m > [22mshould update mapping fields
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindById[2m > [22mshould find mapping by id
[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindById[2m > [22mshould return undefined for non-existent id
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m106:14[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[127/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/schema/collections.test.ts[2m > [22mCollections Schema[2m > [22mCollectionField Table[2m > [22mshould have required columns
[31m[1mAssertionError[22m: expected [ 'id', 'collectionId', 'name', ‚Ä¶(8) ] to include 'isRequired'[39m
[36m [2m‚ùØ[22m tests/unit/schema/collections.test.ts:[2m54:23[22m[39m
    [90m 52| [39m      [34mexpect[39m(columns)[33m.[39m[34mtoContain[39m([32m'slug'[39m)[33m;[39m
    [90m 53| [39m      [34mexpect[39m(columns)[33m.[39m[34mtoContain[39m([32m'type'[39m)[33m;[39m
    [90m 54| [39m      [34mexpect[39m(columns)[33m.[39m[34mtoContain[39m([32m'isRequired'[39m)[33m;[39m
    [90m   | [39m                      [31m^[39m
    [90m 55| [39m      [34mexpect[39m(columns)[33m.[39m[34mtoContain[39m([32m'options'[39m)[33m;[39m
    [90m 56| [39m      [34mexpect[39m(columns)[33m.[39m[34mtoContain[39m([32m'defaultValue'[39m)[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[128/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/schema/collections.test.ts[2m > [22mCollections Schema[2m > [22mCollection Field Type Enum[2m > [22mshould have all expected field types
[31m[1mAssertionError[22m: expected undefined to be defined[39m
[36m [2m‚ùØ[22m tests/unit/schema/collections.test.ts:[2m84:39[22m[39m
    [90m 82| [39m  [34mdescribe[39m([32m'Collection Field Type Enum'[39m[33m,[39m () [33m=>[39m {
    [90m 83| [39m    [34mit[39m([32m'should have all expected field types'[39m[33m,[39m () [33m=>[39m {
    [90m 84| [39m      [34mexpect[39m(collectionFieldTypeEnum)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m   | [39m                                      [31m^[39m
    [90m 85| [39m
    [90m 86| [39m      [35mconst[39m expectedTypes [33m=[39m [

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[129/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/schema/collections.test.ts[2m > [22mCollections Schema[2m > [22mInsert Schemas[2m > [22minsertCollectionFieldSchema[2m > [22mshould validate valid field data
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- true[39m
[31m+ false[39m

[36m [2m‚ùØ[22m tests/unit/schema/collections.test.ts:[2m169:32[22m[39m
    [90m167| [39m
    [90m168| [39m        const result = insertCollectionFieldSchema.safeParse(validData‚Ä¶
    [90m169| [39m        [34mexpect[39m(result[33m.[39msuccess)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m   | [39m                               [31m^[39m
    [90m170| [39m      })[33m;[39m
    [90m171| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[130/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/schema/collections.test.ts[2m > [22mCollections Schema[2m > [22mInsert Schemas[2m > [22minsertCollectionFieldSchema[2m > [22mshould validate field type enum
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- true[39m
[31m+ false[39m

[36m [2m‚ùØ[22m tests/unit/schema/collections.test.ts:[2m204:34[22m[39m
    [90m202| [39m
    [90m203| [39m          [35mconst[39m result [33m=[39m insertCollectionFieldSchema[33m.[39m[34msafeParse[39m(data)[33m;[39m
    [90m204| [39m          [34mexpect[39m(result[33m.[39msuccess)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m   | [39m                                 [31m^[39m
    [90m205| [39m        })[33m;[39m
    [90m206| [39m      })[33m;[39m
[90m [2m‚ùØ[22m tests/unit/schema/collections.test.ts:[2m194:20[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[131/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/schema/collections.test.ts[2m > [22mCollections Schema[2m > [22mInsert Schemas[2m > [22minsertCollectionFieldSchema[2m > [22mshould allow options for select types
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- true[39m
[31m+ false[39m

[36m [2m‚ùØ[22m tests/unit/schema/collections.test.ts:[2m232:32[22m[39m
    [90m230| [39m
    [90m231| [39m        const result = insertCollectionFieldSchema.safeParse(validData‚Ä¶
    [90m232| [39m        [34mexpect[39m(result[33m.[39msuccess)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m   | [39m                               [31m^[39m
    [90m233| [39m      })[33m;[39m
    [90m234| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[132/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/schema/collections.test.ts[2m > [22mCollections Schema[2m > [22mInsert Schemas[2m > [22minsertCollectionFieldSchema[2m > [22mshould allow defaultValue
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- true[39m
[31m+ false[39m

[36m [2m‚ùØ[22m tests/unit/schema/collections.test.ts:[2m246:32[22m[39m
    [90m244| [39m
    [90m245| [39m        const result = insertCollectionFieldSchema.safeParse(validData‚Ä¶
    [90m246| [39m        [34mexpect[39m(result[33m.[39msuccess)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m   | [39m                               [31m^[39m
    [90m247| [39m      })[33m;[39m
    [90m248| [39m    })[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[133/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/schema/collections.test.ts[2m > [22mCollections Schema[2m > [22mJSONB Data Handling[2m > [22mshould support JSONB for field options
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- true[39m
[31m+ false[39m

[36m [2m‚ùØ[22m tests/unit/schema/collections.test.ts:[2m374:30[22m[39m
    [90m372| [39m
    [90m373| [39m      const result = insertCollectionFieldSchema.safeParse(fieldWithOp‚Ä¶
    [90m374| [39m      [34mexpect[39m(result[33m.[39msuccess)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m   | [39m                             [31m^[39m
    [90m375| [39m    })[33m;[39m
    [90m376| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[134/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/schema/collections.test.ts[2m > [22mCollections Schema[2m > [22mJSONB Data Handling[2m > [22mshould support JSONB for field default values
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- true[39m
[31m+ false[39m

[36m [2m‚ùØ[22m tests/unit/schema/collections.test.ts:[2m389:30[22m[39m
    [90m387| [39m
    [90m388| [39m      const result = insertCollectionFieldSchema.safeParse(fieldWithDe‚Ä¶
    [90m389| [39m      [34mexpect[39m(result[33m.[39msuccess)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m   | [39m                             [31m^[39m
    [90m390| [39m    })[33m;[39m
    [90m391| [39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[135/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/DatavaultColumnsService.test.ts[2m > [22mDatavaultColumnsService[2m > [22mdeleteColumn[2m > [22mshould delete column
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m Object.get server/db.ts:[2m113:13[22m[39m
    [90m111| [39m  [35mget[39m(target[33m,[39m prop) {
    [90m112| [39m    [35mif[39m ([33m![39m_db) {
    [90m113| [39m      throw new Error("Database not initialized. Call await initialize‚Ä¶
    [90m   | [39m            [31m^[39m
    [90m114| [39m    }
    [90m115| [39m    [35mreturn[39m _db[prop [35mas[39m keyof [33mDrizzleDB[39m][33m;[39m
[90m [2m‚ùØ[22m DatavaultColumnsService.checkColumnUsage server/services/DatavaultColumnsService.ts:[2m560:8[22m[39m
[90m [2m‚ùØ[22m DatavaultColumnsService.deleteColumn server/services/DatavaultColumnsService.ts:[2m487:16[22m[39m
[90m [2m‚ùØ[22m tests/unit/services/DatavaultColumnsService.test.ts:[2m315:7[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[136/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowPatchService.test.ts[2m > [22mWorkflowPatchService[2m > [22mDataVault Additive Enforcement[2m > [22mshould allow safe DataVault operations (createTable, addColumns)
[31m[1mError[22m: Workflow not found[39m
[36m [2m‚ùØ[22m WorkflowPatchService.getTenantContext server/services/WorkflowPatchService.ts:[2m70:13[22m[39m
    [90m 68| [39m    [35mconst[39m workflow [33m=[39m [35mawait[39m workflowRepository[33m.[39m[34mfindById[39m(workflowId)[33m;[39m
    [90m 69| [39m    [35mif[39m ([33m![39mworkflow) {
    [90m 70| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Workflow not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m 71| [39m    }
    [90m 72| [39m
[90m [2m‚ùØ[22m WorkflowPatchService.applyOp server/services/WorkflowPatchService.ts:[2m514:30[22m[39m
[90m [2m‚ùØ[22m WorkflowPatchService.applyOps server/services/WorkflowPatchService.ts:[2m134:24[22m[39m
[90m [2m‚ùØ[22m tests/unit/services/WorkflowPatchService.test.ts:[2m482:22[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[137/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowPatchService.test.ts[2m > [22mWorkflowPatchService[2m > [22mOperation Application[2m > [22mshould clear tempId mappings between batch calls
[31m[1mError[22m: Invalid section ID: temp-section-1[39m
[36m [2m‚ùØ[22m Object.<anonymous> tests/unit/services/WorkflowPatchService.test.ts:[2m589:17[22m[39m
    [90m587| [39m      mockStepRepoCreate[33m.[39m[34mmockImplementation[39m([35masync[39m (data[33m:[39m any) [33m=>[39m {
    [90m588| [39m        [35mif[39m (data[33m.[39msectionId[33m?.[39m[34mstartsWith[39m([32m'temp-'[39m)) {
    [90m589| [39m          [35mthrow[39m [35mnew[39m [33mError[39m([32m`Invalid section ID: [39m[36m${[39mdata[33m.[39msectionId[36m}[39m[32m`[39m)[33m;[39m
    [90m   | [39m                [31m^[39m
    [90m590| [39m        }
    [90m591| [39m        [35mreturn[39m { id[33m:[39m [32m'step-1'[39m }[33m;[39m
[90m [2m‚ùØ[22m WorkflowPatchService.applyOp server/services/WorkflowPatchService.ts:[2m255:48[22m[39m
[90m [2m‚ùØ[22m WorkflowPatchService.applyOps server/services/WorkflowPatchService.ts:[2m134:24[22m[39m
[90m [2m‚ùØ[22m tests/unit/services/WorkflowPatchService.test.ts:[2m609:23[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[138/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowPatchService.test.ts[2m > [22mWorkflowPatchService[2m > [22mDocument Operations[2m > [22mshould reject binding to non-existent step alias
[31m[1mError[22m: Step alias 'nonExistentAlias' not found in workflow. Please create the step first.[39m
[36m [2m‚ùØ[22m WorkflowPatchService.applyOp server/services/WorkflowPatchService.ts:[2m487:19[22m[39m
    [90m485| [39m        [35mfor[39m ([35mconst[39m stepAlias [35mof[39m [33mObject[39m[33m.[39m[34mvalues[39m(op[33m.[39mbindings)) {
    [90m486| [39m          [35mif[39m ([33m![39mvalidAliases[33m.[39m[34mhas[39m(stepAlias)) {
    [90m487| [39m            [35mthrow[39m [35mnew[39m [33mError[39m(
    [90m   | [39m                  [31m^[39m
    [90m488| [39m              `Step alias '${stepAlias}' not found in workflow. Please‚Ä¶
    [90m489| [39m            )[33m;[39m
[90m [2m‚ùØ[22m WorkflowPatchService.applyOps server/services/WorkflowPatchService.ts:[2m134:24[22m[39m
[90m [2m‚ùØ[22m tests/unit/services/WorkflowPatchService.test.ts:[2m862:22[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[139/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mshould throw error if template belongs to different project
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mshould automatically unset other primaries when setting new primary
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mlistTemplates[2m > [22mshould list all templates for workflow version
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mlistTemplates[2m > [22mshould return empty array for version with no templates
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetTemplateMapping[2m > [22mshould get template mapping by id and version
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetTemplateMapping[2m > [22mshould throw error if mapping not found
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetTemplateByKey[2m > [22mshould get template by key
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetTemplateByKey[2m > [22mshould throw error if key not found
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetPrimaryTemplate[2m > [22mshould get primary template for workflow version
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetPrimaryTemplate[2m > [22mshould return null when no primary template exists
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould update mapping key
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould update isPrimary flag
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould throw error if new key already exists
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould throw error if mapping not found
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould unset other primaries when setting isPrimary to true
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mdetachTemplate[2m > [22mshould detach template from workflow version
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mdetachTemplate[2m > [22mshould throw error if mapping not found
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22msetPrimaryTemplate[2m > [22mshould set template as primary
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22msetPrimaryTemplate[2m > [22mshould throw error if mapping not found
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mtransaction support[2m > [22mshould support operations within a transaction
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mtransaction support[2m > [22mshould rollback on transaction error
[31m[1mError[22m: Database not initialized. Call await initializeDatabase() first.[39m
[36m [2m‚ùØ[22m getDb server/db.ts:[2m92:11[22m[39m
    [90m 90| [39m[35mfunction[39m [34mgetDb[39m() {
    [90m 91| [39m  [35mif[39m ([33m![39mdbInitialized) {
    [90m 92| [39m    throw new Error("Database not initialized. Call await initializeDa‚Ä¶
    [90m   | [39m          [31m^[39m
    [90m 93| [39m  }
    [90m 94| [39m  [35mreturn[39m _db[33m;[39m
[90m [2m‚ùØ[22m new TestFactory tests/helpers/testFactory.ts:[2m79:25[22m[39m
[90m [2m‚ùØ[22m Module.createTestFactory tests/helpers/testFactory.ts:[2m459:10[22m[39m
[90m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m43:15[22m[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[140/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mshould throw error if template belongs to different project
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mshould automatically unset other primaries when setting new primary
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m102:19[22m[39m
    [90m100| [39m  [34mafterEach[39m([35masync[39m () [33m=>[39m {
    [90m101| [39m    [90m// Cleanup using factory (respects foreign key order)[39m
    [90m102| [39m    [35mawait[39m factory[33m.[39m[34mcleanup[39m({ tenantIds[33m:[39m [testTenantId] })[33m;[39m
    [90m   | [39m                  [31m^[39m
    [90m103| [39m    vi[33m.[39m[34mclearAllMocks[39m()[33m;[39m
    [90m104| [39m  })[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[141/308]‚éØ[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mlistTemplates[2m > [22mshould list all templates for workflow version
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mlistTemplates[2m > [22mshould return empty array for version with no templates
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetTemplateMapping[2m > [22mshould get template mapping by id and version
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetTemplateMapping[2m > [22mshould throw error if mapping not found
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetTemplateByKey[2m > [22mshould get template by key
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetTemplateByKey[2m > [22mshould throw error if key not found
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetPrimaryTemplate[2m > [22mshould get primary template for workflow version
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetPrimaryTemplate[2m > [22mshould return null when no primary template exists
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould update mapping key
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould update isPrimary flag
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould throw error if new key already exists
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould throw error if mapping not found
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould unset other primaries when setting isPrimary to true
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mdetachTemplate[2m > [22mshould detach template from workflow version
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mdetachTemplate[2m > [22mshould throw error if mapping not found
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22msetPrimaryTemplate[2m > [22mshould set template as primary
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22msetPrimaryTemplate[2m > [22mshould throw error if mapping not found
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mtransaction support[2m > [22mshould support operations within a transaction
[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mtransaction support[2m > [22mshould rollback on transaction error
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2m‚ùØ[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m102:19[22m[39m
    [90m100| [39m  [34mafterEach[39m([35masync[39m () [33m=>[39m {
    [90m101| [39m    [90m// Cleanup using factory (respects foreign key order)[39m
    [90m102| [39m    [35mawait[39m factory[33m.[39m[34mcleanup[39m({ tenantIds[33m:[39m [testTenantId] })[33m;[39m
    [90m   | [39m                  [31m^[39m
    [90m103| [39m    vi[33m.[39m[34mclearAllMocks[39m()[33m;[39m
    [90m104| [39m  })[33m;[39m

[31m[2m‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ‚éØ[142/308]‚éØ[22m[39m


[2m Test Files [22m [1m[31m55 failed[39m[22m[2m | [22m[1m[32m100 passed[39m[22m[2m | [22m[33m1 skipped[39m[90m (156)[39m
[2m      Tests [22m [1m[31m210 failed[39m[22m[2m | [22m[1m[32m1966 passed[39m[22m[2m | [22m[33m204 skipped[39m[90m (2380)[39m
[2m   Start at [22m 10:50:20
[2m   Duration [22m 54.44s[2m (transform 64.00s, setup 26.40s, import 206.24s, tests 223.04s, environment 26.79s)[22m

