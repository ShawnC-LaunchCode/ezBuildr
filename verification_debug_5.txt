npm warn Unknown project config "puppeteer_skip_download". This will stop working in the next major version of npm.

> ezbuildr@1.0.0 test
> cross-env VITEST_INTEGRATION=true vitest run --coverage tests/integration/api.snapshots.test.ts tests/integration/js_helpers.test.ts tests/integration/api.ai.doc.test.ts


[1m[46m RUN [49m[22m [36mv4.0.16 [39m[90mC:/Users/scoot/poll/VaultLogic[39m
      [2mCoverage enabled with [22m[33mv8[39m

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768339473458,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768339473464,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768339473472,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mÎ“Â£Ã  OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mÎ“Â£Ã  OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mÎ“Â£Ã  OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w0
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w1
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w2
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0 (Reused: true)

{"level":30,"time":1768339478567,"env":"test","msg":"DB: initializing... Local"}
{"level":20,"time":1768339478567,"env":"test","msg":"DB: importing pg..."}
{"level":20,"time":1768339478567,"env":"test","msg":"DB: creating pool..."}
{"level":20,"time":1768339478568,"env":"test","msg":"DB: importing drizzle..."}
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w1 (Reused: true)

{"level":30,"time":1768339478579,"env":"test","msg":"DB: initializing... Local"}
{"level":20,"time":1768339478579,"env":"test","msg":"DB: importing pg..."}
{"level":20,"time":1768339478580,"env":"test","msg":"DB: creating pool..."}
{"level":20,"time":1768339478580,"env":"test","msg":"DB: importing drizzle..."}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w2 (Reused: true)

{"level":30,"time":1768339478585,"env":"test","msg":"DB: initializing... Local"}
{"level":20,"time":1768339478585,"env":"test","msg":"DB: importing pg..."}
{"level":20,"time":1768339478585,"env":"test","msg":"DB: creating pool..."}
{"level":20,"time":1768339478586,"env":"test","msg":"DB: importing drizzle..."}
{"level":20,"time":1768339478598,"env":"test","msg":"DB: created."}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
Î“Ã…âŒ Schema reused, skipping migrations.

{"level":30,"time":1768339478598,"env":"test","msg":"DB: initialized flag set."}
{"level":20,"time":1768339478616,"env":"test","msg":"DB: created."}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
Î“Ã…âŒ Schema reused, skipping migrations.

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
Î“Ã…âŒ Schema reused, skipping migrations.

{"level":30,"time":1768339478616,"env":"test","msg":"DB: initialized flag set."}
{"level":20,"time":1768339478617,"env":"test","msg":"DB: created."}
{"level":30,"time":1768339478617,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768339479100,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768339479117,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/js_helpers.test.ts[2m > [22m[2mDetailed Verification: JS Helper Availability
[22m[39mâ‰¡Æ’Ã´Ãœ API Documentation available at /api-docs
[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768339479117,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768339479107,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768339479108,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768339479111,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768339479116,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768339479116,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768339479117,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768339479117,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768339479124,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768339479134,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts[2m > [22m[2mAI Document Assistant API Integration Tests
[22m[39mâ‰¡Æ’Ã´Ãœ API Documentation available at /api-docs
[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768339479140,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.snapshots.test.ts[2m > [22m[2mStage 13: Workflow Snapshots & Versioning
[22m[39mâ‰¡Æ’Ã´Ãœ API Documentation available at /api-docs
[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768339479130,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768339479131,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768339479135,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768339479140,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768339479140,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768339479140,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768339479140,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768339479125,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768339479125,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768339479129,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768339479134,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768339479134,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768339479134,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768339479134,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":40,"time":1768339479153,"env":"test","error":{},"msg":"Deterministic DOCX extraction failed"}
{"level":30,"time":1768339479179,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768339479179,"env":"test","msg":"DB: pool closed."}
 [32mÎ“Â£Ã´[39m tests/integration/api.ai.doc.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 1035[2mms[22m[39m
{"level":40,"time":1768339479458,"env":"test","workflowId":"2d660a56-fd1d-46aa-bed9-361d8cec5778","msg":"No current or pinned version found for workflow, run might be unstable"}
{"level":20,"time":1768339479612,"env":"test","module":"tenant-middleware","userId":"test-user-id","tenantId":"e92916a7-4979-4ff3-9560-11329b4db933","path":"/runs/a64e125b-84f8-4fa2-889e-5912f8555035","msg":"Tenant validation successful"}
{"level":40,"time":1768339479613,"env":"test","module":"rbac-middleware","userId":"test-user-id","permission":"run:view","path":"/runs/a64e125b-84f8-4fa2-889e-5912f8555035","msg":"Permission denied"}
stderr | tests/integration/api.snapshots.test.ts > Stage 13: Workflow Snapshots & Versioning > should maintain immutability of runs across versions
Run Fetch Failed Body: {
  "message": "Permission denied",
  "error": "forbidden",
  "details": "Required permission: run:view"
}
Run Fetch Failed Text: {"message":"Permission denied","error":"forbidden","details":"Required permission: run:view"}

{"level":20,"time":1768339479654,"env":"test","workflowId":"2d660a56-fd1d-46aa-bed9-361d8cec5778","runId":"aa8355fe-23e0-48f4-9806-d98358e6b93c","msg":"No context for metrics, skipping capture"}
{"level":30,"time":1768339479742,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768339479743,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768339479808,"env":"test","module":"runs-routes","runId":"undefined","sectionId":"00171824-5f6d-4b42-a7c3-f21b4ee572f6","valuesType":"object","isArray":true,"valuesLength":0,"bodyKeys":["values"],"msg":"Section submit request received"}
{"level":50,"time":1768339479855,"env":"test","module":"runs-routes","error":{"length":141,"name":"error","severity":"ERROR","code":"22P02","where":"unnamed portal parameter $1 = '...'","file":"uuid.c","line":"138","routine":"string_to_uuid"},"runId":"undefined","sectionId":"00171824-5f6d-4b42-a7c3-f21b4ee572f6","msg":"Error submitting section values"}
{"level":30,"time":1768339479858,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768339479859,"env":"test","msg":"DB: pool closed."}
 [31mÎ“Â¥Â»[39m tests/integration/api.snapshots.test.ts [2m([22m[2m1 test[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 1590[2mms[22m[39m
[31m     [31mâ”œÃ¹[31m should maintain immutability of runs across versions[39m[33m 301[2mms[22m[39m
 [31mÎ“Â¥Â»[39m tests/integration/js_helpers.test.ts [2m([22m[2m1 test[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 1715[2mms[22m[39m
[31m     [31mâ”œÃ¹[31m should execute a JS block that uses helper functions[39m[33m 562[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 2 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/api.snapshots.test.ts > Stage 13: Workflow Snapshots & Versioning > should maintain immutability of runs across versions
AssertionError: expected 403 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 403

 Î“Â¥Â» tests/integration/api.snapshots.test.ts:217:37
    215|             console.error("Run Fetch Failed Text:", run1Response.text);
    216|         }
    217|         expect(run1Response.status).toBe(200);
       |                                     ^
    218|         const run1Graph = run1Response.body.workflowVersion.graphJson;
    219|         expect(run1Graph.nodes[0].config.question).toBe('Version 1 QueÎ“Ã‡Âª

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/2]Î“Ã„Â»

 FAIL  tests/integration/js_helpers.test.ts > Detailed Verification: JS Helper Availability > should execute a JS block that uses helper functions
Error: Submit failed with status 500: {
  "success": false,
  "errors": [
    "invalid input syntax for type uuid: \"undefined\""
  ]
}
 Î“Â¥Â» tests/integration/js_helpers.test.ts:168:19
    166| 
    167|         if (submitRes.status !== 200) {
    168|             throw new Error(`Submit failed with status ${submitRes.staÎ“Ã‡Âª
       |                   ^
    169|         }
    170| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/2]Î“Ã„Â»


[2m Test Files [22m [1m[31m2 failed[39m[22m[2m | [22m[1m[32m1 passed[39m[22m[90m (3)[39m
[2m      Tests [22m [1m[31m2 failed[39m[22m[2m | [22m[1m[32m4 passed[39m[22m[90m (6)[39m
[2m   Start at [22m 15:24:30
[2m   Duration [22m 15.74s[2m (transform 8.06s, setup 373ms, import 20.34s, tests 4.34s, environment 0ms)[22m

