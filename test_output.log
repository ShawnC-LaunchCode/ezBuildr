npm warn Unknown project config "puppeteer_skip_download". This will stop working in the next major version of npm.

[1m[46m RUN [49m[22m [36mv4.0.16 [39m[90mC:/Users/scoot/poll/VaultLogic[39m

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w0
[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0 (Reused: true)

{"level":30,"time":1768319862732,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768319862756,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
Î“Ã…âŒ Schema reused, skipping migrations.

{"level":30,"time":1768319863899,"env":"test","workflowId":"ac7fcaba-91fc-45fd-9248-cbc92f377f94","userId":"90e6ceb0-1018-492d-a589-908601499e3c","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
stderr | tests/integration/ai/workflowEdit.test.ts > POST /api/workflows/:workflowId/ai/edit - Integration Test > should create draft version on successful AI edit
[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":50,"time":1768319864000,"env":"test","module":"ai-workflow-edit-routes","error":{},"workflowId":"ac7fcaba-91fc-45fd-9248-cbc92f377f94","msg":"AI model call failed"}
{"level":30,"time":1768319864205,"env":"test","workflowId":"e08e1997-bcf4-4be2-ac5c-f153f52dd15d","userId":"90e6ceb0-1018-492d-a589-908601499e3c","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
stderr | tests/integration/ai/workflowEdit.test.ts > POST /api/workflows/:workflowId/ai/edit - Integration Test > should enforce draft mode (revert active workflow to draft)
[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":50,"time":1768319864300,"env":"test","module":"ai-workflow-edit-routes","error":{},"workflowId":"e08e1997-bcf4-4be2-ac5c-f153f52dd15d","msg":"AI model call failed"}
{"level":30,"time":1768319864455,"env":"test","workflowId":"173c4524-278c-4c50-828f-76ff369d8f56","userId":"90e6ceb0-1018-492d-a589-908601499e3c","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
stderr | tests/integration/ai/workflowEdit.test.ts > POST /api/workflows/:workflowId/ai/edit - Integration Test > should not create version when no changes detected (checksum match)
[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":50,"time":1768319864553,"env":"test","module":"ai-workflow-edit-routes","error":{},"workflowId":"173c4524-278c-4c50-828f-76ff369d8f56","msg":"AI model call failed"}
{"level":30,"time":1768319864709,"env":"test","workflowId":"e15acc0a-23ee-4d34-916b-04005cece1ee","userId":"90e6ceb0-1018-492d-a589-908601499e3c","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
stderr | tests/integration/ai/workflowEdit.test.ts > POST /api/workflows/:workflowId/ai/edit - Integration Test > should reject unauthorized access
[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":50,"time":1768319864841,"env":"test","module":"ai-workflow-edit-routes","error":{},"workflowId":"e15acc0a-23ee-4d34-916b-04005cece1ee","msg":"AI model call failed"}
{"level":30,"time":1768319864994,"env":"test","workflowId":"700e3267-df25-40b6-93bb-d63c46a5eddd","userId":"90e6ceb0-1018-492d-a589-908601499e3c","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
stderr | tests/integration/ai/workflowEdit.test.ts > POST /api/workflows/:workflowId/ai/edit - Integration Test > should reject unsafe DataVault operations
[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":50,"time":1768319865092,"env":"test","module":"ai-workflow-edit-routes","error":{},"workflowId":"700e3267-df25-40b6-93bb-d63c46a5eddd","msg":"AI model call failed"}
{"level":30,"time":1768319865303,"env":"test","workflowId":"fc54408a-074c-4c2c-b294-833dbae25e87","userId":"90e6ceb0-1018-492d-a589-908601499e3c","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
stderr | tests/integration/ai/workflowEdit.test.ts > POST /api/workflows/:workflowId/ai/edit - Integration Test > should handle multi-operation edits with tempId resolution
[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":50,"time":1768319865401,"env":"test","module":"ai-workflow-edit-routes","error":{},"workflowId":"fc54408a-074c-4c2c-b294-833dbae25e87","msg":"AI model call failed"}
{"level":30,"time":1768319865556,"env":"test","workflowId":"95c1560b-b06e-4e2e-9de0-456e5f1f764f","userId":"90e6ceb0-1018-492d-a589-908601499e3c","sectionsCount":0,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
stderr | tests/integration/ai/workflowEdit.test.ts > POST /api/workflows/:workflowId/ai/edit - Integration Test > should create BEFORE and AFTER snapshots
[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.

{"level":50,"time":1768319865653,"env":"test","module":"ai-workflow-edit-routes","error":{},"workflowId":"95c1560b-b06e-4e2e-9de0-456e5f1f764f","msg":"AI model call failed"}
{"level":30,"time":1768319865955,"env":"test","workflowId":"b0492fea-cebf-4276-86e4-a5fad68a43e8","userId":"90e6ceb0-1018-492d-a589-908601499e3c","sectionsCount":1,"stepsCount":1,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
stderr | tests/integration/ai/workflowEdit.test.ts > POST /api/workflows/:workflowId/ai/edit - Integration Test > should rollback on validation failure
[vitest] The vi.fn() mock did not use 'function' or 'class' in its implementation, see https://vitest.dev/api/vi#vi-spyon for examples.
{"level":50,"time":1768319866051,"env":"test","module":"ai-workflow-edit-routes","error":{},"workflowId":"b0492fea-cebf-4276-86e4-a5fad68a43e8","msg":"AI model call failed"}

{"level":30,"time":1768319866322,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768319866322,"env":"test","msg":"DB: pool closed."}
 [31mÎ“Â¥Â»[39m tests/integration/ai/workflowEdit.test.ts [2m([22m[2m8 tests[22m[2m | [22m[31m8 failed[39m[2m)[22m[33m 4004[2mms[22m[39m
[31m     [31mâ”œÃ¹[31m should create draft version on successful AI edit[39m[33m 585[2mms[22m[39m
[31m     [31mâ”œÃ¹[31m should enforce draft mode (revert active workflow to draft)[39m[32m 296[2mms[22m[39m
[31m     [31mâ”œÃ¹[31m should not create version when no changes detected (checksum match)[39m[32m 254[2mms[22m[39m
[31m     [31mâ”œÃ¹[31m should reject unauthorized access[39m[32m 288[2mms[22m[39m
[31m     [31mâ”œÃ¹[31m should reject unsafe DataVault operations[39m[32m 250[2mms[22m[39m
[31m     [31mâ”œÃ¹[31m should handle multi-operation edits with tempId resolution[39m[33m 309[2mms[22m[39m
[31m     [31mâ”œÃ¹[31m should create BEFORE and AFTER snapshots[39m[32m 252[2mms[22m[39m
[31m     [31mâ”œÃ¹[31m should rollback on validation failure[39m[33m 398[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 8 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/ai/workflowEdit.test.ts > POST /api/workflows/:workflowId/ai/edit - Integration Test > should create draft version on successful AI edit
Error: expected 200 "OK", got 500 "Internal Server Error"
 Î“Â¥Â» tests/integration/ai/workflowEdit.test.ts:152:8
    150|         },
    151|       })
    152|       .expect(200);
       |        ^
    153| 
    154|     expect(response.body.success).toBe(true);
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» Server.<anonymous> node_modules/supertest/lib/test.js:152:11

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/8]Î“Ã„Â»

 FAIL  tests/integration/ai/workflowEdit.test.ts > POST /api/workflows/:workflowId/ai/edit - Integration Test > should enforce draft mode (revert active workflow to draft)
Error: expected 200 "OK", got 500 "Internal Server Error"
 Î“Â¥Â» tests/integration/ai/workflowEdit.test.ts:192:8
    190|         userMessage: 'Add a phone number field',
    191|       })
    192|       .expect(200);
       |        ^
    193| 
    194|     // Verify workflow is now draft
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» Server.<anonymous> node_modules/supertest/lib/test.js:152:11

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/8]Î“Ã„Â»

 FAIL  tests/integration/ai/workflowEdit.test.ts > POST /api/workflows/:workflowId/ai/edit - Integration Test > should not create version when no changes detected (checksum match)
Error: expected 200 "OK", got 500 "Internal Server Error"
 Î“Â¥Â» tests/integration/ai/workflowEdit.test.ts:209:8
    207|         userMessage: 'Add contact section',
    208|       })
    209|       .expect(200);
       |        ^
    210| 
    211|     const versionId1 = response1.body.data.versionId;
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» Server.<anonymous> node_modules/supertest/lib/test.js:152:11

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/8]Î“Ã„Â»

 FAIL  tests/integration/ai/workflowEdit.test.ts > POST /api/workflows/:workflowId/ai/edit - Integration Test > should reject unauthorized access
Error: expected 401 "Unauthorized", got 500 "Internal Server Error"
 Î“Â¥Â» tests/integration/ai/workflowEdit.test.ts:257:8
    255|         userMessage: 'Add field',
    256|       })
    257|       .expect(401);
       |        ^
    258|   });
    259| 
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» Server.<anonymous> node_modules/supertest/lib/test.js:152:11

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/8]Î“Ã„Â»

 FAIL  tests/integration/ai/workflowEdit.test.ts > POST /api/workflows/:workflowId/ai/edit - Integration Test > should reject unsafe DataVault operations
Error: expected 400 "Bad Request", got 500 "Internal Server Error"
 Î“Â¥Â» tests/integration/ai/workflowEdit.test.ts:289:8
    287|         userMessage: 'Delete all data',
    288|       })
    289|       .expect(400);
       |        ^
    290| 
    291|     expect(response.body.success).toBe(false);
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» Server.<anonymous> node_modules/supertest/lib/test.js:152:11

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/8]Î“Ã„Â»

 FAIL  tests/integration/ai/workflowEdit.test.ts > POST /api/workflows/:workflowId/ai/edit - Integration Test > should handle multi-operation edits with tempId resolution
Error: expected 200 "OK", got 500 "Internal Server Error"
 Î“Â¥Â» tests/integration/ai/workflowEdit.test.ts:357:8
    355|         userMessage: 'Add emergency contact section with name and phonÎ“Ã‡Âª
    356|       })
    357|       .expect(200);
       |        ^
    358| 
    359|     expect(response.body.success).toBe(true);
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» Server.<anonymous> node_modules/supertest/lib/test.js:152:11

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/8]Î“Ã„Â»

 FAIL  tests/integration/ai/workflowEdit.test.ts > POST /api/workflows/:workflowId/ai/edit - Integration Test > should create BEFORE and AFTER snapshots
Error: expected 200 "OK", got 500 "Internal Server Error"
 Î“Â¥Â» tests/integration/ai/workflowEdit.test.ts:388:8
    386|         userMessage: 'Add a simple field',
    387|       })
    388|       .expect(200);
       |        ^
    389| 
    390|     const versionId = response.body.data.versionId;
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» Server.<anonymous> node_modules/supertest/lib/test.js:152:11

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[7/8]Î“Ã„Â»

 FAIL  tests/integration/ai/workflowEdit.test.ts > POST /api/workflows/:workflowId/ai/edit - Integration Test > should rollback on validation failure
Error: expected 400 "Bad Request", got 500 "Internal Server Error"
 Î“Â¥Â» tests/integration/ai/workflowEdit.test.ts:455:8
    453|         userMessage: 'Add backup email field',
    454|       })
    455|       .expect(400);
       |        ^
    456| 
    457|     expect(response.body.success).toBe(false);
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» Server.<anonymous> node_modules/supertest/lib/test.js:152:11

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[8/8]Î“Ã„Â»


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m8 failed[39m[22m[90m (8)[39m
[2m   Start at [22m 09:57:40
[2m   Duration [22m 5.73s[2m (transform 681ms, setup 147ms, import 1.24s, tests 4.00s, environment 0ms)[22m

