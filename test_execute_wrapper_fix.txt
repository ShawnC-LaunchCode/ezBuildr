npm warn Unknown project config "puppeteer_skip_download". This will stop working in the next major version of npm.

> ezbuildr@1.0.0 test
> cross-env VITEST_INTEGRATION=true vitest run --coverage


[1m[46m RUN [49m[22m [36mv4.0.16 [39m[90mC:/Users/scoot/poll/VaultLogic[39m
      [2mCoverage enabled with [22m[33mv8[39m

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w12_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w12_v3 (Reused: true)

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w4_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w4_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w7_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w7_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w14_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w14_v3 (Reused: true)

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w5_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w9_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w5_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w9_v3 (Reused: true)

[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mðŸ“Š Schema test_schema_w12_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709098218,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709098219,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w12_v3\",public"}
{"level":30,"time":1768709098270,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w12_v3\",public"}
{"level":30,"time":1768709098270,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mðŸ“Š Schema test_schema_w4_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709098291,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709098292,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w4_v3\",public"}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w11_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768709098340,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w4_v3\",public"}
{"level":30,"time":1768709098340,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mðŸ“Š Schema test_schema_w7_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709098371,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709098371,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w7_v3\",public"}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w11_v3 (Reused: true)

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w8_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768709098423,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w7_v3\",public"}
{"level":30,"time":1768709098423,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39mðŸ“Š Schema test_schema_w14_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstderr[2m | tests/unit/services/AuthService.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): Error: [vitest] No "closeDatabase" export is defined on the "../../../server/db" mock. Did you forget to return it from "vi.mock"?
If you need to partially mock a module, you can use "importOriginal" helper inside:

    at VitestMocker.createError [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:311:17[90m)[39m
    at Object.get [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:384:16[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:177:34
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m {
  codeFrame: [32m'vi.mock(import("../../../server/db"), async (importOriginal) => {\n'[39m +
    [32m'  const actual = await importOriginal()\n'[39m +
    [32m'  return {\n'[39m +
    [32m'    ...actual,\n'[39m +
    [32m'    // your mocked methods\n'[39m +
    [32m'  }\n'[39m +
    [32m'})'[39m
}

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w8_v3 (Reused: true)

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mðŸ“Š Schema test_schema_w5_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709098501,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709098503,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w5_v3\",public"}
[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mðŸ“Š Schema test_schema_w9_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709098550,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w5_v3\",public"}
{"level":30,"time":1768709098551,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mðŸ“Š Schema test_schema_w11_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709098796,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709098798,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w11_v3\",public"}
{"level":30,"time":1768709098849,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w11_v3\",public"}
{"level":30,"time":1768709098849,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mðŸ“Š Schema test_schema_w8_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709098874,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709098875,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w8_v3\",public"}
{"level":30,"time":1768709098935,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w8_v3\",public"}
{"level":30,"time":1768709098935,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w12_v3, public
âœ… Enforced search_path: test_schema_w12_v3, public

[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w4_v3, public
âœ… Enforced search_path: test_schema_w4_v3, public

[90mstderr[2m | tests/integration/ownershipAccess.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w7_v3, public
âœ… Enforced search_path: test_schema_w7_v3, public

[90mstderr[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w5_v3, public
âœ… Enforced search_path: test_schema_w5_v3, public

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w9_v3, public
âœ… Enforced search_path: test_schema_w9_v3, public

[90mstderr[2m | tests/integration/organizationInvites.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w11_v3, public
âœ… Enforced search_path: test_schema_w11_v3, public

{"level":30,"time":1768709099661,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768709099664,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768709099666,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768709099669,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768709099669,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768709099669,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstderr[2m | tests/unit/engine/templateNode.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w8_v3, public
âœ… Enforced search_path: test_schema_w8_v3, public

[90mstderr[2m | tests/integration/transferOwnership.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w10_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w0_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w6_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w1_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w13_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w2_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w10_v3 (Reused: true)

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w0_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w6_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w1_v3 (Reused: true)

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w13_v3 (Reused: true)

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w2_v3 (Reused: true)

[90mstderr[2m | tests/integration/ownershipAccess.test.ts[2m > [22m[2mOwnership Access Control[2m > [22m[2mcanAccessAsset[2m > [22m[2mshould allow access to null ownership (legacy data)
[22m[39mSetup error: DrizzleQueryError: Failed query: insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, default, default, default), ($4, $5, default, default, default, default, $6, default, default, default) on conflict do nothing
params: 10000000-0000-0000-0000-000000000001,Test Org 1,00000000-0000-0000-0000-000000000099,10000000-0000-0000-0000-000000000002,Test Org 2,00000000-0000-0000-0000-000000000099
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/ownershipAccess.test.ts:35:7 {
  query: [32m'insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, default, default, default), ($4, $5, default, default, default, default, $6, default, default, default) on conflict do nothing'[39m,
  params: [
    [32m'10000000-0000-0000-0000-000000000001'[39m,
    [32m'Test Org 1'[39m,
    [32m'00000000-0000-0000-0000-000000000099'[39m,
    [32m'10000000-0000-0000-0000-000000000002'[39m,
    [32m'Test Org 2'[39m,
    [32m'00000000-0000-0000-0000-000000000099'[39m
  ],
  cause: error: insert or update on table "organizations" violates foreign key constraint "organizations_tenant_id_tenants_id_fk"
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/ownershipAccess.test.ts:35:7 {
    length: [33m347[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23503'[39m,
    detail: [32m'Key (tenant_id)=(00000000-0000-0000-0000-000000000099) is not present in table "tenants".'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w45_v3'[39m,
    table: [32m'organizations'[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [32m'organizations_tenant_id_tenants_id_fk'[39m,
    file: [32m'ri_triggers.c'[39m,
    line: [32m'2599'[39m,
    routine: [32m'ri_ReportViolation'[39m
  }
}

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould transfer user-owned project to org
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,12dc8574-637b-43fe-81f2-9618c3a4ced1,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'12dc8574-637b-43fe-81f2-9618c3a4ced1'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m523[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (347ac585-b7f0-41f6-b4ee-fb15f734af36, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 12dc8574-637b-43fe-81f2-9618c3a4ced1, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 04:05:01.681449, 2026-01-18 04:05:01.681449).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w45_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mðŸ“Š Schema test_schema_w6_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709100690,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709100690,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w6_v3\",public"}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mðŸ“Š Schema test_schema_w10_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mðŸ“Š Schema test_schema_w0_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709100697,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709100697,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709100698,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w10_v3\",public"}
{"level":30,"time":1768709100698,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w0_v3\",public"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mðŸ“Š Schema test_schema_w1_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709100709,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709100709,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w1_v3\",public"}
[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mðŸ“Š Schema test_schema_w2_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709100716,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709100716,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w2_v3\",public"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mðŸ“Š Schema test_schema_w13_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709100717,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709100717,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w13_v3\",public"}
{"level":30,"time":1768709100757,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w6_v3\",public"}
{"level":30,"time":1768709100753,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w0_v3\",public"}
{"level":30,"time":1768709100753,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709100757,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709100761,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w10_v3\",public"}
{"level":30,"time":1768709100761,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709100762,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w1_v3\",public"}
{"level":30,"time":1768709100762,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709100769,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w2_v3\",public"}
{"level":30,"time":1768709100769,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709100770,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w13_v3\",public"}
{"level":30,"time":1768709100770,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould create invite for existing user without creating placeholder
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,ea136605-0dd1-4869-8f20-a697bfc0134e,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'ea136605-0dd1-4869-8f20-a697bfc0134e'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m521[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (e9654f05-1279-4eed-82b2-683529c49560, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, ea136605-0dd1-4869-8f20-a697bfc0134e, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-18 04:05:02.110649, 2026-01-18 04:05:02.110649).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w13_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mâš ï¸ Could not set database-level search_path (expected in cloud DBs): tuple concurrently updated
âœ… Enforced search_path: test_schema_w10_v3, public

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mâš ï¸ Could not set database-level search_path (expected in cloud DBs): tuple concurrently updated
âœ… Enforced search_path: test_schema_w1_v3, public

[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w0_v3, public
âœ… Enforced search_path: test_schema_w0_v3, public

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w6_v3, public
âœ… Enforced search_path: test_schema_w6_v3, public

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w13_v3, public
âœ… Enforced search_path: test_schema_w13_v3, public

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w2_v3, public
âœ… Enforced search_path: test_schema_w2_v3, public

[90mstderr[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/integration/auth.routes.real.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/integration/session.management.real.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould prevent transfer to org if user is not a member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,7fa177bd-dd1d-4a12-bcb6-59dc6712cc33,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'7fa177bd-dd1d-4a12-bcb6-59dc6712cc33'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m523[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (da83cbc7-3309-49cf-93ce-0140e144fd18, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 7fa177bd-dd1d-4a12-bcb6-59dc6712cc33, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 04:05:02.732718, 2026-01-18 04:05:02.732718).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w13_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":50,"time":1768709102136,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["40612d32-34c4-4644-9eeb-bd65f4d01417","$2b$12$nJdGiG.zUKD4AjCOy.TLROJMEBivL5/wDTKsssg978NLyQtgem2YS"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(40612d32-34c4-4644-9eeb-bd65f4d01417) is not present in table \"users\".","schema":"test_schema_w4_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"40612d32-34c4-4644-9eeb-bd65f4d01417","msg":"Failed to create user credentials"}
{"level":50,"time":1768709102136,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["40612d32-34c4-4644-9eeb-bd65f4d01417","$2b$12$nJdGiG.zUKD4AjCOy.TLROJMEBivL5/wDTKsssg978NLyQtgem2YS"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(40612d32-34c4-4644-9eeb-bd65f4d01417) is not present in table \"users\".","schema":"test_schema_w4_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":50,"time":1768709102226,"env":"test","module":"auth-routes","email":"test-1768709101772-icvck@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768709102319,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768709102383,"env":"test","module":"auth-routes","email":"test-1768709101772-icvck@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768709102474,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768709102530,"env":"test","module":"auth-routes","email":"test-1768709101772-icvck@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768709102647,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for current user
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":30,"time":1768709102650,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mProject Transfer[2m > [22m[2mshould allow org member to transfer org-owned project to another org they belong to
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,0e7e1c5f-9e18-49b4-9c13-f9418ab25e3c,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'0e7e1c5f-9e18-49b4-9c13-f9418ab25e3c'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m523[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (b773b38a-3f75-4b71-80de-3860bf595b73, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 0e7e1c5f-9e18-49b4-9c13-f9418ab25e3c, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 04:05:03.725693, 2026-01-18 04:05:03.725693).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w12_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould prevent inviting existing members
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,7d9090d4-da4d-4fec-bdab-7d0bceec5209,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'7d9090d4-da4d-4fec-bdab-7d0bceec5209'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m520[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (d69e1ffb-5565-40dd-9cf3-e5c60b4e67d7, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, 7d9090d4-da4d-4fec-bdab-7d0bceec5209, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-18 04:05:03.787433, 2026-01-18 04:05:03.787433).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w6_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/unit/services/AuthService.test.ts[2m > [22m[2mAuthService[2m > [22m[2mJWT Token Management[2m > [22m[2mverifyToken()[2m > [22m[2mshould throw error for invalid token signature
[22m[39mDEBUG: verifyToken threw: Invalid or malformed token InvalidTokenError

{"level":50,"time":1768709103129,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["8b521642-071e-4d9b-b6d3-b2923436b71b","$2b$12$H5LllyWcKUFi8HZqhiRPHuJcVJcAq6QPaPM7Ess2v0LRgWy8j51de"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(8b521642-071e-4d9b-b6d3-b2923436b71b) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"8b521642-071e-4d9b-b6d3-b2923436b71b","msg":"Failed to create user credentials"}
{"level":50,"time":1768709103129,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["8b521642-071e-4d9b-b6d3-b2923436b71b","$2b$12$H5LllyWcKUFi8HZqhiRPHuJcVJcAq6QPaPM7Ess2v0LRgWy8j51de"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(8b521642-071e-4d9b-b6d3-b2923436b71b) is not present in table \"users\".","schema":"test_schema_w0_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould detach workflow from project when transferring to different owner
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,bb118f77-6ed0-4545-94d0-f3582cb4afc7,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'bb118f77-6ed0-4545-94d0-f3582cb4afc7'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m522[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (bcef41eb-7ccc-466a-a7a1-3504d5b2ed1c, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, bb118f77-6ed0-4545-94d0-f3582cb4afc7, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 04:05:04.700051, 2026-01-18 04:05:04.700051).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w6_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":50,"time":1768709103870,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["264e08fb-9e28-493d-ba1d-7d668dc91e09","$2b$12$yOEX6QvnqoEtijPYt2MY3ujRUqYM5Tb3ZmIWTEb/mtbEuYzclagZC"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(264e08fb-9e28-493d-ba1d-7d668dc91e09) is not present in table \"users\".","schema":"test_schema_w7_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"264e08fb-9e28-493d-ba1d-7d668dc91e09","msg":"Failed to create user credentials"}
{"level":50,"time":1768709103870,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["264e08fb-9e28-493d-ba1d-7d668dc91e09","$2b$12$yOEX6QvnqoEtijPYt2MY3ujRUqYM5Tb3ZmIWTEb/mtbEuYzclagZC"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(264e08fb-9e28-493d-ba1d-7d668dc91e09) is not present in table \"users\".","schema":"test_schema_w7_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould require admin access to create invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,cc3b8661-0770-49b4-bb54-7797c77dc8e8,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'cc3b8661-0770-49b4-bb54-7797c77dc8e8'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m520[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (da53e8aa-5234-46e9-96c1-3c0e4ece1f55, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, cc3b8661-0770-49b4-bb54-7797c77dc8e8, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-18 04:05:04.965995, 2026-01-18 04:05:04.965995).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w8_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":50,"time":1768709104084,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768709104656,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["5a614138-eef7-43fb-aa6c-a5e420bd4b13","$2b$12$KnabtXCxlucnUpVmBh1hu.9Ggcy/g4XNZrHRFX9bhxRUAyHHZlOde"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(5a614138-eef7-43fb-aa6c-a5e420bd4b13) is not present in table \"users\".","schema":"test_schema_w4_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"5a614138-eef7-43fb-aa6c-a5e420bd4b13","msg":"Failed to create user credentials"}
{"level":50,"time":1768709104656,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["5a614138-eef7-43fb-aa6c-a5e420bd4b13","$2b$12$KnabtXCxlucnUpVmBh1hu.9Ggcy/g4XNZrHRFX9bhxRUAyHHZlOde"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(5a614138-eef7-43fb-aa6c-a5e420bd4b13) is not present in table \"users\".","schema":"test_schema_w4_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould keep workflow in project when transferring to same owner
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,de5bd124-eef6-4faf-8867-fdda0e1decfb,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'de5bd124-eef6-4faf-8867-fdda0e1decfb'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m522[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (203a9940-0ee9-4da7-860e-a74d9947cca6, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, de5bd124-eef6-4faf-8867-fdda0e1decfb, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 04:05:05.682755, 2026-01-18 04:05:05.682755).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w4_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mcreateInvite[2m > [22m[2mshould set expiry to 7 days from now
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,0102195b-6c9d-4e9a-949a-36087842d220,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'0102195b-6c9d-4e9a-949a-36087842d220'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m520[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (130eaace-5d8e-4464-b447-8d67770e3189, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, 0102195b-6c9d-4e9a-949a-36087842d220, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-18 04:05:06.147915, 2026-01-18 04:05:06.147915).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w6_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":50,"time":1768709105233,"env":"test","module":"auth-routes","email":"test-1768709104799-plria@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768709105360,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mMFA Setup Flow[2m > [22m[2mshould store hashed backup codes
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768709105374,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768709105463,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["5MPwiaLP526pCK-4WgcRa","$2b$12$2W9hf2zK9pOfWu5Usnnv8OYsDb8U.zVDjB5qbuUlHYtpCCPLM4lRK"],"cause":{"length":332,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(5MPwiaLP526pCK-4WgcRa) is not present in table \"users\".","schema":"test_schema_w10_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"5MPwiaLP526pCK-4WgcRa","msg":"Failed to create user credentials"}
[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mWorkflow Transfer[2m > [22m[2mshould prevent non-member from transferring org workflow
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,0f20e911-eaf4-419d-b659-0e3f477978f9,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'0f20e911-eaf4-419d-b659-0e3f477978f9'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m523[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (801270ef-5ec7-4ef0-bc1a-7bc411c72e2f, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 0f20e911-eaf4-419d-b659-0e3f477978f9, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 04:05:06.671894, 2026-01-18 04:05:06.671894).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w13_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/unit/services/AuthService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [31mâ¯[39m tests/unit/services/AuthService.test.ts [2m([22m[2m113 tests[22m[2m | [22m[31m13 failed[39m[2m)[22m[33m 8149[2mms[22m[39m
         [32mâœ“[39m should hash a password using bcrypt with 12 rounds[32m 237[2mms[22m[39m
         [33m[2mâœ“[22m[39m should generate different hashes for same password [33m 485[2mms[22m[39m
         [32mâœ“[39m should handle empty passwords[32m 236[2mms[22m[39m
         [32mâœ“[39m should handle long passwords[32m 231[2mms[22m[39m
         [32mâœ“[39m should handle unicode characters in password[32m 239[2mms[22m[39m
         [33m[2mâœ“[22m[39m should return true for correct password [33m 445[2mms[22m[39m
         [33m[2mâœ“[22m[39m should return false for incorrect password [33m 461[2mms[22m[39m
         [33m[2mâœ“[22m[39m should be case-sensitive [33m 444[2mms[22m[39m
         [33m[2mâœ“[22m[39m should handle empty password comparison [33m 446[2mms[22m[39m
         [32mâœ“[39m should accept valid email addresses[32m 2[2mms[22m[39m
         [32mâœ“[39m should reject emails longer than 254 characters (RFC 5321)[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject emails shorter than 3 characters[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject emails with consecutive dots[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject emails without @ symbol[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject emails without domain[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject emails with spaces[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject emails without TLD[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject null or undefined[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject emails with local part longer than 64 characters[32m 1[2mms[22m[39m
         [32mâœ“[39m should accept valid strong passwords[32m 25[2mms[22m[39m
         [32mâœ“[39m should reject passwords shorter than 8 characters[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject passwords longer than 128 characters[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject weak passwords with zxcvbn score < 3[32m 6[2mms[22m[39m
         [32mâœ“[39m should provide helpful feedback for weak passwords[32m 2[2mms[22m[39m
         [32mâœ“[39m should reject password containing user's email[32m 3[2mms[22m[39m
         [32mâœ“[39m should reject password containing user's name[32m 3[2mms[22m[39m
         [32mâœ“[39m should accept strong password even with user inputs provided[32m 5[2mms[22m[39m
         [32mâœ“[39m should accept password with exactly 8 characters if strong enough[32m 2[2mms[22m[39m
         [32mâœ“[39m should accept password with exactly 128 characters if strong[32m 116[2mms[22m[39m
         [32mâœ“[39m should return score in result object[32m 4[2mms[22m[39m
         [32mâœ“[39m should create a valid JWT token for a user[32m 4[2mms[22m[39m
         [32mâœ“[39m should include userId, email, tenantId, and role in token payload[32m 2[2mms[22m[39m
         [32mâœ“[39m should set token expiry to 15 minutes by default[32m 2[2mms[22m[39m
         [32mâœ“[39m should throw error if JWT_SECRET is not configured[32m 1[2mms[22m[39m
         [32mâœ“[39m should handle null tenantId and role[32m 1[2mms[22m[39m
         [32mâœ“[39m should verify and decode a valid token[32m 3[2mms[22m[39m
         [33m[2mâœ“[22m[39m should throw error for expired token [33m 1103[2mms[22m[39m
         [32mâœ“[39m should throw error for invalid token signature[32m 3[2mms[22m[39m
         [32mâœ“[39m should throw error for malformed token[32m 1[2mms[22m[39m
         [32mâœ“[39m should throw error for invalid token[32m 1[2mms[22m[39m
         [32mâœ“[39m should extract token from Bearer authorization header[32m 1[2mms[22m[39m
         [32mâœ“[39m should return token if no Bearer prefix[32m 1[2mms[22m[39m
         [32mâœ“[39m should return null for undefined header[32m 1[2mms[22m[39m
         [32mâœ“[39m should return null for empty header[32m 1[2mms[22m[39m
         [32mâœ“[39m should handle Bearer with multiple spaces[32m 1[2mms[22m[39m
         [32mâœ“[39m should return true for JWT-like tokens[32m 1[2mms[22m[39m
         [32mâœ“[39m should return false for non-JWT tokens[32m 1[2mms[22m[39m
         [32mâœ“[39m should return false for empty token[32m 1[2mms[22m[39m
         [32mâœ“[39m should return false for null/undefined[32m 1[2mms[22m[39m
         [32mâœ“[39m should create a valid portal token for an email[32m 2[2mms[22m[39m
         [32mâœ“[39m should include email and portal flag in token payload[32m 1[2mms[22m[39m
         [32mâœ“[39m should set token expiry to 24 hours[32m 1[2mms[22m[39m
         [32mâœ“[39m should verify and decode a valid portal token[32m 2[2mms[22m[39m
         [32mâœ“[39m should throw error for non-portal token[32m 2[2mms[22m[39m
         [32mâœ“[39m should throw error for token without email[32m 2[2mms[22m[39m
         [32mâœ“[39m should throw error for expired portal token[32m 2[2mms[22m[39m
[31m         [31mÃ—[31m should generate password reset token for existing user[39m[32m 228[2mms[22m[39m
         [32mâœ“[39m should return null for non-existent user[32m 2[2mms[22m[39m
[31m         [31mÃ—[31m should invalidate previous reset tokens[39m[32m 3[2mms[22m[39m
         [32mâœ“[39m should return userId for valid token[32m 3[2mms[22m[39m
         [32mâœ“[39m should return null for invalid token[32m 2[2mms[22m[39m
         [32mâœ“[39m should return null for expired token[32m 4[2mms[22m[39m
         [32mâœ“[39m should return null for used token[32m 2[2mms[22m[39m
         [32mâœ“[39m should mark token as used[32m 2[2mms[22m[39m
         [32mâœ“[39m should generate verification token[32m 1[2mms[22m[39m
         [32mâœ“[39m should have 24 hour expiry[32m 1[2mms[22m[39m
         [32mâœ“[39m should verify email with valid token[32m 2[2mms[22m[39m
         [32mâœ“[39m should return false for invalid token[32m 1[2mms[22m[39m
         [32mâœ“[39m should return false for expired token[32m 1[2mms[22m[39m
         [32mâœ“[39m should delete token after successful verification[32m 1[2mms[22m[39m
         [32mâœ“[39m should create refresh token with 30-day expiry[32m 2[2mms[22m[39m
         [32mâœ“[39m should store device metadata[32m 2[2mms[22m[39m
         [32mâœ“[39m should return userId for valid token[32m 1[2mms[22m[39m
         [32mâœ“[39m should return null for revoked token[32m 1[2mms[22m[39m
         [32mâœ“[39m should return null for expired token[32m 1[2mms[22m[39m
[31m         [31mÃ—[31m should rotate valid token and return new one[39m[32m 1[2mms[22m[39m
[31m         [31mÃ—[31m should return null for unknown token[39m[32m 1[2mms[22m[39m
[31m         [31mÃ—[31m should revoke all tokens on reuse detection[39m[32m 3[2mms[22m[39m
[31m         [31mÃ—[31m should return null for expired token[39m[32m 2[2mms[22m[39m
         [32mâœ“[39m should revoke specific token[32m 2[2mms[22m[39m
         [32mâœ“[39m should revoke all tokens for user[32m 2[2mms[22m[39m
[31m         [31mÃ—[31m should cleanup expired refresh tokens[39m[32m 2[2mms[22m[39m
[31m         [31mÃ—[31m should cleanup expired password reset tokens[39m[32m 2[2mms[22m[39m
[31m         [31mÃ—[31m should cleanup expired email verification tokens[39m[32m 1[2mms[22m[39m
[31m         [31mÃ—[31m should cleanup old login attempts via accountLockoutService[39m[32m 2[2mms[22m[39m
         [32mâœ“[39m should use JWT_SECRET if provided[32m 1[2mms[22m[39m
         [32mâœ“[39m should warn if JWT_SECRET is less than 32 characters[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject token with modified payload[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject token with valid structure but invalid signature[32m 2[2mms[22m[39m
         [33m[2mâœ“[22m[39m should handle password with special characters [33m 451[2mms[22m[39m
         [32mâœ“[39m should handle password with only spaces[32m 222[2mms[22m[39m
         [33m[2mâœ“[22m[39m should handle password with newlines and tabs [33m 441[2mms[22m[39m
         [33m[2mâœ“[22m[39m should reject password with null bytes (if validation exists) [33m 440[2mms[22m[39m
         [32mâœ“[39m should reject email with unicode domain (security fix)[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject email starting with dot (security fix)[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject email ending with dot before @ (security fix)[32m 1[2mms[22m[39m
         [32mâœ“[39m should handle email with plus addressing[32m 1[2mms[22m[39m
         [32mâœ“[39m should handle email with subdomain[32m 1[2mms[22m[39m
         [32mâœ“[39m should reject email with invalid TLD (single char)[32m 1[2mms[22m[39m
         [32mâœ“[39m should accept email with numeric TLD[32m 1[2mms[22m[39m
         [32mâœ“[39m should prevent timing attacks on token validation[32m 1[2mms[22m[39m
[31m         [31mÃ—[31m should support full user authentication lifecycle[39m[32m 224[2mms[22m[39m
[31m         [31mÃ—[31m should support complete password reset workflow[39m[32m 1[2mms[22m[39m
[31m         [31mÃ—[31m should prevent reuse of password reset tokens[39m[32m 1[2mms[22m[39m
         [32mâœ“[39m should support multiple valid refresh tokens per user[32m 1[2mms[22m[39m
         [32mâœ“[39m should revoke all user tokens on security event[32m 1[2mms[22m[39m
         [32mâœ“[39m should handle database connection failures gracefully[32m 2[2mms[22m[39m
         [32mâœ“[39m should handle transaction failures[32m 1[2mms[22m[39m
         [32mâœ“[39m should throw error if JWT signing fails[32m 1[2mms[22m[39m
         [32mâœ“[39m should hash password in reasonable time (< 500ms)[32m 222[2mms[22m[39m
         [33m[2mâœ“[22m[39m should compare password in reasonable time (< 500ms) [33m 438[2mms[22m[39m
         [32mâœ“[39m should create JWT token in < 10ms[32m 2[2mms[22m[39m
         [32mâœ“[39m should verify JWT token in < 50ms[32m 2[2mms[22m[39m
[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w3_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w3_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould accept invite and create membership
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,268d03ac-6952-40ba-b57c-289c930d9078,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'268d03ac-6952-40ba-b57c-289c930d9078'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m520[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (a0f15dde-adea-4556-b1b9-14163bcc7670, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, 268d03ac-6952-40ba-b57c-289c930d9078, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-18 04:05:07.298394, 2026-01-18 04:05:07.298394).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w5_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":50,"time":1768709106309,"env":"test","module":"auth-routes","email":"test-1768709105509-se8ud@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768709106314,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["DUWUoY5F-jr7_MbV-61xU","$2b$12$/pehjrAt1EnvNF6aA13hZehB0W7Ng9M3Z6tcf0t2lpV0O7M4uS6YS"],"cause":{"length":332,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(DUWUoY5F-jr7_MbV-61xU) is not present in table \"users\".","schema":"test_schema_w13_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"DUWUoY5F-jr7_MbV-61xU","msg":"Failed to create user credentials"}
[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mðŸ“Š Schema test_schema_w3_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709106326,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709106326,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w3_v3\",public"}
{"level":30,"time":1768709106368,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w3_v3\",public"}
{"level":30,"time":1768709106368,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768709106428,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768709106483,"env":"test","module":"auth-routes","email":"test-1768709105509-se8ud@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768709106601,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768709106606,"env":"test","module":"auth-routes","email":"nonexistent@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mDatabase Transfer[2m > [22m[2mshould transfer database ownership
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,5de51b98-c9d6-4bcc-82b0-5e599f98aa42,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'5de51b98-c9d6-4bcc-82b0-5e599f98aa42'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m523[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (535b0df6-bd1f-4ea0-a66c-c533cfeee58b, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 5de51b98-c9d6-4bcc-82b0-5e599f98aa42, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 04:05:07.657209, 2026-01-18 04:05:07.657209).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w10_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":50,"time":1768709106700,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for non-existent user
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

{"level":50,"time":1768709106748,"env":"test","module":"auth-routes","userId":"581598ab106798cc2d6782f172c264a3","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768709106842,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould filter sessions by current user only
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:74:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768709106847,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768709107067,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/ownershipAccess.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709107068,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/ownershipAccess.test.ts [2m([22m[2m19 tests[22m[2m | [22m[31m8 failed[39m[2m)[22m[33m 9748[2mms[22m[39m
       [32mâœ“[39m should allow access to user-owned asset by owner[32m 287[2mms[22m[39m
       [32mâœ“[39m should deny access to user-owned asset by non-owner[32m 284[2mms[22m[39m
[31m       [31mÃ—[31m should allow access to org-owned asset by org member[39m[33m 382[2mms[22m[39m
       [33m[2mâœ“[22m[39m should deny access to org-owned asset by non-member [33m 332[2mms[22m[39m
       [33m[2mâœ“[22m[39m should allow access to null ownership (legacy data) [33m 562[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return true for org member [33m 365[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return false for non-member [33m 320[2mms[22m[39m
[31m       [31mÃ—[31m should return true for org admin[39m[33m 368[2mms[22m[39m
[31m       [31mÃ—[31m should return true for org admin[39m[33m 645[2mms[22m[39m
[31m       [31mÃ—[31m should return false for org member (non-admin)[39m[33m 650[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return false for non-member [33m 317[2mms[22m[39m
[31m       [31mÃ—[31m should return all org IDs for a user[39m[33m 647[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return empty array for user with no memberships [33m 329[2mms[22m[39m
       [32mâœ“[39m should allow creating user-owned asset if ownerUuid matches userId[32m 276[2mms[22m[39m
       [32mâœ“[39m should deny creating user-owned asset if ownerUuid does not match userId[32m 281[2mms[22m[39m
[31m       [31mÃ—[31m should allow creating org-owned asset if user is member[39m[33m 413[2mms[22m[39m
       [33m[2mâœ“[22m[39m should deny creating org-owned asset if user is not member [33m 318[2mms[22m[39m
[31m       [31mÃ—[31m should not allow member of org1 to access org2-owned assets[39m[33m 661[2mms[22m[39m
[31m       [31mÃ—[31m should allow member of multiple orgs to access all their org assets[39m[33m 441[2mms[22m[39m
[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w3_v3, public
âœ… Enforced search_path: test_schema_w3_v3, public

[90mstderr[2m | tests/integration/api.workflows.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/api.workflows.test.ts[2m > [22m[2mWorkflows API Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/api.workflows.test.ts[2m > [22m[2mWorkflows API Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768709107287,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768709107306,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.workflows.test.ts[2m > [22m[2mWorkflows API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768709107295,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768709107296,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768709107300,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768709107301,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768709107305,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768709107305,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768709107305,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768709107305,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

{"level":50,"time":1768709107442,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["6e752e21-7906-42bf-9f6d-89cebd3c93ed","$2b$12$DKrPgRmJ8aDLKoWty4lCnuYfVL3reNWUBAXFhFDfu/slxYTeUS3j."],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(6e752e21-7906-42bf-9f6d-89cebd3c93ed) is not present in table \"users\".","schema":"test_schema_w7_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"6e752e21-7906-42bf-9f6d-89cebd3c93ed","msg":"Failed to create user credentials"}
{"level":50,"time":1768709107442,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["6e752e21-7906-42bf-9f6d-89cebd3c93ed","$2b$12$DKrPgRmJ8aDLKoWty4lCnuYfVL3reNWUBAXFhFDfu/slxYTeUS3j."],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(6e752e21-7906-42bf-9f6d-89cebd3c93ed) is not present in table \"users\".","schema":"test_schema_w7_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mDatabase Transfer[2m > [22m[2mshould allow org member to transfer org database
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,192db163-90d0-4e6b-b507-c5bb5e3fc613,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'192db163-90d0-4e6b-b507-c5bb5e3fc613'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m522[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (9e8b551c-7023-4986-a3a6-2e9ad6126992, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 192db163-90d0-4e6b-b507-c5bb5e3fc613, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 04:05:08.623832, 2026-01-18 04:05:08.623832).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w0_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

{"level":50,"time":1768709107785,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["c6a763e1-5b07-4e0d-aa23-9455e89b608f","$2b$12$sCH0S395ZmTxBBWf.ODvFusyRpprQlfJjA4ymb4eynfYt2D2dbUSi"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(c6a763e1-5b07-4e0d-aa23-9455e89b608f) is not present in table \"users\".","schema":"test_schema_w9_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"c6a763e1-5b07-4e0d-aa23-9455e89b608f","msg":"Failed to create user credentials"}
{"level":50,"time":1768709107785,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["c6a763e1-5b07-4e0d-aa23-9455e89b608f","$2b$12$sCH0S395ZmTxBBWf.ODvFusyRpprQlfJjA4ymb4eynfYt2D2dbUSi"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(c6a763e1-5b07-4e0d-aa23-9455e89b608f) is not present in table \"users\".","schema":"test_schema_w9_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/api.workflows.test.ts[2m > [22m[2mWorkflows API Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at Module.setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/api.workflows.test.ts:42:11

[90mstdout[2m | tests/integration/api.workflows.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709107796,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709107797,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768709107835,"env":"test","module":"auth-routes","email":"test-1768709106802-s9ty6s@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":30,"time":1768709107937,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":50,"time":1768709107974,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 403 for unverified email
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

 [31mâ¯[39m tests/integration/api.workflows.test.ts [2m([22m[2m17 tests[22m[2m | [22m[33m17 skipped[39m[2m)[22m[33m 2292[2mms[22m[39m
       [2m[90mâ†“[39m[22m should create a new draft workflow
       [2m[90mâ†“[39m[22m should reject without permission
       [2m[90mâ†“[39m[22m should list workflows
       [2m[90mâ†“[39m[22m should filter by status
       [2m[90mâ†“[39m[22m should search by name
       [2m[90mâ†“[39m[22m should update draft workflow
       [2m[90mâ†“[39m[22m should not allow editing published workflow
       [2m[90mâ†“[39m[22m should publish workflow
       [2m[90mâ†“[39m[22m should list workflow versions
       [2m[90mâ†“[39m[22m should move workflow to a project
       [2m[90mâ†“[39m[22m should move workflow to Main Folder (projectId = null)
       [2m[90mâ†“[39m[22m should reject move to non-existent project
       [2m[90mâ†“[39m[22m should reject move without authentication
       [2m[90mâ†“[39m[22m should reject move of workflow user does not own
       [2m[90mâ†“[39m[22m should reject move with invalid projectId format
       [2m[90mâ†“[39m[22m should reject move without projectId in body
       [2m[90mâ†“[39m[22m should reject move to project user does not have access to
[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject expired invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,1f262830-bf74-4df8-97b2-bef17465d5a4,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'1f262830-bf74-4df8-97b2-bef17465d5a4'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m520[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (ced3902a-d4a5-4351-b9ad-0ac8dfacb0a4, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, 1f262830-bf74-4df8-97b2-bef17465d5a4, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-18 04:05:09.327885, 2026-01-18 04:05:09.327885).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w0_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":50,"time":1768709108323,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w15_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w15_v3 (Reused: true)

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w16_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w16_v3 (Reused: true)

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mDatabase Transfer[2m > [22m[2mshould prevent transfer to org if user is not a member
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,9e849f61-9b79-4357-8f9e-d8519041fcf2,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'9e849f61-9b79-4357-8f9e-d8519041fcf2'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m523[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (6256c3e8-c700-4157-b481-458a744d51a6, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 9e849f61-9b79-4357-8f9e-d8519041fcf2, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 04:05:09.597921, 2026-01-18 04:05:09.597921).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w10_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mðŸ“Š Schema test_schema_w15_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709108846,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709108846,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w15_v3\",public"}
{"level":30,"time":1768709108883,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w15_v3\",public"}
{"level":30,"time":1768709108883,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mðŸ“Š Schema test_schema_w16_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709108955,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709108956,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w16_v3\",public"}
{"level":30,"time":1768709108989,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w16_v3\",public"}
{"level":30,"time":1768709108989,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768709109536,"env":"test","module":"auth-routes","email":"test-1768709109132-ogcj8@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768709109573,"env":"test","module":"auth-routes","email":"test-1768709109158-bxykq@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768709109630,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould login with valid backup code
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768709109635,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768709109663,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking current session
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w17_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w17_v3 (Reused: true)

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mTransfer Validation[2m > [22m[2mshould only allow transfer to self when targetOwnerType is user
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,1caab156-da14-44a1-bc8a-ab8c22cc5c9d,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'1caab156-da14-44a1-bc8a-ab8c22cc5c9d'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m523[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (33ec260a-adf7-4871-93c4-de29b10c9620, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, 1caab156-da14-44a1-bc8a-ab8c22cc5c9d, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 04:05:10.845975, 2026-01-18 04:05:10.845975).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w11_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mðŸ“Š Schema test_schema_w17_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709110225,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709110226,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w17_v3\",public"}
{"level":30,"time":1768709110270,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w17_v3\",public"}
{"level":30,"time":1768709110270,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w16_v3, public
âœ… Enforced search_path: test_schema_w16_v3, public

[90mstderr[2m | tests/integration/organizationService.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/integration/transferOwnership.test.ts[2m > [22m[2mTransfer Ownership[2m > [22m[2mTransfer Validation[2m > [22m[2mshould allow transfer from user to self (org member transferring org asset to themselves)
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000031,organization.create,organization,cd0d56c8-15a4-4f26-b1d1-42bf8367aa8e,{"after":{"name":"Transfer Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000031'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'cd0d56c8-15a4-4f26-b1d1-42bf8367aa8e'[39m,
    [32m'{"after":{"name":"Transfer Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/transferOwnership.test.ts:57:21 {
    length: [33m522[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (29eb1dee-7f97-48e5-ae4c-f367e618febd, null, null, 00000000-0000-0000-0000-000000000031, organization.create, null, null, organization, cd0d56c8-15a4-4f26-b1d1-42bf8367aa8e, {"after": {"name": "Transfer Test Org", "slug": null}}, null, null, null, 2026-01-18 04:05:11.800505, 2026-01-18 04:05:11.800505).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w1_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":30,"time":1768709110948,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine/templateNode.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709110948,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768709110974,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/transferOwnership.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709110975,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/unit/engine/templateNode.test.ts [2m([22m[2m17 tests[22m[2m | [22m[31m17 failed[39m[2m)[22m[33m 12983[2mms[22m[39m
[31m       [31mÃ—[31m should resolve template by key from workflowTemplates mapping[39m[33m 612[2mms[22m[39m
[31m       [31mÃ—[31m should throw error if template key not found[39m[33m 606[2mms[22m[39m
[31m       [31mÃ—[31m should store output in runOutputs table[39m[33m 668[2mms[22m[39m
[31m       [31mÃ—[31m should resolve template by templateId directly[39m[33m 698[2mms[22m[39m
[31m       [31mÃ—[31m should throw error if templateId not found[39m[33m 599[2mms[22m[39m
[31m       [31mÃ—[31m should use docxRenderer2 by default (v2 engine)[39m[33m 598[2mms[22m[39m
[31m       [31mÃ—[31m should use legacy engine when engine="legacy"[39m[33m 651[2mms[22m[39m
[31m       [31mÃ—[31m should generate PDF when toPdf=true[39m[33m 615[2mms[22m[39m
[31m       [31mÃ—[31m should default to DOCX when toPdf=false[39m[33m 648[2mms[22m[39m
[31m       [31mÃ—[31m should skip execution when condition evaluates to false[39m[33m 612[2mms[22m[39m
[31m       [31mÃ—[31m should execute when condition evaluates to true[39m[33m 639[2mms[22m[39m
[31m       [31mÃ—[31m should resolve simple bindings[39m[33m 882[2mms[22m[39m
[31m       [31mÃ—[31m should handle binding resolution errors gracefully[39m[33m 618[2mms[22m[39m
[31m       [31mÃ—[31m should record failed output in runOutputs table[39m[33m 640[2mms[22m[39m
[31m       [31mÃ—[31m should not throw errors (should return error in result)[39m[33m 872[2mms[22m[39m
[31m       [31mÃ—[31m should deny access to templates from different tenant[39m[33m 601[2mms[22m[39m
[31m       [31mÃ—[31m should require either templateKey or templateId[39m[33m 630[2mms[22m[39m
 [31mâ¯[39m tests/integration/transferOwnership.test.ts [2m([22m[2m11 tests[22m[2m | [22m[31m11 failed[39m[2m)[22m[33m 12950[2mms[22m[39m
[31m       [31mÃ—[31m should transfer user-owned project to org[39m[33m 1016[2mms[22m[39m
[31m       [31mÃ—[31m should prevent transfer to org if user is not a member[39m[33m 1028[2mms[22m[39m
[31m       [31mÃ—[31m should allow org member to transfer org-owned project to another org they belong to[39m[33m 998[2mms[22m[39m
[31m       [31mÃ—[31m should detach workflow from project when transferring to different owner[39m[33m 979[2mms[22m[39m
[31m       [31mÃ—[31m should keep workflow in project when transferring to same owner[39m[33m 978[2mms[22m[39m
[31m       [31mÃ—[31m should prevent non-member from transferring org workflow[39m[33m 989[2mms[22m[39m
[31m       [31mÃ—[31m should transfer database ownership[39m[33m 979[2mms[22m[39m
[31m       [31mÃ—[31m should allow org member to transfer org database[39m[33m 965[2mms[22m[39m
[31m       [31mÃ—[31m should prevent transfer to org if user is not a member[39m[33m 983[2mms[22m[39m
[31m       [31mÃ—[31m should only allow transfer to self when targetOwnerType is user[39m[33m 1241[2mms[22m[39m
[31m       [31mÃ—[31m should allow transfer from user to self (org member transferring org asset to themselves)[39m[33m 956[2mms[22m[39m
{"level":50,"time":1768709111178,"env":"test","module":"auth-routes","email":"test-1768709110771-l6u1zi@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w15_v3, public
âœ… Enforced search_path: test_schema_w15_v3, public

{"level":50,"time":1768709111266,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/logout[2m > [22m[2mshould logout and clear refresh token cookie
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstderr[2m | tests/integration/auth.flows.real.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2macceptInvite[2m > [22m[2mshould reject invalid token
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,f85e0bff-2291-4db5-b545-e3a09c9eac7d,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'f85e0bff-2291-4db5-b545-e3a09c9eac7d'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m521[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (a35afc6d-b02c-4679-8d0a-921f3e0da05f, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, f85e0bff-2291-4db5-b545-e3a09c9eac7d, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-18 04:05:12.416648, 2026-01-18 04:05:12.416648).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w15_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":50,"time":1768709111471,"env":"test","module":"auth-routes","email":"test-1768709111028-jccuw2@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768709111597,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/mfa.flow.real.test.ts[2m > [22m[2mMFA Flow Integration Tests (REAL)[2m > [22m[2mBackup Code Flow[2m > [22m[2mshould prevent backup code reuse
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768709111601,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

{"level":50,"time":1768709111811,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["ac4735d6-72cf-4f9c-9fc0-9d0939f139ff","$2b$12$UFyUezoRZnL6t6EKknunm.9rRNhDiS750KLACQHWJxNmRczk3hXJW"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(ac4735d6-72cf-4f9c-9fc0-9d0939f139ff) is not present in table \"users\".","schema":"test_schema_w5_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"ac4735d6-72cf-4f9c-9fc0-9d0939f139ff","msg":"Failed to create user credentials"}
{"level":50,"time":1768709111811,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["ac4735d6-72cf-4f9c-9fc0-9d0939f139ff","$2b$12$UFyUezoRZnL6t6EKknunm.9rRNhDiS750KLACQHWJxNmRczk3hXJW"],"cause":{"length":346,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(ac4735d6-72cf-4f9c-9fc0-9d0939f139ff) is not present in table \"users\".","schema":"test_schema_w5_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/PdfQueueService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [31mâ¯[39m tests/unit/services/PdfQueueService.test.ts [2m([22m[2m15 tests[22m[2m | [22m[31m15 failed[39m[2m)[22m[33m 14317[2mms[22m[39m
[31m       [31mÃ—[31m should enqueue a PDF conversion job[39m[33m 794[2mms[22m[39m
[31m       [31mÃ—[31m should create output with empty storagePath initially[39m[33m 802[2mms[22m[39m
[31m       [31mÃ—[31m should return job status for pending job[39m[33m 795[2mms[22m[39m
[31m       [31mÃ—[31m should return null for non-existent job[39m[33m 852[2mms[22m[39m
[31m       [31mÃ—[31m should parse attempt count from error field[39m[33m 783[2mms[22m[39m
[31m       [31mÃ—[31m should convert DOCX to PDF immediately[39m[33m 833[2mms[22m[39m
[31m       [31mÃ—[31m should handle conversion errors gracefully[39m[33m 789[2mms[22m[39m
[31m       [31mÃ—[31m should start and stop service[39m[33m 799[2mms[22m[39m
[31m       [31mÃ—[31m should not start if already running[39m[33m 818[2mms[22m[39m
[31m       [31mÃ—[31m should handle stop when not running[39m[33m 860[2mms[22m[39m
[31m       [31mÃ—[31m should process pending jobs when queue is processed[39m[33m 912[2mms[22m[39m
[31m       [31mÃ—[31m should process multiple jobs in batch[39m[33m 804[2mms[22m[39m
[31m       [31mÃ—[31m should handle missing DOCX output gracefully[39m[33m 1021[2mms[22m[39m
[31m       [31mÃ—[31m should support enqueue within transaction[39m[33m 790[2mms[22m[39m
[31m       [31mÃ—[31m should support convertImmediate within transaction[39m[33m 813[2mms[22m[39m
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

{"level":30,"time":1768709112048,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709112049,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

 [31mâ¯[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m13 failed[39m[2m)[22m[33m 12258[2mms[22m[39m
[31m       [31mÃ—[31m should trust current device[39m[33m 496[2mms[22m[39m
[31m       [31mÃ—[31m should set trust expiry to 30 days[39m[33m 751[2mms[22m[39m
[31m       [31mÃ—[31m should update expiry if device already trusted[39m[33m 733[2mms[22m[39m
       [33m[2mâœ“[22m[39m should require authentication [33m 442[2mms[22m[39m
[31m       [31mÃ—[31m should list all trusted devices[39m[33m 409[2mms[22m[39m
[31m       [31mÃ—[31m should mark current device[39m[33m 733[2mms[22m[39m
[31m       [31mÃ—[31m should exclude revoked devices[39m[33m 738[2mms[22m[39m
[31m       [31mÃ—[31m should exclude expired devices[39m[33m 727[2mms[22m[39m
[31m       [31mÃ—[31m should revoke specific device[39m[33m 744[2mms[22m[39m
[31m       [31mÃ—[31m should return 404 for non-existent device[39m[33m 745[2mms[22m[39m
[31m       [31mÃ—[31m should prevent revoking other user's device[39m[33m 764[2mms[22m[39m
[31m       [31mÃ—[31m should skip MFA for trusted device[39m[33m 841[2mms[22m[39m
[31m       [31mÃ—[31m should require MFA for untrusted device[39m[33m 1019[2mms[22m[39m
[31m       [31mÃ—[31m should update lastUsedAt on trusted device login[39m[33m 1236[2mms[22m[39m
{"level":50,"time":1768709112332,"env":"test","module":"auth-routes","email":"test-1768709111919-vhn5qd@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mgetUserOrganizations[2m > [22m[2mshould return empty array for user with no memberships
[22m[39mCRITICAL: User lookup failed validation in beforeEach: [90mundefined[39m

{"level":50,"time":1768709112425,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/refresh-token[2m > [22m[2mshould refresh access token with valid refresh token
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w17_v3, public
âœ… Enforced search_path: test_schema_w17_v3, public

[90mstderr[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":50,"time":1768709112675,"env":"test","module":"auth-routes","email":"test-1768709112251-4m1mj@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w19_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":50,"time":1768709112772,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w19_v3 (Reused: true)

{"level":50,"time":1768709112830,"env":"test","module":"auth-routes","email":"test-1768709112251-4m1mj@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768709112923,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768709112981,"env":"test","module":"auth-routes","email":"test-1768709112251-4m1mj@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

{"level":50,"time":1768709113079,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":30,"time":1768709113094,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/WorkflowTemplateService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709113094,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

 [31mâ¯[39m tests/unit/services/WorkflowTemplateService.test.ts [2m([22m[2m21 tests[22m[2m | [22m[31m21 failed[39m[2m)[22m[33m 15586[2mms[22m[39m
[31m       [31mÃ—[31m should throw error if template belongs to different project[39m[33m 661[2mms[22m[39m
[31m       [31mÃ—[31m should automatically unset other primaries when setting new primary[39m[33m 725[2mms[22m[39m
[31m         [31mÃ—[31m should list all templates for workflow version[39m[33m 601[2mms[22m[39m
[31m         [31mÃ—[31m should return empty array for version with no templates[39m[33m 620[2mms[22m[39m
[31m         [31mÃ—[31m should get template mapping by id and version[39m[33m 605[2mms[22m[39m
[31m         [31mÃ—[31m should throw error if mapping not found[39m[33m 614[2mms[22m[39m
[31m         [31mÃ—[31m should get template by key[39m[33m 589[2mms[22m[39m
[31m         [31mÃ—[31m should throw error if key not found[39m[33m 592[2mms[22m[39m
[31m         [31mÃ—[31m should get primary template for workflow version[39m[33m 651[2mms[22m[39m
[31m         [31mÃ—[31m should return null when no primary template exists[39m[33m 643[2mms[22m[39m
[31m         [31mÃ—[31m should update mapping key[39m[33m 618[2mms[22m[39m
[31m         [31mÃ—[31m should update isPrimary flag[39m[33m 612[2mms[22m[39m
[31m         [31mÃ—[31m should throw error if new key already exists[39m[33m 633[2mms[22m[39m
[31m         [31mÃ—[31m should throw error if mapping not found[39m[33m 603[2mms[22m[39m
[31m         [31mÃ—[31m should unset other primaries when setting isPrimary to true[39m[33m 589[2mms[22m[39m
[31m         [31mÃ—[31m should detach template from workflow version[39m[33m 615[2mms[22m[39m
[31m         [31mÃ—[31m should throw error if mapping not found[39m[33m 606[2mms[22m[39m
[31m         [31mÃ—[31m should set template as primary[39m[33m 655[2mms[22m[39m
[31m         [31mÃ—[31m should throw error if mapping not found[39m[33m 1208[2mms[22m[39m
[31m         [31mÃ—[31m should support operations within a transaction[39m[33m 652[2mms[22m[39m
[31m         [31mÃ—[31m should rollback on transaction error[39m[33m 640[2mms[22m[39m
{"level":50,"time":1768709113131,"env":"test","module":"auth-routes","email":"test-1768709112251-4m1mj@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w18_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mðŸ“Š Schema test_schema_w19_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709113212,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709113213,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w19_v3\",public"}
{"level":50,"time":1768709113218,"env":"test","module":"auth","err":{"type":"Error","message":"User not found after upsert","stack":"Error: User not found after upsert\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:162:27\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google authentication failed"}
{"level":50,"time":1768709113228,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w18_v3 (Reused: true)

{"level":30,"time":1768709113257,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w19_v3\",public"}
{"level":30,"time":1768709113257,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768709113285,"env":"test","module":"auth-routes","email":"test-1768709112251-4m1mj@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768709113414,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstderr[2m | tests/integration/organizationInvites.test.ts[2m > [22m[2mOrganization Invites[2m > [22m[2mgetPendingInvitesForUser[2m > [22m[2mshould not return expired invites
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,00000000-0000-0000-0000-000000000021,organization.create,organization,0841248e-021b-4d11-9342-cac8cc05fe3e,{"after":{"name":"Invite Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'00000000-0000-0000-0000-000000000021'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'0841248e-021b-4d11-9342-cac8cc05fe3e'[39m,
    [32m'{"after":{"name":"Invite Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizationInvites.test.ts:53:21 {
    length: [33m520[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (32cbc2eb-911b-4df6-97f0-654f883ef138, null, null, 00000000-0000-0000-0000-000000000021, organization.create, null, null, organization, 0841248e-021b-4d11-9342-cac8cc05fe3e, {"after": {"name": "Invite Test Org", "slug": null}}, null, null, null, 2026-01-18 04:05:14.446858, 2026-01-18 04:05:14.446858).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w6_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":50,"time":1768709113464,"env":"test","module":"auth-routes","email":"test-1768709112251-4m1mj@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

{"level":50,"time":1768709113593,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768709113657,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:168:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
{"level":50,"time":1768709113657,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:168:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google authentication failed"}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mðŸ“Š Schema test_schema_w18_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709113681,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709113682,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w18_v3\",public"}
{"level":30,"time":1768709113725,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w18_v3\",public"}
{"level":30,"time":1768709113725,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w20_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":40,"time":1768709113802,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768709113802,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:158:23"},"msg":"Google token verification failed"}
{"level":50,"time":1768709113802,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:158:23"},"msg":"Google authentication failed"}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w20_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w19_v3, public
âœ… Enforced search_path: test_schema_w19_v3, public

[90mstderr[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mðŸ“Š Schema test_schema_w20_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709114225,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709114226,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w20_v3\",public"}
{"level":30,"time":1768709114270,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w20_v3\",public"}
{"level":30,"time":1768709114270,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709114472,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/WorkflowTemplateRepository.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709114472,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/unit/repositories/WorkflowTemplateRepository.test.ts [2m([22m[2m19 tests[22m[2m | [22m[31m19 failed[39m[2m)[22m[33m 17028[2mms[22m[39m
[31m       [31mÃ—[31m should create a workflow template mapping[39m[33m 763[2mms[22m[39m
[31m       [31mÃ—[31m should create non-primary mapping by default[39m[33m 769[2mms[22m[39m
[31m       [31mÃ—[31m should find all templates for a workflow version[39m[33m 737[2mms[22m[39m
[31m       [31mÃ—[31m should return empty array for version with no templates[39m[33m 836[2mms[22m[39m
[31m       [31mÃ—[31m should order by createdAt desc (newest first)[39m[33m 771[2mms[22m[39m
[31m       [31mÃ—[31m should find mapping by workflow version and key[39m[33m 734[2mms[22m[39m
[31m       [31mÃ—[31m should return undefined for non-existent key[39m[33m 750[2mms[22m[39m
[31m       [31mÃ—[31m should find primary template for workflow version[39m[33m 771[2mms[22m[39m
[31m       [31mÃ—[31m should return undefined when no primary template exists[39m[33m 733[2mms[22m[39m
[31m       [31mÃ—[31m should set a template as primary and unset others[39m[33m 741[2mms[22m[39m
[31m       [31mÃ—[31m should handle setting primary when none existed before[39m[33m 892[2mms[22m[39m
[31m       [31mÃ—[31m should not delete mapping if workflow version does not match[39m[33m 749[2mms[22m[39m
[31m       [31mÃ—[31m should return true if key exists in workflow version[39m[33m 793[2mms[22m[39m
[31m       [31mÃ—[31m should return false if key does not exist[39m[33m 1317[2mms[22m[39m
[31m       [31mÃ—[31m should exclude specified id when checking existence[39m[33m 743[2mms[22m[39m
[31m       [31mÃ—[31m should return true if key exists on different mapping[39m[33m 740[2mms[22m[39m
[31m       [31mÃ—[31m should update mapping fields[39m[33m 778[2mms[22m[39m
[31m       [31mÃ—[31m should find mapping by id[39m[33m 852[2mms[22m[39m
[31m       [31mÃ—[31m should return undefined for non-existent id[39m[33m 767[2mms[22m[39m
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w21_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":50,"time":1768709114617,"env":"test","error":{},"msg":"Failed to create connection:"}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w21_v3 (Reused: true)

{"level":30,"time":1768709114783,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709114783,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768709114805,"env":"test","module":"auth","err":{"type":"Error","message":"User not found after upsert","stack":"Error: User not found after upsert\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:162:27\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google authentication failed"}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

 [31mâ¯[39m tests/integration/auth/oauth2.sessions.test.ts [2m([22m[2m25 tests[22m[2m | [22m[31m25 failed[39m[2m)[22m[33m 15004[2mms[22m[39m
[31m       [31mÃ—[31m should list all active sessions for current user[39m[32m 150[2mms[22m[39m
[31m       [31mÃ—[31m should mark current session as current[39m[33m 463[2mms[22m[39m
[31m       [31mÃ—[31m should return empty array when user has no active sessions[39m[33m 464[2mms[22m[39m
[31m       [31mÃ—[31m should not include expired sessions[39m[33m 461[2mms[22m[39m
[31m       [31mÃ—[31m should not include revoked sessions[39m[33m 470[2mms[22m[39m
[31m       [31mÃ—[31m should parse device name from user agent[39m[33m 467[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 for unauthenticated request[39m[33m 469[2mms[22m[39m
[31m       [31mÃ—[31m should revoke a specific session[39m[33m 779[2mms[22m[39m
[31m       [31mÃ—[31m should return 404 for non-existent session[39m[33m 484[2mms[22m[39m
[31m       [31mÃ—[31m should prevent revoking current session[39m[33m 468[2mms[22m[39m
[31m       [31mÃ—[31m should prevent revoking another user's session[39m[33m 469[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 for unauthenticated request[39m[33m 749[2mms[22m[39m
[31m       [31mÃ—[31m should revoke all sessions except current[39m[33m 464[2mms[22m[39m
[31m       [31mÃ—[31m should revoke all trusted devices[39m[33m 465[2mms[22m[39m
[31m       [31mÃ—[31m should return 400 when no active session found[39m[33m 461[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 for unauthenticated request[39m[33m 456[2mms[22m[39m
[31m         [31mÃ—[31m should mark current device as trusted[39m[33m 726[2mms[22m[39m
[31m         [31mÃ—[31m should update existing trusted device expiry[39m[33m 962[2mms[22m[39m
[31m         [31mÃ—[31m should list all trusted devices[39m[33m 468[2mms[22m[39m
[31m         [31mÃ—[31m should not include revoked devices[39m[33m 470[2mms[22m[39m
[31m         [31mÃ—[31m should revoke a trusted device[39m[33m 520[2mms[22m[39m
[31m         [31mÃ—[31m should return 404 for non-existent device[39m[33m 459[2mms[22m[39m
[31m       [31mÃ—[31m should track IP address for sessions[39m[33m 465[2mms[22m[39m
[31m       [31mÃ—[31m should track user agent for sessions[39m[33m 493[2mms[22m[39m
[31m       [31mÃ—[31m should update lastUsedAt on token refresh[39m[33m 737[2mms[22m[39m
{"level":50,"time":1768709114916,"env":"test","module":"auth-routes","email":"test-1768709114499-y4leyr@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w18_v3, public
âœ… Enforced search_path: test_schema_w18_v3, public

{"level":50,"time":1768709115041,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould return 400 if no active session found
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768709115049,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mðŸ“Š Schema test_schema_w21_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709115061,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709115062,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w21_v3\",public"}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w20_v3, public
âœ… Enforced search_path: test_schema_w20_v3, public

{"level":50,"time":1768709115088,"env":"test","module":"auth","err":{"type":"DrizzleQueryError","message":"Failed query: insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"\nparams: google-user-idtoken,idtoken@example.com,,,,c1fae634-e2d2-4ba9-8dde-980f91c89694,viewer,google,easy,true,,,,,2026-01-18T04:05:15.041Z: insert or update on table \"users\" violates foreign key constraint \"users_tenant_id_tenants_id_fk\"","stack":"Error: Failed query: insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"\nparams: google-user-idtoken,idtoken@example.com,,,,c1fae634-e2d2-4ba9-8dde-980f91c89694,viewer,google,easy,true,,,,,2026-01-18T04:05:15.041Z\n    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22\n    at UserRepository.upsert (C:/Users/scoot/poll/VaultLogic/server/repositories/UserRepository.ts:72:22)\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:69:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7\ncaused by: error: insert or update on table \"users\" violates foreign key constraint \"users_tenant_id_tenants_id_fk\"\n    at C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\pg-pool\\index.js:45:11\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18\n    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22\n    at UserRepository.upsert (C:/Users/scoot/poll/VaultLogic/server/repositories/UserRepository.ts:72:22)\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:69:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7","query":"insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"","params":["google-user-idtoken","idtoken@example.com",null,null,null,"c1fae634-e2d2-4ba9-8dde-980f91c89694","viewer","google","easy",true,null,null,null,null,"2026-01-18T04:05:15.041Z"]},"userId":"google-user-idtoken","msg":"Failed to upsert user during authentication"}
{"level":50,"time":1768709115090,"env":"test","module":"auth","err":{"type":"Error","message":"Failed to create or update user account","stack":"Error: Failed to create or update user account\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:73:11)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"msg":"Google authentication failed"}
{"level":30,"time":1768709115104,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w21_v3\",public"}
{"level":30,"time":1768709115104,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/integration/analytics_service.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/integration/variableSafety.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

{"level":50,"time":1768709115427,"env":"test","module":"auth-routes","email":"test-1768709114993-4g4xjr@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w22_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w22_v3 (Reused: true)

{"level":50,"time":1768709115573,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould complete MFA setup and login with TOTP
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768709115579,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768709115782,"env":"test","msg":"EXECUTE: Failed to set search_path: Failed query: ALTER TABLE \"workflow_run_events\" ADD CONSTRAINT \"workflow_run_events_run_id_workflow_runs_id_fk\" FOREIGN KEY (\"run_id\") REFERENCES \"workflow_runs\"(\"id\") ON DELETE CASCADE\nparams: "}
{"level":30,"time":1768709115834,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709115834,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768709115857,"env":"test","module":"auth","err":{"type":"DrizzleQueryError","message":"Failed query: insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"\nparams: google-user-minimal,minimal@example.com,,,,521589a4-4716-4f42-a158-d3dad3f33128,viewer,google,easy,true,,,,,2026-01-18T04:05:15.809Z: insert or update on table \"users\" violates foreign key constraint \"users_tenant_id_tenants_id_fk\"","stack":"Error: Failed query: insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"\nparams: google-user-minimal,minimal@example.com,,,,521589a4-4716-4f42-a158-d3dad3f33128,viewer,google,easy,true,,,,,2026-01-18T04:05:15.809Z\n    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:41:15)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22\n    at UserRepository.upsert (C:/Users/scoot/poll/VaultLogic/server/repositories/UserRepository.ts:72:22)\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:69:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7\ncaused by: error: insert or update on table \"users\" violates foreign key constraint \"users_tenant_id_tenants_id_fk\"\n    at C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\pg-pool\\index.js:45:11\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:124:18\n    at NodePgPreparedQuery.queryWithCache (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/session.js:39:16)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:117:22\n    at UserRepository.upsert (C:/Users/scoot/poll/VaultLogic/server/repositories/UserRepository.ts:72:22)\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:69:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7","query":"insert into \"users\" (\"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\") values ($1, $2, default, $3, $4, $5, $6, default, $7, $8, $9, $10, default, $11, default, default, default, default) on conflict (\"id\") do update set \"first_name\" = $12, \"last_name\" = $13, \"profile_image_url\" = $14, \"updated_at\" = $15 returning \"id\", \"email\", \"full_name\", \"first_name\", \"last_name\", \"profile_image_url\", \"tenant_id\", \"role\", \"tenant_role\", \"auth_provider\", \"default_mode\", \"email_verified\", \"mfa_enabled\", \"last_password_change\", \"is_placeholder\", \"placeholder_email\", \"created_at\", \"updated_at\"","params":["google-user-minimal","minimal@example.com",null,null,null,"521589a4-4716-4f42-a158-d3dad3f33128","viewer","google","easy",true,null,null,null,null,"2026-01-18T04:05:15.809Z"]},"userId":"google-user-minimal","msg":"Failed to upsert user during authentication"}
{"level":50,"time":1768709115857,"env":"test","module":"auth","err":{"type":"Error","message":"Failed to create or update user account","stack":"Error: Failed to create or update user account\n    at upsertUser (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:73:11)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:159:7"},"msg":"Google authentication failed"}
{"level":30,"time":1768709115880,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizationInvites.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709115880,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mðŸ“Š Schema test_schema_w22_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

 [31mâ¯[39m tests/integration/auth/oauth2.token-refresh.test.ts [2m([22m[2m25 tests[22m[2m | [22m[31m25 failed[39m[2m)[22m[33m 16059[2mms[22m[39m
[31m       [31mÃ—[31m should refresh access token with valid refresh token[39m[32m 145[2mms[22m[39m
[31m       [31mÃ—[31m should rotate refresh token after use[39m[33m 464[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 when refresh token is missing[39m[33m 472[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 for invalid refresh token[39m[33m 464[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 for expired refresh token[39m[33m 454[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 for revoked refresh token[39m[33m 478[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 when user is not found[39m[33m 463[2mms[22m[39m
[31m       [31mÃ—[31m should update refresh token metadata on rotation[39m[33m 452[2mms[22m[39m
[31m       [31mÃ—[31m should handle concurrent refresh token requests (token reuse detection)[39m[33m 489[2mms[22m[39m
[31m       [31mÃ—[31m should set secure cookie in production[39m[33m 744[2mms[22m[39m
[31m       [31mÃ—[31m should set proper cookie attributes[39m[33m 453[2mms[22m[39m
[31m       [31mÃ—[31m should include user role information in response[39m[33m 465[2mms[22m[39m
[31m       [31mÃ—[31m should create refresh token on login[39m[33m 463[2mms[22m[39m
[31m       [31mÃ—[31m should revoke refresh token on logout[39m[33m 471[2mms[22m[39m
[31m       [31mÃ—[31m should handle logout without refresh token gracefully[39m[33m 460[2mms[22m[39m
[31m       [31mÃ—[31m should support multiple active refresh tokens per user[39m[33m 474[2mms[22m[39m
[31m       [31mÃ—[31m should revoke all user tokens on password reset[39m[33m 473[2mms[22m[39m
[31m       [31mÃ—[31m should use cryptographically strong random tokens[39m[33m 478[2mms[22m[39m
[31m       [31mÃ—[31m should hash refresh tokens before storing in database[39m[33m 728[2mms[22m[39m
[31m       [31mÃ—[31m should prevent refresh token reuse after rotation[39m[33m 757[2mms[22m[39m
[31m       [31mÃ—[31m should validate token ownership[39m[33m 472[2mms[22m[39m
[31m       [31mÃ—[31m should set HttpOnly flag to prevent XSS[39m[33m 475[2mms[22m[39m
[31m       [31mÃ—[31m should set SameSite=Strict to prevent CSRF[39m[33m 477[2mms[22m[39m
[31m       [31mÃ—[31m should set proper cookie path[39m[33m 469[2mms[22m[39m
[31m       [31mÃ—[31m should set appropriate expiry (30 days)[39m[33m 454[2mms[22m[39m
 [31mâ¯[39m tests/integration/organizationInvites.test.ts [2m([22m[2m17 tests[22m[2m | [22m[31m15 failed[39m[2m)[22m[33m 18235[2mms[22m[39m
[31m       [31mÃ—[31m should create placeholder user for non-existent email[39m[33m 672[2mms[22m[39m
[31m       [31mÃ—[31m should create invite for existing user without creating placeholder[39m[33m 1249[2mms[22m[39m
[31m       [31mÃ—[31m should prevent duplicate pending invites[39m[33m 505[2mms[22m[39m
[31m       [31mÃ—[31m should prevent inviting existing members[39m[33m 1176[2mms[22m[39m
       [33m[2mâœ“[22m[39m should require admin access to create invite [33m 1174[2mms[22m[39m
[31m       [31mÃ—[31m should set expiry to 7 days from now[39m[33m 1180[2mms[22m[39m
[31m       [31mÃ—[31m should accept invite and create membership[39m[33m 1147[2mms[22m[39m
[31m       [31mÃ—[31m should convert placeholder user to real user on accept[39m[33m 825[2mms[22m[39m
[31m       [31mÃ—[31m should reject expired invite[39m[33m 1207[2mms[22m[39m
[31m       [31mÃ—[31m should reject already accepted invite[39m[33m 1086[2mms[22m[39m
[31m       [31mÃ—[31m should verify email matches invite[39m[33m 530[2mms[22m[39m
       [33m[2mâœ“[22m[39m should reject invalid token [33m 1487[2mms[22m[39m
[31m       [31mÃ—[31m should return pending invites for user email[39m[33m 835[2mms[22m[39m
[31m       [31mÃ—[31m should not return expired invites[39m[33m 1175[2mms[22m[39m
[31m       [31mÃ—[31m should not return accepted invites[39m[33m 807[2mms[22m[39m
[31m       [31mÃ—[31m should allow admin to revoke invite[39m[33m 811[2mms[22m[39m
[31m       [31mÃ—[31m should prevent accepting revoked invite[39m[33m 550[2mms[22m[39m
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w21_v3, public
âœ… Enforced search_path: test_schema_w21_v3, public

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstderr[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w23_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstderr[2m | tests/integration/analytics_service.test.ts[2m > [22m[2mAnalytics Service Integration
[22m[39mMANUAL PATCH FAILED DrizzleQueryError: Failed query: ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "workflow_runs"("id") ON DELETE CASCADE
params: 
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at Proxy.rawDb.execute (C:/Users/scoot/poll/VaultLogic/server/db.ts:128:18)
    at C:/Users/scoot/poll/VaultLogic/tests/integration/analytics_service.test.ts:23:13 {
  query: [32m'ALTER TABLE "workflow_run_events" ADD CONSTRAINT "workflow_run_events_run_id_workflow_runs_id_fk" FOREIGN KEY ("run_id") REFERENCES "workflow_runs"("id") ON DELETE CASCADE'[39m,
  params: [],
  cause: error: constraint "workflow_run_events_run_id_workflow_runs_id_fk" for relation "workflow_run_events" already exists
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at Proxy.rawDb.execute (C:/Users/scoot/poll/VaultLogic/server/db.ts:128:18)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/analytics_service.test.ts:23:13 {
    length: [33m177[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42710'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'tablecmds.c'[39m,
    line: [32m'9387'[39m,
    routine: [32m'ATExecAddConstraint'[39m
  }
}

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w23_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

{"level":50,"time":1768709116431,"env":"test","error":{},"msg":"Failed to create connection:"}
{"level":50,"time":1768709116449,"env":"test","module":"auth","err":{"type":"Error","message":"Token verification failed","stack":"Error: Token verification failed\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:431:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709116569,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709116570,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w22_v3\",public"}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mðŸ“Š Schema test_schema_w23_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709116576,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709116577,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w23_v3\",public"}
{"level":40,"time":1768709116593,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768709116593,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:92:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
{"level":30,"time":1768709116597,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/analytics_service.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709116597,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768709116614,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w22_v3\",public"}
{"level":30,"time":1768709116614,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709116619,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w23_v3\",public"}
{"level":30,"time":1768709116619,"env":"test","msg":"DB: initialized flag set."}
 [31mâ¯[39m tests/integration/analytics_service.test.ts [2m([22m[2m1 test[22m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 3770[2mms[22m[39m
     [2m[90mâ†“[39m[22m should generate events and metrics on run completion
{"level":50,"time":1768709116728,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token payload","stack":"Error: Invalid token payload\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:88:26)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
{"level":30,"time":1768709116740,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/workflows/runtime-pipelines.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709116740,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768709116773,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709116773,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/workflows/runtime-pipelines.test.ts [2m([22m[2m4 tests[22m[2m | [22m[33m4 skipped[39m[2m)[22m[33m 2514[2mms[22m[39m
       [2m[90mâ†“[39m[22m should create DataVault row on workflow completion
       [2m[90mâ†“[39m[22m should execute writebacks via RunService.completeRun()
       [2m[90mâ†“[39m[22m should skip document generation when visibleIf condition is false
       [2m[90mâ†“[39m[22m should generate document when visibleIf condition is true
 [31mâ¯[39m tests/integration/auth/oauth2.google.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m5 failed[39m[2m)[22m[33m 7410[2mms[22m[39m
[31m       [31mÃ—[31m should successfully authenticate with valid Google ID token[39m[33m 481[2mms[22m[39m
       [32mâœ“[39m should return 400 when ID token is missing[32m 141[2mms[22m[39m
       [32mâœ“[39m should return 403 when Origin header is invalid[32m 140[2mms[22m[39m
       [32mâœ“[39m should return 401 when Google token verification fails[32m 144[2mms[22m[39m
       [32mâœ“[39m should return 401 when email is not verified by Google[32m 145[2mms[22m[39m
[31m       [31mÃ—[31m should update existing user on subsequent logins[39m[32m 233[2mms[22m[39m
[31m       [31mÃ—[31m should create refresh token record in database[39m[33m 772[2mms[22m[39m
[31m       [31mÃ—[31m should support both "token" and "idToken" fields[39m[32m 284[2mms[22m[39m
       [33m[2mâœ“[22m[39m should respect rate limiting [33m 484[2mms[22m[39m
[31m       [31mÃ—[31m should handle missing profile information gracefully[39m[32m 283[2mms[22m[39m
       [33m[2mâœ“[22m[39m should verify valid Google ID token [33m 458[2mms[22m[39m
       [32mâœ“[39m should throw error when token verification fails[32m 132[2mms[22m[39m
       [32mâœ“[39m should throw error when email is not verified[32m 143[2mms[22m[39m
       [32mâœ“[39m should throw error when payload is null[32m 135[2mms[22m[39m
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

{"level":50,"time":1768709116910,"env":"test","module":"auth-routes","email":"test-1768709116493-myc13@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
[90mstderr[2m | tests/integration/organizationService.test.ts[2m > [22m[2mOrganizationService Integration[2m > [22m[2mremoveMember[2m > [22m[2mshould prevent self-removal
[22m[39mCRITICAL: User lookup failed validation in beforeEach: [90mundefined[39m

{"level":50,"time":1768709117034,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould handle user with single session gracefully
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w22_v3, public
âœ… Enforced search_path: test_schema_w22_v3, public

[90mstderr[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w23_v3, public
âœ… Enforced search_path: test_schema_w23_v3, public

[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

{"level":30,"time":1768709117645,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/variableSafety.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709117645,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/integration/externalSends.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

 [31mâ¯[39m tests/integration/variableSafety.test.ts [2m([22m[2m4 tests[22m[2m | [22m[31m4 failed[39m[2m)[22m[33m 4254[2mms[22m[39m
[31m     [31mÃ—[31m REPRO: ScriptEngine fails to resolve alias 'input_variable' when aliasMap is NOT provided[39m[32m 195[2mms[22m[39m
[31m     [31mÃ—[31m ScriptEngine resolves alias 'input_variable' when aliasMap is provided[39m[33m 509[2mms[22m[39m
[31m     [31mÃ—[31m REPRO: BlockRunner fails to resolve alias in CreateRecordConfig[39m[33m 517[2mms[22m[39m
[31m     [31mÃ—[31m BlockRunner logic resolves alias with aliasMap[39m[33m 549[2mms[22m[39m
{"level":40,"time":1768709117754,"env":"test","module":"auth-middleware","path":"/test","msg":"No authorization token provided"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w26_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768709117857,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709117858,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w26_v3 (Reused: true)

{"level":50,"time":1768709117867,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
 [31mâ¯[39m tests/integration/auth/oauth2.callback.test.ts [2m([22m[2m16 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 5485[2mms[22m[39m
[31m       [31mÃ—[31m should initiate OAuth2 3-legged flow and generate authorization URL[39m[33m 342[2mms[22m[39m
       [32mâœ“[39m should include optional scope in authorization URL[32m 206[2mms[22m[39m
       [32mâœ“[39m should validate valid OAuth2 state token[32m 183[2mms[22m[39m
       [32mâœ“[39m should reject invalid OAuth2 state token[32m 189[2mms[22m[39m
       [32mâœ“[39m should reject expired OAuth2 state token[32m 189[2mms[22m[39m
       [32mâœ“[39m should clean up OAuth2 state after use[32m 189[2mms[22m[39m
       [32mâœ“[39m should handle callback with missing state parameter[32m 192[2mms[22m[39m
       [32mâœ“[39m should handle callback with missing code parameter[32m 184[2mms[22m[39m
       [32mâœ“[39m should handle OAuth2 provider error responses[32m 179[2mms[22m[39m
[31m       [31mÃ—[31m should track OAuth2 connection status[39m[32m 290[2mms[22m[39m
       [32mâœ“[39m should store OAuth2 state in connection metadata[32m 187[2mms[22m[39m
       [32mâœ“[39m should use cryptographically secure random state[32m 196[2mms[22m[39m
       [32mâœ“[39m should prevent state reuse after validation[32m 184[2mms[22m[39m
       [33m[2mâœ“[22m[39m should include PKCE support metadata in state record [33m 450[2mms[22m[39m
       [32mâœ“[39m should validate redirect URI matches allowed URIs[32m 180[2mms[22m[39m
       [32mâœ“[39m should encode redirect URI in authorization URL[32m 182[2mms[22m[39m
{"level":50,"time":1768709117964,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709118247,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/externalSends.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709118248,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mðŸ“Š Schema test_schema_w26_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709118272,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709118273,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w26_v3\",public"}
{"level":30,"time":1768709118288,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/mfa.flow.real.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709118288,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/externalSends.test.ts [2m([22m[2m2 tests[22m[2m | [22m[33m2 skipped[39m[2m)[22m[33m 2488[2mms[22m[39m
     [2m[90mâ†“[39m[22m PREVIEW MODE: Should simulate send and NOT call fetch
     [2m[90mâ†“[39m[22m LIVE MODE: Should call fetch with mapped payload
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

{"level":30,"time":1768709118321,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w26_v3\",public"}
{"level":30,"time":1768709118321,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768709118376,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709118377,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/organizationService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":50,"time":1768709118386,"env":"test","module":"auth-routes","email":"test-1768709117891-6i1b2@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
 [31mâ¯[39m tests/integration/mfa.flow.real.test.ts [2m([22m[2m20 tests[22m[2m | [22m[31m20 failed[39m[2m)[22m[33m 18497[2mms[22m[39m
[31m       [31mÃ—[31m should complete full MFA setup flow[39m[33m 406[2mms[22m[39m
[31m       [31mÃ—[31m should reject invalid TOTP code during setup[39m[33m 731[2mms[22m[39m
[31m       [31mÃ—[31m should not allow MFA setup if already enabled[39m[33m 858[2mms[22m[39m
[31m       [31mÃ—[31m should generate unique backup codes[39m[33m 729[2mms[22m[39m
[31m       [31mÃ—[31m should store hashed backup codes[39m[33m 1621[2mms[22m[39m
[31m       [31mÃ—[31m should require MFA for enabled users[39m[33m 413[2mms[22m[39m
[31m       [31mÃ—[31m should complete MFA login with valid TOTP[39m[33m 830[2mms[22m[39m
[31m       [31mÃ—[31m should reject invalid TOTP during login[39m[33m 737[2mms[22m[39m
[31m       [31mÃ—[31m should accept TOTP codes within 60-second window[39m[33m 733[2mms[22m[39m
[31m       [31mÃ—[31m should login with valid backup code[39m[33m 1510[2mms[22m[39m
[31m       [31mÃ—[31m should mark backup code as used[39m[33m 404[2mms[22m[39m
[31m       [31mÃ—[31m should prevent backup code reuse[39m[33m 1577[2mms[22m[39m
[31m       [31mÃ—[31m should try TOTP before backup code[39m[33m 413[2mms[22m[39m
[31m       [31mÃ—[31m should return MFA status for user[39m[33m 745[2mms[22m[39m
[31m       [31mÃ—[31m should return backup codes count for MFA users[39m[33m 738[2mms[22m[39m
[31m       [31mÃ—[31m should disable MFA with password verification[39m[33m 1113[2mms[22m[39m
[31m       [31mÃ—[31m should require correct password to disable MFA[39m[33m 755[2mms[22m[39m
[31m       [31mÃ—[31m should regenerate backup codes[39m[33m 736[2mms[22m[39m
[31m       [31mÃ—[31m should return error if MFA not enabled[39m[33m 771[2mms[22m[39m
[31m       [31mÃ—[31m should enforce MFA for tenant users when required by tenant[39m[33m 814[2mms[22m[39m
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w28_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [31mâ¯[39m tests/integration/organizationService.test.ts [2m([22m[2m13 tests[22m[2m | [22m[31m13 failed[39m[2m)[22m[33m 10246[2mms[22m[39m
[31m       [31mÃ—[31m should create organization and auto-create admin membership[39m[32m 205[2mms[22m[39m
[31m       [31mÃ—[31m should return all organizations for user[39m[33m 830[2mms[22m[39m
[31m       [31mÃ—[31m should return empty array for user with no memberships[39m[33m 671[2mms[22m[39m
[31m       [31mÃ—[31m should allow admin to update organization[39m[32m 191[2mms[22m[39m
[31m       [31mÃ—[31m should deny non-admin from updating organization[39m[33m 524[2mms[22m[39m
[31m       [31mÃ—[31m should return all members of organization[39m[33m 533[2mms[22m[39m
[31m       [31mÃ—[31m should allow admin to promote member[39m[33m 781[2mms[22m[39m
[31m       [31mÃ—[31m should allow admin to demote other admin[39m[33m 781[2mms[22m[39m
[31m       [31mÃ—[31m should prevent self-demotion[39m[33m 522[2mms[22m[39m
[31m       [31mÃ—[31m should allow admin to remove member[39m[33m 940[2mms[22m[39m
[31m       [31mÃ—[31m should prevent self-removal[39m[33m 326[2mms[22m[39m
[31m       [31mÃ—[31m should allow member to leave organization[39m[32m 190[2mms[22m[39m
[31m       [31mÃ—[31m should allow admin to leave organization[39m[33m 1236[2mms[22m[39m
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w28_v3 (Reused: true)

{"level":50,"time":1768709118505,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mPassword Reset Flow[2m > [22m[2mshould invalidate all sessions after password reset
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768709118559,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

{"level":50,"time":1768709118918,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mðŸ“Š Schema test_schema_w28_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709118923,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709118924,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w28_v3\",public"}
{"level":30,"time":1768709118983,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w28_v3\",public"}
{"level":30,"time":1768709118983,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768709119045,"env":"test","module":"auth-routes","userId":"db7222c6ed9bb060f828ad23a921dc5f","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

{"level":50,"time":1768709119138,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould not expose sensitive token data
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:74:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768709119144,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w26_v3, public
âœ… Enforced search_path: test_schema_w26_v3, public

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":50,"time":1768709119198,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstderr[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/integration/ai/workflowEdit.test.ts[2m > [22m[2mPOST /api/workflows/:workflowId/ai/edit - Integration Test
[22m[39mâš ï¸ Skipping auditLogs cleanup: auditLogs or testUserId is undefined { auditLogs: [33mtrue[39m, testUserId: [90mundefined[39m }

{"level":40,"time":1768709119581,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould reject invalid MFA code
[22m[39m[TEST UTILS] MFA Secret verified for aabdd00863093241eaf94c21baa72783

{"level":30,"time":1768709119744,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768709119771,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/ai/workflowEdit.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709119772,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768709119780,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768709119824,"env":"test","module":"auth-routes","userId":"f7649220261b12cbb757a0247acb9c9a","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w28_v3, public
âœ… Enforced search_path: test_schema_w28_v3, public

 [31mâ¯[39m tests/integration/ai/workflowEdit.test.ts [2m([22m[2m8 tests[22m[2m | [22m[33m8 skipped[39m[2m)[22m[33m 2333[2mms[22m[39m
     [2m[90mâ†“[39m[22m should create draft version on successful AI edit
     [2m[90mâ†“[39m[22m should enforce draft mode (revert active workflow to draft)
     [2m[90mâ†“[39m[22m should not create version when no changes detected (checksum match)
     [2m[90mâ†“[39m[22m should reject unauthorized access
     [2m[90mâ†“[39m[22m should reject unsafe DataVault operations
     [2m[90mâ†“[39m[22m should handle multi-operation edits with tempId resolution
     [2m[90mâ†“[39m[22m should create BEFORE and AFTER snapshots
     [2m[90mâ†“[39m[22m should rollback on validation failure
[90mstderr[2m | tests/integration/regression-REG-1.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":50,"time":1768709119937,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould rotate refresh token on each use
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:74:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w31_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":40,"time":1768709119976,"env":"test","module":"auth-middleware","path":"/test","msg":"No authorization token provided"}
[90mstdout[2m | tests/unit/middleware/auth.middleware.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709119977,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709119978,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w31_v3 (Reused: true)

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

 [31mâ¯[39m tests/unit/middleware/auth.middleware.test.ts [2m([22m[2m22 tests[22m[2m | [22m[31m11 failed[39m[2m)[22m[33m 6384[2mms[22m[39m
       [32mâœ“[39m should authenticate with valid JWT token[32m 95[2mms[22m[39m
       [32mâœ“[39m should return 401 for missing token[32m 103[2mms[22m[39m
       [32mâœ“[39m should return 401 for invalid token[32m 100[2mms[22m[39m
       [32mâœ“[39m should return 401 for expired token[32m 100[2mms[22m[39m
       [32mâœ“[39m should extract token without Bearer prefix[32m 101[2mms[22m[39m
       [32mâœ“[39m should authenticate with valid token[32m 101[2mms[22m[39m
       [32mâœ“[39m should proceed without auth when no token provided[32m 95[2mms[22m[39m
       [32mâœ“[39m should proceed even with invalid token[32m 98[2mms[22m[39m
[31m       [31mÃ—[31m should authenticate with JWT Bearer token[39m[33m 371[2mms[22m[39m
[31m       [31mÃ—[31m should authenticate with refresh token cookie for GET requests[39m[32m 98[2mms[22m[39m
[31m       [31mÃ—[31m should reject cookie auth for POST requests[39m[32m 96[2mms[22m[39m
[31m       [31mÃ—[31m should prioritize JWT over cookie when both present[39m[32m 93[2mms[22m[39m
[31m       [31mÃ—[31m should allow cookie auth only for safe methods[39m[32m 95[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 when no auth provided[39m[32m 91[2mms[22m[39m
[31m       [31mÃ—[31m should authenticate with JWT[39m[32m 92[2mms[22m[39m
[31m       [31mÃ—[31m should authenticate with cookie for GET[39m[32m 93[2mms[22m[39m
[31m       [31mÃ—[31m should proceed without auth when none provided[39m[32m 95[2mms[22m[39m
[31m       [31mÃ—[31m should proceed even with invalid auth[39m[32m 104[2mms[22m[39m
       [32mâœ“[39m should not allow token tampering[32m 99[2mms[22m[39m
[31m       [31mÃ—[31m should not allow cookie auth for mutations (CSRF protection)[39m[32m 100[2mms[22m[39m
       [32mâœ“[39m should reject malformed JWT[32m 101[2mms[22m[39m
       [32mâœ“[39m should handle missing authorization header gracefully[32m 95[2mms[22m[39m
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mðŸ“Š Schema test_schema_w31_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709120425,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709120426,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w31_v3\",public"}
{"level":30,"time":1768709120478,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w31_v3\",public"}
{"level":30,"time":1768709120478,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

{"level":30,"time":1768709120757,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709120757,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768709120829,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["38e7076ddd40269847d5d03dd74add8d","8a29b4670b213fb8a19c5457bd36027a3dd9c0a6fb7de2614d1ac139ca289836","2026-02-17T04:05:20.755Z",false,"{\"ip\":\"::ffff:127.0.0.1\"}",null,"::ffff:127.0.0.1","Location Unknown","2026-01-18T04:05:20.755Z"],"cause":{"length":335,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(38e7076ddd40269847d5d03dd74add8d) is not present in table \"users\".","schema":"test_schema_w15_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Login failed"}
[90mstderr[2m | tests/integration/session.management.real.test.ts[2m > [22m[2mSession Management Integration Tests (REAL)[2m > [22m[2mSession Security[2m > [22m[2mshould track session activity timestamps
[22m[39mLogin Failed DEBUG: DrizzleQueryError: Failed query: insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)
params: 38e7076ddd40269847d5d03dd74add8d,8a29b4670b213fb8a19c5457bd36027a3dd9c0a6fb7de2614d1ac139ca289836,2026-02-17T04:05:20.755Z,false,{"ip":"::ffff:127.0.0.1"},,::ffff:127.0.0.1,Location Unknown,2026-01-18T04:05:20.755Z
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
    at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:150:24)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:325:24 {
  query: [32m'insert into "refresh_tokens" ("id", "user_id", "token", "expires_at", "revoked", "metadata", "device_name", "ip_address", "location", "last_used_at", "created_at") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)'[39m,
  params: [
    [32m'38e7076ddd40269847d5d03dd74add8d'[39m,
    [32m'8a29b4670b213fb8a19c5457bd36027a3dd9c0a6fb7de2614d1ac139ca289836'[39m,
    [32m'2026-02-17T04:05:20.755Z'[39m,
    [33mfalse[39m,
    [32m'{"ip":"::ffff:127.0.0.1"}'[39m,
    [1mnull[22m,
    [32m'::ffff:127.0.0.1'[39m,
    [32m'Location Unknown'[39m,
    [32m'2026-01-18T04:05:20.755Z'[39m
  ],
  cause: error: insert or update on table "refresh_tokens" violates foreign key constraint "refresh_tokens_user_id_users_id_fk"
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuthService.createRefreshToken (C:/Users/scoot/poll/VaultLogic/server/services/AuthService.ts:343:9)
      at issueTokens (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:150:24)
      at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:325:24 {
    length: [33m335[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23503'[39m,
    detail: [32m'Key (user_id)=(38e7076ddd40269847d5d03dd74add8d) is not present in table "users".'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w15_v3'[39m,
    table: [32m'refresh_tokens'[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [32m'refresh_tokens_user_id_users_id_fk'[39m,
    file: [32m'ri_triggers.c'[39m,
    line: [32m'2599'[39m,
    routine: [32m'ri_ReportViolation'[39m
  }
}

{"level":50,"time":1768709120840,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
 [31mâ¯[39m tests/integration/auth.routes.real.test.ts [2m([22m[2m26 tests[22m[2m | [22m[31m17 failed[39m[2m)[22m[33m 20966[2mms[22m[39m
[31m       [31mÃ—[31m should register a new user successfully[39m[33m 520[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 400 for invalid email format [33m 423[2mms[22m[39m
       [32mâœ“[39m should return 400 for weak password[32m 100[2mms[22m[39m
[31m       [31mÃ—[31m should return 409 for duplicate email[39m[33m 1196[2mms[22m[39m
[31m       [31mÃ—[31m should set httpOnly refresh token cookie[39m[33m 786[2mms[22m[39m
[31m       [31mÃ—[31m should login with valid credentials[39m[33m 729[2mms[22m[39m
[31m       [31mÃ—[31m should return 401 for invalid password[39m[33m 764[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 401 for non-existent user [33m 557[2mms[22m[39m
[31m       [31mÃ—[31m should return 403 for unverified email[39m[33m 1270[2mms[22m[39m
[31m       [31mÃ—[31m should record failed login attempt[39m[33m 414[2mms[22m[39m
[31m       [31mÃ—[31m should return requiresMfa=true for MFA-enabled users[39m[33m 733[2mms[22m[39m
[31m       [31mÃ—[31m should lock account after 5 failed attempts[39m[33m 1240[2mms[22m[39m
[31m       [31mÃ—[31m should logout and clear refresh token cookie[39m[33m 1455[2mms[22m[39m
[31m       [31mÃ—[31m should refresh access token with valid refresh token[39m[33m 1178[2mms[22m[39m
       [32mâœ“[39m should return 401 for missing refresh token[32m 99[2mms[22m[39m
[31m       [31mÃ—[31m should rotate refresh token after use[39m[33m 420[2mms[22m[39m
       [33m[2mâœ“[22m[39m should send password reset email for existing user [33m 1401[2mms[22m[39m
       [32mâœ“[39m should not reveal if email exists (security)[32m 145[2mms[22m[39m
[31m       [31mÃ—[31m should reset password with valid token[39m[33m 408[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 400 for invalid token [33m 463[2mms[22m[39m
[31m       [31mÃ—[31m should return 400 for weak new password[39m[33m 1070[2mms[22m[39m
[31m       [31mÃ—[31m should return current user for valid token[39m[33m 452[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return 401 for missing token [33m 411[2mms[22m[39m
       [32mâœ“[39m should return 401 for invalid token[32m 96[2mms[22m[39m
[31m         [31mÃ—[31m should complete MFA login with valid TOTP code[39m[33m 427[2mms[22m[39m
[31m         [31mÃ—[31m should reject invalid MFA code[39m[33m 2364[2mms[22m[39m
{"level":50,"time":1768709121194,"env":"test","module":"auth-routes","userId":"5b4aa94387aa577760b63a36b5397237","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w31_v3, public
âœ… Enforced search_path: test_schema_w31_v3, public

{"level":50,"time":1768709121390,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould detect and prevent refresh token reuse (token theft)
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:74:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768709121434,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/session.management.real.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709121726,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709121727,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/session.management.real.test.ts [2m([22m[2m18 tests[22m[2m | [22m[31m17 failed[39m[2m)[22m[33m 21935[2mms[22m[39m
[31m       [31mÃ—[31m should list all active sessions for current user[39m[33m 1516[2mms[22m[39m
[31m       [31mÃ—[31m should mark current session correctly[39m[33m 406[2mms[22m[39m
[31m       [31mÃ—[31m should exclude revoked sessions[39m[33m 748[2mms[22m[39m
[31m       [31mÃ—[31m should order sessions by last used (most recent first)[39m[33m 728[2mms[22m[39m
[31m       [31mÃ—[31m should filter sessions by current user only[39m[33m 3154[2mms[22m[39m
       [32mâœ“[39m should return 401 for unauthenticated request[32m 93[2mms[22m[39m
[31m       [31mÃ—[31m should revoke specific session[39m[33m 411[2mms[22m[39m
[31m       [31mÃ—[31m should prevent revoking current session[39m[33m 1479[2mms[22m[39m
[31m       [31mÃ—[31m should return 404 for non-existent session[39m[33m 432[2mms[22m[39m
[31m       [31mÃ—[31m should prevent revoking other user's session[39m[33m 2277[2mms[22m[39m
[31m       [31mÃ—[31m should revoke all other sessions[39m[33m 425[2mms[22m[39m
[31m       [31mÃ—[31m should keep current session active[39m[33m 741[2mms[22m[39m
[31m       [31mÃ—[31m should return 400 if no active session found[39m[33m 1535[2mms[22m[39m
[31m       [31mÃ—[31m should revoke all trusted devices[39m[33m 445[2mms[22m[39m
[31m       [31mÃ—[31m should handle user with single session gracefully[39m[33m 1530[2mms[22m[39m
[31m       [31mÃ—[31m should include device metadata in sessions[39m[33m 443[2mms[22m[39m
[31m       [31mÃ—[31m should not expose sensitive token data[39m[33m 1679[2mms[22m[39m
[31m       [31mÃ—[31m should track session activity timestamps[39m[33m 2004[2mms[22m[39m
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,d67fd2e0-2442-45bd-b871-8386f4833d4b,organization.create,organization,7b49734c-7f01-4cff-bd9f-789849e210e4,{"after":{"name":"Test Org Audit","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:58:17 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'd67fd2e0-2442-45bd-b871-8386f4833d4b'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'7b49734c-7f01-4cff-bd9f-789849e210e4'[39m,
    [32m'{"after":{"name":"Test Org Audit","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:58:17 {
    length: [33m520[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (382956aa-00ca-45ce-b464-64e6dcc8fe81, null, null, d67fd2e0-2442-45bd-b871-8386f4833d4b, organization.create, null, null, organization, 7b49734c-7f01-4cff-bd9f-789849e210e4, {"after": {"name": "Test Org Audit", "slug": null}}, null, null, null, 2026-01-18 04:05:23.131845, 2026-01-18 04:05:23.131845).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w15_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w24_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

{"level":50,"time":1768709122612,"env":"test","module":"auth-routes","userId":"cd90b023add0678e09ea1712ff2f58eb","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w24_v3 (Reused: true)

{"level":50,"time":1768709122728,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould list all active sessions
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:74:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768709122784,"env":"test","module":"auth-routes","email":"test-1768709122025-3oa3uu@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":30,"time":1768709122810,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

{"level":50,"time":1768709122912,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould list all active sessions
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768709122919,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709123002,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mðŸ“Š Schema test_schema_w24_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709123040,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709123040,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w24_v3\",public"}
{"level":30,"time":1768709123145,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w24_v3\",public"}
{"level":30,"time":1768709123145,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

{"level":40,"time":1768709123818,"env":"test","msg":"Failed to parse legacy string condition: \"trigger == \", defaulting to visible"}
{"level":40,"time":1768709123818,"env":"test","msg":"Failed to parse legacy string condition: \"trigger == \", defaulting to visible"}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w24_v3, public
âœ… Enforced search_path: test_schema_w24_v3, public

{"level":30,"time":1768709124002,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/regression-REG-1.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709124002,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/regression-REG-1.test.ts [2m([22m[2m8 tests[22m[2m | [22m[31m5 failed[39m[2m)[22m[33m 5964[2mms[22m[39m
[31m       [31mÃ—[31m should block Next when required visible question is empty[39m[33m 541[2mms[22m[39m
[31m       [31mÃ—[31m should NOT block Next when required question is hidden[39m[33m 495[2mms[22m[39m
[31m       [31mÃ—[31m should block when required becomes visible and is empty[39m[33m 900[2mms[22m[39m
[31m       [31mÃ—[31m should skip hidden required page entirely[39m[33m 537[2mms[22m[39m
[31m       [31mÃ—[31m should enforce required on visible page[39m[33m 576[2mms[22m[39m
       [33m[2mâœ“[22m[39m should evaluate visibility consistently across modes [33m 435[2mms[22m[39m
       [32mâœ“[39m should handle malformed visibility expression gracefully[32m 95[2mms[22m[39m
       [32mâœ“[39m should handle missing variable in visibility expression[32m 90[2mms[22m[39m
[90mstderr[2m | tests/integration/api.runs.docx.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768709124108,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768709124138,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts[2m > [22m[2mRuns API - DOCX Generation Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768709124120,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768709124121,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768709124128,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768709124128,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768709124137,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768709124138,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768709124138,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768709124138,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":50,"time":1768709124256,"env":"test","module":"auth-routes","userId":"666ce397f63b38694ac0444bff2b2a13","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

{"level":30,"time":1768709124235,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":50,"time":1768709124371,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:74:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768709124421,"env":"test","module":"auth-routes","email":"test-1768709123726-k2o3vq@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768709124517,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstderr[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mLogin Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:55:11)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:306:20 {
  code: [32m'AUTH_004'[39m,
  statusCode: [33m401[39m,
  isOperational: [33mtrue[39m
}

{"level":50,"time":1768709124524,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w25_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w25_v3 (Reused: true)

{"level":30,"time":1768709124775,"env":"test","module":"user-credentials-repository","userId":"0fdd7cd0-5849-422c-b236-8d8e46d0ac28","msg":"User credentials created"}
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #7: Delete organization[2m > [22m[2mshould allow last admin to delete empty organization
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,d67fd2e0-2442-45bd-b871-8386f4833d4b,organization.create,organization,33975480-71f2-4b37-97be-6ef44af3cd23,{"after":{"name":"Delete Test Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'd67fd2e0-2442-45bd-b871-8386f4833d4b'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'33975480-71f2-4b37-97be-6ef44af3cd23'[39m,
    [32m'{"after":{"name":"Delete Test Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:244:19
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m521[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (e0345070-9627-471e-a5e3-e0de07854200, null, null, d67fd2e0-2442-45bd-b871-8386f4833d4b, organization.create, null, null, organization, 33975480-71f2-4b37-97be-6ef44af3cd23, {"after": {"name": "Delete Test Org", "slug": null}}, null, null, null, 2026-01-18 04:05:25.808197, 2026-01-18 04:05:25.808197).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w24_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":30,"time":1768709124927,"env":"test","module":"email-queue","jobId":"30765945-42c7-476d-87b5-b933ca415edb","to":"test-docx-bHm0pIJ55u_GCDjYAa7se@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768709124978,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["0fdd7cd0-5849-422c-b236-8d8e46d0ac28","2c8c7ce9fd6ddccd82522d907f56e7bf1d8c16f4240b66bc9ad538313e920558","2026-02-17T04:05:24.932Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-18T04:05:24.932Z"],"cause":{"length":339,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(0fdd7cd0-5849-422c-b236-8d8e46d0ac28) is not present in table \"users\".","schema":"test_schema_w31_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768709125097,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709125098,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mðŸ“Š Schema test_schema_w25_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709125172,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709125173,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w25_v3\",public"}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

{"level":30,"time":1768709125227,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w25_v3\",public"}
{"level":30,"time":1768709125227,"env":"test","msg":"DB: initialized flag set."}
 [31mâ¯[39m tests/integration/auth.flows.real.test.ts [2m([22m[2m11 tests[22m[2m | [22m[31m11 failed[39m[2m)[22m[33m 17065[2mms[22m[39m
[31m       [31mÃ—[31m should complete registration, verify email, then login[39m[33m 505[2mms[22m[39m
[31m       [31mÃ—[31m should lock account after 5 failed attempts, then unlock after waiting[39m[33m 2355[2mms[22m[39m
[31m       [31mÃ—[31m should record all login attempts[39m[33m 408[2mms[22m[39m
[31m       [31mÃ—[31m should complete MFA setup and login with TOTP[39m[33m 1646[2mms[22m[39m
[31m       [31mÃ—[31m should login with backup code when TOTP unavailable[39m[33m 465[2mms[22m[39m
[31m       [31mÃ—[31m should complete full password reset flow[39m[33m 777[2mms[22m[39m
[31m       [31mÃ—[31m should invalidate all sessions after password reset[39m[33m 1684[2mms[22m[39m
[31m       [31mÃ—[31m should rotate refresh token on each use[39m[33m 1374[2mms[22m[39m
[31m       [31mÃ—[31m should detect and prevent refresh token reuse (token theft)[39m[33m 1400[2mms[22m[39m
[31m       [31mÃ—[31m should list all active sessions[39m[33m 1701[2mms[22m[39m
[31m       [31mÃ—[31m should revoke specific session[39m[33m 1460[2mms[22m[39m
{"level":30,"time":1768709125295,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768709125333,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768709125347,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768709125419,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.runs.docx.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709125420,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #7: Delete organization[2m > [22m[2mshould prevent deletion if org owns assets
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,d67fd2e0-2442-45bd-b871-8386f4833d4b,organization.create,organization,cb4ee9a8-0799-4da3-a043-e4e7b68eebf3,{"after":{"name":"Has Assets Org","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'd67fd2e0-2442-45bd-b871-8386f4833d4b'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'cb4ee9a8-0799-4da3-a043-e4e7b68eebf3'[39m,
    [32m'{"after":{"name":"Has Assets Org","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:262:19
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m520[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (96d19da3-17fc-4d39-a2b1-2b2bcb10128b, null, null, d67fd2e0-2442-45bd-b871-8386f4833d4b, organization.create, null, null, organization, cb4ee9a8-0799-4da3-a043-e4e7b68eebf3, {"after": {"name": "Has Assets Org", "slug": null}}, null, null, null, 2026-01-18 04:05:26.582408, 2026-01-18 04:05:26.582408).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w25_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

 [31mâ¯[39m tests/integration/api.runs.docx.test.ts [2m([22m[2m6 tests[22m[2m | [22m[33m6 skipped[39m[2m)[22m[33m 3252[2mms[22m[39m
       [2m[90mâ†“[39m[22m should execute workflow with template node and generate DOCX
       [2m[90mâ†“[39m[22m should handle missing template data gracefully
       [2m[90mâ†“[39m[22m should download DOCX output from successful run
       [2m[90mâ†“[39m[22m should return 404 for PDF when not generated
       [2m[90mâ†“[39m[22m should return 404 for non-existent run
       [2m[90mâ†“[39m[22m should extract placeholders from uploaded template
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w27_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w27_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w29_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w29_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w25_v3, public
âœ… Enforced search_path: test_schema_w25_v3, public

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstderr[2m | tests/integration/api.projects.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768709126396,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768709126421,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.projects.test.ts[2m > [22m[2mProjects API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768709126407,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768709126408,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768709126415,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768709126415,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768709126421,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768709126421,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768709126421,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768709126421,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w39_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mðŸ“Š Schema test_schema_w27_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709126518,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709126519,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w27_v3\",public"}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w39_v3 (Reused: true)

{"level":30,"time":1768709126554,"env":"test","module":"email-queue","jobId":"6eb8d5cf-ae96-40a9-9f89-4bb3fb1f33af","to":"placeholder-test@example.com","subject":"You've been invited to join Test Org Audit","msg":"Email added to queue"}
{"level":30,"time":1768709126576,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w27_v3\",public"}
{"level":30,"time":1768709126576,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mðŸ“Š Schema test_schema_w29_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709126641,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709126642,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w29_v3\",public"}
[90mstderr[2m | tests/integration/organizations-audit-fixes.test.ts[2m > [22m[2mOrganization Audit Fixes[2m > [22m[2mFIX #8: Placeholder user cleanup[2m > [22m[2mshould cleanup placeholder user when invite is revoked
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,d67fd2e0-2442-45bd-b871-8386f4833d4b,organization.invite_send,organization,7b49734c-7f01-4cff-bd9f-789849e210e4,{"after":{"invitedEmail":"placeholder-test@example.com","token":"59adfa208fcbbd724078f5184878cf994dd4c13d1719bcfcb5610999fe50f788"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'd67fd2e0-2442-45bd-b871-8386f4833d4b'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'7b49734c-7f01-4cff-bd9f-789849e210e4'[39m,
    [32m'{"after":{"invitedEmail":"placeholder-test@example.com","token":"59adfa208fcbbd724078f5184878cf994dd4c13d1719bcfcb5610999fe50f788"}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-audit-fixes.test.ts:295:22
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m541[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (9c2b92b7-4642-418c-9959-c3a6206c0d7d, null, null, d67fd2e0-2442-45bd-b871-8386f4833d4b, organization.invite_send, null, null, organization, 7b49734c-7f01-4cff-bd9f-789849e210e4, {"after": {"token": "59adfa208fcbbd724078f5184878cf994dd4c13d171..., null, null, null, 2026-01-18 04:05:27.661689, 2026-01-18 04:05:27.661689).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w25_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

{"level":30,"time":1768709126695,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w29_v3\",public"}
{"level":30,"time":1768709126695,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709126835,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mðŸ“Š Schema test_schema_w39_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709126940,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709126941,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w39_v3\",public"}
{"level":50,"time":1768709126981,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["a5ccda18-da57-4d9e-97ae-5a5d38be0ad1","$2b$12$n7bzLg8nms5tHMJNK4sqbOlqwO.j8pEoPnFLXNrAFQWXSWTMFhZu6"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(a5ccda18-da57-4d9e-97ae-5a5d38be0ad1) is not present in table \"users\".","schema":"test_schema_w27_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"a5ccda18-da57-4d9e-97ae-5a5d38be0ad1","msg":"Failed to create user credentials"}
{"level":50,"time":1768709126981,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["a5ccda18-da57-4d9e-97ae-5a5d38be0ad1","$2b$12$n7bzLg8nms5tHMJNK4sqbOlqwO.j8pEoPnFLXNrAFQWXSWTMFhZu6"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(a5ccda18-da57-4d9e-97ae-5a5d38be0ad1) is not present in table \"users\".","schema":"test_schema_w27_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768709126997,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w39_v3\",public"}
{"level":30,"time":1768709126997,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709127064,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768709127370,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.projects.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709127371,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w30_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w27_v3, public
âœ… Enforced search_path: test_schema_w27_v3, public

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w30_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w29_v3, public
âœ… Enforced search_path: test_schema_w29_v3, public

[90mstderr[2m | tests/integration/intake.workflow.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/intake.workflow.test.ts[2m > [22m[2mIntake Workflow Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/intake.workflow.test.ts[2m > [22m[2mIntake Workflow Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768709127534,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768709127560,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/intake.workflow.test.ts[2m > [22m[2mIntake Workflow Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstderr[2m | tests/integration/api.snapshots.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709127611,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768709127546,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768709127547,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768709127552,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768709127553,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768709127559,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768709127559,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768709127559,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768709127560,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768709127636,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.snapshots.test.ts[2m > [22m[2mStage 13: Workflow Snapshots & Versioning
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768709127622,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768709127623,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768709127629,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768709127630,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768709127635,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768709127635,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768709127636,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768709127636,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
 [31mâ¯[39m tests/integration/api.projects.test.ts [2m([22m[2m10 tests[22m[2m | [22m[33m10 skipped[39m[2m)[22m[33m 3045[2mms[22m[39m
       [2m[90mâ†“[39m[22m should create a new project
       [2m[90mâ†“[39m[22m should reject without authentication
       [2m[90mâ†“[39m[22m should reject with invalid data
       [2m[90mâ†“[39m[22m should list projects for tenant
       [2m[90mâ†“[39m[22m should support pagination
       [2m[90mâ†“[39m[22m should get project by ID
       [2m[90mâ†“[39m[22m should return 404 for non-existent project
       [2m[90mâ†“[39m[22m should update project
       [2m[90mâ†“[39m[22m should soft-delete project
       [2m[90mâ†“[39m[22m should not allow cross-tenant access
[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w39_v3, public
âœ… Enforced search_path: test_schema_w39_v3, public

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mðŸ“Š Schema test_schema_w30_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709127876,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709127877,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w30_v3\",public"}
{"level":30,"time":1768709127861,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstderr[2m | tests/integration/organizations-workflow.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768709127931,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w30_v3\",public"}
{"level":30,"time":1768709127931,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

{"level":50,"time":1768709128177,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["3b4ed0b4-985a-406a-b8f1-d322440edff9","$2b$12$M8iiLryfOo/lCSQmzIhGwOydhAv8n0odzDj/be7MNRAyt.V4GkK6u"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(3b4ed0b4-985a-406a-b8f1-d322440edff9) is not present in table \"users\".","schema":"test_schema_w39_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"3b4ed0b4-985a-406a-b8f1-d322440edff9","msg":"Failed to create user credentials"}
{"level":50,"time":1768709128177,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["3b4ed0b4-985a-406a-b8f1-d322440edff9","$2b$12$M8iiLryfOo/lCSQmzIhGwOydhAv8n0odzDj/be7MNRAyt.V4GkK6u"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(3b4ed0b4-985a-406a-b8f1-d322440edff9) is not present in table \"users\".","schema":"test_schema_w39_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/intake.workflow.test.ts[2m > [22m[2mIntake Workflow Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/intake.workflow.test.ts:11:15

[90mstdout[2m | tests/integration/intake.workflow.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709128191,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709128192,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w33_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768709128389,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709128390,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.snapshots.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w33_v3 (Reused: true)

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w34_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [31mâ¯[39m tests/integration/intake.workflow.test.ts [2m([22m[2m2 tests[22m[2m | [22m[33m2 skipped[39m[2m)[22m[33m 2529[2mms[22m[39m
     [2m[90mâ†“[39m[22m should allow designating a workflow as Intake
     [2m[90mâ†“[39m[22m should allow linking a downstream workflow to an intake workflow
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w34_v3 (Reused: true)

{"level":30,"time":1768709128632,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/organizations-audit-fixes.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709128633,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w32_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [31mâ¯[39m tests/integration/api.snapshots.test.ts [2m([22m[2m1 test[22m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 2593[2mms[22m[39m
     [2m[90mâ†“[39m[22m should maintain immutability of runs across versions
 [31mâ¯[39m tests/integration/organizations-audit-fixes.test.ts [2m([22m[2m8 tests[22m[2m | [22m[31m7 failed[39m[2m)[22m[33m 9063[2mms[22m[39m
[31m       [31mÃ—[31m should cascade ownership to workflow runs when project is transferred[39m[33m 1278[2mms[22m[39m
[31m       [31mÃ—[31m should prevent double-acceptance via transaction[39m[32m 144[2mms[22m[39m
[31m       [31mÃ—[31m should not create invite if email fails[39m[32m 141[2mms[22m[39m
[31m       [31mÃ—[31m should allow re-invite after invite expires[39m[32m 192[2mms[22m[39m
[31m       [31mÃ—[31m should allow last admin to delete empty organization[39m[33m 830[2mms[22m[39m
[31m       [31mÃ—[31m should prevent deletion if org owns assets[39m[33m 779[2mms[22m[39m
[31m       [31mÃ—[31m should cleanup placeholder user when invite is revoked[39m[33m 1367[2mms[22m[39m
       [33m[2mâœ“[22m[39m should fail fast on non-existent org [33m 916[2mms[22m[39m
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w32_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w30_v3, public
âœ… Enforced search_path: test_schema_w30_v3, public

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mðŸ“Š Schema test_schema_w33_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709128847,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709128848,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w33_v3\",public"}
{"level":30,"time":1768709128855,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstderr[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768709128897,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768709128921,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768709128911,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w33_v3\",public"}
{"level":30,"time":1768709128911,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709128907,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768709128908,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768709128914,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768709128914,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768709128920,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768709128920,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768709128921,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768709128921,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mðŸ“Š Schema test_schema_w34_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709128941,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709128942,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w34_v3\",public"}
{"level":30,"time":1768709129015,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w34_v3\",public"}
{"level":30,"time":1768709129015,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mComplete Organization Workflow[2m > [22m[2mStep 1: Create organization
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,9e36218e-8912-4a1e-90a9-c3f47677d115,organization.create,organization,ca586c81-a483-4390-84c2-02eaddc73f3b,{"after":{"name":"Test Organization","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'9e36218e-8912-4a1e-90a9-c3f47677d115'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'ca586c81-a483-4390-84c2-02eaddc73f3b'[39m,
    [32m'{"after":{"name":"Test Organization","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:92:19
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m523[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (0eb03d77-edbd-4c41-9c39-ee9476e05936, null, null, 9e36218e-8912-4a1e-90a9-c3f47677d115, organization.create, null, null, organization, ca586c81-a483-4390-84c2-02eaddc73f3b, {"after": {"name": "Test Organization", "slug": null}}, null, null, null, 2026-01-18 04:05:30.103287, 2026-01-18 04:05:30.103287).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w39_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mðŸ“Š Schema test_schema_w32_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709129164,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709129165,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w32_v3\",public"}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

{"level":30,"time":1768709129225,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w32_v3\",public"}
{"level":30,"time":1768709129225,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

{"level":50,"time":1768709129540,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["9c6b4360-81b5-4124-99d0-efb083a3cacb","$2b$12$9qje/va55MNI.38L3LwtU.Zo/CYdWV/.6bWr3Qp5fvRkGteTcmLZu"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(9c6b4360-81b5-4124-99d0-efb083a3cacb) is not present in table \"users\".","schema":"test_schema_w34_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"9c6b4360-81b5-4124-99d0-efb083a3cacb","msg":"Failed to create user credentials"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w35_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":50,"time":1768709129540,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["9c6b4360-81b5-4124-99d0-efb083a3cacb","$2b$12$9qje/va55MNI.38L3LwtU.Zo/CYdWV/.6bWr3Qp5fvRkGteTcmLZu"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(9c6b4360-81b5-4124-99d0-efb083a3cacb) is not present in table \"users\".","schema":"test_schema_w34_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/protected.routes.test.ts:31:15

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709129554,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709129555,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w35_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w33_v3, public
âœ… Enforced search_path: test_schema_w33_v3, public

[90mstderr[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768709129823,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w34_v3, public
âœ… Enforced search_path: test_schema_w34_v3, public

{"level":30,"time":1768709129848,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768709129835,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768709129836,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768709129841,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768709129842,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768709129847,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768709129847,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768709129848,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768709129848,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
 [31mâ¯[39m tests/integration/auth/protected.routes.test.ts [2m([22m[2m33 tests[22m[2m | [22m[33m33 skipped[39m[2m)[22m[33m 2535[2mms[22m[39m
       [2m[90mâ†“[39m[22m should allow access with valid Bearer token
       [2m[90mâ†“[39m[22m should reject access without Authorization header
       [2m[90mâ†“[39m[22m should reject access with empty Bearer token
       [2m[90mâ†“[39m[22m should reject access with malformed Authorization header
       [2m[90mâ†“[39m[22m should reject access with wrong token type
       [2m[90mâ†“[39m[22m should allow POST with valid Bearer token
       [2m[90mâ†“[39m[22m should reject POST without Bearer token
       [2m[90mâ†“[39m[22m should reject POST with invalid token
       [2m[90mâ†“[39m[22m should allow PUT with valid Bearer token
       [2m[90mâ†“[39m[22m should reject PUT without Bearer token
       [2m[90mâ†“[39m[22m should allow DELETE with valid Bearer token
       [2m[90mâ†“[39m[22m should reject DELETE without Bearer token
       [2m[90mâ†“[39m[22m should allow PATCH with valid Bearer token
       [2m[90mâ†“[39m[22m should reject PATCH without Bearer token
       [2m[90mâ†“[39m[22m should handle Bearer token with extra spaces
       [2m[90mâ†“[39m[22m should handle token with newlines
       [2m[90mâ†“[39m[22m should handle very long invalid token
       [2m[90mâ†“[39m[22m should handle empty Authorization header
       [2m[90mâ†“[39m[22m should handle Authorization header with only Bearer
       [2m[90mâ†“[39m[22m should handle multiple Authorization headers
       [2m[90mâ†“[39m[22m should reject token with SQL injection attempt
       [2m[90mâ†“[39m[22m should reject token with XSS attempt
       [2m[90mâ†“[39m[22m should reject token with missing userId
       [2m[90mâ†“[39m[22m should reject token with non-existent userId
       [2m[90mâ†“[39m[22m should not allow user to access another user's resources
       [2m[90mâ†“[39m[22m should inject userId into request context
       [2m[90mâ†“[39m[22m should inject tenantId into request context
       [2m[90mâ†“[39m[22m should inject role into request context
       [2m[90mâ†“[39m[22m should not apply general rate limiting to authenticated requests
       [2m[90mâ†“[39m[22m should handle request with both Bearer token and cookies
       [2m[90mâ†“[39m[22m should prioritize Bearer token over cookie when both present
       [2m[90mâ†“[39m[22m should allow unauthenticated access to optional auth routes
       [2m[90mâ†“[39m[22m should enhance optional auth routes with user context when authenticated
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w36_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstderr[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts[2m > [22m[2mLifecycle Hooks Execution
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts[2m > [22m[2mLifecycle Hooks Execution
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768709129939,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w36_v3 (Reused: true)

{"level":30,"time":1768709129986,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts[2m > [22m[2mLifecycle Hooks Execution
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768709129950,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768709129950,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768709129957,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768709129957,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768709129985,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768709129985,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768709129985,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768709129985,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mðŸ“Š Schema test_schema_w35_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709130007,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709130008,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w35_v3\",public"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w32_v3, public
âœ… Enforced search_path: test_schema_w32_v3, public

{"level":30,"time":1768709130063,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w35_v3\",public"}
{"level":30,"time":1768709130063,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/integration/api.runs.graph.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768709130137,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

{"level":30,"time":1768709130164,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768709130148,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768709130149,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768709130155,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768709130155,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768709130162,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768709130162,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768709130164,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768709130164,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mðŸ“Š Schema test_schema_w36_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709130368,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709130369,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w36_v3\",public"}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768709130419,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w36_v3\",public"}
{"level":30,"time":1768709130419,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

{"level":50,"time":1768709130496,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["04b56a2d-a355-4877-9429-7bef54997bee","$2b$12$DtTrR8nLrgHDyTTFAacA.ubKrHUpIc6iVptz/2irG9zBIyIlrMZQO"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(04b56a2d-a355-4877-9429-7bef54997bee) is not present in table \"users\".","schema":"test_schema_w35_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"04b56a2d-a355-4877-9429-7bef54997bee","msg":"Failed to create user credentials"}
{"level":50,"time":1768709130496,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["04b56a2d-a355-4877-9429-7bef54997bee","$2b$12$DtTrR8nLrgHDyTTFAacA.ubKrHUpIc6iVptz/2irG9zBIyIlrMZQO"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(04b56a2d-a355-4877-9429-7bef54997bee) is not present in table \"users\".","schema":"test_schema_w35_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/auth.middleware.integration.test.ts:35:15

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709130512,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709130512,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768709130516,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["1589e795-fff6-4fc7-8bf6-e37ab3d73714","$2b$12$Mu0noyKWvdVfocVev4wMOu69sijc7CW.DIZw0eb.WmJ1S.IxhmOqy"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(1589e795-fff6-4fc7-8bf6-e37ab3d73714) is not present in table \"users\".","schema":"test_schema_w35_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"1589e795-fff6-4fc7-8bf6-e37ab3d73714","msg":"Failed to create user credentials"}
{"level":50,"time":1768709130516,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["1589e795-fff6-4fc7-8bf6-e37ab3d73714","$2b$12$Mu0noyKWvdVfocVev4wMOu69sijc7CW.DIZw0eb.WmJ1S.IxhmOqy"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(1589e795-fff6-4fc7-8bf6-e37ab3d73714) is not present in table \"users\".","schema":"test_schema_w35_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/lifecycle-hooks-execution.test.ts[2m > [22m[2mLifecycle Hooks Execution
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/lifecycle-hooks-execution.test.ts:41:11

[90mstdout[2m | tests/integration/lifecycle-hooks-execution.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709130533,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709130534,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w37_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w43_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w37_v3 (Reused: true)

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w43_v3 (Reused: true)

 [31mâ¯[39m tests/integration/auth/auth.middleware.integration.test.ts [2m([22m[2m27 tests[22m[2m | [22m[33m27 skipped[39m[2m)[22m[33m 2507[2mms[22m[39m
       [2m[90mâ†“[39m[22m should allow access with valid JWT Bearer token
       [2m[90mâ†“[39m[22m should return 401 when no token provided
       [2m[90mâ†“[39m[22m should return 401 with invalid token
       [2m[90mâ†“[39m[22m should return 401 with expired token
       [2m[90mâ†“[39m[22m should proceed without authentication if no token provided
       [2m[90mâ†“[39m[22m should authenticate with JWT Bearer token
       [2m[90mâ†“[39m[22m should authenticate with refresh token cookie (GET only)
       [2m[90mâ†“[39m[22m should reject cookie auth for POST requests (mutation-strict)
       [2m[90mâ†“[39m[22m should reject cookie auth for PUT requests
       [2m[90mâ†“[39m[22m should reject cookie auth for DELETE requests
       [2m[90mâ†“[39m[22m should allow cookie auth for HEAD requests
       [2m[90mâ†“[39m[22m should prioritize JWT over cookie when both present
       [2m[90mâ†“[39m[22m should return 401 when no auth provided
       [2m[90mâ†“[39m[22m should return 401 when both JWT and cookie are invalid
       [2m[90mâ†“[39m[22m should authenticate with JWT if provided
       [2m[90mâ†“[39m[22m should authenticate with cookie if JWT not provided
       [2m[90mâ†“[39m[22m should proceed anonymously if no auth provided
       [2m[90mâ†“[39m[22m should proceed anonymously if both JWT and cookie are invalid
       [2m[90mâ†“[39m[22m should only allow safe methods for cookie auth
       [2m[90mâ†“[39m[22m should ignore cookies when Bearer token present
       [2m[90mâ†“[39m[22m should attach userId to request
       [2m[90mâ†“[39m[22m should attach userEmail to request
       [2m[90mâ†“[39m[22m should return consistent error format for missing token
       [2m[90mâ†“[39m[22m should return consistent error format for invalid token
       [2m[90mâ†“[39m[22m should return consistent error format for expired token
       [2m[90mâ†“[39m[22m should handle malformed JWT gracefully
       [2m[90mâ†“[39m[22m should handle JWT with wrong algorithm
 [31mâ¯[39m tests/integration/lifecycle-hooks-execution.test.ts [2m([22m[2m15 tests[22m[2m | [22m[33m15 skipped[39m[2m)[22m[33m 2429[2mms[22m[39m
       [2m[90mâ†“[39m[22m should execute beforePage hook and capture console output
       [2m[90mâ†“[39m[22m should execute beforePage hook with mutation mode enabled
       [2m[90mâ†“[39m[22m should handle errors gracefully without breaking workflow
       [2m[90mâ†“[39m[22m should execute afterPage hook with user input data
       [2m[90mâ†“[39m[22m should execute Python afterPage hook
       [2m[90mâ†“[39m[22m should execute beforeFinalBlock hook before document generation
       [2m[90mâ†“[39m[22m should execute afterDocumentsGenerated hook for cleanup
       [2m[90mâ†“[39m[22m should timeout hook that exceeds timeoutMs limit
       [2m[90mâ†“[39m[22m should execute multiple hooks in correct order
       [2m[90mâ†“[39m[22m should list all hooks for a workflow
       [2m[90mâ†“[39m[22m should update a hook
       [2m[90mâ†“[39m[22m should delete a hook
       [2m[90mâ†“[39m[22m should test a hook with sample data
       [2m[90mâ†“[39m[22m should retrieve execution logs for a run
       [2m[90mâ†“[39m[22m should clear execution logs for a run
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w40_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w44_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w40_v3 (Reused: true)

[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w44_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w35_v3, public
âœ… Enforced search_path: test_schema_w35_v3, public

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w45_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstderr[2m | tests/integration/api.runs.graph.test.ts[2m > [22m[2mStage 8: Runs API Integration Tests
[22m[39mCleanup error (non-fatal): DrizzleQueryError: Failed query: delete from "workflows" where  = $1
params: 826f5a53-49c7-4327-897a-8f1eca896814
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/api.runs.graph.test.ts:256:9 {
  query: [32m'delete from "workflows" where  = $1'[39m,
  params: [ [32m'826f5a53-49c7-4327-897a-8f1eca896814'[39m ],
  cause: error: syntax error at or near "="
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/api.runs.graph.test.ts:256:9 {
    length: [33m90[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'42601'[39m,
    detail: [90mundefined[39m,
    hint: [90mundefined[39m,
    position: [32m'32'[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [90mundefined[39m,
    table: [90mundefined[39m,
    column: [90mundefined[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'scan.l'[39m,
    line: [32m'1244'[39m,
    routine: [32m'scanner_yyerror'[39m
  }
}

{"level":30,"time":1768709130905,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.runs.graph.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709130906,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w45_v3 (Reused: true)

[90mstderr[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768709130987,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768709131012,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768709130998,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768709130998,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768709131004,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768709131005,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768709131011,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768709131011,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768709131012,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768709131012,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mðŸ“Š Schema test_schema_w37_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709131126,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709131127,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w37_v3\",public"}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mðŸ“Š Schema test_schema_w43_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709131134,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709131135,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w43_v3\",public"}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

{"level":30,"time":1768709131194,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w43_v3\",public"}
{"level":30,"time":1768709131194,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709131191,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w37_v3\",public"}
{"level":30,"time":1768709131191,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w36_v3, public
âœ… Enforced search_path: test_schema_w36_v3, public

 [31mâ¯[39m tests/integration/api.runs.graph.test.ts [2m([22m[2m19 tests[22m[2m | [22m[33m19 skipped[39m[2m)[22m[33m 2833[2mms[22m[39m
       [2m[90mâ†“[39m[22m should list all runs with pagination
       [2m[90mâ†“[39m[22m should filter runs by status
       [2m[90mâ†“[39m[22m should filter runs by workflow
       [2m[90mâ†“[39m[22m should filter runs by project
       [2m[90mâ†“[39m[22m should filter runs by date range
       [2m[90mâ†“[39m[22m should search runs by query string
       [2m[90mâ†“[39m[22m should get run by ID with all details
       [2m[90mâ†“[39m[22m should return 404 for non-existent run
       [2m[90mâ†“[39m[22m should get logs for a run
       [2m[90mâ†“[39m[22m should re-run workflow with same inputs
       [2m[90mâ†“[39m[22m should re-run workflow with override inputs
       [2m[90mâ†“[39m[22m should return 404 for non-existent run
       [2m[90mâ†“[39m[22m should export runs to CSV
       [2m[90mâ†“[39m[22m should export runs with filters applied
       [2m[90mâ†“[39m[22m should compare two runs
       [2m[90mâ†“[39m[22m should identify changed input keys
       [2m[90mâ†“[39m[22m should return 404 if run A not found
       [2m[90mâ†“[39m[22m should return 404 if run B not found
       [2m[90mâ†“[39m[22m should enforce tenant isolation on runs list
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mðŸ“Š Schema test_schema_w44_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709131317,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709131318,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w44_v3\",public"}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mðŸ“Š Schema test_schema_w40_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709131334,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709131335,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w40_v3\",public"}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768709131356,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests
[22m[39m[DEBUG] Database initialized.

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768709131370,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w44_v3\",public"}
{"level":30,"time":1768709131370,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709131379,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768709131366,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768709131367,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768709131372,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768709131373,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768709131379,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768709131379,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768709131379,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768709131379,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mðŸ“Š Schema test_schema_w45_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709131395,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709131396,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w45_v3\",public"}
{"level":30,"time":1768709131395,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w40_v3\",public"}
{"level":30,"time":1768709131395,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

{"level":30,"time":1768709131449,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w45_v3\",public"}
{"level":30,"time":1768709131449,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w38_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768709131582,"env":"test","module":"user-credentials-repository","userId":"39d0cef7-c880-4c0c-ac4d-aa5d68df4c7f","msg":"User credentials created"}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w38_v3 (Reused: true)

{"level":50,"time":1768709131658,"env":"test","module":"auth-routes","error":{"query":"insert into \"email_verification_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"created_at\") values (default, $1, $2, $3, default)","params":["39d0cef7-c880-4c0c-ac4d-aa5d68df4c7f","416118d0221eb01fdc9b3b7a4f624926ae422b94e2682382cf09d6fc3e85f009","2026-01-19T04:05:31.583Z"],"cause":{"length":383,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(39d0cef7-c880-4c0c-ac4d-aa5d68df4c7f) is not present in table \"users\".","schema":"test_schema_w43_v3","table":"email_verification_tokens","constraint":"email_verification_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
{"level":30,"time":1768709131662,"env":"test","workflowId":"cb38bd17-edba-4153-aa3c-addd61371983","userId":"9e36218e-8912-4a1e-90a9-c3f47677d115","sectionsCount":1,"stepsCount":0,"logicRulesCount":0,"msg":"getWorkflowWithDetails called"}
[90mstderr[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/jwt.authentication.test.ts:31:15

{"level":30,"time":1768709131672,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709131673,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w46_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w46_v3 (Reused: true)

{"level":50,"time":1768709131927,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["65bd2c85-be0f-4d82-a53d-88a7d39d6ee1","$2b$12$oaiYQF605GQWg5RF0ErL0OMf5KEEaPvNEN9dtV5yjZ3wUtFB4JT0a"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(65bd2c85-be0f-4d82-a53d-88a7d39d6ee1) is not present in table \"users\".","schema":"test_schema_w45_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"65bd2c85-be0f-4d82-a53d-88a7d39d6ee1","msg":"Failed to create user credentials"}
{"level":50,"time":1768709131927,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["65bd2c85-be0f-4d82-a53d-88a7d39d6ee1","$2b$12$oaiYQF605GQWg5RF0ErL0OMf5KEEaPvNEN9dtV5yjZ3wUtFB4JT0a"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(65bd2c85-be0f-4d82-a53d-88a7d39d6ee1) is not present in table \"users\".","schema":"test_schema_w45_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/session.management.integration.test.ts:31:15

 [31mâ¯[39m tests/integration/auth/jwt.authentication.test.ts [2m([22m[2m27 tests[22m[2m | [22m[33m27 skipped[39m[2m)[22m[33m 2516[2mms[22m[39m
       [2m[90mâ†“[39m[22m should generate valid JWT token on successful login
       [2m[90mâ†“[39m[22m should include correct payload in JWT token
       [2m[90mâ†“[39m[22m should set JWT expiry to 15 minutes
       [2m[90mâ†“[39m[22m should accept valid JWT token on protected routes
       [2m[90mâ†“[39m[22m should reject request without authorization header
       [2m[90mâ†“[39m[22m should reject request with malformed token
       [2m[90mâ†“[39m[22m should accept request with missing Bearer prefix (lenient)
       [2m[90mâ†“[39m[22m should reject token with invalid signature
       [2m[90mâ†“[39m[22m should reject expired JWT token
       [2m[90mâ†“[39m[22m should return token_expired error code for expired tokens
       [2m[90mâ†“[39m[22m should authenticate with Bearer token in Authorization header
       [2m[90mâ†“[39m[22m should work with Bearer token on POST requests
       [2m[90mâ†“[39m[22m should work with Bearer token on PUT requests
       [2m[90mâ†“[39m[22m should work with Bearer token on DELETE requests
       [2m[90mâ†“[39m[22m should exchange valid session cookie for JWT token
       [2m[90mâ†“[39m[22m should reject token exchange without valid cookie
       [2m[90mâ†“[39m[22m should prefer Bearer token over cookie when both present
       [2m[90mâ†“[39m[22m should fall back to cookie if Bearer token is invalid
       [2m[90mâ†“[39m[22m should allow GET requests with cookie auth only
       [2m[90mâ†“[39m[22m should reject POST requests with cookie auth only (mutation-strict)
       [2m[90mâ†“[39m[22m should allow anonymous access to public workflows
       [2m[90mâ†“[39m[22m should attach user info if authenticated on optional auth routes
       [2m[90mâ†“[39m[22m should refresh access token using refresh token
       [2m[90mâ†“[39m[22m should rotate refresh token on use
       [2m[90mâ†“[39m[22m should detect token reuse and revoke all user tokens
       [2m[90mâ†“[39m[22m should revoke refresh token on logout
       [2m[90mâ†“[39m[22m should clear refresh token cookie on logout
{"level":30,"time":1768709131942,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709131943,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mâš ï¸ Could not set database-level search_path (expected in cloud DBs): tuple concurrently updated
âœ… Enforced search_path: test_schema_w43_v3, public

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mðŸ“Š Schema test_schema_w38_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w37_v3, public
âœ… Enforced search_path: test_schema_w37_v3, public

{"level":30,"time":1768709132015,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709132016,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w38_v3\",public"}
[90mstderr[2m | tests/integration/workflow_versioning.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768709132073,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w38_v3\",public"}
{"level":30,"time":1768709132074,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstderr[2m | tests/integration/api.expression-validation.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/api.expression-validation.test.ts[2m > [22m[2mExpression Validation API Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/api.expression-validation.test.ts[2m > [22m[2mExpression Validation API Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768709132113,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768709132140,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.expression-validation.test.ts[2m > [22m[2mExpression Validation API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768709132123,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768709132124,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768709132131,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768709132132,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768709132139,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768709132139,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768709132140,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768709132140,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w44_v3, public
âœ… Enforced search_path: test_schema_w44_v3, public

{"level":30,"time":1768709132224,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
 [31mâ¯[39m tests/integration/auth/session.management.integration.test.ts [2m([22m[2m18 tests[22m[2m | [22m[33m18 skipped[39m[2m)[22m[33m 2427[2mms[22m[39m
       [2m[90mâ†“[39m[22m should create refresh token on login
       [2m[90mâ†“[39m[22m should track device metadata in session
       [2m[90mâ†“[39m[22m should create separate sessions for multiple device logins
       [2m[90mâ†“[39m[22m should list all active sessions for user
       [2m[90mâ†“[39m[22m should mark current session correctly
       [2m[90mâ†“[39m[22m should not include revoked sessions
       [2m[90mâ†“[39m[22m should order sessions by last used (most recent first)
       [2m[90mâ†“[39m[22m should require authentication
       [2m[90mâ†“[39m[22m should revoke specific session
       [2m[90mâ†“[39m[22m should prevent revoking current session
       [2m[90mâ†“[39m[22m should not allow revoking other users sessions
       [2m[90mâ†“[39m[22m should return 404 for non-existent session ID
       [2m[90mâ†“[39m[22m should revoke all sessions except current
       [2m[90mâ†“[39m[22m should revoke all trusted devices
       [2m[90mâ†“[39m[22m should require active session
       [2m[90mâ†“[39m[22m should reject refresh token after 30 days
       [2m[90mâ†“[39m[22m should handle multiple concurrent logins
       [2m[90mâ†“[39m[22m should handle concurrent token refreshes
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w40_v3, public
âœ… Enforced search_path: test_schema_w40_v3, public

[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w45_v3, public
âœ… Enforced search_path: test_schema_w45_v3, public

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mðŸ“Š Schema test_schema_w46_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstderr[2m | tests/integration/collections.e2e.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768709132296,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709132297,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w46_v3\",public"}
[90mstderr[2m | tests/integration/dataBlocks.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768709132351,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w46_v3\",public"}
{"level":30,"time":1768709132351,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768709132573,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/workflow_versioning.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709132574,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

 [31mâ¯[39m tests/integration/workflow_versioning.test.ts [2m([22m[2m3 tests[22m[2m | [22m[33m3 skipped[39m[2m)[22m[33m 2288[2mms[22m[39m
     [2m[90mâ†“[39m[22m should diff two versions correctly
     [2m[90mâ†“[39m[22m should create a version and populate changelog
     [2m[90mâ†“[39m[22m should track execution lineage via snapshot
{"level":50,"time":1768709132638,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["4a305a86-a33f-4958-b554-caad9c120226","$2b$12$JJJZAozj7SuK.9QUFeex6u/.siJjbTSgD8KAu.Kbjkg3Vbpa94FDq"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(4a305a86-a33f-4958-b554-caad9c120226) is not present in table \"users\".","schema":"test_schema_w39_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"4a305a86-a33f-4958-b554-caad9c120226","msg":"Failed to create user credentials"}
{"level":50,"time":1768709132638,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["4a305a86-a33f-4958-b554-caad9c120226","$2b$12$JJJZAozj7SuK.9QUFeex6u/.siJjbTSgD8KAu.Kbjkg3Vbpa94FDq"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(4a305a86-a33f-4958-b554-caad9c120226) is not present in table \"users\".","schema":"test_schema_w39_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/api.expression-validation.test.ts[2m > [22m[2mExpression Validation API Integration Tests
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/api.expression-validation.test.ts:20:11

[90mstdout[2m | tests/integration/api.expression-validation.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709132655,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709132655,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768709132800,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/collections.e2e.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709132801,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/collections.e2e.test.ts [2m([22m[2m22 tests[22m[2m | [22m[33m22 skipped[39m[2m)[22m[33m 2357[2mms[22m[39m
       [2m[90mâ†“[39m[22m should create a collection
       [2m[90mâ†“[39m[22m should list collections
       [2m[90mâ†“[39m[22m should get a collection by ID
       [2m[90mâ†“[39m[22m should update a collection
       [2m[90mâ†“[39m[22m should create text field
       [2m[90mâ†“[39m[22m should create email field
       [2m[90mâ†“[39m[22m should create number field
       [2m[90mâ†“[39m[22m should create select field with options
       [2m[90mâ†“[39m[22m should create boolean field
       [2m[90mâ†“[39m[22m should list all fields
       [2m[90mâ†“[39m[22m should update field
       [2m[90mâ†“[39m[22m should create a record
       [2m[90mâ†“[39m[22m should create multiple records
       [2m[90mâ†“[39m[22m should list records with pagination
       [2m[90mâ†“[39m[22m should get a single record
       [2m[90mâ†“[39m[22m should update a record
       [2m[90mâ†“[39m[22m should find records by filters
       [2m[90mâ†“[39m[22m should delete a record
       [2m[90mâ†“[39m[22m should list collections with stats
       [2m[90mâ†“[39m[22m should enforce required fields
       [2m[90mâ†“[39m[22m should validate field types
       [2m[90mâ†“[39m[22m should delete collection (cascade fields and records)
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w38_v3, public
âœ… Enforced search_path: test_schema_w38_v3, public

{"level":30,"time":1768709132919,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/dataBlocks.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709132920,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts[2m > [22m[2mData Sources API - Native Catalog
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts[2m > [22m[2mData Sources API - Native Catalog
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768709133019,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
 [31mâ¯[39m tests/integration/api.expression-validation.test.ts [2m([22m[2m10 tests[22m[2m | [22m[33m10 skipped[39m[2m)[22m[33m 2389[2mms[22m[39m
       [2m[90mâ†“[39m[22m should validate a correct expression with valid variables
       [2m[90mâ†“[39m[22m should validate expression with string concatenation
       [2m[90mâ†“[39m[22m should reject expression with invalid syntax
       [2m[90mâ†“[39m[22m should reject without authentication
       [2m[90mâ†“[39m[22m should reject missing required fields
       [2m[90mâ†“[39m[22m should return available variables for a node
       [2m[90mâ†“[39m[22m should reject without authentication
       [2m[90mâ†“[39m[22m should reject non-existent workflow
       [2m[90mâ†“[39m[22m should return list of helper functions with metadata
       [2m[90mâ†“[39m[22m should reject without authentication
{"level":30,"time":1768709133046,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.dataSources.native.test.ts[2m > [22m[2mData Sources API - Native Catalog
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768709133031,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768709133032,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768709133037,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768709133038,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768709133045,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768709133045,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768709133045,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768709133045,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w46_v3, public
âœ… Enforced search_path: test_schema_w46_v3, public

 [31mâ¯[39m tests/integration/dataBlocks.test.ts [2m([22m[2m2 tests[22m[2m | [22m[33m2 skipped[39m[2m)[22m[33m 2484[2mms[22m[39m
     [2m[90mâ†“[39m[22m should write data to DataVault via WriteBlock
     [2m[90mâ†“[39m[22m should query data from DataVault via QueryBlock and use in Logic
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstderr[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768709133336,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/dynamic_options_workflow.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709133337,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/dynamic_options_workflow.test.ts [2m([22m[2m1 test[22m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 2824[2mms[22m[39m
     [2m[90mâ†“[39m[22m should successfully configure a workflow with Read Table -> Dynamic Choice
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768709133626,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709133627,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/datavault.autonumber.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":50,"time":1768709133676,"env":"test","module":"user-credentials-repository","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["875e0ef7-3bf2-4d75-8b42-0379e992036e","$2b$12$qSHD2oIpkZB8T8PSrRKLVORf.2KzXPfMoXFUtq1nLoXGGKIEzKQlq"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(875e0ef7-3bf2-4d75-8b42-0379e992036e) is not present in table \"users\".","schema":"test_schema_w46_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"userId":"875e0ef7-3bf2-4d75-8b42-0379e992036e","msg":"Failed to create user credentials"}
{"level":50,"time":1768709133677,"env":"test","module":"auth-routes","error":{"query":"insert into \"user_credentials\" (\"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\") values (default, $1, $2, default, default) returning \"id\", \"user_id\", \"password_hash\", \"created_at\", \"updated_at\"","params":["875e0ef7-3bf2-4d75-8b42-0379e992036e","$2b$12$qSHD2oIpkZB8T8PSrRKLVORf.2KzXPfMoXFUtq1nLoXGGKIEzKQlq"],"cause":{"length":347,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(875e0ef7-3bf2-4d75-8b42-0379e992036e) is not present in table \"users\".","schema":"test_schema_w46_v3","table":"user_credentials","constraint":"user_credentials_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstderr[2m | tests/integration/api.dataSources.native.test.ts[2m > [22m[2mData Sources API - Native Catalog
[22m[39m[FATAL] setupIntegrationTest failed: Error: User registration failed: {"message":"Registration failed","error":"internal_error"}
    at setupIntegrationTest (C:/Users/scoot/poll/VaultLogic/tests/helpers/integrationTestHelper.ts:114:13)
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/integration/api.dataSources.native.test.ts:20:15

[90mstdout[2m | tests/integration/api.dataSources.native.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709133690,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709133690,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/datavault.autonumber.test.ts [2m([22m[2m5 tests[22m[2m | [22m[33m5 skipped[39m[2m)[22m[33m 2164[2mms[22m[39m
     [2m[90mâ†“[39m[22m should generate basic autonumber without prefix
     [2m[90mâ†“[39m[22m should generate autonumber with prefix
     [2m[90mâ†“[39m[22m should generate autonumber with yearly reset format
     [2m[90mâ†“[39m[22m should be atomic and prevent race conditions
     [2m[90mâ†“[39m[22m should prevent manual updates to autonumber values
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w52_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w52_v3 (Reused: true)

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

 [31mâ¯[39m tests/integration/api.dataSources.native.test.ts [2m([22m[2m2 tests[22m[2m | [22m[33m2 skipped[39m[2m)[22m[33m 2507[2mms[22m[39m
     [2m[90mâ†“[39m[22m should list databases and databases' tables in the catalog
     [2m[90mâ†“[39m[22m should create a native_table data source
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mðŸ“Š Schema test_schema_w52_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w54_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w54_v3 (Reused: true)

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w53_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w53_v3 (Reused: true)

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w55_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w55_v3 (Reused: true)

{"level":30,"time":1768709134503,"env":"test","module":"email-queue","jobId":"e1a2b43b-325e-401c-8cd9-14dcf31b3cba","to":"expired@test.com","subject":"You've been invited to join Test Organization","msg":"Email added to queue"}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w56_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w56_v3 (Reused: true)

{"level":30,"time":1768709134587,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mEdge Cases and Security[2m > [22m[2mCannot accept expired invite
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,9e36218e-8912-4a1e-90a9-c3f47677d115,organization.invite_send,organization,ca586c81-a483-4390-84c2-02eaddc73f3b,{"after":{"invitedEmail":"expired@test.com","token":"db426ae65cf08c1503f10583b285a79be4a0073643c2184504105741467d8812"}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 2 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'9e36218e-8912-4a1e-90a9-c3f47677d115'[39m,
    [32m'organization.invite_send'[39m,
    [32m'organization'[39m,
    [32m'ca586c81-a483-4390-84c2-02eaddc73f3b'[39m,
    [32m'{"after":{"invitedEmail":"expired@test.com","token":"db426ae65cf08c1503f10583b285a79be4a0073643c2184504105741467d8812"}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at OrganizationService.createInvite (C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:550:7)
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:348:22
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m541[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (18be4a68-e1dc-4be7-bc95-470f406a7510, null, null, 9e36218e-8912-4a1e-90a9-c3f47677d115, organization.invite_send, null, null, organization, ca586c81-a483-4390-84c2-02eaddc73f3b, {"after": {"token": "db426ae65cf08c1503f10583b285a79be4a0073643c..., null, null, null, 2026-01-18 04:05:35.614232, 2026-01-18 04:05:35.614232).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w39_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mðŸ“Š Schema test_schema_w54_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mðŸ“Š Schema test_schema_w53_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mðŸ“Š Schema test_schema_w55_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mðŸ“Š Schema test_schema_w56_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709135282,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709135283,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w52_v3\",public"}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w41_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768709135353,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w52_v3\",public"}
{"level":30,"time":1768709135353,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w41_v3 (Reused: true)

[90mstderr[2m | tests/integration/organizations-workflow.test.ts[2m > [22m[2mOrganization Workflow Integration Tests[2m > [22m[2mEdge Cases and Security[2m > [22m[2mCannot transfer workflow to org user is not a member of
[22m[39mFailed to write audit log: DrizzleQueryError: Failed query: insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)
params: ,1392c308-09e6-4afa-80d6-2674bd39c527,organization.create,organization,a70cc6d4-854a-406b-abcc-42cae7bcbda5,{"after":{"name":"Other Organization","slug":null}}
    at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:41:15[90m)[39m
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
    at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
[90m    ... 3 lines matching cause stack trace ...[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
  query: [32m'insert into "audit_logs" ("id", "tenant_id", "workspace_id", "user_id", "action", "entity_type", "entity_id", "resource_type", "resource_id", "changes", "details", "ip_address", "user_agent", "created_at", "timestamp") values (default, default, $1, $2, $3, default, default, $4, $5, $6, default, default, default, default, default)'[39m,
  params: [
    [1mnull[22m,
    [32m'1392c308-09e6-4afa-80d6-2674bd39c527'[39m,
    [32m'organization.create'[39m,
    [32m'organization'[39m,
    [32m'a70cc6d4-854a-406b-abcc-42cae7bcbda5'[39m,
    [32m'{"after":{"name":"Other Organization","slug":null}}'[39m
  ],
  cause: error: null value in column "entity_type" of relation "audit_logs" violates not-null constraint
      at [90mC:\Users\scoot\poll\VaultLogic\[39mnode_modules\[4mpg-pool[24m\index.js:45:11
  [90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:113:20
      at NodePgPreparedQuery.queryWithCache [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/pg-core/session.js:39:16[90m)[39m
      at AuditLogger.log (C:/Users/scoot/poll/VaultLogic/server/lib/audit/auditLogger.ts:21:13)
      at C:/Users/scoot/poll/VaultLogic/server/services/OrganizationService.ts:73:7
      at NodePgSession.transaction [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mdrizzle-orm[24m/node-postgres/session.js:186:22[90m)[39m
      at C:/Users/scoot/poll/VaultLogic/tests/integration/organizations-workflow.test.ts:373:20
      at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:20 {
    length: [33m524[39m,
    severity: [32m'ERROR'[39m,
    code: [32m'23502'[39m,
    detail: [32m'Failing row contains (b821cd61-5f74-4c3d-885e-226df29f93a1, null, null, 1392c308-09e6-4afa-80d6-2674bd39c527, organization.create, null, null, organization, a70cc6d4-854a-406b-abcc-42cae7bcbda5, {"after": {"name": "Other Organization", "slug": null}}, null, null, null, 2026-01-18 04:05:36.599408, 2026-01-18 04:05:36.599408).'[39m,
    hint: [90mundefined[39m,
    position: [90mundefined[39m,
    internalPosition: [90mundefined[39m,
    internalQuery: [90mundefined[39m,
    where: [90mundefined[39m,
    schema: [32m'test_schema_w39_v3'[39m,
    table: [32m'audit_logs'[39m,
    column: [32m'entity_type'[39m,
    dataType: [90mundefined[39m,
    constraint: [90mundefined[39m,
    file: [32m'execMain.c'[39m,
    line: [32m'2032'[39m,
    routine: [32m'ExecConstraints'[39m
  }
}

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709135759,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709135760,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w54_v3\",public"}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mðŸ“Š Schema test_schema_w41_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709135808,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709135809,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w41_v3\",public"}
{"level":30,"time":1768709135856,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w41_v3\",public"}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709135856,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709135859,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709135860,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w53_v3\",public"}
{"level":30,"time":1768709135899,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w54_v3\",public"}
{"level":30,"time":1768709135899,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709135914,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w53_v3\",public"}
{"level":30,"time":1768709135914,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709135993,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709135994,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w55_v3\",public"}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709135999,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709136000,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w56_v3\",public"}
{"level":30,"time":1768709136063,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w56_v3\",public"}
{"level":30,"time":1768709136063,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709136062,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w55_v3\",public"}
{"level":30,"time":1768709136062,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w52_v3, public
âœ… Enforced search_path: test_schema_w52_v3, public

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstderr[2m | tests/unit/workflows/validation.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w50_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w50_v3 (Reused: true)

[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w41_v3, public
âœ… Enforced search_path: test_schema_w41_v3, public

[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w53_v3, public
âœ… Enforced search_path: test_schema_w53_v3, public

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w54_v3, public
âœ… Enforced search_path: test_schema_w54_v3, public

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mðŸ“Š Schema test_schema_w50_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstderr[2m | tests/integration/datavault.permissions.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/datavault.permissions.test.ts[2m > [22m[2mDataVault Table Permissions API (v4 Micro-Phase 6)
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/datavault.permissions.test.ts[2m > [22m[2mDataVault Table Permissions API (v4 Micro-Phase 6)
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768709136814,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstderr[2m | tests/unit/HelperLibrary.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768709136841,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts[2m > [22m[2mDataVault Table Permissions API (v4 Micro-Phase 6)
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768709136825,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768709136826,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768709136833,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768709136834,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768709136840,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768709136841,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768709136841,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768709136841,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w56_v3, public
âœ… Enforced search_path: test_schema_w56_v3, public

[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w55_v3, public
âœ… Enforced search_path: test_schema_w55_v3, public

[90mstdout[2m | tests/integration/organizations-workflow.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709136969,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709136970,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

 [31mâ¯[39m tests/integration/organizations-workflow.test.ts [2m([22m[2m23 tests[22m[2m | [22m[31m9 failed[39m[2m)[22m[33m 10877[2mms[22m[39m
       [33m[2mâœ“[22m[39m Step 1: Create organization [33m 1131[2mms[22m[39m
[31m       [31mÃ—[31m Step 2: Invite member via email[39m[32m 141[2mms[22m[39m
[31m       [31mÃ—[31m Step 3: Accept invite[39m[32m 145[2mms[22m[39m
       [33m[2mâœ“[22m[39m Step 4: Create workflow owned by user [33m 832[2mms[22m[39m
[31m       [31mÃ—[31m Step 5: Transfer workflow to organization[39m[32m 201[2mms[22m[39m
[31m       [31mÃ—[31m Step 6: Org member (user2) can access workflow[39m[33m 327[2mms[22m[39m
[31m       [31mÃ—[31m Step 7: Org member (user2) can update workflow[39m[32m 184[2mms[22m[39m
       [33m[2mâœ“[22m[39m Step 8: Org admin (user1) can still access workflow after transfer [33m 703[2mms[22m[39m
       [32mâœ“[39m Step 9: Non-member (user3) CANNOT access org workflow[32m 192[2mms[22m[39m
       [32mâœ“[39m Step 10: Non-member (user3) CANNOT update org workflow[32m 193[2mms[22m[39m
       [32mâœ“[39m Step 11: Non-member (user3) CANNOT transfer org workflow[32m 189[2mms[22m[39m
[31m       [31mÃ—[31m Step 12: Org member can see workflow in list[39m[32m 198[2mms[22m[39m
       [32mâœ“[39m Step 13: Non-member CANNOT see workflow in list[32m 196[2mms[22m[39m
[31m       [31mÃ—[31m Step 14: Remove member from org[39m[32m 134[2mms[22m[39m
       [32mâœ“[39m Step 15: Removed member (user2) can no longer access workflow[32m 184[2mms[22m[39m
[31m       [31mÃ—[31m Step 16: Re-add member and verify access restored[39m[33m 419[2mms[22m[39m
[31m       [31mÃ—[31m Cannot invite same email twice (pending invite exists)[39m[32m 184[2mms[22m[39m
       [33m[2mâœ“[22m[39m Cannot accept expired invite [33m 1186[2mms[22m[39m
       [33m[2mâœ“[22m[39m Cannot transfer workflow to org user is not a member of [33m 1090[2mms[22m[39m
       [32mâœ“[39m Member cannot promote themselves to admin[32m 131[2mms[22m[39m
       [32mâœ“[39m Member cannot remove admin[32m 140[2mms[22m[39m
       [32mâœ“[39m Only members can view organization details[32m 145[2mms[22m[39m
       [32mâœ“[39m Only members can view organization members list[32m 146[2mms[22m[39m
{"level":30,"time":1768709137084,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w51_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w51_v3 (Reused: true)

{"level":30,"time":1768709137309,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768709137422,"env":"test","module":"user-credentials-repository","userId":"f8a8ba97-c6b3-49cd-b25e-0fbbf28df883","msg":"User credentials created"}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w42_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768709137631,"env":"test","module":"email-queue","jobId":"7123ad44-42d5-4398-8598-62df21921a2e","to":"test-T-DQfJMoI6KfOexkZvsgZ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w42_v3 (Reused: true)

{"level":30,"time":1768709137718,"env":"test","module":"auth-routes","userId":"f8a8ba97-c6b3-49cd-b25e-0fbbf28df883","email":"test-T-DQfJMoI6KfOexkZvsgZ@example.com","msg":"User registered"}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mðŸ“Š Schema test_schema_w51_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768709137800,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709137982,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709137983,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w50_v3\",public"}
{"level":30,"time":1768709138039,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w50_v3\",public"}
{"level":30,"time":1768709138039,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mðŸ“Š Schema test_schema_w42_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709138066,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709138067,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w42_v3\",public"}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w57_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768709138117,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w42_v3\",public"}
{"level":30,"time":1768709138118,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w57_v3 (Reused: true)

{"level":30,"time":1768709138319,"env":"test","module":"user-credentials-repository","userId":"b740ed2a-8025-4998-b5a8-b79c82f13ede","msg":"User credentials created"}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w58_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w58_v3 (Reused: true)

{"level":30,"time":1768709138417,"env":"test","module":"email-queue","jobId":"40dd5f54-b766-4716-b178-6128ba673bbe","to":"test-4c17y-gWDXC1Cj4CWq7OS@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768709138492,"env":"test","module":"auth-routes","error":{"query":"insert into \"refresh_tokens\" (\"id\", \"user_id\", \"token\", \"expires_at\", \"revoked\", \"metadata\", \"device_name\", \"ip_address\", \"location\", \"last_used_at\", \"created_at\") values (default, $1, $2, $3, $4, $5, $6, $7, $8, $9, default)","params":["b740ed2a-8025-4998-b5a8-b79c82f13ede","8ef7f78290248174e6515b034fabfcf1ead111c538358d691d2ddf2b36e4f714","2026-02-17T04:05:38.418Z",false,"{\"ip\":\"::1\"}",null,"::1","Location Unknown","2026-01-18T04:05:38.418Z"],"cause":{"length":339,"name":"error","severity":"ERROR","code":"23503","detail":"Key (user_id)=(b740ed2a-8025-4998-b5a8-b79c82f13ede) is not present in table \"users\".","schema":"test_schema_w42_v3","table":"refresh_tokens","constraint":"refresh_tokens_user_id_users_id_fk","file":"ri_triggers.c","line":"2599","routine":"ri_ReportViolation"}},"msg":"Registration failed"}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mðŸ“Š Schema test_schema_w57_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709138688,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709138690,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w51_v3\",public"}
{"level":30,"time":1768709138751,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w51_v3\",public"}
{"level":30,"time":1768709138751,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mðŸ“Š Schema test_schema_w58_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w50_v3, public
âœ… Enforced search_path: test_schema_w50_v3, public

[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w42_v3, public
âœ… Enforced search_path: test_schema_w42_v3, public

[90mstderr[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/integration/api.templates-runs.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/api.templates-runs.test.ts[2m > [22m[2mTemplates and Runs API Integration Tests
[22m[39m[DEBUG] Starting setupIntegrationTest...
[DEBUG] Initializing database...

[90mstdout[2m | tests/integration/api.templates-runs.test.ts[2m > [22m[2mTemplates and Runs API Integration Tests
[22m[39m[DEBUG] Database initialized.

{"level":30,"time":1768709139029,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768709139055,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts[2m > [22m[2mTemplates and Runs API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768709139041,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768709139042,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768709139048,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768709139049,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768709139054,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768709139054,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768709139055,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768709139055,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768709139080,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.permissions.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709139081,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

 [31mâ¯[39m tests/integration/datavault.permissions.test.ts [2m([22m[2m22 tests[22m[2m | [22m[33m22 skipped[39m[2m)[22m[33m 4105[2mms[22m[39m
       [2m[90mâ†“[39m[22m should allow owner to read table
       [2m[90mâ†“[39m[22m should allow writer to read table
       [2m[90mâ†“[39m[22m should allow reader to read table
       [2m[90mâ†“[39m[22m should deny non-member from reading table
       [2m[90mâ†“[39m[22m should allow owner to update table
       [2m[90mâ†“[39m[22m should deny writer from updating table
       [2m[90mâ†“[39m[22m should deny reader from updating table
       [2m[90mâ†“[39m[22m should deny writer from deleting table
       [2m[90mâ†“[39m[22m should deny reader from deleting table
       [2m[90mâ†“[39m[22m should deny non-member from deleting table
       [2m[90mâ†“[39m[22m should allow owner to view permissions
       [2m[90mâ†“[39m[22m should deny writer from viewing permissions
       [2m[90mâ†“[39m[22m should deny reader from viewing permissions
       [2m[90mâ†“[39m[22m should allow owner to grant permissions
       [2m[90mâ†“[39m[22m should allow owner to update existing permission (upsert)
       [2m[90mâ†“[39m[22m should deny writer from granting permissions
       [2m[90mâ†“[39m[22m should prevent modifying table owner permissions
       [2m[90mâ†“[39m[22m should allow owner to revoke permissions
       [2m[90mâ†“[39m[22m should deny writer from revoking permissions
       [2m[90mâ†“[39m[22m should enforce owner includes write and read
       [2m[90mâ†“[39m[22m should enforce write includes read but not owner
       [2m[90mâ†“[39m[22m should enforce read is read-only
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709139508,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709139509,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w57_v3\",public"}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

{"level":30,"time":1768709139562,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w57_v3\",public"}
{"level":30,"time":1768709139562,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w51_v3, public
âœ… Enforced search_path: test_schema_w51_v3, public

{"level":30,"time":1768709139612,"env":"test","module":"user-credentials-repository","userId":"db06f221-2e50-44ec-8616-a17fdd5ffd0e","msg":"User credentials created"}
[90mstderr[2m | tests/ui/runs.components.test.tsx
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w47_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709139699,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709139700,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w58_v3\",public"}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w47_v3 (Reused: true)

{"level":30,"time":1768709139750,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w58_v3\",public"}
{"level":30,"time":1768709139750,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709139764,"env":"test","module":"email-queue","jobId":"1ba1c43d-fc2a-4159-9199-730f950ca0c7","to":"test-hulmtQIYTLwANnygaHMlC@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768709139813,"env":"test","module":"auth-routes","userId":"db06f221-2e50-44ec-8616-a17fdd5ffd0e","email":"test-hulmtQIYTLwANnygaHMlC@example.com","msg":"User registered"}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w48_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w48_v3 (Reused: true)

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w59_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w59_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mðŸ“Š Schema test_schema_w47_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709140224,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709140225,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w47_v3\",public"}
{"level":30,"time":1768709140268,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w47_v3\",public"}
{"level":30,"time":1768709140269,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w60_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstderr[2m | tests/unit/shared/workflowLogic.test.ts[2m > [22m[2mworkflowLogic[2m > [22m[2mevaluateRules[2m > [22m[2mOperators[2m > [22m[2mUnknown operator[2m > [22m[2mshould return false and log warning for unknown operator
[22m[39mUnknown operator: unknown_operator

[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w57_v3, public
âœ… Enforced search_path: test_schema_w57_v3, public

[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w60_v3 (Reused: true)

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w49_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mðŸ“Š Schema test_schema_w48_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709140386,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709140387,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w48_v3\",public"}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w49_v3 (Reused: true)

{"level":30,"time":1768709140433,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w48_v3\",public"}
{"level":30,"time":1768709140434,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w58_v3, public
âœ… Enforced search_path: test_schema_w58_v3, public

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mðŸ“Š Schema test_schema_w59_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstderr[2m | tests/unit/collab.client.test.tsx
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":40,"time":1768709140673,"env":"test","module":"tenant-middleware","userId":"db06f221-2e50-44ec-8616-a17fdd5ffd0e","path":"/workflows/cac4048d-3f61-4e2f-9ffb-723f589fd0bf/publish","msg":"User does not have an associated tenant"}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mðŸ“Š Schema test_schema_w60_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709140777,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.templates-runs.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709140778,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mðŸ“Š Schema test_schema_w49_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709140848,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709140849,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w49_v3\",public"}
{"level":30,"time":1768709140905,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w49_v3\",public"}
{"level":30,"time":1768709140905,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w47_v3, public
âœ… Enforced search_path: test_schema_w47_v3, public

 [31mâ¯[39m tests/integration/api.templates-runs.test.ts [2m([22m[2m15 tests[22m[2m | [22m[33m15 skipped[39m[2m)[22m[33m 3549[2mms[22m[39m
         [2m[90mâ†“[39m[22m should create template with file upload
         [2m[90mâ†“[39m[22m should reject non-docx files
         [2m[90mâ†“[39m[22m should reject without file
         [2m[90mâ†“[39m[22m should list templates
         [2m[90mâ†“[39m[22m should get template by ID
         [2m[90mâ†“[39m[22m should extract placeholders
         [2m[90mâ†“[39m[22m should update template name
         [2m[90mâ†“[39m[22m should delete template
         [2m[90mâ†“[39m[22m should execute workflow
         [2m[90mâ†“[39m[22m should include logs in debug mode
         [2m[90mâ†“[39m[22m should reject without required permission
         [2m[90mâ†“[39m[22m should list runs
         [2m[90mâ†“[39m[22m should filter by workflowId
         [2m[90mâ†“[39m[22m should get run by ID
         [2m[90mâ†“[39m[22m should get run logs
[90mstderr[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768709141181,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts[2m > [22m[2mPersonalization API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768709141191,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768709141192,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768709141198,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768709141199,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w48_v3, public
âœ… Enforced search_path: test_schema_w48_v3, public

[90mstderr[2m | tests/integration/js_helpers.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768709141359,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768709141382,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/js_helpers.test.ts[2m > [22m[2mDetailed Verification: JS Helper Availability
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768709141369,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768709141369,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768709141375,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768709141376,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768709141381,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768709141381,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768709141382,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768709141382,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709141449,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709141449,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w59_v3\",public"}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709141472,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709141473,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w60_v3\",public"}
{"level":30,"time":1768709141497,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w59_v3\",public"}
{"level":30,"time":1768709141497,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709141507,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w60_v3\",public"}
{"level":30,"time":1768709141507,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w49_v3, public
âœ… Enforced search_path: test_schema_w49_v3, public

[90mstderr[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768709141839,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768709141863,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts[2m > [22m[2mDataVault v4 Regression Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768709141850,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768709141851,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768709141856,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768709141857,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768709141863,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768709141863,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768709141863,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768709141863,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
[90mstderr[2m | tests/ui/datavault/EditableCell.test.tsx[2m > [22m[2mEditableCell Component[2m > [22m[2mError Handling[2m > [22m[2mreverts value on save error
[22m[39mFailed to save cell: Error: Network error
    at C:/Users/scoot/poll/VaultLogic/tests/ui/datavault/EditableCell.test.tsx:206:36
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

{"level":30,"time":1768709141924,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/js_helpers.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709141924,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768709142001,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.ai.personalization.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709142003,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault-v4-regression.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709142002,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768709142003,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/ui/datavault/EditableCell.test.tsx[2m > [22m[2mEditableCell Component[2m > [22m[2mError Handling[2m > [22m[2mdisplays error indicator on save failure
[22m[39mFailed to save cell: Error: Network error
    at C:/Users/scoot/poll/VaultLogic/tests/ui/datavault/EditableCell.test.tsx:222:36
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:145:11
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:915:26
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1243:20
    at new Promise (<anonymous>)
    at runWithTimeout [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1209:10[90m)[39m
    at [90mfile:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:37
    at Traces.$ [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/traces.U4xDYhzZ.js:115:27[90m)[39m
    at trace [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/test.B8ej_ZHS.js:239:21[90m)[39m
    at runTest [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4m@vitest/runner[24m/dist/index.js:1653:12[90m)[39m

[90mstderr[2m | tests/unit/shared/conditionEvaluator.test.ts[2m > [22m[2mconditionEvaluator[2m > [22m[2mComparison operators[2m > [22m[2mUnknown operator[2m > [22m[2mshould default to true and log warning
[22m[39mUnknown operator: unknown_operator

 [31mâ¯[39m tests/integration/js_helpers.test.ts [2m([22m[2m1 test[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 2386[2mms[22m[39m
[31m     [31mÃ—[31m should execute a JS block that uses helper functions[39m[32m 248[2mms[22m[39m
 [31mâ¯[39m tests/integration/api.ai.personalization.test.ts [2m([22m[2m3 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 2685[2mms[22m[39m
[31m       [31mÃ—[31m should rewrite text based on user settings[39m[32m 200[2mms[22m[39m
       [32mâœ“[39m should generate help text[32m 150[2mms[22m[39m
[31m       [31mÃ—[31m should update user settings[39m[32m 198[2mms[22m[39m
 [31mâ¯[39m tests/integration/datavault-v4-regression.test.ts [2m([22m[2m23 tests[22m[2m | [22m[33m23 skipped[39m[2m)[22m[33m 1985[2mms[22m[39m
       [2m[90mâ†“[39m[22m should create a select column with options
       [2m[90mâ†“[39m[22m should create a multiselect column with options
       [2m[90mâ†“[39m[22m should validate select value against options
       [2m[90mâ†“[39m[22m should validate multiselect values as array
       [2m[90mâ†“[39m[22m should create an autonumber column with sequence
       [2m[90mâ†“[39m[22m should format autonumber with prefix
       [2m[90mâ†“[39m[22m should create a note for a row
       [2m[90mâ†“[39m[22m should get all notes for a row
       [2m[90mâ†“[39m[22m should delete a note
       [2m[90mâ†“[39m[22m should not allow deleting notes by other users
       [2m[90mâ†“[39m[22m should create an API token
       [2m[90mâ†“[39m[22m should validate API token scopes
       [2m[90mâ†“[39m[22m should revoke (delete) an API token
       [2m[90mâ†“[39m[22m should deny access with expired token
       [2m[90mâ†“[39m[22m should grant table permission
       [2m[90mâ†“[39m[22m should list table permissions
       [2m[90mâ†“[39m[22m should update table permission role
       [2m[90mâ†“[39m[22m should revoke table permission
       [2m[90mâ†“[39m[22m should enforce RBAC - only owners can manage permissions
       [2m[90mâ†“[39m[22m should paginate rows efficiently
       [2m[90mâ†“[39m[22m should return user-friendly error for invalid column type
       [2m[90mâ†“[39m[22m should return user-friendly error for missing required fields
       [2m[90mâ†“[39m[22m should handle network errors gracefully
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w60_v3, public
âœ… Enforced search_path: test_schema_w60_v3, public

[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w59_v3, public
âœ… Enforced search_path: test_schema_w59_v3, public

[90mstderr[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/ui/expression-editor.test.tsx
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768709142476,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/HelperLibrary.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709142477,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768709142490,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflows/validation.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709142491,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/HelperLibrary.test.ts [2m([22m[2m60 tests[22m[2m)[22m[33m 8467[2mms[22m[39m
 [32mâœ“[39m tests/unit/workflows/validation.test.ts [2m([22m[2m66 tests[22m[2m)[22m[33m 9177[2mms[22m[39m
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould validate expression after debounce
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstderr[2m | tests/ui/datavault/EditableCell.test.tsx[2m > [22m[2mEditableCell Component[2m > [22m[2mBoolean Type (Checkbox)[2m > [22m[2mshows loading spinner when saving checkbox
[22m[39mWarning: An update to EditableCell inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at EditableCell (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/EditableCell.tsx:12:25)

{"level":30,"time":1768709142923,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/TableGridView.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709142924,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould return validation errors for invalid expression
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768709143032,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/workflowLogic.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709143033,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/components/datavault/TableGridView.test.tsx [2m([22m[2m9 tests[22m[2m)[22m[33m 5260[2mms[22m[39m
     [33m[2mâœ“[22m[39m loads table schema and rows [33m 538[2mms[22m[39m
     [33m[2mâœ“[22m[39m updates cell value on blur [33m 444[2mms[22m[39m
     [33m[2mâœ“[22m[39m renders delete button for each row [33m 455[2mms[22m[39m
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

 [32mâœ“[39m tests/unit/shared/workflowLogic.test.ts [2m([22m[2m65 tests[22m[2m)[22m[33m 9003[2mms[22m[39m
[90mstdout[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould return validation errors for invalid expression
[22m[39mValidation Result DEBUG: {"ok":false,"errors":[{"message":"Unknown identifier: unknown_var","start":{"line":0,"col":0},"end":{"line":0,"col":11}}]}
IsValid DEBUG: [33mfalse[39m

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould debounce validation calls
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

{"level":30,"time":1768709143291,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/runs.components.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709143292,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/ui/runs.components.test.tsx [2m([22m[2m19 tests[22m[2m)[22m[33m 6482[2mms[22m[39m
       [33m[2mâœ“[22m[39m should show download options for successful runs [33m 915[2mms[22m[39m
       [33m[2mâœ“[22m[39m should call onChange when status filter changes [33m 399[2mms[22m[39m
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould not validate when workflowId or nodeId is missing
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/unit/listPipeline.semantics.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709143446,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709143446,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2museExpressionValidation[2m > [22m[2mshould not validate when workflowId or nodeId is missing
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13
Warning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

 [32mâœ“[39m tests/unit/listPipeline.semantics.test.ts [2m([22m[2m70 tests[22m[2m)[22m[33m 9543[2mms[22m[39m
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w66_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w65_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768709143557,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/conditionEvaluator.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w63_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768709143558,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w66_v3 (Reused: true)

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

{"level":30,"time":1768709143571,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/collab.client.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709143572,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w65_v3 (Reused: true)

 [32mâœ“[39m tests/unit/shared/conditionEvaluator.test.ts [2m([22m[2m70 tests[22m[2m)[22m[33m 9414[2mms[22m[39m
[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w63_v3 (Reused: true)

 [32mâœ“[39m tests/unit/collab.client.test.tsx [2m([22m[2m17 tests[22m[2m)[22m[33m 5652[2mms[22m[39m
     [33m[2mâœ“[22m[39m should add a comment [33m 580[2mms[22m[39m
     [33m[2mâœ“[22m[39m should allow comment owner to delete their comment [33m 348[2mms[22m[39m
[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression validation integration[2m > [22m[2mshould validate helper functions in expressions
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

{"level":30,"time":1768709143849,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/EditableCell.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709143849,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/ui/datavault/EditableCell.test.tsx [2m([22m[2m29 tests[22m[2m)[22m[33m 8121[2mms[22m[39m
       [33m[2mâœ“[22m[39m shows double-click hint on hover [33m 335[2mms[22m[39m
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w67_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression validation integration[2m > [22m[2mshould validate complex expressions with multiple helpers
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mðŸ“Š Schema test_schema_w66_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w67_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mðŸ“Š Schema test_schema_w65_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mðŸ“Š Schema test_schema_w63_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w68_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w68_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression validation integration[2m > [22m[2mshould handle syntax errors
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w61_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w61_v3 (Reused: true)

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mðŸ“Š Schema test_schema_w67_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mðŸ“Š Schema test_schema_w68_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression Editor component behavior[2m > [22m[2mshould update validation when expression changes
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w72_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w72_v3 (Reused: true)

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mðŸ“Š Schema test_schema_w61_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstderr[2m | tests/ui/expression-editor.test.tsx[2m > [22m[2mExpression Editor Hooks[2m > [22m[2mExpression Editor component behavior[2m > [22m[2mshould update validation when expression changes
[22m[39mWarning: An update to TestComponent inside a test was not wrapped in act(...).

When testing, code that causes React state updates should be wrapped into act(...):

act(() => {
  /* fire events that update state */
});
/* assert on the output */

This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
    at TestComponent (C:\Users\scoot\poll\VaultLogic\node_modules\@testing-library\react\dist\pure.js:328:5)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
    at C:/Users/scoot/poll/VaultLogic/tests/ui/expression-editor.test.tsx:19:13

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709144891,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709144892,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w63_v3\",public"}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709144903,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/expression-editor.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709144903,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709144904,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768709144904,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w66_v3\",public"}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709144917,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709144918,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w65_v3\",public"}
{"level":30,"time":1768709144954,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w63_v3\",public"}
{"level":30,"time":1768709144954,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w73_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [32mâœ“[39m tests/ui/expression-editor.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 5176[2mms[22m[39m
       [33m[2mâœ“[22m[39m should update validation when expression changes [33m 424[2mms[22m[39m
{"level":30,"time":1768709144978,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w66_v3\",public"}
{"level":30,"time":1768709144978,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709144997,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w65_v3\",public"}
{"level":30,"time":1768709144997,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w73_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mðŸ“Š Schema test_schema_w72_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709145407,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709145408,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w67_v3\",public"}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709145413,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709145414,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w68_v3\",public"}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mðŸ“Š Schema test_schema_w73_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

{"level":30,"time":1768709145461,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w67_v3\",public"}
{"level":30,"time":1768709145461,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709145473,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w68_v3\",public"}
{"level":30,"time":1768709145474,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709145749,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709145750,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w61_v3\",public"}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mâš ï¸ Could not set database-level search_path (expected in cloud DBs): tuple concurrently updated
âœ… Enforced search_path: test_schema_w65_v3, public

[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w63_v3, public
âœ… Enforced search_path: test_schema_w63_v3, public

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w66_v3, public
âœ… Enforced search_path: test_schema_w66_v3, public

{"level":30,"time":1768709145807,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w61_v3\",public"}
{"level":30,"time":1768709145807,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/integration/auth.routes.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/unit/middleware/rbac.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstderr[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709146001,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709146002,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w72_v3\",public"}
{"level":30,"time":1768709146049,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w72_v3\",public"}
{"level":30,"time":1768709146049,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w64_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w64_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w74_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w74_v3 (Reused: true)

[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709146254,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709146255,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w73_v3\",public"}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w67_v3, public
âœ… Enforced search_path: test_schema_w67_v3, public

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w68_v3, public
âœ… Enforced search_path: test_schema_w68_v3, public

{"level":30,"time":1768709146306,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w73_v3\",public"}
{"level":30,"time":1768709146306,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/unit/utils/encryption.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mðŸ“Š Schema test_schema_w64_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mðŸ“Š Schema test_schema_w74_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w61_v3, public
âœ… Enforced search_path: test_schema_w61_v3, public

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

{"level":50,"time":1768709146667,"env":"test","status":401,"statusText":"Unauthorized","error":"Invalid client credentials","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768709146667,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w71_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstderr[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":50,"time":1768709146757,"env":"test","data":{"token_type":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768709146757,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w71_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w72_v3, public
âœ… Enforced search_path: test_schema_w72_v3, public

{"level":50,"time":1768709146847,"env":"test","data":{"access_token":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768709146847,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w69_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstderr[2m | tests/integration/api.ai.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w69_v3 (Reused: true)

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w70_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":40,"time":1768709146996,"env":"test","module":"rbac-middleware","path":"/api/workflows","permission":"workflow:create","msg":"Unauthenticated user attempted to access protected resource"}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w70_v3 (Reused: true)

{"level":50,"time":1768709147030,"env":"test","error":"Network error: ECONNREFUSED","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":40,"time":1768709147094,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","permission":"workflow:create","path":"/api/workflows","msg":"Permission denied"}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w73_v3, public
âœ… Enforced search_path: test_schema_w73_v3, public

[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709147159,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709147160,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w74_v3\",public"}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mðŸ“Š Schema test_schema_w71_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768709147192,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w74_v3\",public"}
{"level":30,"time":1768709147192,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709147237,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709147238,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w64_v3\",public"}
[90mstderr[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768709147282,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w64_v3\",public"}
{"level":30,"time":1768709147282,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mðŸ“Š Schema test_schema_w69_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

{"level":40,"time":1768709147377,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":null,"permission":"workflow:view","path":"/api/workflows","msg":"Permission denied"}
{"level":30,"time":1768709147422,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflows/conditionTruthTable.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709147423,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mðŸ“Š Schema test_schema_w70_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

 [32mâœ“[39m tests/unit/workflows/conditionTruthTable.test.ts [2m([22m[2m51 tests[22m[2m)[22m[33m 7482[2mms[22m[39m
       [33m[2mâœ“[22m[39m should evaluate lte (less than or equal) [33m 369[2mms[22m[39m
{"level":40,"time":1768709147567,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","permissions":["workflow:create","workflow:edit","workflow:delete"],"path":"/api/workflows","msg":"Permission denied (none of required permissions)"}
{"level":40,"time":1768709147850,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"builder","permissions":["workflow:edit","workflow:delete"],"path":"/api/workflows","msg":"Permission denied (missing some required permissions)"}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768709147912,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":50,"time":1768709147958,"env":"test","error":"Invalid credentials","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709147963,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709147963,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w71_v3\",public"}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w74_v3, public
âœ… Enforced search_path: test_schema_w74_v3, public

{"level":30,"time":1768709148022,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w71_v3\",public"}
{"level":30,"time":1768709148022,"env":"test","msg":"DB: initialized flag set."}
{"level":50,"time":1768709148044,"env":"test","error":"ECONNREFUSED","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w64_v3, public
âœ… Enforced search_path: test_schema_w64_v3, public

[90mstderr[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709148164,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709148164,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w69_v3\",public"}
[90mstderr[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768709148211,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w69_v3\",public"}
{"level":30,"time":1768709148211,"env":"test","msg":"DB: initialized flag set."}
{"level":40,"time":1768709148222,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","requiredRoles":["owner","builder"],"path":"/api/admin","msg":"Role check failed"}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709148225,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709148225,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w70_v3\",public"}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w75_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768709148273,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w70_v3\",public"}
{"level":30,"time":1768709148273,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709148282,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/TableCard.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709148282,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w75_v3 (Reused: true)

{"level":40,"time":1768709148312,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":null,"requiredRoles":["owner"],"path":"/api/admin","msg":"Role check failed"}
 [32mâœ“[39m tests/ui/datavault/TableCard.test.tsx [2m([22m[2m8 tests[22m[2m)[22m[33m 4445[2mms[22m[39m
     [33m[2mâœ“[22m[39m should call onDelete when delete button is clicked [33m 759[2mms[22m[39m
{"level":40,"time":1768709148495,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"builder","requiredRoles":["owner"],"path":"/api/test","msg":"Role check failed"}
{"level":50,"time":1768709148513,"env":"test","status":400,"statusText":"Bad Request","error":"Invalid grant_type","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768709148513,"env":"test","error":"OAuth2 token request failed: 400 Bad Request","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768709148598,"env":"test","status":401,"statusText":"Unauthorized","error":"Client authentication failed","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768709148598,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mðŸ“Š Schema test_schema_w75_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":50,"time":1768709148697,"env":"test","status":403,"statusText":"Forbidden","error":"Access denied","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768709148697,"env":"test","error":"OAuth2 token request failed: 403 Forbidden","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

{"level":40,"time":1768709148769,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"runner","requiredRoles":["owner","builder"],"path":"/api/test","msg":"Role check failed"}
{"level":50,"time":1768709148788,"env":"test","status":500,"statusText":"Internal Server Error","error":"Server error","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token request failed"}
{"level":50,"time":1768709148788,"env":"test","error":"OAuth2 token request failed: 500 Internal Server Error","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w71_v3, public
âœ… Enforced search_path: test_schema_w71_v3, public

{"level":50,"time":1768709148884,"env":"test","error":"Unexpected token in JSON","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
[90mstderr[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":50,"time":1768709148976,"env":"test","error":"Request timeout","tokenUrl":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w69_v3, public
âœ… Enforced search_path: test_schema_w69_v3, public

{"level":30,"time":1768709149032,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/encryption.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709149032,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w76_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [32mâœ“[39m tests/unit/utils/encryption.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 5464[2mms[22m[39m
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w70_v3, public
âœ… Enforced search_path: test_schema_w70_v3, public

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w76_v3 (Reused: true)

[90mstderr[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":40,"time":1768709149135,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"viewer","requiredRoles":["owner","builder","runner"],"path":"/api/test","msg":"Role check failed"}
{"level":30,"time":1768709149154,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709149155,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

 [32mâœ“[39m tests/integration/auth/oauth2.client-credentials.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 5485[2mms[22m[39m
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709149243,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709149244,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w75_v3\",public"}
{"level":30,"time":1768709149289,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w75_v3\",public"}
{"level":30,"time":1768709149289,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx[2m > [22m[2mTableGridView - Drag & Drop[2m > [22m[2mrenders DndContext wrapper
[22m[39mWarning: validateDOMNesting(...): <th> cannot appear as a child of <div>.
    at th
    at SortableColumnHeader (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/SortableColumnHeader.tsx:12:33)
    at div
    at SortableContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:26:23)
    at tr
    at thead
    at table
    at div
    at DndContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:18:18)
    at div
    at div
    at TableGridView (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/TableGridView.tsx:32:26)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)
Warning: validateDOMNesting(...): <div> cannot appear as a child of <tr>.
    at div
    at SortableContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:26:23)
    at tr
    at thead
    at table
    at div
    at DndContext (C:/Users/scoot/poll/VaultLogic/tests/unit/components/datavault/TableGridViewDragDrop.test.tsx:18:18)
    at div
    at div
    at TableGridView (C:/Users/scoot/poll/VaultLogic/client/src/components/datavault/TableGridView.tsx:32:26)
    at QueryClientProvider (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@tanstack/react-query/build/modern/QueryClientProvider.js:20:3)

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mðŸ“Š Schema test_schema_w76_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

{"level":30,"time":1768709149526,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/docxHelpers.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709149527,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

 [32mâœ“[39m tests/unit/services/docxHelpers.test.ts [2m([22m[2m39 tests[22m[2m)[22m[33m 6388[2mms[22m[39m
{"level":30,"time":1768709149617,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709149617,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/auth.routes.test.ts [2m([22m[2m41 tests[22m[2m)[22m[33m 6456[2mms[22m[39m
{"level":30,"time":1768709149714,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK initialized successfully"}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

{"level":40,"time":1768709149780,"env":"test","module":"rbac-middleware","path":"/api/test","permission":"workflow:view","msg":"Unauthenticated user attempted to access protected resource"}
{"level":30,"time":1768709149714,"env":"test","module":"telemetry","msg":"Prometheus metrics initialized"}
{"level":30,"time":1768709149795,"env":"test","msg":"Master key validated successfully"}
{"level":30,"time":1768709149796,"env":"test","provider":"gemini","model":"gemini-2.0-flash","msg":"AI Service configured and ready"}
{"level":30,"time":1768709149796,"env":"test","msg":"Initializing database..."}
{"level":30,"time":1768709149796,"env":"test","msg":"Database initialized."}
{"level":30,"time":1768709149796,"env":"test","module":"email-queue","intervalMs":5000,"msg":"Starting email queue worker"}
Sourcemap for "C:/Users/scoot/poll/VaultLogic/node_modules/node-cron/dist/esm/node-cron.js" points to missing source files
{"level":30,"time":1768709149860,"env":"test","module":"cron","msg":"Initializing cron jobs..."}
{"level":30,"time":1768709149869,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.ai.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709149869,"env":"test","msg":"DB: pool closed."}
{"level":40,"time":1768709149871,"env":"test","module":"rbac-middleware","userId":"user-123","permission":"workflow:view","path":"/api/test","msg":"Permission denied"}
{"level":30,"time":1768709149901,"env":"test","msg":"DB: closing pool..."}
 [32mâœ“[39m tests/integration/api.ai.test.ts [2m([22m[2m32 tests[22m[2m)[22m[33m 5651[2mms[22m[39m
[90mstdout[2m | tests/unit/components/datavault/CellRenderer.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709149901,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768709149922,"env":"test","msg":"Real-time collaboration server initialized"}
{"level":30,"time":1768709149891,"env":"test","module":"cron","msg":"Cron jobs initialized"}
{"level":30,"time":1768709149893,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768709149904,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768709149905,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768709149911,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768709149913,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768709149921,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768709149921,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768709149921,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768709149922,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768709149922,"env":"test","msg":"Loading Vite for development..."}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768709149957,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/conditionalLogic.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709149958,"env":"test","msg":"DB: pool closed."}
{"level":40,"time":1768709149963,"env":"test","module":"rbac-middleware","userId":"user-123","userRole":"invalid-role","permission":"workflow:view","path":"/api/test","msg":"Permission denied"}
[90mstdout[2m | tests/unit/middleware/rbac.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709149963,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709149964,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/utils/conditionalLogic.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 5394[2mms[22m[39m
 [32mâœ“[39m tests/unit/components/datavault/CellRenderer.test.tsx [2m([22m[2m12 tests[22m[2m)[22m[33m 4262[2mms[22m[39m
     [33m[2mâœ“[22m[39m renders boolean value as Yes/No [33m 323[2mms[22m[39m
 [32mâœ“[39m tests/unit/middleware/rbac.test.ts [2m([22m[2m44 tests[22m[2m)[22m[33m 7075[2mms[22m[39m
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w78_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w78_v3 (Reused: true)

[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w75_v3, public
âœ… Enforced search_path: test_schema_w75_v3, public

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w77_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w77_v3 (Reused: true)

[90mstderr[2m | tests/integration/session.management.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768709150257,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/DatabaseSettingsPage.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709150258,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709150327,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709150329,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w76_v3\",public"}
 [32mâœ“[39m tests/ui/datavault/DatabaseSettingsPage.test.tsx [2m([22m[2m7 tests[22m[2m)[22m[33m 3746[2mms[22m[39m
     [33m[2mâœ“[22m[39m should render database settings page with breadcrumbs [33m 310[2mms[22m[39m
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768709150379,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w76_v3\",public"}
{"level":30,"time":1768709150379,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mðŸ“Š Schema test_schema_w78_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w79_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w79_v3 (Reused: true)

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mðŸ“Š Schema test_schema_w77_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

{"level":30,"time":1768709150603,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/components/datavault/TableGridViewDragDrop.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709150604,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768709150681,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/TemplateAnalysisService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709150682,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/components/datavault/TableGridViewDragDrop.test.tsx [2m([22m[2m7 tests[22m[2m)[22m[33m 4032[2mms[22m[39m
     [33m[2mâœ“[22m[39m displays columns in order based on orderIndex [33m 460[2mms[22m[39m
 [32mâœ“[39m tests/unit/services/TemplateAnalysisService.test.ts [2m([22m[2m27 tests[22m[2m)[22m[33m 4890[2mms[22m[39m
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w82_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w84_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w81_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mðŸ“Š Schema test_schema_w79_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w82_v3 (Reused: true)

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w84_v3 (Reused: true)

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w81_v3 (Reused: true)

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w76_v3, public
âœ… Enforced search_path: test_schema_w76_v3, public

[90mstderr[2m | tests/unit/engine.expr.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w85_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709151279,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709151280,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w78_v3\",public"}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709151314,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709151315,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w77_v3\",public"}
{"level":30,"time":1768709151319,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w78_v3\",public"}
{"level":30,"time":1768709151319,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w85_v3 (Reused: true)

{"level":30,"time":1768709151353,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w77_v3\",public"}
{"level":30,"time":1768709151353,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mðŸ“Š Schema test_schema_w84_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mðŸ“Š Schema test_schema_w82_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mðŸ“Š Schema test_schema_w81_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w83_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768709151501,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/ColumnTypeIcon.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709151502,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w83_v3 (Reused: true)

 [32mâœ“[39m tests/ui/datavault/ColumnTypeIcon.test.tsx [2m([22m[2m27 tests[22m[2m)[22m[33m 5201[2mms[22m[39m
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w86_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w86_v3 (Reused: true)

[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709151638,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709151639,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w79_v3\",public"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w87_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768709151680,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w79_v3\",public"}
{"level":30,"time":1768709151680,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w87_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mðŸ“Š Schema test_schema_w85_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mðŸ“Š Schema test_schema_w83_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mðŸ“Š Schema test_schema_w86_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w80_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709152122,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709152123,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w82_v3\",public"}
{"level":30,"time":1768709152124,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709152125,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w81_v3\",public"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mðŸ“Š Schema test_schema_w87_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w78_v3, public
âœ… Enforced search_path: test_schema_w78_v3, public

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709152133,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709152134,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w84_v3\",public"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w80_v3 (Reused: true)

[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w77_v3, public
âœ… Enforced search_path: test_schema_w77_v3, public

{"level":30,"time":1768709152173,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w81_v3\",public"}
{"level":30,"time":1768709152173,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709152174,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w82_v3\",public"}
{"level":30,"time":1768709152174,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709152183,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w84_v3\",public"}
{"level":30,"time":1768709152183,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709152236,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/session.management.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709152236,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/unit/services/repeater.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

 [32mâœ“[39m tests/integration/session.management.test.ts [2m([22m[2m22 tests[22m[2m)[22m[33m 4336[2mms[22m[39m
[90mstderr[2m | tests/unit/ScriptEngine.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709152443,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709152444,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w85_v3\",public"}
{"level":30,"time":1768709152488,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w85_v3\",public"}
{"level":30,"time":1768709152488,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w79_v3, public
âœ… Enforced search_path: test_schema_w79_v3, public

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mðŸ“Š Schema test_schema_w80_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstderr[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709152682,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709152683,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w83_v3\",public"}
{"level":30,"time":1768709152734,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w83_v3\",public"}
{"level":30,"time":1768709152734,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709152778,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709152779,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w86_v3\",public"}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709152810,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709152811,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w87_v3\",public"}
{"level":30,"time":1768709152830,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w86_v3\",public"}
{"level":30,"time":1768709152830,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709152853,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w87_v3\",public"}
{"level":30,"time":1768709152853,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w82_v3, public
âœ… Enforced search_path: test_schema_w82_v3, public

[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w84_v3, public
âœ… Enforced search_path: test_schema_w84_v3, public

[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w81_v3, public
âœ… Enforced search_path: test_schema_w81_v3, public

[90mstderr[2m | tests/integration/mfa.flow.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/unit/utils/pagination.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/unit/docxRenderer.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w85_v3, public
âœ… Enforced search_path: test_schema_w85_v3, public

[90mstderr[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709153422,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709153423,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w80_v3\",public"}
{"level":30,"time":1768709153473,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w80_v3\",public"}
{"level":30,"time":1768709153474,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w83_v3, public
âœ… Enforced search_path: test_schema_w83_v3, public

[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mâš ï¸ Could not set database-level search_path (expected in cloud DBs): tuple concurrently updated
âœ… Enforced search_path: test_schema_w87_v3, public

[90mstderr[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w86_v3, public
âœ… Enforced search_path: test_schema_w86_v3, public

{"level":30,"time":1768709153692,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine.expr.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709153692,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

 [32mâœ“[39m tests/unit/engine.expr.test.ts [2m([22m[2m26 tests[22m[2m)[22m[33m 5018[2mms[22m[39m
[90mstderr[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w89_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w89_v3 (Reused: true)

{"level":30,"time":1768709153898,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/repeater.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709153899,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/services/repeater.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 4255[2mms[22m[39m
{"level":30,"time":1768709154093,"env":"test","warnings":["Python code does not call emit(). Script will not produce output."],"msg":"Script validation warnings"}
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w88_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mðŸ“Š Schema test_schema_w89_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w88_v3 (Reused: true)

[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

{"level":30,"time":1768709154273,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/conditions/conditionEvaluation.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709154274,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709154278,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w80_v3, public
âœ… Enforced search_path: test_schema_w80_v3, public

{"level":30,"time":1768709154280,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w89_v3\",public"}
{"level":40,"time":1768709154312,"env":"test","error":{},"msg":"PDF conversion failed"}
 [32mâœ“[39m tests/integration/conditions/conditionEvaluation.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 4157[2mms[22m[39m
{"level":30,"time":1768709154317,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/docxRenderer.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709154317,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768709154347,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w89_v3\",public"}
{"level":30,"time":1768709154347,"env":"test","msg":"DB: initialized flag set."}
 [32mâœ“[39m tests/unit/docxRenderer.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 3747[2mms[22m[39m
[90mstderr[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts[2m > [22m[2mIntakeQuestionVisibilityService[2m > [22m[2mHelper methods[2m > [22m[2mshould get visible question count
[22m[39mMOCK SETUP DONE. Mock questions: [
  {
    id: [32m'q1'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q1'[39m,
    order: [33m0[39m,
    isVirtual: [33mfalse[39m,
    alias: [32m'show'[39m,
    visibleIf: [1mnull[22m
  },
  {
    id: [32m'q2'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q2'[39m,
    order: [33m1[39m,
    isVirtual: [33mfalse[39m,
    visibleIf: { op: [32m'equals'[39m, left: [36m[Object][39m, right: [36m[Object][39m }
  },
  {
    id: [32m'q3'[39m,
    sectionId: [32m'section1'[39m,
    title: [32m'Q3'[39m,
    order: [33m2[39m,
    isVirtual: [33mfalse[39m,
    visibleIf: [1mnull[22m
  }
]
Calling getVisibleQuestionCount...

[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts[2m > [22m[2mIntakeQuestionVisibilityService[2m > [22m[2mHelper methods[2m > [22m[2mshould get visible question count
[22m[39mCOUNT RESULT: [33m0[39m
Mock called times: [33m1[39m
Mock last call args: [ [ [32m'section1'[39m ] ]

{"level":30,"time":1768709154541,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/mfa.flow.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709154542,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/mfa.flow.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 4012[2mms[22m[39m
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mðŸ“Š Schema test_schema_w88_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709154665,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/ScriptEngine.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709154666,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

 [32mâœ“[39m tests/unit/ScriptEngine.test.ts [2m([22m[2m26 tests[22m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 4926[2mms[22m[39m
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

{"level":50,"time":1768709154806,"env":"test","module":"email-queue","error":{},"msg":"Error in email queue processor"}
{"level":30,"time":1768709154833,"env":"test","source":"express","msg":"ðŸ“¦ vite.ts module loaded successfully"}
{"level":30,"time":1768709154833,"env":"test","msg":"Vite module loaded, calling setupVite..."}
{"level":30,"time":1768709154833,"env":"test","source":"express","msg":"ðŸ“ setupVite: Starting Vite setup..."}
{"level":30,"time":1768709154833,"env":"test","source":"express","msg":"ðŸ“ setupVite: Resolving Vite config..."}
{"level":30,"time":1768709154838,"env":"test","source":"express","msg":"ðŸ“ setupVite: Vite config resolved"}
{"level":30,"time":1768709154839,"env":"test","source":"express","msg":"ðŸ“ setupVite: Server options prepared, creating Vite server..."}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

{"level":30,"time":1768709154910,"env":"test","source":"express","msg":"ðŸ“ setupVite: Vite server created successfully"}
{"level":30,"time":1768709154910,"env":"test","source":"express","msg":"ðŸ“ setupVite: Mounting Vite middlewares..."}
{"level":30,"time":1768709154910,"env":"test","source":"express","msg":"ðŸ“ setupVite: Vite middlewares mounted"}
{"level":30,"time":1768709154910,"env":"test","source":"express","msg":"ðŸ“ setupVite: Vite setup complete!"}
{"level":30,"time":1768709154910,"env":"test","msg":"Vite setup complete"}
{"level":30,"time":1768709154913,"env":"test","source":"express","msg":"serving on port 5000"}
{"level":50,"time":1768709155031,"env":"test","module":"workflow-patch-service","error":{},"op":{"op":"step.create","sectionRef":"temp-section-1","type":"short_text","title":"Field 1","alias":"field1"},"msg":"Failed to apply operation"}
{"level":50,"time":1768709155042,"env":"test","module":"intake-question-visibility","error":{},"questionId":"q1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating visibleIf condition"}
[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

{"level":30,"time":1768709155133,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/intakeQuestionVisibility.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709155134,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w89_v3, public
âœ… Enforced search_path: test_schema_w89_v3, public

 [32mâœ“[39m tests/unit/services/intakeQuestionVisibility.test.ts [2m([22m[2m19 tests[22m[2m)[22m[33m 4241[2mms[22m[39m
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w92_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstderr[2m | tests/unit/schema/collections.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w92_v3 (Reused: true)

{"level":30,"time":1768709155339,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/pagination.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709155340,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w93_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w90_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [32mâœ“[39m tests/unit/utils/pagination.test.ts [2m([22m[2m24 tests[22m[2m)[22m[33m 4797[2mms[22m[39m
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w93_v3 (Reused: true)

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w90_v3 (Reused: true)

{"level":50,"time":1768709155512,"env":"test","module":"workflow-patch-service","error":{},"op":{"op":"document.bindFields","id":"template-123","bindings":{"client_name":"nonExistentAlias"}},"msg":"Failed to apply operation"}
{"level":30,"time":1768709155538,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/blocks/SendDataToTableBlockEditor.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709155538,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/ui/blocks/SendDataToTableBlockEditor.test.tsx [2m([22m[2m12 tests[22m[2m)[22m[33m 3963[2mms[22m[39m
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709155614,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709155616,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w88_v3\",public"}
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

{"level":30,"time":1768709155640,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/variableResolver.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709155641,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mðŸ“Š Schema test_schema_w92_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

 [32mâœ“[39m tests/unit/utils/variableResolver.test.ts [2m([22m[2m20 tests[22m[2m)[22m[33m 4425[2mms[22m[39m
{"level":30,"time":1768709155679,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w88_v3\",public"}
{"level":30,"time":1768709155679,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

{"level":30,"time":1768709155724,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/WorkflowPatchService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709155725,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w95_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [32mâœ“[39m tests/unit/services/WorkflowPatchService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 4419[2mms[22m[39m
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w95_v3 (Reused: true)

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w94_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mðŸ“Š Schema test_schema_w93_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mðŸ“Š Schema test_schema_w90_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w94_v3 (Reused: true)

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709155913,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709155914,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w90_v3\",public"}
{"level":30,"time":1768709155975,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w90_v3\",public"}
{"level":30,"time":1768709155975,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

{"level":30,"time":1768709156177,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/docxRenderer2.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709156178,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mðŸ“Š Schema test_schema_w95_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

 [32mâœ“[39m tests/unit/services/docxRenderer2.test.ts [2m([22m[2m27 tests[22m[2m)[22m[33m 5069[2mms[22m[39m
[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mðŸ“Š Schema test_schema_w94_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w97_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w97_v3 (Reused: true)

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w88_v3, public
âœ… Enforced search_path: test_schema_w88_v3, public

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w98_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w98_v3 (Reused: true)

[90mstderr[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w62_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709156663,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709156664,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w92_v3\",public"}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w62_v3 (Reused: true)

{"level":30,"time":1768709156720,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w92_v3\",public"}
{"level":30,"time":1768709156720,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709156776,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709156777,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w93_v3\",public"}
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w90_v3, public
âœ… Enforced search_path: test_schema_w90_v3, public

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mðŸ“Š Schema test_schema_w97_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

{"level":30,"time":1768709156838,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w93_v3\",public"}
{"level":30,"time":1768709156838,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w100_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstderr[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w100_v3 (Reused: true)

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mðŸ“Š Schema test_schema_w98_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709157072,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709157073,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w95_v3\",public"}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w91_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768709157129,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w95_v3\",public"}
{"level":30,"time":1768709157129,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w91_v3 (Reused: true)

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709157178,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709157179,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w94_v3\",public"}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mðŸ“Š Schema test_schema_w62_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709157209,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709157210,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w62_v3\",public"}
{"level":30,"time":1768709157234,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w94_v3\",public"}
{"level":30,"time":1768709157234,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709157268,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w62_v3\",public"}
{"level":30,"time":1768709157268,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mðŸ“Š Schema test_schema_w100_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w92_v3, public
âœ… Enforced search_path: test_schema_w92_v3, public

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mðŸ“Š Schema test_schema_w91_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstderr[2m | tests/integration/intake.portal.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w93_v3, public
âœ… Enforced search_path: test_schema_w93_v3, public

[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709157658,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709157659,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w97_v3\",public"}
{"level":30,"time":1768709157710,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w97_v3\",public"}
{"level":30,"time":1768709157710,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709157728,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/common/Breadcrumbs.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709157729,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

 [32mâœ“[39m tests/ui/common/Breadcrumbs.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 3957[2mms[22m[39m
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709157844,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709157849,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w98_v3\",public"}
{"level":30,"time":1768709157904,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w98_v3\",public"}
{"level":30,"time":1768709157904,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w95_v3, public
âœ… Enforced search_path: test_schema_w95_v3, public

[90mstderr[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w94_v3, public
âœ… Enforced search_path: test_schema_w94_v3, public

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709158105,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w62_v3, public
âœ… Enforced search_path: test_schema_w62_v3, public

{"level":30,"time":1768709158106,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w100_v3\",public"}
{"level":30,"time":1768709158153,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w100_v3\",public"}
{"level":30,"time":1768709158153,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/integration/api-docs.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/unit/ai.service.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768709158332,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api-docs.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709158333,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w99_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709158388,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709158389,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w91_v3\",public"}
{"level":30,"time":1768709158407,"env":"test","module":"workflow-quality-validator","overall":99,"breakdown":{"aliases":100,"types":100,"structure":100,"ux":95,"completeness":100,"validation":100},"issuesCount":1,"passed":true,"msg":"Workflow quality validation completed"}
{"level":30,"time":1768709158407,"env":"test","module":"workflow-generation-service","duration":3,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":99,"qualityBreakdown":{"aliases":100,"types":100,"structure":100,"ux":95,"completeness":100,"validation":100},"qualityPassed":true,"issuesCount":1,"msg":"AI workflow generation succeeded"}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w99_v3 (Reused: true)

{"level":30,"time":1768709158443,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w91_v3\",public"}
{"level":30,"time":1768709158443,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709158509,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/schema/collections.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709158509,"env":"test","msg":"DB: pool closed."}
{"level":50,"time":1768709158511,"env":"test","module":"workflow-generation-service","error":{"code":"VALIDATION_ERROR","message":"","retryable":false},"duration":1,"msg":"AI workflow generation failed"}
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w97_v3, public
âœ… Enforced search_path: test_schema_w97_v3, public

 [32mâœ“[39m tests/unit/schema/collections.test.ts [2m([22m[2m34 tests[22m[2m)[22m[33m 5099[2mms[22m[39m
{"level":50,"time":1768709158607,"env":"test","module":"workflow-generation-service","error":{"code":"VALIDATION_ERROR","message":"","retryable":false},"duration":1,"msg":"AI workflow generation failed"}
[90mstderr[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

 [32mâœ“[39m tests/integration/api-docs.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 8533[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w102_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w102_v3 (Reused: true)

{"level":50,"time":1768709158708,"env":"test","module":"workflow-generation-service","error":{"code":"VALIDATION_ERROR","message":"","retryable":false},"duration":1,"msg":"AI workflow generation failed"}
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w98_v3, public
âœ… Enforced search_path: test_schema_w98_v3, public

{"level":50,"time":1768709158801,"env":"test","module":"workflow-generation-service","error":{"status":429,"code":"rate_limit_exceeded"},"duration":0,"msg":"AI workflow generation failed"}
[90mstderr[2m | tests/unit/client/choice-utils.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mðŸ“Š Schema test_schema_w99_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

{"level":50,"time":1768709158904,"env":"test","module":"workflow-generation-service","error":{},"duration":0,"msg":"AI workflow generation failed"}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w100_v3, public
âœ… Enforced search_path: test_schema_w100_v3, public

{"level":30,"time":1768709159056,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/client/list-choice-options.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709159056,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/unit/captcha.service.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

 [32mâœ“[39m tests/unit/client/list-choice-options.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 4104[2mms[22m[39m
{"level":30,"time":1768709159101,"env":"test","module":"workflow-quality-validator","overall":100,"breakdown":{"aliases":100,"types":100,"structure":100,"ux":100,"completeness":100,"validation":100},"issuesCount":0,"passed":true,"msg":"Workflow quality validation completed"}
{"level":30,"time":1768709159101,"env":"test","module":"workflow-generation-service","duration":0,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":100,"qualityBreakdown":{"aliases":100,"types":100,"structure":100,"ux":100,"completeness":100,"validation":100},"qualityPassed":true,"issuesCount":0,"msg":"AI workflow generation succeeded"}
{"level":30,"time":1768709159114,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709159114,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/WorkflowChangeAnalyzer.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mðŸ“Š Schema test_schema_w102_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

 [32mâœ“[39m tests/unit/WorkflowChangeAnalyzer.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 3218[2mms[22m[39m
{"level":30,"time":1768709159190,"env":"test","module":"workflow-quality-validator","overall":96,"breakdown":{"aliases":100,"types":100,"structure":80,"ux":100,"completeness":90,"validation":100},"issuesCount":2,"passed":true,"msg":"Workflow quality validation completed"}
{"level":30,"time":1768709159190,"env":"test","module":"workflow-generation-service","duration":0,"sectionsCount":1,"rulesCount":0,"blocksCount":0,"qualityScore":96,"qualityBreakdown":{"aliases":100,"types":100,"structure":80,"ux":100,"completeness":90,"validation":100},"qualityPassed":true,"issuesCount":2,"msg":"AI workflow generation succeeded"}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w101_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w101_v3 (Reused: true)

{"level":30,"time":1768709159288,"env":"test","module":"workflow-suggestion-service","duration":0,"suggestionsCount":1,"msg":"AI binding suggestion succeeded"}
[90mstdout[2m | tests/unit/ai.service.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709159289,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709159289,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/ai.service.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 3866[2mms[22m[39m
{"level":50,"time":1768709159364,"env":"test","module":"intake-navigation","error":{},"pageId":"page1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating visibleIf condition"}
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w96_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768709159389,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/intake.portal.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709159390,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/intake.portal.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 4561[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w96_v3 (Reused: true)

{"level":50,"time":1768709159452,"env":"test","module":"intake-navigation","error":{},"pageId":"page1","condition":{"op":"invalid","left":null,"right":null},"msg":"Error evaluating skipIf condition"}
[90mstderr[2m | tests/unit/client/choice-utils.test.ts[2m > [22m[2mchoice-utils[2m > [22m[2mhandles missing content gracefully
[22m[39m[generateOptionsFromList] Invalid list data: [1mnull[22m

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w91_v3, public
âœ… Enforced search_path: test_schema_w91_v3, public

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w104_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w104_v3 (Reused: true)

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709159603,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709159604,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w99_v3\",public"}
[90mstderr[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768709159640,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/intakeNavigation.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709159641,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768709159652,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w99_v3\",public"}
{"level":30,"time":1768709159653,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mðŸ“Š Schema test_schema_w101_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

 [32mâœ“[39m tests/unit/services/intakeNavigation.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 4305[2mms[22m[39m
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768709159757,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/client/choice-utils.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709159758,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

 [32mâœ“[39m tests/unit/client/choice-utils.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 3601[2mms[22m[39m
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mðŸ“Š Schema test_schema_w96_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709159854,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709159856,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w96_v3\",public"}
{"level":30,"time":1768709159900,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/schema/documentEngine.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709159901,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709159907,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709159908,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w102_v3\",public"}
{"level":30,"time":1768709159911,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w96_v3\",public"}
{"level":30,"time":1768709159911,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w105_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [32mâœ“[39m tests/unit/schema/documentEngine.test.ts [2m([22m[2m33 tests[22m[2m)[22m[33m 4916[2mms[22m[39m
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w105_v3 (Reused: true)

{"level":30,"time":1768709159975,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w102_v3\",public"}
{"level":30,"time":1768709159975,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mðŸ“Š Schema test_schema_w104_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

{"level":30,"time":1768709160152,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/captcha.service.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709160152,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

 [32mâœ“[39m tests/unit/captcha.service.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 3711[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w107_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w107_v3 (Reused: true)

[90mstdout[2m | tests/ListTools.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mðŸ“Š Schema test_schema_w105_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w99_v3, public
âœ… Enforced search_path: test_schema_w99_v3, public

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/integration/metrics.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w109_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709160643,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709160644,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w101_v3\",public"}
[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w109_v3 (Reused: true)

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mðŸ“Š Schema test_schema_w107_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

{"level":30,"time":1768709160710,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w101_v3\",public"}
{"level":30,"time":1768709160710,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/components/datavault/SortableColumnHeader.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709160746,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709160747,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w96_v3, public
âœ… Enforced search_path: test_schema_w96_v3, public

[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w102_v3, public
âœ… Enforced search_path: test_schema_w102_v3, public

{"level":30,"time":1768709160804,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK initialized successfully"}
 [32mâœ“[39m tests/unit/components/datavault/SortableColumnHeader.test.tsx [2m([22m[2m10 tests[22m[2m)[22m[33m 4086[2mms[22m[39m
{"level":30,"time":1768709160804,"env":"test","module":"telemetry","msg":"Prometheus metrics initialized"}
{"level":30,"time":1768709160807,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
[90mstderr[2m | tests/integration/datavault.routes.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768709160854,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK shut down successfully"}
[90mstdout[2m | tests/ListTools.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

[90mstderr[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709160941,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709160942,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w104_v3\",public"}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w106_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768709160999,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w104_v3\",public"}
{"level":30,"time":1768709160999,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w111_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w106_v3 (Reused: true)

{"level":30,"time":1768709161031,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK initialized successfully"}
{"level":30,"time":1768709161031,"env":"test","module":"telemetry","msg":"Prometheus metrics initialized"}
{"level":30,"time":1768709161031,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":40,"time":1768709161037,"env":"test","module":"metrics-routes","ip":"::ffff:127.0.0.1","msg":"Unauthorized metrics access attempt"}
{"level":30,"time":1768709161048,"env":"test","module":"telemetry","msg":"OpenTelemetry SDK shut down successfully"}
[90mstdout[2m | tests/integration/metrics.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709161050,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709161050,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w111_v3 (Reused: true)

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mðŸ“Š Schema test_schema_w109_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

 [32mâœ“[39m tests/integration/metrics.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 3046[2mms[22m[39m
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mðŸ“Š Schema test_schema_w106_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709161435,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709161436,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w106_v3\",public"}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mðŸ“Š Schema test_schema_w111_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w112_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768709161488,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w106_v3\",public"}
{"level":30,"time":1768709161488,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mâœ… Set default search_path for database: test_schema_w101_v3, public
âœ… Enforced search_path: test_schema_w101_v3, public

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w112_v3 (Reused: true)

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709161575,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709161576,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w107_v3\",public"}
{"level":30,"time":1768709161624,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w107_v3\",public"}
{"level":30,"time":1768709161624,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/ListTools.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w110_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w104_v3, public
âœ… Enforced search_path: test_schema_w104_v3, public

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709161840,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709161840,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w109_v3\",public"}
[90mstdout[2m | tests/ListTools.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w110_v3 (Reused: true)

{"level":30,"time":1768709161876,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w109_v3\",public"}
{"level":30,"time":1768709161876,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w103_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstderr[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w108_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w103_v3 (Reused: true)

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mðŸ“Š Schema test_schema_w112_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w108_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w114_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709162100,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/validation/Validator.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709162101,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709162101,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w111_v3\",public"}
{"level":30,"time":1768709162101,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/shared/validation/Validator.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 3815[2mms[22m[39m
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w114_v3 (Reused: true)

{"level":30,"time":1768709162143,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w111_v3\",public"}
{"level":30,"time":1768709162143,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w105_v3, public
âœ… Enforced search_path: test_schema_w105_v3, public

[90mstdout[2m | tests/ListTools.test.ts
[22m[39mðŸ“Š Schema test_schema_w110_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709162254,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709162255,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w110_v3\",public"}
[90mstderr[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768709162291,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w110_v3\",public"}
{"level":30,"time":1768709162291,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w106_v3, public
âœ… Enforced search_path: test_schema_w106_v3, public

{"level":30,"time":1768709162334,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/datavault/TemplateCard.test.tsx
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mðŸ“Š Schema test_schema_w103_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709162335,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768709162338,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709162338,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w103_v3\",public"}
{"level":30,"time":1768709162387,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w103_v3\",public"}
{"level":30,"time":1768709162387,"env":"test","msg":"DB: initialized flag set."}
 [32mâœ“[39m tests/ui/datavault/TemplateCard.test.tsx [2m([22m[2m6 tests[22m[2m)[22m[33m 3557[2mms[22m[39m
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mðŸ“Š Schema test_schema_w108_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709162404,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709162405,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w108_v3\",public"}
[90mstderr[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w113_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w107_v3, public
âœ… Enforced search_path: test_schema_w107_v3, public

{"level":30,"time":1768709162451,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w108_v3\",public"}
{"level":30,"time":1768709162451,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w113_v3 (Reused: true)

[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709162507,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709162508,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w112_v3\",public"}
{"level":30,"time":1768709162539,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w112_v3\",public"}
{"level":30,"time":1768709162539,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mðŸ“Š Schema test_schema_w114_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstderr[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w109_v3, public
âœ… Enforced search_path: test_schema_w109_v3, public

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstderr[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w115_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768709162853,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/blocks/SendDataBlockEditorRouting.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709162853,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mðŸ“Š Schema test_schema_w113_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709162883,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709162884,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w113_v3\",public"}
 [32mâœ“[39m tests/ui/blocks/SendDataBlockEditorRouting.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 3708[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w115_v3 (Reused: true)

[90mstdout[2m | tests/unit/BlockRunner.validate.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709162926,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w113_v3\",public"}
{"level":30,"time":1768709162927,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w111_v3, public
âœ… Enforced search_path: test_schema_w111_v3, public

 [32mâœ“[39m tests/unit/BlockRunner.validate.test.ts [2m([22m[2m7 tests[22m[2m)[22m[33m 3378[2mms[22m[39m
[90mstderr[2m | tests/unit/services/AIService.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/ListTools.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w110_v3, public
âœ… Enforced search_path: test_schema_w110_v3, public

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w116_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768709163183,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709163184,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w103_v3, public
âœ… Enforced search_path: test_schema_w103_v3, public

[90mstderr[2m | tests/ListTools.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/WorkflowOptimizationService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w116_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mreviseWorkflow should delegate to revision service
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mWorkflow Generation[2m > [22m[2mgenerateWorkflow should return a generated workflow
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w108_v3, public
âœ… Enforced search_path: test_schema_w108_v3, public

 [32mâœ“[39m tests/unit/WorkflowOptimizationService.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 2986[2mms[22m[39m
[90mstderr[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768709163289,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/shared/validation/stepConfigSchemas.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709163289,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mðŸ“Š Schema test_schema_w115_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

 [32mâœ“[39m tests/unit/shared/validation/stepConfigSchemas.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 3464[2mms[22m[39m
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mWorkflow Suggestions[2m > [22m[2msuggestWorkflowImprovements should return suggestions
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstderr[2m | tests/integration/branding.routes.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/ui/builder.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709163357,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w112_v3, public
âœ… Enforced search_path: test_schema_w112_v3, public

{"level":30,"time":1768709163358,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w114_v3\",public"}
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

{"level":30,"time":1768709163415,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w114_v3\",public"}
{"level":30,"time":1768709163415,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mWorkflow Suggestions[2m > [22m[2msuggestTemplateBindings should return bindings
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstderr[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mWorkflow Suggestions[2m > [22m[2msuggestValues should return values
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

{"level":30,"time":1768709163565,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.routes.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709163566,"env":"test","msg":"DB: pool closed."}
{"level":40,"time":1768709163571,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mðŸ“Š Schema test_schema_w116_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mLogic Analysis[2m > [22m[2mgenerateLogic should return logic rules
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

{"level":40,"time":1768709163669,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
 [32mâœ“[39m tests/integration/datavault.routes.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 4567[2mms[22m[39m
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mLogic Analysis[2m > [22m[2mdebugLogic should return issues
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

{"level":40,"time":1768709163763,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w113_v3, public
âœ… Enforced search_path: test_schema_w113_v3, public

[90mstdout[2m | tests/unit/services/AIService.test.ts[2m > [22m[2mAIService Unit Tests[2m > [22m[2mLogic Analysis[2m > [22m[2mvisualizeLogic should return graph data
[22m[39mTest Setup: Initializing AIService
Test Setup: AIService initialized successfully

{"level":30,"time":1768709163808,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/AIService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709163808,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w117_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [32mâœ“[39m tests/unit/services/AIService.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 3210[2mms[22m[39m
{"level":40,"time":1768709163856,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w117_v3 (Reused: true)

[90mstderr[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":40,"time":1768709163947,"env":"test","module":"enhanced-sandbox","error":{"code":"MODULE_NOT_FOUND","requireStack":["C:\\Users\\scoot\\poll\\VaultLogic\\node_modules\\isolated-vm\\isolated-vm.js"]},"msg":"isolated-vm not found, falling back to node 'vm' module"}
[90mstdout[2m | tests/unit/isolatedVmBridge.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709163954,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709163954,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/isolatedVmBridge.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 2929[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts[2m > [22m[2mDatavaultColumnsService[2m > [22m[2mgetColumns[2m > [22m[2mshould throw 404 if table not found
[22m[39m[DEBUG] Table not found: 660e8400-e29b-41d4-a716-446655440001

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709164143,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709164147,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w115_v3\",public"}
[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould skip question when condition is false
[22m[39m[DEBUG Question] Node q1 executed. Key: has_code, Value: false. Context keys: 3

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }

{"level":30,"time":1768709164205,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w115_v3\",public"}
{"level":30,"time":1768709164205,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w114_v3, public
âœ… Enforced search_path: test_schema_w114_v3, public

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould execute question when condition is true
[22m[39m[DEBUG Question] Node q1 executed. Key: has_code, Value: true. Context keys: 4

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould execute question when condition is true
[22m[39m[DEBUG Question] Node q2 executed. Key: code, Value: ABC123. Context keys: 5

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mðŸ“Š Schema test_schema_w117_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstderr[2m | tests/ui/builder.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould skip compute node when condition is false
[22m[39m[DEBUG Question] Node q1 executed. Key: amount, Value: 0. Context keys: 3

[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709164372,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709164373,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w116_v3\",public"}
[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould execute compute node when condition is true
[22m[39m[DEBUG Question] Node q1 executed. Key: amount, Value: 100. Context keys: 3

{"level":30,"time":1768709164426,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w116_v3\",public"}
{"level":30,"time":1768709164426,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould handle complex workflow with multiple conditions
[22m[39m[DEBUG Question] Node q1 executed. Key: has_code, Value: false. Context keys: 4

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mConditional Execution[2m > [22m[2mshould handle complex workflow with multiple conditions
[22m[39m[DEBUG Question] Node q3 executed. Key: amount, Value: 1000. Context keys: 5

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âœ… audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709164609,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/CollectionFieldService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709164610,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/services/CollectionFieldService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 4026[2mms[22m[39m
{"level":30,"time":1768709164704,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ui/builder.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709164704,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/ui/builder.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 2991[2mms[22m[39m
{"level":40,"time":1768709164785,"env":"test","sourceListVar":"nonexistent_list","inputKey":"nonexistent_list","msg":"Input list not found, treating as empty array"}
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w118_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

{"level":30,"time":1768709164883,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/ListTools.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709164883,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w118_v3 (Reused: true)

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

 [32mâœ“[39m tests/ListTools.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 3449[2mms[22m[39m
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w119_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w119_v3 (Reused: true)

[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w115_v3, public
âœ… Enforced search_path: test_schema_w115_v3, public

[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mDebug Mode[2m > [22m[2mshould return trace when debug is enabled
[22m[39m[DEBUG Question] Node q1 executed. Key: name, Value: John. Context keys: 3

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w120_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709165044,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

{"level":30,"time":1768709165045,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w117_v3\",public"}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w120_v3 (Reused: true)

[90mstderr[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768709165098,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w117_v3\",public"}
{"level":30,"time":1768709165098,"env":"test","msg":"DB: initialized flag set."}
[90mstderr[2m | tests/unit/engine.run-conditions.test.ts[2m > [22m[2mEngine - Conditional Execution[2m > [22m[2mDebug Mode[2m > [22m[2mshould not return trace when debug is disabled
[22m[39m[DEBUG Question] Node q1 executed. Key: name, Value: John. Context keys: 3

{"level":30,"time":1768709165110,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine.run-conditions.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709165111,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

 [32mâœ“[39m tests/unit/engine.run-conditions.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 3604[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return trace when debug is enabled [33m 431[2mms[22m[39m
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w116_v3, public
âœ… Enforced search_path: test_schema_w116_v3, public

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mðŸ“Š Schema test_schema_w118_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709165299,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709165300,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w118_v3\",public"}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w121_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768709165323,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DatavaultColumnsService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709165323,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709165342,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w118_v3\",public"}
{"level":30,"time":1768709165342,"env":"test","msg":"DB: initialized flag set."}
 [32mâœ“[39m tests/unit/services/DatavaultColumnsService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 3242[2mms[22m[39m
{"level":30,"time":1768709165365,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/branding.routes.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709165366,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w121_v3 (Reused: true)

{"level":30,"time":1768709165374,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709165375,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/shared/validation/PageValidator.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mðŸ“Š Schema test_schema_w119_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709165392,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709165393,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w119_v3\",public"}
 [32mâœ“[39m tests/unit/shared/validation/PageValidator.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2892[2mms[22m[39m
 [32mâœ“[39m tests/integration/branding.routes.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 3839[2mms[22m[39m
{"level":30,"time":1768709165441,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w119_v3\",public"}
{"level":30,"time":1768709165441,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w124_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w124_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mðŸ“Š Schema test_schema_w120_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709165504,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709165505,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w120_v3\",public"}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w122_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768709165553,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w120_v3\",public"}
{"level":30,"time":1768709165553,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w122_v3 (Reused: true)

{"level":30,"time":1768709165602,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/workflow/QueryBlock.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709165602,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/workflow/QueryBlock.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2835[2mms[22m[39m
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mðŸ“Š Schema test_schema_w121_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709165791,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709165792,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w121_v3\",public"}
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768709165843,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w121_v3\",public"}
{"level":30,"time":1768709165843,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mðŸ“Š Schema test_schema_w124_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w117_v3, public
âœ… Enforced search_path: test_schema_w117_v3, public

[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mðŸ“Š Schema test_schema_w122_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709166009,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709166010,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w122_v3\",public"}
[90mstderr[2m | tests/unit/engine/Performance.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768709166066,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w122_v3\",public"}
{"level":30,"time":1768709166066,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w118_v3, public
âœ… Enforced search_path: test_schema_w118_v3, public

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w123_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w123_v3 (Reused: true)

[90mstderr[2m | tests/services/BrandingService.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w119_v3, public
âœ… Enforced search_path: test_schema_w119_v3, public

{"level":30,"time":1768709166324,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/engine/Performance.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709166324,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w125_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w130_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [32mâœ“[39m tests/unit/engine/Performance.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2879[2mms[22m[39m
[90mstderr[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w120_v3, public
âœ… Enforced search_path: test_schema_w120_v3, public

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w125_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w130_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstderr[2m | tests/unit/services/RecordService.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mðŸ“Š Schema test_schema_w123_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709166622,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709166623,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w123_v3\",public"}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709166643,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709166644,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w124_v3\",public"}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w126_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w121_v3, public
âœ… Enforced search_path: test_schema_w121_v3, public

{"level":30,"time":1768709166661,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w123_v3\",public"}
{"level":30,"time":1768709166661,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709166677,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w124_v3\",public"}
{"level":30,"time":1768709166677,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w126_v3 (Reused: true)

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstderr[2m | tests/integration/analytics_preservation.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mðŸ“Š Schema test_schema_w130_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mðŸ“Š Schema test_schema_w125_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709166809,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709166809,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w125_v3\",public"}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }

{"level":30,"time":1768709166844,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w125_v3\",public"}
{"level":30,"time":1768709166844,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w122_v3, public
âœ… Enforced search_path: test_schema_w122_v3, public

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w127_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w127_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w128_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w129_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstderr[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w128_v3 (Reused: true)

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w129_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mðŸ“Š Schema test_schema_w126_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709167102,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709167103,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w126_v3\",public"}
{"level":30,"time":1768709167136,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w126_v3\",public"}
{"level":30,"time":1768709167136,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w131_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w131_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709167306,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709167306,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w130_v3\",public"}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mðŸ“Š Schema test_schema_w127_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709167331,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709167332,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w127_v3\",public"}
{"level":30,"time":1768709167342,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w130_v3\",public"}
{"level":30,"time":1768709167342,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709167365,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w127_v3\",public"}
{"level":30,"time":1768709167365,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mðŸ“Š Schema test_schema_w128_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709167436,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709167437,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w128_v3\",public"}
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mðŸ“Š Schema test_schema_w129_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709167448,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709167449,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w129_v3\",public"}
{"level":30,"time":1768709167472,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w128_v3\",public"}
{"level":30,"time":1768709167472,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w123_v3, public
âœ… Enforced search_path: test_schema_w123_v3, public

{"level":30,"time":1768709167483,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w129_v3\",public"}
{"level":30,"time":1768709167483,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w124_v3, public
âœ… Enforced search_path: test_schema_w124_v3, public

{"level":30,"time":1768709167508,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/analytics_preservation.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709167508,"env":"test","msg":"DB: pool closed."}
 [31mâ¯[39m tests/integration/analytics_preservation.test.ts [2m([22m[2m1 test[22m[2m | [22m[31m1 failed[39m[2m)[22m[33m 2573[2mms[22m[39m
[31m     [31mÃ—[31m should preserve lifetime user count when a user is deleted[39m[33m 744[2mms[22m[39m
[90mstderr[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mðŸ“Š Schema test_schema_w131_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709167591,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709167592,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w131_v3\",public"}
{"level":30,"time":1768709167629,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w131_v3\",public"}
{"level":30,"time":1768709167630,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w125_v3, public
âœ… Enforced search_path: test_schema_w125_v3, public

[90mstderr[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768709167766,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/DocumentTemplateRepository.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709167767,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768709167789,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/services/BrandingService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709167790,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/repositories/DocumentTemplateRepository.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 3226[2mms[22m[39m
 [32mâœ“[39m tests/services/BrandingService.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 3299[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1768709167870,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/utils/conditionalLogic-simple.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709167871,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/utils/conditionalLogic-simple.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2790[2mms[22m[39m
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w126_v3, public
âœ… Enforced search_path: test_schema_w126_v3, public

[90mstderr[2m | tests/unit/services/StepService.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768709168106,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/RecordService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709168106,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w130_v3, public
âœ… Enforced search_path: test_schema_w130_v3, public

 [32mâœ“[39m tests/unit/services/RecordService.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 3451[2mms[22m[39m
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w127_v3, public
âœ… Enforced search_path: test_schema_w127_v3, public

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstderr[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstderr[2m | tests/unit/services/CollectionService.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w129_v3, public
âœ… Enforced search_path: test_schema_w129_v3, public

[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w128_v3, public
âœ… Enforced search_path: test_schema_w128_v3, public

{"level":30,"time":1768709168303,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DocumentTemplateService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709168304,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

 [32mâœ“[39m tests/unit/services/DocumentTemplateService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 3121[2mms[22m[39m
[90mstderr[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstderr[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768709168436,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/RunExecutionCoordinator.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709168437,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w131_v3, public
âœ… Enforced search_path: test_schema_w131_v3, public

 [32mâœ“[39m tests/unit/services/RunExecutionCoordinator.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 2470[2mms[22m[39m
[90mstderr[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[DEBUG] BaseRepository.update datavault_columns: id=770e8400-e29b-41d4-a716-446655440002, updates={"name":"Mobile Phone","required":true,"updatedAt":"2026-01-18T04:06:08.588Z"}
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

{"level":30,"time":1768709168975,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/repositories/DatavaultColumnsRepository.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709168976,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/repositories/DatavaultColumnsRepository.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 3029[2mms[22m[39m
{"level":30,"time":1768709169050,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/datavault.api-tokens.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709169051,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w133_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ“¡ add observability to secrets: https://dotenvx.com/ops

 [32mâœ“[39m tests/integration/datavault.api-tokens.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 3265[2mms[22m[39m
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w133_v3 (Reused: true)

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

{"level":30,"time":1768709169371,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/StepService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709169372,"env":"test","msg":"DB: pool closed."}
[DEBUG] BaseRepository.update datavault_tables: id=660e8400-e29b-41d4-a716-446655440001, updates={"name":"Updated Table","description":"Updated description","updatedAt":"2026-01-18T04:06:09.379Z"}
 [32mâœ“[39m tests/unit/services/StepService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 3109[2mms[22m[39m
[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  suppress all logs with { quiet: true }

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w135_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768709169538,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DatavaultTablesService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709169538,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mðŸ“Š Schema test_schema_w133_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w135_v3 (Reused: true)

{"level":30,"time":1768709169552,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709169553,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w133_v3\",public"}
 [32mâœ“[39m tests/unit/services/DatavaultTablesService.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 2920[2mms[22m[39m
[90mstdout[2m | tests/services/EmailTemplateMetadataService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709169599,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709169600,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/CollectionService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709169604,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w133_v3\",public"}
{"level":30,"time":1768709169604,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709169605,"env":"test","msg":"DB: closing pool..."}
 [32mâœ“[39m tests/services/EmailTemplateMetadataService.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 2996[2mms[22m[39m
{"level":30,"time":1768709169606,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768709169656,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709169657,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/services/CollectionService.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 3089[2mms[22m[39m
[90mstdout[2m | tests/unit/repositories/DatavaultTablesRepository.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w132_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

 [32mâœ“[39m tests/unit/repositories/DatavaultTablesRepository.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 2886[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w132_v3 (Reused: true)

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mðŸ“Š Schema test_schema_w135_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709169978,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709169979,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w135_v3\",public"}
{"level":30,"time":1768709170038,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w135_v3\",public"}
{"level":30,"time":1768709170038,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mðŸ“Š Schema test_schema_w132_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709170152,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709170153,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w132_v3\",public"}
[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

{"level":30,"time":1768709170224,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w132_v3\",public"}
{"level":30,"time":1768709170224,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ‘¥ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w137_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w136_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w137_v3 (Reused: true)

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w136_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w142_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w142_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w133_v3, public
âœ… Enforced search_path: test_schema_w133_v3, public

[90mstderr[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mðŸ“Š Schema test_schema_w137_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709170727,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709170728,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w137_v3\",public"}
[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mðŸ“Š Schema test_schema_w136_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709170775,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709170777,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w137_v3\",public"}
{"level":30,"time":1768709170777,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768709170775,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w136_v3\",public"}
[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w145_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mðŸ“Š Schema test_schema_w142_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

{"level":30,"time":1768709170831,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w136_v3\",public"}
{"level":30,"time":1768709170831,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w145_v3 (Reused: true)

[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w135_v3, public
âœ… Enforced search_path: test_schema_w135_v3, public

[90mstderr[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w141_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w132_v3, public
âœ… Enforced search_path: test_schema_w132_v3, public

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w141_v3 (Reused: true)

[90mstderr[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mðŸ“Š Schema test_schema_w145_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstderr[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): Error: [vitest] No "closeDatabase" export is defined on the "../../../server/db" mock. Did you forget to return it from "vi.mock"?
If you need to partially mock a module, you can use "importOriginal" helper inside:

    at VitestMocker.createError [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:311:17[90m)[39m
    at Object.get [90m(file:///C:/Users/scoot/poll/VaultLogic/[39mnode_modules/[4mvitest[24m/dist/chunks/startModuleRunner.DpqpB8k3.js:384:16[90m)[39m
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:177:34
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m {
  codeFrame: [32m'vi.mock(import("../../../server/db"), async (importOriginal) => {\n'[39m +
    [32m'  const actual = await importOriginal()\n'[39m +
    [32m'  return {\n'[39m +
    [32m'    ...actual,\n'[39m +
    [32m'    // your mocked methods\n'[39m +
    [32m'  }\n'[39m +
    [32m'})'[39m
}

{"level":30,"time":1768709171263,"env":"test","module":"write-runner","operation":"write_start","mode":"create","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"create","columnMappings":[{"columnId":"col-first","value":"{{ firstName }}"},{"columnId":"col-last","value":"Doe"},{"columnId":"col-age","value":"{{ age }}"}]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
{"level":30,"time":1768709171272,"env":"test","module":"write-runner","operation":"write_start","mode":"create","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"create","columnMappings":[]},"tableId":"table-users","preview":true,"msg":"Starting write execution"}
[90mstdout[2m | tests/unit/writes/WriteRunner.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709171272,"env":"test","module":"write-runner","operation":"write_preview_simulated","values":{},"msg":"Simulating write in preview mode"}
{"level":30,"time":1768709171274,"env":"test","module":"write-runner","operation":"write_start","mode":"update","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"test@example.com","columnMappings":[{"columnId":"col-status","value":"Active"}]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
{"level":30,"time":1768709171275,"env":"test","module":"write-runner","operation":"write_start","mode":"update","config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"missing@example.com","columnMappings":[]},"tableId":"table-users","preview":false,"msg":"Starting write execution"}
{"level":50,"time":1768709171276,"env":"test","module":"write-runner","error":{},"config":{"tableId":"table-users","dataSourceId":"ds-native","mode":"update","primaryKeyColumnId":"col-email","primaryKeyValue":"missing@example.com","columnMappings":[]},"msg":"Write execution failed"}
 [32mâœ“[39m tests/unit/writes/WriteRunner.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 861[2mms[22m[39m
{"level":30,"time":1768709171415,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/services/DataSourceService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709171416,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/services/DataSourceService.test.ts [2m([22m[2m9 tests[22m[2m)[22m[33m 2703[2mms[22m[39m
{"level":30,"time":1768709171469,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/lib/queries/QueryRunner.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709171470,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mðŸ“Š Schema test_schema_w141_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

 [32mâœ“[39m tests/unit/lib/queries/QueryRunner.test.ts [2m([22m[2m5 tests[22m[2m)[22m[33m 2347[2mms[22m[39m
[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w144_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w143_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w137_v3, public
âœ… Enforced search_path: test_schema_w137_v3, public

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w140_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w144_v3 (Reused: true)

[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w136_v3, public
âœ… Enforced search_path: test_schema_w136_v3, public

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w143_v3 (Reused: true)

[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w140_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w146_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstderr[2m | tests/unit/api.ai.revise.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w138_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768709171720,"env":"test","workflowId":"123e4567-e89b-12d3-a456-426614174000","userId":"user-123","sectionsCount":2,"stepsCount":0,"logicRulesCount":1,"msg":"getWorkflowWithDetails called"}
[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w146_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/WorkflowService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstderr[2m | tests/unit/api.ai.logic.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w138_v3 (Reused: true)

 [32mâœ“[39m tests/unit/services/WorkflowService.test.ts [2m([22m[2m15 tests[22m[2m)[22m[33m 1776[2mms[22m[39m
       [33m[2mâœ“[22m[39m should return workflow if user is the creator [33m 899[2mms[22m[39m
{"level":30,"time":1768709171805,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768709171838,"env":"test","module":"ai-controller","userId":"user-123","workflowId":"123e4567-e89b-12d3-a456-426614174000","msg":"AI workflow revision job enqueued"}
{"level":30,"time":1768709171840,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w139_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

{"level":30,"time":1768709171875,"env":"test","module":"ai-controller","userId":"user-123","workflowId":"123e4567-e89b-12d3-a456-426614174000","descriptionLength":26,"msg":"AI logic generation requested"}
[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768709171876,"env":"test","module":"ai-controller","userId":"user-123","workflowId":"123e4567-e89b-12d3-a456-426614174000","duration":2,"changeCount":0,"msg":"AI logic generation succeeded"}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w139_v3 (Reused: true)

{"level":30,"time":1768709171947,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":50,"time":1768709171954,"env":"test","module":"ai-controller","error":{"issues":[{"validation":"uuid","code":"invalid_string","message":"Invalid uuid","path":["workflowId"]},{"code":"invalid_type","expected":"object","received":"undefined","path":["currentWorkflow"],"message":"Required"},{"code":"invalid_type","expected":"string","received":"undefined","path":["userInstruction"],"message":"Required"}],"name":"ZodError"},"msg":"Failed to enqueue AI revision job"}
[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768709171958,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/api.ai.revise.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709171959,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768709171994,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
 [32mâœ“[39m tests/unit/api.ai.revise.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 2085[2mms[22m[39m
[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mðŸ“Š Schema test_schema_w144_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/EmailTemplateMetadataService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mðŸ“Š Schema test_schema_w143_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

 [32mâœ“[39m tests/unit/services/EmailTemplateMetadataService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 879[2mms[22m[39m
[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mðŸ“Š Schema test_schema_w140_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709172106,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709172107,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w140_v3\",public"}
{"level":30,"time":1768709172113,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768709172122,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/api.ai.logic.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709172123,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mðŸ“Š Schema test_schema_w146_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

{"level":30,"time":1768709172161,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w140_v3\",public"}
{"level":30,"time":1768709172161,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/services/DatavaultReferenceColumns.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mðŸ“Š Schema test_schema_w138_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709172185,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709172186,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w138_v3\",public"}
[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”‘ add access controls to secrets: https://dotenvx.com/ops

 [32mâœ“[39m tests/unit/services/DatavaultReferenceColumns.test.ts [2m([22m[2m10 tests[22m[2m)[22m[33m 867[2mms[22m[39m
 [32mâœ“[39m tests/unit/api.ai.logic.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2216[2mms[22m[39m
[90mstdout[2m | tests/unit/services/PortalAuthService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709172244,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w138_v3\",public"}
{"level":30,"time":1768709172244,"env":"test","msg":"DB: initialized flag set."}
 [32mâœ“[39m tests/unit/services/PortalAuthService.test.ts [2m([22m[2m42 tests[22m[2m)[22m[33m 1011[2mms[22m[39m
[90mstdout[2m | tests/integration/datavault.row-notes.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709172306,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709172307,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mðŸ“Š Schema test_schema_w139_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709172311,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709172312,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w139_v3\",public"}
{"level":30,"time":1768709172369,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w139_v3\",public"}
{"level":30,"time":1768709172369,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w149_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

 [32mâœ“[39m tests/integration/datavault.row-notes.test.ts [2m([22m[2m12 tests[22m[2m)[22m[33m 3039[2mms[22m[39m
[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w149_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: âš™ï¸  override existing env vars with { override: true }

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ› ï¸  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/unit/services/MfaService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops

 [32mâœ“[39m tests/unit/services/MfaService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 2165[2mms[22m[39m
[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mðŸ“Š Schema test_schema_w149_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

{"level":30,"time":1768709172882,"env":"test","msg":"External Send Completed","destination":"My Webhook","success":true,"status":200}
[90mstdout[2m | tests/unit/external/ExternalSendRunner.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709172890,"env":"test","msg":"Simulating External Send","destination":"Test","payload":{}}
[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ—‚ï¸ backup and recover secrets: https://dotenvx.com/ops

 [32mâœ“[39m tests/unit/external/ExternalSendRunner.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 856[2mms[22m[39m
[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w140_v3, public
âœ… Enforced search_path: test_schema_w140_v3, public

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w147_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w147_v3 (Reused: true)

[90mstderr[2m | tests/unit/debug_import.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w138_v3, public
âœ… Enforced search_path: test_schema_w138_v3, public

[90mstdout[2m | tests/unit/collab.server.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: ðŸ” prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768709173169,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/debug_import.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709173169,"env":"test","msg":"DB: pool closed."}
[90mstderr[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w139_v3, public
âœ… Enforced search_path: test_schema_w139_v3, public

 [32mâœ“[39m tests/unit/debug_import.test.ts [2m([22m[2m1 test[22m[2m)[22m[33m 1939[2mms[22m[39m
[90mstderr[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768709173328,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w148_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstderr[2m | tests/unit/debugging/Lineage.test.ts[2m > [22m[2mDebug & Lineage[2m > [22m[2mshould generate execution trace with lineage
[22m[39m[DEBUG Question] Node q1 executed. Key: userName, Value: Alice. Context keys: 3

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w148_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mðŸ“Š Schema test_schema_w147_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/workflow/PreviewExecution.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709173491,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768709173491,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/unit/services/BrandingService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709173531,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/unit/debugging/Lineage.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709173532,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/unit/services/BrandingService.test.ts [2m([22m[2m21 tests[22m[2m)[22m[33m 910[2mms[22m[39m
 [32mâœ“[39m tests/unit/workflow/PreviewExecution.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 2136[2mms[22m[39m
 [32mâœ“[39m tests/unit/debugging/Lineage.test.ts [2m([22m[2m2 tests[22m[2m)[22m[33m 2072[2mms[22m[39m
[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w153_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w153_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mðŸ“Š Schema test_schema_w148_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/DatavaultRowsService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/services/DatavaultRowsService.test.ts [2m([22m[2m8 tests[22m[2m)[22m[33m 868[2mms[22m[39m
[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w150_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w150_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w152_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w152_v3 (Reused: true)

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w151_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w151_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mðŸ“Š Schema test_schema_w153_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/Guardrail.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/services/Guardrail.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 851[2mms[22m[39m
[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w155_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/collab.server.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ” encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w155_v3 (Reused: true)

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w154_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/unit/collab.server.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: ðŸ”„ add secrets lifecycle management: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w154_v3 (Reused: true)

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mðŸ“Š Schema test_schema_w150_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

{"level":40,"time":1768709174423,"env":"test","hookId":"hook-1","hookName":"Hook 1","error":"Test error","msg":"LifecycleHookService: Hook execution failed"}
[90mstdout[2m | tests/unit/LifecycleHookService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":50,"time":1768709174426,"env":"test","error":{},"workflowId":"workflow-1","runId":"run-1","phase":"beforePage","msg":"LifecycleHookService: Failed to execute hooks for phase"}
{"level":30,"time":1768709174429,"env":"test","hookId":"hook-1","workflowId":"workflow-1","phase":"beforePage","msg":"LifecycleHookService: Created lifecycle hook"}
{"level":30,"time":1768709174434,"env":"test","hookId":"hook-1","workflowId":"workflow-1","msg":"LifecycleHookService: Updated lifecycle hook"}
{"level":30,"time":1768709174436,"env":"test","hookId":"hook-1","workflowId":"workflow-1","msg":"LifecycleHookService: Deleted lifecycle hook"}
 [32mâœ“[39m tests/unit/LifecycleHookService.test.ts [2m([22m[2m17 tests[22m[2m)[22m[33m 861[2mms[22m[39m
 [2m[90mâ†“[39m[22m tests/unit/collab.server.test.ts [2m([22m[2m14 tests[22m[2m | [22m[33m14 skipped[39m[2m)[22m
[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mðŸ“Š Schema test_schema_w152_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/AuditLogService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/services/AuditLogService.test.ts [2m([22m[2m11 tests[22m[2m)[22m[33m 871[2mms[22m[39m
[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mðŸ“Š Schema test_schema_w151_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/repositories/DatavaultRowsRepository.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/repositories/DatavaultRowsRepository.test.ts [2m([22m[2m13 tests[22m[2m)[22m[33m 855[2mms[22m[39m
[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mðŸ“Š Schema test_schema_w155_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/engine/FinalBlockSnapshot.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/engine/FinalBlockSnapshot.test.ts [2m([22m[2m3 tests[22m[2m)[22m[33m 826[2mms[22m[39m
[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mðŸ“Š Schema test_schema_w154_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mâš ï¸ DB module loaded but appears to be a mock. Skipping real DB setup.

[90mstdout[2m | tests/unit/services/AccountLockoutService.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

 [32mâœ“[39m tests/unit/services/AccountLockoutService.test.ts [2m([22m[2m23 tests[22m[2m)[22m[33m 859[2mms[22m[39m
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mâœ… OpenAPI specification loaded successfully

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39m[SchemaManager] Reusing existing isolated schema: test_schema_w134_v3
[SchemaManager] Processing URL: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech (Port: )
[SchemaManager] Removing -pooler from hostname: ep-gentle-leaf-ahsz38kq-pooler.c-3.us-east-1.aws.neon.tech
[SchemaManager] Switched to Direct Connection for schema isolation.
[SchemaManager] Final Connection String (Host): ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech
[SchemaManager] Final Connection String (Options): null

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mðŸ”’ Test Schema Isolated: test_schema_w134_v3 (Reused: true)

[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mðŸ“Š Schema test_schema_w134_v3 has 110 tables - skipping migrations
[SETUP] DATABASE_URL sent to db module: postgresql://neondb_owner:npg_LYP2cC3DhGsx@ep-gentle-leaf-ahsz38kq.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require

{"level":30,"time":1768709175945,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768709175946,"env":"test","msg":"DB: Configured on('connect') to set search_path=\"test_schema_w134_v3\",public"}
{"level":30,"time":1768709175993,"env":"test","msg":"DB: Wrapped transaction() and execute() to enforce search_path=\"test_schema_w134_v3\",public"}
{"level":30,"time":1768709175993,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mâœ… Set default search_path for database: test_schema_w134_v3, public
âœ… Enforced search_path: test_schema_w134_v3, public

[90mstderr[2m | tests/integration/api.ai.doc.test.ts
[22m[39mâš ï¸ Database initialization failed (ignoring for unit tests or mock scenarios): TypeError: Cannot read properties of undefined (reading '0')
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:218:74
[90m    at processTicksAndRejections (node:internal/process/task_queues:103:5)[39m

{"level":30,"time":1768709176867,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768709176888,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts[2m > [22m[2mAI Document Assistant API Integration Tests
[22m[39mðŸ“š API Documentation available at /api-docs

{"level":30,"time":1768709176877,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768709176878,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768709176883,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768709176883,"env":"test","msg":"[Routes] E-Signature routes registered at /api/esign"}
{"level":30,"time":1768709176888,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768709176888,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768709176888,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768709176888,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":40,"time":1768709176995,"env":"test","error":{},"msg":"Deterministic DOCX extraction failed"}
{"level":30,"time":1768709177286,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/api.ai.doc.test.ts
[22m[39mðŸ§¹ Cleaning up test environment...

{"level":30,"time":1768709177287,"env":"test","msg":"DB: pool closed."}
 [32mâœ“[39m tests/integration/api.ai.doc.test.ts [2m([22m[2m4 tests[22m[2m)[22m[33m 2139[2mms[22m[39m
Failed to parse file:///C:/Users/scoot/poll/VaultLogic/client/src/components/builder/cards/ChoiceCardEditor.tsx. Excluding it from coverage.
 Error [RollupError]: Expected ',', got 'UniversalBlock'
    at getRollupError (file:///C:/Users/scoot/poll/VaultLogic/node_modules/rollup/dist/es/shared/parseAst.js:401:41)
    at convertProgram (file:///C:/Users/scoot/poll/VaultLogic/node_modules/rollup/dist/es/shared/parseAst.js:1098:26)
    at parseAstAsync (file:///C:/Users/scoot/poll/VaultLogic/node_modules/rollup/dist/es/shared/parseAst.js:2084:106)
    at V8CoverageProvider.remapCoverage (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/coverage-v8/dist/provider.js:135:10)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/coverage-v8/dist/provider.js:121:23
    at async Promise.all (index 6)
    at V8CoverageProvider.getCoverageMapForUncoveredFiles (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/coverage-v8/dist/provider.js:111:4)
    at V8CoverageProvider.generateCoverage (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/coverage-v8/dist/provider.js:59:29)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/cli-api.BKg19Fvw.js:12546:23
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/cli-api.BKg19Fvw.js:12559:11 {
  code: 'PARSE_ERROR',
  pos: 1537
}

[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m[1m[41m Failed Suites 25 [49m[22m[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m

[41m[1m FAIL [22m[49m tests/integration/analytics_service.test.ts[2m > [22mAnalytics Service Integration
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, default, default, default, default, default, default, default, default, default)
params: user-kZctR7c8mnPBWBK9zgwkq,user-kZctR7c8mnPBWBK9zgwkq@test.com,2e71f649-6cec-40b3-907f-f83dd85b6ed2,admin,owner[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/analytics_service.test.ts:[2m38:9[22m[39m
    [90m 36| [39m        tenantId [33m=[39m tenant[33m.[39mid[33m;[39m
    [90m 37| [39m        userId [33m=[39m [32m`user-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m`[39m[33m;[39m
    [90m 38| [39m        await db.insert(users).values({ id: userId, email: `${userId}@â€¦
    [90m   | [39m        [31m^[39m
    [90m 39| [39m        const [p] = await db.insert(projects).values({ title: "P", namâ€¦
    [90m 40| [39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/analytics_service.test.ts:[2m38:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(2e71f649-6cec-40b3-907f-f83dd85b6ed2) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[1/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.dataSources.native.test.ts[2m > [22mData Sources API - Native Catalog
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/api.dataSources.native.test.ts:[2m20:15[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[2/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.dataSources.native.test.ts[2m > [22mData Sources API - Native Catalog
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/api.dataSources.native.test.ts:[2m30:19[22m[39m
    [90m 28| [39m
    [90m 29| [39m    [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 30| [39m        [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m                  [31m^[39m
    [90m 31| [39m    })[33m;[39m
    [90m 32| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[3/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.expression-validation.test.ts[2m > [22mExpression Validation API Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/api.expression-validation.test.ts:[2m20:11[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[4/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.expression-validation.test.ts[2m > [22mExpression Validation API Integration Tests
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/api.expression-validation.test.ts:[2m76:15[22m[39m
    [90m 74| [39m
    [90m 75| [39m  [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 76| [39m    [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m              [31m^[39m
    [90m 77| [39m  })[33m;[39m
    [90m 78| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[5/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.projects.test.ts[2m > [22mProjects API Integration Tests
[31m[1mError[22m: expected 201 "Created", got 500 "Internal Server Error"[39m
[36m [2mâ¯[22m tests/integration/api.projects.test.ts:[2m66:8[22m[39m
    [90m 64| [39m        lastName[33m:[39m [32m"User"[39m[33m,[39m
    [90m 65| [39m      })
    [90m 66| [39m      [33m.[39m[34mexpect[39m([34m201[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m 67| [39m
    [90m 68| [39m    authToken [33m=[39m registerResponse[33m.[39mbody[33m.[39mtoken[33m;[39m
[90m [2mâ¯[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2mâ¯[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2mâ¯[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2mâ¯[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m156:7[22m[39m
[90m [2mâ¯[22m Test.Request.callback node_modules/superagent/lib/node/index.js:[2m857:3[22m[39m
[90m [2mâ¯[22m node_modules/superagent/lib/node/index.js:[2m1102:18[22m[39m
[90m [2mâ¯[22m IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:[2m21:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[6/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.runs.docx.test.ts[2m > [22mRuns API - DOCX Generation Integration Tests
[31m[1mError[22m: expected 201 "Created", got 500 "Internal Server Error"[39m
[36m [2mâ¯[22m tests/integration/api.runs.docx.test.ts:[2m113:8[22m[39m
    [90m111| [39m      [33m.[39m[34mpost[39m([32m'/api/auth/register'[39m)
    [90m112| [39m      [33m.[39m[34msend[39m({ email[33m,[39m password[33m:[39m [32m'TestPassword123!@#Strong'[39m })
    [90m113| [39m      [33m.[39m[34mexpect[39m([34m201[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m114| [39m
    [90m115| [39m    authToken [33m=[39m registerResponse[33m.[39mbody[33m.[39mtoken[33m;[39m
[90m [2mâ¯[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2mâ¯[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2mâ¯[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2mâ¯[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m156:7[22m[39m
[90m [2mâ¯[22m Test.Request.callback node_modules/superagent/lib/node/index.js:[2m857:3[22m[39m
[90m [2mâ¯[22m node_modules/superagent/lib/node/index.js:[2m1102:18[22m[39m
[90m [2mâ¯[22m IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:[2m21:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[7/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.runs.graph.test.ts[2m > [22mStage 8: Runs API Integration Tests
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "email" = $6, "tenant_id" = $7, "role" = $8, "tenant_role" = $9
params: test-user-runs-stage8,test-runs-stage8-9WV-NZTAgfQfkqnnI-t3_@example.com,826f5a53-49c7-4327-897a-8f1eca896814,admin,owner,test-runs-stage8-9WV-NZTAgfQfkqnnI-t3_@example.com,826f5a53-49c7-4327-897a-8f1eca896814,admin,owner[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/api.runs.graph.test.ts:[2m123:5[22m[39m
    [90m121| [39m    userId [33m=[39m [32m"test-user-runs-stage8"[39m[33m;[39m
    [90m122| [39m
    [90m123| [39m    [35mawait[39m db[33m.[39m[34minsert[39m(schema[33m.[39musers)[33m.[39m[34mvalues[39m({
    [90m   | [39m    [31m^[39m
    [90m124| [39m      id[33m:[39m userId[33m,[39m
    [90m125| [39m      email[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/api.runs.graph.test.ts:[2m123:5[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(826f5a53-49c7-4327-897a-8f1eca896814) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w35_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[8/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.snapshots.test.ts[2m > [22mStage 13: Workflow Snapshots & Versioning
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, default, $3, $4, default, $5, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project for Snapshots,Test Project for Snapshots,test-user-id,417936e4-8616-4758-b49d-fb1088bc54b2,test-user-id[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/api.snapshots.test.ts:[2m143:27[22m[39m
    [90m141| [39m
    [90m142| [39m        [90m// Create project[39m
    [90m143| [39m        [35mconst[39m [project] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(schema[33m.[39mprojects)[33m.[39m[34mvalues[39m({
    [90m   | [39m                          [31m^[39m
    [90m144| [39m            title[33m:[39m [32m"Test Project for Snapshots"[39m[33m,[39m
    [90m145| [39m            name[33m:[39m [32m"Test Project for Snapshots"[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/api.snapshots.test.ts:[2m143:27[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 300, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(test-user-id) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w39_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[9/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.templates-runs.test.ts[2m > [22mTemplates and Runs API Integration Tests
[31m[1mError[22m: expected 200 "OK", got 403 "Forbidden"[39m
[36m [2mâ¯[22m tests/integration/api.templates-runs.test.ts:[2m81:8[22m[39m
    [90m 79| [39m      [33m.[39m[34mpost[39m([32m`/api/workflows/[39m[36m${[39mworkflowId[36m}[39m[32m/publish`[39m)
    [90m 80| [39m      [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mctx[33m.[39mauthToken[36m}[39m[32m`[39m)
    [90m 81| [39m      [33m.[39m[34mexpect[39m([34m200[39m)[33m;[39m
    [90m   | [39m       [31m^[39m
    [90m 82| [39m  })[33m;[39m
    [90m 83| [39m
[90m [2mâ¯[22m Test._assertStatus node_modules/supertest/lib/test.js:[2m309:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m365:13[22m[39m
[90m [2mâ¯[22m Test._assertFunction node_modules/supertest/lib/test.js:[2m342:13[22m[39m
[90m [2mâ¯[22m Test.assert node_modules/supertest/lib/test.js:[2m195:23[22m[39m
[90m [2mâ¯[22m localAssert node_modules/supertest/lib/test.js:[2m138:14[22m[39m
[90m [2mâ¯[22m node_modules/supertest/lib/test.js:[2m156:7[22m[39m
[90m [2mâ¯[22m Test.Request.callback node_modules/superagent/lib/node/index.js:[2m857:3[22m[39m
[90m [2mâ¯[22m node_modules/superagent/lib/node/index.js:[2m1102:18[22m[39m
[90m [2mâ¯[22m IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:[2m21:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[10/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.workflows.test.ts[2m > [22mWorkflows API Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m Module.setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/api.workflows.test.ts:[2m42:11[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[11/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.workflows.test.ts[2m > [22mWorkflows API Integration Tests
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/api.workflows.test.ts:[2m52:15[22m[39m
    [90m 50| [39m
    [90m 51| [39m  [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 52| [39m    [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m              [31m^[39m
    [90m 53| [39m  })[33m;[39m
    [90m 54| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[12/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/collections.e2e.test.ts[2m > [22mCollections System E2E Tests
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, default, $7, $8, $9, default, default, $10, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: test-user-collections-e2e,test-collections-e2e@example.com,Collections E2E Test User,Collections,E2E Test User,e562dfe9-d35d-496e-9e4e-6695ec9dbed7,owner,local,easy,[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/collections.e2e.test.ts:[2m34:20[22m[39m
    [90m 32| [39m
    [90m 33| [39m    [90m// Create test user[39m
    [90m 34| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 35| [39m      id[33m:[39m [32m'test-user-collections-e2e'[39m[33m,[39m
    [90m 36| [39m      email[33m:[39m [32m'test-collections-e2e@example.com'[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/collections.e2e.test.ts:[2m34:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(e562dfe9-d35d-496e-9e4e-6695ec9dbed7) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w39_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[13/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/dataBlocks.test.ts[2m > [22mData Block Integration Tests
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, $6, default, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 6e1cb367-adf2-4550-b628-9af0982d7876,datablock-test@example.com,6f3a5f93-877f-4079-b8b0-4903ff36ca2a,admin,owner,google[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/dataBlocks.test.ts:[2m49:24[22m[39m
    [90m 47| [39m        tenantId [33m=[39m tenant[33m.[39mid[33m;[39m
    [90m 48| [39m
    [90m 49| [39m        [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                       [31m^[39m
    [90m 50| [39m            id[33m:[39m [34muuidv4[39m()[33m,[39m
    [90m 51| [39m            email[33m:[39m testEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/dataBlocks.test.ts:[2m49:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(6f3a5f93-877f-4079-b8b0-4903ff36ca2a) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w38_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[14/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault-v4-regression.test.ts[2m > [22mDataVault v4 Regression Tests
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, $6, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $7, "role" = $8, "tenant_role" = $9
params: google-user-id,testuser@example.com,026e95c0-47ec-4c0f-9769-574f30739d06,admin,owner,google,026e95c0-47ec-4c0f-9769-574f30739d06,admin,owner[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/datavault-v4-regression.test.ts:[2m90:5[22m[39m
    [90m 88| [39m    [90m// Create test user manually with correct tenant and admin role[39m
    [90m 89| [39m    testUserId [33m=[39m [32m'google-user-id'[39m[33m;[39m
    [90m 90| [39m    [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m    [31m^[39m
    [90m 91| [39m      id[33m:[39m testUserId[33m,[39m
    [90m 92| [39m      email[33m:[39m [32m'testuser@example.com'[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/datavault-v4-regression.test.ts:[2m90:5[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(026e95c0-47ec-4c0f-9769-574f30739d06) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w49_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[15/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault.autonumber.test.ts[2m > [22mDataVault Autonumber Integration Tests
[31m[1mError[22m: Failed query: insert into "datavault_columns" ("id", "table_id", "name", "slug", "type", "description", "width_px", "required", "is_primary_key", "is_unique", "order_index", "auto_number_start", "autonumber_prefix", "autonumber_padding", "autonumber_reset_policy", "reference_table_id", "reference_display_column_slug", "options", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, default, $5, $6, $7, $8, $9, default, default, default, default, default, default, default, default) returning "id", "table_id", "name", "slug", "type", "description", "width_px", "required", "is_primary_key", "is_unique", "order_index", "auto_number_start", "autonumber_prefix", "autonumber_padding", "autonumber_reset_policy", "reference_table_id", "reference_display_column_slug", "options", "created_at", "updated_at"
params: 28c19450-35bd-4ee6-99b8-f27070577045,ID,id,auto_number,true,true,true,0,1[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m DatavaultColumnsRepository.create server/repositories/BaseRepository.ts:[2m90:22[22m[39m
    [90m 88| [39m    [35mconst[39m database [33m=[39m [35mthis[39m[33m.[39m[34mgetDb[39m(tx)[33m;[39m
    [90m 89| [39m
    [90m 90| [39m    [35mconst[39m [record] [33m=[39m [35mawait[39m database
    [90m   | [39m                     [31m^[39m
    [90m 91| [39m      [33m.[39m[34minsert[39m([35mthis[39m[33m.[39mtable [35mas[39m any)
    [90m 92| [39m      [33m.[39m[34mvalues[39m(data [35mas[39m any)
[90m [2mâ¯[22m DatavaultTablesService.createTable server/services/DatavaultTablesService.ts:[2m181:5[22m[39m
[90m [2mâ¯[22m tests/integration/datavault.autonumber.test.ts:[2m29:19[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "datavault_columns" violates foreign key constraint "datavault_columns_table_id_datavault_tables_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m DatavaultColumnsRepository.create server/repositories/BaseRepository.ts:[2m90:22[22m[39m
[90m [2mâ¯[22m DatavaultTablesService.createTable server/services/DatavaultTablesService.ts:[2m181:5[22m[39m
[90m [2mâ¯[22m tests/integration/datavault.autonumber.test.ts:[2m29:19[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 387, severity: 'ERROR', code: '23503', detail: 'Key (table_id)=(28c19450-35bd-4ee6-99b8-f27070577045) is not present in table "datavault_tables".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w46_v3', table: 'datavault_columns', dataType: undefined, constraint: 'datavault_columns_table_id_datavault_tables_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[16/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/datavault.permissions.test.ts[2m > [22mDataVault Table Permissions API (v4 Micro-Phase 6)
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m createTestUser tests/helpers/integrationTestHelper.ts:[2m242:11[22m[39m
    [90m240| [39m
    [90m241| [39m  [35mif[39m (registerRes[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m242| [39m    throw new Error(`User registration failed: ${JSON.stringify(registâ€¦
    [90m   | [39m          [31m^[39m
    [90m243| [39m  }
    [90m244| [39m
[90m [2mâ¯[22m tests/integration/datavault.permissions.test.ts:[2m31:13[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[17/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/dynamic_options_workflow.test.ts[2m > [22mDynamic Options Integration Flow
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'id')[39m
[36m [2mâ¯[22m tests/integration/dynamic_options_workflow.test.ts:[2m49:33[22m[39m
    [90m 47| [39m        [90m// Get default section[39m
    [90m 48| [39m        const sections = await sectionRepository.findByWorkflowId(workâ€¦
    [90m 49| [39m        sectionId [33m=[39m sections[[34m0[39m][33m.[39mid[33m;[39m
    [90m   | [39m                                [31m^[39m
    [90m 50| [39m    })[33m;[39m
    [90m 51| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[18/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/dynamic_options_workflow.test.ts[2m > [22mDynamic Options Integration Flow
[31m[1mError[22m: Workflow not found[39m
[36m [2mâ¯[22m WorkflowService.verifyAccess server/services/WorkflowService.ts:[2m132:13[22m[39m
    [90m130| [39m
    [90m131| [39m    [35mif[39m ([33m![39mworkflow) {
    [90m132| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Workflow not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m133| [39m    }
    [90m134| [39m
[90m [2mâ¯[22m WorkflowService.deleteWorkflow server/services/WorkflowService.ts:[2m339:5[22m[39m
[90m [2mâ¯[22m tests/integration/dynamic_options_workflow.test.ts:[2m54:26[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[19/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/externalSends.test.ts[2m > [22mExternal Send Block Integration
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, $6, default, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 187ea9cc-109c-4fe4-b422-545ed02e2448,ext-test-1768709117757@example.com,8ab89b6e-9937-44dd-9bc0-5d3ca167e57b,admin,owner,local[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/externalSends.test.ts:[2m38:24[22m[39m
    [90m 36| [39m        tenantId [33m=[39m tenant[33m.[39mid[33m;[39m
    [90m 37| [39m
    [90m 38| [39m        [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                       [31m^[39m
    [90m 39| [39m            id[33m:[39m [34muuidv4[39m()[33m,[39m
    [90m 40| [39m            email[33m:[39m [32m`ext-test-[39m[36m${[39m[33mDate[39m[33m.[39m[34mnow[39m()[36m}[39m[32m@example.com`[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/externalSends.test.ts:[2m38:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(8ab89b6e-9937-44dd-9bc0-5d3ca167e57b) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w16_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[20/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/intake.workflow.test.ts[2m > [22mIntake Workflow Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/intake.workflow.test.ts:[2m11:15[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[21/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/intake.workflow.test.ts[2m > [22mIntake Workflow Integration Tests
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/intake.workflow.test.ts:[2m21:19[22m[39m
    [90m 19| [39m
    [90m 20| [39m    [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 21| [39m        [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m                  [31m^[39m
    [90m 22| [39m    })[33m;[39m
    [90m 23| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/lifecycle-hooks-execution.test.ts[2m > [22mLifecycle Hooks Execution
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/lifecycle-hooks-execution.test.ts:[2m41:11[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[23/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/lifecycle-hooks-execution.test.ts[2m > [22mLifecycle Hooks Execution
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/lifecycle-hooks-execution.test.ts:[2m89:15[22m[39m
    [90m 87| [39m
    [90m 88| [39m  [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 89| [39m    [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m              [31m^[39m
    [90m 90| [39m  })[33m;[39m
    [90m 91| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[24/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/workflow_versioning.test.ts[2m > [22mWorkflow Versioning & Lineage
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values (default, $1, $2, default, default, default, $3, $4, $5, default, default, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: test_versioning_1768709132129@example.com,Versioning Tester,13f5c9ab-e9cb-4e4b-a4a0-7a06effe62e0,admin,owner[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/workflow_versioning.test.ts:[2m27:24[22m[39m
    [90m 25| [39m
    [90m 26| [39m        [90m// Create User (Needed for Project creator/owner)[39m
    [90m 27| [39m        [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                       [31m^[39m
    [90m 28| [39m            email[33m:[39m [32m`test_versioning_[39m[36m${[39m[33mDate[39m[33m.[39m[34mnow[39m()[36m}[39m[32m@example.com`[39m[33m,[39m
    [90m 29| [39m            fullName[33m:[39m [32m"Versioning Tester"[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/workflow_versioning.test.ts:[2m27:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(13f5c9ab-e9cb-4e4b-a4a0-7a06effe62e0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w39_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[25/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ai/workflowEdit.test.ts[2m > [22mPOST /api/workflows/:workflowId/ai/edit - Integration Test
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 7bab57d5-57b7-4b73-9984-accf4b607620,test@example.com,Test User,0e66f933-9e5a-473d-9e21-d48f322121e0[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/ai/workflowEdit.test.ts:[2m114:20[22m[39m
    [90m112| [39m
    [90m113| [39m    [90m// Create test user[39m
    [90m114| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m115| [39m      id[33m:[39m mockUserId[33m,[39m
    [90m116| [39m      email[33m:[39m [32m'test@example.com'[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/ai/workflowEdit.test.ts:[2m114:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(0e66f933-9e5a-473d-9e21-d48f322121e0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w28_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[26/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/auth.middleware.integration.test.ts[2m > [22mAuth Middleware Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/auth/auth.middleware.integration.test.ts:[2m35:15[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[27/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/auth.middleware.integration.test.ts[2m > [22mAuth Middleware Integration Tests
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/auth/auth.middleware.integration.test.ts:[2m45:19[22m[39m
    [90m 43| [39m
    [90m 44| [39m    [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 45| [39m        [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m                  [31m^[39m
    [90m 46| [39m    })[33m;[39m
    [90m 47| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[28/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/jwt.authentication.test.ts[2m > [22mJWT Authentication Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/auth/jwt.authentication.test.ts:[2m31:15[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[29/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/jwt.authentication.test.ts[2m > [22mJWT Authentication Integration Tests
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/auth/jwt.authentication.test.ts:[2m40:19[22m[39m
    [90m 38| [39m
    [90m 39| [39m    [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 40| [39m        [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m                  [31m^[39m
    [90m 41| [39m    })[33m;[39m
    [90m 42| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[30/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/protected.routes.test.ts[2m > [22mProtected Routes Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/auth/protected.routes.test.ts:[2m31:15[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[31/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/session.management.integration.test.ts[2m > [22mSession Management Integration Tests
[31m[1mError[22m: User registration failed: {"message":"Registration failed","error":"internal_error"}[39m
[36m [2mâ¯[22m setupIntegrationTest tests/helpers/integrationTestHelper.ts:[2m114:13[22m[39m
    [90m112| [39m
    [90m113| [39m    [35mif[39m (registerResponse[33m.[39mstatus [33m!==[39m [34m201[39m) {
    [90m114| [39m      throw new Error(`User registration failed: ${JSON.stringify(regiâ€¦
    [90m   | [39m            [31m^[39m
    [90m115| [39m    }
    [90m116| [39m
[90m [2mâ¯[22m tests/integration/auth/session.management.integration.test.ts:[2m31:15[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[32/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/session.management.integration.test.ts[2m > [22mSession Management Integration Tests
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'cleanup')[39m
[36m [2mâ¯[22m tests/integration/auth/session.management.integration.test.ts:[2m40:19[22m[39m
    [90m 38| [39m
    [90m 39| [39m    [34mafterAll[39m([35masync[39m () [33m=>[39m {
    [90m 40| [39m        [35mawait[39m ctx[33m.[39m[34mcleanup[39m()[33m;[39m
    [90m   | [39m                  [31m^[39m
    [90m 41| [39m    })[33m;[39m
    [90m 42| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[33/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/workflows/runtime-pipelines.test.ts[2m > [22mRuntime Pipelines Integration Tests
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, default, $3, $4, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,tAymHjVSNU2H3XxqKXDgi,09c59ba7-d867-4cc0-b955-6cbe1003a24c,tAymHjVSNU2H3XxqKXDgi,tAymHjVSNU2H3XxqKXDgi[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/workflows/runtime-pipelines.test.ts:[2m84:23[22m[39m
    [90m 82| [39m
    [90m 83| [39m    [90m// Create test project[39m
    [90m 84| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 85| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 86| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/workflows/runtime-pipelines.test.ts:[2m84:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 309, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(tAymHjVSNU2H3XxqKXDgi) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w17_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[34/341]âŽ¯[22m[39m


[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m[1m[41m Failed Tests 307 [49m[22m[31mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39m

[41m[1m FAIL [22m[49m tests/integration/analytics_preservation.test.ts[2m > [22mAnalytics Preservation[2m > [22mshould preserve lifetime user count when a user is deleted
[31m[1mAssertionError[22m: expected { â€¦(18) } to be undefined[39m

[32m- Expected:[39m 
undefined

[31m+ Received:[39m 
{
  "authProvider": "local",
  "createdAt": 2026-01-18T04:06:08.053Z,
  "defaultMode": "easy",
  "email": "analytics-test-1768709166923@example.com",
  "emailVerified": false,
  "firstName": "Analytics",
  "fullName": null,
  "id": "3e80c5a1-c075-4755-bd37-9726eb76505c",
  "isPlaceholder": false,
  "lastName": "Test",
  "lastPasswordChange": null,
  "mfaEnabled": false,
  "placeholderEmail": null,
  "profileImageUrl": null,
  "role": "creator",
  "tenantId": null,
  "tenantRole": null,
  "updatedAt": 2026-01-18T04:06:08.053Z,
}

[36m [2mâ¯[22m tests/integration/analytics_preservation.test.ts:[2m42:29[22m[39m
    [90m 40| [39m        [90m// 5. Verify user is gone from users table[39m
    [90m 41| [39m        const deletedUser = await userRepository.findByEmail(testEmailâ€¦
    [90m 42| [39m        [34mexpect[39m(deletedUser)[33m.[39m[34mtoBeUndefined[39m()[33m;[39m
    [90m   | [39m                            [31m^[39m
    [90m 43| [39m
    [90m 44| [39m        [90m// 6. Verify lifetime stats are PRESERVED (did not decrement)[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[35/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.ai.personalization.test.ts[2m > [22mPersonalization API Integration Tests[2m > [22mPOST /api/ai/personalize/block[2m > [22mshould rewrite text based on user settings
[31m[1mAssertionError[22m: expected '\n      Rewrite the following survey â€¦' to contain 'Tone: friendly'[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- Tone: friendly[39m
[31m+[39m
[31m+       Rewrite the following survey question text to match the user's preferences.[39m
[31m+       [39m
[31m+       Original Text: "Original Text"[39m
[31m+       [39m
[31m+       User Preferences:[39m
[31m+       - Tone: neutral[39m
[31m+       - Reading Level: standard[39m
[31m+       - Verbosity: standard[39m
[31m+       - Language: en[39m
[31m+       [39m
[31m+       Output ONLY the rewritten text. Do not add quotes or explanations.[39m
[31m+     [39m

[36m [2mâ¯[22m tests/integration/api.ai.personalization.test.ts:[2m107:30[22m[39m
    [90m105| [39m            [90m// Check that prompt contains user settings[39m
    [90m106| [39m            [35mconst[39m callArgs [33m=[39m mockGenerateContent[33m.[39mmock[33m.[39mcalls[[34m0[39m][[34m0[39m][33m;[39m
    [90m107| [39m            [34mexpect[39m(callArgs)[33m.[39m[34mtoContain[39m([32m"Tone: friendly"[39m)[33m;[39m
    [90m   | [39m                             [31m^[39m
    [90m108| [39m            [34mexpect[39m(callArgs)[33m.[39m[34mtoContain[39m([32m"Language: es"[39m)[33m;[39m
    [90m109| [39m        })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[36/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/api.ai.personalization.test.ts[2m > [22mPersonalization API Integration Tests[2m > [22mPOST /api/ai/personalize/settings[2m > [22mshould update user settings
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'tone')[39m
[36m [2mâ¯[22m tests/integration/api.ai.personalization.test.ts:[2m137:29[22m[39m
    [90m135| [39m            [90m// Verify in DB[39m
    [90m136| [39m            const [settings] = await db.select().from(userPersonalizatâ€¦
    [90m137| [39m            [34mexpect[39m(settings[33m.[39mtone)[33m.[39m[34mtoBe[39m([32m'formal'[39m)[33m;[39m
    [90m   | [39m                            [31m^[39m
    [90m138| [39m        })[33m;[39m
    [90m139| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[37/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mComplete Registration â†’ Login Flow[2m > [22mshould complete registration, verify email, then login
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m73:39[22m[39m
    [90m 71| [39m        })[33m;[39m
    [90m 72| [39m
    [90m 73| [39m      [34mexpect[39m(registerResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                                      [31m^[39m
    [90m 74| [39m      [34mexpect[39m(registerResponse[33m.[39mbody[33m.[39muser[33m.[39memailVerified)[33m.[39m[34mtoBe[39m([35mfalse[39m)[33m;[39m
    [90m 75| [39m      [34mtrackUser[39m(registerResponse[33m.[39mbody[33m.[39muser[33m.[39mid)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[38/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mAccount Lockout Flow[2m > [22mshould lock account after 5 failed attempts, then unlock after waiting
[31m[1mAssertionError[22m: expected 401 to be 423 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 423[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m138:36[22m[39m
    [90m136| [39m        })[33m;[39m
    [90m137| [39m
    [90m138| [39m      [34mexpect[39m(lockedAttempt[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m423[39m)[33m;[39m
    [90m   | [39m                                   [31m^[39m
    [90m139| [39m      expect(lockedAttempt.body.message || lockedAttempt.body.error).tâ€¦
    [90m140| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[39/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mAccount Lockout Flow[2m > [22mshould record all login attempts
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 96e4cbfe0d0083d7cacdfa3d3e0721dd,$2b$12$an8WENCh1ITloRA4Jse7o.40h/ISogCDECb4ubYjl5wWPaYOhJTg6,2026-01-18T04:05:14.543Z,2026-01-18T04:05:14.543Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m161:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m161:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(96e4cbfe0d0083d7cacdfa3d3e0721dd) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[40/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mMFA Enrollment and Login Flow[2m > [22mshould complete MFA setup and login with TOTP
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m197:36[22m[39m
    [90m195| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m196| [39m
    [90m197| [39m      [34mexpect[39m(setupResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                   [31m^[39m
    [90m198| [39m      [34mexpect[39m(setupResponse[33m.[39mbody[33m.[39mqrCodeDataUrl)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m199| [39m      [34mexpect[39m(setupResponse[33m.[39mbody[33m.[39mbackupCodes)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[41/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mMFA Enrollment and Login Flow[2m > [22mshould login with backup code when TOTP unavailable
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: e4f4e197ab280dd1e9c5e46d34e975dc,$2b$12$g87TkeS1PB/wu3KW0BESd.uqS.2FF5aFK2Imz6FRZwYzs/eRn4LO.,2026-01-18T04:05:16.620Z,2026-01-18T04:05:16.620Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m253:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m253:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(e4f4e197ab280dd1e9c5e46d34e975dc) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[42/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mPassword Reset Flow[2m > [22mshould complete full password reset flow
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: dec84bb74a743b9e152b1ea42cca4206,$2b$12$BAimN/0fSP2mtosc8l5XcuwSaGH9fQJ4wjW68eSYkv9eVzClEPqqW,2026-01-18T04:05:17.433Z,2026-01-18T04:05:17.433Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m324:56[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m324:56[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(dec84bb74a743b9e152b1ea42cca4206) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w15_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[43/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mPassword Reset Flow[2m > [22mshould invalidate all sessions after password reset
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'id')[39m
[36m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m420:47[22m[39m
    [90m418| [39m      [35mconst[39m { refreshTokens } [33m=[39m [35mawait[39m [35mimport[39m([32m"@shared/schema"[39m)[33m;[39m
    [90m419| [39m      const validRefreshTokens = await db.query.refreshTokens.findManyâ€¦
    [90m420| [39m        where[33m:[39m [34meq[39m(refreshTokens[33m.[39muserId[33m,[39m user[33m![39m[33m.[39mid)[33m,[39m
    [90m   | [39m                                              [31m^[39m
    [90m421| [39m      })[33m;[39m
    [90m422| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[44/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mToken Refresh Flow[2m > [22mshould rotate refresh token on each use
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m439:40[22m[39m
    [90m437| [39m
    [90m438| [39m      const cookies = loginResponse.headers['set-cookie'] as unknown aâ€¦
    [90m439| [39m      let refreshTokenCookie = cookies.find(c => c.startsWith('refreshâ€¦
    [90m   | [39m                                       [31m^[39m
    [90m440| [39m
    [90m441| [39m      [34mexpect[39m(refreshTokenCookie)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[45/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mToken Refresh Flow[2m > [22mshould detect and prevent refresh token reuse (token theft)
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m473:44[22m[39m
    [90m471| [39m
    [90m472| [39m      const cookies = loginResponse.headers['set-cookie'] as unknown aâ€¦
    [90m473| [39m      const originalRefreshToken = cookies.find(c => c.startsWith('refâ€¦
    [90m   | [39m                                           [31m^[39m
    [90m474| [39m
    [90m475| [39m      [90m// Use token once (rotation happens)[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[46/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mSession Management Flow[2m > [22mshould list all active sessions
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m528:39[22m[39m
    [90m526| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m527| [39m
    [90m528| [39m      [34mexpect[39m(sessionsResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                                      [31m^[39m
    [90m529| [39m      [34mexpect[39m(sessionsResponse[33m.[39mbody[33m.[39msessions)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m530| [39m      expect(sessionsResponse.body.sessions.length).toBeGreaterThanOrEâ€¦

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[47/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.flows.real.test.ts[2m > [22mAuth Flows Integration Tests (REAL)[2m > [22mSession Management Flow[2m > [22mshould revoke specific session
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2mâ¯[22m tests/integration/auth.flows.real.test.ts:[2m554:40[22m[39m
    [90m552| [39m
    [90m553| [39m      [35mconst[39m sessions [33m=[39m sessionsResponse[33m.[39mbody[33m.[39msessions[33m;[39m
    [90m554| [39m      [35mconst[39m sessionToRevoke [33m=[39m sessions[33m.[39m[34mfind[39m((s[33m:[39m any) [33m=>[39m [33m![39ms[33m.[39mcurrent)[33m;[39m
    [90m   | [39m                                       [31m^[39m
    [90m555| [39m
    [90m556| [39m      [90m// Revoke first session[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[48/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/register[2m > [22mshould register a new user successfully
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m78:31[22m[39m
    [90m 76| [39m        })[33m;[39m
    [90m 77| [39m
    [90m 78| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m 79| [39m      expect((response.body).message).toContain("Registration successfâ€¦
    [90m 80| [39m      [34mexpect[39m((response[33m.[39mbody)[33m.[39mtoken)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[49/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/register[2m > [22mshould return 409 for duplicate email
[31m[1mAssertionError[22m: expected 500 to be 409 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 409[39m
[31m+ 500[39m

[36m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m139:31[22m[39m
    [90m137| [39m        [33m.[39m[34msend[39m({ email[33m,[39m password[33m,[39m firstName[33m:[39m [32m"Second"[39m })[33m;[39m
    [90m138| [39m
    [90m139| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m409[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m140| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoContain[39m([32m"already exists"[39m)[33m;[39m
    [90m141| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[50/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/register[2m > [22mshould set httpOnly refresh token cookie
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m151:31[22m[39m
    [90m149| [39m        [33m.[39m[34msend[39m({ email[33m,[39m password[33m,[39m firstName[33m:[39m [32m"Test"[39m })[33m;[39m
    [90m150| [39m
    [90m151| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m152| [39m      [34mexpect[39m(response[33m.[39mheaders[[32m'set-cookie'[39m])[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m153| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[51/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould login with valid credentials
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 48a8492a48d7f4454fd093bb3dc2e49e,$2b$12$c.19YUfWvdxnIV1QgFHlIui6MG7TJsGabHGGOiY091wyPnV9rThBW,2026-01-18T04:05:05.339Z,2026-01-18T04:05:05.339Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m164:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m164:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(48a8492a48d7f4454fd093bb3dc2e49e) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[52/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould return 401 for invalid password
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 725269763995b88bbf509da0628f41f7,$2b$12$TOV74pgNAWLG16ni4vjrEuqnCmMTJ.Z0AbjptgizVKs8fUqytXIoy,2026-01-18T04:05:06.101Z,2026-01-18T04:05:06.101Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m185:33[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m185:33[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(725269763995b88bbf509da0628f41f7) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[53/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould return 403 for unverified email
[31m[1mAssertionError[22m: expected 401 to be 403 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 403[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m226:31[22m[39m
    [90m224| [39m        [33m.[39m[34msend[39m({ email[33m,[39m password })[33m;[39m
    [90m225| [39m
    [90m226| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m403[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m227| [39m      expect(response.body.message || response.body.error).toBeDefinedâ€¦
    [90m228| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[54/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould record failed login attempt
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 38e052f0baed69d083d9e5bc599d45cb,$2b$12$goW03jdabf.jVmZldW5L1unV3gpsvRw/WX9viFhX5DEvceLlhUju6,2026-01-18T04:05:08.344Z,2026-01-18T04:05:08.344Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m231:33[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m231:33[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(38e052f0baed69d083d9e5bc599d45cb) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w0_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[55/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould return requiresMfa=true for MFA-enabled users
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 26d99114914060e74112e8660912fecc,$2b$12$PZLRkIw7UF6ACj1e.kWPVeIDI3GhpGUfNYgPzrjGU3CVkX7WWO9Ne,2026-01-18T04:05:09.081Z,2026-01-18T04:05:09.081Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m252:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m252:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(26d99114914060e74112e8660912fecc) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[56/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/login[2m > [22mshould lock account after 5 failed attempts
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: a066f31a1f76f576e78b1df7c8592a01,$2b$12$aW3dbNJNpbAofv416KOh6.eQIuspAc6HkA4VpEwB6KJCC1/MCpLcC,2026-01-18T04:05:10.319Z,2026-01-18T04:05:10.319Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m266:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m266:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(a066f31a1f76f576e78b1df7c8592a01) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[57/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/logout[2m > [22mshould logout and clear refresh token cookie
[31m[1mAssertionError[22m: expected undefined to be defined[39m
[36m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m304:23[22m[39m
    [90m302| [39m
    [90m303| [39m      const cookies = (loginResponse.headers as any)['set-cookie'] as â€¦
    [90m304| [39m      [34mexpect[39m(cookies)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m   | [39m                      [31m^[39m
    [90m305| [39m      const refreshTokenCookie = cookies!.find(c => c.startsWith('refrâ€¦
    [90m306| [39m      [34mexpect[39m(refreshTokenCookie)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[58/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould refresh access token with valid refresh token
[31m[1mAssertionError[22m: expected undefined to be defined[39m
[36m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m334:23[22m[39m
    [90m332| [39m
    [90m333| [39m      const cookies = (loginResponse.headers as any)['set-cookie'] as â€¦
    [90m334| [39m      [34mexpect[39m(cookies)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m   | [39m                      [31m^[39m
    [90m335| [39m      const refreshTokenCookie = cookies!.find(c => c.startsWith('refrâ€¦
    [90m336| [39m      [34mexpect[39m(refreshTokenCookie)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[59/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould rotate refresh token after use
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 547198c4980e296a12facb4776797f7a,$2b$12$ucU4X8bIpti2.eIu1OhmduuwlJpEmnasa8delbkCQH0HM3QNh4JoO,2026-01-18T04:05:13.464Z,2026-01-18T04:05:13.464Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m364:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m364:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(547198c4980e296a12facb4776797f7a) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[60/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/reset-password[2m > [22mshould reset password with valid token
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 0f13978743c0440e53a8b78bbb2e9930,$2b$12$ZuAuIgJoC7FTpH3luIYlmeTwNYyjpsIowUSUHvyjwfPjebDZtvMEm,2026-01-18T04:05:15.424Z,2026-01-18T04:05:15.424Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m423:56[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m423:56[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(0f13978743c0440e53a8b78bbb2e9930) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w17_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[61/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mPOST /api/auth/reset-password[2m > [22mshould return 400 for weak new password
[31m[1mAssertionError[22m: expected 'Token and password required' to contain 'Password'[39m

Expected: [32m"[7mPasswor[27md"[39m
Received: [31m"[7mToken and password require[27md"[39m

[36m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m481:37[22m[39m
    [90m479| [39m
    [90m480| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m400[39m)[33m;[39m
    [90m481| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoContain[39m([32m"Password"[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m482| [39m    })[33m;[39m
    [90m483| [39m  })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[62/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mGET /api/auth/me[2m > [22mshould return current user for valid token
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 89523938e9e004166596f87f0e2155ad,$2b$12$uQZLiOCklhyio0EPdxMk8uREWYala6kkHLKlfU4GXSB6VJa8AEKhG,2026-01-18T04:05:17.408Z,2026-01-18T04:05:17.408Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m487:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m487:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(89523938e9e004166596f87f0e2155ad) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w0_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[63/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mMFA Routes[2m > [22mPOST /api/auth/mfa/verify-login[2m > [22mshould complete MFA login with valid TOTP code
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: a0e5b72daf16293b56b697bb065d0688,$2b$12$t5MPZc.DK2d0YUnWkGBwM.8gjXErgFJIfq7h5UussBNxgYY9fIDky,2026-01-18T04:05:18.346Z,2026-01-18T04:05:18.346Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m523:57[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m523:57[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(a0e5b72daf16293b56b697bb065d0688) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w2_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[64/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth.routes.real.test.ts[2m > [22mAuth Routes Integration Tests (REAL)[2m > [22mMFA Routes[2m > [22mPOST /api/auth/mfa/verify-login[2m > [22mshould reject invalid MFA code
[31m[1mAssertionError[22m: expected 404 to be 401 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 401[39m
[31m+ 404[39m

[36m [2mâ¯[22m tests/integration/auth.routes.real.test.ts:[2m559:33[22m[39m
    [90m557| [39m          })[33m;[39m
    [90m558| [39m
    [90m559| [39m        [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m401[39m)[33m;[39m
    [90m   | [39m                                [31m^[39m
    [90m560| [39m        [34mexpect[39m(response[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoContain[39m([32m"Invalid"[39m)[33m;[39m
    [90m561| [39m      })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[65/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/js_helpers.test.ts[2m > [22mDetailed Verification: JS Helper Availability[2m > [22mshould execute a JS block that uses helper functions
[31m[1mError[22m: Failed query: insert into "sections" ("id", "workflow_id", "title", "description", "order", "config", "visible_if", "skip_if", "created_at", "updated_at") values (default, $1, $2, default, $3, default, default, default, default, default) returning "id", "workflow_id", "title", "description", "order", "config", "visible_if", "skip_if", "created_at", "updated_at"
params: 47993892-e576-43d1-99eb-3f8ed8144158,JS Section,1[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/js_helpers.test.ts:[2m127:27[22m[39m
    [90m125| [39m    it("should execute a JS block that uses helper functions", async (â€¦
    [90m126| [39m        [90m// 1. Create a Section with a JS Question[39m
    [90m127| [39m        [35mconst[39m [section] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(sections)[33m.[39m[34mvalues[39m({
    [90m   | [39m                          [31m^[39m
    [90m128| [39m            workflowId[33m,[39m
    [90m129| [39m            title[33m:[39m [32m"JS Section"[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "sections" violates foreign key constraint "sections_workflow_id_workflows_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/js_helpers.test.ts:[2m127:27[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 339, severity: 'ERROR', code: '23503', detail: 'Key (workflow_id)=(47993892-e576-43d1-99eb-3f8ed8144158) is not present in table "workflows".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w49_v3', table: 'sections', dataType: undefined, constraint: 'sections_workflow_id_workflows_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[66/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould complete full MFA setup flow
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 78bc753dfb9d5658f694ccc532846384,$2b$12$UMrHmBLRe3eDa0UUgLdIdehvgLJQmfN8Q.in7kvLSzpVdv708hEwa,2026-01-18T04:05:02.010Z,2026-01-18T04:05:02.010Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m59:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m59:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(78bc753dfb9d5658f694ccc532846384) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[67/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould reject invalid TOTP code during setup
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 884ffbe3b9c711399d5601ae8db730d0,$2b$12$C0scvl1/UpjA3MkmseDZlOKNjsJZiWZMhgvXrNnuJpYCSN3pCj22C,2026-01-18T04:05:02.746Z,2026-01-18T04:05:02.746Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m125:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m125:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(884ffbe3b9c711399d5601ae8db730d0) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[68/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould not allow MFA setup if already enabled
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: 65d57e0128649e2322c1115dcb083190,OBRDY4BDKJHTOTBXPBJU4N3IHZFTQ6ZMKJNWQ7LTGNKFITJOMVGQ,true,2026-01-18T04:05:03.575Z,2026-01-18T04:05:03.575Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m157:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m157:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 322, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(65d57e0128649e2322c1115dcb083190) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[69/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould generate unique backup codes
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: d318ee56f64d98efd2ea0181ca098af1,$2b$12$/q37YKHPsOexENZrVvWCp.ibTBxHd4smPszhWqlZ9lD/4wgGHqlvO,2026-01-18T04:05:04.330Z,2026-01-18T04:05:04.330Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m171:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m171:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(d318ee56f64d98efd2ea0181ca098af1) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[70/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Setup Flow[2m > [22mshould store hashed backup codes
[31m[1mAssertionError[22m: expected [] to have a length of 10 but got +0[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 10[39m
[31m+ 0[39m

[36m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m208:27[22m[39m
    [90m206| [39m      })[33m;[39m
    [90m207| [39m
    [90m208| [39m      [34mexpect[39m(storedCodes)[33m.[39m[34mtoHaveLength[39m([34m10[39m)[33m;[39m
    [90m   | [39m                          [31m^[39m
    [90m209| [39m
    [90m210| [39m      [90m// Hashes should not match plain codes[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[71/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Login Flow[2m > [22mshould require MFA for enabled users
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: e3690ac70c99b124af34bb6b6a920bbd,$2b$12$OdUZFk75SAl50IAt7vTHNOsDNCUkCe5KI6Nn2v21oW6yj23J9feme,2026-01-18T04:05:06.365Z,2026-01-18T04:05:06.365Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m220:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m220:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(e3690ac70c99b124af34bb6b6a920bbd) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[72/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Login Flow[2m > [22mshould complete MFA login with valid TOTP
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: 94158383d9160780722cdc3e0c189b53,MM2CM6DFMITEG4TDIFDSYO25OFTGCSK3PMYFQODBOY2F4LSWLZHA,true,2026-01-18T04:05:07.190Z,2026-01-18T04:05:07.190Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m234:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m234:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 322, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(94158383d9160780722cdc3e0c189b53) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[73/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Login Flow[2m > [22mshould reject invalid TOTP during login
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 099ac0fb0b46d209775c2cea934025db,$2b$12$vGdGNE2JJTqSriCTOzCRzOy8YIxpG5oZrlp3uDgVHtwHgkoLogqQi,2026-01-18T04:05:07.927Z,2026-01-18T04:05:07.927Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m268:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m268:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(099ac0fb0b46d209775c2cea934025db) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[74/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Login Flow[2m > [22mshould accept TOTP codes within 60-second window
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 5f2647da2cabe4b1d0928072fa0bc477,$2b$12$aq0WADssgelHqCKzls5xYuaHaKd0n6psfJL3bBcMYt4pxKEX40w.O,2026-01-18T04:05:08.666Z,2026-01-18T04:05:08.666Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m286:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m286:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(5f2647da2cabe4b1d0928072fa0bc477) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[75/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Flow[2m > [22mshould login with valid backup code
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'id')[39m
[36m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m338:44[22m[39m
    [90m336| [39m
    [90m337| [39m      [35mconst[39m mfaSecret [33m=[39m [35mawait[39m db[33m.[39mquery[33m.[39mmfaSecrets[33m.[39m[34mfindFirst[39m({
    [90m338| [39m        where[33m:[39m [34meq[39m(mfaSecrets[33m.[39muserId[33m,[39m user[33m![39m[33m.[39mid)[33m,[39m
    [90m   | [39m                                           [31m^[39m
    [90m339| [39m      })[33m;[39m
    [90m340| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[76/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Flow[2m > [22mshould mark backup code as used
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 91aef255bd261a30f85c91e2b57c7fda,$2b$12$6YE07ZMwFispVxEADVPG1eKw4syLu/.93bPu1.MqYOExbMs2XOIkW,2026-01-18T04:05:10.581Z,2026-01-18T04:05:10.581Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m370:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m370:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(91aef255bd261a30f85c91e2b57c7fda) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[77/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Flow[2m > [22mshould prevent backup code reuse
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'id')[39m
[36m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m410:44[22m[39m
    [90m408| [39m
    [90m409| [39m      [35mconst[39m mfaSecret [33m=[39m [35mawait[39m db[33m.[39mquery[33m.[39mmfaSecrets[33m.[39m[34mfindFirst[39m({
    [90m410| [39m        where[33m:[39m [34meq[39m(mfaSecrets[33m.[39muserId[33m,[39m user[33m![39m[33m.[39mid)[33m,[39m
    [90m   | [39m                                           [31m^[39m
    [90m411| [39m      })[33m;[39m
    [90m412| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[78/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Flow[2m > [22mshould try TOTP before backup code
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 6e3821e114d464eac361a33c0f6443ac,$2b$12$cZBZiJs3hD6tsg4O37PJ6.0yVLHzZDkZ4NZu8yQlK5mpEcJ6/G6R6,2026-01-18T04:05:12.568Z,2026-01-18T04:05:12.568Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m452:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m452:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(6e3821e114d464eac361a33c0f6443ac) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[79/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Status[2m > [22mshould return MFA status for user
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 6f0d3f05c2fd3463302ac871d70824d5,$2b$12$cFMF02fwMvfMzInghXMbTu0GTDNnhIvAPqDH9jJk5v9PnsWmDpGMe,2026-01-18T04:05:13.314Z,2026-01-18T04:05:13.314Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m475:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m475:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(6f0d3f05c2fd3463302ac871d70824d5) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[80/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Status[2m > [22mshould return backup codes count for MFA users
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 29ace8cfcc46835b6e9e35d3b6550ec8,$2b$12$JNPaZlAVYB8ah0XP/G1UnOQUZmaib.nmI8uV046HxGHdR8esbncqa,2026-01-18T04:05:14.053Z,2026-01-18T04:05:14.053Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m492:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m492:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(29ace8cfcc46835b6e9e35d3b6550ec8) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w18_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[81/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Disable Flow[2m > [22mshould disable MFA with password verification
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: 8935ae4107fa1e865ae9c486aedc85b4,GZBV4KLDLVVT44RZMMSG6UBQOBBTU3DFONAHWPBZMF3CGYLHKQ6A,true,2026-01-18T04:05:15.162Z,2026-01-18T04:05:15.162Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m529:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m529:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 322, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(8935ae4107fa1e865ae9c486aedc85b4) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[82/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mMFA Disable Flow[2m > [22mshould require correct password to disable MFA
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: da2133f2743c74e598e9e3d714f4543f,$2b$12$Ar/9Z3NqlCbOM8uyVsSv6O0tNx2oH0NwGnNjwyPU5CN5GYxw/TOia,2026-01-18T04:05:15.917Z,2026-01-18T04:05:15.917Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m579:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m579:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(da2133f2743c74e598e9e3d714f4543f) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w19_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[83/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Regeneration[2m > [22mshould regenerate backup codes
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 2546a75cb44e6051ee1e3d4775225bea,$2b$12$yOhwp0HnMuek4Eher5rouOSigtZF6ZZZDL.Cp8/23IgyuFGLi/wu.,2026-01-18T04:05:16.658Z,2026-01-18T04:05:16.658Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m613:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m613:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(2546a75cb44e6051ee1e3d4775225bea) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w20_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[84/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mBackup Code Regeneration[2m > [22mshould return error if MFA not enabled
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: ba5e698f7e731778666f64b6fa2880a4,$2b$12$aEENcLupS43MJvKmWdFPQOzE2sTicN9KVWueyk5qWR3uuSBF1eW.y,2026-01-18T04:05:17.426Z,2026-01-18T04:05:17.426Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m646:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m646:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(ba5e698f7e731778666f64b6fa2880a4) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w15_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[85/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/mfa.flow.real.test.ts[2m > [22mMFA Flow Integration Tests (REAL)[2m > [22mTenant-Level MFA Enforcement[2m > [22mshould enforce MFA for tenant users when required by tenant
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 9deea13d3e144b52c5e44121a9fc0d24,$2b$12$Y3mD1UMUjTfFJrLBfeskUObEvfpURPNhXHadLa9G2pIx08NOegNi6,2026-01-18T04:05:18.237Z,2026-01-18T04:05:18.237Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m673:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/mfa.flow.real.test.ts:[2m673:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(9deea13d3e144b52c5e44121a9fc0d24) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w0_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[86/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould create placeholder user for non-existent email
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22macceptInvite[2m > [22mshould convert placeholder user to real user on accept
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22macceptInvite[2m > [22mshould reject already accepted invite
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mgetPendingInvitesForUser[2m > [22mshould return pending invites for user email
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mgetPendingInvitesForUser[2m > [22mshould not return accepted invites
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mrevokeInvite[2m > [22mshould allow admin to revoke invite
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default)
params: 00000000-0000-0000-0000-000000000021,admin@test.com,Admin User,00000000-0000-0000-0000-000000000098,00000000-0000-0000-0000-000000000022,existing_1768709097635@test.com,Existing User,00000000-0000-0000-0000-000000000098[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m46:9[22m[39m
    [90m 44| [39m        await db.delete(users).where(inArray(users.id, [adminUserId, eâ€¦
    [90m 45| [39m
    [90m 46| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 47| [39m            { id: adminUserId, email: 'admin@test.com', fullName: 'Admâ€¦
    [90m 48| [39m            { id: existingUserId, email: existingUserEmail, fullName: â€¦

[31m[1mCaused by: error[22m: duplicate key value violates unique constraint "users_pkey"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m46:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 227, severity: 'ERROR', code: '23505', detail: 'Key (id)=(00000000-0000-0000-0000-000000000021) already exists.', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'users', dataType: undefined, constraint: 'users_pkey', file: 'nbtinsert.c', routine: '_bt_check_unique' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[87/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould create invite for existing user without creating placeholder
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2mâ¯[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2mâ¯[22m OrganizationService.createInvite server/services/OrganizationService.ts:[2m438:5[22m[39m
[90m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m100:28[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[88/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould prevent duplicate pending invites
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22macceptInvite[2m > [22mshould verify email matches invite
[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mrevokeInvite[2m > [22mshould prevent accepting revoked invite
[31m[1mError[22m: User must belong to a tenant to create organizations[39m
[36m [2mâ¯[22m OrganizationService.createOrganization server/services/OrganizationService.ts:[2m49:13[22m[39m
    [90m 47| [39m
    [90m 48| [39m    [35mif[39m ([33m![39muser[33m?.[39mtenantId) {
    [90m 49| [39m      throw new Error('User must belong to a tenant to create organizaâ€¦
    [90m   | [39m            [31m^[39m
    [90m 50| [39m    }
    [90m 51| [39m
[90m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m53:21[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[89/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould prevent inviting existing members
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2mâ¯[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2mâ¯[22m OrganizationService.addMember server/services/OrganizationService.ts:[2m410:5[22m[39m
[90m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m128:13[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[90/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mcreateInvite[2m > [22mshould set expiry to 7 days from now
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2mâ¯[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2mâ¯[22m OrganizationService.createInvite server/services/OrganizationService.ts:[2m438:5[22m[39m
[90m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m143:28[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[91/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22macceptInvite[2m > [22mshould accept invite and create membership
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2mâ¯[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2mâ¯[22m OrganizationService.createInvite server/services/OrganizationService.ts:[2m438:5[22m[39m
[90m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m165:34[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[92/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22macceptInvite[2m > [22mshould reject expired invite
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2mâ¯[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2mâ¯[22m OrganizationService.createInvite server/services/OrganizationService.ts:[2m438:5[22m[39m
[90m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m216:34[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[93/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationInvites.test.ts[2m > [22mOrganization Invites[2m > [22mgetPendingInvitesForUser[2m > [22mshould not return expired invites
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2mâ¯[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2mâ¯[22m OrganizationService.createInvite server/services/OrganizationService.ts:[2m438:5[22m[39m
[90m [2mâ¯[22m tests/integration/organizationInvites.test.ts:[2m294:34[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[94/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-audit-fixes.test.ts[2m > [22mOrganization Audit Fixes[2m > [22mFIX #1: Project transfer cascades runs ownership[2m > [22mshould cascade ownership to workflow runs when project is transferred
[31m[1mError[22m: Failed query: insert into "workflow_runs" ("id", "workflow_id", "workflow_version_id", "run_token", "created_by", "current_section_id", "progress", "completed", "completed_at", "metadata", "created_at", "updated_at", "client_email", "portal_access_key", "access_mode", "share_token", "share_token_expires_at", "owner_type", "owner_uuid") values (default, $1, default, $2, $3, default, default, default, default, default, default, default, default, default, default, default, default, $4, $5) returning "id", "workflow_id", "workflow_version_id", "run_token", "created_by", "current_section_id", "progress", "completed", "completed_at", "metadata", "created_at", "updated_at", "client_email", "portal_access_key", "access_mode", "share_token", "share_token_expires_at", "owner_type", "owner_uuid"
params: 43ce4f52-baaa-425b-812a-d12429ac6bc3,c47e4400-771c-46de-a90e-22295a15d075,d67fd2e0-2442-45bd-b871-8386f4833d4b,user,d67fd2e0-2442-45bd-b871-8386f4833d4b[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/organizations-audit-fixes.test.ts:[2m135:21[22m[39m
    [90m133| [39m
    [90m134| [39m      [90m// Create a run[39m
    [90m135| [39m      [35mconst[39m [run] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(workflowRuns)[33m.[39m[34mvalues[39m({
    [90m   | [39m                    [31m^[39m
    [90m136| [39m        workflowId[33m:[39m workflow[33m.[39mid[33m,[39m
    [90m137| [39m        runToken[33m:[39m [34muuidv4[39m()[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "workflow_runs" violates foreign key constraint "workflow_runs_workflow_id_workflows_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/organizations-audit-fixes.test.ts:[2m135:21[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 359, severity: 'ERROR', code: '23503', detail: 'Key (workflow_id)=(43ce4f52-baaa-425b-812a-d12429ac6bc3) is not present in table "workflows".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w28_v3', table: 'workflow_runs', dataType: undefined, constraint: 'workflow_runs_workflow_id_workflows_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[95/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-audit-fixes.test.ts[2m > [22mOrganization Audit Fixes[2m > [22mFIX #2: Invite acceptance race condition[2m > [22mshould prevent double-acceptance via transaction
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2mâ¯[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2mâ¯[22m OrganizationService.createInvite server/services/OrganizationService.ts:[2m438:5[22m[39m
[90m [2mâ¯[22m tests/integration/organizations-audit-fixes.test.ts:[2m164:22[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[96/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-audit-fixes.test.ts[2m > [22mOrganization Audit Fixes[2m > [22mFIX #3: Invite email failure rollback[2m > [22mshould not create invite if email fails
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2mâ¯[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2mâ¯[22m OrganizationService.createInvite server/services/OrganizationService.ts:[2m438:5[22m[39m
[90m [2mâ¯[22m tests/integration/organizations-audit-fixes.test.ts:[2m192:22[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[97/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-audit-fixes.test.ts[2m > [22mOrganization Audit Fixes[2m > [22mFIX #5: Expired invites[2m > [22mshould allow re-invite after invite expires
[31m[1mError[22m: Organization not found[39m
[36m [2mâ¯[22m OrganizationService.createInvite server/services/OrganizationService.ts:[2m449:13[22m[39m
    [90m447| [39m
    [90m448| [39m    [35mif[39m ([33m![39morg) {
    [90m449| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m'Organization not found'[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m450| [39m    }
    [90m451| [39m
[90m [2mâ¯[22m tests/integration/organizations-audit-fixes.test.ts:[2m215:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[98/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-audit-fixes.test.ts[2m > [22mOrganization Audit Fixes[2m > [22mFIX #7: Delete organization[2m > [22mshould allow last admin to delete empty organization
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2mâ¯[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2mâ¯[22m OrganizationService.deleteOrganization server/services/OrganizationService.ts:[2m904:5[22m[39m
[90m [2mâ¯[22m tests/integration/organizations-audit-fixes.test.ts:[2m250:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[99/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-audit-fixes.test.ts[2m > [22mOrganization Audit Fixes[2m > [22mFIX #7: Delete organization[2m > [22mshould prevent deletion if org owns assets
[31m[1mError[22m: Access denied: You do not have permission to create assets with this ownership[39m
[36m [2mâ¯[22m WorkflowService.createWorkflow server/services/WorkflowService.ts:[2m168:13[22m[39m
    [90m166| [39m    const canCreate = await canCreateWithOwnership(creatorId, ownerTypâ€¦
    [90m167| [39m    [35mif[39m ([33m![39mcanCreate) {
    [90m168| [39m      throw new Error('Access denied: You do not have permission to crâ€¦
    [90m   | [39m            [31m^[39m
    [90m169| [39m    }
    [90m170| [39m
[90m [2mâ¯[22m tests/integration/organizations-audit-fixes.test.ts:[2m267:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[100/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-audit-fixes.test.ts[2m > [22mOrganization Audit Fixes[2m > [22mFIX #8: Placeholder user cleanup[2m > [22mshould cleanup placeholder user when invite is revoked
[31m[1mAssertionError[22m: expected undefined to be true // Object.is equality[39m

[32m- Expected:[39m 
true

[31m+ Received:[39m 
undefined

[36m [2mâ¯[22m tests/integration/organizations-audit-fixes.test.ts:[2m302:46[22m[39m
    [90m300| [39m      })[33m;[39m
    [90m301| [39m
    [90m302| [39m      [34mexpect[39m(placeholderUser[33m?.[39misPlaceholder)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m   | [39m                                             [31m^[39m
    [90m303| [39m
    [90m304| [39m      [90m// Revoke invite (should trigger cleanup)[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[101/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-workflow.test.ts[2m > [22mOrganization Workflow Integration Tests[2m > [22mComplete Organization Workflow[2m > [22mStep 2: Invite member via email
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2mâ¯[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2mâ¯[22m OrganizationService.createInvite server/services/OrganizationService.ts:[2m438:5[22m[39m
[90m [2mâ¯[22m tests/integration/organizations-workflow.test.ts:[2m117:22[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[102/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-workflow.test.ts[2m > [22mOrganization Workflow Integration Tests[2m > [22mComplete Organization Workflow[2m > [22mStep 3: Accept invite
[31m[1mError[22m: Invite not found[39m
[36m [2mâ¯[22m OrganizationService.acceptInvite server/services/OrganizationService.ts:[2m702:13[22m[39m
    [90m700| [39m
    [90m701| [39m    [35mif[39m ([33m![39minvite) {
    [90m702| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m'Invite not found'[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m703| [39m    }
    [90m704| [39m
[90m [2mâ¯[22m tests/integration/organizations-workflow.test.ts:[2m141:22[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[103/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-workflow.test.ts[2m > [22mOrganization Workflow Integration Tests[2m > [22mComplete Organization Workflow[2m > [22mStep 5: Transfer workflow to organization
[31m[1mError[22m: Workflow not found[39m
[36m [2mâ¯[22m WorkflowService.verifyAccess server/services/WorkflowService.ts:[2m132:13[22m[39m
    [90m130| [39m
    [90m131| [39m    [35mif[39m ([33m![39mworkflow) {
    [90m132| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Workflow not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m133| [39m    }
    [90m134| [39m
[90m [2mâ¯[22m WorkflowService.transferOwnership server/services/WorkflowService.ts:[2m855:22[22m[39m
[90m [2mâ¯[22m tests/integration/organizations-workflow.test.ts:[2m185:27[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[104/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-workflow.test.ts[2m > [22mOrganization Workflow Integration Tests[2m > [22mComplete Organization Workflow[2m > [22mStep 6: Org member (user2) can access workflow
[31m[1mError[22m: Access denied - insufficient permissions for this workflow[39m
[36m [2mâ¯[22m WorkflowService.verifyAccess server/services/WorkflowService.ts:[2m151:13[22m[39m
    [90m149| [39m
    [90m150| [39m    [35mif[39m ([33m![39mhasAclAccess) {
    [90m151| [39m      throw new Error("Access denied - insufficient permissions for thâ€¦
    [90m   | [39m            [31m^[39m
    [90m152| [39m    }
    [90m153| [39m
[90m [2mâ¯[22m WorkflowService.getWorkflowWithDetails server/services/WorkflowService.ts:[2m209:22[22m[39m
[90m [2mâ¯[22m tests/integration/organizations-workflow.test.ts:[2m207:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[105/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-workflow.test.ts[2m > [22mOrganization Workflow Integration Tests[2m > [22mComplete Organization Workflow[2m > [22mStep 7: Org member (user2) can update workflow
[31m[1mError[22m: Workflow not found[39m
[36m [2mâ¯[22m WorkflowService.verifyAccess server/services/WorkflowService.ts:[2m132:13[22m[39m
    [90m130| [39m
    [90m131| [39m    [35mif[39m ([33m![39mworkflow) {
    [90m132| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m"Workflow not found"[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m133| [39m    }
    [90m134| [39m
[90m [2mâ¯[22m WorkflowService.updateWorkflow server/services/WorkflowService.ts:[2m286:5[22m[39m
[90m [2mâ¯[22m tests/integration/organizations-workflow.test.ts:[2m219:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[106/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-workflow.test.ts[2m > [22mOrganization Workflow Integration Tests[2m > [22mComplete Organization Workflow[2m > [22mStep 12: Org member can see workflow in list
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- true[39m
[31m+ false[39m

[36m [2mâ¯[22m tests/integration/organizations-workflow.test.ts:[2m274:62[22m[39m
    [90m272| [39m
    [90m273| [39m      [34mexpect[39m(workflows)[33m.[39m[34mtoBeDefined[39m()[33m;[39m
    [90m274| [39m      expect(workflows.some((w) => w.id === testWorkflowId)).toBe(trueâ€¦
    [90m   | [39m                                                             [31m^[39m
    [90m275| [39m    })[33m;[39m
    [90m276| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[107/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-workflow.test.ts[2m > [22mOrganization Workflow Integration Tests[2m > [22mComplete Organization Workflow[2m > [22mStep 14: Remove member from org
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2mâ¯[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2mâ¯[22m OrganizationService.removeMember server/services/OrganizationService.ts:[2m312:5[22m[39m
[90m [2mâ¯[22m tests/integration/organizations-workflow.test.ts:[2m285:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[108/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-workflow.test.ts[2m > [22mOrganization Workflow Integration Tests[2m > [22mComplete Organization Workflow[2m > [22mStep 16: Re-add member and verify access restored
[31m[1mError[22m: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: ca586c81-a483-4390-84c2-02eaddc73f3b,d521fa4d-43a5-427f-b39f-2eaffc5e8650,member[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m OrganizationService.addMember server/services/OrganizationService.ts:[2m420:5[22m[39m
    [90m418| [39m
    [90m419| [39m    [90m// Add membership[39m
    [90m420| [39m    [35mawait[39m db[33m.[39m[34minsert[39m(organizationMemberships)[33m.[39m[34mvalues[39m({
    [90m   | [39m    [31m^[39m
    [90m421| [39m      orgId[33m,[39m
    [90m422| [39m      userId[33m:[39m targetUserId[33m,[39m
[90m [2mâ¯[22m tests/integration/organizations-workflow.test.ts:[2m307:7[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "organization_memberships" violates foreign key constraint "organization_memberships_org_id_organizations_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m OrganizationService.addMember server/services/OrganizationService.ts:[2m420:5[22m[39m
[90m [2mâ¯[22m tests/integration/organizations-workflow.test.ts:[2m307:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 400, severity: 'ERROR', code: '23503', detail: 'Key (org_id)=(ca586c81-a483-4390-84c2-02eaddc73f3b) is not present in table "organizations".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w46_v3', table: 'organization_memberships', dataType: undefined, constraint: 'organization_memberships_org_id_organizations_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[109/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizations-workflow.test.ts[2m > [22mOrganization Workflow Integration Tests[2m > [22mEdge Cases and Security[2m > [22mCannot invite same email twice (pending invite exists)
[31m[1mError[22m: Organization not found[39m
[36m [2mâ¯[22m OrganizationService.createInvite server/services/OrganizationService.ts:[2m449:13[22m[39m
    [90m447| [39m
    [90m448| [39m    [35mif[39m ([33m![39morg) {
    [90m449| [39m      [35mthrow[39m [35mnew[39m [33mError[39m([32m'Organization not found'[39m)[33m;[39m
    [90m   | [39m            [31m^[39m
    [90m450| [39m    }
    [90m451| [39m
[90m [2mâ¯[22m tests/integration/organizations-workflow.test.ts:[2m323:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[110/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mcreateOrganization[2m > [22mshould create organization and auto-create admin membership
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,96a8a4c1-c664-4eec-9151-60b5be7aad34,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,96a8a4c1-c664-4eec-9151-60b5be7aad34,96a8a4c1-c664-4eec-9151-60b5be7aad34[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(96a8a4c1-c664-4eec-9151-60b5be7aad34) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w0_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[111/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mgetUserOrganizations[2m > [22mshould return all organizations for user
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,dc976b4e-4080-46da-9ab7-85ec77e3bb50,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,dc976b4e-4080-46da-9ab7-85ec77e3bb50,dc976b4e-4080-46da-9ab7-85ec77e3bb50[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(dc976b4e-4080-46da-9ab7-85ec77e3bb50) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[112/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mgetUserOrganizations[2m > [22mshould return empty array for user with no memberships
[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mremoveMember[2m > [22mshould prevent self-removal
[31m[1mError[22m: Test setup failed: User 00000000-0000-0000-0000-000000000011 missing tenantId[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m54:19[22m[39m
    [90m 52| [39m        [35mif[39m ([33m![39muserCheck[33m?.[39mtenantId) {
    [90m 53| [39m            console.error('CRITICAL: User lookup failed validation in â€¦
    [90m 54| [39m            throw new Error(`Test setup failed: User ${testUserId1} miâ€¦
    [90m   | [39m                  [31m^[39m
    [90m 55| [39m        }
    [90m 56| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[113/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mupdateOrganization[2m > [22mshould allow admin to update organization
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,5fe0516f-8b61-4c27-9d52-8bcb0bf3e3f2,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,5fe0516f-8b61-4c27-9d52-8bcb0bf3e3f2,5fe0516f-8b61-4c27-9d52-8bcb0bf3e3f2[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(5fe0516f-8b61-4c27-9d52-8bcb0bf3e3f2) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[114/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mupdateOrganization[2m > [22mshould deny non-admin from updating organization
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,8dee0eb3-bfd1-40b2-80d2-c77a042e3bef,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,8dee0eb3-bfd1-40b2-80d2-c77a042e3bef,8dee0eb3-bfd1-40b2-80d2-c77a042e3bef[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(8dee0eb3-bfd1-40b2-80d2-c77a042e3bef) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w2_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[115/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mgetOrganizationMembers[2m > [22mshould return all members of organization
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,e845eddb-5c96-42a0-b601-c257be62e18b,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,e845eddb-5c96-42a0-b601-c257be62e18b,e845eddb-5c96-42a0-b601-c257be62e18b[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(e845eddb-5c96-42a0-b601-c257be62e18b) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w19_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[116/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mpromoteMember[2m > [22mshould allow admin to promote member
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,35a8b990-a7cc-4455-b36a-5fcf3448e420,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,35a8b990-a7cc-4455-b36a-5fcf3448e420,35a8b990-a7cc-4455-b36a-5fcf3448e420[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(35a8b990-a7cc-4455-b36a-5fcf3448e420) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w17_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[117/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mdemoteMember[2m > [22mshould allow admin to demote other admin
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,df8c0167-eca1-4088-b4e4-8fd218e19636,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,df8c0167-eca1-4088-b4e4-8fd218e19636,df8c0167-eca1-4088-b4e4-8fd218e19636[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(df8c0167-eca1-4088-b4e4-8fd218e19636) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[118/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mdemoteMember[2m > [22mshould prevent self-demotion
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,a9c638a7-970c-41b7-969c-601e656f8b5e,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,a9c638a7-970c-41b7-969c-601e656f8b5e,a9c638a7-970c-41b7-969c-601e656f8b5e[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(a9c638a7-970c-41b7-969c-601e656f8b5e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w0_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[119/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mremoveMember[2m > [22mshould allow admin to remove member
[31m[1mError[22m: Failed query: insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values (default, $1, default, default, default, default, $2, $3, default, default) returning "id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at"
params: Remove Test Org Int,052a3919-4c40-4089-8e28-908593713431,00000000-0000-0000-0000-000000000011[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m server/services/OrganizationService.ts:[2m54:21[22m[39m
    [90m 52| [39m    [35mreturn[39m db[33m.[39m[34mtransaction[39m([35masync[39m (tx) [33m=>[39m {
    [90m 53| [39m      [90m// Create organization with tenant scoping[39m
    [90m 54| [39m      [35mconst[39m [org] [33m=[39m [35mawait[39m tx
    [90m   | [39m                    [31m^[39m
    [90m 55| [39m        [33m.[39m[34minsert[39m(organizations)
    [90m 56| [39m        [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m227:25[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "organizations" violates foreign key constraint "organizations_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m server/services/OrganizationService.ts:[2m54:21[22m[39m
[90m [2mâ¯[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m227:25[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 347, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(052a3919-4c40-4089-8e28-908593713431) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w16_v3', table: 'organizations', dataType: undefined, constraint: 'organizations_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[120/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mleaveOrganization[2m > [22mshould allow member to leave organization
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, default, default, default, $4, default, default, default, default, default, default, default, default, default, default, default), ($5, $6, $7, default, default, default, $8, default, default, default, default, default, default, default, default, default, default, default) on conflict ("id") do update set "tenant_id" = $9
params: 00000000-0000-0000-0000-000000000011,orgtest1_int@test.com,Org Test User 1 Int,77f7feee-e78b-4491-9c5d-a373edaf3510,00000000-0000-0000-0000-000000000012,orgtest2_int@test.com,Org Test User 2 Int,77f7feee-e78b-4491-9c5d-a373edaf3510,77f7feee-e78b-4491-9c5d-a373edaf3510[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m
    [90m 31| [39m
    [90m 32| [39m        // Create test users with tenantId using upsert to guarantee sâ€¦
    [90m 33| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m([
    [90m   | [39m        [31m^[39m
    [90m 34| [39m            { id: testUserId1, email: 'orgtest1_int@test.com', fullNamâ€¦
    [90m 35| [39m            { id: testUserId2, email: 'orgtest2_int@test.com', fullNamâ€¦

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m33:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(77f7feee-e78b-4491-9c5d-a373edaf3510) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w0_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[121/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/organizationService.test.ts[2m > [22mOrganizationService Integration[2m > [22mleaveOrganization[2m > [22mshould allow admin to leave organization
[31m[1mError[22m: Failed query: insert into "organizations" ("id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at") values (default, $1, default, default, default, default, $2, $3, default, default) returning "id", "name", "description", "slug", "domain", "settings", "tenant_id", "created_by_user_id", "created_at", "updated_at"
params: Admin Leave Test Int,c4f33371-fe33-4744-89da-4a387f6b9185,00000000-0000-0000-0000-000000000011[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m server/services/OrganizationService.ts:[2m54:21[22m[39m
    [90m 52| [39m    [35mreturn[39m db[33m.[39m[34mtransaction[39m([35masync[39m (tx) [33m=>[39m {
    [90m 53| [39m      [90m// Create organization with tenant scoping[39m
    [90m 54| [39m      [35mconst[39m [org] [33m=[39m [35mawait[39m tx
    [90m   | [39m                    [31m^[39m
    [90m 55| [39m        [33m.[39m[34minsert[39m(organizations)
    [90m 56| [39m        [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m272:25[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "organizations" violates foreign key constraint "organizations_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg/lib/client.js:[2m545:17[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m server/services/OrganizationService.ts:[2m54:21[22m[39m
[90m [2mâ¯[22m NodePgSession.transaction node_modules/drizzle-orm/node-postgres/session.js:[2m186:22[22m[39m
[90m [2mâ¯[22m tests/integration/organizationService.test.ts:[2m272:25[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 347, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(c4f33371-fe33-4744-89da-4a387f6b9185) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w16_v3', table: 'organizations', dataType: undefined, constraint: 'organizations_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[122/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22mcanAccessAsset[2m > [22mshould allow access to org-owned asset by org member
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- true[39m
[31m+ false[39m

[36m [2mâ¯[22m tests/integration/ownershipAccess.test.ts:[2m87:25[22m[39m
    [90m 85| [39m
    [90m 86| [39m      [35mconst[39m hasAccess [33m=[39m [35mawait[39m [34mcanAccessAsset[39m(userId1[33m,[39m [32m'org'[39m[33m,[39m orgId1)[33m;[39m
    [90m 87| [39m      [34mexpect[39m(hasAccess)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m   | [39m                        [31m^[39m
    [90m 88| [39m    })[33m;[39m
    [90m 89| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[123/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22misOrgMember[2m > [22mshould return true for org admin
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- true[39m
[31m+ false[39m

[36m [2mâ¯[22m tests/integration/ownershipAccess.test.ts:[2m126:24[22m[39m
    [90m124| [39m
    [90m125| [39m      [35mconst[39m isMember [33m=[39m [35mawait[39m [34misOrgMember[39m(userId1[33m,[39m orgId1)[33m;[39m
    [90m126| [39m      [34mexpect[39m(isMember)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m127| [39m    })[33m;[39m
    [90m128| [39m  })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[124/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22mcanManageOrg[2m > [22mshould return true for org admin
[31m[1mError[22m: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: 10000000-0000-0000-0000-000000000001,00000000-0000-0000-0000-000000000001,admin[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/ownershipAccess.test.ts:[2m132:7[22m[39m
    [90m130| [39m  [34mdescribe[39m([32m'canManageOrg'[39m[33m,[39m () [33m=>[39m {
    [90m131| [39m    [34mit[39m([32m'should return true for org admin'[39m[33m,[39m [35masync[39m () [33m=>[39m {
    [90m132| [39m      [35mawait[39m db[33m.[39m[34minsert[39m(organizationMemberships)[33m.[39m[34mvalues[39m({
    [90m   | [39m      [31m^[39m
    [90m133| [39m        orgId[33m:[39m orgId1[33m,[39m
    [90m134| [39m        userId[33m:[39m userId1[33m,[39m

[31m[1mCaused by: error[22m: duplicate key value violates unique constraint "org_membership_unique_idx"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/ownershipAccess.test.ts:[2m132:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 326, severity: 'ERROR', code: '23505', detail: 'Key (org_id, user_id)=(10000000-0000-0000-0000-000000000001, 00000000-0000-0000-0000-000000000001) already exists.', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'organization_memberships', dataType: undefined, constraint: 'org_membership_unique_idx', file: 'nbtinsert.c', routine: '_bt_check_unique' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[125/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22mcanManageOrg[2m > [22mshould return false for org member (non-admin)
[31m[1mError[22m: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: 10000000-0000-0000-0000-000000000001,00000000-0000-0000-0000-000000000001,member[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/ownershipAccess.test.ts:[2m143:7[22m[39m
    [90m141| [39m
    [90m142| [39m    [34mit[39m([32m'should return false for org member (non-admin)'[39m[33m,[39m [35masync[39m () [33m=>[39m {
    [90m143| [39m      [35mawait[39m db[33m.[39m[34minsert[39m(organizationMemberships)[33m.[39m[34mvalues[39m({
    [90m   | [39m      [31m^[39m
    [90m144| [39m        orgId[33m:[39m orgId1[33m,[39m
    [90m145| [39m        userId[33m:[39m userId1[33m,[39m

[31m[1mCaused by: error[22m: duplicate key value violates unique constraint "org_membership_unique_idx"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/ownershipAccess.test.ts:[2m143:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 326, severity: 'ERROR', code: '23505', detail: 'Key (org_id, user_id)=(10000000-0000-0000-0000-000000000001, 00000000-0000-0000-0000-000000000001) already exists.', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'organization_memberships', dataType: undefined, constraint: 'org_membership_unique_idx', file: 'nbtinsert.c', routine: '_bt_check_unique' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[126/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22mgetUserOrgIds[2m > [22mshould return all org IDs for a user
[31m[1mError[22m: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default), (default, $4, $5, $6, default)
params: 10000000-0000-0000-0000-000000000001,00000000-0000-0000-0000-000000000001,member,10000000-0000-0000-0000-000000000002,00000000-0000-0000-0000-000000000001,admin[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/ownershipAccess.test.ts:[2m161:7[22m[39m
    [90m159| [39m  [34mdescribe[39m([32m'getUserOrgIds'[39m[33m,[39m () [33m=>[39m {
    [90m160| [39m    [34mit[39m([32m'should return all org IDs for a user'[39m[33m,[39m [35masync[39m () [33m=>[39m {
    [90m161| [39m      [35mawait[39m db[33m.[39m[34minsert[39m(organizationMemberships)[33m.[39m[34mvalues[39m([
    [90m   | [39m      [31m^[39m
    [90m162| [39m        { orgId[33m:[39m orgId1[33m,[39m userId[33m:[39m userId1[33m,[39m role[33m:[39m [32m'member'[39m }[33m,[39m
    [90m163| [39m        { orgId[33m:[39m orgId2[33m,[39m userId[33m:[39m userId1[33m,[39m role[33m:[39m [32m'admin'[39m }[33m,[39m

[31m[1mCaused by: error[22m: duplicate key value violates unique constraint "org_membership_unique_idx"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/ownershipAccess.test.ts:[2m161:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 326, severity: 'ERROR', code: '23505', detail: 'Key (org_id, user_id)=(10000000-0000-0000-0000-000000000001, 00000000-0000-0000-0000-000000000001) already exists.', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'organization_memberships', dataType: undefined, constraint: 'org_membership_unique_idx', file: 'nbtinsert.c', routine: '_bt_check_unique' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[127/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22mcanCreateWithOwnership[2m > [22mshould allow creating org-owned asset if user is member
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- true[39m
[31m+ false[39m

[36m [2mâ¯[22m tests/integration/ownershipAccess.test.ts:[2m197:25[22m[39m
    [90m195| [39m
    [90m196| [39m      const canCreate = await canCreateWithOwnership(userId1, 'org', oâ€¦
    [90m197| [39m      [34mexpect[39m(canCreate)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m   | [39m                        [31m^[39m
    [90m198| [39m    })[33m;[39m
    [90m199| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[128/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22mCross-org Access Control[2m > [22mshould not allow member of org1 to access org2-owned assets
[31m[1mError[22m: Failed query: insert into "organization_memberships" ("id", "org_id", "user_id", "role", "created_at") values (default, $1, $2, $3, default)
params: 10000000-0000-0000-0000-000000000001,00000000-0000-0000-0000-000000000001,member[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/ownershipAccess.test.ts:[2m208:7[22m[39m
    [90m206| [39m  [34mdescribe[39m([32m'Cross-org Access Control'[39m[33m,[39m () [33m=>[39m {
    [90m207| [39m    it('should not allow member of org1 to access org2-owned assets', â€¦
    [90m208| [39m      [35mawait[39m db[33m.[39m[34minsert[39m(organizationMemberships)[33m.[39m[34mvalues[39m({
    [90m   | [39m      [31m^[39m
    [90m209| [39m        orgId[33m:[39m orgId1[33m,[39m
    [90m210| [39m        userId[33m:[39m userId1[33m,[39m

[31m[1mCaused by: error[22m: duplicate key value violates unique constraint "org_membership_unique_idx"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/ownershipAccess.test.ts:[2m208:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 326, severity: 'ERROR', code: '23505', detail: 'Key (org_id, user_id)=(10000000-0000-0000-0000-000000000001, 00000000-0000-0000-0000-000000000001) already exists.', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'organization_memberships', dataType: undefined, constraint: 'org_membership_unique_idx', file: 'nbtinsert.c', routine: '_bt_check_unique' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[129/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/ownershipAccess.test.ts[2m > [22mOwnership Access Control[2m > [22mCross-org Access Control[2m > [22mshould allow member of multiple orgs to access all their org assets
[31m[1mAssertionError[22m: expected false to be true // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- true[39m
[31m+ false[39m

[36m [2mâ¯[22m tests/integration/ownershipAccess.test.ts:[2m227:26[22m[39m
    [90m225| [39m      [35mconst[39m hasAccess2 [33m=[39m [35mawait[39m [34mcanAccessAsset[39m(userId1[33m,[39m [32m'org'[39m[33m,[39m orgId2)[33m;[39m
    [90m226| [39m
    [90m227| [39m      [34mexpect[39m(hasAccess1)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m228| [39m      [34mexpect[39m(hasAccess2)[33m.[39m[34mtoBe[39m([35mtrue[39m)[33m;[39m
    [90m229| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[130/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/regression-REG-1.test.ts[2m > [22mREG-1: Workflow Logic Regression[2m > [22m1. Required + Show/Hide (Questions)[2m > [22mshould block Next when required visible question is empty
[31m[1mError[22m: Failed query: insert into "steps" ("id", "section_id", "type", "title", "description", "required", "options", "alias", "default_value", "order", "is_virtual", "visible_if", "repeater_config", "created_at", "updated_at") values ($1, $2, $3, $4, default, $5, $6, $7, default, $8, default, default, default, default, default)
params: 93cc6dff-8948-4ccc-898a-f5b42ee63c1a,91a43c56-31eb-4044-9084-b1ab9c8772b7,text,Required Question,true,{},required_q,1[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/regression-REG-1.test.ts:[2m129:13[22m[39m
    [90m127| [39m        it("should block Next when required visible question is empty"â€¦
    [90m128| [39m            [35mconst[39m stepId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m129| [39m            [35mawait[39m db[33m.[39m[34minsert[39m(steps)[33m.[39m[34mvalues[39m({
    [90m   | [39m            [31m^[39m
    [90m130| [39m                id[33m:[39m stepId[33m,[39m
    [90m131| [39m                sectionId[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "steps" violates foreign key constraint "steps_section_id_sections_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/regression-REG-1.test.ts:[2m129:13[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 321, severity: 'ERROR', code: '23503', detail: 'Key (section_id)=(91a43c56-31eb-4044-9084-b1ab9c8772b7) is not present in table "sections".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w15_v3', table: 'steps', dataType: undefined, constraint: 'steps_section_id_sections_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[131/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/regression-REG-1.test.ts[2m > [22mREG-1: Workflow Logic Regression[2m > [22m1. Required + Show/Hide (Questions)[2m > [22mshould NOT block Next when required question is hidden
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: 680c5288-d14b-4326-9800-8d8f675094d1,Required Question Test,d595cb49-015e-4cb5-92b8-9377871d1946,d595cb49-015e-4cb5-92b8-9377871d1946,80890dca-f024-4bb7-a6f2-a9115b288470,923dc435-5534-4d27-af89-a2e3ff2a4760[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/regression-REG-1.test.ts:[2m100:13[22m[39m
    [90m 98| [39m            workflowVersionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 99| [39m
    [90m100| [39m            [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m            [31m^[39m
    [90m101| [39m                id[33m:[39m workflowId[33m,[39m
    [90m102| [39m                projectId[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/regression-REG-1.test.ts:[2m100:13[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(d595cb49-015e-4cb5-92b8-9377871d1946) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w15_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[132/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/regression-REG-1.test.ts[2m > [22mREG-1: Workflow Logic Regression[2m > [22m1. Required + Show/Hide (Questions)[2m > [22mshould block when required becomes visible and is empty
[31m[1mError[22m: Failed query: insert into "steps" ("id", "section_id", "type", "title", "description", "required", "options", "alias", "default_value", "order", "is_virtual", "visible_if", "repeater_config", "created_at", "updated_at") values ($1, $2, $3, $4, default, $5, $6, $7, default, $8, default, $9, default, default, default)
params: fa844d09-d299-49ac-acbc-620ab4d683e6,c682c269-ee87-44a2-84e4-1203cb561481,text,Conditionally Required,true,{},cond_required,2,"show_trigger == true"[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/regression-REG-1.test.ts:[2m234:13[22m[39m
    [90m232| [39m
    [90m233| [39m            [35mconst[39m requiredStepId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m234| [39m            [35mawait[39m db[33m.[39m[34minsert[39m(steps)[33m.[39m[34mvalues[39m({
    [90m   | [39m            [31m^[39m
    [90m235| [39m                id[33m:[39m requiredStepId[33m,[39m
    [90m236| [39m                sectionId[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "steps" violates foreign key constraint "steps_section_id_sections_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/regression-REG-1.test.ts:[2m234:13[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 321, severity: 'ERROR', code: '23503', detail: 'Key (section_id)=(c682c269-ee87-44a2-84e4-1203cb561481) is not present in table "sections".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w31_v3', table: 'steps', dataType: undefined, constraint: 'steps_section_id_sections_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[133/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/regression-REG-1.test.ts[2m > [22mREG-1: Workflow Logic Regression[2m > [22m2. Required + Show/Hide (Pages)[2m > [22mshould skip hidden required page entirely
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values ($1, $2, default, $3, $4, default, default, default, $5, $6, default, default, default, default, default, default, default, default, default, default, default)
params: 6b6aa462-24cb-4055-af7f-0ad882d3fa32,Page Visibility Test,d595cb49-015e-4cb5-92b8-9377871d1946,d595cb49-015e-4cb5-92b8-9377871d1946,80890dca-f024-4bb7-a6f2-a9115b288470,458e7223-d0ed-4f4e-b0dc-ddc5005fad06[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/regression-REG-1.test.ts:[2m272:13[22m[39m
    [90m270| [39m            workflowVersionId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m271| [39m
    [90m272| [39m            [35mawait[39m db[33m.[39m[34minsert[39m(workflows)[33m.[39m[34mvalues[39m({
    [90m   | [39m            [31m^[39m
    [90m273| [39m                id[33m:[39m workflowId[33m,[39m
    [90m274| [39m                projectId[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/regression-REG-1.test.ts:[2m272:13[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(d595cb49-015e-4cb5-92b8-9377871d1946) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w15_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[134/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/regression-REG-1.test.ts[2m > [22mREG-1: Workflow Logic Regression[2m > [22m2. Required + Show/Hide (Pages)[2m > [22mshould enforce required on visible page
[31m[1mError[22m: Failed query: insert into "workflow_versions" ("id", "workflow_id", "base_id", "version_number", "is_draft", "graph_json", "migration_info", "changelog", "notes", "checksum", "created_by", "published", "published_at", "created_at", "updated_at") values ($1, $2, default, $3, default, $4, default, default, default, default, $5, default, default, default, default)
params: ba1fd164-6e8f-4697-95df-3639b1eab4c6,b4a120b2-b73f-4135-aacc-e9a50f27e11e,1,{},d595cb49-015e-4cb5-92b8-9377871d1946[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/regression-REG-1.test.ts:[2m367:13[22m[39m
    [90m365| [39m            })[33m;[39m
    [90m366| [39m
    [90m367| [39m            [35mawait[39m db[33m.[39m[34minsert[39m(workflowVersions)[33m.[39m[34mvalues[39m({
    [90m   | [39m            [31m^[39m
    [90m368| [39m                id[33m:[39m workflowVersionId[33m,[39m
    [90m369| [39m                workflowId[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "workflow_versions" violates foreign key constraint "workflow_versions_workflow_id_workflows_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/regression-REG-1.test.ts:[2m367:13[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 375, severity: 'ERROR', code: '23503', detail: 'Key (workflow_id)=(b4a120b2-b73f-4135-aacc-e9a50f27e11e) is not present in table "workflows".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w31_v3', table: 'workflow_versions', dataType: undefined, constraint: 'workflow_versions_workflow_id_workflows_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[135/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould list all active sessions for current user
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m78:30[22m[39m
    [90m 76| [39m      [35mconst[39m token [33m=[39m session3[33m.[39mbody[33m.[39mtoken[33m;[39m
    [90m 77| [39m      const cookies = (session3.headers as any)["set-cookie"] as strinâ€¦
    [90m 78| [39m      const cookie = cookies.find((c) => c.startsWith("refresh_token="â€¦
    [90m   | [39m                             [31m^[39m
    [90m 79| [39m
    [90m 80| [39m      [90m// List sessions[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[136/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould mark current session correctly
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 66b02da64226b00a722e47685f7f3260,$2b$12$QnZJXh.ZXg/R.bSH/kZnS.mq9OsYq8D7.zN5KpF53Tm9H9aURBVSq,2026-01-18T04:05:03.554Z,2026-01-18T04:05:03.554Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m105:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m105:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(66b02da64226b00a722e47685f7f3260) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[137/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould exclude revoked sessions
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 830471a22ea5163fc2fe173e02b130aa,$2b$12$eX7utT1r8f0OuU8p9wCfO.v3M0/SkvMmmk7TDhH.mRQjpaDfcP/Qa,2026-01-18T04:05:04.300Z,2026-01-18T04:05:04.300Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m135:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m135:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(830471a22ea5163fc2fe173e02b130aa) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[138/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould order sessions by last used (most recent first)
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 35201c02936681d4e59fc82928e81407,$2b$12$p1oxaBvVfUjnfsZJUu7JvOPK7trWL0kAajdglda4P0.GZ./OPFQSS,2026-01-18T04:05:05.031Z,2026-01-18T04:05:05.031Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m167:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m167:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(35201c02936681d4e59fc82928e81407) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[139/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mGET /api/auth/sessions[2m > [22mshould filter sessions by current user only
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'length')[39m
[36m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m222:37[22m[39m
    [90m220| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39muser1Login[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m221| [39m
    [90m222| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39msessions[33m.[39mlength)[33m.[39m[34mtoBe[39m([34m2[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m223| [39m    })[33m;[39m
    [90m224| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[140/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould revoke specific session
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 03f5bca5d1b0c3c4c6f1899835d43e5c,$2b$12$jJwFX2UGdYIGNRdoa3s5ve7E0UuVc.DNrYgaP8f9rWLw/W6wDI7UO,2026-01-18T04:05:08.689Z,2026-01-18T04:05:08.689Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m234:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m234:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(03f5bca5d1b0c3c4c6f1899835d43e5c) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[141/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould prevent revoking current session
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m289:30[22m[39m
    [90m287| [39m      [35mconst[39m token [33m=[39m login[33m.[39mbody[33m.[39mtoken[33m;[39m
    [90m288| [39m      [35mconst[39m cookies [33m=[39m (login[33m.[39mheaders [35mas[39m any)[[32m"set-cookie"[39m] [35mas[39m string[][33m;[39m
    [90m289| [39m      const cookie = cookies.find((c) => c.startsWith("refresh_token="â€¦
    [90m   | [39m                             [31m^[39m
    [90m290| [39m
    [90m291| [39m      [90m// Get sessions[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[142/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould return 404 for non-existent session
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: d00e0287f1c7d7fd66ab304496aad0a6,$2b$12$oGNfisAQ94qOnbSjOmNfOuh.i/szO88qQ/5DrFmU2a9WuY1w58tDK,2026-01-18T04:05:10.574Z,2026-01-18T04:05:10.574Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m312:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m312:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(d00e0287f1c7d7fd66ab304496aad0a6) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w16_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[143/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/:sessionId[2m > [22mshould prevent revoking other user's session
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 1d7c9328b3f4136c0dc4fa3dcfc7763d,$2b$12$LGelWFT4yK0fyqBL0CNKr.TTKUs5ZVwZp5NPHi8d1nCndhLj2ffLq,2026-01-18T04:05:11.969Z,2026-01-18T04:05:11.969Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m329:21[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m329:21[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(1d7c9328b3f4136c0dc4fa3dcfc7763d) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w16_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[144/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould revoke all other sessions
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 85b2e946a9593e4bab6d5ca9141a1199,$2b$12$f3U4LT1NrZzhJZQe6GNLrenqgM.97k2SZWWqPTv2D3Wri3oDNTlCO,2026-01-18T04:05:13.300Z,2026-01-18T04:05:13.300Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m360:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m360:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(85b2e946a9593e4bab6d5ca9141a1199) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[145/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould keep current session active
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: f38f5d7cb6941ca85d0354547973b9ea,$2b$12$Saug5u6DYgewbGusuMDgUOWpt3j6S5Es0e4NvU/v5KyiK/Ca5r64.,2026-01-18T04:05:14.042Z,2026-01-18T04:05:14.042Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m394:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m394:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(f38f5d7cb6941ca85d0354547973b9ea) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w18_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[146/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould return 400 if no active session found
[31m[1mAssertionError[22m: expected 401 to be 400 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 400[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m444:31[22m[39m
    [90m442| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m443| [39m
    [90m444| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m400[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m445| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoContain[39m([32m"No active session"[39m)[33m;[39m
    [90m446| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[147/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould revoke all trusted devices
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 8144433d57ffeb67d71afecc1fb91884,$2b$12$TJ0uTsMZafgeo2lbte/BieyjI/eaLwMOH5SuFo8jIQz09f0wX9Y2W,2026-01-18T04:05:15.990Z,2026-01-18T04:05:15.990Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m449:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m449:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(8144433d57ffeb67d71afecc1fb91884) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w21_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[148/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mDELETE /api/auth/sessions/all[2m > [22mshould handle user with single session gracefully
[31m[1mTypeError[22m: Cannot read properties of undefined (reading 'find')[39m
[36m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m490:30[22m[39m
    [90m488| [39m      [35mconst[39m token [33m=[39m login[33m.[39mbody[33m.[39mtoken[33m;[39m
    [90m489| [39m      [35mconst[39m cookies [33m=[39m (login[33m.[39mheaders [35mas[39m any)[[32m"set-cookie"[39m] [35mas[39m string[][33m;[39m
    [90m490| [39m      const cookie = cookies.find((c) => c.startsWith("refresh_token="â€¦
    [90m   | [39m                             [31m^[39m
    [90m491| [39m
    [90m492| [39m      [90m// Revoke all (but only one exists)[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[149/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mSession Security[2m > [22mshould include device metadata in sessions
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 9ae5db8084d7ff7f39c048581648f7da,$2b$12$Q/ipgsDi..5/x5SJbzWZQunt6enr.qtsuDM.F3.L45.bv6.cxWI..,2026-01-18T04:05:17.964Z,2026-01-18T04:05:17.964Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m511:43[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m511:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(9ae5db8084d7ff7f39c048581648f7da) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w16_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[150/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mSession Security[2m > [22mshould not expose sensitive token data
[31m[1mTypeError[22m: Cannot read properties of undefined (reading '0')[39m
[36m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m544:37[22m[39m
    [90m542| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mlogin[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m543| [39m
    [90m544| [39m      [35mconst[39m session [33m=[39m response[33m.[39mbody[33m.[39msessions[[34m0[39m][33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m545| [39m
    [90m546| [39m      [90m// Should NOT include token hash or metadata[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[151/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/session.management.real.test.ts[2m > [22mSession Management Integration Tests (REAL)[2m > [22mSession Security[2m > [22mshould track session activity timestamps
[31m[1mTypeError[22m: Cannot read properties of undefined (reading '0')[39m
[36m [2mâ¯[22m tests/integration/session.management.real.test.ts:[2m563:37[22m[39m
    [90m561| [39m        [33m.[39m[35mset[39m([32m"Authorization"[39m[33m,[39m [32m`Bearer [39m[36m${[39mlogin[33m.[39mbody[33m.[39mtoken[36m}[39m[32m`[39m)[33m;[39m
    [90m562| [39m
    [90m563| [39m      [35mconst[39m session [33m=[39m response[33m.[39mbody[33m.[39msessions[[34m0[39m][33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m564| [39m
    [90m565| [39m      [34mexpect[39m(session[33m.[39mcreatedAt)[33m.[39m[34mtoBeDefined[39m()[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[152/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mProject Transfer[2m > [22mshould transfer user-owned project to org
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mProject Transfer[2m > [22mshould prevent transfer to org if user is not a member
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mProject Transfer[2m > [22mshould allow org member to transfer org-owned project to another org they belong to
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mWorkflow Transfer[2m > [22mshould detach workflow from project when transferring to different owner
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mWorkflow Transfer[2m > [22mshould keep workflow in project when transferring to same owner
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mWorkflow Transfer[2m > [22mshould prevent non-member from transferring org workflow
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mDatabase Transfer[2m > [22mshould transfer database ownership
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mDatabase Transfer[2m > [22mshould allow org member to transfer org database
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mDatabase Transfer[2m > [22mshould prevent transfer to org if user is not a member
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mTransfer Validation[2m > [22mshould only allow transfer to self when targetOwnerType is user
[41m[1m FAIL [22m[49m tests/integration/transferOwnership.test.ts[2m > [22mTransfer Ownership[2m > [22mTransfer Validation[2m > [22mshould allow transfer from user to self (org member transferring org asset to themselves)
[31m[1mError[22m: Access denied: Organization admin role required[39m
[36m [2mâ¯[22m requireOrgAdmin server/utils/ownershipAccess.ts:[2m195:11[22m[39m
    [90m193| [39m  [35mconst[39m isAdmin [33m=[39m [35mawait[39m [34mcanManageOrg[39m(userId[33m,[39m orgId)[33m;[39m
    [90m194| [39m  [35mif[39m ([33m![39misAdmin) {
    [90m195| [39m    [35mthrow[39m [35mnew[39m [33mError[39m([32m'Access denied: Organization admin role required'[39m)[33m;[39m
    [90m   | [39m          [31m^[39m
    [90m196| [39m  }
    [90m197| [39m}
[90m [2mâ¯[22m OrganizationService.addMember server/services/OrganizationService.ts:[2m410:5[22m[39m
[90m [2mâ¯[22m tests/integration/transferOwnership.test.ts:[2m64:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[153/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mPOST /api/auth/trust-device[2m > [22mshould trust current device
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: 0120e24a133bf95ad79abfe40e257bdf,PNZHUTLEORCHI4LVJFUUE42SM4QUKQD3HFGESVRRIFYUGZR6NYWA,true,2026-01-18T04:05:02.119Z,2026-01-18T04:05:02.119Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m58:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m58:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(0120e24a133bf95ad79abfe40e257bdf) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[154/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mPOST /api/auth/trust-device[2m > [22mshould set trust expiry to 30 days
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: e8ecf567e16bc5388adc80e1ea895eab,$2b$12$O4FjdgpbYRAgXYioPPCoj.iuTuCCLJ0vezYs3h5zR8xP.dQiUT6RS,2026-01-18T04:05:02.868Z,2026-01-18T04:05:02.868Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m97:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m97:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(e8ecf567e16bc5388adc80e1ea895eab) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[155/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mPOST /api/auth/trust-device[2m > [22mshould update expiry if device already trusted
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 5f5b84e0051b9ad1c80dcc7c7e43dcf9,$2b$12$uZqh63i6PjYaft9StnhXBuTXkIQOdOdK7P0zHr/yAypaIDP3y0IeW,2026-01-18T04:05:03.604Z,2026-01-18T04:05:03.604Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m124:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m124:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(5f5b84e0051b9ad1c80dcc7c7e43dcf9) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[156/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould list all trusted devices
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: adff80c398612fa5dd4bc63b65ea240d,$2b$12$ty93IGP1OTfERo18ZtY/RuuCjNPqrwLX5f/Qsc21dafoT1txtRbMi,2026-01-18T04:05:04.454Z,2026-01-18T04:05:04.454Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m183:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m183:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(adff80c398612fa5dd4bc63b65ea240d) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[157/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould mark current device
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 9c09be9fbbebf19dd4c9e272d37e02f0,$2b$12$/Gz6BoWRT3yqhklxEjCjs.OCmMO6y0.lqes9Z1o0JHcWwJyfNCTpi,2026-01-18T04:05:05.187Z,2026-01-18T04:05:05.187Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m240:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m240:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(9c09be9fbbebf19dd4c9e272d37e02f0) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[158/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould exclude revoked devices
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 8daa0d366741bb43b206a8a1db2d02bd,$2b$12$oIWRj7Y7Ii/6luO/NabcIuL8115oUUQoxmRrUQCFhK006AgwQXDtO,2026-01-18T04:05:05.922Z,2026-01-18T04:05:05.922Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m272:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m272:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(8daa0d366741bb43b206a8a1db2d02bd) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[159/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould exclude expired devices
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 28d2c2961edc6eb0546efc3c90b95e5c,$2b$12$2i6yBeWALezlOnr29Mdl2.FHRyzlTaCHMeea4CCNe0rzDoeprTuyq,2026-01-18T04:05:06.651Z,2026-01-18T04:05:06.651Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m305:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m305:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(28d2c2961edc6eb0546efc3c90b95e5c) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[160/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDELETE /api/auth/trusted-devices/:deviceId[2m > [22mshould revoke specific device
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: e2d17c4e2d030e6affebe95811d69fe0,$2b$12$Ya.T2KNhWG3j0/oitopy8e3n6h5JDB6zwpeBzmSaxSuDqflyBZupS,2026-01-18T04:05:07.390Z,2026-01-18T04:05:07.390Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m341:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m341:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(e2d17c4e2d030e6affebe95811d69fe0) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[161/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDELETE /api/auth/trusted-devices/:deviceId[2m > [22mshould return 404 for non-existent device
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: a1c7dbbc83d0dc62e3bafb2691242101,$2b$12$TN8gvEvJJwQKwthrg5hHZOCdVKj/rgMvM783fMSS/Ckw3F661C.gS,2026-01-18T04:05:08.137Z,2026-01-18T04:05:08.137Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m391:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m391:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 342, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(a1c7dbbc83d0dc62e3bafb2691242101) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[162/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDELETE /api/auth/trusted-devices/:deviceId[2m > [22mshould prevent revoking other user's device
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 2a579750fe2b81975535c3fc25ecfe6b,$2b$12$XrkV1wHR7PtvKE2SLnQUa.EIg.nFZNsc.BdNTzwKViHtXWk2zOmsO,2026-01-18T04:05:08.881Z,2026-01-18T04:05:08.881Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m410:21[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m410:21[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(2a579750fe2b81975535c3fc25ecfe6b) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[163/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDevice Trust with MFA Login[2m > [22mshould skip MFA for trusted device
[31m[1mError[22m: Failed query: insert into "mfa_secrets" ("id", "user_id", "secret", "enabled", "created_at", "enabled_at") values (default, $1, $2, $3, $4, $5)
params: 1e0c3f69a1724f02db1c51829baf2d0a,MZTCQKJUKFHF2RTLGJKVCNCVMR3DA53SPJXV42J6KUVGKPZIJZBA,true,2026-01-18T04:05:09.717Z,2026-01-18T04:05:09.717Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
    [90m214| [39m
    [90m215| [39m  [90m// Store MFA secret[39m
    [90m216| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(mfaSecrets)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m217| [39m    userId[33m:[39m userData[33m.[39muserId[33m,[39m
    [90m218| [39m    secret[33m:[39m secret[33m.[39mbase32[33m,[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m459:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "mfa_secrets" violates foreign key constraint "mfa_secrets_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m216:3[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m459:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 322, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(1e0c3f69a1724f02db1c51829baf2d0a) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'mfa_secrets', dataType: undefined, constraint: 'mfa_secrets_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[164/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDevice Trust with MFA Login[2m > [22mshould require MFA for untrusted device
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: ffbcb60704c2d635ad17c88baa0da644,$2b$12$WkSlQ9IETLsj7soi8ZzE2ut990e/.UrrhO4Zlpd2fgqrbReKj4by.,2026-01-18T04:05:10.739Z,2026-01-18T04:05:10.739Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m497:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m497:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(ffbcb60704c2d635ad17c88baa0da644) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w16_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[165/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/trusted.devices.real.test.ts[2m > [22mTrusted Devices Integration Tests (REAL)[2m > [22mDevice Trust with MFA Login[2m > [22mshould update lastUsedAt on trusted device login
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, $3, $4)
params: 6bb762b390546d4b27ae6d40b964de36,$2b$12$lYbJsHmFSU8F6rkDtPk1gORUMWcH8CsDeZGX8ep7dK7afsW93ui5m,2026-01-18T04:05:12.000Z,2026-01-18T04:05:12.000Z[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
    [90m164| [39m
    [90m165| [39m  [90m// Create credentials[39m
    [90m166| [39m  [35mawait[39m db[33m.[39m[34minsert[39m(userCredentials)[33m.[39m[34mvalues[39m({
    [90m   | [39m  [31m^[39m
    [90m167| [39m    userId[33m,[39m
    [90m168| [39m    passwordHash[33m,[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m528:55[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m createTestUser tests/helpers/testUtils.ts:[2m166:3[22m[39m
[90m [2mâ¯[22m createUserWithMfa tests/helpers/testUtils.ts:[2m206:20[22m[39m
[90m [2mâ¯[22m tests/integration/trusted.devices.real.test.ts:[2m528:55[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 343, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(6bb762b390546d4b27ae6d40b964de36) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w16_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[166/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mREPRO: ScriptEngine fails to resolve alias 'input_variable' when aliasMap is NOT provided
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, $6, default, default, default, default, default, default, default, default)
params: dad0fac6-322d-45de-9e09-f4228f2b6309,safety - b04d2c8b-a5d6-4d80-a378-bc6c52a379d0 @example.com,2c746c1b-f813-4eef-9f10-ba041ade9d06,admin,owner,local[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/variableSafety.test.ts:[2m51:9[22m[39m
    [90m 49| [39m
    [90m 50| [39m        userId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 51| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(usersSchema)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 52| [39m            id[33m:[39m userId[33m,[39m
    [90m 53| [39m            email[33m:[39m [32m`safety - [39m[36m${[39m[34muuidv4[39m()[36m}[39m[32m @example.com`[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/variableSafety.test.ts:[2m51:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(2c746c1b-f813-4eef-9f10-ba041ade9d06) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w19_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[167/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mScriptEngine resolves alias 'input_variable' when aliasMap is provided
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, $6, default, default, default, default, default, default, default, default)
params: 3da3d91e-0c32-4e7a-a216-f04d257c5b51,safety - 9da5984d-a344-4187-a2a1-3a7c13cc8da8 @example.com,a993b4d1-1b4f-431c-9aa4-a20748b3c34c,admin,owner,local[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/variableSafety.test.ts:[2m51:9[22m[39m
    [90m 49| [39m
    [90m 50| [39m        userId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 51| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(usersSchema)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 52| [39m            id[33m:[39m userId[33m,[39m
    [90m 53| [39m            email[33m:[39m [32m`safety - [39m[36m${[39m[34muuidv4[39m()[36m}[39m[32m @example.com`[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/variableSafety.test.ts:[2m51:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(a993b4d1-1b4f-431c-9aa4-a20748b3c34c) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w19_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[168/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mREPRO: BlockRunner fails to resolve alias in CreateRecordConfig
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, $6, default, default, default, default, default, default, default, default)
params: 7365173c-332a-4c18-9d86-2a85ff914969,safety - 812a9a56-11c8-47fb-84ef-0b1c80f1e891 @example.com,1d0c80a0-b0f1-495d-85ee-8d5c44106015,admin,owner,local[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/variableSafety.test.ts:[2m51:9[22m[39m
    [90m 49| [39m
    [90m 50| [39m        userId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 51| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(usersSchema)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 52| [39m            id[33m:[39m userId[33m,[39m
    [90m 53| [39m            email[33m:[39m [32m`safety - [39m[36m${[39m[34muuidv4[39m()[36m}[39m[32m @example.com`[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/variableSafety.test.ts:[2m51:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(1d0c80a0-b0f1-495d-85ee-8d5c44106015) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w17_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[169/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/variableSafety.test.ts[2m > [22mVariable Schema Safety & Resolution[2m > [22mBlockRunner logic resolves alias with aliasMap
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, default, default, default, default, $3, $4, $5, $6, default, default, default, default, default, default, default, default)
params: ba6c1cce-1549-41c9-b9e5-46aea21401a7,safety - c0afd12b-9d46-421a-902e-b7b82662e60e @example.com,92f6368b-0b51-40b1-a2b7-cf882fccdbcd,admin,owner,local[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/variableSafety.test.ts:[2m51:9[22m[39m
    [90m 49| [39m
    [90m 50| [39m        userId [33m=[39m [34muuidv4[39m()[33m;[39m
    [90m 51| [39m        [35mawait[39m db[33m.[39m[34minsert[39m(usersSchema)[33m.[39m[34mvalues[39m({
    [90m   | [39m        [31m^[39m
    [90m 52| [39m            id[33m:[39m userId[33m,[39m
    [90m 53| [39m            email[33m:[39m [32m`safety - [39m[36m${[39m[34muuidv4[39m()[36m}[39m[32m @example.com`[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/variableSafety.test.ts:[2m51:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(92f6368b-0b51-40b1-a2b7-cf882fccdbcd) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w19_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[170/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Authorization Flow Initiation[2m > [22mshould initiate OAuth2 3-legged flow and generate authorization URL
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2mâ¯[22m tests/integration/auth/oauth2.callback.test.ts:[2m125:37[22m[39m
    [90m123| [39m        })[33m;[39m
    [90m124| [39m
    [90m125| [39m      [34mexpect[39m(createResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m126| [39m      testConnectionId [33m=[39m createResponse[33m.[39mbody[33m.[39mid[33m;[39m
    [90m127| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[171/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.callback.test.ts[2m > [22mOAuth2 3-Legged Flow - Callback Handling[2m > [22mOAuth2 Connection Status[2m > [22mshould track OAuth2 connection status
[31m[1mAssertionError[22m: expected 500 to be 201 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 201[39m
[31m+ 500[39m

[36m [2mâ¯[22m tests/integration/auth/oauth2.callback.test.ts:[2m309:37[22m[39m
    [90m307| [39m        })[33m;[39m
    [90m308| [39m
    [90m309| [39m      [34mexpect[39m(createResponse[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m201[39m)[33m;[39m
    [90m   | [39m                                    [31m^[39m
    [90m310| [39m      [35mconst[39m connectionId [33m=[39m createResponse[33m.[39mbody[33m.[39mid[33m;[39m
    [90m311| [39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[172/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould successfully authenticate with valid Google ID token
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth/oauth2.google.test.ts:[2m91:31[22m[39m
    [90m 89| [39m
    [90m 90| [39m      [90m// Verify response[39m
    [90m 91| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m 92| [39m      [34mexpect[39m(response[33m.[39mbody)[33m.[39m[34mtoMatchObject[39m({
    [90m 93| [39m        message[33m:[39m [32m'Authentication successful'[39m[33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[173/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould update existing user on subsequent logins
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default)
params: google-user-existing,existing@example.com,Old Name,Old,Name,fee6bc66-d588-4d32-a676-270d5486a02a,creator,viewer,google,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.google.test.ts:[2m218:7[22m[39m
    [90m216| [39m
    [90m217| [39m      [90m// Create existing user[39m
    [90m218| [39m      [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m      [31m^[39m
    [90m219| [39m        id[33m:[39m userId[33m,[39m
    [90m220| [39m        email[33m:[39m [32m'existing@example.com'[39m[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m113:20[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.google.test.ts:[2m218:7[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(fee6bc66-d588-4d32-a676-270d5486a02a) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[174/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould create refresh token record in database
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth/oauth2.google.test.ts:[2m297:31[22m[39m
    [90m295| [39m        })[33m;[39m
    [90m296| [39m
    [90m297| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m298| [39m
    [90m299| [39m      [90m// Verify refresh token exists in database[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[175/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould support both "token" and "idToken" fields
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth/oauth2.google.test.ts:[2m332:31[22m[39m
    [90m330| [39m        })[33m;[39m
    [90m331| [39m
    [90m332| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m333| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39mmessage)[33m.[39m[34mtoBe[39m([32m'Authentication successful'[39m)[33m;[39m
    [90m334| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[176/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.google.test.ts[2m > [22mOAuth2 Google Authentication Flow[2m > [22mPOST /api/auth/google - Google OAuth2 Login[2m > [22mshould handle missing profile information gracefully
[31m[1mAssertionError[22m: expected 401 to be 200 // Object.is equality[39m

[32m- Expected[39m
[31m+ Received[39m

[32m- 200[39m
[31m+ 401[39m

[36m [2mâ¯[22m tests/integration/auth/oauth2.google.test.ts:[2m395:31[22m[39m
    [90m393| [39m        })[33m;[39m
    [90m394| [39m
    [90m395| [39m      [34mexpect[39m(response[33m.[39mstatus)[33m.[39m[34mtoBe[39m([34m200[39m)[33m;[39m
    [90m   | [39m                              [31m^[39m
    [90m396| [39m      [34mexpect[39m(response[33m.[39mbody[33m.[39muser)[33m.[39m[34mtoMatchObject[39m({
    [90m397| [39m        email[33m:[39m [32m'minimal@example.com'[39m[33m,[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[177/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould list all active sessions for current user
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: LygXm8dcHnnHteqkCCyKp,session-test-7TONArKunLLAzyp92DNFE@example.com,Session Test,Session,Test,f36bdc0a-dfb3-4058-b914-87ae6f623363,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f36bdc0a-dfb3-4058-b914-87ae6f623363) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[178/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould mark current session as current
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: yYU1R2dP5BsafJ0cqZQxu,session-test-wVUubUvZTNIVRZPGwW-L0@example.com,Session Test,Session,Test,f36bdc0a-dfb3-4058-b914-87ae6f623363,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f36bdc0a-dfb3-4058-b914-87ae6f623363) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[179/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould return empty array when user has no active sessions
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: oFo5XwjPCOwVRS8vbVbzX,session-test-2xCmxazaUCboj4beCHB1e@example.com,Session Test,Session,Test,f36bdc0a-dfb3-4058-b914-87ae6f623363,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f36bdc0a-dfb3-4058-b914-87ae6f623363) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[180/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould not include expired sessions
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: --hw8lpAg7Omw-2qO1lpy,session-test-pRY64rAWAMj1hihVeW_mq@example.com,Session Test,Session,Test,f36bdc0a-dfb3-4058-b914-87ae6f623363,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f36bdc0a-dfb3-4058-b914-87ae6f623363) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[181/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould not include revoked sessions
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: YgNVvqPaQc9HNMjogZxmf,session-test-4b9Nf_YN6YpIxIn3Muh3K@example.com,Session Test,Session,Test,f36bdc0a-dfb3-4058-b914-87ae6f623363,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f36bdc0a-dfb3-4058-b914-87ae6f623363) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[182/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould parse device name from user agent
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: x2l9HJSwtyrk48_7Zy3Vl,session-test-DKvFWOd_H010qtWxjQu7k@example.com,Session Test,Session,Test,f36bdc0a-dfb3-4058-b914-87ae6f623363,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f36bdc0a-dfb3-4058-b914-87ae6f623363) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[183/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mGET /api/auth/sessions - List Active Sessions[2m > [22mshould return 401 for unauthenticated request
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: KyGKZ_h6qsNMRLaPlZf-W,session-test-LVNRh1gGh5iSwQQ3UQDQS@example.com,Session Test,Session,Test,f36bdc0a-dfb3-4058-b914-87ae6f623363,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f36bdc0a-dfb3-4058-b914-87ae6f623363) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[184/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/:sessionId - Revoke Session[2m > [22mshould revoke a specific session
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, default, default) returning "id", "user_id", "password_hash", "created_at", "updated_at"
params: 5MPwiaLP526pCK-4WgcRa,$2b$12$2W9hf2zK9pOfWu5Usnnv8OYsDb8U.zVDjB5qbuUlHYtpCCPLM4lRK[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m UserCredentialsRepository.createCredentials server/repositories/UserCredentialsRepository.ts:[2m42:29[22m[39m
    [90m 40| [39m
    [90m 41| [39m    [35mtry[39m {
    [90m 42| [39m      [35mconst[39m [credentials] [33m=[39m [35mawait[39m database
    [90m   | [39m                            [31m^[39m
    [90m 43| [39m        [33m.[39m[34minsert[39m(userCredentials)
    [90m 44| [39m        [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m70:5[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m UserCredentialsRepository.createCredentials server/repositories/UserCredentialsRepository.ts:[2m42:29[22m[39m
[90m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m70:5[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 332, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(5MPwiaLP526pCK-4WgcRa) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[185/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/:sessionId - Revoke Session[2m > [22mshould return 404 for non-existent session
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 2G14dFPZNMfW2O68kx1UX,session-test-utJF5r3T4kr6LLuHz7j2B@example.com,Session Test,Session,Test,f36bdc0a-dfb3-4058-b914-87ae6f623363,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f36bdc0a-dfb3-4058-b914-87ae6f623363) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[186/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/:sessionId - Revoke Session[2m > [22mshould prevent revoking current session
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: Su20nWUG7h9yAdVRB3llv,session-test-GzBujK_u05uf-OCyQ4h9S@example.com,Session Test,Session,Test,f36bdc0a-dfb3-4058-b914-87ae6f623363,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f36bdc0a-dfb3-4058-b914-87ae6f623363) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[187/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/:sessionId - Revoke Session[2m > [22mshould prevent revoking another user's session
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: lsoRNECTdHlB46JTlHL1G,session-test-jWmGzdSL29xQgQmmOppUn@example.com,Session Test,Session,Test,f36bdc0a-dfb3-4058-b914-87ae6f623363,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f36bdc0a-dfb3-4058-b914-87ae6f623363) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[188/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/:sessionId - Revoke Session[2m > [22mshould return 401 for unauthenticated request
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: i0u0kzgRiz_sSpBnCAQnq,session-test-Fe79p34wmd82ZSfhYPVPY@example.com,Session Test,Session,Test,f36bdc0a-dfb3-4058-b914-87ae6f623363,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f36bdc0a-dfb3-4058-b914-87ae6f623363) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[189/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/all - Logout All Other Devices[2m > [22mshould revoke all sessions except current
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: b5RHMB5N2EaCElno_RUbk,session-test-dhEfpy1h0LZglUrcgaptF@example.com,Session Test,Session,Test,f36bdc0a-dfb3-4058-b914-87ae6f623363,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f36bdc0a-dfb3-4058-b914-87ae6f623363) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[190/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/all - Logout All Other Devices[2m > [22mshould revoke all trusted devices
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 6XT5vNMYqg6iKjehjas4Y,session-test-X745oOEEv037TbyWTi-9g@example.com,Session Test,Session,Test,f36bdc0a-dfb3-4058-b914-87ae6f623363,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f36bdc0a-dfb3-4058-b914-87ae6f623363) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[191/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/all - Logout All Other Devices[2m > [22mshould return 400 when no active session found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 1ggMfk_fUhl2VzdlfBvBf,session-test-grtXuCqwZlBI5Hy2yMYTe@example.com,Session Test,Session,Test,f36bdc0a-dfb3-4058-b914-87ae6f623363,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f36bdc0a-dfb3-4058-b914-87ae6f623363) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[192/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mDELETE /api/auth/sessions/all - Logout All Other Devices[2m > [22mshould return 401 for unauthenticated request
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: DMPudBMxMBYK0_c2wygkb,session-test-VE-BJ-zvt6wRm_WWcy4Qo@example.com,Session Test,Session,Test,f36bdc0a-dfb3-4058-b914-87ae6f623363,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f36bdc0a-dfb3-4058-b914-87ae6f623363) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[193/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mPOST /api/auth/trust-device[2m > [22mshould mark current device as trusted
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: VmienzpRVv0cAQctkYZ-q,session-test-2CCrFwsOaCIa3W90rxZC0@example.com,Session Test,Session,Test,f36bdc0a-dfb3-4058-b914-87ae6f623363,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f36bdc0a-dfb3-4058-b914-87ae6f623363) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[194/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mPOST /api/auth/trust-device[2m > [22mshould update existing trusted device expiry
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: ETpHCqgRi6c4JSX0FroCN,session-test-mbfdlQWXXRCQ3adDGrXOF@example.com,Session Test,Session,Test,f36bdc0a-dfb3-4058-b914-87ae6f623363,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f36bdc0a-dfb3-4058-b914-87ae6f623363) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[195/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould list all trusted devices
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: r2pCVjPYfddnCHuiqFV-Y,session-test-WNHm3fL6P2rgddji0rwzT@example.com,Session Test,Session,Test,f36bdc0a-dfb3-4058-b914-87ae6f623363,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f36bdc0a-dfb3-4058-b914-87ae6f623363) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[196/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mGET /api/auth/trusted-devices[2m > [22mshould not include revoked devices
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: MR2DzHZKvwSiH8Pv7Hg9S,session-test-8ZL4eGjO0XuFm4jGDdj_4@example.com,Session Test,Session,Test,f36bdc0a-dfb3-4058-b914-87ae6f623363,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f36bdc0a-dfb3-4058-b914-87ae6f623363) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w16_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[197/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mDELETE /api/auth/trusted-devices/:deviceId[2m > [22mshould revoke a trusted device
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: eOI3LUwN4N5HUecDuDeSx,session-test-zErW6aeK0IW4141kVlG9f@example.com,Session Test,Session,Test,f36bdc0a-dfb3-4058-b914-87ae6f623363,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f36bdc0a-dfb3-4058-b914-87ae6f623363) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w17_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[198/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mTrusted Devices Management[2m > [22mDELETE /api/auth/trusted-devices/:deviceId[2m > [22mshould return 404 for non-existent device
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: mMNLNYRehVCyhaMBDxCgG,session-test-RNgkcvcmrcJ5dvcJ0vZF1@example.com,Session Test,Session,Test,f36bdc0a-dfb3-4058-b914-87ae6f623363,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f36bdc0a-dfb3-4058-b914-87ae6f623363) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w2_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[199/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mSession Metadata Tracking[2m > [22mshould track IP address for sessions
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: UQz-wj0dioJkOSf2henen,session-test-wN3N_B2ZUDDz0GxhodO7J@example.com,Session Test,Session,Test,f36bdc0a-dfb3-4058-b914-87ae6f623363,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f36bdc0a-dfb3-4058-b914-87ae6f623363) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[200/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mSession Metadata Tracking[2m > [22mshould track user agent for sessions
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: AGwkJ5Iyjq8wKYSIJ6fn5,session-test-ihNBNj76YEfG9g2cwLuIY@example.com,Session Test,Session,Test,f36bdc0a-dfb3-4058-b914-87ae6f623363,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f36bdc0a-dfb3-4058-b914-87ae6f623363) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[201/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.sessions.test.ts[2m > [22mOAuth2 Session Management[2m > [22mSession Metadata Tracking[2m > [22mshould update lastUsedAt on token refresh
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: _vC3ztSn2vd6JucOx6tpv,session-test-foV7uwqwotPlymTknaR0G@example.com,Session Test,Session,Test,f36bdc0a-dfb3-4058-b914-87ae6f623363,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m
    [90m 51| [39m    testUserEmail [33m=[39m [32m`session-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 52| [39m
    [90m 53| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 54| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 55| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.sessions.test.ts:[2m53:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f36bdc0a-dfb3-4058-b914-87ae6f623363) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[202/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould refresh access token with valid refresh token
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: wphzXkHTRNvyH5KpJLzJ4,refresh-test-np-2MvszgBc9Mf2BM4GZu@example.com,Refresh Test,Refresh,Test,daae2c62-a469-4d3b-8bae-17445ddfc9b0,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(daae2c62-a469-4d3b-8bae-17445ddfc9b0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[203/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould rotate refresh token after use
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: IJe4Eql98DvDIF5DOXsfP,refresh-test-kUKmJEMQGC0f_werC2Ch5@example.com,Refresh Test,Refresh,Test,daae2c62-a469-4d3b-8bae-17445ddfc9b0,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(daae2c62-a469-4d3b-8bae-17445ddfc9b0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[204/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould return 401 when refresh token is missing
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: wAJ5YrkA66mvQze4QGvjw,refresh-test--FaoT3A9AUVFgxw1CKw6l@example.com,Refresh Test,Refresh,Test,daae2c62-a469-4d3b-8bae-17445ddfc9b0,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(daae2c62-a469-4d3b-8bae-17445ddfc9b0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[205/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould return 401 for invalid refresh token
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: LeR9NUwCmpR_nd6MlbLRI,refresh-test-8uXmP8rGSPQN2iFYXSGNu@example.com,Refresh Test,Refresh,Test,daae2c62-a469-4d3b-8bae-17445ddfc9b0,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(daae2c62-a469-4d3b-8bae-17445ddfc9b0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[206/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould return 401 for expired refresh token
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: bjEpdWs4jkfK2AnKFOLyW,refresh-test-X0PGjjV62LgXXUTIqqKfa@example.com,Refresh Test,Refresh,Test,daae2c62-a469-4d3b-8bae-17445ddfc9b0,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(daae2c62-a469-4d3b-8bae-17445ddfc9b0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[207/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould return 401 for revoked refresh token
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: oHmZZEElpH65LiblfrG5L,refresh-test-nbFAsUSmCuSswKoEVS7sK@example.com,Refresh Test,Refresh,Test,daae2c62-a469-4d3b-8bae-17445ddfc9b0,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(daae2c62-a469-4d3b-8bae-17445ddfc9b0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[208/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould return 401 when user is not found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: pvXggqwsDJVXfcwBBbz1R,refresh-test-bvevBj-O2nHdI1mZvSPH7@example.com,Refresh Test,Refresh,Test,daae2c62-a469-4d3b-8bae-17445ddfc9b0,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(daae2c62-a469-4d3b-8bae-17445ddfc9b0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[209/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould update refresh token metadata on rotation
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: HtDJGp0wfabtgm232AWIt,refresh-test-4s8IZLDyuHYvwYuWLwrfk@example.com,Refresh Test,Refresh,Test,daae2c62-a469-4d3b-8bae-17445ddfc9b0,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(daae2c62-a469-4d3b-8bae-17445ddfc9b0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[210/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould handle concurrent refresh token requests (token reuse detection)
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: sirrKCblRJ3u35ZFzJaqW,refresh-test-KcBrMzGl4KwXAqMhA4arL@example.com,Refresh Test,Refresh,Test,daae2c62-a469-4d3b-8bae-17445ddfc9b0,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(daae2c62-a469-4d3b-8bae-17445ddfc9b0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[211/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould set secure cookie in production
[31m[1mError[22m: Failed query: insert into "user_credentials" ("id", "user_id", "password_hash", "created_at", "updated_at") values (default, $1, $2, default, default) returning "id", "user_id", "password_hash", "created_at", "updated_at"
params: DUWUoY5F-jr7_MbV-61xU,$2b$12$/pehjrAt1EnvNF6aA13hZehB0W7Ng9M3Z6tcf0t2lpV0O7M4uS6YS[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m UserCredentialsRepository.createCredentials server/repositories/UserCredentialsRepository.ts:[2m42:29[22m[39m
    [90m 40| [39m
    [90m 41| [39m    [35mtry[39m {
    [90m 42| [39m      [35mconst[39m [credentials] [33m=[39m [35mawait[39m database
    [90m   | [39m                            [31m^[39m
    [90m 43| [39m        [33m.[39m[34minsert[39m(userCredentials)
    [90m 44| [39m        [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m72:5[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "user_credentials" violates foreign key constraint "user_credentials_user_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m UserCredentialsRepository.createCredentials server/repositories/UserCredentialsRepository.ts:[2m42:29[22m[39m
[90m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m72:5[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 332, severity: 'ERROR', code: '23503', detail: 'Key (user_id)=(DUWUoY5F-jr7_MbV-61xU) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'user_credentials', dataType: undefined, constraint: 'user_credentials_user_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[212/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould set proper cookie attributes
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 9_tx-0_JjYnGPX5qZ3MlJ,refresh-test-MpyWkhg4RAm7tARsI7QRF@example.com,Refresh Test,Refresh,Test,daae2c62-a469-4d3b-8bae-17445ddfc9b0,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(daae2c62-a469-4d3b-8bae-17445ddfc9b0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[213/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mPOST /api/auth/refresh-token[2m > [22mshould include user role information in response
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 3sJ-tAgDBP5YUAJXIz477,refresh-test-S5MNie6-sn4nxX0Qv8nGE@example.com,Refresh Test,Refresh,Test,daae2c62-a469-4d3b-8bae-17445ddfc9b0,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(daae2c62-a469-4d3b-8bae-17445ddfc9b0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[214/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Lifecycle[2m > [22mshould create refresh token on login
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: p1Surq448BV4EhyGgZbOR,refresh-test-s8z2yjiF_rA6oPl0QehcZ@example.com,Refresh Test,Refresh,Test,daae2c62-a469-4d3b-8bae-17445ddfc9b0,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(daae2c62-a469-4d3b-8bae-17445ddfc9b0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[215/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Lifecycle[2m > [22mshould revoke refresh token on logout
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: vuEhtVgaYII6Cc8WR4rQn,refresh-test-qVJ7bATn3NKjpUFFlsAMK@example.com,Refresh Test,Refresh,Test,daae2c62-a469-4d3b-8bae-17445ddfc9b0,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(daae2c62-a469-4d3b-8bae-17445ddfc9b0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[216/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Lifecycle[2m > [22mshould handle logout without refresh token gracefully
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: Fbd4K5qAE2FrLuviEY1TS,refresh-test-blhu8zW4q9YFI_uW4gxYn@example.com,Refresh Test,Refresh,Test,daae2c62-a469-4d3b-8bae-17445ddfc9b0,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(daae2c62-a469-4d3b-8bae-17445ddfc9b0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[217/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Lifecycle[2m > [22mshould support multiple active refresh tokens per user
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 1jtXNU5cyD15Wcd-Bg-aJ,refresh-test-m92xeRb8NgPG35OIydtB6@example.com,Refresh Test,Refresh,Test,daae2c62-a469-4d3b-8bae-17445ddfc9b0,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(daae2c62-a469-4d3b-8bae-17445ddfc9b0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w0_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[218/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Lifecycle[2m > [22mshould revoke all user tokens on password reset
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: mKQlTDJZD_tOYj6dY5wZq,refresh-test-LATYe88-JUY4kOeB-EzIV@example.com,Refresh Test,Refresh,Test,daae2c62-a469-4d3b-8bae-17445ddfc9b0,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(daae2c62-a469-4d3b-8bae-17445ddfc9b0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[219/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Security[2m > [22mshould use cryptographically strong random tokens
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: fLUD3pG2JfOMtzDEmw6qF,refresh-test-q7qiOy4tnsZ78mpyLcd4Y@example.com,Refresh Test,Refresh,Test,daae2c62-a469-4d3b-8bae-17445ddfc9b0,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(daae2c62-a469-4d3b-8bae-17445ddfc9b0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[220/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Security[2m > [22mshould hash refresh tokens before storing in database
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 9fQdGWH5g86PWgRfFoOoF,refresh-test-IC-fisoCzJRx0PG9mo8cE@example.com,Refresh Test,Refresh,Test,daae2c62-a469-4d3b-8bae-17445ddfc9b0,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(daae2c62-a469-4d3b-8bae-17445ddfc9b0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w16_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[221/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Security[2m > [22mshould prevent refresh token reuse after rotation
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: dRjix2AbF2rd6QOvN5YKB,refresh-test-tt6G3kw0jYsmfGpVzViDx@example.com,Refresh Test,Refresh,Test,daae2c62-a469-4d3b-8bae-17445ddfc9b0,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(daae2c62-a469-4d3b-8bae-17445ddfc9b0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w16_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[222/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mRefresh Token Security[2m > [22mshould validate token ownership
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: IprYcYcMe8fdiCCE3-pVo,refresh-test-iYdwWbo3xc9ToAxubR_l_@example.com,Refresh Test,Refresh,Test,daae2c62-a469-4d3b-8bae-17445ddfc9b0,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(daae2c62-a469-4d3b-8bae-17445ddfc9b0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[223/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mCookie Security[2m > [22mshould set HttpOnly flag to prevent XSS
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: fjzfLkeJJmO0WyRxiK5Yu,refresh-test-2T2TABkTDJwO7eX-8jKDV@example.com,Refresh Test,Refresh,Test,daae2c62-a469-4d3b-8bae-17445ddfc9b0,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(daae2c62-a469-4d3b-8bae-17445ddfc9b0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w0_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[224/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mCookie Security[2m > [22mshould set SameSite=Strict to prevent CSRF
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: VY3lOWppOpTN45c5qaqfh,refresh-test-lw85vKBwMxTbqZ5k0lCWN@example.com,Refresh Test,Refresh,Test,daae2c62-a469-4d3b-8bae-17445ddfc9b0,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(daae2c62-a469-4d3b-8bae-17445ddfc9b0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w0_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[225/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mCookie Security[2m > [22mshould set proper cookie path
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: eEuXFtUhTavlQqsY0_aza,refresh-test-zip0U451Y6fo9XfwBOsaU@example.com,Refresh Test,Refresh,Test,daae2c62-a469-4d3b-8bae-17445ddfc9b0,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(daae2c62-a469-4d3b-8bae-17445ddfc9b0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[226/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22mOAuth2 Token Refresh Flow[2m > [22mCookie Security[2m > [22mshould set appropriate expiry (30 days)
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, $11, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: slFpUVfEST3gt6Zf4V3Zf,refresh-test-BdwvUdpEyoUnS2eCEuUE-@example.com,Refresh Test,Refresh,Test,daae2c62-a469-4d3b-8bae-17445ddfc9b0,creator,owner,local,easy,true[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m
    [90m 53| [39m    testUserEmail [33m=[39m [32m`refresh-test-[39m[36m${[39m[34mnanoid[39m()[36m}[39m[32m@example.com`[39m[33m;[39m
    [90m 54| [39m
    [90m 55| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m db[33m.[39m[34minsert[39m(users)[33m.[39m[34mvalues[39m({
    [90m   | [39m                   [31m^[39m
    [90m 56| [39m      id[33m:[39m [34mnanoid[39m()[33m,[39m
    [90m 57| [39m      email[33m:[39m testUserEmail[33m,[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/integration/auth/oauth2.token-refresh.test.ts:[2m55:20[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(daae2c62-a469-4d3b-8bae-17445ddfc9b0) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w17_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[227/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mTemplate Key Resolution (New Path)[2m > [22mshould resolve template by key from workflowTemplates mapping
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 3c775a35-3935-48a2-84a7-1ee3a233061e,test-1768709099904@example.com,Test User,Test,User,2de66b35-e337-4f6d-bbdc-5256cfcb236e,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(2de66b35-e337-4f6d-bbdc-5256cfcb236e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[228/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mTemplate Key Resolution (New Path)[2m > [22mshould throw error if template key not found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 842dfab4-0568-4efd-b608-77374b1d08cb,test-1768709100506@example.com,Test User,Test,User,2a65be13-2ea8-486f-9c7d-dd0d8ba4bd8c,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(2a65be13-2ea8-486f-9c7d-dd0d8ba4bd8c) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[229/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mTemplate Key Resolution (New Path)[2m > [22mshould store output in runOutputs table
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: e541336f-cefb-4bc0-995f-ff6ff551929e,Test Project,Test Project,Test project for integration tests,3d4fd7cd-3c5d-4251-80eb-fe1b006d4a5b,c129c1ed-fb49-4dfc-9850-d5ef4f5bd477,3d4fd7cd-3c5d-4251-80eb-fe1b006d4a5b,3d4fd7cd-3c5d-4251-80eb-fe1b006d4a5b[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(3d4fd7cd-3c5d-4251-80eb-fe1b006d4a5b) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[230/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mLegacy Template ID Path (Backward Compatibility)[2m > [22mshould resolve template by templateId directly
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: 1d064a29-742e-466c-98e4-0ded7d76cf75,Test Project,Test Project,Test project for integration tests,a162b581-a239-4e56-bc8c-bd522eb8d4b7,74236d7e-48c0-4231-ab25-3936410a2634,a162b581-a239-4e56-bc8c-bd522eb8d4b7,a162b581-a239-4e56-bc8c-bd522eb8d4b7[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(a162b581-a239-4e56-bc8c-bd522eb8d4b7) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[231/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mLegacy Template ID Path (Backward Compatibility)[2m > [22mshould throw error if templateId not found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 7c4a0602-83dc-48c1-9015-102c34b09e65,test-1768709102483@example.com,Test User,Test,User,5e579ea7-0171-4af2-a7b2-b3ada32c7bc3,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(5e579ea7-0171-4af2-a7b2-b3ada32c7bc3) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[232/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mRendering Engine Selection[2m > [22mshould use docxRenderer2 by default (v2 engine)
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: d2ee91f6-9d0c-4fd9-8d3a-c510963b42d7,test-1768709103083@example.com,Test User,Test,User,8be1f49a-410e-418a-906b-4c2471f525bc,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(8be1f49a-410e-418a-906b-4c2471f525bc) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w0_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[233/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mRendering Engine Selection[2m > [22mshould use legacy engine when engine="legacy"
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: 55cc36da-0f18-43f6-8c6b-212010e38ee0,Test Project,Test Project,Test project for integration tests,e5f5a2fb-6a4a-46e9-b951-6c34cc92648e,47b241a5-296d-4258-94c8-166436f4ba56,e5f5a2fb-6a4a-46e9-b951-6c34cc92648e,e5f5a2fb-6a4a-46e9-b951-6c34cc92648e[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(e5f5a2fb-6a4a-46e9-b951-6c34cc92648e) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[234/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mPDF Generation[2m > [22mshould generate PDF when toPdf=true
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 99044e77-327b-40ac-90f2-0ba2bd90f28c,test-1768709104325@example.com,Test User,Test,User,db7f5962-dc98-401d-b8f1-dd27f42246fc,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(db7f5962-dc98-401d-b8f1-dd27f42246fc) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[235/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mPDF Generation[2m > [22mshould default to DOCX when toPdf=false
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 23abbf52-293a-4174-a778-77477f5d655c,test-1768709104970@example.com,Test User,Test,User,964fd014-e6fc-4075-b3d9-a1b756b3f3ee,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(964fd014-e6fc-4075-b3d9-a1b756b3f3ee) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[236/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mConditional Execution[2m > [22mshould skip execution when condition evaluates to false
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 4961949c-4c9b-494d-8520-9aaa60870392,test-1768709105595@example.com,Test User,Test,User,095955f6-2928-4642-b991-69f55f06d33b,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(095955f6-2928-4642-b991-69f55f06d33b) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[237/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mConditional Execution[2m > [22mshould execute when condition evaluates to true
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 97b06404-b8e6-4467-a304-94676f8d148d,test-1768709106242@example.com,Test User,Test,User,6d6d2064-e9a4-4049-8a58-85afaf91d8e1,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(6d6d2064-e9a4-4049-8a58-85afaf91d8e1) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[238/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mBinding Resolution[2m > [22mshould resolve simple bindings
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 9e0ea98d-1120-4c95-be30-a81cd7676a4e,test-1768709106843@example.com,Test User,Test,User,e00be13f-a71f-47a6-adb5-618cfccbe229,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(e00be13f-a71f-47a6-adb5-618cfccbe229) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[239/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mBinding Resolution[2m > [22mshould handle binding resolution errors gracefully
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: ff51a66f-a0ae-423e-a29a-644326741048,test-1768709107734@example.com,Test User,Test,User,34548efb-56b7-4340-a1c5-e740e56f84d9,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(34548efb-56b7-4340-a1c5-e740e56f84d9) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[240/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mError Handling[2m > [22mshould record failed output in runOutputs table
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 1b55f4dd-ef79-402d-9c85-fd4c99761524,test-1768709108383@example.com,Test User,Test,User,7505fc9e-7dc7-49c9-b547-14c7a22ddf8f,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(7505fc9e-7dc7-49c9-b547-14c7a22ddf8f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[241/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mError Handling[2m > [22mshould not throw errors (should return error in result)
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 812c20aa-7595-4260-b9c1-ebf3c9b2139d,test-1768709108991@example.com,Test User,Test,User,ec39b21a-fa7b-4740-8c8b-21801df748b2,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(ec39b21a-fa7b-4740-8c8b-21801df748b2) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w0_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[242/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mTenant Access Control[2m > [22mshould deny access to templates from different tenant
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 84d054d1-eb39-40de-ae79-11e74d2c7865,test-1768709109862@example.com,Test User,Test,User,39d7cdad-659a-4dbb-8d02-30d76ee0747b,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(39d7cdad-659a-4dbb-8d02-30d76ee0747b) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[243/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/engine/templateNode.test.ts[2m > [22mTemplate Node - Multi-Template Support[2m > [22mValidation[2m > [22mshould require either templateKey or templateId
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: f6b301f3-a09b-4f7e-a83b-ffbd9ec758a1,test-1768709110489@example.com,Test User,Test,User,19b45744-e04e-458d-a1e8-fd2a050b07d8,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/engine/templateNode.test.ts:[2m81:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(19b45744-e04e-458d-a1e8-fd2a050b07d8) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[244/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mcreate[2m > [22mshould create a workflow template mapping
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,0dc5ee29-9398-4bff-92b6-3cd48e60cdd7,0dc5ee29-9398-4bff-92b6-3cd48e60cdd7,0dc5ee29-9398-4bff-92b6-3cd48e60cdd7[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(0dc5ee29-9398-4bff-92b6-3cd48e60cdd7) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[245/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mcreate[2m > [22mshould create non-primary mapping by default
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,05494cf5-0273-400d-a9e6-c8f146258065,05494cf5-0273-400d-a9e6-c8f146258065,05494cf5-0273-400d-a9e6-c8f146258065[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(05494cf5-0273-400d-a9e6-c8f146258065) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[246/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionId[2m > [22mshould find all templates for a workflow version
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,58ac863b-ed08-4616-b7ee-d559769ea635,58ac863b-ed08-4616-b7ee-d559769ea635,58ac863b-ed08-4616-b7ee-d559769ea635[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(58ac863b-ed08-4616-b7ee-d559769ea635) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[247/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionId[2m > [22mshould return empty array for version with no templates
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,e2b4d4bb-c831-4254-b040-15c7fee3af43,e2b4d4bb-c831-4254-b040-15c7fee3af43,e2b4d4bb-c831-4254-b040-15c7fee3af43[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(e2b4d4bb-c831-4254-b040-15c7fee3af43) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[248/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionId[2m > [22mshould order by createdAt desc (newest first)
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,3cd9b08f-8896-426f-9619-bd89dc113084,3cd9b08f-8896-426f-9619-bd89dc113084,3cd9b08f-8896-426f-9619-bd89dc113084[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(3cd9b08f-8896-426f-9619-bd89dc113084) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[249/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionAndKey[2m > [22mshould find mapping by workflow version and key
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,ec1e6b31-5e19-4818-a82a-a22d4a14af88,ec1e6b31-5e19-4818-a82a-a22d4a14af88,ec1e6b31-5e19-4818-a82a-a22d4a14af88[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(ec1e6b31-5e19-4818-a82a-a22d4a14af88) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[250/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindByWorkflowVersionAndKey[2m > [22mshould return undefined for non-existent key
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,0297c5f2-58b3-4b50-a7cc-006315e58db6,0297c5f2-58b3-4b50-a7cc-006315e58db6,0297c5f2-58b3-4b50-a7cc-006315e58db6[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(0297c5f2-58b3-4b50-a7cc-006315e58db6) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[251/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindPrimaryByWorkflowVersionId[2m > [22mshould find primary template for workflow version
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,e950db68-296e-48e5-a359-c61973dfc4f5,e950db68-296e-48e5-a359-c61973dfc4f5,e950db68-296e-48e5-a359-c61973dfc4f5[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(e950db68-296e-48e5-a359-c61973dfc4f5) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w2_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[252/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindPrimaryByWorkflowVersionId[2m > [22mshould return undefined when no primary template exists
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,52c8260a-a86b-41f3-a5ba-58f2806268d0,52c8260a-a86b-41f3-a5ba-58f2806268d0,52c8260a-a86b-41f3-a5ba-58f2806268d0[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(52c8260a-a86b-41f3-a5ba-58f2806268d0) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[253/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22msetPrimary[2m > [22mshould set a template as primary and unset others
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,61125a41-4cf5-486b-9941-367b6a552dae,61125a41-4cf5-486b-9941-367b6a552dae,61125a41-4cf5-486b-9941-367b6a552dae[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(61125a41-4cf5-486b-9941-367b6a552dae) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[254/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22msetPrimary[2m > [22mshould handle setting primary when none existed before
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,40bee62a-e615-499f-838e-a280b49544c2,40bee62a-e615-499f-838e-a280b49544c2,40bee62a-e615-499f-838e-a280b49544c2[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(40bee62a-e615-499f-838e-a280b49544c2) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[255/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22msetPrimary[2m > [22mshould not delete mapping if workflow version does not match
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,568e98f0-18b6-4d6d-ba0e-e2bc14461a43,568e98f0-18b6-4d6d-ba0e-e2bc14461a43,568e98f0-18b6-4d6d-ba0e-e2bc14461a43[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(568e98f0-18b6-4d6d-ba0e-e2bc14461a43) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[256/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mexistsByKey[2m > [22mshould return true if key exists in workflow version
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,2b2876d0-d333-4158-9fc4-131befd6c74b,2b2876d0-d333-4158-9fc4-131befd6c74b,2b2876d0-d333-4158-9fc4-131befd6c74b[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(2b2876d0-d333-4158-9fc4-131befd6c74b) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w5_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[257/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mexistsByKey[2m > [22mshould return false if key does not exist
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, default, $5, default, default, default, default, default, default, $6, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,Test workflow,748625ab-a9d8-4245-a469-62ca249dcb63,748625ab-a9d8-4245-a469-62ca249dcb63,09c25d78-6622-4f35-85f1-a80aa1b57056,draft[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m
    [90m 50| [39m
    [90m 51| [39m    [90m// Create test workflow[39m
    [90m 52| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m db
    [90m   | [39m                       [31m^[39m
    [90m 53| [39m      [33m.[39m[34minsert[39m(workflows)
    [90m 54| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 327, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(748625ab-a9d8-4245-a469-62ca249dcb63) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[258/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mexistsByKey[2m > [22mshould exclude specified id when checking existence
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,2e66fffe-9d34-46b0-99df-67680ec0308f,2e66fffe-9d34-46b0-99df-67680ec0308f,2e66fffe-9d34-46b0-99df-67680ec0308f[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(2e66fffe-9d34-46b0-99df-67680ec0308f) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[259/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mexistsByKey[2m > [22mshould return true if key exists on different mapping
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,739fccfb-b675-4ae2-b38a-025148e2c058,739fccfb-b675-4ae2-b38a-025148e2c058,739fccfb-b675-4ae2-b38a-025148e2c058[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(739fccfb-b675-4ae2-b38a-025148e2c058) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w16_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[260/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mupdate[2m > [22mshould update mapping fields
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,81c6a863-6fb9-41b0-ad21-cd45546e13d7,81c6a863-6fb9-41b0-ad21-cd45546e13d7,81c6a863-6fb9-41b0-ad21-cd45546e13d7[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(81c6a863-6fb9-41b0-ad21-cd45546e13d7) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w15_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[261/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindById[2m > [22mshould find mapping by id
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, default, $5, default, default, default, default, default, default, $6, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,Test workflow,6f35e854-57d9-41d0-9c7c-ae00fca8f012,6f35e854-57d9-41d0-9c7c-ae00fca8f012,f5a01eef-a49f-4912-b544-4802c15415cb,draft[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m
    [90m 50| [39m
    [90m 51| [39m    [90m// Create test workflow[39m
    [90m 52| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m db
    [90m   | [39m                       [31m^[39m
    [90m 53| [39m      [33m.[39m[34minsert[39m(workflows)
    [90m 54| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m52:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 327, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(6f35e854-57d9-41d0-9c7c-ae00fca8f012) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[262/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/repositories/WorkflowTemplateRepository.test.ts[2m > [22mWorkflowTemplateRepository[2m > [22mfindById[2m > [22mshould return undefined for non-existent id
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, default, $5, $6, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project for workflow templates,d55cb151-ecb8-46e6-81d0-62b986a3edd7,d55cb151-ecb8-46e6-81d0-62b986a3edd7,d55cb151-ecb8-46e6-81d0-62b986a3edd7[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m
    [90m 36| [39m
    [90m 37| [39m    [90m// Create test project[39m
    [90m 38| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 39| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 40| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/repositories/WorkflowTemplateRepository.test.ts:[2m38:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(d55cb151-ecb8-46e6-81d0-62b986a3edd7) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w17_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[263/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22mhybridAuth[2m > [22mshould authenticate with JWT Bearer token
[31m[1mAssertionError[22m: expected "vi.fn()" to be called at least once[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m238:24[22m[39m
    [90m236| [39m      await hybridAuth(mockReq as unknown as Request, mockRes as unknoâ€¦
    [90m237| [39m
    [90m238| [39m      [34mexpect[39m(mockNext)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m239| [39m      [35mconst[39m authReq [33m=[39m mockReq [35mas[39m unknown [35mas[39m [33mAuthRequest[39m[33m;[39m
    [90m240| [39m      [34mexpect[39m(authReq[33m.[39muserId)[33m.[39m[34mtoBe[39m(mockUser[33m.[39mid)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[264/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22mhybridAuth[2m > [22mshould authenticate with refresh token cookie for GET requests
[31m[1mAssertionError[22m: expected "vi.fn()" to be called with arguments: [ 'user-123' ][90m

Number of calls: [1m0[22m
[31m[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m256:39[22m[39m
    [90m254| [39m
    [90m255| [39m      expect(authService.validateRefreshToken).toHaveBeenCalledWith(reâ€¦
    [90m256| [39m      expect(userRepository.findById).toHaveBeenCalledWith(mockUser.idâ€¦
    [90m   | [39m                                      [31m^[39m
    [90m257| [39m      [34mexpect[39m(mockNext)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m258| [39m      [35mconst[39m authReq [33m=[39m mockReq [35mas[39m unknown [35mas[39m [33mAuthRequest[39m[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[265/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22mhybridAuth[2m > [22mshould reject cookie auth for POST requests
[31m[1mAssertionError[22m: expected "vi.fn()" to be called with arguments: [ 401 ][90m

Number of calls: [1m0[22m
[31m[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m272:26[22m[39m
    [90m270| [39m
    [90m271| [39m      [34mexpect[39m(mockNext)[33m.[39mnot[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m272| [39m      [34mexpect[39m(statusMock)[33m.[39m[34mtoHaveBeenCalledWith[39m([34m401[39m)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m273| [39m      expect(authService.validateRefreshToken).not.toHaveBeenCalled();â€¦
    [90m274| [39m    })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[266/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22mhybridAuth[2m > [22mshould prioritize JWT over cookie when both present
[31m[1mAssertionError[22m: expected "vi.fn()" to be called at least once[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m296:24[22m[39m
    [90m294| [39m      await hybridAuth(mockReq as unknown as Request, mockRes as unknoâ€¦
    [90m295| [39m
    [90m296| [39m      [34mexpect[39m(mockNext)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m297| [39m      [35mconst[39m authReq [33m=[39m mockReq [35mas[39m unknown [35mas[39m [33mAuthRequest[39m[33m;[39m
    [90m298| [39m      [90m// Should use JWT (mockUser), not cookie (mockUser2)[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[267/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22mhybridAuth[2m > [22mshould allow cookie auth only for safe methods
[31m[1mAssertionError[22m: expected "vi.fn()" to be called at least once[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m324:22[22m[39m
    [90m322| [39m
    [90m323| [39m        await hybridAuth(req as unknown as Request, res as unknown as â€¦
    [90m324| [39m        [34mexpect[39m(next)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                     [31m^[39m
    [90m325| [39m        expect(authService.validateRefreshToken).toHaveBeenCalledWith(â€¦
    [90m326| [39m        expect(userRepository.findById).toHaveBeenCalledWith(mockUser.â€¦

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[268/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22mhybridAuth[2m > [22mshould return 401 when no auth provided
[31m[1mAssertionError[22m: expected "vi.fn()" to be called with arguments: [ 401 ][90m

Number of calls: [1m0[22m
[31m[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m364:26[22m[39m
    [90m362| [39m
    [90m363| [39m      [34mexpect[39m(mockNext)[33m.[39mnot[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m364| [39m      [34mexpect[39m(statusMock)[33m.[39m[34mtoHaveBeenCalledWith[39m([34m401[39m)[33m;[39m
    [90m   | [39m                         [31m^[39m
    [90m365| [39m    })[33m;[39m
    [90m366| [39m  })[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[269/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22moptionalHybridAuth[2m > [22mshould authenticate with JWT
[31m[1mAssertionError[22m: expected "vi.fn()" to be called at least once[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m381:24[22m[39m
    [90m379| [39m      await optionalHybridAuth(mockReq as unknown as Request, mockRes â€¦
    [90m380| [39m
    [90m381| [39m      [34mexpect[39m(mockNext)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m382| [39m      [35mconst[39m authReq [33m=[39m mockReq [35mas[39m unknown [35mas[39m [33mAuthRequest[39m[33m;[39m
    [90m383| [39m      [34mexpect[39m(authReq[33m.[39muserId)[33m.[39m[34mtoBe[39m(mockUser[33m.[39mid)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[270/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22moptionalHybridAuth[2m > [22mshould authenticate with cookie for GET
[31m[1mAssertionError[22m: expected "vi.fn()" to be called at least once[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m400:24[22m[39m
    [90m398| [39m      await optionalHybridAuth(mockReq as unknown as Request, mockRes â€¦
    [90m399| [39m
    [90m400| [39m      [34mexpect[39m(mockNext)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m401| [39m      [35mconst[39m authReq [33m=[39m mockReq [35mas[39m unknown [35mas[39m [33mAuthRequest[39m[33m;[39m
    [90m402| [39m      [34mexpect[39m(authReq[33m.[39muserId)[33m.[39m[34mtoBe[39m(mockUser[33m.[39mid)[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[271/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22moptionalHybridAuth[2m > [22mshould proceed without auth when none provided
[31m[1mAssertionError[22m: expected "vi.fn()" to be called at least once[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m413:24[22m[39m
    [90m411| [39m      await optionalHybridAuth(mockReq as unknown as Request, mockRes â€¦
    [90m412| [39m
    [90m413| [39m      [34mexpect[39m(mockNext)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m414| [39m      [35mconst[39m authReq [33m=[39m mockReq [35mas[39m unknown [35mas[39m [33mAuthRequest[39m[33m;[39m
    [90m415| [39m      [34mexpect[39m(authReq[33m.[39muserId)[33m.[39m[34mtoBeUndefined[39m()[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[272/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22moptionalHybridAuth[2m > [22mshould proceed even with invalid auth
[31m[1mAssertionError[22m: expected "vi.fn()" to be called at least once[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m435:24[22m[39m
    [90m433| [39m      await optionalHybridAuth(mockReq as unknown as Request, mockRes â€¦
    [90m434| [39m
    [90m435| [39m      [34mexpect[39m(mockNext)[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m   | [39m                       [31m^[39m
    [90m436| [39m      [35mconst[39m authReq [33m=[39m mockReq [35mas[39m unknown [35mas[39m [33mAuthRequest[39m[33m;[39m
    [90m437| [39m      [34mexpect[39m(authReq[33m.[39muserId)[33m.[39m[34mtoBeUndefined[39m()[33m;[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[273/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/middleware/auth.middleware.test.ts[2m > [22mAuth Middleware[2m > [22mSecurity Edge Cases[2m > [22mshould not allow cookie auth for mutations (CSRF protection)
[31m[1mAssertionError[22m: expected "vi.fn()" to be called with arguments: [ 401 ][90m

Number of calls: [1m0[22m
[31m[39m
[36m [2mâ¯[22m tests/unit/middleware/auth.middleware.test.ts:[2m479:28[22m[39m
    [90m477| [39m
    [90m478| [39m        [34mexpect[39m(next)[33m.[39mnot[33m.[39m[34mtoHaveBeenCalled[39m()[33m;[39m
    [90m479| [39m        [34mexpect[39m(res[33m.[39mstatus)[33m.[39m[34mtoHaveBeenCalledWith[39m([34m401[39m)[33m;[39m
    [90m   | [39m                           [31m^[39m
    [90m480| [39m        expect(authService.validateRefreshToken).not.toHaveBeenCalled(â€¦
    [90m481| [39m        vi[33m.[39m[34mclearAllMocks[39m()[33m;[39m [90m// Clear mocks for next iteration[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[274/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mPassword Reset[2m > [22mgeneratePasswordResetToken()[2m > [22mshould generate password reset token for existing user
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.generatePasswordResetToken server/services/AuthService.ts:[2m508:9[22m[39m
    [90m506| [39m
    [90m507| [39m        [35mawait[39m [34msendPasswordResetEmail[39m(email[33m,[39m plainToken)[33m;[39m
    [90m508| [39m        log[33m.[39m[34minfo[39m({ email }[33m,[39m [32m'Password reset email sent'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m509| [39m
    [90m510| [39m        [35mreturn[39m plainToken[33m;[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m671:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[275/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mPassword Reset[2m > [22mgeneratePasswordResetToken()[2m > [22mshould invalidate previous reset tokens
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.generatePasswordResetToken server/services/AuthService.ts:[2m508:9[22m[39m
    [90m506| [39m
    [90m507| [39m        [35mawait[39m [34msendPasswordResetEmail[39m(email[33m,[39m plainToken)[33m;[39m
    [90m508| [39m        log[33m.[39m[34minfo[39m({ email }[33m,[39m [32m'Password reset email sent'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m509| [39m
    [90m510| [39m        [35mreturn[39m plainToken[33m;[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m695:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[276/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mRefresh Token Management[2m > [22mrotateRefreshToken()[2m > [22mshould rotate valid token and return new one
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.rotateRefreshToken server/services/AuthService.ts:[2m396:9[22m[39m
    [90m394| [39m        [90m// DEBUG LOG[39m
    [90m395| [39m        [90m// logger is available as 'log' from imports[39m
    [90m396| [39m        log.info({ tokenHash, plainTokenLen: plainToken.length }, 'DEBâ€¦
    [90m   | [39m        [31m^[39m
    [90m397| [39m
    [90m398| [39m        [90m// Find token purely by hash to detect state[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m901:42[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[277/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mRefresh Token Management[2m > [22mrotateRefreshToken()[2m > [22mshould return null for unknown token
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.rotateRefreshToken server/services/AuthService.ts:[2m396:9[22m[39m
    [90m394| [39m        [90m// DEBUG LOG[39m
    [90m395| [39m        [90m// logger is available as 'log' from imports[39m
    [90m396| [39m        log.info({ tokenHash, plainTokenLen: plainToken.length }, 'DEBâ€¦
    [90m   | [39m        [31m^[39m
    [90m397| [39m
    [90m398| [39m        [90m// Find token purely by hash to detect state[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m914:42[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[278/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mRefresh Token Management[2m > [22mrotateRefreshToken()[2m > [22mshould revoke all tokens on reuse detection
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.rotateRefreshToken server/services/AuthService.ts:[2m396:9[22m[39m
    [90m394| [39m        [90m// DEBUG LOG[39m
    [90m395| [39m        [90m// logger is available as 'log' from imports[39m
    [90m396| [39m        log.info({ tokenHash, plainTokenLen: plainToken.length }, 'DEBâ€¦
    [90m   | [39m        [31m^[39m
    [90m397| [39m
    [90m398| [39m        [90m// Find token purely by hash to detect state[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m933:42[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[279/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mRefresh Token Management[2m > [22mrotateRefreshToken()[2m > [22mshould return null for expired token
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.rotateRefreshToken server/services/AuthService.ts:[2m396:9[22m[39m
    [90m394| [39m        [90m// DEBUG LOG[39m
    [90m395| [39m        [90m// logger is available as 'log' from imports[39m
    [90m396| [39m        log.info({ tokenHash, plainTokenLen: plainToken.length }, 'DEBâ€¦
    [90m   | [39m        [31m^[39m
    [90m397| [39m
    [90m398| [39m        [90m// Find token purely by hash to detect state[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m950:42[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[280/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mToken Cleanup[2m > [22mcleanupExpiredTokens()[2m > [22mshould cleanup expired refresh tokens
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.cleanupExpiredTokens server/services/AuthService.ts:[2m593:9[22m[39m
    [90m591| [39m        [35mawait[39m accountLockoutService[33m.[39m[34mcleanupOldAttempts[39m()[33m;[39m
    [90m592| [39m
    [90m593| [39m        log[33m.[39m[34minfo[39m([32m'Cleaned up expired tokens and old login attempts'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m594| [39m    }
    [90m595| [39m}
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m977:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[281/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mToken Cleanup[2m > [22mcleanupExpiredTokens()[2m > [22mshould cleanup expired password reset tokens
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.cleanupExpiredTokens server/services/AuthService.ts:[2m593:9[22m[39m
    [90m591| [39m        [35mawait[39m accountLockoutService[33m.[39m[34mcleanupOldAttempts[39m()[33m;[39m
    [90m592| [39m
    [90m593| [39m        log[33m.[39m[34minfo[39m([32m'Cleaned up expired tokens and old login attempts'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m594| [39m    }
    [90m595| [39m}
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m982:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[282/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mToken Cleanup[2m > [22mcleanupExpiredTokens()[2m > [22mshould cleanup expired email verification tokens
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.cleanupExpiredTokens server/services/AuthService.ts:[2m593:9[22m[39m
    [90m591| [39m        [35mawait[39m accountLockoutService[33m.[39m[34mcleanupOldAttempts[39m()[33m;[39m
    [90m592| [39m
    [90m593| [39m        log[33m.[39m[34minfo[39m([32m'Cleaned up expired tokens and old login attempts'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m594| [39m    }
    [90m595| [39m}
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m987:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[283/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mToken Cleanup[2m > [22mcleanupExpiredTokens()[2m > [22mshould cleanup old login attempts via accountLockoutService
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.cleanupExpiredTokens server/services/AuthService.ts:[2m593:9[22m[39m
    [90m591| [39m        [35mawait[39m accountLockoutService[33m.[39m[34mcleanupOldAttempts[39m()[33m;[39m
    [90m592| [39m
    [90m593| [39m        log[33m.[39m[34minfo[39m([32m'Cleaned up expired tokens and old login attempts'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m594| [39m    }
    [90m595| [39m}
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m993:9[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[284/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mIntegration Scenarios[2m > [22mComplete Authentication Flow[2m > [22mshould support full user authentication lifecycle
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.rotateRefreshToken server/services/AuthService.ts:[2m396:9[22m[39m
    [90m394| [39m        [90m// DEBUG LOG[39m
    [90m395| [39m        [90m// logger is available as 'log' from imports[39m
    [90m396| [39m        log.info({ tokenHash, plainTokenLen: plainToken.length }, 'DEBâ€¦
    [90m   | [39m        [31m^[39m
    [90m397| [39m
    [90m398| [39m        [90m// Find token purely by hash to detect state[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m1239:43[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[285/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mIntegration Scenarios[2m > [22mPassword Reset Flow[2m > [22mshould support complete password reset workflow
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.generatePasswordResetToken server/services/AuthService.ts:[2m508:9[22m[39m
    [90m506| [39m
    [90m507| [39m        [35mawait[39m [34msendPasswordResetEmail[39m(email[33m,[39m plainToken)[33m;[39m
    [90m508| [39m        log[33m.[39m[34minfo[39m({ email }[33m,[39m [32m'Password reset email sent'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m509| [39m
    [90m510| [39m        [35mreturn[39m plainToken[33m;[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m1259:28[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[286/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/AuthService.test.ts[2m > [22mAuthService[2m > [22mIntegration Scenarios[2m > [22mPassword Reset Flow[2m > [22mshould prevent reuse of password reset tokens
[31m[1mReferenceError[22m: log is not defined[39m
[36m [2mâ¯[22m AuthService.generatePasswordResetToken server/services/AuthService.ts:[2m508:9[22m[39m
    [90m506| [39m
    [90m507| [39m        [35mawait[39m [34msendPasswordResetEmail[39m(email[33m,[39m plainToken)[33m;[39m
    [90m508| [39m        log[33m.[39m[34minfo[39m({ email }[33m,[39m [32m'Password reset email sent'[39m)[33m;[39m
    [90m   | [39m        [31m^[39m
    [90m509| [39m
    [90m510| [39m        [35mreturn[39m plainToken[33m;[39m
[90m [2mâ¯[22m tests/unit/services/AuthService.test.ts:[2m1296:28[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[287/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22menqueue[2m > [22mshould enqueue a PDF conversion job
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,6578e48c-4176-4646-909e-786868336058,c0dac7c5-cb2d-4a81-bc56-3745c3941414,6578e48c-4176-4646-909e-786868336058,6578e48c-4176-4646-909e-786868336058[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(6578e48c-4176-4646-909e-786868336058) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[288/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22menqueue[2m > [22mshould create output with empty storagePath initially
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,60e72d6d-4cc5-42ec-934f-1fe37eec620c,917874cd-4441-434f-8018-e9af718b7e27,60e72d6d-4cc5-42ec-934f-1fe37eec620c,60e72d6d-4cc5-42ec-934f-1fe37eec620c[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(60e72d6d-4cc5-42ec-934f-1fe37eec620c) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[289/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mgetJobStatus[2m > [22mshould return job status for pending job
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,20c2bbfe-3363-4b1f-bbc1-7dce2ab7ece9,0e869bea-6b06-43ab-86a2-e9c80f5968a6,20c2bbfe-3363-4b1f-bbc1-7dce2ab7ece9,20c2bbfe-3363-4b1f-bbc1-7dce2ab7ece9[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(20c2bbfe-3363-4b1f-bbc1-7dce2ab7ece9) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[290/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mgetJobStatus[2m > [22mshould return null for non-existent job
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, $5, $6, default, default, default, default, default, default, $7, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,Test workflow,3bbb60cb-6645-499a-b887-c051eaba84ef,3bbb60cb-6645-499a-b887-c051eaba84ef,Test Workflow,a9781721-2d74-4ebf-8b38-ee62a837f3bd,draft[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m109:24[22m[39m
    [90m107| [39m
    [90m108| [39m    [90m// Create test workflow[39m
    [90m109| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m db
    [90m   | [39m                       [31m^[39m
    [90m110| [39m      [33m.[39m[34minsert[39m(workflows)
    [90m111| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m109:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(3bbb60cb-6645-499a-b887-c051eaba84ef) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[291/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mgetJobStatus[2m > [22mshould parse attempt count from error field
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,b4b1f7b9-b71e-4d72-a239-0d4ccb4ba5ff,9f1b2f4f-8321-48a5-bf7d-8fb3293384fb,b4b1f7b9-b71e-4d72-a239-0d4ccb4ba5ff,b4b1f7b9-b71e-4d72-a239-0d4ccb4ba5ff[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(b4b1f7b9-b71e-4d72-a239-0d4ccb4ba5ff) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[292/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mconvertImmediate[2m > [22mshould convert DOCX to PDF immediately
[31m[1mError[22m: Failed query: insert into "workflows" ("id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id") values (default, $1, $2, $3, $4, default, default, $5, $6, default, default, default, default, default, default, $7, default, default, default, default, default) returning "id", "title", "description", "creator_id", "owner_id", "mode_override", "public_link", "name", "project_id", "current_version_id", "is_public", "slug", "require_login", "intake_config", "pinned_version_id", "status", "owner_type", "owner_uuid", "created_at", "updated_at", "source_blueprint_id"
params: Test Workflow,Test workflow,d53c1096-f448-4498-b843-ae62e72f16e0,d53c1096-f448-4498-b843-ae62e72f16e0,Test Workflow,67b49fe0-eda5-4658-a587-8da4910bc64c,draft[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m109:24[22m[39m
    [90m107| [39m
    [90m108| [39m    [90m// Create test workflow[39m
    [90m109| [39m    [35mconst[39m [workflow] [33m=[39m [35mawait[39m db
    [90m   | [39m                       [31m^[39m
    [90m110| [39m      [33m.[39m[34minsert[39m(workflows)
    [90m111| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "workflows" violates foreign key constraint "workflows_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m109:24[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 328, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(d53c1096-f448-4498-b843-ae62e72f16e0) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'workflows', dataType: undefined, constraint: 'workflows_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[293/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mconvertImmediate[2m > [22mshould handle conversion errors gracefully
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,ea8ff87e-681b-4cab-8d29-6833bce3d962,3496226c-375b-400d-b4a2-f4f2e86398e8,ea8ff87e-681b-4cab-8d29-6833bce3d962,ea8ff87e-681b-4cab-8d29-6833bce3d962[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(ea8ff87e-681b-4cab-8d29-6833bce3d962) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[294/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mService Lifecycle[2m > [22mshould start and stop service
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,3c6adba3-78a7-49fe-afda-5125309732b7,bcca5618-602f-406a-b848-4a2037fadd67,3c6adba3-78a7-49fe-afda-5125309732b7,3c6adba3-78a7-49fe-afda-5125309732b7[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 327, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(bcca5618-602f-406a-b848-4a2037fadd67) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'projects', dataType: undefined, constraint: 'projects_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[295/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mService Lifecycle[2m > [22mshould not start if already running
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,19025428-be03-4721-b444-a80d3b42c929,47d1af78-81a1-4779-9a05-bc5c7b70aba5,19025428-be03-4721-b444-a80d3b42c929,19025428-be03-4721-b444-a80d3b42c929[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(19025428-be03-4721-b444-a80d3b42c929) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[296/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mService Lifecycle[2m > [22mshould handle stop when not running
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,cba8b970-b0fd-4390-ab2b-f9273b6b3d6a,dfed9d66-a221-4e1d-bc76-f3977366a792,cba8b970-b0fd-4390-ab2b-f9273b6b3d6a,cba8b970-b0fd-4390-ab2b-f9273b6b3d6a[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(cba8b970-b0fd-4390-ab2b-f9273b6b3d6a) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w7_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[297/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mQueue Processing[2m > [22mshould process pending jobs when queue is processed
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,4df643dc-3fb1-4677-a528-4d4646b7a3db,d9d2d7a4-4c68-4b7a-b0c7-558b923be601,4df643dc-3fb1-4677-a528-4d4646b7a3db,4df643dc-3fb1-4677-a528-4d4646b7a3db[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(4df643dc-3fb1-4677-a528-4d4646b7a3db) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[298/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mQueue Processing[2m > [22mshould process multiple jobs in batch
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,b6182e20-0902-4e0f-b1a7-2e19497b5a57,6202ed12-31e1-4c24-947e-96dbeee6837a,b6182e20-0902-4e0f-b1a7-2e19497b5a57,b6182e20-0902-4e0f-b1a7-2e19497b5a57[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(b6182e20-0902-4e0f-b1a7-2e19497b5a57) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w1_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[299/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mError Handling[2m > [22mshould handle missing DOCX output gracefully
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,2ee0a057-522d-4e1c-bd7e-4508d0b22257,89704ee2-4b3e-4b93-aed6-f905e16d922f,2ee0a057-522d-4e1c-bd7e-4508d0b22257,2ee0a057-522d-4e1c-bd7e-4508d0b22257[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 326, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(89704ee2-4b3e-4b93-aed6-f905e16d922f) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'projects', dataType: undefined, constraint: 'projects_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[300/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mTransaction Support[2m > [22mshould support enqueue within transaction
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,66381b7e-c6ed-4efc-8e60-d3b8e2b1b87b,e12d0e83-271d-4fbe-a5cc-e298c1914dd3,66381b7e-c6ed-4efc-8e60-d3b8e2b1b87b,66381b7e-c6ed-4efc-8e60-d3b8e2b1b87b[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(66381b7e-c6ed-4efc-8e60-d3b8e2b1b87b) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w16_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[301/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/PdfQueueService.test.ts[2m > [22mPdfQueueService[2m > [22mTransaction Support[2m > [22mshould support convertImmediate within transaction
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values (default, $1, $2, $3, $4, $5, $6, $7, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: Test Project,Test Project,Test project,e9bbfd65-7ad6-4573-af8a-5de8fabfc13d,b8014bab-9108-49eb-8961-4892710318c5,e9bbfd65-7ad6-4573-af8a-5de8fabfc13d,e9bbfd65-7ad6-4573-af8a-5de8fabfc13d[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m
    [90m 92| [39m
    [90m 93| [39m    [90m// Create test project[39m
    [90m 94| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m db
    [90m   | [39m                      [31m^[39m
    [90m 95| [39m      [33m.[39m[34minsert[39m(projects)
    [90m 96| [39m      [33m.[39m[34mvalues[39m({

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m tests/unit/services/PdfQueueService.test.ts:[2m94:23[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(e9bbfd65-7ad6-4573-af8a-5de8fabfc13d) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[302/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mshould throw error if template belongs to different project
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 02986e86-0b36-4d92-bb72-f25c7bafd3e6,test-1768709099542@example.com,Test User,Test,User,d3ed3830-3301-41aa-8a01-2d6baecf6bbb,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(d3ed3830-3301-41aa-8a01-2d6baecf6bbb) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[303/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mshould automatically unset other primaries when setting new primary
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: f6e10881-d452-4c20-9c47-51b76deacebd,Test Project,Test Project,Test project for integration tests,8fb9e833-98ee-4aa9-9166-d44b94de4ac7,6096db6c-d52a-49dd-a999-907c9bcb346d,8fb9e833-98ee-4aa9-9166-d44b94de4ac7,8fb9e833-98ee-4aa9-9166-d44b94de4ac7[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(8fb9e833-98ee-4aa9-9166-d44b94de4ac7) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[304/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mlistTemplates[2m > [22mshould list all templates for workflow version
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: ce875fa9-1712-4e9c-9a03-0a9b7133609c,test-1768709100881@example.com,Test User,Test,User,eef651d4-21f4-46d0-a90b-26a3db00fef5,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(eef651d4-21f4-46d0-a90b-26a3db00fef5) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[305/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mlistTemplates[2m > [22mshould return empty array for version with no templates
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 482e6244-e6ca-4620-b58c-4cbd96b1fd0e,test-1768709101487@example.com,Test User,Test,User,6cddd20b-191a-4970-888a-d51c65d54b12,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(6cddd20b-191a-4970-888a-d51c65d54b12) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[306/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetTemplateMapping[2m > [22mshould get template mapping by id and version
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 0610f4e5-e225-4ff3-ba7e-f897cdf75aaa,test-1768709102103@example.com,Test User,Test,User,aeba876f-0284-4963-bba2-945c76b79a80,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(aeba876f-0284-4963-bba2-945c76b79a80) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[307/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetTemplateMapping[2m > [22mshould throw error if mapping not found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: beda32ec-1fe1-4693-b528-518c5d56a9a0,test-1768709102714@example.com,Test User,Test,User,53ce3255-f376-49de-a392-20d33464d250,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(53ce3255-f376-49de-a392-20d33464d250) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w4_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[308/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetTemplateByKey[2m > [22mshould get template by key
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 6dfcaf04-d845-441f-8748-77d7ded78cbb,test-1768709103321@example.com,Test User,Test,User,00cea526-8775-44ec-a2a1-545324f7c668,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(00cea526-8775-44ec-a2a1-545324f7c668) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w12_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[309/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetTemplateByKey[2m > [22mshould throw error if key not found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 9bc72fe5-40bf-4ef9-8e98-5666dd4e0473,test-1768709103914@example.com,Test User,Test,User,b01d4e9c-8a03-4ad9-ae36-8853090ff19a,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(b01d4e9c-8a03-4ad9-ae36-8853090ff19a) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w8_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[310/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetPrimaryTemplate[2m > [22mshould get primary template for workflow version
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: fd576cb4-84e1-4764-ab8e-f92b1ae38a42,Test Project,Test Project,Test project for integration tests,89ac25b6-bfa1-4b4d-be00-88adc9384716,360ec4ca-ca61-4562-b741-80c9204e675d,89ac25b6-bfa1-4b4d-be00-88adc9384716,89ac25b6-bfa1-4b4d-be00-88adc9384716[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(89ac25b6-bfa1-4b4d-be00-88adc9384716) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[311/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mgetPrimaryTemplate[2m > [22mshould return null when no primary template exists
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 1e18d576-9552-4fb0-b240-6fdc8fb807e7,test-1768709105184@example.com,Test User,Test,User,6362d8b6-3e8b-4e94-82de-aa161d13915e,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(6362d8b6-3e8b-4e94-82de-aa161d13915e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[312/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould update mapping key
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 539d1557-2e7f-4abe-a6af-5edfed67c841,test-1768709105802@example.com,Test User,Test,User,2799bd7f-118b-4569-b685-d7894c74d348,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(2799bd7f-118b-4569-b685-d7894c74d348) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w6_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[313/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould update isPrimary flag
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 5069fc9f-f7c7-4fa0-bf9f-23a70b3e2e41,test-1768709106417@example.com,Test User,Test,User,df6426cb-d689-4f83-a74e-bac567d09e40,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(df6426cb-d689-4f83-a74e-bac567d09e40) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w13_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[314/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould throw error if new key already exists
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 9fcbdff4-75d9-4609-b4e5-32e768c7f75b,test-1768709107030@example.com,Test User,Test,User,f6cd3faf-6a78-4a1d-9918-1023b19690b3,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f6cd3faf-6a78-4a1d-9918-1023b19690b3) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w10_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[315/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould throw error if mapping not found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: d6d34ba6-91fb-406d-ba2f-e04579192557,test-1768709107666@example.com,Test User,Test,User,a4a6fc5d-e47d-473b-83cd-d5daa726be0e,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(a4a6fc5d-e47d-473b-83cd-d5daa726be0e) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[316/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mupdateTemplateMapping[2m > [22mshould unset other primaries when setting isPrimary to true
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 06c7ab89-3e6a-450f-9463-ded0a1061f78,test-1768709108263@example.com,Test User,Test,User,f3c68d30-6033-403a-b2fc-3d331fe8116a,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(f3c68d30-6033-403a-b2fc-3d331fe8116a) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[317/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mdetachTemplate[2m > [22mshould detach template from workflow version
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 0ad671b6-a12d-41fe-9826-18e0bbdeda87,test-1768709108851@example.com,Test User,Test,User,63b0ad93-f6fd-47d8-9cbd-2aadaf79d8f8,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(63b0ad93-f6fd-47d8-9cbd-2aadaf79d8f8) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w11_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[318/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mdetachTemplate[2m > [22mshould throw error if mapping not found
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: a724d0db-7b91-4582-ac23-4a7ffb8c8dfb,test-1768709109476@example.com,Test User,Test,User,77b52192-0ecd-45f3-b6ef-7e6cc2100950,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 314, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(77b52192-0ecd-45f3-b6ef-7e6cc2100950) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w2_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[319/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22msetPrimaryTemplate[2m > [22mshould set template as primary
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: 6c7cffa6-6e69-427e-a243-4caeb45a3ffc,Test Project,Test Project,Test project for integration tests,af46d578-9607-4c49-840d-5ca813dcdac1,4b143ab3-d6c0-42f6-989c-9f2f06234469,af46d578-9607-4c49-840d-5ca813dcdac1,af46d578-9607-4c49-840d-5ca813dcdac1[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 323, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(af46d578-9607-4c49-840d-5ca813dcdac1) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w9_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[320/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22msetPrimaryTemplate[2m > [22mshould throw error if mapping not found
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: 1a90e66a-ebbe-4572-90ac-95dc46ce654a,Test Project,Test Project,Test project for integration tests,c91538c8-a0b6-453c-a1c6-fd45116ef55e,d45afd8f-1270-45ce-93a4-69f7ba296433,c91538c8-a0b6-453c-a1c6-fd45116ef55e,c91538c8-a0b6-453c-a1c6-fd45116ef55e[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(c91538c8-a0b6-453c-a1c6-fd45116ef55e) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w16_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[321/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mtransaction support[2m > [22mshould support operations within a transaction
[31m[1mError[22m: Failed query: insert into "projects" ("id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at") values ($1, $2, $3, $4, $5, $6, $7, $8, default, default, default, default, default, default) returning "id", "title", "name", "description", "creator_id", "tenant_id", "created_by", "owner_id", "owner_type", "owner_uuid", "status", "archived", "created_at", "updated_at"
params: c34ee70a-626b-4404-b964-a290b49a5c56,Test Project,Test Project,Test project for integration tests,029b4e4f-a272-4bd9-830a-b3f124bdbad5,03804143-7cc3-4f04-a141-4121ab450411,029b4e4f-a272-4bd9-830a-b3f124bdbad5,029b4e4f-a272-4bd9-830a-b3f124bdbad5[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
    [90m120| [39m
    [90m121| [39m    [90m// Create project with all required ownership fields[39m
    [90m122| [39m    [35mconst[39m [project] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                      [31m^[39m
    [90m123| [39m      [33m.[39m[34minsert[39m(schema[33m.[39mprojects)
    [90m124| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "projects" violates foreign key constraint "projects_creator_id_users_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m122:23[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 324, severity: 'ERROR', code: '23503', detail: 'Key (creator_id)=(029b4e4f-a272-4bd9-830a-b3f124bdbad5) is not present in table "users".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w16_v3', table: 'projects', dataType: undefined, constraint: 'projects_creator_id_users_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[322/341]âŽ¯[22m[39m

[41m[1m FAIL [22m[49m tests/unit/services/WorkflowTemplateService.test.ts[2m > [22mWorkflowTemplateService[2m > [22mattachTemplate[2m > [22mtransaction support[2m > [22mshould rollback on transaction error
[31m[1mError[22m: Failed query: insert into "users" ("id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at") values ($1, $2, $3, $4, $5, default, $6, $7, $8, $9, $10, default, default, default, default, default, default, default) returning "id", "email", "full_name", "first_name", "last_name", "profile_image_url", "tenant_id", "role", "tenant_role", "auth_provider", "default_mode", "email_verified", "mfa_enabled", "last_password_change", "is_placeholder", "placeholder_email", "created_at", "updated_at"
params: 756880a6-8d54-4478-8f8a-f2871f4c47ec,test-1768709112624@example.com,Test User,Test,User,ec46b962-2e7d-4f81-a546-9db30fc0ba48,admin,owner,local,easy[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m41:15[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
    [90m102| [39m
    [90m103| [39m    [90m// Create user with admin/owner role for test permissions[39m
    [90m104| [39m    [35mconst[39m [user] [33m=[39m [35mawait[39m [35mthis[39m[33m.[39mdb
    [90m   | [39m                   [31m^[39m
    [90m105| [39m      [33m.[39m[34minsert[39m(schema[33m.[39musers)
    [90m106| [39m      [33m.[39m[34mvalues[39m({
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[1mCaused by: error[22m: insert or update on table "users" violates foreign key constraint "users_tenant_id_tenants_id_fk"[39m
[90m [2mâ¯[22m node_modules/pg-pool/index.js:[2m45:11[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m124:18[22m[39m
[90m [2mâ¯[22m NodePgPreparedQuery.queryWithCache node_modules/drizzle-orm/pg-core/session.js:[2m39:16[22m[39m
[90m [2mâ¯[22m node_modules/drizzle-orm/node-postgres/session.js:[2m117:22[22m[39m
[36m [2mâ¯[22m TestFactory.createTenant tests/helpers/testFactory.ts:[2m104:20[22m[39m
[90m [2mâ¯[22m tests/unit/services/WorkflowTemplateService.test.ts:[2m47:39[22m[39m

[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[22m[39m
[31m[1mSerialized Error:[22m[39m [90m{ length: 315, severity: 'ERROR', code: '23503', detail: 'Key (tenant_id)=(ec46b962-2e7d-4f81-a546-9db30fc0ba48) is not present in table "tenants".', hint: undefined, position: undefined, internalPosition: undefined, internalQuery: undefined, where: undefined, schema: 'test_schema_w17_v3', table: 'users', dataType: undefined, constraint: 'users_tenant_id_tenants_id_fk', file: 'ri_triggers.c', routine: 'ri_ReportViolation' }[39m
[31m[2mâŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯âŽ¯[323/341]âŽ¯[22m[39m


[2m Test Files [22m [1m[31m51 failed[39m[22m[2m | [22m[1m[32m105 passed[39m[22m[2m | [22m[33m1 skipped[39m[90m (157)[39m
[2m      Tests [22m [1m[31m307 failed[39m[22m[2m | [22m[1m[32m2023 passed[39m[22m[2m | [22m[33m310 skipped[39m[90m (2640)[39m
[2m   Start at [22m 22:04:54
[2m   Duration [22m 91.96s[2m (transform 22.97s, setup 20.24s, import 303.07s, tests 768.47s, environment 23.88s)[22m

