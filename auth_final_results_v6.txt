npm warn Unknown project config "puppeteer_skip_download". This will stop working in the next major version of npm.

[1m[46m RUN [49m[22m [36mv4.0.16 [39m[90mC:/Users/scoot/poll/VaultLogic[39m

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w11_07df7ad9

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w11_07df7ad9

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w10_af611100

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w10_af611100

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768250416031,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

{"level":30,"time":1768250416080,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768250416231,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768250416265,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w9_e7437d43

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w9_e7437d43

{"level":30,"time":1768250417043,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768250417091,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w8_bee5626c

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w8_bee5626c

{"level":30,"time":1768250417375,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768250417418,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

{"level":30,"time":1768250417852,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768250417866,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768250417866,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768250417870,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768250417871,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768250417882,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768250417892,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768250417914,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w5_3d0afa22

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w6_5619afbb

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w4_bceb160f

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w3_6832ab4f

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w5_3d0afa22

{"level":30,"time":1768250418397,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w6_5619afbb

{"level":30,"time":1768250418400,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w4_bceb160f

{"level":30,"time":1768250418404,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768250418429,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w3_6832ab4f

{"level":30,"time":1768250418437,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768250418437,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768250418440,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

{"level":30,"time":1768250418476,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w0_ced6369a

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w1_dce3d1e3

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w7_59d7d948

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w2_1353c25f

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_ced6369a

{"level":30,"time":1768250423014,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w1_dce3d1e3

{"level":30,"time":1768250423019,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w7_59d7d948

{"level":30,"time":1768250423029,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w2_1353c25f

{"level":30,"time":1768250423039,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768250423045,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

{"level":30,"time":1768250423053,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768250423057,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

{"level":30,"time":1768250423069,"env":"test","msg":"DB: initialized flag set."}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

stderr | tests/integration/auth.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: column "loop_config" of relation "loop_group_subquestions" already exists
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 153,
  severity: 'ERROR',
  code: '42701',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'tablecmds.c',
  line: '7478',
  routine: 'check_for_column_name_collision'
}

{"level":30,"time":1768250425318,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250425319,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth.routes.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w11_07df7ad9

 [32mÎ“Â£Ã´[39m tests/integration/auth.routes.test.ts [2m([22m[2m41 tests[22m[2m)[22m[33m 11049[2mms[22m[39m
stderr | tests/integration/auth/oauth2.client-credentials.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: column "loop_config" of relation "loop_group_subquestions" already exists
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 153,
  severity: 'ERROR',
  code: '42701',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'tablecmds.c',
  line: '7478',
  routine: 'check_for_column_name_collision'
}

{"level":50,"time":1768250431180,"env":"test","status":401,"statusText":"Unauthorized","error":"Invalid client credentials","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token request failed"}
{"level":50,"time":1768250431180,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768250431181,"env":"test","data":{"token_type":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768250431181,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768250431182,"env":"test","data":{"access_token":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","expires_in":3600},"msg":"Invalid OAuth2 token response"}
{"level":50,"time":1768250431182,"env":"test","error":"Invalid OAuth2 token response: missing access_token or token_type","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768250431183,"env":"test","error":"Network error: ECONNREFUSED","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768250431287,"env":"test","error":"Invalid credentials","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":50,"time":1768250431288,"env":"test","error":"ECONNREFUSED","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768250431290,"env":"test","status":400,"statusText":"Bad Request","error":"Invalid grant_type","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token request failed"}
{"level":50,"time":1768250431290,"env":"test","error":"OAuth2 token request failed: 400 Bad Request","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768250431291,"env":"test","status":401,"statusText":"Unauthorized","error":"Client authentication failed","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token request failed"}
{"level":50,"time":1768250431291,"env":"test","error":"OAuth2 token request failed: 401 Unauthorized","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768250431291,"env":"test","status":403,"statusText":"Forbidden","error":"Access denied","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token request failed"}
{"level":50,"time":1768250431291,"env":"test","error":"OAuth2 token request failed: 403 Forbidden","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768250431292,"env":"test","status":500,"statusText":"Internal Server Error","error":"Server error","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token request failed"}
{"level":50,"time":1768250431292,"env":"test","error":"OAuth2 token request failed: 500 Internal Server Error","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768250431292,"env":"test","error":"Unexpected token in JSON","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":50,"time":1768250431293,"env":"test","error":"Request timeout","tokenUrl":"Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³Î“Ã‡Ã³","msg":"OAuth2 token fetch error"}
{"level":30,"time":1768250431294,"env":"test","msg":"DB: closing pool..."}
{"level":30,"time":1768250431295,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/oauth2.client-credentials.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w10_af611100

 [32mÎ“Â£Ã´[39m tests/integration/auth/oauth2.client-credentials.test.ts [2m([22m[2m29 tests[22m[2m)[22m[33m 16861[2mms[22m[39m
stderr | tests/integration/auth/oauth2.callback.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: column "loop_config" of relation "loop_group_subquestions" already exists
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 153,
  severity: 'ERROR',
  code: '42701',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'tablecmds.c',
  line: '7478',
  routine: 'check_for_column_name_collision'
}

{"level":30,"time":1768250438056,"env":"test","connectionId":"f802497a-d71e-4bd3-a167-7a4d72054c52","projectId":"36beb8cc-a26d-4554-a00c-c524454ed59b","name":"Test OAuth2 Connection","type":"oauth2_3leg","msg":"Connection created:"}
{"level":30,"time":1768250439135,"env":"test","connectionId":"f0a53ba8-2796-40f8-9d91-35ff1b9fb61d","projectId":"36beb8cc-a26d-4554-a00c-c524454ed59b","name":"Status Test Connection","type":"oauth2_3leg","msg":"Connection created:"}
{"level":30,"time":1768250439844,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250439844,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/oauth2.callback.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w9_e7437d43

 [32mÎ“Â£Ã´[39m tests/integration/auth/oauth2.callback.test.ts [2m([22m[2m16 tests[22m[2m)[22m[33m 23702[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should initiate OAuth2 3-legged flow and generate authorization URL [33m 328[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should track OAuth2 connection status [33m 358[2mms[22m[39m
stderr | tests/integration/auth/oauth2.google.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: column "loop_config" of relation "loop_group_subquestions" already exists
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 153,
  severity: 'ERROR',
  code: '42701',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'tablecmds.c',
  line: '7478',
  routine: 'check_for_column_name_collision'
}

{"level":30,"time":1768250444076,"env":"test","module":"auth","email":"testuser@example.com","msg":"OAuth2 login successful"}
{"level":50,"time":1768250444309,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:165:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
{"level":50,"time":1768250444310,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token","stack":"Error: Invalid token\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:165:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google authentication failed"}
{"level":40,"time":1768250444384,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768250444384,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:89:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:155:23"},"msg":"Google token verification failed"}
{"level":50,"time":1768250444384,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:89:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)\n    at C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:155:23"},"msg":"Google authentication failed"}
{"level":30,"time":1768250444796,"env":"test","module":"auth","email":"existing@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1768250445210,"env":"test","module":"auth","email":"refresh@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1768250445609,"env":"test","module":"auth","email":"idtoken@example.com","msg":"OAuth2 login successful"}
{"level":30,"time":1768250446010,"env":"test","module":"auth","email":"minimal@example.com","msg":"OAuth2 login successful"}
{"level":50,"time":1768250446106,"env":"test","module":"auth","err":{"type":"Error","message":"Token verification failed","stack":"Error: Token verification failed\n    at C:/Users/scoot/poll/VaultLogic/tests/integration/auth/oauth2.google.test.ts:425:9\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:145:11\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:915:26\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1243:20\n    at new Promise (<anonymous>)\n    at runWithTimeout (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1209:10)\n    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:37\n    at Traces.$ (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/traces.U4xDYhzZ.js:115:27)\n    at trace (file:///C:/Users/scoot/poll/VaultLogic/node_modules/vitest/dist/chunks/test.B8ej_ZHS.js:239:21)\n    at runTest (file:///C:/Users/scoot/poll/VaultLogic/node_modules/@vitest/runner/dist/index.js:1653:12)"},"msg":"Google token verification failed"}
{"level":40,"time":1768250446160,"env":"test","module":"auth","email":"unverified@example.com","msg":"Email not verified by Google"}
{"level":50,"time":1768250446160,"env":"test","module":"auth","err":{"type":"Error","message":"Email not verified by Google","stack":"Error: Email not verified by Google\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:89:13)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
{"level":50,"time":1768250446208,"env":"test","module":"auth","err":{"type":"Error","message":"Invalid token payload","stack":"Error: Invalid token payload\n    at verifyGoogleToken (C:/Users/scoot/poll/VaultLogic/server/googleAuth.ts:85:25)\n    at processTicksAndRejections (node:internal/process/task_queues:103:5)"},"msg":"Google token verification failed"}
{"level":30,"time":1768250446269,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250446270,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/oauth2.google.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w8_bee5626c

 [32mÎ“Â£Ã´[39m tests/integration/auth/oauth2.google.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 29805[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should successfully authenticate with valid Google ID token [33m 543[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should update existing user on subsequent logins [33m 461[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should create refresh token record in database [33m 415[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should support both "token" and "idToken" fields [33m 349[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle missing profile information gracefully [33m 350[2mms[22m[39m
stderr | tests/integration/auth.routes.real.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: column "loop_config" of relation "loop_group_subquestions" already exists
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 153,
  severity: 'ERROR',
  code: '42701',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'tablecmds.c',
  line: '7478',
  routine: 'check_for_column_name_collision'
}

{"level":30,"time":1768250450199,"env":"test","module":"user-credentials-repository","userId":"6ed1a16b-23de-46ca-bb94-91697e7d29db","msg":"User credentials created"}
{"level":30,"time":1768250450299,"env":"test","module":"email-queue","jobId":"fec7d49c-20a2-4a04-a20f-aeb678797ada","to":"test-1768250449808-g35xen@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250450347,"env":"test","module":"auth-routes","userId":"6ed1a16b-23de-46ca-bb94-91697e7d29db","email":"test-1768250449808-g35xen@example.com","msg":"User registered"}
{"level":30,"time":1768250452998,"env":"test","module":"user-credentials-repository","userId":"1323aa11-5ada-4ca0-b639-a43343e09b75","msg":"User credentials created"}
{"level":30,"time":1768250453098,"env":"test","module":"email-queue","jobId":"42de57ec-ddde-427a-a9f6-b3589e697a74","to":"test-1768250452637-ndqlxi@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250453151,"env":"test","module":"auth-routes","userId":"1323aa11-5ada-4ca0-b639-a43343e09b75","email":"test-1768250452637-ndqlxi@example.com","msg":"User registered"}
{"level":30,"time":1768250454312,"env":"test","module":"user-credentials-repository","userId":"782c9140-a725-48dc-b6a4-818a5ea1952b","msg":"User credentials created"}
{"level":30,"time":1768250454416,"env":"test","module":"email-queue","jobId":"0c4faecf-a19a-4eb1-a61a-fe2ee727adca","to":"test-1768250453951-77e9t7@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250454467,"env":"test","module":"auth-routes","userId":"782c9140-a725-48dc-b6a4-818a5ea1952b","email":"test-1768250453951-77e9t7@example.com","msg":"User registered"}
stderr | tests/integration/auth.flows.real.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: column "loop_config" of relation "loop_group_subquestions" already exists
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 153,
  severity: 'ERROR',
  code: '42701',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'tablecmds.c',
  line: '7478',
  routine: 'check_for_column_name_collision'
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould login with valid credentials
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250456044,"env":"test","module":"auth-routes","userId":"32c640a9da7c4a4579a6c7c732014efd","msg":"User logged in successfully"}
{"level":30,"time":1768250456096,"env":"test","module":"audit-log-service","userId":"32c640a9da7c4a4579a6c7c732014efd","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250456347,"env":"test","module":"user-credentials-repository","userId":"936b53b3-aa19-43ea-815d-b74a02d1e62c","msg":"User credentials created"}
{"level":30,"time":1768250456450,"env":"test","module":"email-queue","jobId":"1e8e3167-b7fb-4e75-b1d4-c4492416e50b","to":"test-1768250455957-3ok38kb@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250456512,"env":"test","module":"auth-routes","userId":"936b53b3-aa19-43ea-815d-b74a02d1e62c","email":"test-1768250455957-3ok38kb@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mComplete Registration Î“Ã¥Ã† Login Flow[2m > [22m[2mshould complete registration, verify email, then login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250456672,"env":"test","module":"auth-routes","userId":"936b53b3-aa19-43ea-815d-b74a02d1e62c","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250456772,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Complete Registration Î“Ã¥Ã† Login Flow > should complete registration, verify email, then login
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for invalid password
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250457339,"env":"test","module":"auth-routes","userId":"76073d8a2d58936fe5f66f599dcb9211","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250457435,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should return 401 for invalid password
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250457935,"env":"test","module":"auth-routes","email":"test-1768250457192-89m1x@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":50,"time":1768250458038,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250458193,"env":"test","module":"auth-routes","userId":"d9d72e6af032dd6b5a527b7c0022adaf","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 401 for non-existent user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250458250,"env":"test","module":"auth-routes","email":"nonexistent@example.com","msg":"DEBUG: ValidateCredentials - User not found"}
{"level":50,"time":1768250458294,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250458343,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should return 401 for non-existent user
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:51:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250458446,"env":"test","module":"auth-routes","userId":"d9d72e6af032dd6b5a527b7c0022adaf","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250458544,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250458690,"env":"test","module":"auth-routes","userId":"d9d72e6af032dd6b5a527b7c0022adaf","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250458786,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250458939,"env":"test","module":"auth-routes","userId":"d9d72e6af032dd6b5a527b7c0022adaf","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250459043,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould lock account after 5 failed attempts, then unlock after waiting
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250459203,"env":"test","module":"auth-routes","userId":"d9d72e6af032dd6b5a527b7c0022adaf","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250459303,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250459454,"env":"test","module":"user-credentials-repository","userId":"c2500acc-a2d5-4bf2-a4c0-ccc1758533fd","msg":"User credentials created"}
{"level":30,"time":1768250459547,"env":"test","module":"email-queue","jobId":"83dcb2c4-59fc-46c4-b892-c40dfef6d7b6","to":"test-1768250459079-ay97wv@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250459606,"env":"test","module":"auth-routes","userId":"c2500acc-a2d5-4bf2-a4c0-ccc1758533fd","email":"test-1768250459079-ay97wv@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return 403 for unverified email
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250459752,"env":"test","module":"auth-routes","userId":"c2500acc-a2d5-4bf2-a4c0-ccc1758533fd","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250459846,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should return 403 for unverified email
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250460427,"env":"test","module":"auth-routes","email":"test-1768250459692-rvgi9@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":50,"time":1768250460527,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should record all login attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250460678,"env":"test","module":"auth-routes","userId":"60776e8117e38211f95fce5ad7a7789d","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250460780,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should record all login attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mAccount Lockout Flow[2m > [22m[2mshould record all login attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

stderr | tests/integration/auth/oauth2.token-refresh.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: column "loop_config" of relation "loop_group_subquestions" already exists
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 153,
  severity: 'ERROR',
  code: '42701',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'tablecmds.c',
  line: '7478',
  routine: 'check_for_column_name_collision'
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould record failed login attempt
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250461555,"env":"test","module":"auth-routes","userId":"60776e8117e38211f95fce5ad7a7789d","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250461661,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should record all login attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250461904,"env":"test","module":"auth-routes","email":"test-1768250460595-uoflcg@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":50,"time":1768250461998,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should record failed login attempt
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250462105,"env":"test","module":"user-credentials-repository","userId":"EhzK1DI-ei3rPtPpYf-lr","msg":"User credentials created"}
{"level":30,"time":1768250462180,"env":"test","module":"auth-service","tokenHash":"0925d35757180c21996a579220ecc321ea8e4f538619bec598f2f5aa12dbbf91","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould complete MFA setup and login with TOTP
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250462618,"env":"test","module":"auth-routes","userId":"7b9e691b7b3987a2b599ae010406429b","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250462725,"env":"test","module":"user-credentials-repository","userId":"73LL54beHIzm-jS1dwbYZ","msg":"User credentials created"}
{"level":50,"time":1768250462731,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > MFA Enrollment and Login Flow > should complete MFA setup and login with TOTP
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250462735,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250462784,"env":"test","module":"auth-service","tokenHash":"c5d8affcfdefadab5d385670190f426de25676e2a72a167bcf4b617dae91ee59","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return requiresMfa=true for MFA-enabled users
[22m[39m[TEST UTILS] MFA Secret verified for b74958c580d97cd1ab7fea0d77d79810

{"level":30,"time":1768250463365,"env":"test","module":"user-credentials-repository","userId":"uoshn_d7quS0d4RDn4thE","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould return requiresMfa=true for MFA-enabled users
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mMFA Enrollment and Login Flow[2m > [22m[2mshould login with backup code when TOTP unavailable
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250463670,"env":"test","module":"auth-routes","userId":"b74958c580d97cd1ab7fea0d77d79810","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250463735,"env":"test","module":"user-credentials-repository","userId":"-FKkpqaIuAiemIdL5EiAU","msg":"User credentials created"}
{"level":50,"time":1768250463761,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should return requiresMfa=true for MFA-enabled users
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250463788,"env":"test","module":"auth-service","tokenHash":"2fe6f7ff0fa9bd1ee1eb2b4de4567a52a13546270f31f9607e884393806b0e0c","plainTokenLen":19,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250463840,"env":"test","module":"auth-service","tokenHash":"2fe6f7ff0fa9bd1ee1eb2b4de4567a52a13546270f31f9607e884393806b0e0c","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768250463888,"env":"test","module":"auth-service","allTokensCount":2,"sampleToken":"35fb773a4388c2e5fb159d413b82a4765acb58e17c0fbde050d65fc88c8e96bc","msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768250464002,"env":"test","module":"auth-routes","userId":"e6ca9fefb23f9086555ed03a63fd7be7","msg":"User logged in successfully"}
{"level":30,"time":1768250464053,"env":"test","module":"audit-log-service","userId":"e6ca9fefb23f9086555ed03a63fd7be7","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250464206,"env":"test","module":"user-credentials-repository","userId":"odfJydnEAZ5EoNblu0wH3","msg":"User credentials created"}
{"level":30,"time":1768250464307,"env":"test","module":"auth-service","tokenHash":"719d4f34fd9de961e8180db389d381f3f2fb25ec3f7287005acb16280bd0a506","plainTokenLen":17,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250464355,"env":"test","module":"auth-service","tokenHash":"719d4f34fd9de961e8180db389d381f3f2fb25ec3f7287005acb16280bd0a506","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768250464410,"env":"test","module":"auth-service","allTokensCount":2,"sampleToken":"ad4f6ccb3d46d8c6d1bfaa8491ae61c13b8d681d1b80857bdd16faaa4a37fe6a","msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768250464492,"env":"test","module":"mfa-service","userId":"e6ca9fefb23f9086555ed03a63fd7be7","count":10,"msg":"Stored backup codes"}
{"level":30,"time":1768250464492,"env":"test","module":"mfa-service","userId":"e6ca9fefb23f9086555ed03a63fd7be7","msg":"Generated TOTP secret"}
{"level":30,"time":1768250464492,"env":"test","module":"auth-routes","userId":"e6ca9fefb23f9086555ed03a63fd7be7","msg":"MFA setup initiated"}
{"level":30,"time":1768250464730,"env":"test","module":"user-credentials-repository","userId":"4upies659CGGcSJRvF4Z-","msg":"User credentials created"}
{"level":30,"time":1768250464840,"env":"test","module":"auth-service","tokenHash":"c307c9e7eb239613aa951a9445a92758c54c45b9b1805d752cb458bd13bf7154","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768250464887,"env":"test","module":"auth-service","userId":"4upies659CGGcSJRvF4Z-","tokenHash":"c307c9e7eb239613aa951a9445a92758c54c45b9b1805d752cb458bd13bf7154","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":50,"time":1768250465019,"env":"test","module":"auth-routes","userId":"6cfc16b13a05b18202d5afffc4c5cae7","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250465113,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250465254,"env":"test","module":"auth-routes","userId":"6cfc16b13a05b18202d5afffc4c5cae7","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250465262,"env":"test","module":"user-credentials-repository","userId":"BcH00QrXcsoHJjVC_FooR","msg":"User credentials created"}
{"level":50,"time":1768250465357,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250465388,"env":"test","module":"auth-service","tokenHash":"79ff81358e36292ee1c15efcfd83396a04a23cde913e2b0dca4932d6106b258d","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250465436,"env":"test","module":"auth-service","tokenHash":"79ff81358e36292ee1c15efcfd83396a04a23cde913e2b0dca4932d6106b258d","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768250465491,"env":"test","module":"auth-service","allTokensCount":0,"msg":"DEBUG: Tokens in DB"}
{"level":50,"time":1768250465505,"env":"test","module":"auth-routes","userId":"6cfc16b13a05b18202d5afffc4c5cae7","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250465562,"env":"test","module":"email-queue","jobId":"88ed2ee3-6386-4af7-86cc-ef97e4afb1ab","to":"test-1768250464994-pgcgml@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250465562,"env":"test","module":"auth-service","email":"test-1768250464994-pgcgml@example.com","msg":"Password reset email sent"}
{"level":50,"time":1768250465602,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250465752,"env":"test","module":"auth-routes","userId":"6cfc16b13a05b18202d5afffc4c5cae7","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250465807,"env":"test","module":"user-credentials-repository","userId":"EdLbsrV5D_K7cuKkV3cio","msg":"User credentials created"}
{"level":50,"time":1768250465851,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250465865,"env":"test","module":"email-queue","jobId":"4d96da76-c695-435e-802b-827e35327873","to":"test-1768250464994-pgcgml@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250465865,"env":"test","module":"auth-service","email":"test-1768250464994-pgcgml@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768250465867,"env":"test","module":"auth-service","tokenHash":"831046786ef81ba90ecb5f518396506d7ed178bcd5275ae7f48882bc7e5f86a7","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":50,"time":1768250466000,"env":"test","module":"auth-routes","userId":"6cfc16b13a05b18202d5afffc4c5cae7","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":40,"time":1768250466194,"env":"test","module":"account-lockout","userId":"6cfc16b13a05b18202d5afffc4c5cae7","email":"test-1768250464518-r76gii@example.com","lockedUntil":"2026-01-12T20:56:06.141Z","msg":"Account locked due to too many failed attempts"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250466194,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/login[2m > [22m[2mshould lock account after 5 failed attempts
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250466245,"env":"test","module":"user-credentials-repository","userId":"e2912f1aba2c4dc42ea83a43b2a15123","msg":"User password updated"}
{"level":40,"time":1768250466292,"env":"test","module":"auth-routes","userId":"6cfc16b13a05b18202d5afffc4c5cae7","email":"test-1768250464518-r76gii@example.com","msg":"Login blocked: account locked"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should lock account after 5 failed attempts
Login Failed DEBUG: AccountLockedError: Account is locked until 2026-01-12T20:56:06.141Z
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:58:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_005',
  statusCode: 423,
  isOperational: true,
  lockedUntil: 2026-01-12T20:56:06.141Z,
  remainingMinutes: 15
}

{"level":50,"time":1768250466293,"env":"test","module":"auth-routes","error":{"name":"AccountLockedError","code":"AUTH_005","statusCode":423,"isOperational":true,"lockedUntil":"2026-01-12T20:56:06.141Z","remainingMinutes":15},"msg":"Login failed"}
{"level":30,"time":1768250466392,"env":"test","module":"audit-log-service","userId":"e2912f1aba2c4dc42ea83a43b2a15123","eventType":"password_reset","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mPassword Reset Flow[2m > [22m[2mshould complete full password reset flow
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250466472,"env":"test","module":"user-credentials-repository","userId":"vdsc9RBp24ojKvaSDYWcp","msg":"User credentials created"}
{"level":30,"time":1768250466534,"env":"test","module":"auth-service","tokenHash":"ba84ae431a2da864f59994b6e96a6e7951cf457f369355408a0461f0127b5153","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250466535,"env":"test","module":"auth-service","tokenHash":"ba84ae431a2da864f59994b6e96a6e7951cf457f369355408a0461f0127b5153","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250466586,"env":"test","module":"auth-service","tokenHash":"ba84ae431a2da864f59994b6e96a6e7951cf457f369355408a0461f0127b5153","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768250466633,"env":"test","module":"auth-service","allTokensCount":0,"msg":"DEBUG: Tokens in DB"}
{"level":50,"time":1768250466755,"env":"test","module":"auth-routes","email":"test-1768250464994-pgcgml@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":50,"time":1768250466852,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Password Reset Flow > should complete full password reset flow
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mPassword Reset Flow[2m > [22m[2mshould complete full password reset flow
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768250466915,"env":"test","module":"auth-service","tokenHash":"ba84ae431a2da864f59994b6e96a6e7951cf457f369355408a0461f0127b5153","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768250466961,"env":"test","module":"auth-service","allTokensCount":0,"msg":"DEBUG: Tokens in DB"}
{"level":50,"time":1768250467000,"env":"test","module":"auth-routes","userId":"e2912f1aba2c4dc42ea83a43b2a15123","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250467104,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Password Reset Flow > should complete full password reset flow
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/oauth2.sessions.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: column "loop_config" of relation "loop_group_subquestions" already exists
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 153,
  severity: 'ERROR',
  code: '42701',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'tablecmds.c',
  line: '7478',
  routine: 'check_for_column_name_collision'
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/logout[2m > [22m[2mshould logout and clear refresh token cookie
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mPassword Reset Flow[2m > [22m[2mshould invalidate all sessions after password reset
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250467907,"env":"test","module":"user-credentials-repository","userId":"sTTce5ygKLsbS6BWXtGEn","msg":"User credentials created"}
{"level":30,"time":1768250467962,"env":"test","module":"auth-service","tokenHash":"994c6e27d5d30954853557eeaf623840d6e807bb3f33bc12d25c55753db66722","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250468208,"env":"test","module":"auth-routes","userId":"70bcee7aefc76c5117ac76e1b9042ea0","msg":"User logged in successfully"}
{"level":30,"time":1768250468256,"env":"test","module":"audit-log-service","userId":"70bcee7aefc76c5117ac76e1b9042ea0","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250468283,"env":"test","module":"user-credentials-repository","userId":"uoLm2l9_HrSyS5teJWK3b","msg":"User credentials created"}
{"level":30,"time":1768250468373,"env":"test","module":"auth-routes","userId":"37f6debacc69a48c15fcff86cd720002","msg":"User logged in successfully"}
{"level":30,"time":1768250468429,"env":"test","module":"audit-log-service","userId":"37f6debacc69a48c15fcff86cd720002","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250468468,"env":"test","module":"user-credentials-repository","userId":"MNCSiI_Rb8TIh3W7Yn-kk","msg":"User credentials created"}
{"level":30,"time":1768250468479,"env":"test","module":"auth-routes","userId":"uoLm2l9_HrSyS5teJWK3b","sessionCount":2,"msg":"Listed active sessions"}
{"level":30,"time":1768250468520,"env":"test","module":"auth-service","tokenHash":"04788b96dbb7ab6467ecddeff81362e98d573aefd32d4b0ad5ca6e2aa9064cf6","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250468616,"env":"test","module":"auth-service","userId":"MNCSiI_Rb8TIh3W7Yn-kk","tokenHash":"04788b96dbb7ab6467ecddeff81362e98d573aefd32d4b0ad5ca6e2aa9064cf6","msg":"Security: REUSED REFRESH TOKEN DETECTED (Concurrent). Revoking all sessions."}
{"level":30,"time":1768250468631,"env":"test","module":"email-queue","jobId":"a6aa25fc-9d23-4057-9cf6-a1e53787a077","to":"test-1768250467530-xxivqd@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250468631,"env":"test","module":"auth-service","email":"test-1768250467530-xxivqd@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768250468813,"env":"test","module":"user-credentials-repository","userId":"X7dIM7VXtNQpgJp566ULi","msg":"User credentials created"}
{"level":30,"time":1768250468919,"env":"test","module":"auth-routes","userId":"X7dIM7VXtNQpgJp566ULi","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768250468974,"env":"test","module":"user-credentials-repository","userId":"c0ZsPJrdG2-Sb_jWFKmiY","msg":"User credentials created"}
{"level":50,"time":1768250468996,"env":"test","module":"user-credentials-repository","error":{},"userId":"37f6debacc69a48c15fcff86cd720002","msg":"Failed to update user password"}
{"level":50,"time":1768250468996,"env":"test","module":"auth-routes","error":{},"msg":"Reset password error"}
{"level":30,"time":1768250469023,"env":"test","module":"auth-service","tokenHash":"76f85c23aaa7a38ea7b0950d2d5216c0b8b20b214b57038456d602d34d83c5da","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250469237,"env":"test","module":"user-credentials-repository","userId":"oUdokO642OpU7PbALnUvR","msg":"User credentials created"}
{"level":30,"time":1768250469338,"env":"test","module":"auth-routes","userId":"oUdokO642OpU7PbALnUvR","sessionCount":0,"msg":"Listed active sessions"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/refresh-token[2m > [22m[2mshould refresh access token with valid refresh token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250469521,"env":"test","module":"user-credentials-repository","userId":"83vnE8QH4bDJ_rGuBjnDw","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts[2m > [22m[2mOAuth2 Token Refresh Flow[2m > [22m[2mRefresh Token Lifecycle[2m > [22m[2mshould create refresh token on login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250469655,"env":"test","module":"user-credentials-repository","userId":"SBtwGEWdvT0j6EWxUPyNA","msg":"User credentials created"}
{"level":50,"time":1768250469715,"env":"test","module":"auth-routes","userId":"83vnE8QH4bDJ_rGuBjnDw","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250469755,"env":"test","module":"auth-routes","userId":"SBtwGEWdvT0j6EWxUPyNA","sessionCount":0,"msg":"Listed active sessions"}
{"level":50,"time":1768250469816,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > Refresh Token Lifecycle > should create refresh token on login
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250469897,"env":"test","module":"auth-routes","userId":"fc5105b1d48966ecac4c8a30a95dee4b","msg":"User logged in successfully"}
{"level":30,"time":1768250469948,"env":"test","module":"audit-log-service","userId":"fc5105b1d48966ecac4c8a30a95dee4b","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250469952,"env":"test","module":"auth-service","tokenHash":"685b91f11f81af36d105e776adba28462e785cd30fd0fe7d7f98b00d9724b30e","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould rotate refresh token on each use
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250470073,"env":"test","module":"user-credentials-repository","userId":"s39_Z2QJyQwDbMfo309K0","msg":"User credentials created"}
{"level":30,"time":1768250470126,"env":"test","module":"user-credentials-repository","userId":"WY_1cKVV58iSLjo89gQ1c","msg":"User credentials created"}
{"level":30,"time":1768250470230,"env":"test","module":"auth-routes","userId":"s39_Z2QJyQwDbMfo309K0","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768250470427,"env":"test","module":"auth-routes","userId":"bd589778f795f25aa4cfdc8c582b3f89","msg":"User logged in successfully"}
{"level":30,"time":1768250470479,"env":"test","module":"audit-log-service","userId":"bd589778f795f25aa4cfdc8c582b3f89","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250470482,"env":"test","module":"auth-service","tokenHash":"271e72ad76deb6aed7cce894d0359b9fdb4d1c8f2252b1e4c50eafedec64d04c","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250470532,"env":"test","module":"auth-service","tokenHash":"271e72ad76deb6aed7cce894d0359b9fdb4d1c8f2252b1e4c50eafedec64d04c","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768250470552,"env":"test","module":"user-credentials-repository","userId":"GBliElNXNw5zqzVa7s0Hl","msg":"User credentials created"}
{"level":30,"time":1768250470583,"env":"test","module":"auth-service","allTokensCount":0,"msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768250470593,"env":"test","module":"user-credentials-repository","userId":"Hne2nd0_rf7GX3Z3L8siV","msg":"User credentials created"}
{"level":30,"time":1768250470654,"env":"test","module":"auth-routes","userId":"GBliElNXNw5zqzVa7s0Hl","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768250470965,"env":"test","module":"user-credentials-repository","userId":"RGPuVaCzYxjspFml9dLUw","msg":"User credentials created"}
{"level":30,"time":1768250470979,"env":"test","module":"user-credentials-repository","userId":"kLg9yth9EovXeLcK8yz_0","msg":"User credentials created"}
{"level":50,"time":1768250470982,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250471318,"env":"test","module":"user-credentials-repository","userId":"Wza7Cw_dAorsJiQRQAoJl","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould detect and prevent refresh token reuse (token theft)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250471482,"env":"test","module":"user-credentials-repository","userId":"e-5QMaqaFiz1_vcN7usjp","msg":"User credentials created"}
{"level":50,"time":1768250471497,"env":"test","module":"auth-routes","userId":"6c06826e681d1d3df7b937d614efe3d8","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250471520,"env":"test","module":"auth-routes","userId":"Wza7Cw_dAorsJiQRQAoJl","sessionId":"c0fd9f00-2595-4bff-8b74-c40c031b936f","msg":"Session revoked"}
{"level":50,"time":1768250471593,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Token Refresh Flow > should detect and prevent refresh token reuse (token theft)
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250471894,"env":"test","module":"user-credentials-repository","userId":"DvmyBouWG4pdOha5tco0O","msg":"User credentials created"}
{"level":30,"time":1768250472027,"env":"test","module":"user-credentials-repository","userId":"wC85Ytx2tlYlDMhA4l-3D","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/refresh-token[2m > [22m[2mshould rotate refresh token after use
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250472215,"env":"test","module":"user-credentials-repository","userId":"wi4c3F_UtUWsjRSBQ69Md","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould list all active sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250472506,"env":"test","module":"auth-routes","userId":"df89bdce9ed8f5beabd94c1750d4823f","msg":"User logged in successfully"}
{"level":30,"time":1768250472552,"env":"test","module":"audit-log-service","userId":"df89bdce9ed8f5beabd94c1750d4823f","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250472555,"env":"test","module":"auth-service","tokenHash":"97f9662a68b4c45a10601dec4d55793c217cdcde4d2002591305e408fa46a87f","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250472685,"env":"test","module":"user-credentials-repository","userId":"YoUF8YBHFSI22My7iI-kn","msg":"User credentials created"}
{"level":30,"time":1768250472752,"env":"test","module":"auth-service","tokenHash":"97f9662a68b4c45a10601dec4d55793c217cdcde4d2002591305e408fa46a87f","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250472804,"env":"test","module":"auth-service","userId":"df89bdce9ed8f5beabd94c1750d4823f","tokenHash":"97f9662a68b4c45a10601dec4d55793c217cdcde4d2002591305e408fa46a87f","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768250472817,"env":"test","module":"auth-routes","userId":"df731c591306f4e11f8162856b755968","msg":"User logged in successfully"}
{"level":30,"time":1768250472865,"env":"test","module":"audit-log-service","userId":"df731c591306f4e11f8162856b755968","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould list all active sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: column "loop_config" of relation "loop_group_subquestions" already exists
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 153,
  severity: 'ERROR',
  code: '42701',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'tablecmds.c',
  line: '7478',
  routine: 'check_for_column_name_collision'
}

{"level":50,"time":1768250473616,"env":"test","module":"auth-routes","userId":"df731c591306f4e11f8162856b755968","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250473720,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Session Management Flow > should list all active sessions
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250473724,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250473769,"env":"test","module":"user-credentials-repository","userId":"UgX6WEAbAyCRea_TDtcwq","msg":"User credentials created"}
{"level":50,"time":1768250473771,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250473777,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768250473798,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests
[22m[39m[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768250473784,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768250473786,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768250473790,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768250473797,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768250473797,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768250473798,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768250473798,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768250474085,"env":"test","module":"user-credentials-repository","userId":"rhPMPyVMGI9Yg8Uz2WL0S","msg":"User credentials created"}
{"level":30,"time":1768250474257,"env":"test","module":"user-credentials-repository","userId":"46246ff7-26f4-487d-9f28-52e4124ffce5","msg":"User credentials created"}
{"level":30,"time":1768250474354,"env":"test","module":"email-queue","jobId":"8e36cbf1-587d-4f08-a49e-07fba2814d20","to":"test-7YXXJsSZIh4J9dJUMqRs7@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250474409,"env":"test","module":"auth-routes","userId":"46246ff7-26f4-487d-9f28-52e4124ffce5","email":"test-7YXXJsSZIh4J9dJUMqRs7@example.com","msg":"User registered"}
{"level":30,"time":1768250474461,"env":"test","module":"email-queue","jobId":"fbecad59-643c-4313-b921-ba8b975266ec","to":"test-1768250473887-nolh40k@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250474461,"env":"test","module":"auth-service","email":"test-1768250473887-nolh40k@example.com","msg":"Password reset email sent"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250474565,"env":"test","module":"auth-routes","userId":"rhPMPyVMGI9Yg8Uz2WL0S","msg":"All other sessions revoked"}
{"level":30,"time":1768250474615,"env":"test","module":"audit-log-service","userId":"rhPMPyVMGI9Yg8Uz2WL0S","eventType":"all_sessions_revoked","ipAddress":"::ffff:127.0.0.1","hasMetadata":false,"msg":"Security event logged"}
{"level":30,"time":1768250474955,"env":"test","module":"auth-routes","userId":"bd465f6009555017d5ce8fb5692613ba","msg":"User logged in successfully"}
{"level":30,"time":1768250474981,"env":"test","module":"user-credentials-repository","userId":"NZuSRD9D6ckW8fvjChE-V","msg":"User credentials created"}
{"level":30,"time":1768250475006,"env":"test","module":"audit-log-service","userId":"bd465f6009555017d5ce8fb5692613ba","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts[2m > [22m[2mAuth Flows Integration Tests (REAL)[2m > [22m[2mSession Management Flow[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250475067,"env":"test","module":"user-credentials-repository","userId":"639103a5-677f-43f8-8ee1-e0ea8bd7a471","msg":"User credentials created"}
{"level":50,"time":1768250475164,"env":"test","module":"auth-routes","userId":"bd465f6009555017d5ce8fb5692613ba","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250475169,"env":"test","module":"email-queue","jobId":"efbdbe8a-2c84-4c0a-be64-b1ae6a6fbd8a","to":"protected-test-px6lOMFirQojngBD-SCYk@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250475180,"env":"test","module":"auth-routes","userId":"NZuSRD9D6ckW8fvjChE-V","msg":"All other sessions revoked"}
{"level":30,"time":1768250475219,"env":"test","module":"auth-routes","userId":"639103a5-677f-43f8-8ee1-e0ea8bd7a471","email":"protected-test-px6lOMFirQojngBD-SCYk@example.com","msg":"User registered"}
{"level":30,"time":1768250475226,"env":"test","module":"audit-log-service","userId":"NZuSRD9D6ckW8fvjChE-V","eventType":"all_sessions_revoked","ipAddress":"::ffff:127.0.0.1","hasMetadata":false,"msg":"Security event logged"}
{"level":50,"time":1768250475266,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Session Management Flow > should revoke specific session
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250475269,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250475271,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250475271,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould allow access with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250475486,"env":"test","module":"auth-routes","userId":"639103a5-677f-43f8-8ee1-e0ea8bd7a471","msg":"DEBUG: ValidateCredentials - Credentials not found"}
[90mstdout[2m | tests/integration/auth.flows.real.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w4_bceb160f

{"level":50,"time":1768250475590,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250475599,"env":"test","module":"user-credentials-repository","userId":"U5SSHtaiqescgydHsclCx","msg":"User credentials created"}
 [31mÎ“Â¥Â»[39m tests/integration/auth.flows.real.test.ts [2m([22m[2m11 tests[22m[2m | [22m[31m10 failed[39m[2m)[22m[33m 57742[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should complete registration, verify email, then login[39m[33m 1225[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should lock account after 5 failed attempts, then unlock after waiting[39m[33m 2524[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should record all login attempts[39m[33m 2410[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should complete MFA setup and login with TOTP[39m[33m 1020[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should login with backup code when TOTP unavailable[39m[33m 1857[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should complete full password reset flow[39m[33m 2512[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should invalidate all sessions after password reset [33m 2100[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should rotate refresh token on each use[39m[33m 1379[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should detect and prevent refresh token reuse (token theft)[39m[33m 1010[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all active sessions[39m[33m 2131[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific session[39m[33m 1545[2mms[22m[39m
{"level":30,"time":1768250475924,"env":"test","module":"user-credentials-repository","userId":"3gOsY4XdMshDL4ghhrLWF","msg":"User credentials created"}
{"level":50,"time":1768250475927,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250475958,"env":"test","module":"user-credentials-repository","userId":"292eba2e-439e-40d3-98fa-2a063c311fbf","msg":"User credentials created"}
{"level":30,"time":1768250476060,"env":"test","module":"email-queue","jobId":"21228165-5e8d-4bef-8a0e-5c293876ba2a","to":"protected-test-g6DC6KmdMiqqrdjlpjBzP@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250476106,"env":"test","module":"auth-routes","userId":"292eba2e-439e-40d3-98fa-2a063c311fbf","email":"protected-test-g6DC6KmdMiqqrdjlpjBzP@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould reject access without Authorization header
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250476243,"env":"test","module":"user-credentials-repository","userId":"F7xtSh6vFzay9qLEF5DBa","msg":"User credentials created"}
{"level":30,"time":1768250476342,"env":"test","module":"auth-routes","userId":"F7xtSh6vFzay9qLEF5DBa","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Device marked as trusted"}
{"level":50,"time":1768250476356,"env":"test","module":"auth-routes","userId":"292eba2e-439e-40d3-98fa-2a063c311fbf","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250476459,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250476615,"env":"test","module":"email-queue","jobId":"44fb9e20-ca9b-4540-8c64-fd2500fe06bb","to":"test-1768250476054-30qlkh@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250476615,"env":"test","module":"auth-service","email":"test-1768250476054-30qlkh@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768250476723,"env":"test","module":"user-credentials-repository","userId":"qiqVtcY9SoQTn1absAvTb","msg":"User credentials created"}
{"level":30,"time":1768250476831,"env":"test","module":"auth-routes","userId":"qiqVtcY9SoQTn1absAvTb","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Device marked as trusted"}
{"level":30,"time":1768250476838,"env":"test","module":"user-credentials-repository","userId":"9e982c89-750f-4d85-b953-7cc1dbf77c63","msg":"User credentials created"}
{"level":30,"time":1768250476942,"env":"test","module":"email-queue","jobId":"fca23b8e-60f0-4e6d-a04a-8d08fe402100","to":"protected-test-PDazNo-BOAwVxQ0FAPKDz@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250476975,"env":"test","module":"auth-routes","userId":"qiqVtcY9SoQTn1absAvTb","deviceFingerprint":"0c304ba4c86647b5f5daea2958cadcf6d04bf27326f1c319a59264ba7ace843b","msg":"Trusted device expiry updated"}
{"level":30,"time":1768250476984,"env":"test","module":"user-credentials-repository","userId":"e9046118b831416758e8c8112a03c54a","msg":"User password updated"}
{"level":30,"time":1768250476989,"env":"test","module":"auth-routes","userId":"9e982c89-750f-4d85-b953-7cc1dbf77c63","email":"protected-test-PDazNo-BOAwVxQ0FAPKDz@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould reject access with empty Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250477125,"env":"test","module":"audit-log-service","userId":"e9046118b831416758e8c8112a03c54a","eventType":"password_reset","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/reset-password[2m > [22m[2mshould reset password with valid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250477345,"env":"test","module":"user-credentials-repository","userId":"t66M_dG3ndEzbMBAblR-B","msg":"User credentials created"}
{"level":30,"time":1768250477446,"env":"test","module":"auth-routes","userId":"t66M_dG3ndEzbMBAblR-B","deviceCount":2,"msg":"Listed trusted devices"}
{"level":30,"time":1768250477602,"env":"test","module":"auth-routes","userId":"e9046118b831416758e8c8112a03c54a","msg":"User logged in successfully"}
{"level":30,"time":1768250477601,"env":"test","module":"auth-routes","userId":"9e982c89-750f-4d85-b953-7cc1dbf77c63","msg":"User logged in successfully"}
{"level":30,"time":1768250477651,"env":"test","module":"audit-log-service","userId":"e9046118b831416758e8c8112a03c54a","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250477651,"env":"test","module":"audit-log-service","userId":"9e982c89-750f-4d85-b953-7cc1dbf77c63","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/reset-password[2m > [22m[2mshould reset password with valid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250477655,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250477767,"env":"test","module":"user-credentials-repository","userId":"KP5D2354vapVEI2xXi5TN","msg":"User credentials created"}
{"level":30,"time":1768250477868,"env":"test","module":"auth-routes","userId":"KP5D2354vapVEI2xXi5TN","deviceCount":0,"msg":"Listed trusted devices"}
{"level":30,"time":1768250477888,"env":"test","module":"user-credentials-repository","userId":"j8343ZOp9cBOKneTkkYKU","msg":"User credentials created"}
{"level":50,"time":1768250478021,"env":"test","module":"auth-routes","email":"test-1768250476054-30qlkh@example.com","msg":"DEBUG: ValidateCredentials - Password mismatch"}
{"level":30,"time":1768250478026,"env":"test","module":"user-credentials-repository","userId":"6b1d185c-22fa-41d2-aec2-ac33b62fe51d","msg":"User credentials created"}
{"level":50,"time":1768250478111,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/reset-password > should reset password with valid token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:80:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768250478117,"env":"test","module":"email-queue","jobId":"95ea354c-f159-49a5-8907-1b57740bb5f2","to":"protected-test-ucen6oGSQnp56R6JDM9XJ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250478167,"env":"test","module":"auth-routes","userId":"6b1d185c-22fa-41d2-aec2-ac33b62fe51d","email":"protected-test-ucen6oGSQnp56R6JDM9XJ@example.com","msg":"User registered"}
{"level":30,"time":1768250478182,"env":"test","module":"user-credentials-repository","userId":"HRwjDgyuQP3KRl9OUqI3j","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould reject access with malformed Authorization header
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250478339,"env":"test","module":"user-credentials-repository","userId":"cy0jmgROFls6Zepx6J0SE","msg":"User credentials created"}
{"level":30,"time":1768250478392,"env":"test","module":"auth-service","tokenHash":"0e838ea2660af3c544eae8e204500660d5f2bc007da285b479b75cb3e87e25d8","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250478438,"env":"test","module":"auth-service","tokenHash":"0e838ea2660af3c544eae8e204500660d5f2bc007da285b479b75cb3e87e25d8","msg":"Security: Unknown refresh token used (Not Found in DB)"}
{"level":30,"time":1768250478484,"env":"test","module":"auth-service","allTokensCount":0,"msg":"DEBUG: Tokens in DB"}
{"level":30,"time":1768250478605,"env":"test","module":"user-credentials-repository","userId":"4hz7xVOg1WVKUsneXEhEX","msg":"User credentials created"}
{"level":30,"time":1768250478763,"env":"test","module":"auth-routes","userId":"6b1d185c-22fa-41d2-aec2-ac33b62fe51d","msg":"User logged in successfully"}
{"level":30,"time":1768250478796,"env":"test","module":"user-credentials-repository","userId":"YPpw3Fpyf20sr6T0mxihh","msg":"User credentials created"}
{"level":30,"time":1768250478819,"env":"test","module":"audit-log-service","userId":"6b1d185c-22fa-41d2-aec2-ac33b62fe51d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250478823,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250479526,"env":"test","module":"user-credentials-repository","userId":"69_RJGiqJVGzo0PXRZHC_","msg":"User credentials created"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: column "loop_config" of relation "loop_group_subquestions" already exists
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 153,
  severity: 'ERROR',
  code: '42701',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'tablecmds.c',
  line: '7478',
  routine: 'check_for_column_name_collision'
}

{"level":30,"time":1768250479776,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768250479788,"env":"test","module":"user-credentials-repository","userId":"07091c5b-0820-4109-b2e1-ed84b1d22148","msg":"User credentials created"}
{"level":30,"time":1768250479791,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests
[22m[39m[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768250479783,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768250479783,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768250479788,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768250479791,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768250479791,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768250479791,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768250479791,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768250479892,"env":"test","module":"user-credentials-repository","userId":"B7jl7EcB8ntiqpAYpLvGt","msg":"User credentials created"}
{"level":30,"time":1768250479893,"env":"test","module":"email-queue","jobId":"df3ddc15-0a60-4132-86fe-d159b49d3cdf","to":"protected-test-dVQHx3aJwnWYOzacLZY8d@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250479943,"env":"test","module":"auth-routes","userId":"07091c5b-0820-4109-b2e1-ed84b1d22148","email":"protected-test-dVQHx3aJwnWYOzacLZY8d@example.com","msg":"User registered"}
{"level":30,"time":1768250479944,"env":"test","module":"auth-service","tokenHash":"e27d9da58b8a2ed1ca66ce3b1a6e29026cc7e10cf61b6cb63b79ad96a8774d86","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250479951,"env":"test","module":"user-credentials-repository","userId":"IJdA2mIWOoXEp8iONZHxq","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould reject access with wrong token type
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250480222,"env":"test","module":"email-queue","jobId":"0272bf3c-53fb-4b23-a591-5dc9f4bd2bfa","to":"test-1768250479670-9lz7xo@example.com","subject":"Reset Your Password - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250480222,"env":"test","module":"auth-service","email":"test-1768250479670-9lz7xo@example.com","msg":"Password reset email sent"}
{"level":30,"time":1768250480234,"env":"test","module":"user-credentials-repository","userId":"97374d43-a2a5-48d0-abb6-249a36baab74","msg":"User credentials created"}
{"level":30,"time":1768250480335,"env":"test","module":"email-queue","jobId":"29269547-eb43-4c77-9e14-b401caea1f10","to":"test-1CDjIlX0qQ_x4RJ8bMmhv@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250480374,"env":"test","module":"user-credentials-repository","userId":"ZLh4TEeVm-ktpllvM05Ja","msg":"User credentials created"}
{"level":30,"time":1768250480388,"env":"test","module":"auth-routes","userId":"97374d43-a2a5-48d0-abb6-249a36baab74","email":"test-1CDjIlX0qQ_x4RJ8bMmhv@example.com","msg":"User registered"}
{"level":30,"time":1768250480458,"env":"test","module":"user-credentials-repository","userId":"pSb1qti24s1bSikuNq782","msg":"User credentials created"}
{"level":30,"time":1768250480506,"env":"test","module":"auth-service","tokenHash":"02a9ea00b5441c55241f956359255ff26253ef3e45d6cb7382691af5a53f044f","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250480542,"env":"test","module":"auth-routes","userId":"07091c5b-0820-4109-b2e1-ed84b1d22148","msg":"User logged in successfully"}
{"level":30,"time":1768250480575,"env":"test","module":"auth-service","tokenHash":"992596fdc74c6459f2ea8c79ce8101e8d59ec0cb30a2c294f2a25549c0103c75","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250480593,"env":"test","module":"audit-log-service","userId":"07091c5b-0820-4109-b2e1-ed84b1d22148","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768250480596,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768250480596,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768250480668,"env":"test","module":"auth-service","userId":"ZLh4TEeVm-ktpllvM05Ja","tokenHash":"992596fdc74c6459f2ea8c79ce8101e8d59ec0cb30a2c294f2a25549c0103c75","msg":"Security: REUSED REFRESH TOKEN DETECTED (Concurrent). Revoking all sessions."}
{"level":30,"time":1768250480764,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250480764,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768250480960,"env":"test","module":"user-credentials-repository","userId":"d176497f-6e6e-4a1c-bfcc-2360b50d1f21","msg":"User credentials created"}
{"level":30,"time":1768250481016,"env":"test","module":"user-credentials-repository","userId":"5uhQkO-qtZBi8eoCNh-vo","msg":"User credentials created"}
{"level":30,"time":1768250481024,"env":"test","module":"user-credentials-repository","userId":"b6ce711e-89d9-4573-8d38-5b1846357cc5","msg":"User credentials created"}
{"level":30,"time":1768250481057,"env":"test","module":"email-queue","jobId":"4d1dd288-64aa-4a35-b1a3-d1d3b24b565a","to":"protected-test-UHQsfA0dv-ho7jEJyN_Wr@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250481064,"env":"test","module":"auth-service","tokenHash":"f84dc16f59c6b4a81bbf55fd2d5c46a5b3587ddded5b755b9e384e8c865e71fe","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/auth/oauth2.sessions.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w6_5619afbb

{"level":30,"time":1768250481107,"env":"test","module":"auth-routes","userId":"d176497f-6e6e-4a1c-bfcc-2360b50d1f21","email":"protected-test-UHQsfA0dv-ho7jEJyN_Wr@example.com","msg":"User registered"}
{"level":30,"time":1768250481127,"env":"test","module":"email-queue","jobId":"52622933-663a-42ad-832e-853cf0719f13","to":"middleware-test-e4weuB8aQUkTeoy80mGLq@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250481180,"env":"test","module":"auth-routes","userId":"b6ce711e-89d9-4573-8d38-5b1846357cc5","email":"middleware-test-e4weuB8aQUkTeoy80mGLq@example.com","msg":"User registered"}
 [31mÎ“Â¥Â»[39m tests/integration/auth/oauth2.sessions.test.ts [2m([22m[2m25 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 63280[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should list all active sessions for current user [33m 522[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should mark current session as current [33m 435[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return empty array when user has no active sessions [33m 419[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not include expired sessions [33m 417[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not include revoked sessions [33m 475[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should parse device name from user agent [33m 425[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for unauthenticated request [33m 328[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke a specific session [33m 584[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 404 for non-existent session [33m 331[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prevent revoking current session [33m 470[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prevent revoking another user's session [33m 529[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for unauthenticated request [33m 874[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke all sessions except current [33m 892[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke all trusted devices [33m 612[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 400 when no active session found [33m 325[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for unauthenticated request [33m 325[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should mark current device as trusted [33m 463[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should update existing trusted device expiry [33m 631[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should list all trusted devices [33m 424[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should not include revoked devices [33m 423[2mms[22m[39m
[31m         [31mâ”œÃ¹[31m should revoke a trusted device[39m[33m 415[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should return 404 for non-existent device [33m 325[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should track IP address for sessions [33m 1019[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should track user agent for sessions [33m 429[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update lastUsedAt on token refresh[39m[33m 705[2mms[22m[39m
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPOST Protected Routes[2m > [22m[2mshould allow POST with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould allow access with valid JWT Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250481335,"env":"test","module":"auth-routes","userId":"d176497f-6e6e-4a1c-bfcc-2360b50d1f21","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250481379,"env":"test","module":"auth-routes","userId":"b6ce711e-89d9-4573-8d38-5b1846357cc5","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250481434,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should allow POST with valid Bearer token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250481481,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should allow access with valid JWT Bearer token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should allow access with valid JWT Bearer token
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:41:21.484Z'
  }
}

[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mGET /api/auth/me[2m > [22m[2mshould return current user for valid token
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould allow access with valid JWT Bearer token
[22m[39mUser in DB: {
  id: [32m'b6ce711e-89d9-4573-8d38-5b1846357cc5'[39m,
  email: [32m'middleware-test-e4weuB8aQUkTeoy80mGLq@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:41:23.930Z[39m,
  updatedAt: [35m2026-01-12T20:41:23.930Z[39m
}

{"level":30,"time":1768250481565,"env":"test","module":"user-credentials-repository","userId":"x1WrXJUOkNgSLuDRmuuPF","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould allow access with valid JWT Bearer token
[22m[39mCreds in DB: [90mundefined[39m

{"level":30,"time":1768250481612,"env":"test","module":"auth-service","tokenHash":"8ed7a0afa22945e218c70f1ddfe98a5c4684409bb4a15d952baf03aaaee73275","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250481795,"env":"test","module":"user-credentials-repository","userId":"a96dc396-62b4-4f97-b40d-f5b27fa65258","msg":"User credentials created"}
{"level":30,"time":1768250481898,"env":"test","module":"email-queue","jobId":"47c2efb7-5c6d-40e4-92ab-42a798801baf","to":"protected-test--4rv-oxiKKskGoGSMLa0X@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250481946,"env":"test","module":"auth-routes","userId":"a96dc396-62b4-4f97-b40d-f5b27fa65258","email":"protected-test--4rv-oxiKKskGoGSMLa0X@example.com","msg":"User registered"}
{"level":30,"time":1768250481957,"env":"test","module":"auth-routes","userId":"a69460166a23f939ec94c39943f04641","msg":"User logged in successfully"}
{"level":30,"time":1768250481966,"env":"test","module":"user-credentials-repository","userId":"2fc65c7f-0f61-4150-9a90-a56adfd18d9d","msg":"User credentials created"}
{"level":30,"time":1768250482005,"env":"test","module":"audit-log-service","userId":"a69460166a23f939ec94c39943f04641","eventType":"login_success","ipAddress":"::ffff:127.0.0.1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250482040,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250482041,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPOST Protected Routes[2m > [22m[2mshould reject POST without Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250482065,"env":"test","module":"email-queue","jobId":"df351316-b40b-4343-a956-ad70b24501f7","to":"middleware-test-p_-dU3TuyQNybqWrtjeIT@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250482114,"env":"test","module":"auth-routes","userId":"2fc65c7f-0f61-4150-9a90-a56adfd18d9d","email":"middleware-test-p_-dU3TuyQNybqWrtjeIT@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 when no token provided
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/oauth2.token-refresh.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w5_3d0afa22

 [31mÎ“Â¥Â»[39m tests/integration/auth/oauth2.token-refresh.test.ts [2m([22m[2m25 tests[22m[2m | [22m[31m5 failed[39m[2m)[22m[33m 64522[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should refresh access token with valid refresh token [33m 640[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should rotate refresh token after use[39m[33m 638[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 when refresh token is missing [33m 366[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for invalid refresh token [33m 472[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for expired refresh token [33m 522[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for revoked refresh token [33m 535[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 when user is not found [33m 547[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should update refresh token metadata on rotation [33m 658[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle concurrent refresh token requests (token reuse detection) [33m 812[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set secure cookie in production [33m 1187[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set proper cookie attributes[39m[33m 512[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should include user role information in response [33m 548[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should create refresh token on login[39m[33m 610[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke refresh token on logout [33m 463[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle logout without refresh token gracefully [33m 359[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should support multiple active refresh tokens per user [33m 530[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke all user tokens on password reset [33m 542[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should use cryptographically strong random tokens [33m 5862[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should hash refresh tokens before storing in database [33m 454[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent refresh token reuse after rotation[39m[33m 454[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should validate token ownership[39m[33m 1090[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set HttpOnly flag to prevent XSS [33m 568[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set SameSite=Strict to prevent CSRF [33m 553[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set proper cookie path [33m 564[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set appropriate expiry (30 days) [33m 538[2mms[22m[39m
{"level":30,"time":1768250482556,"env":"test","module":"auth-routes","userId":"a96dc396-62b4-4f97-b40d-f5b27fa65258","msg":"User logged in successfully"}
{"level":30,"time":1768250482601,"env":"test","module":"audit-log-service","userId":"a96dc396-62b4-4f97-b40d-f5b27fa65258","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250482604,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250482630,"env":"test","module":"auth-routes","userId":"2fc65c7f-0f61-4150-9a90-a56adfd18d9d","msg":"User logged in successfully"}
{"level":30,"time":1768250482680,"env":"test","module":"audit-log-service","userId":"2fc65c7f-0f61-4150-9a90-a56adfd18d9d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250482684,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768250482870,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250482969,"env":"test","module":"user-credentials-repository","userId":"2f11bd80-430f-4275-a458-f836e8779b19","msg":"User credentials created"}
{"level":30,"time":1768250483052,"env":"test","module":"user-credentials-repository","userId":"eca12203-1b4d-48f6-9830-85e7f24b94ff","msg":"User credentials created"}
{"level":30,"time":1768250483068,"env":"test","module":"email-queue","jobId":"6baa091e-f3e5-4aa4-b571-6aeaedcd9b16","to":"protected-test-7h_84ApO342kGq8a-2Ayd@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250483119,"env":"test","module":"auth-routes","userId":"2f11bd80-430f-4275-a458-f836e8779b19","email":"protected-test-7h_84ApO342kGq8a-2Ayd@example.com","msg":"User registered"}
{"level":30,"time":1768250483146,"env":"test","module":"email-queue","jobId":"f1f99c4a-08a1-4cc6-aa57-972f74f9acde","to":"middleware-test-1JElBxO_MBDxu2KUtbAuD@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250483193,"env":"test","module":"auth-routes","userId":"eca12203-1b4d-48f6-9830-85e7f24b94ff","email":"middleware-test-1JElBxO_MBDxu2KUtbAuD@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPOST Protected Routes[2m > [22m[2mshould reject POST with invalid token
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 with invalid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250483359,"env":"test","module":"auth-routes","userId":"2f11bd80-430f-4275-a458-f836e8779b19","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250483399,"env":"test","module":"auth-routes","userId":"eca12203-1b4d-48f6-9830-85e7f24b94ff","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250483452,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST with invalid token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250483493,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should return 401 with invalid token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should return 401 with invalid token
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:41:23.493Z'
  }
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 with invalid token
[22m[39mUser in DB: {
  id: [32m'eca12203-1b4d-48f6-9830-85e7f24b94ff'[39m,
  email: [32m'middleware-test-1JElBxO_MBDxu2KUtbAuD@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:41:25.962Z[39m,
  updatedAt: [35m2026-01-12T20:41:25.962Z[39m
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 with invalid token
[22m[39mCreds in DB: [90mundefined[39m

{"level":50,"time":1768250483620,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250483815,"env":"test","module":"user-credentials-repository","userId":"b934e81d-c88d-4536-9f8e-686ab63a9574","msg":"User credentials created"}
{"level":30,"time":1768250483910,"env":"test","module":"email-queue","jobId":"83e72f1e-52db-441c-9205-b4f367c89d2d","to":"protected-test-lVTbTUNy2GqwFnAQ9FdT6@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250483955,"env":"test","module":"user-credentials-repository","userId":"53dad316-0ec8-4420-ba7a-0f5b0ba1427a","msg":"User credentials created"}
{"level":30,"time":1768250483959,"env":"test","module":"auth-routes","userId":"b934e81d-c88d-4536-9f8e-686ab63a9574","email":"protected-test-lVTbTUNy2GqwFnAQ9FdT6@example.com","msg":"User registered"}
{"level":30,"time":1768250484060,"env":"test","module":"email-queue","jobId":"68006f5c-7ea8-4d0f-a19c-c5bf41465f04","to":"middleware-test-gNg-3pe7yUM-cA0kpg8QP@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPUT Protected Routes[2m > [22m[2mshould allow PUT with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250484108,"env":"test","module":"auth-routes","userId":"53dad316-0ec8-4420-ba7a-0f5b0ba1427a","email":"middleware-test-gNg-3pe7yUM-cA0kpg8QP@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 with expired token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250484205,"env":"test","module":"auth-routes","userId":"b934e81d-c88d-4536-9f8e-686ab63a9574","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250484303,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should allow PUT with valid Bearer token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768250484311,"env":"test","module":"auth-routes","userId":"53dad316-0ec8-4420-ba7a-0f5b0ba1427a","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":50,"time":1768250484412,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should return 401 with expired token
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should return 401 with expired token
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:41:24.413Z'
  }
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 with expired token
[22m[39mUser in DB: {
  id: [32m'53dad316-0ec8-4420-ba7a-0f5b0ba1427a'[39m,
  email: [32m'middleware-test-gNg-3pe7yUM-cA0kpg8QP@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:41:26.872Z[39m,
  updatedAt: [35m2026-01-12T20:41:26.872Z[39m
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mrequireAuth Middleware[2m > [22m[2mshould return 401 with expired token
[22m[39mCreds in DB: [90mundefined[39m

{"level":30,"time":1768250484667,"env":"test","module":"user-credentials-repository","userId":"eb5c2ef6-bed8-4bbd-9710-339621c471c2","msg":"User credentials created"}
{"level":30,"time":1768250484766,"env":"test","module":"email-queue","jobId":"d2cd44d6-7c41-4c05-a92e-8c3de417d8e2","to":"protected-test-m_4ka4MN-9hzppDy0tCKm@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250484814,"env":"test","module":"auth-routes","userId":"eb5c2ef6-bed8-4bbd-9710-339621c471c2","email":"protected-test-m_4ka4MN-9hzppDy0tCKm@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould complete MFA login with valid TOTP code
[22m[39m[TEST UTILS] MFA Secret verified for 8d610faff23c633329931a3a2e078e4e

{"level":30,"time":1768250484871,"env":"test","module":"user-credentials-repository","userId":"445a5216-b851-4976-afca-79b0e79ca5b1","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPUT Protected Routes[2m > [22m[2mshould reject PUT without Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250484974,"env":"test","module":"email-queue","jobId":"4d5b5249-d789-436b-a1ba-3147f6520930","to":"middleware-test-TBRhIntf5Xyt9eqdxGJLU@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250485665,"env":"test","module":"auth-routes","userId":"eb5c2ef6-bed8-4bbd-9710-339621c471c2","msg":"User logged in successfully"}
{"level":30,"time":1768250485667,"env":"test","module":"auth-routes","userId":"445a5216-b851-4976-afca-79b0e79ca5b1","email":"middleware-test-TBRhIntf5Xyt9eqdxGJLU@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould complete MFA login with valid TOTP code
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250485718,"env":"test","module":"audit-log-service","userId":"eb5c2ef6-bed8-4bbd-9710-339621c471c2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould authenticate with JWT Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250485722,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stderr | tests/integration/auth/session.management.integration.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: column "loop_config" of relation "loop_group_subquestions" already exists
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 153,
  severity: 'ERROR',
  code: '42701',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'tablecmds.c',
  line: '7478',
  routine: 'check_for_column_name_collision'
}

{"level":30,"time":1768250485936,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768250485950,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests
[22m[39m[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768250485942,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768250485942,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768250485946,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768250485950,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768250485950,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768250485950,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768250485950,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768250486098,"env":"test","module":"user-credentials-repository","userId":"5f64155b-d3c2-4d80-9b83-4796a8a30547","msg":"User credentials created"}
{"level":30,"time":1768250486133,"env":"test","module":"auth-routes","userId":"8d610faff23c633329931a3a2e078e4e","msg":"Login requires MFA verification"}
{"level":30,"time":1768250486184,"env":"test","module":"auth-routes","userId":"445a5216-b851-4976-afca-79b0e79ca5b1","msg":"User logged in successfully"}
{"level":30,"time":1768250486194,"env":"test","module":"email-queue","jobId":"e1b784b0-c38a-46c4-afe2-f833883636f3","to":"protected-test-bcabSmOlUGSd8Sk-GoEM4@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250486232,"env":"test","module":"audit-log-service","userId":"445a5216-b851-4976-afca-79b0e79ca5b1","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250486237,"env":"test","module":"mfa-service","userId":"8d610faff23c633329931a3a2e078e4e","msg":"TOTP verification successful"}
{"level":30,"time":1768250486244,"env":"test","module":"auth-routes","userId":"5f64155b-d3c2-4d80-9b83-4796a8a30547","email":"protected-test-bcabSmOlUGSd8Sk-GoEM4@example.com","msg":"User registered"}
{"level":30,"time":1768250486290,"env":"test","module":"auth-routes","userId":"8d610faff23c633329931a3a2e078e4e","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mDELETE Protected Routes[2m > [22m[2mshould allow DELETE with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250486398,"env":"test","module":"user-credentials-repository","userId":"960985ee-4607-4d6c-be8b-c4f26b9de622","msg":"User credentials created"}
{"level":30,"time":1768250486497,"env":"test","module":"email-queue","jobId":"31b63db7-daca-4d45-8307-b742fe37ddd3","to":"test-Uud9zoCLdc6sZ_x9QBFWK@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250486549,"env":"test","module":"auth-routes","userId":"960985ee-4607-4d6c-be8b-c4f26b9de622","email":"test-Uud9zoCLdc6sZ_x9QBFWK@example.com","msg":"User registered"}
{"level":30,"time":1768250486705,"env":"test","module":"user-credentials-repository","userId":"8f353eb0-fa87-402c-9fe9-b9f82d75b704","msg":"User credentials created"}
{"level":30,"time":1768250486801,"env":"test","module":"email-queue","jobId":"bc141982-cc68-47d5-9dd4-4384ed027018","to":"middleware-test-M0wR8ix6vcWfBfmFaQyM_@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250486849,"env":"test","module":"auth-routes","userId":"8f353eb0-fa87-402c-9fe9-b9f82d75b704","email":"middleware-test-M0wR8ix6vcWfBfmFaQyM_@example.com","msg":"User registered"}
{"level":30,"time":1768250486862,"env":"test","module":"auth-routes","userId":"5f64155b-d3c2-4d80-9b83-4796a8a30547","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould authenticate with refresh token cookie (GET only)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250486913,"env":"test","module":"audit-log-service","userId":"5f64155b-d3c2-4d80-9b83-4796a8a30547","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250487075,"env":"test","module":"user-credentials-repository","userId":"9ea69dc6-8880-43c8-9a79-c9246c4ced41","msg":"User credentials created"}
{"level":30,"time":1768250487183,"env":"test","module":"email-queue","jobId":"e94e9ba0-ae73-4152-8c9c-0720fd822a03","to":"session-test-cXVE8LwLMnJ5nS_NyQe6t@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250487235,"env":"test","module":"auth-routes","userId":"9ea69dc6-8880-43c8-9a79-c9246c4ced41","email":"session-test-cXVE8LwLMnJ5nS_NyQe6t@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Creation and Tracking[2m > [22m[2mshould create refresh token on login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250487390,"env":"test","module":"auth-routes","userId":"8f353eb0-fa87-402c-9fe9-b9f82d75b704","msg":"User logged in successfully"}
{"level":30,"time":1768250487442,"env":"test","module":"audit-log-service","userId":"8f353eb0-fa87-402c-9fe9-b9f82d75b704","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250487453,"env":"test","module":"user-credentials-repository","userId":"d6bda9e9-b035-4680-a638-3bf7fe1ebe6a","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts[2m > [22m[2mAuth Routes Integration Tests (REAL)[2m > [22m[2mMFA Routes[2m > [22m[2mPOST /api/auth/mfa/verify-login[2m > [22m[2mshould reject invalid MFA code
[22m[39m[TEST UTILS] MFA Secret verified for 6c4010cdd51ad572d41cff87114c6712

{"level":30,"time":1768250487553,"env":"test","module":"email-queue","jobId":"24b1d3a6-9195-40ed-a778-22536538a99e","to":"protected-test-V0pJmaKW-QtG2Ifg27e2J@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250487600,"env":"test","module":"auth-routes","userId":"d6bda9e9-b035-4680-a638-3bf7fe1ebe6a","email":"protected-test-V0pJmaKW-QtG2Ifg27e2J@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mDELETE Protected Routes[2m > [22m[2mshould reject DELETE without Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250487815,"env":"test","module":"auth-routes","userId":"9ea69dc6-8880-43c8-9a79-c9246c4ced41","msg":"User logged in successfully"}
{"level":30,"time":1768250487870,"env":"test","module":"audit-log-service","userId":"9ea69dc6-8880-43c8-9a79-c9246c4ced41","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768250487907,"env":"test","module":"mfa-service","userId":"6c4010cdd51ad572d41cff87114c6712","msg":"TOTP verification failed"}
{"level":40,"time":1768250487907,"env":"test","module":"auth-routes","userId":"6c4010cdd51ad572d41cff87114c6712","msg":"MFA verification failed during login"}
{"level":30,"time":1768250487965,"env":"test","module":"user-credentials-repository","userId":"15c4e725-366d-4f04-8084-7cc29a7ad40e","msg":"User credentials created"}
{"level":30,"time":1768250488068,"env":"test","module":"email-queue","jobId":"a176b250-1b9a-4abc-8131-8d903d6a63eb","to":"middleware-test-wGSpAnpWDRQFYbeSiHAI5@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250488119,"env":"test","module":"auth-routes","userId":"15c4e725-366d-4f04-8084-7cc29a7ad40e","email":"middleware-test-wGSpAnpWDRQFYbeSiHAI5@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for POST requests (mutation-strict)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250488207,"env":"test","module":"auth-routes","userId":"d6bda9e9-b035-4680-a638-3bf7fe1ebe6a","msg":"User logged in successfully"}
{"level":30,"time":1768250488254,"env":"test","module":"audit-log-service","userId":"d6bda9e9-b035-4680-a638-3bf7fe1ebe6a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250488257,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250488286,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250488286,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768250488291,"env":"test","module":"user-credentials-repository","userId":"f8bac009-fd52-4a6a-b889-ce47d3b8cc91","msg":"User credentials created"}
{"level":50,"time":1768250488324,"env":"test","module":"auth-routes","userId":"15c4e725-366d-4f04-8084-7cc29a7ad40e","msg":"DEBUG: ValidateCredentials - Credentials not found"}
{"level":30,"time":1768250488404,"env":"test","module":"email-queue","jobId":"5065f2d4-9364-4ad5-84b6-53903ff00e47","to":"session-test-82L4OBwnhRNoxjCfKKXCz@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":50,"time":1768250488420,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should reject cookie auth for POST requests (mutation-strict)
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:71:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:302:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should reject cookie auth for POST requests (mutation-strict)
Login Failed! 401 {
  success: false,
  error: {
    code: 'AUTH_004',
    message: 'Invalid credentials',
    details: { errorType: 'InvalidCredentialsError' },
    timestamp: '2026-01-12T20:41:28.420Z'
  }
}

{"level":30,"time":1768250488453,"env":"test","module":"auth-routes","userId":"f8bac009-fd52-4a6a-b889-ce47d3b8cc91","email":"session-test-82L4OBwnhRNoxjCfKKXCz@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for POST requests (mutation-strict)
[22m[39mUser in DB: {
  id: [32m'15c4e725-366d-4f04-8084-7cc29a7ad40e'[39m,
  email: [32m'middleware-test-wGSpAnpWDRQFYbeSiHAI5@example.com'[39m,
  fullName: [32m'Middleware Tester'[39m,
  firstName: [32m'Middleware'[39m,
  lastName: [32m'Tester'[39m,
  profileImageUrl: [1mnull[22m,
  tenantId: [1mnull[22m,
  role: [32m'creator'[39m,
  tenantRole: [1mnull[22m,
  authProvider: [32m'local'[39m,
  defaultMode: [32m'easy'[39m,
  emailVerified: [33mtrue[39m,
  mfaEnabled: [33mfalse[39m,
  lastPasswordChange: [1mnull[22m,
  isPlaceholder: [33mfalse[39m,
  placeholderEmail: [1mnull[22m,
  createdAt: [35m2026-01-12T20:41:30.875Z[39m,
  updatedAt: [35m2026-01-12T20:41:30.875Z[39m
}

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for POST requests (mutation-strict)
[22m[39mCreds in DB: [90mundefined[39m

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Creation and Tracking[2m > [22m[2mshould track device metadata in session
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth.routes.real.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w3_6832ab4f

{"level":30,"time":1768250488624,"env":"test","module":"user-credentials-repository","userId":"619b2c34-2162-4901-a72d-c4062bfffcae","msg":"User credentials created"}
 [31mÎ“Â¥Â»[39m tests/integration/auth.routes.real.test.ts [2m([22m[2m26 tests[22m[2m | [22m[31m2 failed[39m[2m)[22m[33m 70739[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should register a new user successfully [33m 1337[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 400 for invalid email format [33m 749[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 400 for weak password [33m 739[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 409 for duplicate email [33m 1322[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set httpOnly refresh token cookie [33m 1269[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should login with valid credentials [33m 1610[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for invalid password [33m 1358[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for non-existent user [33m 887[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 403 for unverified email[39m[33m 1525[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should record failed login attempt [33m 2190[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return requiresMfa=true for MFA-enabled users[39m[33m 1723[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should lock account after 5 failed attempts [33m 2532[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should logout and clear refresh token cookie [33m 2012[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should refresh access token with valid refresh token [33m 1831[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for missing refresh token [33m 789[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should rotate refresh token after use [33m 1918[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should send password reset email for existing user [33m 1608[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not reveal if email exists (security) [33m 834[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reset password with valid token [33m 2820[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 400 for invalid token [33m 804[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 400 for weak new password [33m 1430[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return current user for valid token [33m 1767[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for missing token [33m 757[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 for invalid token [33m 755[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should complete MFA login with valid TOTP code [33m 2669[2mms[22m[39m
         [33m[2mÎ“Â£Ã´[22m[39m should reject invalid MFA code [33m 1610[2mms[22m[39m
{"level":30,"time":1768250488727,"env":"test","module":"email-queue","jobId":"b05d9e34-b7af-4402-8a3c-56aa501b0615","to":"protected-test-0hRRNOeToYUtocydDT_Rk@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250488779,"env":"test","module":"auth-routes","userId":"619b2c34-2162-4901-a72d-c4062bfffcae","email":"protected-test-0hRRNOeToYUtocydDT_Rk@example.com","msg":"User registered"}
{"level":30,"time":1768250488886,"env":"test","module":"user-credentials-repository","userId":"ca58d203-44ca-4cc0-876e-c00337b62c79","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPATCH Protected Routes[2m > [22m[2mshould allow PATCH with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250488991,"env":"test","module":"email-queue","jobId":"6cc71e94-25cf-4b26-b661-de52ffe52015","to":"middleware-test-chgGGly_GZZ4PEeUTIHAJ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250489024,"env":"test","module":"auth-routes","userId":"f8bac009-fd52-4a6a-b889-ce47d3b8cc91","msg":"User logged in successfully"}
{"level":30,"time":1768250489042,"env":"test","module":"auth-routes","userId":"ca58d203-44ca-4cc0-876e-c00337b62c79","email":"middleware-test-chgGGly_GZZ4PEeUTIHAJ@example.com","msg":"User registered"}
{"level":30,"time":1768250489073,"env":"test","module":"audit-log-service","userId":"f8bac009-fd52-4a6a-b889-ce47d3b8cc91","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for PUT requests
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250489395,"env":"test","module":"auth-routes","userId":"619b2c34-2162-4901-a72d-c4062bfffcae","msg":"User logged in successfully"}
{"level":30,"time":1768250489441,"env":"test","module":"audit-log-service","userId":"619b2c34-2162-4901-a72d-c4062bfffcae","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250489508,"env":"test","module":"user-credentials-repository","userId":"f6632c3b-e422-48ef-8cab-dc55cc3e46ab","msg":"User credentials created"}
{"level":30,"time":1768250489548,"env":"test","module":"auth-routes","userId":"ca58d203-44ca-4cc0-876e-c00337b62c79","msg":"User logged in successfully"}
{"level":30,"time":1768250489600,"env":"test","module":"audit-log-service","userId":"ca58d203-44ca-4cc0-876e-c00337b62c79","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250489605,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250489606,"env":"test","module":"email-queue","jobId":"59f9fc04-778d-427e-979b-b6e282700615","to":"session-test-3pGIposQ72APIB0Fvk4N_@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250489659,"env":"test","module":"auth-routes","userId":"f6632c3b-e422-48ef-8cab-dc55cc3e46ab","email":"session-test-3pGIposQ72APIB0Fvk4N_@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Creation and Tracking[2m > [22m[2mshould create separate sessions for multiple device logins
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250489977,"env":"test","module":"user-credentials-repository","userId":"a80554d4-0b3b-4571-8955-a64f4a91a8a4","msg":"User credentials created"}
{"level":30,"time":1768250490075,"env":"test","module":"email-queue","jobId":"7abe2a49-8729-460e-bde2-a8b0796ce663","to":"middleware-test-Y8ZgSmZ3nfXTK-_VRYJBM@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250490123,"env":"test","module":"auth-routes","userId":"a80554d4-0b3b-4571-8955-a64f4a91a8a4","email":"middleware-test-Y8ZgSmZ3nfXTK-_VRYJBM@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould reject cookie auth for DELETE requests
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250490239,"env":"test","module":"auth-routes","userId":"f6632c3b-e422-48ef-8cab-dc55cc3e46ab","msg":"User logged in successfully"}
{"level":30,"time":1768250490287,"env":"test","module":"audit-log-service","userId":"f6632c3b-e422-48ef-8cab-dc55cc3e46ab","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Creation and Tracking[2m > [22m[2mshould create separate sessions for multiple device logins
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250490454,"env":"test","module":"user-credentials-repository","userId":"14135204-fd26-4648-8bee-921a16e9c5a6","msg":"User credentials created"}
{"level":30,"time":1768250490547,"env":"test","module":"email-queue","jobId":"0fd7cfc4-f4b8-4f57-b459-c18123e40a54","to":"protected-test-6Vs3EERWu5Bru_FC1n7pP@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250490594,"env":"test","module":"auth-routes","userId":"14135204-fd26-4648-8bee-921a16e9c5a6","email":"protected-test-6Vs3EERWu5Bru_FC1n7pP@example.com","msg":"User registered"}
{"level":30,"time":1768250490639,"env":"test","module":"auth-routes","userId":"a80554d4-0b3b-4571-8955-a64f4a91a8a4","msg":"User logged in successfully"}
{"level":30,"time":1768250490691,"env":"test","module":"audit-log-service","userId":"a80554d4-0b3b-4571-8955-a64f4a91a8a4","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250490695,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPATCH Protected Routes[2m > [22m[2mshould reject PATCH without Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250490782,"env":"test","module":"auth-routes","userId":"f6632c3b-e422-48ef-8cab-dc55cc3e46ab","msg":"User logged in successfully"}
{"level":30,"time":1768250490831,"env":"test","module":"audit-log-service","userId":"f6632c3b-e422-48ef-8cab-dc55cc3e46ab","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Creation and Tracking[2m > [22m[2mshould create separate sessions for multiple device logins
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250491066,"env":"test","module":"user-credentials-repository","userId":"1404919a-b45b-4d8f-9680-e472a87a74e9","msg":"User credentials created"}
{"level":30,"time":1768250491171,"env":"test","module":"email-queue","jobId":"fd5e9a9d-2152-4c8f-b52f-d1ac3c101933","to":"middleware-test-GauRn6-hmVXAE9Kwvr5cd@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250491191,"env":"test","module":"auth-routes","userId":"14135204-fd26-4648-8bee-921a16e9c5a6","msg":"User logged in successfully"}
{"level":30,"time":1768250491224,"env":"test","module":"auth-routes","userId":"1404919a-b45b-4d8f-9680-e472a87a74e9","email":"middleware-test-GauRn6-hmVXAE9Kwvr5cd@example.com","msg":"User registered"}
{"level":30,"time":1768250491238,"env":"test","module":"audit-log-service","userId":"14135204-fd26-4648-8bee-921a16e9c5a6","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250491241,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250491934,"env":"test","module":"auth-routes","userId":"f6632c3b-e422-48ef-8cab-dc55cc3e46ab","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould allow cookie auth for HEAD requests
[22m[39mDEBUG: LOGIN HANDLER HIT

stderr | tests/integration/auth/jwt.authentication.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: column "loop_config" of relation "loop_group_subquestions" already exists
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 153,
  severity: 'ERROR',
  code: '42701',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'tablecmds.c',
  line: '7478',
  routine: 'check_for_column_name_collision'
}

{"level":30,"time":1768250491998,"env":"test","module":"audit-log-service","userId":"f6632c3b-e422-48ef-8cab-dc55cc3e46ab","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250492206,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768250492223,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests
[22m[39m[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768250492213,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768250492214,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768250492219,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768250492223,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768250492223,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768250492223,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768250492223,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768250492264,"env":"test","module":"user-credentials-repository","userId":"68a4c471-60fe-44a1-874d-e33e1f263d76","msg":"User credentials created"}
{"level":30,"time":1768250492365,"env":"test","module":"email-queue","jobId":"75bb24fd-1688-4005-b198-0896cd0da0e9","to":"protected-test-xdDYU42XzjuT1mLD7n-Xm@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250492401,"env":"test","module":"auth-routes","userId":"1404919a-b45b-4d8f-9680-e472a87a74e9","msg":"User logged in successfully"}
{"level":30,"time":1768250492414,"env":"test","module":"auth-routes","userId":"68a4c471-60fe-44a1-874d-e33e1f263d76","email":"protected-test-xdDYU42XzjuT1mLD7n-Xm@example.com","msg":"User registered"}
{"level":30,"time":1768250492432,"env":"test","module":"user-credentials-repository","userId":"a32c9742-04c5-40f2-9301-cf8029c7fff7","msg":"User credentials created"}
{"level":30,"time":1768250492454,"env":"test","module":"audit-log-service","userId":"1404919a-b45b-4d8f-9680-e472a87a74e9","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle Bearer token with extra spaces
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250492533,"env":"test","module":"email-queue","jobId":"4432467e-e250-4ac8-a5cf-4b11738f89fd","to":"session-test-gsjUW8PlFwNy4uGEKOaVF@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250492582,"env":"test","module":"auth-routes","userId":"a32c9742-04c5-40f2-9301-cf8029c7fff7","email":"session-test-gsjUW8PlFwNy4uGEKOaVF@example.com","msg":"User registered"}
{"level":30,"time":1768250492677,"env":"test","module":"user-credentials-repository","userId":"37e9c97c-8393-4540-b700-794bb26a50a2","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250492778,"env":"test","module":"email-queue","jobId":"9f2eaa72-91ed-4233-bb01-98a6a2edf0b0","to":"test-f5WgcfvAPCmhuOZxxznHv@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250492831,"env":"test","module":"auth-routes","userId":"37e9c97c-8393-4540-b700-794bb26a50a2","email":"test-f5WgcfvAPCmhuOZxxznHv@example.com","msg":"User registered"}
{"level":30,"time":1768250492970,"env":"test","module":"user-credentials-repository","userId":"44fcb111-3f10-47bd-92b8-5b23e5e78141","msg":"User credentials created"}
{"level":30,"time":1768250493007,"env":"test","module":"auth-routes","userId":"68a4c471-60fe-44a1-874d-e33e1f263d76","msg":"User logged in successfully"}
{"level":30,"time":1768250493055,"env":"test","module":"audit-log-service","userId":"68a4c471-60fe-44a1-874d-e33e1f263d76","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768250493058,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768250493058,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250493065,"env":"test","module":"email-queue","jobId":"41255ea5-254e-44c6-a75f-0f6922ee4d0c","to":"middleware-test-JcRvfr1u_TQwRHjZIptLo@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250493120,"env":"test","module":"auth-routes","userId":"44fcb111-3f10-47bd-92b8-5b23e5e78141","email":"middleware-test-JcRvfr1u_TQwRHjZIptLo@example.com","msg":"User registered"}
{"level":30,"time":1768250493149,"env":"test","module":"auth-routes","userId":"a32c9742-04c5-40f2-9301-cf8029c7fff7","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould prioritize JWT over cookie when both present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250493198,"env":"test","module":"audit-log-service","userId":"a32c9742-04c5-40f2-9301-cf8029c7fff7","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250493425,"env":"test","module":"user-credentials-repository","userId":"aa1ac56c-5bee-423e-ba69-91a4ee7c6c25","msg":"User credentials created"}
{"level":30,"time":1768250493470,"env":"test","module":"user-credentials-repository","userId":"452afc8c-ece6-4082-a844-4118247a208f","msg":"User credentials created"}
{"level":30,"time":1768250493536,"env":"test","module":"email-queue","jobId":"7e199c24-e858-4419-91d9-9b4b969b716a","to":"protected-test-UqHXbvtvq3N5JVzMeq89Z@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250493567,"env":"test","module":"email-queue","jobId":"04dbbdaa-8655-4e80-a0dc-741499cf59c9","to":"jwt-test-e4A1cRAwtVWxWZlutKyyP@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250493581,"env":"test","module":"auth-routes","userId":"aa1ac56c-5bee-423e-ba69-91a4ee7c6c25","email":"protected-test-UqHXbvtvq3N5JVzMeq89Z@example.com","msg":"User registered"}
{"level":30,"time":1768250493618,"env":"test","module":"auth-routes","userId":"452afc8c-ece6-4082-a844-4118247a208f","email":"jwt-test-e4A1cRAwtVWxWZlutKyyP@example.com","msg":"User registered"}
{"level":30,"time":1768250493624,"env":"test","module":"auth-routes","userId":"44fcb111-3f10-47bd-92b8-5b23e5e78141","msg":"User logged in successfully"}
{"level":30,"time":1768250493672,"env":"test","module":"audit-log-service","userId":"44fcb111-3f10-47bd-92b8-5b23e5e78141","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250493686,"env":"test","module":"auth-routes","userId":"a32c9742-04c5-40f2-9301-cf8029c7fff7","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle very long invalid token
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mJWT Token Generation[2m > [22m[2mshould generate valid JWT token on successful login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250493737,"env":"test","module":"audit-log-service","userId":"a32c9742-04c5-40f2-9301-cf8029c7fff7","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250494044,"env":"test","module":"user-credentials-repository","userId":"7d321f1e-8ad7-4365-b31f-6c66112cb27f","msg":"User credentials created"}
{"level":30,"time":1768250494145,"env":"test","module":"email-queue","jobId":"9bfc6d9a-0ff6-465a-9882-3587e500bdb5","to":"user2-vg446CVXMwqeHiDOKUwHC@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250494193,"env":"test","module":"auth-routes","userId":"7d321f1e-8ad7-4365-b31f-6c66112cb27f","email":"user2-vg446CVXMwqeHiDOKUwHC@example.com","msg":"User registered"}
{"level":30,"time":1768250494200,"env":"test","module":"auth-routes","userId":"aa1ac56c-5bee-423e-ba69-91a4ee7c6c25","msg":"User logged in successfully"}
{"level":30,"time":1768250494210,"env":"test","module":"auth-routes","userId":"452afc8c-ece6-4082-a844-4118247a208f","msg":"User logged in successfully"}
{"level":30,"time":1768250494216,"env":"test","module":"auth-routes","userId":"a32c9742-04c5-40f2-9301-cf8029c7fff7","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould prioritize JWT over cookie when both present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250494248,"env":"test","module":"audit-log-service","userId":"aa1ac56c-5bee-423e-ba69-91a4ee7c6c25","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250494251,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250494269,"env":"test","module":"audit-log-service","userId":"a32c9742-04c5-40f2-9301-cf8029c7fff7","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250494269,"env":"test","module":"audit-log-service","userId":"452afc8c-ece6-4082-a844-4118247a208f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250494378,"env":"test","module":"auth-routes","userId":"a32c9742-04c5-40f2-9301-cf8029c7fff7","sessionCount":3,"msg":"Listed active sessions"}
{"level":30,"time":1768250494618,"env":"test","module":"user-credentials-repository","userId":"da9846c3-cdbb-46f4-a8bb-6b1238f4fcc6","msg":"User credentials created"}
{"level":30,"time":1768250494657,"env":"test","module":"user-credentials-repository","userId":"0b68b4ae-7180-42ba-86f3-47e245e9db50","msg":"User credentials created"}
{"level":30,"time":1768250494721,"env":"test","module":"email-queue","jobId":"5417e09b-7878-47fd-b6d8-30a6146f94d7","to":"protected-test-ndqrpTDNXpaJefYzsju-O@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250494729,"env":"test","module":"auth-routes","userId":"7d321f1e-8ad7-4365-b31f-6c66112cb27f","msg":"User logged in successfully"}
{"level":30,"time":1768250494759,"env":"test","module":"email-queue","jobId":"dc597f71-0f1d-43b5-a794-2859a4664d00","to":"jwt-test-gzRKmRN_l9FGuRciDu6I0@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250494765,"env":"test","module":"user-credentials-repository","userId":"226aec7b-3ea8-4de1-a775-7dbdf9762197","msg":"User credentials created"}
{"level":30,"time":1768250494769,"env":"test","module":"auth-routes","userId":"da9846c3-cdbb-46f4-a8bb-6b1238f4fcc6","email":"protected-test-ndqrpTDNXpaJefYzsju-O@example.com","msg":"User registered"}
{"level":30,"time":1768250494780,"env":"test","module":"audit-log-service","userId":"7d321f1e-8ad7-4365-b31f-6c66112cb27f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250494808,"env":"test","module":"auth-routes","userId":"0b68b4ae-7180-42ba-86f3-47e245e9db50","email":"jwt-test-gzRKmRN_l9FGuRciDu6I0@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mJWT Token Generation[2m > [22m[2mshould include correct payload in JWT token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250494864,"env":"test","module":"email-queue","jobId":"c0e7119e-8ee9-44d2-aba9-08c62f466801","to":"session-test-A7L71bnR0gXzc_dwbJJ6s@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle empty Authorization header
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250494917,"env":"test","module":"auth-routes","userId":"226aec7b-3ea8-4de1-a775-7dbdf9762197","email":"session-test-A7L71bnR0gXzc_dwbJJ6s@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould mark current session correctly
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250495258,"env":"test","module":"user-credentials-repository","userId":"a1684c17-1ce5-43ef-ba74-36c73f61df5c","msg":"User credentials created"}
{"level":30,"time":1768250495333,"env":"test","module":"auth-routes","userId":"0b68b4ae-7180-42ba-86f3-47e245e9db50","msg":"User logged in successfully"}
{"level":30,"time":1768250495357,"env":"test","module":"email-queue","jobId":"320b6e24-1de2-44ee-a27b-dc6a0cd3fd13","to":"middleware-test-xLAagxz_DYVWXaIsKrBfD@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250495385,"env":"test","module":"audit-log-service","userId":"0b68b4ae-7180-42ba-86f3-47e245e9db50","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250495394,"env":"test","module":"auth-routes","userId":"da9846c3-cdbb-46f4-a8bb-6b1238f4fcc6","msg":"User logged in successfully"}
{"level":30,"time":1768250495408,"env":"test","module":"auth-routes","userId":"a1684c17-1ce5-43ef-ba74-36c73f61df5c","email":"middleware-test-xLAagxz_DYVWXaIsKrBfD@example.com","msg":"User registered"}
{"level":30,"time":1768250495444,"env":"test","module":"audit-log-service","userId":"da9846c3-cdbb-46f4-a8bb-6b1238f4fcc6","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250495447,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould return 401 when no auth provided
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250495508,"env":"test","module":"auth-routes","userId":"226aec7b-3ea8-4de1-a775-7dbdf9762197","msg":"User logged in successfully"}
{"level":30,"time":1768250495563,"env":"test","module":"audit-log-service","userId":"226aec7b-3ea8-4de1-a775-7dbdf9762197","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould mark current session correctly
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250495768,"env":"test","module":"user-credentials-repository","userId":"33c69df6-c45b-4ad5-ab0b-2338de09cb56","msg":"User credentials created"}
{"level":30,"time":1768250495822,"env":"test","module":"user-credentials-repository","userId":"5aaa8bbb-31bf-41a1-a438-7c5a7cb933d9","msg":"User credentials created"}
{"level":30,"time":1768250495871,"env":"test","module":"email-queue","jobId":"237a6b74-c4e7-491f-9571-525b75461081","to":"jwt-test-IDNLidUlRD7Wkuc9kjwEm@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250495925,"env":"test","module":"auth-routes","userId":"33c69df6-c45b-4ad5-ab0b-2338de09cb56","email":"jwt-test-IDNLidUlRD7Wkuc9kjwEm@example.com","msg":"User registered"}
{"level":30,"time":1768250495928,"env":"test","module":"email-queue","jobId":"60b14c9f-1187-4299-bfc7-2ddc41e408ec","to":"protected-test-YEj5fnxu9fX_e-gFfKu1m@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250495943,"env":"test","module":"auth-routes","userId":"a1684c17-1ce5-43ef-ba74-36c73f61df5c","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mJWT Token Generation[2m > [22m[2mshould set JWT expiry to 15 minutes
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250495982,"env":"test","module":"auth-routes","userId":"5aaa8bbb-31bf-41a1-a438-7c5a7cb933d9","email":"protected-test-YEj5fnxu9fX_e-gFfKu1m@example.com","msg":"User registered"}
{"level":30,"time":1768250495991,"env":"test","module":"audit-log-service","userId":"a1684c17-1ce5-43ef-ba74-36c73f61df5c","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250495996,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250496038,"env":"test","module":"auth-routes","userId":"226aec7b-3ea8-4de1-a775-7dbdf9762197","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle Authorization header with only Bearer
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250496093,"env":"test","module":"audit-log-service","userId":"226aec7b-3ea8-4de1-a775-7dbdf9762197","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250496199,"env":"test","module":"auth-routes","userId":"226aec7b-3ea8-4de1-a775-7dbdf9762197","sessionCount":2,"msg":"Listed active sessions"}
{"level":30,"time":1768250496367,"env":"test","module":"user-credentials-repository","userId":"a774073a-2996-4b41-97ee-31d8e69cae04","msg":"User credentials created"}
{"level":30,"time":1768250496461,"env":"test","module":"auth-routes","userId":"33c69df6-c45b-4ad5-ab0b-2338de09cb56","msg":"User logged in successfully"}
{"level":30,"time":1768250496465,"env":"test","module":"email-queue","jobId":"3ff9f4a3-cd86-4a92-9c5a-8d99420c4b4d","to":"middleware-test-ivXI8Cb4uZMHKG-j-trzA@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250496511,"env":"test","module":"audit-log-service","userId":"33c69df6-c45b-4ad5-ab0b-2338de09cb56","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250496515,"env":"test","module":"auth-routes","userId":"a774073a-2996-4b41-97ee-31d8e69cae04","email":"middleware-test-ivXI8Cb4uZMHKG-j-trzA@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mhybridAuth Middleware[2m > [22m[2mshould return 401 when both JWT and cookie are invalid
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250496581,"env":"test","module":"user-credentials-repository","userId":"b3c86044-2439-4cbd-98ff-c1484aa3c48e","msg":"User credentials created"}
{"level":30,"time":1768250496591,"env":"test","module":"auth-routes","userId":"5aaa8bbb-31bf-41a1-a438-7c5a7cb933d9","msg":"User logged in successfully"}
{"level":30,"time":1768250496638,"env":"test","module":"audit-log-service","userId":"5aaa8bbb-31bf-41a1-a438-7c5a7cb933d9","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250496641,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250496682,"env":"test","module":"email-queue","jobId":"e6436f4b-73c8-402b-bfdf-44ac8e946d3b","to":"session-test-JX9HfsorKPKy_Iwadkw9X@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250496735,"env":"test","module":"auth-routes","userId":"b3c86044-2439-4cbd-98ff-c1484aa3c48e","email":"session-test-JX9HfsorKPKy_Iwadkw9X@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould not include revoked sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250496889,"env":"test","module":"user-credentials-repository","userId":"9652ccef-bf96-408f-b0d8-ea29b231adea","msg":"User credentials created"}
{"level":30,"time":1768250496994,"env":"test","module":"email-queue","jobId":"5a5e7842-e0f3-4975-8fa4-cb53242ad19f","to":"jwt-test-VKujfQwyj13e5Mwrli7HG@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250497023,"env":"test","module":"user-credentials-repository","userId":"09565240-ed78-454d-ac17-9db4966c0eea","msg":"User credentials created"}
{"level":30,"time":1768250497033,"env":"test","module":"auth-routes","userId":"a774073a-2996-4b41-97ee-31d8e69cae04","msg":"User logged in successfully"}
{"level":30,"time":1768250497043,"env":"test","module":"auth-routes","userId":"9652ccef-bf96-408f-b0d8-ea29b231adea","email":"jwt-test-VKujfQwyj13e5Mwrli7HG@example.com","msg":"User registered"}
{"level":30,"time":1768250497080,"env":"test","module":"audit-log-service","userId":"a774073a-2996-4b41-97ee-31d8e69cae04","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250497083,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mJWT Token Validation[2m > [22m[2mshould accept valid JWT token on protected routes
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250497121,"env":"test","module":"email-queue","jobId":"ee39931c-ccd4-427d-80e6-fa70a9a683cf","to":"protected-test-GEPaF6WgTE_kBi_zOk2zD@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250497173,"env":"test","module":"auth-routes","userId":"09565240-ed78-454d-ac17-9db4966c0eea","email":"protected-test-GEPaF6WgTE_kBi_zOk2zD@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle multiple Authorization headers
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250497315,"env":"test","module":"auth-routes","userId":"b3c86044-2439-4cbd-98ff-c1484aa3c48e","msg":"User logged in successfully"}
{"level":30,"time":1768250497363,"env":"test","module":"audit-log-service","userId":"b3c86044-2439-4cbd-98ff-c1484aa3c48e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould not include revoked sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250497467,"env":"test","module":"user-credentials-repository","userId":"e6e79b86-b831-46e7-9f43-97af28dd91b4","msg":"User credentials created"}
{"level":30,"time":1768250497566,"env":"test","module":"email-queue","jobId":"f2943f07-a33f-4341-8ebc-e70d401eb77d","to":"middleware-test-tW0_NOC7P0ykTli7cNPxv@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250497574,"env":"test","module":"auth-routes","userId":"9652ccef-bf96-408f-b0d8-ea29b231adea","msg":"User logged in successfully"}
{"level":30,"time":1768250497624,"env":"test","module":"auth-routes","userId":"e6e79b86-b831-46e7-9f43-97af28dd91b4","email":"middleware-test-tW0_NOC7P0ykTli7cNPxv@example.com","msg":"User registered"}
{"level":30,"time":1768250497625,"env":"test","module":"audit-log-service","userId":"9652ccef-bf96-408f-b0d8-ea29b231adea","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould authenticate with JWT if provided
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250497736,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768250497739,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250497784,"env":"test","module":"auth-routes","userId":"09565240-ed78-454d-ac17-9db4966c0eea","msg":"User logged in successfully"}
{"level":30,"time":1768250497830,"env":"test","module":"auth-routes","userId":"b3c86044-2439-4cbd-98ff-c1484aa3c48e","msg":"User logged in successfully"}
{"level":30,"time":1768250497834,"env":"test","module":"audit-log-service","userId":"09565240-ed78-454d-ac17-9db4966c0eea","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250497837,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250497878,"env":"test","module":"audit-log-service","userId":"b3c86044-2439-4cbd-98ff-c1484aa3c48e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250497991,"env":"test","module":"auth-routes","userId":"b3c86044-2439-4cbd-98ff-c1484aa3c48e","sessionCount":2,"msg":"Listed active sessions"}
{"level":30,"time":1768250498114,"env":"test","module":"user-credentials-repository","userId":"475beafd-9d8a-4121-90f6-091a0be1c6a2","msg":"User credentials created"}
{"level":30,"time":1768250498128,"env":"test","module":"auth-routes","userId":"e6e79b86-b831-46e7-9f43-97af28dd91b4","msg":"User logged in successfully"}
{"level":30,"time":1768250498148,"env":"test","module":"auth-routes","userId":"b3c86044-2439-4cbd-98ff-c1484aa3c48e","sessionId":"8bb07534-b39b-476a-b9a9-68371bcda43d","msg":"Session revoked"}
{"level":30,"time":1768250498176,"env":"test","module":"audit-log-service","userId":"e6e79b86-b831-46e7-9f43-97af28dd91b4","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250498203,"env":"test","module":"user-credentials-repository","userId":"00423837-4422-4c38-a104-fbe329aa0f4e","msg":"User credentials created"}
{"level":30,"time":1768250498214,"env":"test","module":"email-queue","jobId":"15cc7b56-8b57-45f5-aff0-0f18c945aeea","to":"jwt-test-59YR929K2FiP-e9ELNzTd@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250498247,"env":"test","module":"auth-routes","userId":"b3c86044-2439-4cbd-98ff-c1484aa3c48e","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768250498263,"env":"test","module":"auth-routes","userId":"475beafd-9d8a-4121-90f6-091a0be1c6a2","email":"jwt-test-59YR929K2FiP-e9ELNzTd@example.com","msg":"User registered"}
{"level":30,"time":1768250498298,"env":"test","module":"email-queue","jobId":"a967035f-d497-4c3b-900e-a666811f7fae","to":"protected-test-_e9M3AydQO2yhh4ZomkBS@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mJWT Token Validation[2m > [22m[2mshould accept request with missing Bearer prefix (lenient)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250498344,"env":"test","module":"auth-routes","userId":"00423837-4422-4c38-a104-fbe329aa0f4e","email":"protected-test-_e9M3AydQO2yhh4ZomkBS@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould reject token with SQL injection attempt
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250498623,"env":"test","module":"user-credentials-repository","userId":"caa83498-ca99-4e44-b40f-b194839cb1f5","msg":"User credentials created"}
{"level":30,"time":1768250498717,"env":"test","module":"intake-service","runId":"40bf4ed8-003f-4293-b91a-7f2a28304ae5","slug":"hybrid-jwt-tx9beah3sUAb6zF5MWWz3","userId":"e6e79b86-b831-46e7-9f43-97af28dd91b4","msg":"Created intake run"}
{"level":30,"time":1768250498724,"env":"test","module":"email-queue","jobId":"7cccf940-8a27-4070-a47c-34196838480b","to":"session-test-Dsdc8G4dEmqrMWtUveCit@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250498777,"env":"test","module":"auth-routes","userId":"caa83498-ca99-4e44-b40f-b194839cb1f5","email":"session-test-Dsdc8G4dEmqrMWtUveCit@example.com","msg":"User registered"}
{"level":30,"time":1768250498801,"env":"test","module":"auth-routes","userId":"475beafd-9d8a-4121-90f6-091a0be1c6a2","msg":"User logged in successfully"}
{"level":30,"time":1768250498850,"env":"test","module":"audit-log-service","userId":"475beafd-9d8a-4121-90f6-091a0be1c6a2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250498933,"env":"test","module":"auth-routes","userId":"00423837-4422-4c38-a104-fbe329aa0f4e","msg":"User logged in successfully"}
{"level":40,"time":1768250498959,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768250498960,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250498978,"env":"test","module":"audit-log-service","userId":"00423837-4422-4c38-a104-fbe329aa0f4e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250498981,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250499077,"env":"test","module":"user-credentials-repository","userId":"471cb46c-a77d-42a4-8ec5-f7b41cb9abd1","msg":"User credentials created"}
{"level":30,"time":1768250499170,"env":"test","module":"email-queue","jobId":"b166911e-91ca-4bf3-a141-643a08ec9cfd","to":"middleware-test-qDpOLYqhElqU0YuwRFM-n@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250499219,"env":"test","module":"auth-routes","userId":"471cb46c-a77d-42a4-8ec5-f7b41cb9abd1","email":"middleware-test-qDpOLYqhElqU0YuwRFM-n@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould authenticate with cookie if JWT not provided
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250499345,"env":"test","module":"auth-routes","userId":"caa83498-ca99-4e44-b40f-b194839cb1f5","msg":"User logged in successfully"}
{"level":30,"time":1768250499362,"env":"test","module":"user-credentials-repository","userId":"ae78ac88-41ea-4127-a397-fad24a44e981","msg":"User credentials created"}
{"level":30,"time":1768250499394,"env":"test","module":"audit-log-service","userId":"caa83498-ca99-4e44-b40f-b194839cb1f5","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250499455,"env":"test","module":"email-queue","jobId":"55a4e7dc-0e4d-4086-9830-241039b293dd","to":"protected-test-q8EB2v5Y6JC1DuU0Lj2cj@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250499507,"env":"test","module":"auth-routes","userId":"ae78ac88-41ea-4127-a397-fad24a44e981","email":"protected-test-q8EB2v5Y6JC1DuU0Lj2cj@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould reject token with XSS attempt
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250499729,"env":"test","module":"auth-routes","userId":"471cb46c-a77d-42a4-8ec5-f7b41cb9abd1","msg":"User logged in successfully"}
{"level":30,"time":1768250499779,"env":"test","module":"audit-log-service","userId":"471cb46c-a77d-42a4-8ec5-f7b41cb9abd1","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250499947,"env":"test","module":"auth-routes","userId":"caa83498-ca99-4e44-b40f-b194839cb1f5","msg":"User logged in successfully"}
{"level":30,"time":1768250499995,"env":"test","module":"audit-log-service","userId":"caa83498-ca99-4e44-b40f-b194839cb1f5","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768250500064,"env":"test","module":"auth-middleware","error":{"name":"TokenExpiredError","code":"AUTH_002","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768250500064,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250500101,"env":"test","module":"auth-routes","userId":"ae78ac88-41ea-4127-a397-fad24a44e981","msg":"User logged in successfully"}
{"level":30,"time":1768250500153,"env":"test","module":"audit-log-service","userId":"ae78ac88-41ea-4127-a397-fad24a44e981","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250500156,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250500279,"env":"test","module":"intake-service","runId":"2a072dc8-5455-4a54-997f-231d93b7762d","slug":"hybrid-cookie-FLwQYpwOzV-mNCCQyh9mp","msg":"Created intake run"}
{"level":30,"time":1768250500527,"env":"test","module":"user-credentials-repository","userId":"93f4b4b6-4ef2-400e-a2a8-f1f1507d862e","msg":"User credentials created"}
{"level":30,"time":1768250500569,"env":"test","module":"auth-routes","userId":"caa83498-ca99-4e44-b40f-b194839cb1f5","msg":"User logged in successfully"}
{"level":30,"time":1768250500619,"env":"test","module":"audit-log-service","userId":"caa83498-ca99-4e44-b40f-b194839cb1f5","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250500630,"env":"test","module":"email-queue","jobId":"006dd284-116d-405a-90b9-2801812734dc","to":"protected-test-HiSiwOp_nfBzMel9VwB-Q@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250500645,"env":"test","module":"user-credentials-repository","userId":"bb218ee3-c398-4e84-aa22-e1efef1bd95a","msg":"User credentials created"}
{"level":30,"time":1768250500683,"env":"test","module":"auth-routes","userId":"93f4b4b6-4ef2-400e-a2a8-f1f1507d862e","email":"protected-test-HiSiwOp_nfBzMel9VwB-Q@example.com","msg":"User registered"}
{"level":30,"time":1768250500735,"env":"test","module":"auth-routes","userId":"caa83498-ca99-4e44-b40f-b194839cb1f5","sessionCount":3,"msg":"Listed active sessions"}
{"level":30,"time":1768250500753,"env":"test","module":"email-queue","jobId":"b69830db-17f9-428c-82ee-60060a7284db","to":"middleware-test-2VaOLo_Ndfu777zBA-v-U@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Payload Validation[2m > [22m[2mshould reject token with missing userId
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250500801,"env":"test","module":"auth-routes","userId":"bb218ee3-c398-4e84-aa22-e1efef1bd95a","email":"middleware-test-2VaOLo_Ndfu777zBA-v-U@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould proceed anonymously if no auth provided
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250501116,"env":"test","module":"user-credentials-repository","userId":"348e5068-4139-4f47-ae69-4e3e1a0903c9","msg":"User credentials created"}
{"level":40,"time":1768250501169,"env":"test","module":"auth-middleware","error":{"name":"TokenExpiredError","code":"AUTH_002","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768250501169,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250501213,"env":"test","module":"email-queue","jobId":"a04267b9-b3c7-402e-b950-42b5caf64e45","to":"session-test-EkywHzEmMh2jF3_Hu44SL@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250501262,"env":"test","module":"auth-routes","userId":"348e5068-4139-4f47-ae69-4e3e1a0903c9","email":"session-test-EkywHzEmMh2jF3_Hu44SL@example.com","msg":"User registered"}
{"level":30,"time":1768250501291,"env":"test","module":"auth-routes","userId":"93f4b4b6-4ef2-400e-a2a8-f1f1507d862e","msg":"User logged in successfully"}
{"level":30,"time":1768250501321,"env":"test","module":"auth-routes","userId":"bb218ee3-c398-4e84-aa22-e1efef1bd95a","msg":"User logged in successfully"}
{"level":30,"time":1768250501339,"env":"test","module":"audit-log-service","userId":"93f4b4b6-4ef2-400e-a2a8-f1f1507d862e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250501362,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250501374,"env":"test","module":"audit-log-service","userId":"bb218ee3-c398-4e84-aa22-e1efef1bd95a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250501730,"env":"test","module":"user-credentials-repository","userId":"3a3ffcb6-86da-435e-8d6f-ff299eed013d","msg":"User credentials created"}
{"level":30,"time":1768250501749,"env":"test","module":"user-credentials-repository","userId":"bb9af46a-97ca-4fd8-be96-b27fb96680f1","msg":"User credentials created"}
{"level":30,"time":1768250501830,"env":"test","module":"email-queue","jobId":"a7c4d258-9856-457a-b76a-38998e3fafda","to":"protected-test-DJhAnYKrQ7eNoxjdwkPRC@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250501846,"env":"test","module":"email-queue","jobId":"8fe42170-3cc0-4e9e-a452-494c51f5d1f4","to":"session-test--J2i1hicQNXQ2bjoRKawY@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250501878,"env":"test","module":"intake-service","runId":"8b9e6ff2-fe1c-45ff-ab0a-acfaea7e1f3a","slug":"hybrid-anon-K7CFCDwDgFo5tgpVhAB80","msg":"Created intake run"}
{"level":30,"time":1768250501882,"env":"test","module":"auth-routes","userId":"3a3ffcb6-86da-435e-8d6f-ff299eed013d","email":"protected-test-DJhAnYKrQ7eNoxjdwkPRC@example.com","msg":"User registered"}
{"level":30,"time":1768250501897,"env":"test","module":"auth-routes","userId":"bb9af46a-97ca-4fd8-be96-b27fb96680f1","email":"session-test--J2i1hicQNXQ2bjoRKawY@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Payload Validation[2m > [22m[2mshould reject token with non-existent userId
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250502138,"env":"test","module":"user-credentials-repository","userId":"c2490a28-8983-40a5-bf81-267ae0c3c6bf","msg":"User credentials created"}
{"level":30,"time":1768250502236,"env":"test","module":"email-queue","jobId":"1631b32f-07fe-4aee-aca4-3b0c90fba10d","to":"jwt-test-MzffZYcAUUchp34Dmrbup@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250502258,"env":"test","module":"user-credentials-repository","userId":"2c4a1ca5-21be-4816-9668-233315fc6f13","msg":"User credentials created"}
{"level":30,"time":1768250502290,"env":"test","module":"auth-routes","userId":"c2490a28-8983-40a5-bf81-267ae0c3c6bf","email":"jwt-test-MzffZYcAUUchp34Dmrbup@example.com","msg":"User registered"}
{"level":30,"time":1768250502354,"env":"test","module":"email-queue","jobId":"bdf7f7ff-7294-4386-8def-7bbb8446ccab","to":"middleware-test-gnA-A1Zb1PgvqljimWbHe@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250502406,"env":"test","module":"auth-routes","userId":"2c4a1ca5-21be-4816-9668-233315fc6f13","email":"middleware-test-gnA-A1Zb1PgvqljimWbHe@example.com","msg":"User registered"}
{"level":50,"time":1768250502451,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2moptionalHybridAuth Middleware[2m > [22m[2mshould proceed anonymously if both JWT and cookie are invalid
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250502462,"env":"test","module":"auth-routes","userId":"bb9af46a-97ca-4fd8-be96-b27fb96680f1","msg":"User logged in successfully"}
{"level":30,"time":1768250502494,"env":"test","module":"auth-routes","userId":"3a3ffcb6-86da-435e-8d6f-ff299eed013d","msg":"User logged in successfully"}
{"level":30,"time":1768250502516,"env":"test","module":"audit-log-service","userId":"bb9af46a-97ca-4fd8-be96-b27fb96680f1","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250502539,"env":"test","module":"audit-log-service","userId":"3a3ffcb6-86da-435e-8d6f-ff299eed013d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250502820,"env":"test","module":"user-credentials-repository","userId":"5830068e-1ce7-4f62-882a-03c401f18d79","msg":"User credentials created"}
{"level":30,"time":1768250502920,"env":"test","module":"email-queue","jobId":"cf8e062f-2137-4588-a767-a0af9ad38ab8","to":"user1-tKpGMbvCzrkRNSDWRApzd@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250502925,"env":"test","module":"auth-routes","userId":"2c4a1ca5-21be-4816-9668-233315fc6f13","msg":"User logged in successfully"}
{"level":30,"time":1768250502968,"env":"test","module":"auth-routes","userId":"5830068e-1ce7-4f62-882a-03c401f18d79","email":"user1-tKpGMbvCzrkRNSDWRApzd@example.com","msg":"User registered"}
{"level":30,"time":1768250502973,"env":"test","module":"audit-log-service","userId":"2c4a1ca5-21be-4816-9668-233315fc6f13","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250502987,"env":"test","module":"auth-routes","userId":"bb9af46a-97ca-4fd8-be96-b27fb96680f1","msg":"User logged in successfully"}
{"level":30,"time":1768250502997,"env":"test","module":"user-credentials-repository","userId":"24a9f35b-ca06-48ec-a69d-45b08562a8c0","msg":"User credentials created"}
{"level":30,"time":1768250503036,"env":"test","module":"audit-log-service","userId":"bb9af46a-97ca-4fd8-be96-b27fb96680f1","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250503094,"env":"test","module":"email-queue","jobId":"476a83be-058f-40d5-a135-ea6706a09006","to":"protected-test-vEaZCfBtgI9Q7u_M0zJw_@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250503135,"env":"test","module":"auth-routes","userId":"bb9af46a-97ca-4fd8-be96-b27fb96680f1","sessionCount":2,"msg":"Listed active sessions"}
{"level":30,"time":1768250503141,"env":"test","module":"auth-routes","userId":"24a9f35b-ca06-48ec-a69d-45b08562a8c0","email":"protected-test-vEaZCfBtgI9Q7u_M0zJw_@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mCross-User Authorization[2m > [22m[2mshould not allow user to access another user's resources
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250503283,"env":"test","module":"auth-routes","userId":"bb9af46a-97ca-4fd8-be96-b27fb96680f1","sessionId":"5a6049eb-91fb-49e1-b3e9-db6a1a021acc","msg":"Session revoked"}
{"level":30,"time":1768250503286,"env":"test","module":"auth-service","tokenHash":"6e5364fa28ca92ef89ecebb2539a077c903f17aef936ac388b7eefe447c50d65","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250503333,"env":"test","module":"auth-service","userId":"bb9af46a-97ca-4fd8-be96-b27fb96680f1","tokenHash":"6e5364fa28ca92ef89ecebb2539a077c903f17aef936ac388b7eefe447c50d65","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768250503347,"env":"test","module":"user-credentials-repository","userId":"0bd3de06-f1fd-445b-930a-5f291eb1d2ce","msg":"User credentials created"}
{"level":30,"time":1768250503448,"env":"test","module":"email-queue","jobId":"72c2749c-f440-48ad-aecc-bd880fb08bdf","to":"user2-D-bDO3r7ZhwE5NRn7HF9i@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250503484,"env":"test","module":"intake-service","runId":"fe8e6534-dbe3-457e-974d-c1b7a1d7b125","slug":"hybrid-invalid-FVcZtoB7ydQuyOSn9ACO3","msg":"Created intake run"}
{"level":30,"time":1768250503498,"env":"test","module":"auth-routes","userId":"0bd3de06-f1fd-445b-930a-5f291eb1d2ce","email":"user2-D-bDO3r7ZhwE5NRn7HF9i@example.com","msg":"User registered"}
{"level":30,"time":1768250503743,"env":"test","module":"auth-routes","userId":"24a9f35b-ca06-48ec-a69d-45b08562a8c0","msg":"User logged in successfully"}
{"level":30,"time":1768250503768,"env":"test","module":"user-credentials-repository","userId":"5c424e5d-5e92-4d18-96fc-5e433436dde8","msg":"User credentials created"}
{"level":30,"time":1768250503795,"env":"test","module":"audit-log-service","userId":"24a9f35b-ca06-48ec-a69d-45b08562a8c0","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250503861,"env":"test","module":"user-credentials-repository","userId":"2204c02c-6a4d-4cab-abaa-a72a992e089b","msg":"User credentials created"}
{"level":30,"time":1768250503868,"env":"test","module":"email-queue","jobId":"1e0d0a23-202b-4470-a337-61d322defa5e","to":"session-test-pHjfH3Gs1NlBkgT_sREwg@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250503924,"env":"test","module":"auth-routes","userId":"5c424e5d-5e92-4d18-96fc-5e433436dde8","email":"session-test-pHjfH3Gs1NlBkgT_sREwg@example.com","msg":"User registered"}
{"level":30,"time":1768250503983,"env":"test","module":"email-queue","jobId":"d57b3afd-f403-4567-b243-440b9ad65c80","to":"middleware-test-zWOvnyuQxl5q5nE2pBowX@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250503989,"env":"test","module":"user-credentials-repository","userId":"940f6e61-b065-4010-b138-b899c7476212","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking current session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250504035,"env":"test","module":"auth-routes","userId":"2204c02c-6a4d-4cab-abaa-a72a992e089b","email":"middleware-test-zWOvnyuQxl5q5nE2pBowX@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mCookie Strategy Security[2m > [22m[2mshould only allow safe methods for cookie auth
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250504104,"env":"test","module":"email-queue","jobId":"9b392014-d821-4560-b011-60a59776d94e","to":"jwt-test-zxW-yZcvrwGu1i7QnpFcO@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250504153,"env":"test","module":"auth-routes","userId":"940f6e61-b065-4010-b138-b899c7476212","email":"jwt-test-zxW-yZcvrwGu1i7QnpFcO@example.com","msg":"User registered"}
{"level":50,"time":1768250504155,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250504171,"env":"test","module":"user-credentials-repository","userId":"a27667c5-8590-4026-a863-7388db9b3282","msg":"User credentials created"}
{"level":30,"time":1768250504262,"env":"test","module":"email-queue","jobId":"178fcce7-aa4d-4b4b-a889-1775b990f987","to":"user2--GG-mBh3D7K79HuYwa2iq@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250504311,"env":"test","module":"auth-routes","userId":"a27667c5-8590-4026-a863-7388db9b3282","email":"user2--GG-mBh3D7K79HuYwa2iq@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mCross-User Authorization[2m > [22m[2mshould not allow user to access another user's resources
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250504495,"env":"test","module":"auth-routes","userId":"5c424e5d-5e92-4d18-96fc-5e433436dde8","msg":"User logged in successfully"}
{"level":30,"time":1768250504539,"env":"test","module":"user-credentials-repository","userId":"06eafd4a-335c-4fb2-82c2-bfb97f784b80","msg":"User credentials created"}
{"level":30,"time":1768250504546,"env":"test","module":"audit-log-service","userId":"5c424e5d-5e92-4d18-96fc-5e433436dde8","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250504557,"env":"test","module":"auth-routes","userId":"2204c02c-6a4d-4cab-abaa-a72a992e089b","msg":"User logged in successfully"}
{"level":30,"time":1768250504603,"env":"test","module":"audit-log-service","userId":"2204c02c-6a4d-4cab-abaa-a72a992e089b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250504636,"env":"test","module":"email-queue","jobId":"4cc5954e-9b0c-48d6-9a81-815a551dc0d9","to":"jwt-test-BkkZzoJs_bVOL1vhl1mju@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250504651,"env":"test","module":"auth-routes","userId":"5c424e5d-5e92-4d18-96fc-5e433436dde8","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768250504684,"env":"test","module":"auth-routes","userId":"06eafd4a-335c-4fb2-82c2-bfb97f784b80","email":"jwt-test-BkkZzoJs_bVOL1vhl1mju@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mHybrid Authentication Strategy[2m > [22m[2mshould allow GET requests with cookie auth only
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":50,"time":1768250504757,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250504863,"env":"test","module":"auth-routes","userId":"a27667c5-8590-4026-a863-7388db9b3282","msg":"User logged in successfully"}
{"level":30,"time":1768250504911,"env":"test","module":"audit-log-service","userId":"a27667c5-8590-4026-a863-7388db9b3282","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768250504965,"env":"test","module":"rbac-middleware","userId":"a27667c5-8590-4026-a863-7388db9b3282","userRole":"viewer","permission":"project:delete","path":"/d9cd3743-73ac-4d10-9950-f0b2e2b7339d","msg":"Permission denied"}
{"level":30,"time":1768250505126,"env":"test","module":"user-credentials-repository","userId":"548565a4-a635-4003-824f-1527be566183","msg":"User credentials created"}
{"level":30,"time":1768250505131,"env":"test","module":"user-credentials-repository","userId":"73f1f54b-364d-42a7-a65d-ed145d9c6fb8","msg":"User credentials created"}
{"level":30,"time":1768250505197,"env":"test","module":"auth-routes","userId":"06eafd4a-335c-4fb2-82c2-bfb97f784b80","msg":"User logged in successfully"}
{"level":30,"time":1768250505235,"env":"test","module":"email-queue","jobId":"9eaa6559-e780-49f1-ba99-508224f2e0c3","to":"middleware-test-RQuUjfze8NtIefF7PQp2i@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250505236,"env":"test","module":"email-queue","jobId":"0cd1fa95-240d-4033-b04d-1d7ecaa6ed6f","to":"session-test-_Yt6xnaZMQQ4YKaQjHGdU@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250505247,"env":"test","module":"audit-log-service","userId":"06eafd4a-335c-4fb2-82c2-bfb97f784b80","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250505284,"env":"test","module":"auth-routes","userId":"73f1f54b-364d-42a7-a65d-ed145d9c6fb8","email":"middleware-test-RQuUjfze8NtIefF7PQp2i@example.com","msg":"User registered"}
{"level":30,"time":1768250505284,"env":"test","module":"auth-routes","userId":"548565a4-a635-4003-824f-1527be566183","email":"session-test-_Yt6xnaZMQQ4YKaQjHGdU@example.com","msg":"User registered"}
{"level":30,"time":1768250505323,"env":"test","module":"user-credentials-repository","userId":"ff04a243-9337-46cc-b55d-042c29058ea3","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mCookie Strategy Security[2m > [22m[2mshould ignore cookies when Bearer token present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250505424,"env":"test","module":"email-queue","jobId":"bfd4bdc7-5d1f-4804-b3af-bdde1d737acb","to":"protected-test-rpGmPbGbcH2deUMx9d3Yf@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250505477,"env":"test","module":"auth-routes","userId":"ff04a243-9337-46cc-b55d-042c29058ea3","email":"protected-test-rpGmPbGbcH2deUMx9d3Yf@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mUser Context Injection[2m > [22m[2mshould inject userId into request context
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250505758,"env":"test","module":"user-credentials-repository","userId":"ee0a4f9e-cec9-4bf7-a340-3f8f1bd3f9ab","msg":"User credentials created"}
{"level":30,"time":1768250505780,"env":"test","module":"user-credentials-repository","userId":"2bc42ef3-a70e-4638-a209-8c02a3a9a45a","msg":"User credentials created"}
{"level":30,"time":1768250505792,"env":"test","module":"auth-routes","userId":"73f1f54b-364d-42a7-a65d-ed145d9c6fb8","msg":"User logged in successfully"}
{"level":30,"time":1768250505840,"env":"test","module":"audit-log-service","userId":"73f1f54b-364d-42a7-a65d-ed145d9c6fb8","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250505856,"env":"test","module":"email-queue","jobId":"278a4a06-5fdf-4b45-ad4c-14c0b2f8ee1a","to":"user2-y_MeqAeAn7gu6KgxWpYg3@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250505880,"env":"test","module":"email-queue","jobId":"ae8ec963-4618-4a45-9fc1-247019149e12","to":"jwt-test-gmrahJY2gIVJnsGegFTBx@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250505905,"env":"test","module":"auth-routes","userId":"ee0a4f9e-cec9-4bf7-a340-3f8f1bd3f9ab","email":"user2-y_MeqAeAn7gu6KgxWpYg3@example.com","msg":"User registered"}
{"level":30,"time":1768250505928,"env":"test","module":"auth-routes","userId":"2bc42ef3-a70e-4638-a209-8c02a3a9a45a","email":"jwt-test-gmrahJY2gIVJnsGegFTBx@example.com","msg":"User registered"}
{"level":50,"time":1768250505931,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould not allow revoking other users sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250506070,"env":"test","module":"auth-routes","userId":"ff04a243-9337-46cc-b55d-042c29058ea3","msg":"User logged in successfully"}
{"level":30,"time":1768250506116,"env":"test","module":"audit-log-service","userId":"ff04a243-9337-46cc-b55d-042c29058ea3","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250506210,"env":"test","module":"user-credentials-repository","userId":"3d6a9e0a-24f1-419f-9f9c-c177513bbed1","msg":"User credentials created"}
{"level":30,"time":1768250506308,"env":"test","module":"email-queue","jobId":"017142e0-2ea2-4a0e-a638-e790ff8374e5","to":"cookie-test-qpH8UcKAnAYFybBfqPOXZ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250506360,"env":"test","module":"auth-routes","userId":"3d6a9e0a-24f1-419f-9f9c-c177513bbed1","email":"cookie-test-qpH8UcKAnAYFybBfqPOXZ@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mCookie Strategy Security[2m > [22m[2mshould ignore cookies when Bearer token present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250506420,"env":"test","module":"auth-routes","userId":"ee0a4f9e-cec9-4bf7-a340-3f8f1bd3f9ab","msg":"User logged in successfully"}
{"level":30,"time":1768250506469,"env":"test","module":"audit-log-service","userId":"ee0a4f9e-cec9-4bf7-a340-3f8f1bd3f9ab","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250506526,"env":"test","module":"user-credentials-repository","userId":"02359aef-a9f5-4a00-9a22-a98f9effd405","msg":"User credentials created"}
{"level":30,"time":1768250506580,"env":"test","module":"auth-routes","userId":"ee0a4f9e-cec9-4bf7-a340-3f8f1bd3f9ab","sessionCount":2,"msg":"Listed active sessions"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould not allow revoking other users sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250506630,"env":"test","module":"email-queue","jobId":"0008dc9b-a358-42f1-805b-e7fa7a01b282","to":"protected-test-0gM8uljsL7pyzQr4F1WUk@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250506676,"env":"test","module":"auth-routes","userId":"02359aef-a9f5-4a00-9a22-a98f9effd405","email":"protected-test-0gM8uljsL7pyzQr4F1WUk@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mUser Context Injection[2m > [22m[2mshould inject tenantId into request context
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250506864,"env":"test","module":"auth-routes","userId":"3d6a9e0a-24f1-419f-9f9c-c177513bbed1","msg":"User logged in successfully"}
{"level":30,"time":1768250506916,"env":"test","module":"audit-log-service","userId":"3d6a9e0a-24f1-419f-9f9c-c177513bbed1","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250507049,"env":"test","module":"auth-routes","userId":"548565a4-a635-4003-824f-1527be566183","msg":"User logged in successfully"}
{"level":30,"time":1768250507102,"env":"test","module":"audit-log-service","userId":"548565a4-a635-4003-824f-1527be566183","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250507217,"env":"test","module":"user-credentials-repository","userId":"f7043678-dfe9-414c-a95b-46909181bf3e","msg":"User credentials created"}
{"level":30,"time":1768250507280,"env":"test","module":"auth-routes","userId":"02359aef-a9f5-4a00-9a22-a98f9effd405","msg":"User logged in successfully"}
{"level":30,"time":1768250507314,"env":"test","module":"email-queue","jobId":"523bf50b-5a81-4227-89d1-a4856a877742","to":"jwt-test-lIzeRr8uZxRK2jJkG7zDA@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250507327,"env":"test","module":"audit-log-service","userId":"02359aef-a9f5-4a00-9a22-a98f9effd405","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250507365,"env":"test","module":"auth-routes","userId":"f7043678-dfe9-414c-a95b-46909181bf3e","email":"jwt-test-lIzeRr8uZxRK2jJkG7zDA@example.com","msg":"User registered"}
{"level":30,"time":1768250507386,"env":"test","module":"user-credentials-repository","userId":"7402738b-e07d-4258-8618-48b2ec559c54","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould refresh access token using refresh token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250507491,"env":"test","module":"email-queue","jobId":"398c21ab-0930-44fc-a6e0-74f9157ef6a3","to":"middleware-test-QZ5xS99b6gGlrHrQ0mDMX@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250507545,"env":"test","module":"auth-routes","userId":"7402738b-e07d-4258-8618-48b2ec559c54","email":"middleware-test-QZ5xS99b6gGlrHrQ0mDMX@example.com","msg":"User registered"}
{"level":30,"time":1768250507573,"env":"test","module":"user-credentials-repository","userId":"14efa6c8-4058-43dc-9e96-3a7a66730b59","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mUser Context Attachment[2m > [22m[2mshould attach userId to request
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250507678,"env":"test","module":"email-queue","jobId":"07989621-3528-44b7-b32a-5e2f97b4f5d0","to":"session-test-d4y7bCu1IEcunbxFbBgYR@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250507726,"env":"test","module":"auth-routes","userId":"14efa6c8-4058-43dc-9e96-3a7a66730b59","email":"session-test-d4y7bCu1IEcunbxFbBgYR@example.com","msg":"User registered"}
{"level":30,"time":1768250507749,"env":"test","module":"user-credentials-repository","userId":"f9819089-3201-4970-ba93-96feb800c123","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould return 404 for non-existent session ID
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250507843,"env":"test","module":"email-queue","jobId":"c5578e90-de47-4aa1-a67a-271f918a1380","to":"protected-test-Yw3s8wDyxU7ab3NiRGklu@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250507883,"env":"test","module":"auth-routes","userId":"f7043678-dfe9-414c-a95b-46909181bf3e","msg":"User logged in successfully"}
{"level":30,"time":1768250507891,"env":"test","module":"auth-routes","userId":"f9819089-3201-4970-ba93-96feb800c123","email":"protected-test-Yw3s8wDyxU7ab3NiRGklu@example.com","msg":"User registered"}
{"level":30,"time":1768250507934,"env":"test","module":"audit-log-service","userId":"f7043678-dfe9-414c-a95b-46909181bf3e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mUser Context Injection[2m > [22m[2mshould inject role into request context
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250508062,"env":"test","module":"auth-routes","userId":"7402738b-e07d-4258-8618-48b2ec559c54","msg":"User logged in successfully"}
{"level":30,"time":1768250508109,"env":"test","module":"audit-log-service","userId":"7402738b-e07d-4258-8618-48b2ec559c54","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250508282,"env":"test","module":"auth-routes","userId":"14efa6c8-4058-43dc-9e96-3a7a66730b59","msg":"User logged in successfully"}
{"level":30,"time":1768250508329,"env":"test","module":"audit-log-service","userId":"14efa6c8-4058-43dc-9e96-3a7a66730b59","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250508489,"env":"test","module":"auth-routes","userId":"f9819089-3201-4970-ba93-96feb800c123","msg":"User logged in successfully"}
{"level":30,"time":1768250508534,"env":"test","module":"audit-log-service","userId":"f9819089-3201-4970-ba93-96feb800c123","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250508583,"env":"test","module":"user-credentials-repository","userId":"bfbe08f1-cee2-4774-91f8-eea56d6024e1","msg":"User credentials created"}
{"level":30,"time":1768250508678,"env":"test","module":"email-queue","jobId":"fc0859b2-a1a3-4d74-8e8e-c159e9e74045","to":"middleware-test-WkC2mNPGYWqorF14BxG98@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250508725,"env":"test","module":"auth-routes","userId":"bfbe08f1-cee2-4774-91f8-eea56d6024e1","email":"middleware-test-WkC2mNPGYWqorF14BxG98@example.com","msg":"User registered"}
{"level":30,"time":1768250508752,"env":"test","module":"user-credentials-repository","userId":"99325fce-cba9-487c-925d-1f3e82c639fa","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mUser Context Attachment[2m > [22m[2mshould attach userEmail to request
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250508850,"env":"test","module":"email-queue","jobId":"f5042d6f-9965-4cdc-a736-e793cecee7f7","to":"session-test-FxqaFDNVMiJ9UT_hDv7KO@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250508898,"env":"test","module":"auth-routes","userId":"99325fce-cba9-487c-925d-1f3e82c639fa","email":"session-test-FxqaFDNVMiJ9UT_hDv7KO@example.com","msg":"User registered"}
{"level":30,"time":1768250508938,"env":"test","module":"auth-service","tokenHash":"25b5f6779698e65a666333983abd83b1b217a5ca62af5a0cfe5e8d9eeb22db54","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250508943,"env":"test","module":"user-credentials-repository","userId":"b91809cc-dd69-4736-a06f-46f3f469e2e2","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all sessions except current
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250509039,"env":"test","module":"email-queue","jobId":"b14c94bc-f952-44ba-af9c-da8f89531e88","to":"protected-test-j3pV1piF_L0pyJx9sUxke@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250509088,"env":"test","module":"auth-routes","userId":"b91809cc-dd69-4736-a06f-46f3f469e2e2","email":"protected-test-j3pV1piF_L0pyJx9sUxke@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mRate Limiting on Protected Routes[2m > [22m[2mshould not apply general rate limiting to authenticated requests
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250509238,"env":"test","module":"auth-routes","userId":"bfbe08f1-cee2-4774-91f8-eea56d6024e1","msg":"User logged in successfully"}
{"level":30,"time":1768250509286,"env":"test","module":"audit-log-service","userId":"bfbe08f1-cee2-4774-91f8-eea56d6024e1","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250509474,"env":"test","module":"auth-routes","userId":"99325fce-cba9-487c-925d-1f3e82c639fa","msg":"User logged in successfully"}
{"level":30,"time":1768250509517,"env":"test","module":"user-credentials-repository","userId":"21633474-2902-445c-a324-2cde602d0516","msg":"User credentials created"}
{"level":30,"time":1768250509535,"env":"test","module":"audit-log-service","userId":"99325fce-cba9-487c-925d-1f3e82c639fa","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all sessions except current
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250509614,"env":"test","module":"email-queue","jobId":"7c8a7202-fc39-432f-87cf-4ab304128c09","to":"jwt-test-5YlvrjaDmYA5PcARSUQST@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250509665,"env":"test","module":"auth-routes","userId":"21633474-2902-445c-a324-2cde602d0516","email":"jwt-test-5YlvrjaDmYA5PcARSUQST@example.com","msg":"User registered"}
{"level":30,"time":1768250509701,"env":"test","module":"auth-routes","userId":"b91809cc-dd69-4736-a06f-46f3f469e2e2","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould rotate refresh token on use
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250509748,"env":"test","module":"user-credentials-repository","userId":"e85c13d7-9d78-47dd-9c6c-d81caad9ed9a","msg":"User credentials created"}
{"level":30,"time":1768250509752,"env":"test","module":"audit-log-service","userId":"b91809cc-dd69-4736-a06f-46f3f469e2e2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250509845,"env":"test","module":"email-queue","jobId":"f9eadce2-6b69-4178-82c0-0bed7867e759","to":"middleware-test-8cIfXld8cTg3xsQTSc8Mx@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250509896,"env":"test","module":"auth-routes","userId":"e85c13d7-9d78-47dd-9c6c-d81caad9ed9a","email":"middleware-test-8cIfXld8cTg3xsQTSc8Mx@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould return consistent error format for missing token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250510003,"env":"test","module":"auth-routes","userId":"99325fce-cba9-487c-925d-1f3e82c639fa","msg":"User logged in successfully"}
{"level":30,"time":1768250510055,"env":"test","module":"audit-log-service","userId":"99325fce-cba9-487c-925d-1f3e82c639fa","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all sessions except current
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250510182,"env":"test","module":"auth-routes","userId":"21633474-2902-445c-a324-2cde602d0516","msg":"User logged in successfully"}
{"level":30,"time":1768250510237,"env":"test","module":"audit-log-service","userId":"21633474-2902-445c-a324-2cde602d0516","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250510240,"env":"test","module":"auth-service","tokenHash":"201c260d96a61f10c657d978cc89db0b4ed99f4d8e78743994c4f976d0fee252","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250510419,"env":"test","module":"auth-routes","userId":"e85c13d7-9d78-47dd-9c6c-d81caad9ed9a","msg":"User logged in successfully"}
{"level":30,"time":1768250510442,"env":"test","module":"auth-service","tokenHash":"201c260d96a61f10c657d978cc89db0b4ed99f4d8e78743994c4f976d0fee252","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250510466,"env":"test","module":"audit-log-service","userId":"e85c13d7-9d78-47dd-9c6c-d81caad9ed9a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250510469,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1768250510492,"env":"test","module":"auth-service","userId":"21633474-2902-445c-a324-2cde602d0516","tokenHash":"201c260d96a61f10c657d978cc89db0b4ed99f4d8e78743994c4f976d0fee252","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768250510530,"env":"test","module":"auth-routes","userId":"99325fce-cba9-487c-925d-1f3e82c639fa","msg":"User logged in successfully"}
{"level":30,"time":1768250510547,"env":"test","module":"auth-service","tokenHash":"98f19c2c54098ba085b6047940c262833fd868f3200d012647ab91cb56a73232","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250510583,"env":"test","module":"user-credentials-repository","userId":"add3653e-0b0f-4a2b-be08-cc380f2bb3b9","msg":"User credentials created"}
{"level":30,"time":1768250510584,"env":"test","module":"audit-log-service","userId":"99325fce-cba9-487c-925d-1f3e82c639fa","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768250510595,"env":"test","module":"auth-service","userId":"21633474-2902-445c-a324-2cde602d0516","tokenHash":"98f19c2c54098ba085b6047940c262833fd868f3200d012647ab91cb56a73232","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768250510683,"env":"test","module":"email-queue","jobId":"c517855c-d790-487e-977d-261dbdf5e5b2","to":"protected-test-ILPbd_x5nhargygwvxxwF@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250510730,"env":"test","module":"auth-routes","userId":"add3653e-0b0f-4a2b-be08-cc380f2bb3b9","email":"protected-test-ILPbd_x5nhargygwvxxwF@example.com","msg":"User registered"}
{"level":30,"time":1768250510738,"env":"test","module":"auth-routes","userId":"99325fce-cba9-487c-925d-1f3e82c639fa","msg":"All other sessions revoked"}
{"level":30,"time":1768250510792,"env":"test","module":"audit-log-service","userId":"99325fce-cba9-487c-925d-1f3e82c639fa","eventType":"all_sessions_revoked","ipAddress":"::1","hasMetadata":false,"msg":"Security event logged"}
{"level":30,"time":1768250510795,"env":"test","module":"auth-service","tokenHash":"45b05a41d997f0e3ba8d50ec306f05cd4fed7f05edcdc081a945f2d3d179889c","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mMixed Auth Scenarios[2m > [22m[2mshould handle request with both Bearer token and cookies
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250510848,"env":"test","module":"user-credentials-repository","userId":"27fb28f2-fcfe-47b4-9e54-a99f6e144478","msg":"User credentials created"}
{"level":30,"time":1768250510944,"env":"test","module":"email-queue","jobId":"34250045-b13e-4eda-909b-c3eb130019e7","to":"middleware-test-7lbj_2BCh9615k_T14_gX@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250511001,"env":"test","module":"auth-routes","userId":"27fb28f2-fcfe-47b4-9e54-a99f6e144478","email":"middleware-test-7lbj_2BCh9615k_T14_gX@example.com","msg":"User registered"}
{"level":30,"time":1768250511019,"env":"test","module":"user-credentials-repository","userId":"2098f9b6-8de1-41da-90b3-a73ddf9fcb79","msg":"User credentials created"}
{"level":30,"time":1768250511020,"env":"test","module":"auth-service","tokenHash":"867edc38f5f3584feb64c1246541fc66616e03e284b35f6657378d1743d26717","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould return consistent error format for invalid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":40,"time":1768250511067,"env":"test","module":"auth-service","userId":"99325fce-cba9-487c-925d-1f3e82c639fa","tokenHash":"867edc38f5f3584feb64c1246541fc66616e03e284b35f6657378d1743d26717","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768250511120,"env":"test","module":"auth-service","tokenHash":"55d832b01094bfc4888b22850012cf815d189d26966973fdb6cb55a4ca02a544","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250511124,"env":"test","module":"email-queue","jobId":"8d50b2d1-646d-448f-9229-aa4f83e0ff1b","to":"jwt-test-5xSb6K_FHS8PJvDDBFkFf@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":40,"time":1768250511172,"env":"test","module":"auth-service","userId":"99325fce-cba9-487c-925d-1f3e82c639fa","tokenHash":"55d832b01094bfc4888b22850012cf815d189d26966973fdb6cb55a4ca02a544","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768250511179,"env":"test","module":"auth-routes","userId":"2098f9b6-8de1-41da-90b3-a73ddf9fcb79","email":"jwt-test-5xSb6K_FHS8PJvDDBFkFf@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould detect token reuse and revoke all user tokens
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250511336,"env":"test","module":"auth-routes","userId":"add3653e-0b0f-4a2b-be08-cc380f2bb3b9","msg":"User logged in successfully"}
{"level":30,"time":1768250511389,"env":"test","module":"audit-log-service","userId":"add3653e-0b0f-4a2b-be08-cc380f2bb3b9","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mMixed Auth Scenarios[2m > [22m[2mshould handle request with both Bearer token and cookies
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250511526,"env":"test","module":"auth-routes","userId":"27fb28f2-fcfe-47b4-9e54-a99f6e144478","msg":"User logged in successfully"}
{"level":30,"time":1768250511573,"env":"test","module":"audit-log-service","userId":"27fb28f2-fcfe-47b4-9e54-a99f6e144478","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768250511577,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250511603,"env":"test","module":"user-credentials-repository","userId":"ab759227-e6a8-4e55-a2e4-3b4d8b4e78cb","msg":"User credentials created"}
{"level":30,"time":1768250511705,"env":"test","module":"email-queue","jobId":"dbd31252-4eee-4f78-9a61-a2714643f12b","to":"session-test-818vwEQfqabCMLc8tGU-c@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250511712,"env":"test","module":"auth-routes","userId":"2098f9b6-8de1-41da-90b3-a73ddf9fcb79","msg":"User logged in successfully"}
{"level":30,"time":1768250511768,"env":"test","module":"audit-log-service","userId":"2098f9b6-8de1-41da-90b3-a73ddf9fcb79","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mToken Refresh Flow[2m > [22m[2mshould detect token reuse and revoke all user tokens
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250511782,"env":"test","module":"auth-routes","userId":"ab759227-e6a8-4e55-a2e4-3b4d8b4e78cb","email":"session-test-818vwEQfqabCMLc8tGU-c@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all trusted devices
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250511905,"env":"test","module":"auth-routes","userId":"add3653e-0b0f-4a2b-be08-cc380f2bb3b9","msg":"User logged in successfully"}
{"level":30,"time":1768250511949,"env":"test","module":"user-credentials-repository","userId":"904d6cd5-4837-4a16-9763-132f6e796a02","msg":"User credentials created"}
{"level":30,"time":1768250511954,"env":"test","module":"audit-log-service","userId":"add3653e-0b0f-4a2b-be08-cc380f2bb3b9","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250512048,"env":"test","module":"email-queue","jobId":"63b40736-285e-4465-bc96-7d9a2a13fe91","to":"middleware-test-Ez5tqn4oyOxzpfOT1E1wu@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250512099,"env":"test","module":"auth-routes","userId":"904d6cd5-4837-4a16-9763-132f6e796a02","email":"middleware-test-Ez5tqn4oyOxzpfOT1E1wu@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould return consistent error format for expired token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250512237,"env":"test","module":"auth-routes","userId":"2098f9b6-8de1-41da-90b3-a73ddf9fcb79","msg":"User logged in successfully"}
{"level":30,"time":1768250512285,"env":"test","module":"audit-log-service","userId":"2098f9b6-8de1-41da-90b3-a73ddf9fcb79","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250512288,"env":"test","module":"auth-service","tokenHash":"ffce6de31455cdc165a54f7d8e88e32bc5183c17d98123761f7ed1a75a987174","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250512348,"env":"test","module":"auth-routes","userId":"ab759227-e6a8-4e55-a2e4-3b4d8b4e78cb","msg":"User logged in successfully"}
{"level":30,"time":1768250512380,"env":"test","module":"user-credentials-repository","userId":"68c2ee89-8c43-4f70-a317-63d5da4045d6","msg":"User credentials created"}
{"level":30,"time":1768250512407,"env":"test","module":"audit-log-service","userId":"ab759227-e6a8-4e55-a2e4-3b4d8b4e78cb","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250512482,"env":"test","module":"email-queue","jobId":"40d95a98-2ec3-4909-8c40-60aea96609a9","to":"protected-test-hJTiShOV_Fkqi6_efH8rc@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250512506,"env":"test","module":"auth-service","tokenHash":"ffce6de31455cdc165a54f7d8e88e32bc5183c17d98123761f7ed1a75a987174","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250512533,"env":"test","module":"auth-routes","userId":"68c2ee89-8c43-4f70-a317-63d5da4045d6","email":"protected-test-hJTiShOV_Fkqi6_efH8rc@example.com","msg":"User registered"}
{"level":40,"time":1768250512561,"env":"test","module":"auth-service","userId":"2098f9b6-8de1-41da-90b3-a73ddf9fcb79","tokenHash":"ffce6de31455cdc165a54f7d8e88e32bc5183c17d98123761f7ed1a75a987174","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768250512567,"env":"test","module":"auth-routes","userId":"ab759227-e6a8-4e55-a2e4-3b4d8b4e78cb","deviceFingerprint":"377ad01217b8c93ca52518d515505c47ab7553fab66d6fddaa60af67802c5a4c","msg":"Device marked as trusted"}
{"level":30,"time":1768250512615,"env":"test","module":"auth-routes","userId":"904d6cd5-4837-4a16-9763-132f6e796a02","msg":"User logged in successfully"}
{"level":30,"time":1768250512619,"env":"test","module":"auth-service","tokenHash":"f43f4922e2d8ebd46c98126b38638e4dd6dbf49984f6ace91040cb0b862f51cf","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mMixed Auth Scenarios[2m > [22m[2mshould prioritize Bearer token over cookie when both present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250512668,"env":"test","module":"audit-log-service","userId":"904d6cd5-4837-4a16-9763-132f6e796a02","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768250512674,"env":"test","module":"auth-service","userId":"2098f9b6-8de1-41da-90b3-a73ddf9fcb79","tokenHash":"f43f4922e2d8ebd46c98126b38638e4dd6dbf49984f6ace91040cb0b862f51cf","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768250512723,"env":"test","module":"auth-routes","userId":"ab759227-e6a8-4e55-a2e4-3b4d8b4e78cb","msg":"All other sessions revoked"}
{"level":30,"time":1768250512775,"env":"test","module":"audit-log-service","userId":"ab759227-e6a8-4e55-a2e4-3b4d8b4e78cb","eventType":"all_sessions_revoked","ipAddress":"::1","hasMetadata":false,"msg":"Security event logged"}
{"level":30,"time":1768250512881,"env":"test","module":"auth-routes","userId":"ab759227-e6a8-4e55-a2e4-3b4d8b4e78cb","deviceCount":0,"msg":"Listed trusted devices"}
{"level":30,"time":1768250513106,"env":"test","module":"user-credentials-repository","userId":"ab1903d4-682e-4843-b003-dd2be6987891","msg":"User credentials created"}
{"level":30,"time":1768250513144,"env":"test","module":"auth-routes","userId":"68c2ee89-8c43-4f70-a317-63d5da4045d6","msg":"User logged in successfully"}
{"level":30,"time":1768250513194,"env":"test","module":"audit-log-service","userId":"68c2ee89-8c43-4f70-a317-63d5da4045d6","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mMixed Auth Scenarios[2m > [22m[2mshould prioritize Bearer token over cookie when both present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250513203,"env":"test","module":"email-queue","jobId":"8a88b410-d8f9-4bc3-850d-ad9b0f1ee867","to":"jwt-test-4nW0EQQcz83NMFxLBUhL9@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250513253,"env":"test","module":"auth-routes","userId":"ab1903d4-682e-4843-b003-dd2be6987891","email":"jwt-test-4nW0EQQcz83NMFxLBUhL9@example.com","msg":"User registered"}
{"level":30,"time":1768250513259,"env":"test","module":"user-credentials-repository","userId":"c6ab68e2-447e-454a-b808-94f4c36379d4","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mLogout Flow[2m > [22m[2mshould revoke refresh token on logout
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250513361,"env":"test","module":"email-queue","jobId":"785b6daf-efff-445a-b830-ecb3c8615375","to":"session-test-Y0eLLzI_FLHETQgf5Nx8h@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250513415,"env":"test","module":"auth-routes","userId":"c6ab68e2-447e-454a-b808-94f4c36379d4","email":"session-test-Y0eLLzI_FLHETQgf5Nx8h@example.com","msg":"User registered"}
{"level":50,"time":1768250513525,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250513709,"env":"test","module":"auth-routes","userId":"68c2ee89-8c43-4f70-a317-63d5da4045d6","msg":"User logged in successfully"}
{"level":30,"time":1768250513763,"env":"test","module":"audit-log-service","userId":"68c2ee89-8c43-4f70-a317-63d5da4045d6","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768250513773,"env":"test","module":"auth-middleware","error":{"name":"TokenExpiredError","code":"AUTH_002","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768250513773,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250513788,"env":"test","module":"auth-routes","userId":"ab1903d4-682e-4843-b003-dd2be6987891","msg":"User logged in successfully"}
{"level":30,"time":1768250513837,"env":"test","module":"audit-log-service","userId":"ab1903d4-682e-4843-b003-dd2be6987891","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250513892,"env":"test","module":"auth-service","tokenHash":"5707a93a0deb0e43a2017d3f416ac656962630526892a6ce574eae9b43823f21","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250513907,"env":"test","module":"user-credentials-repository","userId":"8dd260eb-874b-42ae-9505-c4427e8fdb60","msg":"User credentials created"}
{"level":40,"time":1768250513948,"env":"test","module":"auth-service","userId":"ab1903d4-682e-4843-b003-dd2be6987891","tokenHash":"5707a93a0deb0e43a2017d3f416ac656962630526892a6ce574eae9b43823f21","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768250514003,"env":"test","module":"email-queue","jobId":"96eae4cd-d867-41d9-bb06-8d37699acbbb","to":"session-test-CDUQmKrcmbHABbFfqHpNv@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250514057,"env":"test","module":"auth-routes","userId":"8dd260eb-874b-42ae-9505-c4427e8fdb60","email":"session-test-CDUQmKrcmbHABbFfqHpNv@example.com","msg":"User registered"}
{"level":30,"time":1768250514130,"env":"test","module":"user-credentials-repository","userId":"14a61ad5-11c3-47e4-ae75-262c2421f4fe","msg":"User credentials created"}
{"level":30,"time":1768250514157,"env":"test","module":"user-credentials-repository","userId":"33508721-e507-49da-b975-285eb4dd4380","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Expiration[2m > [22m[2mshould reject refresh token after 30 days
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250514224,"env":"test","module":"email-queue","jobId":"aec02e5d-b93d-47b4-8f44-2dd40ba0c431","to":"user2-xE6wtDqkHE-NwcoYT027O@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250514255,"env":"test","module":"email-queue","jobId":"184b6d1c-5a03-45af-9643-0c3aa2b71682","to":"middleware-test-JbcigECkjtNMncqEhjEZd@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250514273,"env":"test","module":"auth-routes","userId":"14a61ad5-11c3-47e4-ae75-262c2421f4fe","email":"user2-xE6wtDqkHE-NwcoYT027O@example.com","msg":"User registered"}
{"level":30,"time":1768250514307,"env":"test","module":"auth-routes","userId":"33508721-e507-49da-b975-285eb4dd4380","email":"middleware-test-JbcigECkjtNMncqEhjEZd@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mMixed Auth Scenarios[2m > [22m[2mshould prioritize Bearer token over cookie when both present
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould handle malformed JWT gracefully
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250514370,"env":"test","module":"user-credentials-repository","userId":"bd53d38f-2be2-4b31-9d4c-ebbf7f5baf03","msg":"User credentials created"}
{"level":30,"time":1768250514468,"env":"test","module":"email-queue","jobId":"4d254b4c-576f-4c69-8328-10071b111c9d","to":"jwt-test-iSpsJIziRNgRf8Sg0JkMW@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250514517,"env":"test","module":"auth-routes","userId":"bd53d38f-2be2-4b31-9d4c-ebbf7f5baf03","email":"jwt-test-iSpsJIziRNgRf8Sg0JkMW@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts[2m > [22m[2mJWT Authentication Integration Tests[2m > [22m[2mLogout Flow[2m > [22m[2mshould clear refresh token cookie on logout
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250514627,"env":"test","module":"auth-routes","userId":"8dd260eb-874b-42ae-9505-c4427e8fdb60","msg":"User logged in successfully"}
{"level":30,"time":1768250514675,"env":"test","module":"audit-log-service","userId":"8dd260eb-874b-42ae-9505-c4427e8fdb60","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250514780,"env":"test","module":"auth-service","tokenHash":"0fe3f42166c5f8ecef30ffc71d8a214b99fe468eedc01d2aa128067969b17119","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250514792,"env":"test","module":"auth-routes","userId":"14a61ad5-11c3-47e4-ae75-262c2421f4fe","msg":"User logged in successfully"}
{"level":30,"time":1768250514811,"env":"test","module":"auth-routes","userId":"33508721-e507-49da-b975-285eb4dd4380","msg":"User logged in successfully"}
{"level":40,"time":1768250514829,"env":"test","module":"auth-service","userId":"8dd260eb-874b-42ae-9505-c4427e8fdb60","msg":"Security: Expired refresh token used"}
{"level":30,"time":1768250514840,"env":"test","module":"audit-log-service","userId":"14a61ad5-11c3-47e4-ae75-262c2421f4fe","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250514858,"env":"test","module":"audit-log-service","userId":"33508721-e507-49da-b975-285eb4dd4380","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768250514862,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768250514862,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250515030,"env":"test","module":"auth-routes","userId":"bd53d38f-2be2-4b31-9d4c-ebbf7f5baf03","msg":"User logged in successfully"}
{"level":30,"time":1768250515080,"env":"test","module":"audit-log-service","userId":"bd53d38f-2be2-4b31-9d4c-ebbf7f5baf03","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250515199,"env":"test","module":"user-credentials-repository","userId":"2db95b65-cc38-44f0-a761-f2fea87d7351","msg":"User credentials created"}
{"level":30,"time":1768250515233,"env":"test","module":"user-credentials-repository","userId":"930c27fb-0ce0-4ad1-862c-0c0d30c70d49","msg":"User credentials created"}
{"level":30,"time":1768250515301,"env":"test","module":"email-queue","jobId":"9d45c90d-cdb2-4458-be3b-613a543ab7ca","to":"session-test-8pNy5z4GKbR1whTJCD-V2@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250515311,"env":"test","module":"user-credentials-repository","userId":"9bc9141c-e465-439b-851a-305596a38e4a","msg":"User credentials created"}
{"level":30,"time":1768250515328,"env":"test","module":"email-queue","jobId":"3e4f056b-fc50-41d6-9e42-5ced11088da4","to":"middleware-test-bfLqhJI8MTUeFMoKyjtVP@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250515350,"env":"test","module":"auth-routes","userId":"2db95b65-cc38-44f0-a761-f2fea87d7351","email":"session-test-8pNy5z4GKbR1whTJCD-V2@example.com","msg":"User registered"}
{"level":30,"time":1768250515394,"env":"test","module":"auth-routes","userId":"930c27fb-0ce0-4ad1-862c-0c0d30c70d49","email":"middleware-test-bfLqhJI8MTUeFMoKyjtVP@example.com","msg":"User registered"}
{"level":30,"time":1768250515412,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250515412,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768250515413,"env":"test","module":"email-queue","jobId":"f9a98426-39b1-4c39-b008-0938f732c4ca","to":"protected-test-MLbKR8TJjdPlDZ2R0wHmt@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts[2m > [22m[2mAuth Middleware Integration Tests[2m > [22m[2mError Handling[2m > [22m[2mshould handle JWT with wrong algorithm
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250515471,"env":"test","module":"auth-routes","userId":"9bc9141c-e465-439b-851a-305596a38e4a","email":"protected-test-MLbKR8TJjdPlDZ2R0wHmt@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mConcurrent Session Handling[2m > [22m[2mshould handle multiple concurrent logins
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mConcurrent Session Handling[2m > [22m[2mshould handle multiple concurrent logins
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mConcurrent Session Handling[2m > [22m[2mshould handle multiple concurrent logins
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mOptional Auth Routes[2m > [22m[2mshould allow unauthenticated access to optional auth routes
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/jwt.authentication.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w7_59d7d948

 [32mÎ“Â£Ã´[39m tests/integration/auth/jwt.authentication.test.ts [2m([22m[2m27 tests[22m[2m)[22m[33m 93269[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should generate valid JWT token on successful login [33m 1173[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should include correct payload in JWT token [33m 1115[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set JWT expiry to 15 minutes [33m 1126[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should accept valid JWT token on protected routes [33m 1221[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should accept request with missing Bearer prefix (lenient) [33m 1215[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject expired JWT token [33m 1105[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return token_expired error code for expired tokens [33m 1104[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should exchange valid session cookie for JWT token [33m 692[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prefer Bearer token over cookie when both present [33m 1146[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should fall back to cookie if Bearer token is invalid [33m 558[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow GET requests with cookie auth only [33m 1251[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject POST requests with cookie auth only (mutation-strict) [33m 525[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow anonymous access to public workflows [33m 462[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should attach user info if authenticated on optional auth routes [33m 445[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should refresh access token using refresh token [33m 2295[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should rotate refresh token on use [33m 1516[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should detect token reuse and revoke all user tokens [33m 2073[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke refresh token on logout [33m 1273[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should clear refresh token cookie on logout [33m 1134[2mms[22m[39m
{"level":30,"time":1768250515903,"env":"test","module":"auth-routes","userId":"930c27fb-0ce0-4ad1-862c-0c0d30c70d49","msg":"User logged in successfully"}
{"level":30,"time":1768250515953,"env":"test","module":"audit-log-service","userId":"930c27fb-0ce0-4ad1-862c-0c0d30c70d49","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768250515957,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768250515957,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768250515967,"env":"test","module":"auth-routes","userId":"2db95b65-cc38-44f0-a761-f2fea87d7351","msg":"User logged in successfully"}
{"level":30,"time":1768250516018,"env":"test","module":"audit-log-service","userId":"2db95b65-cc38-44f0-a761-f2fea87d7351","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250516085,"env":"test","module":"auth-routes","userId":"9bc9141c-e465-439b-851a-305596a38e4a","msg":"User logged in successfully"}
{"level":30,"time":1768250516131,"env":"test","module":"audit-log-service","userId":"9bc9141c-e465-439b-851a-305596a38e4a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250516218,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250516218,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768250516272,"env":"test","module":"auth-routes","userId":"2db95b65-cc38-44f0-a761-f2fea87d7351","msg":"User logged in successfully"}
{"level":30,"time":1768250516280,"env":"test","module":"auth-routes","userId":"2db95b65-cc38-44f0-a761-f2fea87d7351","msg":"User logged in successfully"}
{"level":30,"time":1768250516325,"env":"test","module":"audit-log-service","userId":"2db95b65-cc38-44f0-a761-f2fea87d7351","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250516331,"env":"test","module":"audit-log-service","userId":"2db95b65-cc38-44f0-a761-f2fea87d7351","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/auth.middleware.integration.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w1_dce3d1e3

 [31mÎ“Â¥Â»[39m tests/integration/auth/auth.middleware.integration.test.ts [2m([22m[2m27 tests[22m[2m | [22m[31m4 failed[39m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 94086[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow access with valid JWT Bearer token[39m[33m 939[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 when no token provided [33m 1093[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 401 with invalid token[39m[33m 909[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 401 with expired token[39m[33m 916[2mms[22m[39m
       [2m[90mÎ“Ã¥Ã´[39m[22m should proceed without authentication if no token provided
       [33m[2mÎ“Â£Ã´[22m[39m should authenticate with JWT Bearer token [33m 1826[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should authenticate with refresh token cookie (GET only) [33m 1259[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject cookie auth for POST requests (mutation-strict)[39m[33m 920[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject cookie auth for PUT requests [33m 1090[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject cookie auth for DELETE requests [33m 1089[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow cookie auth for HEAD requests [33m 1909[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prioritize JWT over cookie when both present [33m 2277[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 when no auth provided [33m 1115[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 401 when both JWT and cookie are invalid [33m 1086[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should authenticate with JWT if provided [33m 1634[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should authenticate with cookie if JWT not provided [33m 1562[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should proceed anonymously if no auth provided [33m 1599[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should proceed anonymously if both JWT and cookie are invalid [33m 1607[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should only allow safe methods for cookie auth [33m 1272[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should ignore cookies when Bearer token present [33m 2260[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should attach userId to request [33m 1200[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should attach userEmail to request [33m 1171[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return consistent error format for missing token [33m 1081[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return consistent error format for invalid token [33m 1108[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return consistent error format for expired token [33m 2197[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle malformed JWT gracefully [33m 1088[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle JWT with wrong algorithm [33m 1095[2mms[22m[39m
{"level":30,"time":1768250516649,"env":"test","module":"intake-service","runId":"ea3e524a-afe3-451e-997e-9dd6a799528d","slug":"public-1kYnZDEXY6uAlyAi6Dp9W","msg":"Created intake run"}
{"level":30,"time":1768250516760,"env":"test","module":"user-credentials-repository","userId":"7d29d673-68ce-4ae1-b35f-7ca86089945b","msg":"User credentials created"}
{"level":30,"time":1768250516871,"env":"test","module":"email-queue","jobId":"4849baa2-b5f1-4fd7-98b0-301c773edc69","to":"session-test-aRjy3EmMMhkhIQmjtTyPd@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250516920,"env":"test","module":"auth-routes","userId":"7d29d673-68ce-4ae1-b35f-7ca86089945b","email":"session-test-aRjy3EmMMhkhIQmjtTyPd@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mConcurrent Session Handling[2m > [22m[2mshould handle concurrent token refreshes
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250517078,"env":"test","module":"user-credentials-repository","userId":"d2c76d7e-b94a-42cf-97a1-43101d16a09f","msg":"User credentials created"}
{"level":30,"time":1768250517179,"env":"test","module":"email-queue","jobId":"eae59b92-86cd-4b86-94ca-17adc1141e3f","to":"protected-test-lwOd8EGn2k2E0jgG-SSZw@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768250517227,"env":"test","module":"auth-routes","userId":"d2c76d7e-b94a-42cf-97a1-43101d16a09f","email":"protected-test-lwOd8EGn2k2E0jgG-SSZw@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mOptional Auth Routes[2m > [22m[2mshould enhance optional auth routes with user context when authenticated
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768250517498,"env":"test","module":"auth-routes","userId":"7d29d673-68ce-4ae1-b35f-7ca86089945b","msg":"User logged in successfully"}
{"level":30,"time":1768250517546,"env":"test","module":"audit-log-service","userId":"7d29d673-68ce-4ae1-b35f-7ca86089945b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768250517549,"env":"test","module":"auth-service","tokenHash":"9fc02ca14d0dcf95a60dc075f9f91659c05015b58888736b275ef34f41e68c85","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250517749,"env":"test","module":"auth-service","tokenHash":"9fc02ca14d0dcf95a60dc075f9f91659c05015b58888736b275ef34f41e68c85","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768250517797,"env":"test","module":"auth-service","userId":"7d29d673-68ce-4ae1-b35f-7ca86089945b","tokenHash":"9fc02ca14d0dcf95a60dc075f9f91659c05015b58888736b275ef34f41e68c85","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768250517838,"env":"test","module":"auth-routes","userId":"d2c76d7e-b94a-42cf-97a1-43101d16a09f","msg":"User logged in successfully"}
{"level":30,"time":1768250517848,"env":"test","module":"auth-service","tokenHash":"e879df4d8b7da7c185c04ac2e776e278bd9672928540ae5072fb1b69bf5ecb76","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768250517886,"env":"test","module":"audit-log-service","userId":"d2c76d7e-b94a-42cf-97a1-43101d16a09f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768250517895,"env":"test","module":"auth-service","userId":"7d29d673-68ce-4ae1-b35f-7ca86089945b","tokenHash":"e879df4d8b7da7c185c04ac2e776e278bd9672928540ae5072fb1b69bf5ecb76","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768250518200,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250518200,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768250518369,"env":"test","module":"intake-service","runId":"28656335-1da0-4c8b-b7b6-8c63d6b24263","slug":"optional--6qHhZ7oqJuaTv2cZc3Qg","userId":"d2c76d7e-b94a-42cf-97a1-43101d16a09f","msg":"Created intake run"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w2_1353c25f

 [32mÎ“Â£Ã´[39m tests/integration/auth/session.management.integration.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 96064[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should create refresh token on login [33m 1221[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should track device metadata in session [33m 1208[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should create separate sessions for multiple device logins [33m 2919[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should list all active sessions for user [33m 2331[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should mark current session correctly [33m 1820[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not include revoked sessions [33m 2047[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should order sessions by last used (most recent first) [33m 2488[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 628[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke specific session [33m 2020[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prevent revoking current session [33m 1372[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not allow revoking other users sessions [33m 2443[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 404 for non-existent session ID [33m 1184[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke all sessions except current [33m 2842[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke all trusted devices [33m 1658[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require active session [33m 644[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject refresh token after 30 days [33m 1304[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle multiple concurrent logins [33m 1553[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle concurrent token refreshes [33m 1560[2mms[22m[39m
{"level":30,"time":1768250518898,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768250518899,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w0_ced6369a

 [31mÎ“Â¥Â»[39m tests/integration/auth/protected.routes.test.ts [2m([22m[2m33 tests[22m[2m | [22m[31m5 failed[39m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 96778[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow access with valid Bearer token[39m[33m 905[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject access without Authorization header[39m[33m 865[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject access with empty Bearer token [33m 1195[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject access with malformed Authorization header [33m 1167[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject access with wrong token type [33m 1773[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow POST with valid Bearer token[39m[33m 838[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject POST without Bearer token [33m 1170[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should reject POST with invalid token[39m[33m 849[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should allow PUT with valid Bearer token[39m[33m 852[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject PUT without Bearer token [33m 1418[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow DELETE with valid Bearer token [33m 1352[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject DELETE without Bearer token [33m 1182[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow PATCH with valid Bearer token [33m 1835[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject PATCH without Bearer token [33m 1150[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle Bearer token with extra spaces [33m 1817[2mms[22m[39m
       [2m[90mÎ“Ã¥Ã´[39m[22m should handle token with newlines
       [33m[2mÎ“Â£Ã´[22m[39m should handle very long invalid token [33m 1193[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle empty Authorization header [33m 1196[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle Authorization header with only Bearer [33m 1194[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle multiple Authorization headers [33m 1197[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject token with SQL injection attempt [33m 1143[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject token with XSS attempt [33m 1174[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject token with missing userId [33m 1189[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject token with non-existent userId [33m 1291[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not allow user to access another user's resources [33m 2329[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should inject userId into request context [33m 1200[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should inject tenantId into request context [33m 1213[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should inject role into request context [33m 1209[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not apply general rate limiting to authenticated requests [33m 1618[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle request with both Bearer token and cookies [33m 1801[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prioritize Bearer token over cookie when both present [33m 2935[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow unauthenticated access to optional auth routes [33m 1756[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should enhance optional auth routes with user context when authenticated [33m 1775[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 28 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Complete Registration Î“Ã¥Ã† Login Flow > should complete registration, verify email, then login
AssertionError: expected 401 to be 403 // Object.is equality

- Expected
+ Received

- 403
+ 401

 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:55:36
     53|         .send({ email, password });
     54| 
     55|       expect(loginAttempt1.status).toBe(403);
       |                                    ^
     56|       expect(loginAttempt1.body.message || loginAttempt1.body.error).tÎ“Ã‡Âª
     57| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/28]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should lock account after 5 failed attempts, then unlock after waiting
AssertionError: expected 401 to be 423 // Object.is equality

- Expected
+ Received

- 423
+ 401

 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:110:36
    108|         });
    109| 
    110|       expect(lockedAttempt.status).toBe(423);
       |                                    ^
    111|       expect(lockedAttempt.body.message || lockedAttempt.body.error).tÎ“Ã‡Âª
    112| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/28]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Account Lockout Flow > should record all login attempts
AssertionError: expected 3 to be 2 // Object.is equality

- Expected
+ Received

- 2
+ 3

 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:146:58
    144| 
    145|       expect(attempts.length).toBe(3);
    146|       expect(attempts.filter(a => !a.successful).length).toBe(2);
       |                                                          ^
    147|       expect(attempts.filter(a => a.successful).length).toBe(1);
    148|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/28]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > MFA Enrollment and Login Flow > should complete MFA setup and login with TOTP
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:167:36
    165|         .set("Authorization", `Bearer ${token}`);
    166| 
    167|       expect(setupResponse.status).toBe(200);
       |                                    ^
    168|       expect(setupResponse.body.qrCodeDataUrl).toBeDefined();
    169|       expect(setupResponse.body.backupCodes).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/28]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > MFA Enrollment and Login Flow > should login with backup code when TOTP unavailable
TypeError: Cannot read properties of undefined (reading 'secret')
 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:248:52
    246|       });
    247| 
    248|       const totpCode = generateTotpCode(mfaSecret!.secret);
       |                                                    ^
    249| 
    250|       await request(app)

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/28]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Password Reset Flow > should complete full password reset flow
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:346:39
    344|         .send({ email, password: newPassword });
    345| 
    346|       expect(newPasswordLogin.status).toBe(200);
       |                                       ^
    347|       expect(newPasswordLogin.body.token).toBeDefined();
    348|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/28]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Token Refresh Flow > should rotate refresh token on each use
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:415:40
    413|           .set('Cookie', refreshTokenCookie!);
    414| 
    415|         expect(refreshResponse.status).toBe(200);
       |                                        ^
    416|         expect(refreshResponse.body.token).toBeDefined();
    417| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[7/28]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Token Refresh Flow > should detect and prevent refresh token reuse (token theft)
TypeError: Cannot read properties of undefined (reading 'find')
 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:438:44
    436| 
    437|       const cookies = loginResponse.headers['set-cookie'] as unknown aÎ“Ã‡Âª
    438|       const originalRefreshToken = cookies.find(c => c.startsWith('refÎ“Ã‡Âª
       |                                            ^
    439| 
    440|       // Use token once (rotation happens)

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[8/28]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Session Management Flow > should list all active sessions
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:492:39
    490|         .set("Authorization", `Bearer ${token}`);
    491| 
    492|       expect(sessionsResponse.status).toBe(200);
       |                                       ^
    493|       expect(sessionsResponse.body.sessions).toBeDefined();
    494|       expect(sessionsResponse.body.sessions.length).toBeGreaterThanOrEÎ“Ã‡Âª

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[9/28]Î“Ã„Â»

 FAIL  tests/integration/auth.flows.real.test.ts > Auth Flows Integration Tests (REAL) > Session Management Flow > should revoke specific session
TypeError: Cannot read properties of undefined (reading 'find')
 Î“Â¥Â» tests/integration/auth.flows.real.test.ts:517:40
    515| 
    516|       const sessions = sessionsResponse.body.sessions;
    517|       const sessionToRevoke = sessions.find((s: any) => !s.current);
       |                                        ^
    518| 
    519|       // Revoke first session

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[10/28]Î“Ã„Â»

 FAIL  tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should return 403 for unverified email
AssertionError: expected 401 to be 403 // Object.is equality

- Expected
+ Received

- 403
+ 401

 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:192:31
    190|         .send({ email, password });
    191| 
    192|       expect(response.status).toBe(403);
       |                               ^
    193|       expect(response.body.message || response.body.error).toBeDefinedÎ“Ã‡Âª
    194|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[11/28]Î“Ã„Â»

 FAIL  tests/integration/auth.routes.real.test.ts > Auth Routes Integration Tests (REAL) > POST /api/auth/login > should return requiresMfa=true for MFA-enabled users
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth.routes.real.test.ts:223:31
    221|         .send({ email, password });
    222| 
    223|       expect(response.status).toBe(200);
       |                               ^
    224|       expect(response.body.requiresMfa).toBe(true);
    225|       expect(response.body.userId).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[12/28]Î“Ã„Â»

 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should allow access with valid JWT Bearer token
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should return 401 with invalid token
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > requireAuth Middleware > should return 401 with expired token
 FAIL  tests/integration/auth/auth.middleware.integration.test.ts > Auth Middleware Integration Tests > hybridAuth Middleware > should reject cookie auth for POST requests (mutation-strict)
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth/auth.middleware.integration.test.ts:82:33
     80|         }
     81| 
     82|         expect(loginRes.status).toBe(200);
       |                                 ^
     83| 
     84|         userToken = loginRes.body.token;

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[13/28]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > Trusted Devices Management > DELETE /api/auth/trusted-devices/:deviceId > should revoke a trusted device
AssertionError: expected 404 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 404

 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:521:33
    519|           .set('Authorization', `Bearer ${authToken}`);
    520| 
    521|         expect(response.status).toBe(200);
       |                                 ^
    522|         expect(response.body.message).toBe('Device revoked successfullÎ“Ã‡Âª
    523| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[14/28]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.sessions.test.ts > OAuth2 Session Management > Session Metadata Tracking > should update lastUsedAt on token refresh
AssertionError: expected +0 to be 1 // Object.is equality

- Expected
+ Received

- 1
+ 0

 Î“Â¥Â» tests/integration/auth/oauth2.sessions.test.ts:590:31
    588|         ));
    589| 
    590|       expect(sessions.length).toBe(1);
       |                               ^
    591|       expect(sessions[0].lastUsedAt).toBeDefined();
    592|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[15/28]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > POST /api/auth/refresh-token > should rotate refresh token after use
AssertionError: expected undefined to be true // Object.is equality

- Expected: 
true

+ Received: 
undefined

 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:134:33
    132|         where: eq(refreshTokens.token, hashToken(testRefreshToken)),
    133|       });
    134|       expect(oldToken?.revoked).toBe(true);
       |                                 ^
    135| 
    136|       // New token should exist and not be revoked

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[16/28]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > POST /api/auth/refresh-token > should set proper cookie attributes
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:283:31
    281|         .set('Cookie', `refresh_token=${testRefreshToken}`);
    282| 
    283|       expect(response.status).toBe(200);
       |                               ^
    284| 
    285|       const setCookieHeader = response.headers['set-cookie']?.[0];

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[17/28]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > Refresh Token Lifecycle > should create refresh token on login
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:316:31
    314|         });
    315| 
    316|       expect(response.status).toBe(200);
       |                               ^
    317| 
    318|       // Verify refresh token cookie is set

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[18/28]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > Refresh Token Security > should prevent refresh token reuse after rotation
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:442:36
    440|         .set('Cookie', `refresh_token=${testRefreshToken}`);
    441| 
    442|       expect(firstResponse.status).toBe(200);
       |                                    ^
    443| 
    444|       // Try to reuse old token

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[19/28]Î“Ã„Â»

 FAIL  tests/integration/auth/oauth2.token-refresh.test.ts > OAuth2 Token Refresh Flow > Refresh Token Security > should validate token ownership
AssertionError: expected undefined to be 'YPpw3Fpyf20sr6T0mxihh' // Object.is equality

- Expected: 
"YPpw3Fpyf20sr6T0mxihh"

+ Received: 
undefined

 Î“Â¥Â» tests/integration/auth/oauth2.token-refresh.test.ts:475:29
    473|       });
    474| 
    475|       expect(token?.userId).toBe(testUserId);
       |                             ^
    476|       expect(token?.userId).not.toBe(otherUser.id);
    477|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[20/28]Î“Ã„Â»

 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should allow access with valid Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > GET Protected Routes > should reject access without Authorization header
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should allow POST with valid Bearer token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > POST Protected Routes > should reject POST with invalid token
 FAIL  tests/integration/auth/protected.routes.test.ts > Protected Routes Integration Tests > PUT Protected Routes > should allow PUT with valid Bearer token
Error: expected 200 "OK", got 401 "Unauthorized"
 Î“Â¥Â» tests/integration/auth/protected.routes.test.ts:80:14
     78|                 password: testUser.password,
     79|             })
     80|             .expect(200);
       |              ^
     81| 
     82|         userToken = loginRes.body.token;
 Î“Â¥Â» Test._assertStatus node_modules/supertest/lib/test.js:309:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:365:13
 Î“Â¥Â» Test._assertFunction node_modules/supertest/lib/test.js:342:13
 Î“Â¥Â» Test.assert node_modules/supertest/lib/test.js:195:23
 Î“Â¥Â» localAssert node_modules/supertest/lib/test.js:138:14
 Î“Â¥Â» node_modules/supertest/lib/test.js:156:7
 Î“Â¥Â» Test.Request.callback node_modules/superagent/lib/node/index.js:857:3
 Î“Â¥Â» node_modules/superagent/lib/node/index.js:1102:18
 Î“Â¥Â» IncomingMessage.<anonymous> node_modules/superagent/lib/node/parsers/json.js:21:7

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[21/28]Î“Ã„Â»


[2m Test Files [22m [1m[31m6 failed[39m[22m[2m | [22m[1m[32m6 passed[39m[22m[90m (12)[39m
[2m      Tests [22m [1m[31m28 failed[39m[22m[2m | [22m[1m[32m262 passed[39m[22m[2m | [22m[33m2 skipped[39m[90m (292)[39m
[2m   Start at [22m 14:40:13
[2m   Duration [22m 105.73s[2m (transform 15.71s, setup 2.86s, import 50.17s, tests 717.90s, environment 3ms)[22m

