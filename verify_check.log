npm warn Unknown project config "puppeteer_skip_download". This will stop working in the next major version of npm.
 DEPRECATED  `test.poolOptions` was removed in Vitest 4. All previous `poolOptions` are now top-level options. Please, refer to the migration guide: https://vitest.dev/guide/migration#pool-rework

[1m[44m DEV [49m[22m [34mv4.0.16 [39m[90mC:/Users/scoot/poll/VaultLogic[39m

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

{"level":30,"time":1767991323522,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

stderr | tests/integration/trusted.devices.real.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): Error: No file ./migrations/0008_flashy_jimmy_woo.sql found in ./migrations folder
    at readMigrationFiles (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/migrator.js:26:13)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:3:22)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:120:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for e2241920fb4b38c3a9e59bb2d0bf774f

{"level":30,"time":1767991325554,"env":"test","module":"auth-routes","userId":"e2241920fb4b38c3a9e59bb2d0bf774f","msg":"Login requires MFA verification"}
{"level":30,"time":1767991325661,"env":"test","module":"mfa-service","userId":"e2241920fb4b38c3a9e59bb2d0bf774f","msg":"TOTP verification successful"}
{"level":30,"time":1767991325710,"env":"test","module":"auth-routes","userId":"e2241920fb4b38c3a9e59bb2d0bf774f","msg":"MFA login successful"}
{"level":30,"time":1767991325867,"env":"test","module":"auth-routes","userId":"e2241920fb4b38c3a9e59bb2d0bf774f","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39m[TEST UTILS] MFA Secret verified for c6f1c1c0d813cde5d1cc585372fd8a90

{"level":30,"time":1767991327493,"env":"test","module":"auth-routes","userId":"c6f1c1c0d813cde5d1cc585372fd8a90","msg":"Login requires MFA verification"}
{"level":30,"time":1767991327595,"env":"test","module":"mfa-service","userId":"c6f1c1c0d813cde5d1cc585372fd8a90","msg":"TOTP verification successful"}
{"level":30,"time":1767991327642,"env":"test","module":"auth-routes","userId":"c6f1c1c0d813cde5d1cc585372fd8a90","msg":"MFA login successful"}
{"level":30,"time":1767991327813,"env":"test","module":"auth-routes","userId":"c6f1c1c0d813cde5d1cc585372fd8a90","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for 94ea1969f61d6b227f9ef6d71f86922c

{"level":30,"time":1767991329438,"env":"test","module":"auth-routes","userId":"94ea1969f61d6b227f9ef6d71f86922c","msg":"Login requires MFA verification"}
{"level":30,"time":1767991329541,"env":"test","module":"mfa-service","userId":"94ea1969f61d6b227f9ef6d71f86922c","msg":"TOTP verification successful"}
{"level":30,"time":1767991329587,"env":"test","module":"auth-routes","userId":"94ea1969f61d6b227f9ef6d71f86922c","msg":"MFA login successful"}
{"level":30,"time":1767991329739,"env":"test","module":"auth-routes","userId":"94ea1969f61d6b227f9ef6d71f86922c","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1767991330003,"env":"test","module":"auth-routes","userId":"94ea1969f61d6b227f9ef6d71f86922c","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Trusted device expiry updated"}
{"level":50,"time":1767991330472,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39m[TEST UTILS] MFA Secret verified for c86240e2b9c94fef109b55156cf41603

{"level":30,"time":1767991332007,"env":"test","module":"auth-routes","userId":"c86240e2b9c94fef109b55156cf41603","msg":"Login requires MFA verification"}
{"level":30,"time":1767991332102,"env":"test","module":"mfa-service","userId":"c86240e2b9c94fef109b55156cf41603","msg":"TOTP verification successful"}
{"level":30,"time":1767991332149,"env":"test","module":"auth-routes","userId":"c86240e2b9c94fef109b55156cf41603","msg":"MFA login successful"}
{"level":30,"time":1767991332300,"env":"test","module":"auth-routes","userId":"c86240e2b9c94fef109b55156cf41603","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1767991332753,"env":"test","module":"auth-routes","userId":"c86240e2b9c94fef109b55156cf41603","msg":"Login requires MFA verification"}
{"level":30,"time":1767991332854,"env":"test","module":"mfa-service","userId":"c86240e2b9c94fef109b55156cf41603","msg":"TOTP verification successful"}
{"level":30,"time":1767991332903,"env":"test","module":"auth-routes","userId":"c86240e2b9c94fef109b55156cf41603","msg":"MFA login successful"}
{"level":30,"time":1767991333051,"env":"test","module":"auth-routes","userId":"c86240e2b9c94fef109b55156cf41603","deviceFingerprint":"091366faa1882b5c8dc1cba02126615a77a378274bbfd3375e821aa38bdd1b4f","msg":"Device marked as trusted"}
{"level":30,"time":1767991333557,"env":"test","module":"auth-routes","userId":"c86240e2b9c94fef109b55156cf41603","msg":"Login requires MFA verification"}
{"level":30,"time":1767991333656,"env":"test","module":"mfa-service","userId":"c86240e2b9c94fef109b55156cf41603","msg":"TOTP verification successful"}
{"level":30,"time":1767991333703,"env":"test","module":"auth-routes","userId":"c86240e2b9c94fef109b55156cf41603","msg":"MFA login successful"}
{"level":30,"time":1767991333802,"env":"test","module":"auth-routes","userId":"c86240e2b9c94fef109b55156cf41603","deviceCount":2,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for c58c19e38b5c551709c010424d55228b

{"level":30,"time":1767991335341,"env":"test","module":"auth-routes","userId":"c58c19e38b5c551709c010424d55228b","msg":"Login requires MFA verification"}
{"level":30,"time":1767991335441,"env":"test","module":"mfa-service","userId":"c58c19e38b5c551709c010424d55228b","msg":"TOTP verification successful"}
{"level":30,"time":1767991335490,"env":"test","module":"auth-routes","userId":"c58c19e38b5c551709c010424d55228b","msg":"MFA login successful"}
{"level":30,"time":1767991335639,"env":"test","module":"auth-routes","userId":"c58c19e38b5c551709c010424d55228b","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1767991335735,"env":"test","module":"auth-routes","userId":"c58c19e38b5c551709c010424d55228b","deviceCount":1,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39m[TEST UTILS] MFA Secret verified for a250ceb3d0fe920bb18b25ad30e93c78

{"level":30,"time":1767991337289,"env":"test","module":"auth-routes","userId":"a250ceb3d0fe920bb18b25ad30e93c78","msg":"Login requires MFA verification"}
{"level":30,"time":1767991337389,"env":"test","module":"mfa-service","userId":"a250ceb3d0fe920bb18b25ad30e93c78","msg":"TOTP verification successful"}
{"level":30,"time":1767991337440,"env":"test","module":"auth-routes","userId":"a250ceb3d0fe920bb18b25ad30e93c78","msg":"MFA login successful"}
{"level":30,"time":1767991337590,"env":"test","module":"auth-routes","userId":"a250ceb3d0fe920bb18b25ad30e93c78","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1767991337737,"env":"test","module":"auth-routes","userId":"a250ceb3d0fe920bb18b25ad30e93c78","deviceCount":0,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for fc79e1c81bb3ac0a2ef540a0fd6210e5

{"level":30,"time":1767991339299,"env":"test","module":"auth-routes","userId":"fc79e1c81bb3ac0a2ef540a0fd6210e5","msg":"Login requires MFA verification"}
{"level":30,"time":1767991339408,"env":"test","module":"mfa-service","userId":"fc79e1c81bb3ac0a2ef540a0fd6210e5","msg":"TOTP verification successful"}
{"level":30,"time":1767991339458,"env":"test","module":"auth-routes","userId":"fc79e1c81bb3ac0a2ef540a0fd6210e5","msg":"MFA login successful"}
{"level":30,"time":1767991339611,"env":"test","module":"auth-routes","userId":"fc79e1c81bb3ac0a2ef540a0fd6210e5","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1767991339769,"env":"test","module":"auth-routes","userId":"fc79e1c81bb3ac0a2ef540a0fd6210e5","deviceCount":0,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for cd87cfe44b27766f9df22383fd3ae789

{"level":30,"time":1767991341319,"env":"test","module":"auth-routes","userId":"cd87cfe44b27766f9df22383fd3ae789","msg":"Login requires MFA verification"}
{"level":30,"time":1767991341420,"env":"test","module":"mfa-service","userId":"cd87cfe44b27766f9df22383fd3ae789","msg":"TOTP verification successful"}
{"level":30,"time":1767991341468,"env":"test","module":"auth-routes","userId":"cd87cfe44b27766f9df22383fd3ae789","msg":"MFA login successful"}
{"level":30,"time":1767991341614,"env":"test","module":"auth-routes","userId":"cd87cfe44b27766f9df22383fd3ae789","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1767991341714,"env":"test","module":"auth-routes","userId":"cd87cfe44b27766f9df22383fd3ae789","deviceCount":1,"msg":"Listed trusted devices"}
{"level":30,"time":1767991341867,"env":"test","module":"auth-routes","userId":"cd87cfe44b27766f9df22383fd3ae789","deviceId":"4455dca3-3bee-4fb8-87ac-4c12d6db5fba","msg":"Trusted device revoked"}
{"level":30,"time":1767991342014,"env":"test","module":"auth-routes","userId":"cd87cfe44b27766f9df22383fd3ae789","deviceCount":0,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39m[TEST UTILS] MFA Secret verified for ba4b55b8f52c713fd65617119d8443da

{"level":30,"time":1767991343556,"env":"test","module":"auth-routes","userId":"ba4b55b8f52c713fd65617119d8443da","msg":"Login requires MFA verification"}
{"level":30,"time":1767991343655,"env":"test","module":"mfa-service","userId":"ba4b55b8f52c713fd65617119d8443da","msg":"TOTP verification successful"}
{"level":30,"time":1767991343707,"env":"test","module":"auth-routes","userId":"ba4b55b8f52c713fd65617119d8443da","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 89ac83f0274d64a443e445244f720333

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for b3eccf769ed88846a2eb55b7a1d9ffb8

{"level":30,"time":1767991346021,"env":"test","module":"auth-routes","userId":"89ac83f0274d64a443e445244f720333","msg":"Login requires MFA verification"}
{"level":30,"time":1767991346121,"env":"test","module":"mfa-service","userId":"89ac83f0274d64a443e445244f720333","msg":"TOTP verification successful"}
{"level":30,"time":1767991346173,"env":"test","module":"auth-routes","userId":"89ac83f0274d64a443e445244f720333","msg":"MFA login successful"}
{"level":30,"time":1767991346319,"env":"test","module":"auth-routes","userId":"89ac83f0274d64a443e445244f720333","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1767991346421,"env":"test","module":"auth-routes","userId":"89ac83f0274d64a443e445244f720333","deviceCount":1,"msg":"Listed trusted devices"}
{"level":30,"time":1767991346872,"env":"test","module":"auth-routes","userId":"b3eccf769ed88846a2eb55b7a1d9ffb8","msg":"Login requires MFA verification"}
{"level":30,"time":1767991346969,"env":"test","module":"mfa-service","userId":"b3eccf769ed88846a2eb55b7a1d9ffb8","msg":"TOTP verification successful"}
{"level":30,"time":1767991347015,"env":"test","module":"auth-routes","userId":"b3eccf769ed88846a2eb55b7a1d9ffb8","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39m[TEST UTILS] MFA Secret verified for 67a4998f94548bbccce85f05510ca619

{"level":30,"time":1767991348706,"env":"test","module":"auth-routes","userId":"67a4998f94548bbccce85f05510ca619","msg":"Login requires MFA verification"}
{"level":30,"time":1767991348804,"env":"test","module":"mfa-service","userId":"67a4998f94548bbccce85f05510ca619","msg":"TOTP verification successful"}
{"level":30,"time":1767991348854,"env":"test","module":"auth-routes","userId":"67a4998f94548bbccce85f05510ca619","msg":"MFA login successful"}
{"level":30,"time":1767991349001,"env":"test","module":"auth-routes","userId":"67a4998f94548bbccce85f05510ca619","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1767991349515,"env":"test","module":"auth-routes","userId":"67a4998f94548bbccce85f05510ca619","msg":"Login from trusted device - MFA skipped"}
{"level":30,"time":1767991349568,"env":"test","module":"auth-routes","userId":"67a4998f94548bbccce85f05510ca619","msg":"User logged in successfully"}
{"level":30,"time":1767991349620,"env":"test","module":"audit-log-service","userId":"67a4998f94548bbccce85f05510ca619","eventType":"login_success","ipAddress":"192.168.1.100","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39m[TEST UTILS] MFA Secret verified for ebeb9513b0ed852910fcfedc9340a368

{"level":30,"time":1767991351194,"env":"test","module":"auth-routes","userId":"ebeb9513b0ed852910fcfedc9340a368","msg":"Login requires MFA verification"}
{"level":30,"time":1767991351296,"env":"test","module":"mfa-service","userId":"ebeb9513b0ed852910fcfedc9340a368","msg":"TOTP verification successful"}
{"level":30,"time":1767991351344,"env":"test","module":"auth-routes","userId":"ebeb9513b0ed852910fcfedc9340a368","msg":"MFA login successful"}
{"level":30,"time":1767991351496,"env":"test","module":"auth-routes","userId":"ebeb9513b0ed852910fcfedc9340a368","deviceFingerprint":"10fa3aea039bf6fec7b6bcb982cbed1cc6ab844dd3c0879bec32baefb2997b52","msg":"Device marked as trusted"}
{"level":30,"time":1767991351956,"env":"test","module":"auth-routes","userId":"ebeb9513b0ed852910fcfedc9340a368","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39m[TEST UTILS] MFA Secret verified for 7bdc111aa53965874a00096942fa71b9

{"level":30,"time":1767991353502,"env":"test","module":"auth-routes","userId":"7bdc111aa53965874a00096942fa71b9","msg":"Login requires MFA verification"}
{"level":30,"time":1767991353595,"env":"test","module":"mfa-service","userId":"7bdc111aa53965874a00096942fa71b9","msg":"TOTP verification successful"}
{"level":30,"time":1767991353642,"env":"test","module":"auth-routes","userId":"7bdc111aa53965874a00096942fa71b9","msg":"MFA login successful"}
{"level":30,"time":1767991353789,"env":"test","module":"auth-routes","userId":"7bdc111aa53965874a00096942fa71b9","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1767991354438,"env":"test","module":"auth-routes","userId":"7bdc111aa53965874a00096942fa71b9","msg":"Login from trusted device - MFA skipped"}
{"level":30,"time":1767991354492,"env":"test","module":"auth-routes","userId":"7bdc111aa53965874a00096942fa71b9","msg":"User logged in successfully"}
{"level":30,"time":1767991354539,"env":"test","module":"audit-log-service","userId":"7bdc111aa53965874a00096942fa71b9","eventType":"login_success","ipAddress":"192.168.1.100","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 31017[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should trust current device [33m 1916[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set trust expiry to 30 days [33m 1900[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should update expiry if device already trusted [33m 2242[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 416[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should list all trusted devices [33m 3328[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should mark current device [33m 1933[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should exclude revoked devices [33m 2004[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should exclude expired devices [33m 2031[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke specific device [33m 2244[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 404 for non-existent device [33m 1745[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prevent revoking other user's device [33m 3361[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should skip MFA for trusted device [33m 2500[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require MFA for untrusted device [33m 2336[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should update lastUsedAt on trusted device login [33m 2632[2mms[22m[39m

[2m Test Files [22m [1m[32m1 passed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[32m14 passed[39m[22m[90m (14)[39m
[2m   Start at [22m 14:41:53
[2m   Duration [22m 41.59s[2m (transform 7.21s, setup 7.30s, import 2.50s, tests 31.02s, environment 0ms)[22m

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mpackage.json [22m[34mx1 [34m[39m
       [2m Filename pattern: [22m[34mtests/integration/trusted.devices.real.test.ts[39m

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

{"level":30,"time":1767991685576,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

stderr | tests/integration/trusted.devices.real.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): Error: No file ./migrations/0008_flashy_jimmy_woo.sql found in ./migrations folder
    at readMigrationFiles (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/migrator.js:26:13)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:3:22)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:120:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Concurrency conflict creating DB functions (attempt 1/3). Retrying...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for 8acd934132cf0b2ed7b7a4719f1bcaa9

{"level":50,"time":1767991688445,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1767991688559,"env":"test","module":"mfa-service","userId":"8acd934132cf0b2ed7b7a4719f1bcaa9","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1767991688559,"env":"test","module":"auth-routes","userId":"8acd934132cf0b2ed7b7a4719f1bcaa9","msg":"MFA verification failed during login"}
{"level":50,"time":1767991688564,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for 3f7a7fe3f861daa130c7b42e0058f6e3

{"level":50,"time":1767991690895,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1767991691003,"env":"test","module":"mfa-service","userId":"3f7a7fe3f861daa130c7b42e0058f6e3","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1767991691003,"env":"test","module":"auth-routes","userId":"3f7a7fe3f861daa130c7b42e0058f6e3","msg":"MFA verification failed during login"}
{"level":50,"time":1767991691006,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1767991691111,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1767991691517,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for ceb23518f944b108d14e74e40a3359af

{"level":50,"time":1767991693824,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1767991693932,"env":"test","module":"mfa-service","userId":"ceb23518f944b108d14e74e40a3359af","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1767991693932,"env":"test","module":"auth-routes","userId":"ceb23518f944b108d14e74e40a3359af","msg":"MFA verification failed during login"}
{"level":50,"time":1767991693936,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1767991693939,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for 87741a64d550dafb69fdd17bf90d9fbd

{"level":50,"time":1767991696295,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1767991696408,"env":"test","module":"mfa-service","userId":"87741a64d550dafb69fdd17bf90d9fbd","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1767991696408,"env":"test","module":"auth-routes","userId":"87741a64d550dafb69fdd17bf90d9fbd","msg":"MFA verification failed during login"}
{"level":50,"time":1767991696413,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1767991696465,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for 2d23456c471dee1d9391825497d8e47c

{"level":50,"time":1767991697901,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1767991698005,"env":"test","module":"mfa-service","userId":"2d23456c471dee1d9391825497d8e47c","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1767991698006,"env":"test","module":"auth-routes","userId":"2d23456c471dee1d9391825497d8e47c","msg":"MFA verification failed during login"}
{"level":50,"time":1767991698008,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1767991698012,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39m[TEST UTILS] MFA Secret verified for 8519ba6d697b06c1dc45887f02f947f8

{"level":50,"time":1767991699431,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1767991699563,"env":"test","module":"mfa-service","userId":"8519ba6d697b06c1dc45887f02f947f8","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1767991699563,"env":"test","module":"auth-routes","userId":"8519ba6d697b06c1dc45887f02f947f8","msg":"MFA verification failed during login"}
{"level":50,"time":1767991699567,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 6d0ecb3e3af5a63976d1f4fdf0050cdd

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for c057ab8052737507abae6460b7b9033f

{"level":50,"time":1767991701711,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1767991701817,"env":"test","module":"mfa-service","userId":"6d0ecb3e3af5a63976d1f4fdf0050cdd","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1767991701817,"env":"test","module":"auth-routes","userId":"6d0ecb3e3af5a63976d1f4fdf0050cdd","msg":"MFA verification failed during login"}
{"level":50,"time":1767991701820,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1767991701822,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39m[TEST UTILS] MFA Secret verified for 338f9ac3ccd969e20b69f6d6abeead32

{"level":30,"time":1767991703462,"env":"test","module":"auth-routes","userId":"338f9ac3ccd969e20b69f6d6abeead32","msg":"Login requires MFA verification"}
{"level":30,"time":1767991703566,"env":"test","module":"mfa-service","userId":"338f9ac3ccd969e20b69f6d6abeead32","msg":"TOTP verification successful"}
{"level":30,"time":1767991703634,"env":"test","module":"auth-routes","userId":"338f9ac3ccd969e20b69f6d6abeead32","msg":"MFA login successful"}
{"level":30,"time":1767991703803,"env":"test","module":"auth-routes","userId":"338f9ac3ccd969e20b69f6d6abeead32","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":50,"time":1767991704075,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39m[TEST UTILS] MFA Secret verified for 40a12e3395146211cceb18fc39018296

{"level":30,"time":1767991705693,"env":"test","module":"auth-routes","userId":"40a12e3395146211cceb18fc39018296","msg":"Login requires MFA verification"}
{"level":40,"time":1767991705798,"env":"test","module":"mfa-service","userId":"40a12e3395146211cceb18fc39018296","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1767991705798,"env":"test","module":"auth-routes","userId":"40a12e3395146211cceb18fc39018296","msg":"MFA verification failed during login"}
{"level":50,"time":1767991705801,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1767991706061,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39m[TEST UTILS] MFA Secret verified for 916efeff89a61ae2e5df99edf9964bfe

{"level":50,"time":1767991707466,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1767991707565,"env":"test","module":"mfa-service","userId":"916efeff89a61ae2e5df99edf9964bfe","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1767991707565,"env":"test","module":"auth-routes","userId":"916efeff89a61ae2e5df99edf9964bfe","msg":"MFA verification failed during login"}
{"level":50,"time":1767991707568,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m13 failed[39m[2m)[22m[33m 21834[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should trust current device[39m[33m 1589[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set trust expiry to 30 days[39m[33m 891[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update expiry if device already trusted[39m[33m 1650[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 405[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all trusted devices[39m[33m 887[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should mark current device[39m[33m 1535[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude revoked devices[39m[33m 941[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude expired devices[39m[33m 1585[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific device[39m[33m 1547[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 404 for non-existent device[39m[33m 1556[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent revoking other user's device[39m[33m 2253[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should skip MFA for trusted device[39m[33m 2255[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should require MFA for untrusted device[39m[33m 1985[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update lastUsedAt on trusted device login[39m[33m 1553[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 13 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should trust current device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:52:36
     50|         .set("X-Forwarded-For", "192.168.1.100");
     51| 
     52|       expect(trustResponse.status).toBe(200);
       |                                    ^
     53|       expect(trustResponse.body.message).toContain("trusted");
     54|       expect(trustResponse.body.trustedUntil).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should set trust expiry to 30 days
Error: [TEST UTILS] MFA Secret verification failed for fe38527c4f80a07b3df8f42254306094
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:182:21
    180|     where: eq(mfaSecrets.userId, userData.userId)
    181|   });
    182|   if (!check) throw new Error(`[TEST UTILS] MFA Secret verification faÎ“Ã‡Âª
       |                     ^
    183|   if (!check.enabled) throw new Error(`[TEST UTILS] MFA Secret enabledÎ“Ã‡Âª
    184|   console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}Î“Ã‡Âª
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:70:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should update expiry if device already trusted
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:132:42
    130| 
    131|       // Should have extended expiry
    132|       expect(secondExpiry > firstExpiry).toBe(true);
       |                                          ^
    133| 
    134|       // Should still only have 1 device record

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
Error: [TEST UTILS] MFA Secret verification failed for b0c97067097df12de527a154227f1470
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:182:21
    180|     where: eq(mfaSecrets.userId, userData.userId)
    181|   });
    182|   if (!check) throw new Error(`[TEST UTILS] MFA Secret verification faÎ“Ã‡Âª
       |                     ^
    183|   if (!check.enabled) throw new Error(`[TEST UTILS] MFA Secret enabledÎ“Ã‡Âª
    184|   console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}Î“Ã‡Âª
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:154:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should mark current device
TypeError: Cannot read properties of undefined (reading 'find')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:236:51
    234|         .set("X-Forwarded-For", "192.168.1.100");
    235| 
    236|       const currentDevice = response.body.devices.find((d: any) => d.cÎ“Ã‡Âª
       |                                                   ^
    237|       expect(currentDevice).toBeDefined();
    238|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude revoked devices
Error: [TEST UTILS] MFA Secret verification failed for 7f4c723da8e638b58996c93827867340
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:182:21
    180|     where: eq(mfaSecrets.userId, userData.userId)
    181|   });
    182|   if (!check) throw new Error(`[TEST UTILS] MFA Secret verification faÎ“Ã‡Âª
       |                     ^
    183|   if (!check.enabled) throw new Error(`[TEST UTILS] MFA Secret enabledÎ“Ã‡Âª
    184|   console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}Î“Ã‡Âª
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:241:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude expired devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:302:36
    300|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    301| 
    302|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    303|     });
    304|   });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[7/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:332:45
    330|         .set("Authorization", `Bearer ${token}`);
    331| 
    332|       const deviceId = devicesResponse.body.devices[0].id;
       |                                             ^
    333| 
    334|       // Revoke device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[8/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should return 404 for non-existent device
AssertionError: expected 401 to be 404 // Object.is equality

- Expected
+ Received

- 404
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:371:31
    369|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    370| 
    371|       expect(response.status).toBe(404);
       |                               ^
    372|     });
    373| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[9/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should prevent revoking other user's device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:399:43
    397|         .set("Authorization", `Bearer ${mfaLogin1.body.token}`);
    398| 
    399|       const user1DeviceId = devices1.body.devices[0].id;
       |                                           ^
    400| 
    401|       // User 2 tries to revoke user 1's device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[10/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:453:42
    451| 
    452|       // Should not require MFA
    453|       expect(secondLoginResponse.status).toBe(200);
       |                                          ^
    454|       expect(secondLoginResponse.body.requiresMfa).toBeUndefined();
    455|       expect(secondLoginResponse.body.token).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[11/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
AssertionError: expected undefined to be true // Object.is equality

- Expected: 
true

+ Received: 
undefined

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:485:51
    483| 
    484|       // Should require MFA
    485|       expect(loginFromNewDevice.body.requiresMfa).toBe(true);
       |                                                   ^
    486|     });
    487| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[12/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should update lastUsedAt on trusted device login
TypeError: Cannot read properties of undefined (reading 'lastUsedAt')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:512:38
    510|       });
    511| 
    512|       const firstLastUsed = device1!.lastUsedAt;
       |                                      ^
    513| 
    514|       // Wait a bit


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m13 failed[39m[22m[2m | [22m[1m[32m1 passed[39m[22m[90m (14)[39m
[2m   Start at [22m 14:47:45
[2m   Duration [22m 26.04s

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[13/13]Î“Ã„Â»

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mtests/setup.ts [22m[34mx2 [34m[39m
       [2m Filename pattern: [22m[34mtests/integration/trusted.devices.real.test.ts[39m

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1767993184081,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

stderr | tests/integration/trusted.devices.real.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): Error: No file ./migrations/0008_flashy_jimmy_woo.sql found in ./migrations folder
    at readMigrationFiles (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/migrator.js:26:13)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:3:22)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:120:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[33m14 skipped[39m[2m)[22m[33m 30004[2mms[22m[39m
       [2m[90mÎ“Ã¥Ã´[39m[22m should trust current device
       [2m[90mÎ“Ã¥Ã´[39m[22m should set trust expiry to 30 days
       [2m[90mÎ“Ã¥Ã´[39m[22m should update expiry if device already trusted
       [2m[90mÎ“Ã¥Ã´[39m[22m should require authentication
       [2m[90mÎ“Ã¥Ã´[39m[22m should list all trusted devices
       [2m[90mÎ“Ã¥Ã´[39m[22m should mark current device
       [2m[90mÎ“Ã¥Ã´[39m[22m should exclude revoked devices
       [2m[90mÎ“Ã¥Ã´[39m[22m should exclude expired devices
       [2m[90mÎ“Ã¥Ã´[39m[22m should revoke specific device
       [2m[90mÎ“Ã¥Ã´[39m[22m should return 404 for non-existent device
       [2m[90mÎ“Ã¥Ã´[39m[22m should prevent revoking other user's device
       [2m[90mÎ“Ã¥Ã´[39m[22m should skip MFA for trusted device
       [2m[90mÎ“Ã¥Ã´[39m[22m should require MFA for untrusted device
       [2m[90mÎ“Ã¥Ã´[39m[22m should update lastUsedAt on trusted device login

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Suites 1 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts [ tests/integration/trusted.devices.real.test.ts ]
Error: Hook timed out in 30000ms.
If this is a long-running hook, pass a timeout value as the last argument or configure it globally with "hookTimeout".
 Î“Â¥Â» tests/setup.ts:96:1
     94| 
     95| // Global test hooks
     96| beforeAll(async () => {
       | ^
     97|   // Only attempt DB setup if we expect a real DB connection
     98|   if (shouldConnectToDb()) {

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/1]Î“Ã„Â»


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [33m14 skipped[39m[90m (14)[39m
[2m   Start at [22m 15:12:56
[2m   Duration [22m 36.04s

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mtests/setup.ts [22m[34mx3 [34m[39m
       [2m Filename pattern: [22m[34mtests/integration/trusted.devices.real.test.ts[39m

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

{"level":30,"time":1767993330352,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

stderr | tests/integration/trusted.devices.real.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): Error: No file ./migrations/0008_flashy_jimmy_woo.sql found in ./migrations folder
    at readMigrationFiles (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/migrator.js:26:13)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:3:22)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:120:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for 6fdec57bffe3de8b1e24ea1a04e387ec

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for 7b78d4276692959cf1c5509270170a03

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for 4978a601cc5c27ee8f1f7981e81573e1

{"level":50,"time":1767993395943,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":50,"time":1767993423116,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1767993455977,"env":"test","module":"auth-routes","error":{},"msg":"MFA login verification error"}
{"level":50,"time":1767993455983,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1767993456416,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":50,"time":1767993456421,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1767993456531,"env":"test","module":"mfa-service","userId":"7b78d4276692959cf1c5509270170a03","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1767993456532,"env":"test","module":"auth-routes","userId":"7b78d4276692959cf1c5509270170a03","msg":"MFA verification failed during login"}
{"level":50,"time":1767993456536,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1767993456544,"env":"test","module":"mfa-service","userId":"4978a601cc5c27ee8f1f7981e81573e1","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1767993456544,"env":"test","module":"auth-routes","userId":"4978a601cc5c27ee8f1f7981e81573e1","msg":"MFA verification failed during login"}
{"level":50,"time":1767993456547,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1767993456655,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for aaa86a6884b66af1ba588e9321ca9bf1

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for 882d8d0995b4714eecff65303931fff2

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for 1a608c4bc13e8b647e3343b2ffa96e6b

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for c2566bdf9401eed8606fe435d12250c7

{"level":50,"time":1767993517801,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":50,"time":1767993517816,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1767993517902,"env":"test","module":"mfa-service","userId":"882d8d0995b4714eecff65303931fff2","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1767993517902,"env":"test","module":"auth-routes","userId":"882d8d0995b4714eecff65303931fff2","msg":"MFA verification failed during login"}
{"level":50,"time":1767993517906,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1767993517909,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1767993517921,"env":"test","module":"mfa-service","userId":"aaa86a6884b66af1ba588e9321ca9bf1","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1767993517921,"env":"test","module":"auth-routes","userId":"aaa86a6884b66af1ba588e9321ca9bf1","msg":"MFA verification failed during login"}
{"level":50,"time":1767993517925,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1767993518185,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1767993518300,"env":"test","module":"mfa-service","userId":"aaa86a6884b66af1ba588e9321ca9bf1","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1767993518300,"env":"test","module":"auth-routes","userId":"aaa86a6884b66af1ba588e9321ca9bf1","msg":"MFA verification failed during login"}
{"level":50,"time":1767993518303,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1767993518557,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1767993518665,"env":"test","module":"mfa-service","userId":"aaa86a6884b66af1ba588e9321ca9bf1","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1767993518666,"env":"test","module":"auth-routes","userId":"aaa86a6884b66af1ba588e9321ca9bf1","msg":"MFA verification failed during login"}
{"level":50,"time":1767993518670,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1767993519259,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":50,"time":1767993519322,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1767993519366,"env":"test","module":"mfa-service","userId":"c2566bdf9401eed8606fe435d12250c7","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1767993519366,"env":"test","module":"auth-routes","userId":"c2566bdf9401eed8606fe435d12250c7","msg":"MFA verification failed during login"}
{"level":50,"time":1767993519371,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":40,"time":1767993519426,"env":"test","module":"mfa-service","userId":"1a608c4bc13e8b647e3343b2ffa96e6b","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1767993519426,"env":"test","module":"auth-routes","userId":"1a608c4bc13e8b647e3343b2ffa96e6b","msg":"MFA verification failed during login"}
{"level":50,"time":1767993519433,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1767993519434,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1767993519490,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for d122190c74cec4a1dbfe191687addd58

{"level":50,"time":1767993521436,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1767993521542,"env":"test","module":"mfa-service","userId":"d122190c74cec4a1dbfe191687addd58","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1767993521542,"env":"test","module":"auth-routes","userId":"d122190c74cec4a1dbfe191687addd58","msg":"MFA verification failed during login"}
{"level":50,"time":1767993521548,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1767993521553,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 403c0dfc45f5023de77c8698fd3d84c0

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 7f28f42f16298058e67fd5db22a7c456

{"level":50,"time":1767993555061,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1767993555170,"env":"test","module":"mfa-service","userId":"403c0dfc45f5023de77c8698fd3d84c0","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1767993555170,"env":"test","module":"auth-routes","userId":"403c0dfc45f5023de77c8698fd3d84c0","msg":"MFA verification failed during login"}
{"level":50,"time":1767993555173,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1767993555176,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39m[TEST UTILS] MFA Secret verified for 578ae26230c4ea6c95302051c1125f87

{"level":50,"time":1767993556863,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1767993556975,"env":"test","module":"mfa-service","userId":"578ae26230c4ea6c95302051c1125f87","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1767993556975,"env":"test","module":"auth-routes","userId":"578ae26230c4ea6c95302051c1125f87","msg":"MFA verification failed during login"}
{"level":50,"time":1767993556979,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1767993557239,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39m[TEST UTILS] MFA Secret verified for 122372ee7b0711ea4c2b554929d52290

{"level":50,"time":1767993558699,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1767993558806,"env":"test","module":"mfa-service","userId":"122372ee7b0711ea4c2b554929d52290","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1767993558807,"env":"test","module":"auth-routes","userId":"122372ee7b0711ea4c2b554929d52290","msg":"MFA verification failed during login"}
{"level":50,"time":1767993558810,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1767993559071,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39m[TEST UTILS] MFA Secret verified for 2b989b27d9521528a63a0e53fa689121

{"level":50,"time":1767993560476,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1767993560580,"env":"test","module":"mfa-service","userId":"2b989b27d9521528a63a0e53fa689121","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1767993560580,"env":"test","module":"auth-routes","userId":"2b989b27d9521528a63a0e53fa689121","msg":"MFA verification failed during login"}
{"level":50,"time":1767993560583,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m13 failed[39m[2m)[22m[33m 230219[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should trust current device[39m[33m 30423[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set trust expiry to 30 days[39m[33m 30557[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update expiry if device already trusted[39m[33m 30571[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 567[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all trusted devices[39m[33m 30391[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should mark current device[39m[33m 30546[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude revoked devices[39m[33m 30594[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude expired devices[39m[33m 4788[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific device[39m[33m 2117[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 404 for non-existent device[39m[33m 30404[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent revoking other user's device[39m[33m 3219[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should skip MFA for trusted device[39m[33m 2066[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should require MFA for untrusted device[39m[33m 1829[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update lastUsedAt on trusted device login[39m[33m 1564[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 13 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should trust current device
Error: Test timed out in 30000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:31:5
     29| 
     30|   describe("POST /api/auth/trust-device", () => {
     31|     it("should trust current device", async () => {
       |     ^
     32|       const { email, password, userId, totpSecret } = await createUserÎ“Ã‡Âª
     33| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should set trust expiry to 30 days
Error: Test timed out in 30000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:69:5
     67|     });
     68| 
     69|     it("should set trust expiry to 30 days", async () => {
       |     ^
     70|       const { email, password, userId, totpSecret } = await createUserÎ“Ã‡Âª
     71| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should update expiry if device already trusted
Error: Test timed out in 30000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:95:5
     93|     });
     94| 
     95|     it("should update expiry if device already trusted", async () => {
       |     ^
     96|       const { email, password, userId, totpSecret } = await createUserÎ“Ã‡Âª
     97| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
Error: Test timed out in 30000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:153:5
    151| 
    152|   describe("GET /api/auth/trusted-devices", () => {
    153|     it("should list all trusted devices", async () => {
       |     ^
    154|       const { email, password, userId, totpSecret } = await createUserÎ“Ã‡Âª
    155| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should mark current device
Error: Test timed out in 30000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:209:5
    207|     });
    208| 
    209|     it("should mark current device", async () => {
       |     ^
    210|       const { email, password, userId, totpSecret } = await createUserÎ“Ã‡Âª
    211| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude revoked devices
Error: Test timed out in 30000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:240:5
    238|     });
    239| 
    240|     it("should exclude revoked devices", async () => {
       |     ^
    241|       const { email, password, userId, totpSecret } = await createUserÎ“Ã‡Âª
    242| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude expired devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:302:36
    300|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    301| 
    302|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    303|     });
    304|   });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[7/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:332:45
    330|         .set("Authorization", `Bearer ${token}`);
    331| 
    332|       const deviceId = devicesResponse.body.devices[0].id;
       |                                             ^
    333| 
    334|       // Revoke device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[8/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should return 404 for non-existent device
Error: Test timed out in 30000ms.
If this is a long-running test, pass a timeout value as the last argument or configure it globally with "testTimeout".
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:356:5
    354|     });
    355| 
    356|     it("should return 404 for non-existent device", async () => {
       |     ^
    357|       const { email, password, userId, totpSecret } = await createUserÎ“Ã‡Âª
    358| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[9/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should prevent revoking other user's device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:399:43
    397|         .set("Authorization", `Bearer ${mfaLogin1.body.token}`);
    398| 
    399|       const user1DeviceId = devices1.body.devices[0].id;
       |                                           ^
    400| 
    401|       // User 2 tries to revoke user 1's device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[10/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:453:42
    451| 
    452|       // Should not require MFA
    453|       expect(secondLoginResponse.status).toBe(200);
       |                                          ^
    454|       expect(secondLoginResponse.body.requiresMfa).toBeUndefined();
    455|       expect(secondLoginResponse.body.token).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[11/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
AssertionError: expected undefined to be true // Object.is equality

- Expected: 
true

+ Received: 
undefined

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:485:51
    483| 
    484|       // Should require MFA
    485|       expect(loginFromNewDevice.body.requiresMfa).toBe(true);
       |                                                   ^
    486|     });
    487| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[12/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should update lastUsedAt on trusted device login
TypeError: Cannot read properties of undefined (reading 'lastUsedAt')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:512:38
    510|       });
    511| 
    512|       const firstLastUsed = device1!.lastUsedAt;
       |                                      ^
    513| 
    514|       // Wait a bit

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[13/13]Î“Ã„Â»


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m13 failed[39m[22m[2m | [22m[1m[32m1 passed[39m[22m[90m (14)[39m
[2m   Start at [22m 15:15:22
[2m   Duration [22m 237.10s

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/middleware/auth.ts [22m[34mx4 [34m[39m
       [2m Filename pattern: [22m[34mtests/integration/trusted.devices.real.test.ts[39m

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768064260368,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

stderr | tests/integration/trusted.devices.real.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): Error: No file ./migrations/0008_flashy_jimmy_woo.sql found in ./migrations folder
    at readMigrationFiles (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/migrator.js:26:13)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:3:22)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:120:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for 44eb4dd6b2234ff880135ccfdc7399b3

{"level":50,"time":1768064262258,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768064262376,"env":"test","module":"mfa-service","userId":"44eb4dd6b2234ff880135ccfdc7399b3","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768064262376,"env":"test","module":"auth-routes","userId":"44eb4dd6b2234ff880135ccfdc7399b3","msg":"MFA verification failed during login"}
{"level":50,"time":1768064262383,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39m[TEST UTILS] MFA Secret verified for c09cb1227eceb24b6163cfcc9433468d

{"level":50,"time":1768064263803,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768064263907,"env":"test","module":"mfa-service","userId":"c09cb1227eceb24b6163cfcc9433468d","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768064263907,"env":"test","module":"auth-routes","userId":"c09cb1227eceb24b6163cfcc9433468d","msg":"MFA verification failed during login"}
{"level":50,"time":1768064263911,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for 3b1ef45a8f8047e717782f3d36cf4799

{"level":50,"time":1768064265282,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768064265387,"env":"test","module":"mfa-service","userId":"3b1ef45a8f8047e717782f3d36cf4799","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768064265387,"env":"test","module":"auth-routes","userId":"3b1ef45a8f8047e717782f3d36cf4799","msg":"MFA verification failed during login"}
{"level":50,"time":1768064265390,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768064265495,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768064265874,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39m[TEST UTILS] MFA Secret verified for f8ca51293900d645f7c85aa6a98ab74e

{"level":50,"time":1768064267216,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768064267316,"env":"test","module":"mfa-service","userId":"f8ca51293900d645f7c85aa6a98ab74e","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768064267316,"env":"test","module":"auth-routes","userId":"f8ca51293900d645f7c85aa6a98ab74e","msg":"MFA verification failed during login"}
{"level":50,"time":1768064267319,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768064267582,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768064267677,"env":"test","module":"mfa-service","userId":"f8ca51293900d645f7c85aa6a98ab74e","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768064267677,"env":"test","module":"auth-routes","userId":"f8ca51293900d645f7c85aa6a98ab74e","msg":"MFA verification failed during login"}
{"level":50,"time":1768064267680,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768064267933,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768064268043,"env":"test","module":"mfa-service","userId":"f8ca51293900d645f7c85aa6a98ab74e","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768064268043,"env":"test","module":"auth-routes","userId":"f8ca51293900d645f7c85aa6a98ab74e","msg":"MFA verification failed during login"}
{"level":50,"time":1768064268047,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for 2301f6936a169d4969a0b4c244b39cba

{"level":50,"time":1768064269414,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768064269522,"env":"test","module":"mfa-service","userId":"2301f6936a169d4969a0b4c244b39cba","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768064269522,"env":"test","module":"auth-routes","userId":"2301f6936a169d4969a0b4c244b39cba","msg":"MFA verification failed during login"}
{"level":50,"time":1768064269526,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768064269528,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39m[TEST UTILS] MFA Secret verified for 8baa087e67816312130c610bb54af381

{"level":30,"time":1768064271067,"env":"test","module":"auth-routes","userId":"8baa087e67816312130c610bb54af381","msg":"Login requires MFA verification"}
{"level":40,"time":1768064271177,"env":"test","module":"mfa-service","userId":"8baa087e67816312130c610bb54af381","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768064271177,"env":"test","module":"auth-routes","userId":"8baa087e67816312130c610bb54af381","msg":"MFA verification failed during login"}
{"level":50,"time":1768064271179,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768064271232,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for 267622f3415ab55b4ac3263ab80194b0

{"level":50,"time":1768064272598,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768064272700,"env":"test","module":"mfa-service","userId":"267622f3415ab55b4ac3263ab80194b0","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768064272700,"env":"test","module":"auth-routes","userId":"267622f3415ab55b4ac3263ab80194b0","msg":"MFA verification failed during login"}
{"level":50,"time":1768064272704,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768064272758,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for 6cb174be8d11f0fc9ca60d398a44da3b

{"level":50,"time":1768064274122,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768064274223,"env":"test","module":"mfa-service","userId":"6cb174be8d11f0fc9ca60d398a44da3b","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768064274223,"env":"test","module":"auth-routes","userId":"6cb174be8d11f0fc9ca60d398a44da3b","msg":"MFA verification failed during login"}
{"level":50,"time":1768064274227,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768064274229,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39m[TEST UTILS] MFA Secret verified for 3cf81a5808204982db41edce6b885551

{"level":30,"time":1768064275810,"env":"test","module":"auth-routes","userId":"3cf81a5808204982db41edce6b885551","msg":"Login requires MFA verification"}
{"level":40,"time":1768064275903,"env":"test","module":"mfa-service","userId":"3cf81a5808204982db41edce6b885551","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768064275903,"env":"test","module":"auth-routes","userId":"3cf81a5808204982db41edce6b885551","msg":"MFA verification failed during login"}
{"level":50,"time":1768064275906,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 3604dc9e7716e8f4dd0253b4dfe64ec7

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 9facd30fb039905b04c55d5f0394179b

{"level":50,"time":1768064277972,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768064278093,"env":"test","module":"mfa-service","userId":"3604dc9e7716e8f4dd0253b4dfe64ec7","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768064278093,"env":"test","module":"auth-routes","userId":"3604dc9e7716e8f4dd0253b4dfe64ec7","msg":"MFA verification failed during login"}
{"level":50,"time":1768064278096,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768064278098,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39m[TEST UTILS] MFA Secret verified for 953de6fe41fc0fab3b83705b0b4cd083

{"level":50,"time":1768064279436,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768064279538,"env":"test","module":"mfa-service","userId":"953de6fe41fc0fab3b83705b0b4cd083","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768064279538,"env":"test","module":"auth-routes","userId":"953de6fe41fc0fab3b83705b0b4cd083","msg":"MFA verification failed during login"}
{"level":50,"time":1768064279543,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768064279801,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39m[TEST UTILS] MFA Secret verified for 1ccc96e06466fa26f4dbd7cc1965ccb8

{"level":50,"time":1768064281168,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768064281264,"env":"test","module":"mfa-service","userId":"1ccc96e06466fa26f4dbd7cc1965ccb8","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768064281265,"env":"test","module":"auth-routes","userId":"1ccc96e06466fa26f4dbd7cc1965ccb8","msg":"MFA verification failed during login"}
{"level":50,"time":1768064281267,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768064281518,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39m[TEST UTILS] MFA Secret verified for 32237bd056b1314f2b0b9ec39d0b2cf4

{"level":50,"time":1768064282909,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768064283013,"env":"test","module":"mfa-service","userId":"32237bd056b1314f2b0b9ec39d0b2cf4","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768064283013,"env":"test","module":"auth-routes","userId":"32237bd056b1314f2b0b9ec39d0b2cf4","msg":"MFA verification failed during login"}
{"level":50,"time":1768064283015,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m13 failed[39m[2m)[22m[33m 22662[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should trust current device[39m[33m 1567[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set trust expiry to 30 days[39m[33m 1524[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update expiry if device already trusted[39m[33m 1583[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 379[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all trusted devices[39m[33m 2173[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should mark current device[39m[33m 1481[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude revoked devices[39m[33m 1704[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude expired devices[39m[33m 1527[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific device[39m[33m 1470[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 404 for non-existent device[39m[33m 1678[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent revoking other user's device[39m[33m 2191[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should skip MFA for trusted device[39m[33m 1703[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should require MFA for untrusted device[39m[33m 1717[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update lastUsedAt on trusted device login[39m[33m 1542[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 13 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should trust current device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:52:36
     50|         .set("X-Forwarded-For", "192.168.1.100");
     51| 
     52|       expect(trustResponse.status).toBe(200);
       |                                    ^
     53|       expect(trustResponse.body.message).toContain("trusted");
     54|       expect(trustResponse.body.trustedUntil).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should set trust expiry to 30 days
AssertionError: expected NaN to be 30 // Object.is equality

- Expected
+ Received

- 30
+ NaN

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:92:24
     90|       );
     91| 
     92|       expect(diffDays).toBe(30);
       |                        ^
     93|     });
     94| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should update expiry if device already trusted
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:132:42
    130| 
    131|       // Should have extended expiry
    132|       expect(secondExpiry > firstExpiry).toBe(true);
       |                                          ^
    133| 
    134|       // Should still only have 1 device record

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:193:31
    191|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    192| 
    193|       expect(response.status).toBe(200);
       |                               ^
    194|       expect(response.body.devices).toBeDefined();
    195|       expect(response.body.devices.length).toBe(2);

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should mark current device
TypeError: Cannot read properties of undefined (reading 'find')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:236:51
    234|         .set("X-Forwarded-For", "192.168.1.100");
    235| 
    236|       const currentDevice = response.body.devices.find((d: any) => d.cÎ“Ã‡Âª
       |                                                   ^
    237|       expect(currentDevice).toBeDefined();
    238|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude revoked devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:269:36
    267|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    268| 
    269|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    270|     });
    271| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude expired devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:302:36
    300|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    301| 
    302|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    303|     });
    304|   });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[7/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:332:45
    330|         .set("Authorization", `Bearer ${token}`);
    331| 
    332|       const deviceId = devicesResponse.body.devices[0].id;
       |                                             ^
    333| 
    334|       // Revoke device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[8/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should return 404 for non-existent device
AssertionError: expected 401 to be 404 // Object.is equality

- Expected
+ Received

- 404
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:371:31
    369|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    370| 
    371|       expect(response.status).toBe(404);
       |                               ^
    372|     });
    373| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[9/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should prevent revoking other user's device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:399:43
    397|         .set("Authorization", `Bearer ${mfaLogin1.body.token}`);
    398| 
    399|       const user1DeviceId = devices1.body.devices[0].id;
       |                                           ^
    400| 
    401|       // User 2 tries to revoke user 1's device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[10/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:453:42
    451| 
    452|       // Should not require MFA
    453|       expect(secondLoginResponse.status).toBe(200);
       |                                          ^
    454|       expect(secondLoginResponse.body.requiresMfa).toBeUndefined();
    455|       expect(secondLoginResponse.body.token).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[11/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
AssertionError: expected undefined to be true // Object.is equality

- Expected: 
true

+ Received: 
undefined

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:485:51
    483| 
    484|       // Should require MFA
    485|       expect(loginFromNewDevice.body.requiresMfa).toBe(true);
       |                                                   ^
    486|     });
    487| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[12/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should update lastUsedAt on trusted device login
TypeError: Cannot read properties of undefined (reading 'lastUsedAt')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:512:38
    510|       });
    511| 
    512|       const firstLastUsed = device1!.lastUsedAt;
       |                                      ^
    513| 
    514|       // Wait a bit

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[13/13]Î“Ã„Â»


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m13 failed[39m[22m[2m | [22m[1m[32m1 passed[39m[22m[90m (14)[39m
[2m   Start at [22m 10:56:15
[2m   Duration [22m 24.35s

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/middleware/auth.ts [22m[34mx5 [34m[39m
       [2m Filename pattern: [22m[34mtests/integration/trusted.devices.real.test.ts[39m

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

{"level":30,"time":1768066805957,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

stderr | tests/integration/trusted.devices.real.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): Error: No file ./migrations/0008_flashy_jimmy_woo.sql found in ./migrations folder
    at readMigrationFiles (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/migrator.js:26:13)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:3:22)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:120:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for cdd11677229e6c4d97d69273f1ab0a01

{"level":30,"time":1768066808081,"env":"test","module":"auth-routes","userId":"cdd11677229e6c4d97d69273f1ab0a01","msg":"Login requires MFA verification"}
{"level":30,"time":1768066808187,"env":"test","module":"mfa-service","userId":"cdd11677229e6c4d97d69273f1ab0a01","msg":"TOTP verification successful"}
{"level":30,"time":1768066808238,"env":"test","module":"auth-routes","userId":"cdd11677229e6c4d97d69273f1ab0a01","msg":"MFA login successful"}
{"level":30,"time":1768066808409,"env":"test","module":"auth-routes","userId":"cdd11677229e6c4d97d69273f1ab0a01","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39m[TEST UTILS] MFA Secret verified for 9fa131cd110729a4cf60faf97d76dc60

{"level":50,"time":1768066809862,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":30,"time":1768066809968,"env":"test","module":"mfa-service","userId":"9fa131cd110729a4cf60faf97d76dc60","msg":"TOTP verification successful"}
{"level":30,"time":1768066810020,"env":"test","module":"auth-routes","userId":"9fa131cd110729a4cf60faf97d76dc60","msg":"MFA login successful"}
{"level":30,"time":1768066810204,"env":"test","module":"auth-routes","userId":"9fa131cd110729a4cf60faf97d76dc60","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for de56905f5c9f7e6f3330b504afd01133

{"level":50,"time":1768066811623,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":30,"time":1768066811734,"env":"test","module":"mfa-service","userId":"de56905f5c9f7e6f3330b504afd01133","msg":"TOTP verification successful"}
{"level":30,"time":1768066811789,"env":"test","module":"auth-routes","userId":"de56905f5c9f7e6f3330b504afd01133","msg":"MFA login successful"}
{"level":30,"time":1768066811948,"env":"test","module":"auth-routes","userId":"de56905f5c9f7e6f3330b504afd01133","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768066812208,"env":"test","module":"auth-routes","userId":"de56905f5c9f7e6f3330b504afd01133","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Trusted device expiry updated"}
{"level":50,"time":1768066812688,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39m[TEST UTILS] MFA Secret verified for 5695dc03d5836bba9b4ea33e44501064

{"level":30,"time":1768066814325,"env":"test","module":"auth-routes","userId":"5695dc03d5836bba9b4ea33e44501064","msg":"Login requires MFA verification"}
{"level":30,"time":1768066814432,"env":"test","module":"mfa-service","userId":"5695dc03d5836bba9b4ea33e44501064","msg":"TOTP verification successful"}
{"level":30,"time":1768066814490,"env":"test","module":"auth-routes","userId":"5695dc03d5836bba9b4ea33e44501064","msg":"MFA login successful"}
{"level":30,"time":1768066814647,"env":"test","module":"auth-routes","userId":"5695dc03d5836bba9b4ea33e44501064","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768066815107,"env":"test","module":"auth-routes","userId":"5695dc03d5836bba9b4ea33e44501064","msg":"Login requires MFA verification"}
{"level":40,"time":1768066815210,"env":"test","module":"mfa-service","userId":"5695dc03d5836bba9b4ea33e44501064","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768066815210,"env":"test","module":"auth-routes","userId":"5695dc03d5836bba9b4ea33e44501064","msg":"MFA verification failed during login"}
{"level":50,"time":1768066815214,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768066815465,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768066815576,"env":"test","module":"mfa-service","userId":"5695dc03d5836bba9b4ea33e44501064","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768066815576,"env":"test","module":"auth-routes","userId":"5695dc03d5836bba9b4ea33e44501064","msg":"MFA verification failed during login"}
{"level":50,"time":1768066815581,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for 660404806e78149af6ed7b051a4954dd

{"level":50,"time":1768066816989,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768066817097,"env":"test","module":"mfa-service","userId":"660404806e78149af6ed7b051a4954dd","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768066817097,"env":"test","module":"auth-routes","userId":"660404806e78149af6ed7b051a4954dd","msg":"MFA verification failed during login"}
{"level":50,"time":1768066817101,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768066817105,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768066818523,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768066818634,"env":"test","module":"mfa-service","userId":"9a3c9c160b0247ae46d3d0062ad5b6fb","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768066818634,"env":"test","module":"auth-routes","userId":"9a3c9c160b0247ae46d3d0062ad5b6fb","msg":"MFA verification failed during login"}
{"level":50,"time":1768066818638,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768066818691,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768066820329,"env":"test","module":"auth-routes","userId":"4087b93ac37761b3a2175879f1d16ca2","msg":"Login requires MFA verification"}
{"level":30,"time":1768066820431,"env":"test","module":"mfa-service","userId":"4087b93ac37761b3a2175879f1d16ca2","msg":"TOTP verification successful"}
{"level":30,"time":1768066820493,"env":"test","module":"auth-routes","userId":"4087b93ac37761b3a2175879f1d16ca2","msg":"MFA login successful"}
{"level":30,"time":1768066820650,"env":"test","module":"auth-routes","userId":"4087b93ac37761b3a2175879f1d16ca2","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768066820805,"env":"test","module":"auth-routes","userId":"4087b93ac37761b3a2175879f1d16ca2","deviceCount":0,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39m[TEST UTILS] MFA Secret verified for 9a3c9c160b0247ae46d3d0062ad5b6fb

{"level":30,"time":1768066822426,"env":"test","module":"auth-routes","userId":"1bda311b8837695ccf95347a82fdf041","msg":"Login requires MFA verification"}
{"level":30,"time":1768066822530,"env":"test","module":"mfa-service","userId":"1bda311b8837695ccf95347a82fdf041","msg":"TOTP verification successful"}
{"level":30,"time":1768066822578,"env":"test","module":"auth-routes","userId":"1bda311b8837695ccf95347a82fdf041","msg":"MFA login successful"}
{"level":30,"time":1768066822732,"env":"test","module":"auth-routes","userId":"1bda311b8837695ccf95347a82fdf041","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768066822834,"env":"test","module":"auth-routes","userId":"1bda311b8837695ccf95347a82fdf041","deviceCount":1,"msg":"Listed trusted devices"}
{"level":30,"time":1768066822993,"env":"test","module":"auth-routes","userId":"1bda311b8837695ccf95347a82fdf041","deviceId":"dc9b23d3-e29f-4f31-8417-969471fe553d","msg":"Trusted device revoked"}
{"level":30,"time":1768066823148,"env":"test","module":"auth-routes","userId":"1bda311b8837695ccf95347a82fdf041","deviceCount":0,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for 4087b93ac37761b3a2175879f1d16ca2

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for 1bda311b8837695ccf95347a82fdf041

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39m[TEST UTILS] MFA Secret verified for d0f8acaf8f36ce46060b80c34d7e96dd

{"level":30,"time":1768066824805,"env":"test","module":"auth-routes","userId":"d0f8acaf8f36ce46060b80c34d7e96dd","msg":"Login requires MFA verification"}
{"level":30,"time":1768066824906,"env":"test","module":"mfa-service","userId":"d0f8acaf8f36ce46060b80c34d7e96dd","msg":"TOTP verification successful"}
{"level":30,"time":1768066824960,"env":"test","module":"auth-routes","userId":"d0f8acaf8f36ce46060b80c34d7e96dd","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for f53b552bb339b180cf08855e0d726ad9

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 73594bdb25d60429f743d94d25df9761

{"level":30,"time":1768066827374,"env":"test","module":"auth-routes","userId":"f53b552bb339b180cf08855e0d726ad9","msg":"Login requires MFA verification"}
{"level":30,"time":1768066827474,"env":"test","module":"mfa-service","userId":"f53b552bb339b180cf08855e0d726ad9","msg":"TOTP verification successful"}
{"level":30,"time":1768066827525,"env":"test","module":"auth-routes","userId":"f53b552bb339b180cf08855e0d726ad9","msg":"MFA login successful"}
{"level":30,"time":1768066827681,"env":"test","module":"auth-routes","userId":"f53b552bb339b180cf08855e0d726ad9","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768066827780,"env":"test","module":"auth-routes","userId":"f53b552bb339b180cf08855e0d726ad9","deviceCount":1,"msg":"Listed trusted devices"}
{"level":30,"time":1768066828244,"env":"test","module":"auth-routes","userId":"73594bdb25d60429f743d94d25df9761","msg":"Login requires MFA verification"}
{"level":30,"time":1768066828355,"env":"test","module":"mfa-service","userId":"73594bdb25d60429f743d94d25df9761","msg":"TOTP verification successful"}
{"level":30,"time":1768066828406,"env":"test","module":"auth-routes","userId":"73594bdb25d60429f743d94d25df9761","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39m[TEST UTILS] MFA Secret verified for def95d00a86f8f8362abd7644d29efaf

{"level":30,"time":1768066830098,"env":"test","module":"auth-routes","userId":"def95d00a86f8f8362abd7644d29efaf","msg":"Login requires MFA verification"}
{"level":30,"time":1768066830196,"env":"test","module":"mfa-service","userId":"def95d00a86f8f8362abd7644d29efaf","msg":"TOTP verification successful"}
{"level":30,"time":1768066830245,"env":"test","module":"auth-routes","userId":"def95d00a86f8f8362abd7644d29efaf","msg":"MFA login successful"}
{"level":30,"time":1768066830396,"env":"test","module":"auth-routes","userId":"def95d00a86f8f8362abd7644d29efaf","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768066830921,"env":"test","module":"auth-routes","userId":"def95d00a86f8f8362abd7644d29efaf","msg":"Login from trusted device - MFA skipped"}
{"level":30,"time":1768066830976,"env":"test","module":"auth-routes","userId":"def95d00a86f8f8362abd7644d29efaf","msg":"User logged in successfully"}
{"level":30,"time":1768066831031,"env":"test","module":"audit-log-service","userId":"def95d00a86f8f8362abd7644d29efaf","eventType":"login_success","ipAddress":"192.168.1.100","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39m[TEST UTILS] MFA Secret verified for 3f62f6562dcbf095c62c8489a72ace64

{"level":30,"time":1768066832634,"env":"test","module":"auth-routes","userId":"3f62f6562dcbf095c62c8489a72ace64","msg":"Login requires MFA verification"}
{"level":30,"time":1768066832741,"env":"test","module":"mfa-service","userId":"3f62f6562dcbf095c62c8489a72ace64","msg":"TOTP verification successful"}
{"level":30,"time":1768066832793,"env":"test","module":"auth-routes","userId":"3f62f6562dcbf095c62c8489a72ace64","msg":"MFA login successful"}
{"level":30,"time":1768066832951,"env":"test","module":"auth-routes","userId":"3f62f6562dcbf095c62c8489a72ace64","deviceFingerprint":"10fa3aea039bf6fec7b6bcb982cbed1cc6ab844dd3c0879bec32baefb2997b52","msg":"Device marked as trusted"}
{"level":30,"time":1768066833417,"env":"test","module":"auth-routes","userId":"3f62f6562dcbf095c62c8489a72ace64","msg":"Login requires MFA verification"}
{"level":30,"time":1768066835015,"env":"test","module":"auth-routes","userId":"6400d8e075462969881859c9154180d7","msg":"Login requires MFA verification"}
{"level":30,"time":1768066835116,"env":"test","module":"mfa-service","userId":"6400d8e075462969881859c9154180d7","msg":"TOTP verification successful"}
{"level":30,"time":1768066835167,"env":"test","module":"auth-routes","userId":"6400d8e075462969881859c9154180d7","msg":"MFA login successful"}
{"level":30,"time":1768066835320,"env":"test","module":"auth-routes","userId":"6400d8e075462969881859c9154180d7","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39m[TEST UTILS] MFA Secret verified for 6400d8e075462969881859c9154180d7

{"level":30,"time":1768066835986,"env":"test","module":"auth-routes","userId":"6400d8e075462969881859c9154180d7","msg":"Login from trusted device - MFA skipped"}
{"level":30,"time":1768066836039,"env":"test","module":"auth-routes","userId":"6400d8e075462969881859c9154180d7","msg":"User logged in successfully"}
{"level":30,"time":1768066836088,"env":"test","module":"audit-log-service","userId":"6400d8e075462969881859c9154180d7","eventType":"login_success","ipAddress":"192.168.1.100","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m3 failed[39m[2m)[22m[33m 30157[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should trust current device [33m 2013[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set trust expiry to 30 days [33m 1745[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should update expiry if device already trusted [33m 2070[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 413[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all trusted devices[39m[33m 2900[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should mark current device[39m[33m 1518[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude revoked devices[39m[33m 1585[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should exclude expired devices [33m 2114[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke specific device [33m 2342[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 404 for non-existent device [33m 1870[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prevent revoking other user's device [33m 3493[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should skip MFA for trusted device [33m 2521[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require MFA for untrusted device [33m 2386[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should update lastUsedAt on trusted device login [33m 2723[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 3 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:193:31
    191|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    192| 
    193|       expect(response.status).toBe(200);
       |                               ^
    194|       expect(response.body.devices).toBeDefined();
    195|       expect(response.body.devices.length).toBe(2);

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/3]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should mark current device
TypeError: Cannot read properties of undefined (reading 'find')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:236:51
    234|         .set("X-Forwarded-For", "192.168.1.100");
    235| 
    236|       const currentDevice = response.body.devices.find((d: any) => d.cÎ“Ã‡Âª
       |                                                   ^
    237|       expect(currentDevice).toBeDefined();
    238|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/3]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude revoked devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:269:36
    267|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    268| 
    269|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    270|     });
    271| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/3]Î“Ã„Â»


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m3 failed[39m[22m[2m | [22m[1m[32m11 passed[39m[22m[90m (14)[39m
[2m   Start at [22m 11:24:05
[2m   Duration [22m 31.71s

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/services/AuthService.ts [22m[34mx6 [34m[39m
       [2m Filename pattern: [22m[34mtests/integration/trusted.devices.real.test.ts[39m

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768067707461,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

stderr | tests/integration/trusted.devices.real.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): Error: No file ./migrations/0008_flashy_jimmy_woo.sql found in ./migrations folder
    at readMigrationFiles (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/migrator.js:26:13)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:3:22)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:120:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for d16b4eb0ae70fdc60a6a64fed9b9631a

{"level":30,"time":1768067709533,"env":"test","module":"auth-routes","userId":"d16b4eb0ae70fdc60a6a64fed9b9631a","msg":"Login requires MFA verification"}
{"level":30,"time":1768067709646,"env":"test","module":"mfa-service","userId":"d16b4eb0ae70fdc60a6a64fed9b9631a","msg":"TOTP verification successful"}
{"level":30,"time":1768067709701,"env":"test","module":"auth-routes","userId":"d16b4eb0ae70fdc60a6a64fed9b9631a","msg":"MFA login successful"}
{"level":30,"time":1768067709867,"env":"test","module":"auth-routes","userId":"d16b4eb0ae70fdc60a6a64fed9b9631a","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39m[TEST UTILS] MFA Secret verified for b71bf9c5874f49eee340c93483d1e461

{"level":30,"time":1768067711544,"env":"test","module":"auth-routes","userId":"b71bf9c5874f49eee340c93483d1e461","msg":"Login requires MFA verification"}
{"level":30,"time":1768067711656,"env":"test","module":"mfa-service","userId":"b71bf9c5874f49eee340c93483d1e461","msg":"TOTP verification successful"}
{"level":30,"time":1768067711705,"env":"test","module":"auth-routes","userId":"b71bf9c5874f49eee340c93483d1e461","msg":"MFA login successful"}
{"level":30,"time":1768067711864,"env":"test","module":"auth-routes","userId":"b71bf9c5874f49eee340c93483d1e461","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for 852893e0290e05ed2e67fbf102c92099

{"level":30,"time":1768067713456,"env":"test","module":"auth-routes","userId":"852893e0290e05ed2e67fbf102c92099","msg":"Login requires MFA verification"}
{"level":30,"time":1768067713558,"env":"test","module":"mfa-service","userId":"852893e0290e05ed2e67fbf102c92099","msg":"TOTP verification successful"}
{"level":30,"time":1768067713610,"env":"test","module":"auth-routes","userId":"852893e0290e05ed2e67fbf102c92099","msg":"MFA login successful"}
{"level":30,"time":1768067713763,"env":"test","module":"auth-routes","userId":"852893e0290e05ed2e67fbf102c92099","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768067714024,"env":"test","module":"auth-routes","userId":"852893e0290e05ed2e67fbf102c92099","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Trusted device expiry updated"}
{"level":50,"time":1768067714476,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39m[TEST UTILS] MFA Secret verified for d86126605d466b2094755ab995fa5c5f

{"level":30,"time":1768067716076,"env":"test","module":"auth-routes","userId":"d86126605d466b2094755ab995fa5c5f","msg":"Login requires MFA verification"}
{"level":30,"time":1768067716182,"env":"test","module":"mfa-service","userId":"d86126605d466b2094755ab995fa5c5f","msg":"TOTP verification successful"}
{"level":30,"time":1768067716232,"env":"test","module":"auth-routes","userId":"d86126605d466b2094755ab995fa5c5f","msg":"MFA login successful"}
{"level":30,"time":1768067716383,"env":"test","module":"auth-routes","userId":"d86126605d466b2094755ab995fa5c5f","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768067716848,"env":"test","module":"auth-routes","userId":"d86126605d466b2094755ab995fa5c5f","msg":"Login requires MFA verification"}
{"level":30,"time":1768067716949,"env":"test","module":"mfa-service","userId":"d86126605d466b2094755ab995fa5c5f","msg":"TOTP verification successful"}
{"level":30,"time":1768067716999,"env":"test","module":"auth-routes","userId":"d86126605d466b2094755ab995fa5c5f","msg":"MFA login successful"}
{"level":30,"time":1768067717152,"env":"test","module":"auth-routes","userId":"d86126605d466b2094755ab995fa5c5f","deviceFingerprint":"091366faa1882b5c8dc1cba02126615a77a378274bbfd3375e821aa38bdd1b4f","msg":"Device marked as trusted"}
{"level":30,"time":1768067717641,"env":"test","module":"auth-routes","userId":"d86126605d466b2094755ab995fa5c5f","msg":"Login requires MFA verification"}
{"level":30,"time":1768067717748,"env":"test","module":"mfa-service","userId":"d86126605d466b2094755ab995fa5c5f","msg":"TOTP verification successful"}
{"level":30,"time":1768067717799,"env":"test","module":"auth-routes","userId":"d86126605d466b2094755ab995fa5c5f","msg":"MFA login successful"}
{"level":30,"time":1768067717900,"env":"test","module":"auth-routes","userId":"d86126605d466b2094755ab995fa5c5f","deviceCount":2,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for 37dba6d566254e4da1aba3145f4c531c

{"level":30,"time":1768067719489,"env":"test","module":"auth-routes","userId":"37dba6d566254e4da1aba3145f4c531c","msg":"Login requires MFA verification"}
{"level":30,"time":1768067719592,"env":"test","module":"mfa-service","userId":"37dba6d566254e4da1aba3145f4c531c","msg":"TOTP verification successful"}
{"level":30,"time":1768067719651,"env":"test","module":"auth-routes","userId":"37dba6d566254e4da1aba3145f4c531c","msg":"MFA login successful"}
{"level":30,"time":1768067719815,"env":"test","module":"auth-routes","userId":"37dba6d566254e4da1aba3145f4c531c","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768067719922,"env":"test","module":"auth-routes","userId":"37dba6d566254e4da1aba3145f4c531c","deviceCount":1,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39m[TEST UTILS] MFA Secret verified for a237f5b53ff0dd247832f997a39b13bf

{"level":30,"time":1768067721541,"env":"test","module":"auth-routes","userId":"a237f5b53ff0dd247832f997a39b13bf","msg":"Login requires MFA verification"}
{"level":30,"time":1768067721643,"env":"test","module":"mfa-service","userId":"a237f5b53ff0dd247832f997a39b13bf","msg":"TOTP verification successful"}
{"level":30,"time":1768067721690,"env":"test","module":"auth-routes","userId":"a237f5b53ff0dd247832f997a39b13bf","msg":"MFA login successful"}
{"level":30,"time":1768067721851,"env":"test","module":"auth-routes","userId":"a237f5b53ff0dd247832f997a39b13bf","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768067722005,"env":"test","module":"auth-routes","userId":"a237f5b53ff0dd247832f997a39b13bf","deviceCount":0,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for c2a400f02bd0c1cef08732c86d890fa1

{"level":30,"time":1768067723609,"env":"test","module":"auth-routes","userId":"c2a400f02bd0c1cef08732c86d890fa1","msg":"Login requires MFA verification"}
{"level":30,"time":1768067723719,"env":"test","module":"mfa-service","userId":"c2a400f02bd0c1cef08732c86d890fa1","msg":"TOTP verification successful"}
{"level":30,"time":1768067723771,"env":"test","module":"auth-routes","userId":"c2a400f02bd0c1cef08732c86d890fa1","msg":"MFA login successful"}
{"level":30,"time":1768067723920,"env":"test","module":"auth-routes","userId":"c2a400f02bd0c1cef08732c86d890fa1","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768067724071,"env":"test","module":"auth-routes","userId":"c2a400f02bd0c1cef08732c86d890fa1","deviceCount":0,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for 9a4fc79fbdb3d0c967bcede6a85c8e8f

{"level":30,"time":1768067725672,"env":"test","module":"auth-routes","userId":"9a4fc79fbdb3d0c967bcede6a85c8e8f","msg":"Login requires MFA verification"}
{"level":30,"time":1768067725781,"env":"test","module":"mfa-service","userId":"9a4fc79fbdb3d0c967bcede6a85c8e8f","msg":"TOTP verification successful"}
{"level":30,"time":1768067725831,"env":"test","module":"auth-routes","userId":"9a4fc79fbdb3d0c967bcede6a85c8e8f","msg":"MFA login successful"}
{"level":30,"time":1768067725988,"env":"test","module":"auth-routes","userId":"9a4fc79fbdb3d0c967bcede6a85c8e8f","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768067726090,"env":"test","module":"auth-routes","userId":"9a4fc79fbdb3d0c967bcede6a85c8e8f","deviceCount":0,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39m[TEST UTILS] MFA Secret verified for 3d1f7c2e97b3131cfcc91ba3a9c6a444

{"level":30,"time":1768067727715,"env":"test","module":"auth-routes","userId":"3d1f7c2e97b3131cfcc91ba3a9c6a444","msg":"Login requires MFA verification"}
{"level":30,"time":1768067727824,"env":"test","module":"mfa-service","userId":"3d1f7c2e97b3131cfcc91ba3a9c6a444","msg":"TOTP verification successful"}
{"level":30,"time":1768067727884,"env":"test","module":"auth-routes","userId":"3d1f7c2e97b3131cfcc91ba3a9c6a444","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for ba3b3a0d5cf60779418f8bba4fbef3b0

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 29fb326df8a055ce00fe90de9fec23b3

{"level":30,"time":1768067730270,"env":"test","module":"auth-routes","userId":"ba3b3a0d5cf60779418f8bba4fbef3b0","msg":"Login requires MFA verification"}
{"level":40,"time":1768067730373,"env":"test","module":"mfa-service","userId":"ba3b3a0d5cf60779418f8bba4fbef3b0","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768067730373,"env":"test","module":"auth-routes","userId":"ba3b3a0d5cf60779418f8bba4fbef3b0","msg":"MFA verification failed during login"}
{"level":50,"time":1768067730376,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768067730379,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39m[TEST UTILS] MFA Secret verified for a526aac36669918f48c6d13df86f5dcc

{"level":30,"time":1768067731989,"env":"test","module":"auth-routes","userId":"a526aac36669918f48c6d13df86f5dcc","msg":"Login requires MFA verification"}
{"level":30,"time":1768067732359,"env":"test","module":"mfa-service","userId":"a526aac36669918f48c6d13df86f5dcc","msg":"TOTP verification successful"}
{"level":30,"time":1768067732406,"env":"test","module":"auth-routes","userId":"a526aac36669918f48c6d13df86f5dcc","msg":"MFA login successful"}
{"level":30,"time":1768067732554,"env":"test","module":"auth-routes","userId":"a526aac36669918f48c6d13df86f5dcc","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768067733065,"env":"test","module":"auth-routes","userId":"a526aac36669918f48c6d13df86f5dcc","msg":"Login from trusted device - MFA skipped"}
{"level":30,"time":1768067733117,"env":"test","module":"auth-routes","userId":"a526aac36669918f48c6d13df86f5dcc","msg":"User logged in successfully"}
{"level":30,"time":1768067733170,"env":"test","module":"audit-log-service","userId":"a526aac36669918f48c6d13df86f5dcc","eventType":"login_success","ipAddress":"192.168.1.100","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39m[TEST UTILS] MFA Secret verified for 9b379f08a6dfe1ce2762aa61b290a71f

{"level":50,"time":1768067734539,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768067734638,"env":"test","module":"mfa-service","userId":"9b379f08a6dfe1ce2762aa61b290a71f","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768067734638,"env":"test","module":"auth-routes","userId":"9b379f08a6dfe1ce2762aa61b290a71f","msg":"MFA verification failed during login"}
{"level":50,"time":1768067734641,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768067734897,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m4 failed[39m[2m)[22m[33m 28323[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should trust current device [33m 1985[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set trust expiry to 30 days [33m 1945[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should update expiry if device already trusted [33m 2210[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 402[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should list all trusted devices [33m 3424[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should mark current device [33m 2022[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should exclude revoked devices [33m 2084[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should exclude expired devices [33m 2066[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific device[39m[33m 2021[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 404 for non-existent device [33m 1844[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent revoking other user's device[39m[33m 2443[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should skip MFA for trusted device [33m 2791[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should require MFA for untrusted device[39m[33m 1730[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update lastUsedAt on trusted device login[39m[33m 896[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 4 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
TypeError: Cannot read properties of undefined (reading 'id')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:332:56
    330|         .set("Authorization", `Bearer ${token}`);
    331| 
    332|       const deviceId = devicesResponse.body.devices[0].id;
       |                                                        ^
    333| 
    334|       // Revoke device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/4]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should prevent revoking other user's device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:399:43
    397|         .set("Authorization", `Bearer ${mfaLogin1.body.token}`);
    398| 
    399|       const user1DeviceId = devices1.body.devices[0].id;
       |                                           ^
    400| 
    401|       // User 2 tries to revoke user 1's device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/4]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
AssertionError: expected undefined to be true // Object.is equality

- Expected: 
true

+ Received: 
undefined

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:485:51
    483| 
    484|       // Should require MFA
    485|       expect(loginFromNewDevice.body.requiresMfa).toBe(true);
       |                                                   ^
    486|     });
    487| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/4]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should update lastUsedAt on trusted device login
Error: [TEST UTILS] MFA Secret verification failed for 18017d6dbe5c8415f86813c157e8989c
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:182:21
    180|     where: eq(mfaSecrets.userId, userData.userId)
    181|   });
    182|   if (!check) throw new Error(`[TEST UTILS] MFA Secret verification faÎ“Ã‡Âª
       |                     ^
    183|   if (!check.enabled) throw new Error(`[TEST UTILS] MFA Secret enabledÎ“Ã‡Âª
    184|   console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}Î“Ã‡Âª
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:489:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/4]Î“Ã„Â»


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m4 failed[39m[22m[2m | [22m[1m[32m10 passed[39m[22m[90m (14)[39m
[2m   Start at [22m 11:55:04
[2m   Duration [22m 29.86s

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/services/AuthService.ts [22m[34mx7 [34m[39m
       [2m Filename pattern: [22m[34mtests/integration/trusted.devices.real.test.ts[39m

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¦Ã‘ sync secrets across teammates & machines: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768081529824,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for 67a5e38b089a69a447b1e57b9025c115

{"level":50,"time":1768081532050,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768081532171,"env":"test","module":"mfa-service","userId":"67a5e38b089a69a447b1e57b9025c115","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768081532171,"env":"test","module":"auth-routes","userId":"67a5e38b089a69a447b1e57b9025c115","msg":"MFA verification failed during login"}
{"level":50,"time":1768081532178,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768081533591,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768081533696,"env":"test","module":"mfa-service","userId":"93146942b03dde6fcee1614f8db7f884","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768081533696,"env":"test","module":"auth-routes","userId":"93146942b03dde6fcee1614f8db7f884","msg":"MFA verification failed during login"}
{"level":50,"time":1768081533701,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39m[TEST UTILS] MFA Secret verified for 93146942b03dde6fcee1614f8db7f884

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for cabe112ba22db8163ac09bc43f8ed77e

{"level":30,"time":1768081535360,"env":"test","module":"auth-routes","userId":"cabe112ba22db8163ac09bc43f8ed77e","msg":"Login requires MFA verification"}
{"level":40,"time":1768081535467,"env":"test","module":"mfa-service","userId":"cabe112ba22db8163ac09bc43f8ed77e","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768081535467,"env":"test","module":"auth-routes","userId":"cabe112ba22db8163ac09bc43f8ed77e","msg":"MFA verification failed during login"}
{"level":50,"time":1768081535472,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768081535579,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768081535988,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39m[TEST UTILS] MFA Secret verified for d1bbe9123757a414ebe2d2c8369543f2

{"level":50,"time":1768081537457,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768081537570,"env":"test","module":"mfa-service","userId":"d1bbe9123757a414ebe2d2c8369543f2","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768081537570,"env":"test","module":"auth-routes","userId":"d1bbe9123757a414ebe2d2c8369543f2","msg":"MFA verification failed during login"}
{"level":50,"time":1768081537575,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768081537839,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768081537948,"env":"test","module":"mfa-service","userId":"d1bbe9123757a414ebe2d2c8369543f2","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768081537948,"env":"test","module":"auth-routes","userId":"d1bbe9123757a414ebe2d2c8369543f2","msg":"MFA verification failed during login"}
{"level":50,"time":1768081537952,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768081538217,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768081538329,"env":"test","module":"mfa-service","userId":"d1bbe9123757a414ebe2d2c8369543f2","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768081538329,"env":"test","module":"auth-routes","userId":"d1bbe9123757a414ebe2d2c8369543f2","msg":"MFA verification failed during login"}
{"level":50,"time":1768081538335,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768081539794,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768081539894,"env":"test","module":"mfa-service","userId":"f7073cb2f319ef90b0e96edddf5697c8","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768081539894,"env":"test","module":"auth-routes","userId":"f7073cb2f319ef90b0e96edddf5697c8","msg":"MFA verification failed during login"}
{"level":50,"time":1768081539899,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768081539902,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768081541301,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768081541407,"env":"test","module":"mfa-service","userId":"fcf1e44ece028a6a4923dfb61045c1a1","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768081541407,"env":"test","module":"auth-routes","userId":"fcf1e44ece028a6a4923dfb61045c1a1","msg":"MFA verification failed during login"}
{"level":50,"time":1768081541411,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for f7073cb2f319ef90b0e96edddf5697c8

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39m[TEST UTILS] MFA Secret verified for fcf1e44ece028a6a4923dfb61045c1a1

{"level":50,"time":1768081541463,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768081542880,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768081542984,"env":"test","module":"mfa-service","userId":"380ffd63fc4ac179911bb2eea9a2e624","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768081542984,"env":"test","module":"auth-routes","userId":"380ffd63fc4ac179911bb2eea9a2e624","msg":"MFA verification failed during login"}
{"level":50,"time":1768081542989,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768081543045,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768081544465,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768081544573,"env":"test","module":"mfa-service","userId":"a97a7b999138c60b8753377be5dbb766","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768081544573,"env":"test","module":"auth-routes","userId":"a97a7b999138c60b8753377be5dbb766","msg":"MFA verification failed during login"}
{"level":50,"time":1768081544576,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768081544580,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768081546235,"env":"test","module":"auth-routes","userId":"1acc6ed448b160e58220f5b8cd29f3ad","msg":"Login requires MFA verification"}
{"level":40,"time":1768081546342,"env":"test","module":"mfa-service","userId":"1acc6ed448b160e58220f5b8cd29f3ad","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768081546342,"env":"test","module":"auth-routes","userId":"1acc6ed448b160e58220f5b8cd29f3ad","msg":"MFA verification failed during login"}
{"level":50,"time":1768081546346,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for 380ffd63fc4ac179911bb2eea9a2e624

{"level":30,"time":1768081548789,"env":"test","module":"auth-routes","userId":"42250d50ebb13139711992915a3e4443","msg":"Login requires MFA verification"}
{"level":40,"time":1768081548887,"env":"test","module":"mfa-service","userId":"42250d50ebb13139711992915a3e4443","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768081548887,"env":"test","module":"auth-routes","userId":"42250d50ebb13139711992915a3e4443","msg":"MFA verification failed during login"}
{"level":50,"time":1768081548891,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768081548896,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768081550520,"env":"test","module":"auth-routes","userId":"0aa80fbc2ecafeef66682cfede40ad24","msg":"Login requires MFA verification"}
{"level":40,"time":1768081550631,"env":"test","module":"mfa-service","userId":"0aa80fbc2ecafeef66682cfede40ad24","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768081550631,"env":"test","module":"auth-routes","userId":"0aa80fbc2ecafeef66682cfede40ad24","msg":"MFA verification failed during login"}
{"level":50,"time":1768081550635,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768081550900,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":30,"time":1768081552530,"env":"test","module":"auth-routes","userId":"4edc394f09e835a6fee946a8f7f57dc7","msg":"Login requires MFA verification"}
{"level":40,"time":1768081552635,"env":"test","module":"mfa-service","userId":"4edc394f09e835a6fee946a8f7f57dc7","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768081552635,"env":"test","module":"auth-routes","userId":"4edc394f09e835a6fee946a8f7f57dc7","msg":"MFA verification failed during login"}
{"level":50,"time":1768081552639,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768081552901,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":50,"time":1768081554322,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768081554430,"env":"test","module":"mfa-service","userId":"58f31f0226bf5d995ea4874faab370a4","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768081554430,"env":"test","module":"auth-routes","userId":"58f31f0226bf5d995ea4874faab370a4","msg":"MFA verification failed during login"}
{"level":50,"time":1768081554434,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for a97a7b999138c60b8753377be5dbb766

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39m[TEST UTILS] MFA Secret verified for 1acc6ed448b160e58220f5b8cd29f3ad

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 42250d50ebb13139711992915a3e4443

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 09e6b4b1b64e3658fce5454c05c5f0c5

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39m[TEST UTILS] MFA Secret verified for 0aa80fbc2ecafeef66682cfede40ad24

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39m[TEST UTILS] MFA Secret verified for 4edc394f09e835a6fee946a8f7f57dc7

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39m[TEST UTILS] MFA Secret verified for 58f31f0226bf5d995ea4874faab370a4

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m13 failed[39m[2m)[22m[33m 24635[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should trust current device[39m[33m 1637[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set trust expiry to 30 days[39m[33m 1512[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update expiry if device already trusted[39m[33m 1879[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 408[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all trusted devices[39m[33m 2347[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should mark current device[39m[33m 1566[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude revoked devices[39m[33m 1561[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude expired devices[39m[33m 1582[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific device[39m[33m 1534[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 404 for non-existent device[39m[33m 1767[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent revoking other user's device[39m[33m 2550[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should skip MFA for trusted device[39m[33m 2004[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should require MFA for untrusted device[39m[33m 2000[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update lastUsedAt on trusted device login[39m[33m 1581[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 13 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should trust current device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:52:36
     50|         .set("X-Forwarded-For", "192.168.1.100");
     51| 
     52|       expect(trustResponse.status).toBe(200);
       |                                    ^
     53|       expect(trustResponse.body.message).toContain("trusted");
     54|       expect(trustResponse.body.trustedUntil).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should set trust expiry to 30 days
AssertionError: expected NaN to be 30 // Object.is equality

- Expected
+ Received

- 30
+ NaN

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:92:24
     90|       );
     91| 
     92|       expect(diffDays).toBe(30);
       |                        ^
     93|     });
     94| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should update expiry if device already trusted
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:132:42
    130| 
    131|       // Should have extended expiry
    132|       expect(secondExpiry > firstExpiry).toBe(true);
       |                                          ^
    133| 
    134|       // Should still only have 1 device record

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:193:31
    191|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    192| 
    193|       expect(response.status).toBe(200);
       |                               ^
    194|       expect(response.body.devices).toBeDefined();
    195|       expect(response.body.devices.length).toBe(2);

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should mark current device
TypeError: Cannot read properties of undefined (reading 'find')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:236:51
    234|         .set("X-Forwarded-For", "192.168.1.100");
    235| 
    236|       const currentDevice = response.body.devices.find((d: any) => d.cÎ“Ã‡Âª
       |                                                   ^
    237|       expect(currentDevice).toBeDefined();
    238|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude revoked devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:269:36
    267|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    268| 
    269|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    270|     });
    271| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude expired devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:302:36
    300|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    301| 
    302|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    303|     });
    304|   });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[7/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:332:45
    330|         .set("Authorization", `Bearer ${token}`);
    331| 
    332|       const deviceId = devicesResponse.body.devices[0].id;
       |                                             ^
    333| 
    334|       // Revoke device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[8/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should return 404 for non-existent device
AssertionError: expected 401 to be 404 // Object.is equality

- Expected
+ Received

- 404
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:371:31
    369|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    370| 
    371|       expect(response.status).toBe(404);
       |                               ^
    372|     });
    373| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[9/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should prevent revoking other user's device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:399:43
    397|         .set("Authorization", `Bearer ${mfaLogin1.body.token}`);
    398| 
    399|       const user1DeviceId = devices1.body.devices[0].id;
       |                                           ^
    400| 
    401|       // User 2 tries to revoke user 1's device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[10/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:453:42
    451| 
    452|       // Should not require MFA
    453|       expect(secondLoginResponse.status).toBe(200);
       |                                          ^
    454|       expect(secondLoginResponse.body.requiresMfa).toBeUndefined();
    455|       expect(secondLoginResponse.body.token).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[11/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
AssertionError: expected undefined to be true // Object.is equality

- Expected: 
true

+ Received: 
undefined

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:485:51
    483| 
    484|       // Should require MFA
    485|       expect(loginFromNewDevice.body.requiresMfa).toBe(true);
       |                                                   ^
    486|     });
    487| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[12/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should update lastUsedAt on trusted device login
TypeError: Cannot read properties of undefined (reading 'lastUsedAt')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:512:38
    510|       });
    511| 
    512|       const firstLastUsed = device1!.lastUsedAt;
       |                                      ^
    513| 
    514|       // Wait a bit

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[13/13]Î“Ã„Â»


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m13 failed[39m[22m[2m | [22m[1m[32m1 passed[39m[22m[90m (14)[39m
[2m   Start at [22m 15:30:22
[2m   Duration [22m 32.82s

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mtests/integration/api.runs.docx.test.ts [22m[34mx8 [34m[39m
       [2m Filename pattern: [22m[34mtests/integration/trusted.devices.real.test.ts[39m

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768081582773,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for 1f9b02926d49d408bca034933c081943

{"level":50,"time":1768081585299,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768081585423,"env":"test","module":"mfa-service","userId":"1f9b02926d49d408bca034933c081943","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768081585423,"env":"test","module":"auth-routes","userId":"1f9b02926d49d408bca034933c081943","msg":"MFA verification failed during login"}
{"level":50,"time":1768081585431,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for 3ff8870009059ca18bd0495ee695e93f

{"level":50,"time":1768081588182,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768081588293,"env":"test","module":"mfa-service","userId":"3ff8870009059ca18bd0495ee695e93f","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768081588293,"env":"test","module":"auth-routes","userId":"3ff8870009059ca18bd0495ee695e93f","msg":"MFA verification failed during login"}
{"level":50,"time":1768081588299,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768081588405,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768081588825,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39m[TEST UTILS] MFA Secret verified for 5e33ff9ba2077ef2b7d31a3ffb960964

{"level":50,"time":1768081590365,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768081590474,"env":"test","module":"mfa-service","userId":"5e33ff9ba2077ef2b7d31a3ffb960964","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768081590474,"env":"test","module":"auth-routes","userId":"5e33ff9ba2077ef2b7d31a3ffb960964","msg":"MFA verification failed during login"}
{"level":50,"time":1768081590479,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768081590727,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768081590834,"env":"test","module":"mfa-service","userId":"5e33ff9ba2077ef2b7d31a3ffb960964","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768081590835,"env":"test","module":"auth-routes","userId":"5e33ff9ba2077ef2b7d31a3ffb960964","msg":"MFA verification failed during login"}
{"level":50,"time":1768081590839,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768081591102,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768081591207,"env":"test","module":"mfa-service","userId":"5e33ff9ba2077ef2b7d31a3ffb960964","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768081591207,"env":"test","module":"auth-routes","userId":"5e33ff9ba2077ef2b7d31a3ffb960964","msg":"MFA verification failed during login"}
{"level":50,"time":1768081591210,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39m[TEST UTILS] MFA Secret verified for 44be78ce0d6ea472b5a32ccb18c3d8b1

{"level":50,"time":1768081593828,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768081593937,"env":"test","module":"mfa-service","userId":"44be78ce0d6ea472b5a32ccb18c3d8b1","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768081593937,"env":"test","module":"auth-routes","userId":"44be78ce0d6ea472b5a32ccb18c3d8b1","msg":"MFA verification failed during login"}
{"level":50,"time":1768081593940,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768081593991,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for d4ef8fba82d99ffcde190b384e71ec87

{"level":50,"time":1768081595431,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768081595539,"env":"test","module":"mfa-service","userId":"d4ef8fba82d99ffcde190b384e71ec87","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768081595539,"env":"test","module":"auth-routes","userId":"d4ef8fba82d99ffcde190b384e71ec87","msg":"MFA verification failed during login"}
{"level":50,"time":1768081595543,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768081595598,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for 2c68effcc584943c9d8edf212f7e59a8

{"level":50,"time":1768081597041,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768081597143,"env":"test","module":"mfa-service","userId":"2c68effcc584943c9d8edf212f7e59a8","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768081597143,"env":"test","module":"auth-routes","userId":"2c68effcc584943c9d8edf212f7e59a8","msg":"MFA verification failed during login"}
{"level":50,"time":1768081597146,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768081597150,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39m[TEST UTILS] MFA Secret verified for 86a1a7f45f24077b239b429b14d298bb

{"level":50,"time":1768081598625,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768081598734,"env":"test","module":"mfa-service","userId":"86a1a7f45f24077b239b429b14d298bb","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768081598734,"env":"test","module":"auth-routes","userId":"86a1a7f45f24077b239b429b14d298bb","msg":"MFA verification failed during login"}
{"level":50,"time":1768081598738,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 2d6d6746f11f18d07619108e4f10f8b2

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39m[TEST UTILS] MFA Secret verified for 7cb8b8a9958bc3a469948fe539ff1e18

{"level":50,"time":1768081601948,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768081602054,"env":"test","module":"mfa-service","userId":"7cb8b8a9958bc3a469948fe539ff1e18","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768081602054,"env":"test","module":"auth-routes","userId":"7cb8b8a9958bc3a469948fe539ff1e18","msg":"MFA verification failed during login"}
{"level":50,"time":1768081602058,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768081602319,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39m[TEST UTILS] MFA Secret verified for 1ce0e152728e659860cd51e11883b3aa

{"level":50,"time":1768081603751,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768081603860,"env":"test","module":"mfa-service","userId":"1ce0e152728e659860cd51e11883b3aa","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768081603860,"env":"test","module":"auth-routes","userId":"1ce0e152728e659860cd51e11883b3aa","msg":"MFA verification failed during login"}
{"level":50,"time":1768081603864,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768081604127,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39m[TEST UTILS] MFA Secret verified for 96df5d1d459cd34a63873e5ce3460762

{"level":50,"time":1768081605718,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768081605833,"env":"test","module":"mfa-service","userId":"96df5d1d459cd34a63873e5ce3460762","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768081605833,"env":"test","module":"auth-routes","userId":"96df5d1d459cd34a63873e5ce3460762","msg":"MFA verification failed during login"}
{"level":50,"time":1768081605837,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m13 failed[39m[2m)[22m[33m 23038[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should trust current device[39m[33m 1766[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set trust expiry to 30 days[39m[33m 946[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update expiry if device already trusted[39m[33m 2019[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 418[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all trusted devices[39m[33m 2385[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should mark current device[39m[33m 1174[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude revoked devices[39m[33m 1607[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude expired devices[39m[33m 1607[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific device[39m[33m 1552[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 404 for non-existent device[39m[33m 1588[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent revoking other user's device[39m[33m 1783[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should skip MFA for trusted device[39m[33m 1798[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should require MFA for untrusted device[39m[33m 1809[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update lastUsedAt on trusted device login[39m[33m 1759[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 13 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should trust current device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:52:36
     50|         .set("X-Forwarded-For", "192.168.1.100");
     51| 
     52|       expect(trustResponse.status).toBe(200);
       |                                    ^
     53|       expect(trustResponse.body.message).toContain("trusted");
     54|       expect(trustResponse.body.trustedUntil).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should set trust expiry to 30 days
Error: [TEST UTILS] MFA Secret verification failed for 62e6f64a2215beb16cda1c1fe7f36413
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:182:21
    180|     where: eq(mfaSecrets.userId, userData.userId)
    181|   });
    182|   if (!check) throw new Error(`[TEST UTILS] MFA Secret verification faÎ“Ã‡Âª
       |                     ^
    183|   if (!check.enabled) throw new Error(`[TEST UTILS] MFA Secret enabledÎ“Ã‡Âª
    184|   console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}Î“Ã‡Âª
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:70:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should update expiry if device already trusted
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:132:42
    130| 
    131|       // Should have extended expiry
    132|       expect(secondExpiry > firstExpiry).toBe(true);
       |                                          ^
    133| 
    134|       // Should still only have 1 device record

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:193:31
    191|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    192| 
    193|       expect(response.status).toBe(200);
       |                               ^
    194|       expect(response.body.devices).toBeDefined();
    195|       expect(response.body.devices.length).toBe(2);

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should mark current device
Error: [TEST UTILS] MFA Secret verification failed for 74fef56adc590aa911e8e5a5130c2b19
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:182:21
    180|     where: eq(mfaSecrets.userId, userData.userId)
    181|   });
    182|   if (!check) throw new Error(`[TEST UTILS] MFA Secret verification faÎ“Ã‡Âª
       |                     ^
    183|   if (!check.enabled) throw new Error(`[TEST UTILS] MFA Secret enabledÎ“Ã‡Âª
    184|   console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}Î“Ã‡Âª
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:210:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude revoked devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:269:36
    267|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    268| 
    269|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    270|     });
    271| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude expired devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:302:36
    300|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    301| 
    302|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    303|     });
    304|   });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[7/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:332:45
    330|         .set("Authorization", `Bearer ${token}`);
    331| 
    332|       const deviceId = devicesResponse.body.devices[0].id;
       |                                             ^
    333| 
    334|       // Revoke device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[8/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should return 404 for non-existent device
AssertionError: expected 401 to be 404 // Object.is equality

- Expected
+ Received

- 404
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:371:31
    369|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    370| 
    371|       expect(response.status).toBe(404);
       |                               ^
    372|     });
    373| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[9/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should prevent revoking other user's device
Error: [TEST UTILS] MFA Secret verification failed for b8cac84fcc4138cc2b753de6b236a6fc
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:182:21
    180|     where: eq(mfaSecrets.userId, userData.userId)
    181|   });
    182|   if (!check) throw new Error(`[TEST UTILS] MFA Secret verification faÎ“Ã‡Âª
       |                     ^
    183|   if (!check.enabled) throw new Error(`[TEST UTILS] MFA Secret enabledÎ“Ã‡Âª
    184|   console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}Î“Ã‡Âª
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:376:21

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[10/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:453:42
    451| 
    452|       // Should not require MFA
    453|       expect(secondLoginResponse.status).toBe(200);
       |                                          ^
    454|       expect(secondLoginResponse.body.requiresMfa).toBeUndefined();
    455|       expect(secondLoginResponse.body.token).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[11/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
AssertionError: expected undefined to be true // Object.is equality

- Expected: 
true

+ Received: 
undefined

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:485:51
    483| 
    484|       // Should require MFA
    485|       expect(loginFromNewDevice.body.requiresMfa).toBe(true);
       |                                                   ^
    486|     });
    487| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[12/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should update lastUsedAt on trusted device login
TypeError: Cannot read properties of undefined (reading 'lastUsedAt')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:512:38
    510|       });
    511| 
    512|       const firstLastUsed = device1!.lastUsedAt;
       |                                      ^
    513| 
    514|       // Wait a bit

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[13/13]Î“Ã„Â»


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m13 failed[39m[22m[2m | [22m[1m[32m1 passed[39m[22m[90m (14)[39m
[2m   Start at [22m 15:46:16
[2m   Duration [22m 27.96s

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mtests/integration/auth/jwt.authentication.test.ts [22m[34mx9 [34m[39m
       [2m Filename pattern: [22m[34mtests/integration/trusted.devices.real.test.ts[39m

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

{"level":30,"time":1768087591362,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for 7bf97fc3ed1d85e57673ab689c76711e

{"level":30,"time":1768087593839,"env":"test","module":"auth-routes","userId":"7bf97fc3ed1d85e57673ab689c76711e","msg":"Login requires MFA verification"}
{"level":30,"time":1768087593951,"env":"test","module":"mfa-service","userId":"7bf97fc3ed1d85e57673ab689c76711e","msg":"TOTP verification successful"}
{"level":30,"time":1768087594004,"env":"test","module":"auth-routes","userId":"7bf97fc3ed1d85e57673ab689c76711e","msg":"MFA login successful"}
{"level":30,"time":1768087594174,"env":"test","module":"auth-routes","userId":"7bf97fc3ed1d85e57673ab689c76711e","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39m[TEST UTILS] MFA Secret verified for fa9619ecbee3b0baa3a81d74883ae57e

{"level":30,"time":1768087595820,"env":"test","module":"auth-routes","userId":"fa9619ecbee3b0baa3a81d74883ae57e","msg":"Login requires MFA verification"}
{"level":30,"time":1768087595923,"env":"test","module":"mfa-service","userId":"fa9619ecbee3b0baa3a81d74883ae57e","msg":"TOTP verification successful"}
{"level":30,"time":1768087595973,"env":"test","module":"auth-routes","userId":"fa9619ecbee3b0baa3a81d74883ae57e","msg":"MFA login successful"}
{"level":30,"time":1768087596134,"env":"test","module":"auth-routes","userId":"fa9619ecbee3b0baa3a81d74883ae57e","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for 1ef508732f06d004254cdc97da3bda50

{"level":30,"time":1768087597719,"env":"test","module":"auth-routes","userId":"1ef508732f06d004254cdc97da3bda50","msg":"Login requires MFA verification"}
{"level":30,"time":1768087597826,"env":"test","module":"mfa-service","userId":"1ef508732f06d004254cdc97da3bda50","msg":"TOTP verification successful"}
{"level":30,"time":1768087597877,"env":"test","module":"auth-routes","userId":"1ef508732f06d004254cdc97da3bda50","msg":"MFA login successful"}
{"level":30,"time":1768087598034,"env":"test","module":"auth-routes","userId":"1ef508732f06d004254cdc97da3bda50","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768087598295,"env":"test","module":"auth-routes","userId":"1ef508732f06d004254cdc97da3bda50","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Trusted device expiry updated"}
{"level":50,"time":1768087598748,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39m[TEST UTILS] MFA Secret verified for abfc9fc59d65a9c7652f93110358dd48

{"level":30,"time":1768087600355,"env":"test","module":"auth-routes","userId":"abfc9fc59d65a9c7652f93110358dd48","msg":"Login requires MFA verification"}
{"level":30,"time":1768087600454,"env":"test","module":"mfa-service","userId":"abfc9fc59d65a9c7652f93110358dd48","msg":"TOTP verification successful"}
{"level":30,"time":1768087600508,"env":"test","module":"auth-routes","userId":"abfc9fc59d65a9c7652f93110358dd48","msg":"MFA login successful"}
{"level":30,"time":1768087600662,"env":"test","module":"auth-routes","userId":"abfc9fc59d65a9c7652f93110358dd48","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768087601154,"env":"test","module":"auth-routes","userId":"abfc9fc59d65a9c7652f93110358dd48","msg":"Login requires MFA verification"}
{"level":40,"time":1768087601262,"env":"test","module":"mfa-service","userId":"abfc9fc59d65a9c7652f93110358dd48","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768087601262,"env":"test","module":"auth-routes","userId":"abfc9fc59d65a9c7652f93110358dd48","msg":"MFA verification failed during login"}
{"level":50,"time":1768087601266,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768087601520,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768087601625,"env":"test","module":"mfa-service","userId":"abfc9fc59d65a9c7652f93110358dd48","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768087601625,"env":"test","module":"auth-routes","userId":"abfc9fc59d65a9c7652f93110358dd48","msg":"MFA verification failed during login"}
{"level":50,"time":1768087601628,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for 687a342edb7479a237d1f08117d93deb

{"level":50,"time":1768087603010,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":30,"time":1768087603117,"env":"test","module":"mfa-service","userId":"687a342edb7479a237d1f08117d93deb","msg":"TOTP verification successful"}
{"level":30,"time":1768087603168,"env":"test","module":"auth-routes","userId":"687a342edb7479a237d1f08117d93deb","msg":"MFA login successful"}
{"level":30,"time":1768087603328,"env":"test","module":"auth-routes","userId":"687a342edb7479a237d1f08117d93deb","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768087603441,"env":"test","module":"auth-routes","userId":"687a342edb7479a237d1f08117d93deb","deviceCount":1,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39m[TEST UTILS] MFA Secret verified for e542611227319dee3c2e47a8d492cea5

{"level":30,"time":1768087605052,"env":"test","module":"auth-routes","userId":"e542611227319dee3c2e47a8d492cea5","msg":"Login requires MFA verification"}
{"level":40,"time":1768087605155,"env":"test","module":"mfa-service","userId":"e542611227319dee3c2e47a8d492cea5","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768087605155,"env":"test","module":"auth-routes","userId":"e542611227319dee3c2e47a8d492cea5","msg":"MFA verification failed during login"}
{"level":50,"time":1768087605158,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768087605216,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for 32c44e4f85426f3b50316bfe9116e3f6

{"level":30,"time":1768087606812,"env":"test","module":"auth-routes","userId":"32c44e4f85426f3b50316bfe9116e3f6","msg":"Login requires MFA verification"}
{"level":40,"time":1768087606911,"env":"test","module":"mfa-service","userId":"32c44e4f85426f3b50316bfe9116e3f6","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768087606912,"env":"test","module":"auth-routes","userId":"32c44e4f85426f3b50316bfe9116e3f6","msg":"MFA verification failed during login"}
{"level":50,"time":1768087606916,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768087606969,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for d9c1555b7c7cd71c2c9f57b90a79dfb9

{"level":30,"time":1768087608525,"env":"test","module":"auth-routes","userId":"d9c1555b7c7cd71c2c9f57b90a79dfb9","msg":"Login requires MFA verification"}
{"level":40,"time":1768087608630,"env":"test","module":"mfa-service","userId":"d9c1555b7c7cd71c2c9f57b90a79dfb9","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768087608630,"env":"test","module":"auth-routes","userId":"d9c1555b7c7cd71c2c9f57b90a79dfb9","msg":"MFA verification failed during login"}
{"level":50,"time":1768087608633,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768087608635,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39m[TEST UTILS] MFA Secret verified for fe52bfaee7f1753211dd4714d50cae76

{"level":30,"time":1768087610246,"env":"test","module":"auth-routes","userId":"fe52bfaee7f1753211dd4714d50cae76","msg":"Login requires MFA verification"}
{"level":30,"time":1768087610353,"env":"test","module":"mfa-service","userId":"fe52bfaee7f1753211dd4714d50cae76","msg":"TOTP verification successful"}
{"level":30,"time":1768087610403,"env":"test","module":"auth-routes","userId":"fe52bfaee7f1753211dd4714d50cae76","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 3df5c213340bd83c4fbf66f00f28b0b5

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 8cf9dd7740a6f99c7942aeb1a94964b8

{"level":30,"time":1768087612771,"env":"test","module":"auth-routes","userId":"3df5c213340bd83c4fbf66f00f28b0b5","msg":"Login requires MFA verification"}
{"level":30,"time":1768087612873,"env":"test","module":"mfa-service","userId":"3df5c213340bd83c4fbf66f00f28b0b5","msg":"TOTP verification successful"}
{"level":30,"time":1768087612927,"env":"test","module":"auth-routes","userId":"3df5c213340bd83c4fbf66f00f28b0b5","msg":"MFA login successful"}
{"level":30,"time":1768087613091,"env":"test","module":"auth-routes","userId":"3df5c213340bd83c4fbf66f00f28b0b5","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768087613197,"env":"test","module":"auth-routes","userId":"3df5c213340bd83c4fbf66f00f28b0b5","deviceCount":1,"msg":"Listed trusted devices"}
{"level":30,"time":1768087613655,"env":"test","module":"auth-routes","userId":"8cf9dd7740a6f99c7942aeb1a94964b8","msg":"Login requires MFA verification"}
{"level":30,"time":1768087613754,"env":"test","module":"mfa-service","userId":"8cf9dd7740a6f99c7942aeb1a94964b8","msg":"TOTP verification successful"}
{"level":30,"time":1768087613804,"env":"test","module":"auth-routes","userId":"8cf9dd7740a6f99c7942aeb1a94964b8","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39m[TEST UTILS] MFA Secret verified for 89bf14e281bc0cc6335c81e39314d7d3

{"level":30,"time":1768087615494,"env":"test","module":"auth-routes","userId":"89bf14e281bc0cc6335c81e39314d7d3","msg":"Login requires MFA verification"}
{"level":30,"time":1768087615597,"env":"test","module":"mfa-service","userId":"89bf14e281bc0cc6335c81e39314d7d3","msg":"TOTP verification successful"}
{"level":30,"time":1768087615651,"env":"test","module":"auth-routes","userId":"89bf14e281bc0cc6335c81e39314d7d3","msg":"MFA login successful"}
{"level":30,"time":1768087615802,"env":"test","module":"auth-routes","userId":"89bf14e281bc0cc6335c81e39314d7d3","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768087616316,"env":"test","module":"auth-routes","userId":"89bf14e281bc0cc6335c81e39314d7d3","msg":"Login from trusted device - MFA skipped"}
{"level":30,"time":1768087616368,"env":"test","module":"auth-routes","userId":"89bf14e281bc0cc6335c81e39314d7d3","msg":"User logged in successfully"}
{"level":30,"time":1768087616425,"env":"test","module":"audit-log-service","userId":"89bf14e281bc0cc6335c81e39314d7d3","eventType":"login_success","ipAddress":"192.168.1.100","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39m[TEST UTILS] MFA Secret verified for ddc63bd5d675187f4913357da33f66cb

{"level":30,"time":1768087617989,"env":"test","module":"auth-routes","userId":"ddc63bd5d675187f4913357da33f66cb","msg":"Login requires MFA verification"}
{"level":30,"time":1768087618100,"env":"test","module":"mfa-service","userId":"ddc63bd5d675187f4913357da33f66cb","msg":"TOTP verification successful"}
{"level":30,"time":1768087618148,"env":"test","module":"auth-routes","userId":"ddc63bd5d675187f4913357da33f66cb","msg":"MFA login successful"}
{"level":30,"time":1768087618296,"env":"test","module":"auth-routes","userId":"ddc63bd5d675187f4913357da33f66cb","deviceFingerprint":"10fa3aea039bf6fec7b6bcb982cbed1cc6ab844dd3c0879bec32baefb2997b52","msg":"Device marked as trusted"}
{"level":30,"time":1768087618765,"env":"test","module":"auth-routes","userId":"ddc63bd5d675187f4913357da33f66cb","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39m[TEST UTILS] MFA Secret verified for 1b66168a2553ddc0a5ef88b0e1d04461

{"level":30,"time":1768087620369,"env":"test","module":"auth-routes","userId":"1b66168a2553ddc0a5ef88b0e1d04461","msg":"Login requires MFA verification"}
{"level":30,"time":1768087620472,"env":"test","module":"mfa-service","userId":"1b66168a2553ddc0a5ef88b0e1d04461","msg":"TOTP verification successful"}
{"level":30,"time":1768087620522,"env":"test","module":"auth-routes","userId":"1b66168a2553ddc0a5ef88b0e1d04461","msg":"MFA login successful"}
{"level":30,"time":1768087620674,"env":"test","module":"auth-routes","userId":"1b66168a2553ddc0a5ef88b0e1d04461","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768087621361,"env":"test","module":"auth-routes","userId":"1b66168a2553ddc0a5ef88b0e1d04461","msg":"Login from trusted device - MFA skipped"}
{"level":30,"time":1768087621414,"env":"test","module":"auth-routes","userId":"1b66168a2553ddc0a5ef88b0e1d04461","msg":"User logged in successfully"}
{"level":30,"time":1768087621469,"env":"test","module":"audit-log-service","userId":"1b66168a2553ddc0a5ef88b0e1d04461","eventType":"login_success","ipAddress":"192.168.1.100","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m4 failed[39m[2m)[22m[33m 30097[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should trust current device [33m 2077[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set trust expiry to 30 days [33m 1904[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should update expiry if device already trusted [33m 2215[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 400[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all trusted devices[39m[33m 2886[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should mark current device [33m 1806[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude revoked devices[39m[33m 1775[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude expired devices[39m[33m 1752[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific device[39m[33m 1666[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 404 for non-existent device [33m 1819[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prevent revoking other user's device [33m 3452[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should skip MFA for trusted device [33m 2518[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require MFA for untrusted device [33m 2341[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should update lastUsedAt on trusted device login [33m 2754[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 4 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:193:31
    191|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    192| 
    193|       expect(response.status).toBe(200);
       |                               ^
    194|       expect(response.body.devices).toBeDefined();
    195|       expect(response.body.devices.length).toBe(2);

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/4]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude revoked devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:269:36
    267|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    268| 
    269|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    270|     });
    271| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/4]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude expired devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:302:36
    300|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    301| 
    302|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    303|     });
    304|   });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/4]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:332:45
    330|         .set("Authorization", `Bearer ${token}`);
    331| 
    332|       const deviceId = devicesResponse.body.devices[0].id;
       |                                             ^
    333| 
    334|       // Revoke device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/4]Î“Ã„Â»


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m4 failed[39m[22m[2m | [22m[1m[32m10 passed[39m[22m[90m (14)[39m
[2m   Start at [22m 17:24:28
[2m   Duration [22m 36.56s

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/routes/auth.routes.ts [22m[34mx10 [34m[39m
       [2m Filename pattern: [22m[34mtests/integration/trusted.devices.real.test.ts[39m

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã´Ã­ add observability to secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768096598720,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for dbc544d610e3bf52d8d9f5a058fdf652

{"level":30,"time":1768096601130,"env":"test","module":"auth-routes","userId":"dbc544d610e3bf52d8d9f5a058fdf652","msg":"Login requires MFA verification"}
{"level":40,"time":1768096601242,"env":"test","module":"mfa-service","userId":"dbc544d610e3bf52d8d9f5a058fdf652","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768096601242,"env":"test","module":"auth-routes","userId":"dbc544d610e3bf52d8d9f5a058fdf652","msg":"MFA verification failed during login"}
{"level":50,"time":1768096601249,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39m[TEST UTILS] MFA Secret verified for 465d129cc0799a214e370d0550c02f99

{"level":30,"time":1768096602894,"env":"test","module":"auth-routes","userId":"465d129cc0799a214e370d0550c02f99","msg":"Login requires MFA verification"}
{"level":30,"time":1768096603000,"env":"test","module":"mfa-service","userId":"465d129cc0799a214e370d0550c02f99","msg":"TOTP verification successful"}
{"level":30,"time":1768096603054,"env":"test","module":"auth-routes","userId":"465d129cc0799a214e370d0550c02f99","msg":"MFA login successful"}
{"level":30,"time":1768096603218,"env":"test","module":"auth-routes","userId":"465d129cc0799a214e370d0550c02f99","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for ce4d9b68d10dbac3b0d9ae09150dc153

{"level":30,"time":1768096604867,"env":"test","module":"auth-routes","userId":"ce4d9b68d10dbac3b0d9ae09150dc153","msg":"Login requires MFA verification"}
{"level":40,"time":1768096604974,"env":"test","module":"mfa-service","userId":"ce4d9b68d10dbac3b0d9ae09150dc153","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768096604974,"env":"test","module":"auth-routes","userId":"ce4d9b68d10dbac3b0d9ae09150dc153","msg":"MFA verification failed during login"}
{"level":50,"time":1768096604979,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768096605085,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768096605499,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39m[TEST UTILS] MFA Secret verified for 8d7ec45a6dc91cc8c9f6f3b0bbbb7591

{"level":50,"time":1768096606978,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":30,"time":1768096607089,"env":"test","module":"mfa-service","userId":"8d7ec45a6dc91cc8c9f6f3b0bbbb7591","msg":"TOTP verification successful"}
{"level":30,"time":1768096607142,"env":"test","module":"auth-routes","userId":"8d7ec45a6dc91cc8c9f6f3b0bbbb7591","msg":"MFA login successful"}
{"level":30,"time":1768096607318,"env":"test","module":"auth-routes","userId":"8d7ec45a6dc91cc8c9f6f3b0bbbb7591","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":50,"time":1768096607583,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":30,"time":1768096607696,"env":"test","module":"mfa-service","userId":"8d7ec45a6dc91cc8c9f6f3b0bbbb7591","msg":"TOTP verification successful"}
{"level":30,"time":1768096607749,"env":"test","module":"auth-routes","userId":"8d7ec45a6dc91cc8c9f6f3b0bbbb7591","msg":"MFA login successful"}
{"level":30,"time":1768096607916,"env":"test","module":"auth-routes","userId":"8d7ec45a6dc91cc8c9f6f3b0bbbb7591","deviceFingerprint":"091366faa1882b5c8dc1cba02126615a77a378274bbfd3375e821aa38bdd1b4f","msg":"Device marked as trusted"}
{"level":50,"time":1768096608184,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768096608293,"env":"test","module":"mfa-service","userId":"8d7ec45a6dc91cc8c9f6f3b0bbbb7591","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768096608293,"env":"test","module":"auth-routes","userId":"8d7ec45a6dc91cc8c9f6f3b0bbbb7591","msg":"MFA verification failed during login"}
{"level":50,"time":1768096608297,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for eb3a2d57091fc3d03fcd724145f7ebcd

{"level":50,"time":1768096609727,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":30,"time":1768096609841,"env":"test","module":"mfa-service","userId":"eb3a2d57091fc3d03fcd724145f7ebcd","msg":"TOTP verification successful"}
{"level":30,"time":1768096609895,"env":"test","module":"auth-routes","userId":"eb3a2d57091fc3d03fcd724145f7ebcd","msg":"MFA login successful"}
{"level":30,"time":1768096610061,"env":"test","module":"auth-routes","userId":"eb3a2d57091fc3d03fcd724145f7ebcd","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768096610167,"env":"test","module":"auth-routes","userId":"eb3a2d57091fc3d03fcd724145f7ebcd","deviceCount":1,"msg":"Listed trusted devices"}
{"level":50,"time":1768096611634,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768096611739,"env":"test","module":"mfa-service","userId":"1c9438714bc506d2c443406ea16d9772","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768096611740,"env":"test","module":"auth-routes","userId":"1c9438714bc506d2c443406ea16d9772","msg":"MFA verification failed during login"}
{"level":50,"time":1768096611743,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768096611798,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768096613221,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768096613331,"env":"test","module":"mfa-service","userId":"b61f1009c73c1055b67c3b0ce4346737","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768096613331,"env":"test","module":"auth-routes","userId":"b61f1009c73c1055b67c3b0ce4346737","msg":"MFA verification failed during login"}
{"level":50,"time":1768096613335,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768096613390,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768096614850,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768096614964,"env":"test","module":"mfa-service","userId":"902d9765c235c16950bf9e469f4727c4","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768096614964,"env":"test","module":"auth-routes","userId":"902d9765c235c16950bf9e469f4727c4","msg":"MFA verification failed during login"}
{"level":50,"time":1768096614969,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768096614974,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39m[TEST UTILS] MFA Secret verified for 1c9438714bc506d2c443406ea16d9772

{"level":50,"time":1768096616482,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768096616590,"env":"test","module":"mfa-service","userId":"ac28a6b25e592b26c084c3f0e357666c","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768096616590,"env":"test","module":"auth-routes","userId":"ac28a6b25e592b26c084c3f0e357666c","msg":"MFA verification failed during login"}
{"level":50,"time":1768096616596,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768096618846,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768096618950,"env":"test","module":"mfa-service","userId":"9413a2de7ccec5ad9a606d469108183d","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768096618950,"env":"test","module":"auth-routes","userId":"9413a2de7ccec5ad9a606d469108183d","msg":"MFA verification failed during login"}
{"level":50,"time":1768096618954,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768096618957,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768096620435,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768096620550,"env":"test","module":"mfa-service","userId":"3dafebd538ae01705dccb5259af1811f","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768096620550,"env":"test","module":"auth-routes","userId":"3dafebd538ae01705dccb5259af1811f","msg":"MFA verification failed during login"}
{"level":50,"time":1768096620556,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768096620831,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":50,"time":1768096623244,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768096623354,"env":"test","module":"mfa-service","userId":"f316b84381e01f87de6dbb424260139d","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768096623354,"env":"test","module":"auth-routes","userId":"f316b84381e01f87de6dbb424260139d","msg":"MFA verification failed during login"}
{"level":50,"time":1768096623359,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for b61f1009c73c1055b67c3b0ce4346737

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for 902d9765c235c16950bf9e469f4727c4

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39m[TEST UTILS] MFA Secret verified for ac28a6b25e592b26c084c3f0e357666c

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 9413a2de7ccec5ad9a606d469108183d

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 92f42ef8c779ed9d0507820c58892d77

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39m[TEST UTILS] MFA Secret verified for 3dafebd538ae01705dccb5259af1811f

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39m[TEST UTILS] MFA Secret verified for f316b84381e01f87de6dbb424260139d

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m11 failed[39m[2m)[22m[33m 24677[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should trust current device[39m[33m 1787[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set trust expiry to 30 days [33m 1962[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update expiry if device already trusted[39m[33m 1867[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 413[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all trusted devices[39m[33m 2800[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should mark current device [33m 1868[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude revoked devices[39m[33m 1632[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude expired devices[39m[33m 1591[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific device[39m[33m 1584[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 404 for non-existent device[39m[33m 1623[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent revoking other user's device[39m[33m 2360[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should skip MFA for trusted device[39m[33m 1875[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should require MFA for untrusted device[39m[33m 948[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update lastUsedAt on trusted device login[39m[33m 1630[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 11 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should trust current device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:52:36
     50|         .set("X-Forwarded-For", "192.168.1.100");
     51| 
     52|       expect(trustResponse.status).toBe(200);
       |                                    ^
     53|       expect(trustResponse.body.message).toContain("trusted");
     54|       expect(trustResponse.body.trustedUntil).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should update expiry if device already trusted
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:132:42
    130| 
    131|       // Should have extended expiry
    132|       expect(secondExpiry > firstExpiry).toBe(true);
       |                                          ^
    133| 
    134|       // Should still only have 1 device record

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:193:31
    191|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    192| 
    193|       expect(response.status).toBe(200);
       |                               ^
    194|       expect(response.body.devices).toBeDefined();
    195|       expect(response.body.devices.length).toBe(2);

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude revoked devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:269:36
    267|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    268| 
    269|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    270|     });
    271| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude expired devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:302:36
    300|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    301| 
    302|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    303|     });
    304|   });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:332:45
    330|         .set("Authorization", `Bearer ${token}`);
    331| 
    332|       const deviceId = devicesResponse.body.devices[0].id;
       |                                             ^
    333| 
    334|       // Revoke device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should return 404 for non-existent device
AssertionError: expected 401 to be 404 // Object.is equality

- Expected
+ Received

- 404
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:371:31
    369|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    370| 
    371|       expect(response.status).toBe(404);
       |                               ^
    372|     });
    373| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[7/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should prevent revoking other user's device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:399:43
    397|         .set("Authorization", `Bearer ${mfaLogin1.body.token}`);
    398| 
    399|       const user1DeviceId = devices1.body.devices[0].id;
       |                                           ^
    400| 
    401|       // User 2 tries to revoke user 1's device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[8/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:453:42
    451| 
    452|       // Should not require MFA
    453|       expect(secondLoginResponse.status).toBe(200);
       |                                          ^
    454|       expect(secondLoginResponse.body.requiresMfa).toBeUndefined();
    455|       expect(secondLoginResponse.body.token).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[9/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
Error: [TEST UTILS] MFA Secret verification failed for 3fc57aab4aec26b5841061c366858d8c
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:182:21
    180|     where: eq(mfaSecrets.userId, userData.userId)
    181|   });
    182|   if (!check) throw new Error(`[TEST UTILS] MFA Secret verification faÎ“Ã‡Âª
       |                     ^
    183|   if (!check.enabled) throw new Error(`[TEST UTILS] MFA Secret enabledÎ“Ã‡Âª
    184|   console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}Î“Ã‡Âª
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:459:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[10/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should update lastUsedAt on trusted device login
TypeError: Cannot read properties of undefined (reading 'lastUsedAt')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:512:38
    510|       });
    511| 
    512|       const firstLastUsed = device1!.lastUsedAt;
       |                                      ^
    513| 
    514|       // Wait a bit

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[11/11]Î“Ã„Â»


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m11 failed[39m[22m[2m | [22m[1m[32m3 passed[39m[22m[90m (14)[39m
[2m   Start at [22m 19:56:35
[2m   Duration [22m 26.29s

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/routes/auth.routes.ts [22m[34mx11 [34m[39m
       [2m Filename pattern: [22m[34mtests/integration/trusted.devices.real.test.ts[39m

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768143607659,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

{"level":30,"time":1768143611607,"env":"test","module":"auth-routes","userId":"967b8230f2e37469026c983c2e527e6d","msg":"Login requires MFA verification"}
{"level":30,"time":1768143611716,"env":"test","module":"mfa-service","userId":"967b8230f2e37469026c983c2e527e6d","msg":"TOTP verification successful"}
{"level":30,"time":1768143611770,"env":"test","module":"auth-routes","userId":"967b8230f2e37469026c983c2e527e6d","msg":"MFA login successful"}
{"level":30,"time":1768143611937,"env":"test","module":"auth-routes","userId":"967b8230f2e37469026c983c2e527e6d","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768143613653,"env":"test","module":"auth-routes","userId":"764b7fd0f05d56fd704ac4a8354970a5","msg":"Login requires MFA verification"}
{"level":30,"time":1768143613767,"env":"test","module":"mfa-service","userId":"764b7fd0f05d56fd704ac4a8354970a5","msg":"TOTP verification successful"}
{"level":30,"time":1768143613821,"env":"test","module":"auth-routes","userId":"764b7fd0f05d56fd704ac4a8354970a5","msg":"MFA login successful"}
{"level":30,"time":1768143613998,"env":"test","module":"auth-routes","userId":"764b7fd0f05d56fd704ac4a8354970a5","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768143615689,"env":"test","module":"auth-routes","userId":"a1b8ac086d1190eccd8c8611f4982a2a","msg":"Login requires MFA verification"}
{"level":30,"time":1768143615801,"env":"test","module":"mfa-service","userId":"a1b8ac086d1190eccd8c8611f4982a2a","msg":"TOTP verification successful"}
{"level":30,"time":1768143615854,"env":"test","module":"auth-routes","userId":"a1b8ac086d1190eccd8c8611f4982a2a","msg":"MFA login successful"}
{"level":30,"time":1768143616026,"env":"test","module":"auth-routes","userId":"a1b8ac086d1190eccd8c8611f4982a2a","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768143616283,"env":"test","module":"auth-routes","userId":"a1b8ac086d1190eccd8c8611f4982a2a","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Trusted device expiry updated"}
{"level":50,"time":1768143616764,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768143618520,"env":"test","module":"auth-routes","userId":"6ed4c61b2554274991062bb63f40f0d4","msg":"Login requires MFA verification"}
{"level":30,"time":1768143618635,"env":"test","module":"mfa-service","userId":"6ed4c61b2554274991062bb63f40f0d4","msg":"TOTP verification successful"}
{"level":30,"time":1768143618685,"env":"test","module":"auth-routes","userId":"6ed4c61b2554274991062bb63f40f0d4","msg":"MFA login successful"}
{"level":30,"time":1768143618848,"env":"test","module":"auth-routes","userId":"6ed4c61b2554274991062bb63f40f0d4","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":50,"time":1768143619119,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768143619229,"env":"test","module":"mfa-service","userId":"6ed4c61b2554274991062bb63f40f0d4","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143619229,"env":"test","module":"auth-routes","userId":"6ed4c61b2554274991062bb63f40f0d4","msg":"MFA verification failed during login"}
{"level":50,"time":1768143619235,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143619506,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for 967b8230f2e37469026c983c2e527e6d

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39m[TEST UTILS] MFA Secret verified for 764b7fd0f05d56fd704ac4a8354970a5

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for a1b8ac086d1190eccd8c8611f4982a2a

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39m[TEST UTILS] MFA Secret verified for 6ed4c61b2554274991062bb63f40f0d4

{"level":40,"time":1768143619618,"env":"test","module":"mfa-service","userId":"6ed4c61b2554274991062bb63f40f0d4","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143619618,"env":"test","module":"auth-routes","userId":"6ed4c61b2554274991062bb63f40f0d4","msg":"MFA verification failed during login"}
{"level":50,"time":1768143619622,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for 9958ab0070e3a7677cf020d5c7c8fd88

{"level":50,"time":1768143621596,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768143621710,"env":"test","module":"mfa-service","userId":"9958ab0070e3a7677cf020d5c7c8fd88","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143621710,"env":"test","module":"auth-routes","userId":"9958ab0070e3a7677cf020d5c7c8fd88","msg":"MFA verification failed during login"}
{"level":50,"time":1768143621716,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143621721,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for d34bcd7fce2c99450467f372c1c26b97

{"level":50,"time":1768143624514,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768143624623,"env":"test","module":"mfa-service","userId":"d34bcd7fce2c99450467f372c1c26b97","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143624623,"env":"test","module":"auth-routes","userId":"d34bcd7fce2c99450467f372c1c26b97","msg":"MFA verification failed during login"}
{"level":50,"time":1768143624629,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143624683,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for 416b957ace83db8e316ce27ac7768031

{"level":50,"time":1768143626541,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768143626655,"env":"test","module":"mfa-service","userId":"416b957ace83db8e316ce27ac7768031","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143626655,"env":"test","module":"auth-routes","userId":"416b957ace83db8e316ce27ac7768031","msg":"MFA verification failed during login"}
{"level":50,"time":1768143626661,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143626666,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39m[TEST UTILS] MFA Secret verified for 46d6cc4a6b7a06fc2512ba7d7ff7613b

{"level":50,"time":1768143628499,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768143628613,"env":"test","module":"mfa-service","userId":"46d6cc4a6b7a06fc2512ba7d7ff7613b","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143628613,"env":"test","module":"auth-routes","userId":"46d6cc4a6b7a06fc2512ba7d7ff7613b","msg":"MFA verification failed during login"}
{"level":50,"time":1768143628618,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 15eebfbe6ca67249d1ec23e202aa6cec

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for dfaf7ce4b49b668b79c8beb3d19923c8

{"level":50,"time":1768143631662,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768143631774,"env":"test","module":"mfa-service","userId":"15eebfbe6ca67249d1ec23e202aa6cec","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143631774,"env":"test","module":"auth-routes","userId":"15eebfbe6ca67249d1ec23e202aa6cec","msg":"MFA verification failed during login"}
{"level":50,"time":1768143631778,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143631782,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39m[TEST UTILS] MFA Secret verified for a95d38a2c2b3b02862f6b62ba8c7292d

{"level":50,"time":1768143634657,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768143634767,"env":"test","module":"mfa-service","userId":"a95d38a2c2b3b02862f6b62ba8c7292d","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143634768,"env":"test","module":"auth-routes","userId":"a95d38a2c2b3b02862f6b62ba8c7292d","msg":"MFA verification failed during login"}
{"level":50,"time":1768143634773,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143635070,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m10 failed[39m[2m)[22m[33m 27281[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should trust current device [33m 2064[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set trust expiry to 30 days [33m 2008[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should update expiry if device already trusted [33m 2344[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 422[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all trusted devices[39m[33m 2865[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should mark current device[39m[33m 2093[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude revoked devices[39m[33m 941[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude expired devices[39m[33m 2020[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific device[39m[33m 1982[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 404 for non-existent device[39m[33m 1953[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent revoking other user's device[39m[33m 3163[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should skip MFA for trusted device[39m[33m 1246[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should require MFA for untrusted device[39m[33m 2044[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update lastUsedAt on trusted device login[39m[33m 981[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 10 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:193:31
    191|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    192| 
    193|       expect(response.status).toBe(200);
       |                               ^
    194|       expect(response.body.devices).toBeDefined();
    195|       expect(response.body.devices.length).toBe(2);

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should mark current device
TypeError: Cannot read properties of undefined (reading 'find')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:236:51
    234|         .set("X-Forwarded-For", "192.168.1.100");
    235| 
    236|       const currentDevice = response.body.devices.find((d: any) => d.cÎ“Ã‡Âª
       |                                                   ^
    237|       expect(currentDevice).toBeDefined();
    238|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude revoked devices
Error: [TEST UTILS] MFA Secret verification failed for ae07d7380b70ec44352e4b8391f09648
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:182:21
    180|     where: eq(mfaSecrets.userId, userData.userId)
    181|   });
    182|   if (!check) throw new Error(`[TEST UTILS] MFA Secret verification faÎ“Ã‡Âª
       |                     ^
    183|   if (!check.enabled) throw new Error(`[TEST UTILS] MFA Secret enabledÎ“Ã‡Âª
    184|   console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}Î“Ã‡Âª
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:241:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude expired devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:302:36
    300|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    301| 
    302|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    303|     });
    304|   });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:332:45
    330|         .set("Authorization", `Bearer ${token}`);
    331| 
    332|       const deviceId = devicesResponse.body.devices[0].id;
       |                                             ^
    333| 
    334|       // Revoke device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should return 404 for non-existent device
AssertionError: expected 401 to be 404 // Object.is equality

- Expected
+ Received

- 404
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:371:31
    369|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    370| 
    371|       expect(response.status).toBe(404);
       |                               ^
    372|     });
    373| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should prevent revoking other user's device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:399:43
    397|         .set("Authorization", `Bearer ${mfaLogin1.body.token}`);
    398| 
    399|       const user1DeviceId = devices1.body.devices[0].id;
       |                                           ^
    400| 
    401|       // User 2 tries to revoke user 1's device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[7/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
Error: [TEST UTILS] MFA Secret verification failed for 1013d15b23503d7beb8d6e03665451b4
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:182:21
    180|     where: eq(mfaSecrets.userId, userData.userId)
    181|   });
    182|   if (!check) throw new Error(`[TEST UTILS] MFA Secret verification faÎ“Ã‡Âª
       |                     ^
    183|   if (!check.enabled) throw new Error(`[TEST UTILS] MFA Secret enabledÎ“Ã‡Âª
    184|   console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}Î“Ã‡Âª
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:422:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[8/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
AssertionError: expected undefined to be true // Object.is equality

- Expected: 
true

+ Received: 
undefined

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:485:51
    483| 
    484|       // Should require MFA
    485|       expect(loginFromNewDevice.body.requiresMfa).toBe(true);
       |                                                   ^
    486|     });
    487| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[9/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should update lastUsedAt on trusted device login
Error: [TEST UTILS] MFA Secret verification failed for 60c4471c61dbdc9ac859fb08ccf08761
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:182:21
    180|     where: eq(mfaSecrets.userId, userData.userId)
    181|   });
    182|   if (!check) throw new Error(`[TEST UTILS] MFA Secret verification faÎ“Ã‡Âª
       |                     ^
    183|   if (!check.enabled) throw new Error(`[TEST UTILS] MFA Secret enabledÎ“Ã‡Âª
    184|   console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}Î“Ã‡Âª
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:489:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[10/10]Î“Ã„Â»


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m10 failed[39m[22m[2m | [22m[1m[32m4 passed[39m[22m[90m (14)[39m
[2m   Start at [22m 08:58:57
[2m   Duration [22m 86.92s

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/routes/auth.routes.ts [22m[34mx12 [34m[39m
       [2m Filename pattern: [22m[34mtests/integration/trusted.devices.real.test.ts[39m

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

{"level":30,"time":1768143761692,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for 00538dcbd14e6285de59533929d9ba83

{"level":30,"time":1768143765414,"env":"test","module":"auth-routes","userId":"00538dcbd14e6285de59533929d9ba83","msg":"Login requires MFA verification"}
{"level":30,"time":1768143765525,"env":"test","module":"mfa-service","userId":"00538dcbd14e6285de59533929d9ba83","msg":"TOTP verification successful"}
{"level":30,"time":1768143765584,"env":"test","module":"auth-routes","userId":"00538dcbd14e6285de59533929d9ba83","msg":"MFA login successful"}
{"level":30,"time":1768143765758,"env":"test","module":"auth-routes","userId":"00538dcbd14e6285de59533929d9ba83","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768143767483,"env":"test","module":"auth-routes","userId":"36653963e30fecace17e6968f1a3993c","msg":"Login requires MFA verification"}
{"level":40,"time":1768143767586,"env":"test","module":"mfa-service","userId":"36653963e30fecace17e6968f1a3993c","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143767586,"env":"test","module":"auth-routes","userId":"36653963e30fecace17e6968f1a3993c","msg":"MFA verification failed during login"}
{"level":50,"time":1768143767593,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768143769231,"env":"test","module":"auth-routes","userId":"5d5f245f48bbd026dd4b885fd55eecb0","msg":"Login requires MFA verification"}
{"level":30,"time":1768143769337,"env":"test","module":"mfa-service","userId":"5d5f245f48bbd026dd4b885fd55eecb0","msg":"TOTP verification successful"}
{"level":30,"time":1768143769387,"env":"test","module":"auth-routes","userId":"5d5f245f48bbd026dd4b885fd55eecb0","msg":"MFA login successful"}
{"level":30,"time":1768143769555,"env":"test","module":"auth-routes","userId":"5d5f245f48bbd026dd4b885fd55eecb0","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768143769815,"env":"test","module":"auth-routes","userId":"5d5f245f48bbd026dd4b885fd55eecb0","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":50,"time":1768143770278,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143771701,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768143771808,"env":"test","module":"mfa-service","userId":"c9cf6b3b934ff740f88d685c6946a1aa","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143771808,"env":"test","module":"auth-routes","userId":"c9cf6b3b934ff740f88d685c6946a1aa","msg":"MFA verification failed during login"}
{"level":50,"time":1768143771813,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143772073,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768143772174,"env":"test","module":"mfa-service","userId":"c9cf6b3b934ff740f88d685c6946a1aa","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143772174,"env":"test","module":"auth-routes","userId":"c9cf6b3b934ff740f88d685c6946a1aa","msg":"MFA verification failed during login"}
{"level":50,"time":1768143772177,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143772447,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768143772549,"env":"test","module":"mfa-service","userId":"c9cf6b3b934ff740f88d685c6946a1aa","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143772549,"env":"test","module":"auth-routes","userId":"c9cf6b3b934ff740f88d685c6946a1aa","msg":"MFA verification failed during login"}
{"level":50,"time":1768143772553,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39m[TEST UTILS] MFA Secret verified for 36653963e30fecace17e6968f1a3993c

{"level":30,"time":1768143774160,"env":"test","module":"auth-routes","userId":"32935fbfab1148d2e82dbf0a06d40669","msg":"Login requires MFA verification"}
{"level":40,"time":1768143774268,"env":"test","module":"mfa-service","userId":"32935fbfab1148d2e82dbf0a06d40669","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143774268,"env":"test","module":"auth-routes","userId":"32935fbfab1148d2e82dbf0a06d40669","msg":"MFA verification failed during login"}
{"level":50,"time":1768143774273,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143774277,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768143775916,"env":"test","module":"auth-routes","userId":"ef8a167624d50b48c36cc65c9189df6b","msg":"Login requires MFA verification"}
{"level":30,"time":1768143776025,"env":"test","module":"mfa-service","userId":"ef8a167624d50b48c36cc65c9189df6b","msg":"TOTP verification successful"}
{"level":30,"time":1768143776077,"env":"test","module":"auth-routes","userId":"ef8a167624d50b48c36cc65c9189df6b","msg":"MFA login successful"}
{"level":30,"time":1768143776234,"env":"test","module":"auth-routes","userId":"ef8a167624d50b48c36cc65c9189df6b","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768143776393,"env":"test","module":"auth-routes","userId":"ef8a167624d50b48c36cc65c9189df6b","deviceCount":0,"msg":"Listed trusted devices"}
{"level":30,"time":1768143778144,"env":"test","module":"auth-routes","userId":"6d8ceb719d008e8292ef17d3eb9f9010","msg":"Login requires MFA verification"}
{"level":40,"time":1768143778250,"env":"test","module":"mfa-service","userId":"6d8ceb719d008e8292ef17d3eb9f9010","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143778250,"env":"test","module":"auth-routes","userId":"6d8ceb719d008e8292ef17d3eb9f9010","msg":"MFA verification failed during login"}
{"level":50,"time":1768143778254,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143778312,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768143780359,"env":"test","module":"auth-routes","userId":"20d0ef83e88689d346e38ef70bbcd5fa","msg":"Login requires MFA verification"}
{"level":40,"time":1768143780467,"env":"test","module":"mfa-service","userId":"20d0ef83e88689d346e38ef70bbcd5fa","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143780467,"env":"test","module":"auth-routes","userId":"20d0ef83e88689d346e38ef70bbcd5fa","msg":"MFA verification failed during login"}
{"level":50,"time":1768143780472,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143780478,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143782340,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for 5d5f245f48bbd026dd4b885fd55eecb0

{"level":40,"time":1768143782450,"env":"test","module":"mfa-service","userId":"82bbd5254520fafef96b15c9302f3f7c","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143782450,"env":"test","module":"auth-routes","userId":"82bbd5254520fafef96b15c9302f3f7c","msg":"MFA verification failed during login"}
{"level":50,"time":1768143782455,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39m[TEST UTILS] MFA Secret verified for c9cf6b3b934ff740f88d685c6946a1aa

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for 32935fbfab1148d2e82dbf0a06d40669

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39m[TEST UTILS] MFA Secret verified for ef8a167624d50b48c36cc65c9189df6b

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for 6d8ceb719d008e8292ef17d3eb9f9010

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for 20d0ef83e88689d346e38ef70bbcd5fa

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39m[TEST UTILS] MFA Secret verified for 82bbd5254520fafef96b15c9302f3f7c

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for ef25e7c3c0638ea725a4fd101356aaa5

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 17ffdd0bc5d193050ed53ab3bc86ae03

{"level":50,"time":1768143784909,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768143785024,"env":"test","module":"mfa-service","userId":"ef25e7c3c0638ea725a4fd101356aaa5","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143785024,"env":"test","module":"auth-routes","userId":"ef25e7c3c0638ea725a4fd101356aaa5","msg":"MFA verification failed during login"}
{"level":50,"time":1768143785028,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143785032,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39m[TEST UTILS] MFA Secret verified for 3cbe038fd1fcedf560df4d30d15aeaa2

{"level":50,"time":1768143786590,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768143786702,"env":"test","module":"mfa-service","userId":"3cbe038fd1fcedf560df4d30d15aeaa2","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143786702,"env":"test","module":"auth-routes","userId":"3cbe038fd1fcedf560df4d30d15aeaa2","msg":"MFA verification failed during login"}
{"level":50,"time":1768143786708,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143786981,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39m[TEST UTILS] MFA Secret verified for 782e1401069d9acf0930d0ce2c7ac800

{"level":50,"time":1768143788667,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768143788785,"env":"test","module":"mfa-service","userId":"782e1401069d9acf0930d0ce2c7ac800","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143788785,"env":"test","module":"auth-routes","userId":"782e1401069d9acf0930d0ce2c7ac800","msg":"MFA verification failed during login"}
{"level":50,"time":1768143788791,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143789081,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39m[TEST UTILS] MFA Secret verified for a56ffc32ded072d849caae4f68c71bee

{"level":50,"time":1768143790967,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768143791085,"env":"test","module":"mfa-service","userId":"a56ffc32ded072d849caae4f68c71bee","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143791085,"env":"test","module":"auth-routes","userId":"a56ffc32ded072d849caae4f68c71bee","msg":"MFA verification failed during login"}
{"level":50,"time":1768143791089,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m10 failed[39m[2m)[22m[33m 28966[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should trust current device [33m 2536[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set trust expiry to 30 days[39m[33m 1792[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should update expiry if device already trusted [33m 2267[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 409[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all trusted devices[39m[33m 2274[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should mark current device[39m[33m 1725[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should exclude revoked devices [33m 2115[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude expired devices[39m[33m 1920[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific device[39m[33m 2165[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 404 for non-existent device[39m[33m 1978[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent revoking other user's device[39m[33m 2576[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should skip MFA for trusted device[39m[33m 1949[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should require MFA for untrusted device[39m[33m 2102[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update lastUsedAt on trusted device login[39m[33m 2061[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 10 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should set trust expiry to 30 days
AssertionError: expected NaN to be 30 // Object.is equality

- Expected
+ Received

- 30
+ NaN

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:92:24

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:193:31

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should mark current device
TypeError: Cannot read properties of undefined (reading 'find')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:236:51

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude expired devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:302:36

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:332:45

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should return 404 for non-existent device
AssertionError: expected 401 to be 404 // Object.is equality

- Expected
+ Received

- 404
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:371:31

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should prevent revoking other user's device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:399:43

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[7/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:453:42

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[8/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
AssertionError: expected undefined to be true // Object.is equality

- Expected: 
true

+ Received: 
undefined

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:485:51

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[9/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should update lastUsedAt on trusted device login
TypeError: Cannot read properties of undefined (reading 'lastUsedAt')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:512:38

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[10/10]Î“Ã„Â»


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m10 failed[39m[22m[2m | [22m[1m[32m4 passed[39m[22m[90m (14)[39m
[2m   Start at [22m 09:01:03
[2m   Duration [22m 116.16s

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/routes/auth.routes.ts [22m[34mx13 [34m[39m
       [2m Filename pattern: [22m[34mtests/integration/trusted.devices.real.test.ts[39m

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild

{"level":30,"time":1768143865829,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":50,"time":1768143872739,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768143872855,"env":"test","module":"mfa-service","userId":"085420026c6fd99d38f6b6765c0ae968","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143872855,"env":"test","module":"auth-routes","userId":"085420026c6fd99d38f6b6765c0ae968","msg":"MFA verification failed during login"}
{"level":50,"time":1768143872861,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for 085420026c6fd99d38f6b6765c0ae968

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39m[TEST UTILS] MFA Secret verified for a9cd5da8c99eff47842adef533201c93

{"level":50,"time":1768143874473,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768143874591,"env":"test","module":"mfa-service","userId":"a9cd5da8c99eff47842adef533201c93","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143874591,"env":"test","module":"auth-routes","userId":"a9cd5da8c99eff47842adef533201c93","msg":"MFA verification failed during login"}
{"level":50,"time":1768143874599,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143876005,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768143876107,"env":"test","module":"mfa-service","userId":"a6255bc58a77d8de964c62f1feaaaca3","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143876107,"env":"test","module":"auth-routes","userId":"a6255bc58a77d8de964c62f1feaaaca3","msg":"MFA verification failed during login"}
{"level":50,"time":1768143876111,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143876217,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143876613,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143878036,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768143878141,"env":"test","module":"mfa-service","userId":"60332bcb4bf23a7bc8016eb043efff80","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143878141,"env":"test","module":"auth-routes","userId":"60332bcb4bf23a7bc8016eb043efff80","msg":"MFA verification failed during login"}
{"level":50,"time":1768143878147,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143878412,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768143878519,"env":"test","module":"mfa-service","userId":"60332bcb4bf23a7bc8016eb043efff80","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143878520,"env":"test","module":"auth-routes","userId":"60332bcb4bf23a7bc8016eb043efff80","msg":"MFA verification failed during login"}
{"level":50,"time":1768143878524,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143878782,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768143878888,"env":"test","module":"mfa-service","userId":"60332bcb4bf23a7bc8016eb043efff80","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143878888,"env":"test","module":"auth-routes","userId":"60332bcb4bf23a7bc8016eb043efff80","msg":"MFA verification failed during login"}
{"level":50,"time":1768143878893,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768143880541,"env":"test","module":"auth-routes","userId":"55528c1d97604be0aa1485f9a017f6bd","msg":"Login requires MFA verification"}
{"level":40,"time":1768143880646,"env":"test","module":"mfa-service","userId":"55528c1d97604be0aa1485f9a017f6bd","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143880646,"env":"test","module":"auth-routes","userId":"55528c1d97604be0aa1485f9a017f6bd","msg":"MFA verification failed during login"}
{"level":50,"time":1768143880650,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143880653,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143882062,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768143882167,"env":"test","module":"mfa-service","userId":"8bc63061e80b1afe69989a90d9a33bd2","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143882167,"env":"test","module":"auth-routes","userId":"8bc63061e80b1afe69989a90d9a33bd2","msg":"MFA verification failed during login"}
{"level":50,"time":1768143882171,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143882223,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143883670,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768143883774,"env":"test","module":"mfa-service","userId":"2103b30f6334a9de7324f227dc9c6ac3","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143883774,"env":"test","module":"auth-routes","userId":"2103b30f6334a9de7324f227dc9c6ac3","msg":"MFA verification failed during login"}
{"level":50,"time":1768143883780,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143883831,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143885236,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768143885344,"env":"test","module":"mfa-service","userId":"bb2c0264a7c42a5e1464ac69f16e0777","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143885344,"env":"test","module":"auth-routes","userId":"bb2c0264a7c42a5e1464ac69f16e0777","msg":"MFA verification failed during login"}
{"level":50,"time":1768143885348,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143885351,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143886763,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768143886872,"env":"test","module":"mfa-service","userId":"e68c27841cb83c1ad7d808215c72b5ff","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143886872,"env":"test","module":"auth-routes","userId":"e68c27841cb83c1ad7d808215c72b5ff","msg":"MFA verification failed during login"}
{"level":50,"time":1768143886878,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143889098,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768143889201,"env":"test","module":"mfa-service","userId":"28820820733f0e66c4f957104b0eb814","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143889201,"env":"test","module":"auth-routes","userId":"28820820733f0e66c4f957104b0eb814","msg":"MFA verification failed during login"}
{"level":50,"time":1768143889204,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143889209,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for a6255bc58a77d8de964c62f1feaaaca3

{"level":50,"time":1768143890615,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768143890718,"env":"test","module":"mfa-service","userId":"c53d4d7be6307d44246b094ba1f5c1f8","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143890718,"env":"test","module":"auth-routes","userId":"c53d4d7be6307d44246b094ba1f5c1f8","msg":"MFA verification failed during login"}
{"level":50,"time":1768143890722,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143890982,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":30,"time":1768143892658,"env":"test","module":"auth-routes","userId":"1ff1d68804128519d8a46c5b18d35559","msg":"Login requires MFA verification"}
{"level":40,"time":1768143892770,"env":"test","module":"mfa-service","userId":"1ff1d68804128519d8a46c5b18d35559","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143892770,"env":"test","module":"auth-routes","userId":"1ff1d68804128519d8a46c5b18d35559","msg":"MFA verification failed during login"}
{"level":50,"time":1768143892774,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768143893043,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":30,"time":1768143894656,"env":"test","module":"auth-routes","userId":"169308b059da563e038007d8ae39d706","msg":"Login requires MFA verification"}
{"level":40,"time":1768143894762,"env":"test","module":"mfa-service","userId":"169308b059da563e038007d8ae39d706","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768143894762,"env":"test","module":"auth-routes","userId":"169308b059da563e038007d8ae39d706","msg":"MFA verification failed during login"}
{"level":50,"time":1768143894766,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39m[TEST UTILS] MFA Secret verified for 60332bcb4bf23a7bc8016eb043efff80

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for 55528c1d97604be0aa1485f9a017f6bd

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39m[TEST UTILS] MFA Secret verified for 8bc63061e80b1afe69989a90d9a33bd2

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for 2103b30f6334a9de7324f227dc9c6ac3

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for bb2c0264a7c42a5e1464ac69f16e0777

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39m[TEST UTILS] MFA Secret verified for e68c27841cb83c1ad7d808215c72b5ff

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 28820820733f0e66c4f957104b0eb814

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for ac43e7031e9dc471092e36401ee994f9

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39m[TEST UTILS] MFA Secret verified for c53d4d7be6307d44246b094ba1f5c1f8

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39m[TEST UTILS] MFA Secret verified for 1ff1d68804128519d8a46c5b18d35559

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39m[TEST UTILS] MFA Secret verified for 169308b059da563e038007d8ae39d706

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m13 failed[39m[2m)[22m[33m 24247[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should trust current device[39m[33m 1584[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set trust expiry to 30 days[39m[33m 1732[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update expiry if device already trusted[39m[33m 1615[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 396[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all trusted devices[39m[33m 2281[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should mark current device[39m[33m 1759[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude revoked devices[39m[33m 1569[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude expired devices[39m[33m 1609[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific device[39m[33m 1520[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 404 for non-existent device[39m[33m 1528[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent revoking other user's device[39m[33m 2330[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should skip MFA for trusted device[39m[33m 1773[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should require MFA for untrusted device[39m[33m 2061[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update lastUsedAt on trusted device login[39m[33m 1771[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 13 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should trust current device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:52:36
     50|         .set("X-Forwarded-For", "192.168.1.100");
     51| 
     52|       expect(trustResponse.status).toBe(200);
       |                                    ^
     53|       expect(trustResponse.body.message).toContain("trusted");
     54|       expect(trustResponse.body.trustedUntil).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should set trust expiry to 30 days
AssertionError: expected NaN to be 30 // Object.is equality

- Expected
+ Received

- 30
+ NaN

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:92:24
     90|       );
     91| 
     92|       expect(diffDays).toBe(30);
       |                        ^
     93|     });
     94| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should update expiry if device already trusted
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:132:42
    130| 
    131|       // Should have extended expiry
    132|       expect(secondExpiry > firstExpiry).toBe(true);
       |                                          ^
    133| 
    134|       // Should still only have 1 device record

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:193:31
    191|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    192| 
    193|       expect(response.status).toBe(200);
       |                               ^
    194|       expect(response.body.devices).toBeDefined();
    195|       expect(response.body.devices.length).toBe(2);

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should mark current device
TypeError: Cannot read properties of undefined (reading 'find')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:236:51
    234|         .set("X-Forwarded-For", "192.168.1.100");
    235| 
    236|       const currentDevice = response.body.devices.find((d: any) => d.cÎ“Ã‡Âª
       |                                                   ^
    237|       expect(currentDevice).toBeDefined();
    238|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude revoked devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:269:36
    267|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    268| 
    269|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    270|     });
    271| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude expired devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:302:36
    300|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    301| 
    302|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    303|     });
    304|   });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[7/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:332:45
    330|         .set("Authorization", `Bearer ${token}`);
    331| 
    332|       const deviceId = devicesResponse.body.devices[0].id;
       |                                             ^
    333| 
    334|       // Revoke device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[8/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should return 404 for non-existent device
AssertionError: expected 401 to be 404 // Object.is equality

- Expected
+ Received

- 404
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:371:31
    369|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    370| 
    371|       expect(response.status).toBe(404);
       |                               ^
    372|     });
    373| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[9/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should prevent revoking other user's device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:399:43
    397|         .set("Authorization", `Bearer ${mfaLogin1.body.token}`);
    398| 
    399|       const user1DeviceId = devices1.body.devices[0].id;
       |                                           ^
    400| 
    401|       // User 2 tries to revoke user 1's device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[10/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:453:42
    451| 
    452|       // Should not require MFA
    453|       expect(secondLoginResponse.status).toBe(200);
       |                                          ^
    454|       expect(secondLoginResponse.body.requiresMfa).toBeUndefined();
    455|       expect(secondLoginResponse.body.token).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[11/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
AssertionError: expected undefined to be true // Object.is equality

- Expected: 
true

+ Received: 
undefined

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:485:51
    483| 
    484|       // Should require MFA
    485|       expect(loginFromNewDevice.body.requiresMfa).toBe(true);
       |                                                   ^
    486|     });
    487| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[12/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should update lastUsedAt on trusted device login
TypeError: Cannot read properties of undefined (reading 'lastUsedAt')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:512:38
    510|       });
    511| 
    512|       const firstLastUsed = device1!.lastUsedAt;
       |                                      ^
    513| 
    514|       // Wait a bit

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[13/13]Î“Ã„Â»


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m13 failed[39m[22m[2m | [22m[1m[32m1 passed[39m[22m[90m (14)[39m
[2m   Start at [22m 09:03:12
[2m   Duration [22m 96.51s

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mtests/ui/expression-editor.test.tsx [22m[34mx14 [34m[39m
       [2m Filename pattern: [22m[34mtests/integration/trusted.devices.real.test.ts[39m

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Â¢Ã¡âˆ©â••Ã…  run anywhere with `dotenvx run -- yourcommand`

{"level":30,"time":1768151326247,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for be62b4e4f1948af9688cc3b63cef3707

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should trust current device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768151329881,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768151330012,"env":"test","module":"mfa-service","userId":"be62b4e4f1948af9688cc3b63cef3707","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768151330013,"env":"test","module":"auth-routes","userId":"be62b4e4f1948af9688cc3b63cef3707","msg":"MFA verification failed during login"}
{"level":50,"time":1768151330020,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39m[TEST UTILS] MFA Secret verified for 64e0d0f779df4acac23c251fed975b5d

{"level":50,"time":1768151332080,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should set trust expiry to 30 days
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768151332193,"env":"test","module":"mfa-service","userId":"64e0d0f779df4acac23c251fed975b5d","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768151332194,"env":"test","module":"auth-routes","userId":"64e0d0f779df4acac23c251fed975b5d","msg":"MFA verification failed during login"}
{"level":50,"time":1768151332202,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for 3cd8b188e7bda691180f3de974d70a55

{"level":50,"time":1768151334200,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768151334308,"env":"test","module":"mfa-service","userId":"3cd8b188e7bda691180f3de974d70a55","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768151334309,"env":"test","module":"auth-routes","userId":"3cd8b188e7bda691180f3de974d70a55","msg":"MFA verification failed during login"}
{"level":50,"time":1768151334314,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should update expiry if device already trusted
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768151334426,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768151334844,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39m[TEST UTILS] MFA Secret verified for 5c5e3d2895596bc9bdc278b39d4da731

{"level":30,"time":1768151336705,"env":"test","module":"auth-routes","userId":"5c5e3d2895596bc9bdc278b39d4da731","msg":"Login requires MFA verification"}
{"level":40,"time":1768151336823,"env":"test","module":"mfa-service","userId":"5c5e3d2895596bc9bdc278b39d4da731","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768151336823,"env":"test","module":"auth-routes","userId":"5c5e3d2895596bc9bdc278b39d4da731","msg":"MFA verification failed during login"}
{"level":50,"time":1768151336828,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768151337124,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768151337239,"env":"test","module":"mfa-service","userId":"5c5e3d2895596bc9bdc278b39d4da731","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768151337239,"env":"test","module":"auth-routes","userId":"5c5e3d2895596bc9bdc278b39d4da731","msg":"MFA verification failed during login"}
{"level":50,"time":1768151337245,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768151337521,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768151337631,"env":"test","module":"mfa-service","userId":"5c5e3d2895596bc9bdc278b39d4da731","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768151337631,"env":"test","module":"auth-routes","userId":"5c5e3d2895596bc9bdc278b39d4da731","msg":"MFA verification failed during login"}
{"level":50,"time":1768151337637,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for 84c47bd63a3464dbf5d3f2fcb2cab6b2

{"level":50,"time":1768151339467,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768151339587,"env":"test","module":"mfa-service","userId":"84c47bd63a3464dbf5d3f2fcb2cab6b2","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768151339587,"env":"test","module":"auth-routes","userId":"84c47bd63a3464dbf5d3f2fcb2cab6b2","msg":"MFA verification failed during login"}
{"level":50,"time":1768151339592,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768151339597,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should mark current device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39m[TEST UTILS] MFA Secret verified for dfe102587d6ee6a86aed000affa42593

{"level":30,"time":1768151341458,"env":"test","module":"auth-routes","userId":"dfe102587d6ee6a86aed000affa42593","msg":"Login requires MFA verification"}
{"level":30,"time":1768151341569,"env":"test","module":"mfa-service","userId":"dfe102587d6ee6a86aed000affa42593","msg":"TOTP verification successful"}
{"level":30,"time":1768151341627,"env":"test","module":"auth-routes","userId":"dfe102587d6ee6a86aed000affa42593","msg":"MFA login successful"}
{"level":30,"time":1768151341803,"env":"test","module":"auth-routes","userId":"dfe102587d6ee6a86aed000affa42593","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768151341978,"env":"test","module":"auth-routes","userId":"dfe102587d6ee6a86aed000affa42593","deviceCount":0,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for cf6914238c29abec8a1f988b5978c2d6

{"level":50,"time":1768151343723,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude expired devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768151343830,"env":"test","module":"mfa-service","userId":"cf6914238c29abec8a1f988b5978c2d6","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768151343830,"env":"test","module":"auth-routes","userId":"cf6914238c29abec8a1f988b5978c2d6","msg":"MFA verification failed during login"}
{"level":50,"time":1768151343836,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768151343894,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for 9f6494cd8085fe4aebb5c921a1deb532

{"level":50,"time":1768151345489,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":30,"time":1768151345600,"env":"test","module":"mfa-service","userId":"9f6494cd8085fe4aebb5c921a1deb532","msg":"TOTP verification successful"}
{"level":30,"time":1768151345656,"env":"test","module":"auth-routes","userId":"9f6494cd8085fe4aebb5c921a1deb532","msg":"MFA login successful"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768151345836,"env":"test","module":"auth-routes","userId":"9f6494cd8085fe4aebb5c921a1deb532","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768151345947,"env":"test","module":"auth-routes","userId":"9f6494cd8085fe4aebb5c921a1deb532","deviceCount":1,"msg":"Listed trusted devices"}
{"level":30,"time":1768151346111,"env":"test","module":"auth-routes","userId":"9f6494cd8085fe4aebb5c921a1deb532","deviceId":"b7634fa4-749c-4a25-803e-5b799327bccc","msg":"Trusted device revoked"}
{"level":30,"time":1768151346296,"env":"test","module":"auth-routes","userId":"9f6494cd8085fe4aebb5c921a1deb532","deviceCount":0,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 8b5f29192eb9b9641eed75ad9eb23ab4

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for ba379feef5e08b85aee376b3b06830ee

{"level":50,"time":1768151350430,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768151350543,"env":"test","module":"mfa-service","userId":"8b5f29192eb9b9641eed75ad9eb23ab4","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768151350543,"env":"test","module":"auth-routes","userId":"8b5f29192eb9b9641eed75ad9eb23ab4","msg":"MFA verification failed during login"}
{"level":50,"time":1768151350549,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768151350555,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should prevent revoking other user's device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39m[TEST UTILS] MFA Secret verified for f2c45ca5263cbca62aa98bc6568424b2

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}
{"level":50,"time":1768151352582,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768151352688,"env":"test","module":"mfa-service","userId":"f2c45ca5263cbca62aa98bc6568424b2","msg":"No enabled MFA secret found for user"}

{"level":40,"time":1768151352688,"env":"test","module":"auth-routes","userId":"f2c45ca5263cbca62aa98bc6568424b2","msg":"MFA verification failed during login"}
{"level":50,"time":1768151352693,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768151352970,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39m[TEST UTILS] MFA Secret verified for 74330cf7b0dfad81b1437bf6396dd033

{"level":30,"time":1768151355054,"env":"test","module":"auth-routes","userId":"74330cf7b0dfad81b1437bf6396dd033","msg":"Login requires MFA verification"}
{"level":30,"time":1768151355175,"env":"test","module":"mfa-service","userId":"74330cf7b0dfad81b1437bf6396dd033","msg":"TOTP verification successful"}
{"level":30,"time":1768151355225,"env":"test","module":"auth-routes","userId":"74330cf7b0dfad81b1437bf6396dd033","msg":"MFA login successful"}
{"level":30,"time":1768151355391,"env":"test","module":"auth-routes","userId":"74330cf7b0dfad81b1437bf6396dd033","deviceFingerprint":"10fa3aea039bf6fec7b6bcb982cbed1cc6ab844dd3c0879bec32baefb2997b52","msg":"Device marked as trusted"}
{"level":30,"time":1768151356576,"env":"test","module":"auth-routes","userId":"74330cf7b0dfad81b1437bf6396dd033","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39m[TEST UTILS] MFA Secret verified for 743d424fb1a2bdbae39ff31980536b73

{"level":50,"time":1768151358609,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768151358727,"env":"test","module":"mfa-service","userId":"743d424fb1a2bdbae39ff31980536b73","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768151358727,"env":"test","module":"auth-routes","userId":"743d424fb1a2bdbae39ff31980536b73","msg":"MFA verification failed during login"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should update lastUsedAt on trusted device login
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768151358733,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m10 failed[39m[2m)[22m[33m 31850[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should trust current device[39m[33m 1989[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set trust expiry to 30 days[39m[33m 2171[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update expiry if device already trusted[39m[33m 2225[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 416[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all trusted devices[39m[33m 2793[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should mark current device[39m[33m 1960[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should exclude revoked devices [33m 2380[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude expired devices[39m[33m 1917[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke specific device [33m 2401[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 404 for non-existent device[39m[33m 963[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent revoking other user's device[39m[33m 3296[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should skip MFA for trusted device[39m[33m 2417[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require MFA for untrusted device [33m 3603[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update lastUsedAt on trusted device login[39m[33m 2214[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 10 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should trust current device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:52:36
     50|         .set("X-Forwarded-For", "192.168.1.100");
     51| 
     52|       expect(trustResponse.status).toBe(200);
       |                                    ^
     53|       expect(trustResponse.body.message).toContain("trusted");
     54|       expect(trustResponse.body.trustedUntil).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should set trust expiry to 30 days
AssertionError: expected NaN to be 30 // Object.is equality

- Expected
+ Received

- 30
+ NaN

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:92:24
     90|       );
     91| 
     92|       expect(diffDays).toBe(30);
       |                        ^
     93|     });
     94| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should update expiry if device already trusted
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:132:42
    130| 
    131|       // Should have extended expiry
    132|       expect(secondExpiry > firstExpiry).toBe(true);
       |                                          ^
    133| 
    134|       // Should still only have 1 device record

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:193:31
    191|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    192| 
    193|       expect(response.status).toBe(200);
       |                               ^
    194|       expect(response.body.devices).toBeDefined();
    195|       expect(response.body.devices.length).toBe(2);

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should mark current device
TypeError: Cannot read properties of undefined (reading 'find')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:236:51
    234|         .set("X-Forwarded-For", "192.168.1.100");
    235| 
    236|       const currentDevice = response.body.devices.find((d: any) => d.cÎ“Ã‡Âª
       |                                                   ^
    237|       expect(currentDevice).toBeDefined();
    238|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude expired devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:302:36
    300|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    301| 
    302|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    303|     });
    304|   });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should return 404 for non-existent device
Error: [TEST UTILS] MFA Secret verification failed for e0400478f329dd59003bcdaa35484ad7
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:182:21
    180|     where: eq(mfaSecrets.userId, userData.userId)
    181|   });
    182|   if (!check) throw new Error(`[TEST UTILS] MFA Secret verification faÎ“Ã‡Âª
       |                     ^
    183|   if (!check.enabled) throw new Error(`[TEST UTILS] MFA Secret enabledÎ“Ã‡Âª
    184|   console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}Î“Ã‡Âª
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:357:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[7/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should prevent revoking other user's device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:399:43
    397|         .set("Authorization", `Bearer ${mfaLogin1.body.token}`);
    398| 
    399|       const user1DeviceId = devices1.body.devices[0].id;
       |                                           ^
    400| 
    401|       // User 2 tries to revoke user 1's device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[8/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:453:42
    451| 
    452|       // Should not require MFA
    453|       expect(secondLoginResponse.status).toBe(200);
       |                                          ^
    454|       expect(secondLoginResponse.body.requiresMfa).toBeUndefined();
    455|       expect(secondLoginResponse.body.token).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[9/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should update lastUsedAt on trusted device login
TypeError: Cannot read properties of undefined (reading 'lastUsedAt')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:512:38
    510|       });
    511| 
    512|       const firstLastUsed = device1!.lastUsedAt;
       |                                      ^
    513| 
    514|       // Wait a bit

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[10/10]Î“Ã„Â»


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m10 failed[39m[22m[2m | [22m[1m[32m4 passed[39m[22m[90m (14)[39m
[2m   Start at [22m 11:08:15
[2m   Duration [22m 55.79s

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mtests/setup.ts [22m[34mx15 [34m[39m
       [2m Filename pattern: [22m[34mtests/integration/trusted.devices.real.test.ts[39m

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768153007871,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’ÂºÂ¬ Setting up test environment...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for 7c9d25b88bf6068e59d830c2eaca0502

{"level":30,"time":1768153013172,"env":"test","module":"auth-routes","userId":"7c9d25b88bf6068e59d830c2eaca0502","msg":"Login requires MFA verification"}
{"level":40,"time":1768153013307,"env":"test","module":"mfa-service","userId":"7c9d25b88bf6068e59d830c2eaca0502","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768153013308,"env":"test","module":"auth-routes","userId":"7c9d25b88bf6068e59d830c2eaca0502","msg":"MFA verification failed during login"}
{"level":50,"time":1768153013315,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39m[TEST UTILS] MFA Secret verified for 73855308e585b060bc22a4e587259234

{"level":50,"time":1768153015046,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should set trust expiry to 30 days
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768153015169,"env":"test","module":"mfa-service","userId":"73855308e585b060bc22a4e587259234","msg":"TOTP verification successful"}
{"level":30,"time":1768153015226,"env":"test","module":"auth-routes","userId":"73855308e585b060bc22a4e587259234","msg":"MFA login successful"}
{"level":30,"time":1768153015402,"env":"test","module":"auth-routes","userId":"73855308e585b060bc22a4e587259234","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for 8ade43bd5a926f090c8ee5f0dd96bb5c

{"level":50,"time":1768153017316,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":30,"time":1768153017425,"env":"test","module":"mfa-service","userId":"8ade43bd5a926f090c8ee5f0dd96bb5c","msg":"TOTP verification successful"}
{"level":30,"time":1768153017480,"env":"test","module":"auth-routes","userId":"8ade43bd5a926f090c8ee5f0dd96bb5c","msg":"MFA login successful"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should update expiry if device already trusted
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768153017645,"env":"test","module":"auth-routes","userId":"8ade43bd5a926f090c8ee5f0dd96bb5c","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768153017907,"env":"test","module":"auth-routes","userId":"8ade43bd5a926f090c8ee5f0dd96bb5c","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Trusted device expiry updated"}
{"level":50,"time":1768153018378,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39m[TEST UTILS] MFA Secret verified for 186479b11f1a940e702a1ebbd19fbf9e

{"level":30,"time":1768153021122,"env":"test","module":"auth-routes","userId":"186479b11f1a940e702a1ebbd19fbf9e","msg":"Login requires MFA verification"}
{"level":40,"time":1768153021234,"env":"test","module":"mfa-service","userId":"186479b11f1a940e702a1ebbd19fbf9e","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768153021235,"env":"test","module":"auth-routes","userId":"186479b11f1a940e702a1ebbd19fbf9e","msg":"MFA verification failed during login"}
{"level":50,"time":1768153021241,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768153021505,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768153021628,"env":"test","module":"mfa-service","userId":"186479b11f1a940e702a1ebbd19fbf9e","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768153021628,"env":"test","module":"auth-routes","userId":"186479b11f1a940e702a1ebbd19fbf9e","msg":"MFA verification failed during login"}
{"level":50,"time":1768153021635,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768153021903,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768153022015,"env":"test","module":"mfa-service","userId":"186479b11f1a940e702a1ebbd19fbf9e","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768153022015,"env":"test","module":"auth-routes","userId":"186479b11f1a940e702a1ebbd19fbf9e","msg":"MFA verification failed during login"}
{"level":50,"time":1768153022021,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for db21de35468bd6cd46e73fc08c25c014

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should mark current device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768153023809,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768153023918,"env":"test","module":"mfa-service","userId":"db21de35468bd6cd46e73fc08c25c014","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768153023918,"env":"test","module":"auth-routes","userId":"db21de35468bd6cd46e73fc08c25c014","msg":"MFA verification failed during login"}
{"level":50,"time":1768153023923,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768153023928,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768153025645,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39m[TEST UTILS] MFA Secret verified for 759d587c49750a321d1933ecc7738bbb

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude revoked devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768153025766,"env":"test","module":"mfa-service","userId":"759d587c49750a321d1933ecc7738bbb","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768153025767,"env":"test","module":"auth-routes","userId":"759d587c49750a321d1933ecc7738bbb","msg":"MFA verification failed during login"}
{"level":50,"time":1768153025773,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768153025827,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for b01033985bf5ee7e0a26b3541e666a4e

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude expired devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768153027731,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768153027842,"env":"test","module":"mfa-service","userId":"b01033985bf5ee7e0a26b3541e666a4e","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768153027842,"env":"test","module":"auth-routes","userId":"b01033985bf5ee7e0a26b3541e666a4e","msg":"MFA verification failed during login"}
{"level":50,"time":1768153027847,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768153027899,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for 1080aec3fee6b8dd5a57c5d2838712d7

{"level":50,"time":1768153029485,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768153029599,"env":"test","module":"mfa-service","userId":"1080aec3fee6b8dd5a57c5d2838712d7","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768153029599,"env":"test","module":"auth-routes","userId":"1080aec3fee6b8dd5a57c5d2838712d7","msg":"MFA verification failed during login"}
{"level":50,"time":1768153029605,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768153029611,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39m[TEST UTILS] MFA Secret verified for 9990dbe0ca0dd7ceca8c866ab64be461

{"level":50,"time":1768153031244,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should return 404 for non-existent device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768153031359,"env":"test","module":"mfa-service","userId":"9990dbe0ca0dd7ceca8c866ab64be461","msg":"TOTP verification successful"}
{"level":30,"time":1768153031410,"env":"test","module":"auth-routes","userId":"9990dbe0ca0dd7ceca8c866ab64be461","msg":"MFA login successful"}
{"level":50,"time":1768153034212,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768153034321,"env":"test","module":"mfa-service","userId":"1fc1b51e991601c3a2202d4b7143ee23","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768153034322,"env":"test","module":"auth-routes","userId":"1fc1b51e991601c3a2202d4b7143ee23","msg":"MFA verification failed during login"}
{"level":50,"time":1768153034328,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39m[TEST UTILS] MFA Secret verified for 1fc1b51e991601c3a2202d4b7143ee23

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768153034608,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39m[TEST UTILS] MFA Secret verified for ff4b3d26d6528ab760377e41591812cc

{"level":30,"time":1768153037437,"env":"test","module":"auth-routes","userId":"ff4b3d26d6528ab760377e41591812cc","msg":"Login requires MFA verification"}
{"level":40,"time":1768153037548,"env":"test","module":"mfa-service","userId":"ff4b3d26d6528ab760377e41591812cc","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768153037549,"env":"test","module":"auth-routes","userId":"ff4b3d26d6528ab760377e41591812cc","msg":"MFA verification failed during login"}
{"level":50,"time":1768153037554,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m11 failed[39m[2m)[22m[33m 27476[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should trust current device[39m[33m 2123[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set trust expiry to 30 days [33m 2074[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update expiry if device already trusted[39m[33m 2562[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 414[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all trusted devices[39m[33m 3642[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should mark current device[39m[33m 1907[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude revoked devices[39m[33m 1899[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude expired devices[39m[33m 2072[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific device[39m[33m 1712[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 404 for non-existent device [33m 1856[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent revoking other user's device[39m[33m 1059[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should skip MFA for trusted device[39m[33m 2083[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should require MFA for untrusted device[39m[33m 926[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update lastUsedAt on trusted device login[39m[33m 2078[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 11 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should trust current device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:52:36
     50|         .set("X-Forwarded-For", "192.168.1.100");
     51| 
     52|       expect(trustResponse.status).toBe(200);
       |                                    ^
     53|       expect(trustResponse.body.message).toContain("trusted");
     54|       expect(trustResponse.body.trustedUntil).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should update expiry if device already trusted
AssertionError: expected +0 to be 1 // Object.is equality

- Expected
+ Received

- 1
+ 0

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:142:30
    140|       });
    141| 
    142|       expect(devices.length).toBe(1);
       |                              ^
    143|     });
    144| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:193:31
    191|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    192| 
    193|       expect(response.status).toBe(200);
       |                               ^
    194|       expect(response.body.devices).toBeDefined();
    195|       expect(response.body.devices.length).toBe(2);

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should mark current device
TypeError: Cannot read properties of undefined (reading 'find')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:236:51
    234|         .set("X-Forwarded-For", "192.168.1.100");
    235| 
    236|       const currentDevice = response.body.devices.find((d: any) => d.cÎ“Ã‡Âª
       |                                                   ^
    237|       expect(currentDevice).toBeDefined();
    238|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude revoked devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:269:36
    267|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    268| 
    269|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    270|     });
    271| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude expired devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:302:36
    300|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    301| 
    302|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    303|     });
    304|   });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:332:45
    330|         .set("Authorization", `Bearer ${token}`);
    331| 
    332|       const deviceId = devicesResponse.body.devices[0].id;
       |                                             ^
    333| 
    334|       // Revoke device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[7/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should prevent revoking other user's device
Error: [TEST UTILS] MFA Secret verification failed for 692a61a0abf71a320728a098ed70dba3
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:182:21
    180|     where: eq(mfaSecrets.userId, userData.userId)
    181|   });
    182|   if (!check) throw new Error(`[TEST UTILS] MFA Secret verification faÎ“Ã‡Âª
       |                     ^
    183|   if (!check.enabled) throw new Error(`[TEST UTILS] MFA Secret enabledÎ“Ã‡Âª
    184|   console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}Î“Ã‡Âª
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:375:21

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[8/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:453:42
    451| 
    452|       // Should not require MFA
    453|       expect(secondLoginResponse.status).toBe(200);
       |                                          ^
    454|       expect(secondLoginResponse.body.requiresMfa).toBeUndefined();
    455|       expect(secondLoginResponse.body.token).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[9/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
Error: [TEST UTILS] MFA Secret verification failed for 935af4cff879b759f25e48b92324a6ab
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:182:21
    180|     where: eq(mfaSecrets.userId, userData.userId)
    181|   });
    182|   if (!check) throw new Error(`[TEST UTILS] MFA Secret verification faÎ“Ã‡Âª
       |                     ^
    183|   if (!check.enabled) throw new Error(`[TEST UTILS] MFA Secret enabledÎ“Ã‡Âª
    184|   console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}Î“Ã‡Âª
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:459:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[10/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should update lastUsedAt on trusted device login
TypeError: Cannot read properties of undefined (reading 'lastUsedAt')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:512:38
    510|       });
    511| 
    512|       const firstLastUsed = device1!.lastUsedAt;
       |                                      ^
    513| 
    514|       // Wait a bit

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[11/11]Î“Ã„Â»


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m11 failed[39m[22m[2m | [22m[1m[32m3 passed[39m[22m[90m (14)[39m
[2m   Start at [22m 11:26:20
[2m   Duration [22m 325.72s

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/db.ts [22m[34mx16 [34m[39m
       [2m Filename pattern: [22m[34mtests/integration/trusted.devices.real.test.ts[39m

[1m[35m
Restarting due to config changes...[39m[22m

[1m[44m DEV [49m[22m [34mv4.0.16 [39m[90mC:/Users/scoot/poll/VaultLogic[39m

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  override existing env vars with { override: true }

{"level":30,"time":1768154903138,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768154903141,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“ÃœÃ¡âˆ©â••Ã… Concurrency conflict creating DB functions (attempt 1/3). Retrying...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for c852582b6f75a594ee72929664088f06

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for f4ae37fb98e102ff1b636af4aca5132f

{"level":50,"time":1768154905637,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should trust current device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768154905763,"env":"test","module":"mfa-service","userId":"c852582b6f75a594ee72929664088f06","msg":"TOTP verification successful"}
{"level":30,"time":1768154905821,"env":"test","module":"auth-routes","userId":"c852582b6f75a594ee72929664088f06","msg":"MFA login successful"}
{"level":30,"time":1768154906009,"env":"test","module":"auth-routes","userId":"c852582b6f75a594ee72929664088f06","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768154906388,"env":"test","module":"auth-routes","userId":"f4ae37fb98e102ff1b636af4aca5132f","msg":"Login requires MFA verification"}
{"level":40,"time":1768154906509,"env":"test","module":"mfa-service","userId":"f4ae37fb98e102ff1b636af4aca5132f","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768154906510,"env":"test","module":"auth-routes","userId":"f4ae37fb98e102ff1b636af4aca5132f","msg":"MFA verification failed during login"}
{"level":50,"time":1768154906516,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39m[TEST UTILS] MFA Secret verified for a84a084fb566020128b5c1f413c89512

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39m[TEST UTILS] MFA Secret verified for 397449cd946bdeeffabf1a035a2ff673

{"level":50,"time":1768154907528,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should set trust expiry to 30 days
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768154907641,"env":"test","module":"mfa-service","userId":"a84a084fb566020128b5c1f413c89512","msg":"TOTP verification successful"}
{"level":30,"time":1768154907698,"env":"test","module":"auth-routes","userId":"a84a084fb566020128b5c1f413c89512","msg":"MFA login successful"}
{"level":30,"time":1768154907887,"env":"test","module":"auth-routes","userId":"a84a084fb566020128b5c1f413c89512","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768154908237,"env":"test","module":"auth-routes","userId":"397449cd946bdeeffabf1a035a2ff673","msg":"Login requires MFA verification"}
{"level":40,"time":1768154908346,"env":"test","module":"mfa-service","userId":"397449cd946bdeeffabf1a035a2ff673","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768154908346,"env":"test","module":"auth-routes","userId":"397449cd946bdeeffabf1a035a2ff673","msg":"MFA verification failed during login"}
{"level":50,"time":1768154908352,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for ff6ffcc0a2ae304c5b76cfc442e92397

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for fa4b1dd2a2362cc0471509727f4a3fb1

{"level":50,"time":1768154909357,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should update expiry if device already trusted
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768154909465,"env":"test","module":"mfa-service","userId":"ff6ffcc0a2ae304c5b76cfc442e92397","msg":"TOTP verification successful"}
{"level":30,"time":1768154909518,"env":"test","module":"auth-routes","userId":"ff6ffcc0a2ae304c5b76cfc442e92397","msg":"MFA login successful"}
{"level":30,"time":1768154909679,"env":"test","module":"auth-routes","userId":"ff6ffcc0a2ae304c5b76cfc442e92397","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768154909944,"env":"test","module":"auth-routes","userId":"ff6ffcc0a2ae304c5b76cfc442e92397","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Trusted device expiry updated"}
{"level":30,"time":1768154910049,"env":"test","module":"auth-routes","userId":"fa4b1dd2a2362cc0471509727f4a3fb1","msg":"Login requires MFA verification"}
{"level":30,"time":1768154910166,"env":"test","module":"mfa-service","userId":"fa4b1dd2a2362cc0471509727f4a3fb1","msg":"TOTP verification successful"}
{"level":30,"time":1768154910221,"env":"test","module":"auth-routes","userId":"fa4b1dd2a2362cc0471509727f4a3fb1","msg":"MFA login successful"}
{"level":30,"time":1768154910404,"env":"test","module":"auth-routes","userId":"fa4b1dd2a2362cc0471509727f4a3fb1","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":50,"time":1768154910429,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768154910675,"env":"test","module":"auth-routes","userId":"fa4b1dd2a2362cc0471509727f4a3fb1","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":50,"time":1768154911160,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39m[TEST UTILS] MFA Secret verified for 30d4c60f9d86f65e475bfb9da81b818c

{"level":50,"time":1768154911897,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768154912008,"env":"test","module":"mfa-service","userId":"30d4c60f9d86f65e475bfb9da81b818c","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768154912008,"env":"test","module":"auth-routes","userId":"30d4c60f9d86f65e475bfb9da81b818c","msg":"MFA verification failed during login"}
{"level":50,"time":1768154912012,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39m[TEST UTILS] MFA Secret verified for 01fd07ac20bd2521ae3f5a9f4a396163

{"level":50,"time":1768154912280,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768154912394,"env":"test","module":"mfa-service","userId":"30d4c60f9d86f65e475bfb9da81b818c","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768154912394,"env":"test","module":"auth-routes","userId":"30d4c60f9d86f65e475bfb9da81b818c","msg":"MFA verification failed during login"}
{"level":50,"time":1768154912398,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768154912663,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768154912771,"env":"test","module":"mfa-service","userId":"30d4c60f9d86f65e475bfb9da81b818c","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768154912771,"env":"test","module":"auth-routes","userId":"30d4c60f9d86f65e475bfb9da81b818c","msg":"MFA verification failed during login"}
{"level":50,"time":1768154912775,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768154912843,"env":"test","module":"auth-routes","userId":"01fd07ac20bd2521ae3f5a9f4a396163","msg":"Login requires MFA verification"}
{"level":30,"time":1768154912954,"env":"test","module":"mfa-service","userId":"01fd07ac20bd2521ae3f5a9f4a396163","msg":"TOTP verification successful"}
{"level":30,"time":1768154913008,"env":"test","module":"auth-routes","userId":"01fd07ac20bd2521ae3f5a9f4a396163","msg":"MFA login successful"}
{"level":30,"time":1768154913170,"env":"test","module":"auth-routes","userId":"01fd07ac20bd2521ae3f5a9f4a396163","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":50,"time":1768154913438,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768154913556,"env":"test","module":"mfa-service","userId":"01fd07ac20bd2521ae3f5a9f4a396163","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768154913556,"env":"test","module":"auth-routes","userId":"01fd07ac20bd2521ae3f5a9f4a396163","msg":"MFA verification failed during login"}
{"level":50,"time":1768154913561,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for 4c5312da3fae7d9be87fb46524f4e658

{"level":50,"time":1768154913829,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768154913941,"env":"test","module":"mfa-service","userId":"01fd07ac20bd2521ae3f5a9f4a396163","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768154913941,"env":"test","module":"auth-routes","userId":"01fd07ac20bd2521ae3f5a9f4a396163","msg":"MFA verification failed during login"}
{"level":50,"time":1768154913945,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768154914473,"env":"test","module":"auth-routes","userId":"4c5312da3fae7d9be87fb46524f4e658","msg":"Login requires MFA verification"}
{"level":40,"time":1768154914581,"env":"test","module":"mfa-service","userId":"4c5312da3fae7d9be87fb46524f4e658","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768154914581,"env":"test","module":"auth-routes","userId":"4c5312da3fae7d9be87fb46524f4e658","msg":"MFA verification failed during login"}
{"level":50,"time":1768154914586,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768154914591,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for 18da41df499df268a01aa353365a20e7

{"level":50,"time":1768154915397,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should mark current device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39m[TEST UTILS] MFA Secret verified for 1417fd356b55fac8d66921841bf0e26e

{"level":40,"time":1768154915515,"env":"test","module":"mfa-service","userId":"18da41df499df268a01aa353365a20e7","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768154915515,"env":"test","module":"auth-routes","userId":"18da41df499df268a01aa353365a20e7","msg":"MFA verification failed during login"}
{"level":50,"time":1768154915519,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768154915524,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768154916262,"env":"test","module":"auth-routes","userId":"1417fd356b55fac8d66921841bf0e26e","msg":"Login requires MFA verification"}
{"level":40,"time":1768154916367,"env":"test","module":"mfa-service","userId":"1417fd356b55fac8d66921841bf0e26e","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768154916367,"env":"test","module":"auth-routes","userId":"1417fd356b55fac8d66921841bf0e26e","msg":"MFA verification failed during login"}
{"level":50,"time":1768154916371,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768154916426,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39m[TEST UTILS] MFA Secret verified for b5da79ca6cbab82b1b8170181c07771e

{"level":50,"time":1768154916973,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude revoked devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768154917085,"env":"test","module":"mfa-service","userId":"b5da79ca6cbab82b1b8170181c07771e","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768154917085,"env":"test","module":"auth-routes","userId":"b5da79ca6cbab82b1b8170181c07771e","msg":"MFA verification failed during login"}
{"level":50,"time":1768154917089,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768154917145,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for e10275103516191ea472b96cf25afe27

{"level":50,"time":1768154917887,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude expired devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768154917995,"env":"test","module":"mfa-service","userId":"e10275103516191ea472b96cf25afe27","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768154917995,"env":"test","module":"auth-routes","userId":"e10275103516191ea472b96cf25afe27","msg":"MFA verification failed during login"}
{"level":50,"time":1768154917998,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768154918052,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for 4ddee7668a0031bea06dd4e4a00fc609

{"level":50,"time":1768154918606,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude expired devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768154918714,"env":"test","module":"mfa-service","userId":"4ddee7668a0031bea06dd4e4a00fc609","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768154918714,"env":"test","module":"auth-routes","userId":"4ddee7668a0031bea06dd4e4a00fc609","msg":"MFA verification failed during login"}
{"level":50,"time":1768154918719,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768154918772,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for 94f9078d9ad1f273731cae9c0056fa89

{"level":50,"time":1768154919517,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768154919630,"env":"test","module":"mfa-service","userId":"94f9078d9ad1f273731cae9c0056fa89","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768154919630,"env":"test","module":"auth-routes","userId":"94f9078d9ad1f273731cae9c0056fa89","msg":"MFA verification failed during login"}
{"level":50,"time":1768154919633,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768154919637,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for 1a81a009e75ac5868958a9b9c59d8fbe

{"level":50,"time":1768154920237,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768154920357,"env":"test","module":"mfa-service","userId":"1a81a009e75ac5868958a9b9c59d8fbe","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768154920357,"env":"test","module":"auth-routes","userId":"1a81a009e75ac5868958a9b9c59d8fbe","msg":"MFA verification failed during login"}
{"level":50,"time":1768154920361,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768154920364,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39m[TEST UTILS] MFA Secret verified for 70befd862fa9d3e0fd7d2e371232a28c

{"level":50,"time":1768154921075,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should return 404 for non-existent device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768154921182,"env":"test","module":"mfa-service","userId":"70befd862fa9d3e0fd7d2e371232a28c","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768154921182,"env":"test","module":"auth-routes","userId":"70befd862fa9d3e0fd7d2e371232a28c","msg":"MFA verification failed during login"}
{"level":50,"time":1768154921186,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39m[TEST UTILS] MFA Secret verified for cae4fc59bead907251de4601eb604dcc

{"level":50,"time":1768154921830,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should return 404 for non-existent device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768154921943,"env":"test","module":"mfa-service","userId":"cae4fc59bead907251de4601eb604dcc","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768154921943,"env":"test","module":"auth-routes","userId":"cae4fc59bead907251de4601eb604dcc","msg":"MFA verification failed during login"}
{"level":50,"time":1768154921947,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 70d102a173c55b130c60ecb5187d0f52

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for ab9637236964a3c9a085f10a6c12384f

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 174f31adf6cdc4fff6b3492fefbce829

{"level":50,"time":1768154923427,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should prevent revoking other user's device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768154923539,"env":"test","module":"mfa-service","userId":"70d102a173c55b130c60ecb5187d0f52","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768154923539,"env":"test","module":"auth-routes","userId":"70d102a173c55b130c60ecb5187d0f52","msg":"MFA verification failed during login"}
{"level":50,"time":1768154923544,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768154923547,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for ff6d6ff4f5472dc06f9660c388d57924

{"level":50,"time":1768154924194,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should prevent revoking other user's device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768154924306,"env":"test","module":"mfa-service","userId":"174f31adf6cdc4fff6b3492fefbce829","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768154924306,"env":"test","module":"auth-routes","userId":"174f31adf6cdc4fff6b3492fefbce829","msg":"MFA verification failed during login"}
{"level":50,"time":1768154924309,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768154924312,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39m[TEST UTILS] MFA Secret verified for e2b322e94a3731e0f37af2d355400c9e

{"level":50,"time":1768154925013,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768154925121,"env":"test","module":"mfa-service","userId":"e2b322e94a3731e0f37af2d355400c9e","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768154925121,"env":"test","module":"auth-routes","userId":"e2b322e94a3731e0f37af2d355400c9e","msg":"MFA verification failed during login"}
{"level":50,"time":1768154925124,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39m[TEST UTILS] MFA Secret verified for 9e754f635bb4ce845bd8c610a2a20b61

{"level":50,"time":1768154925398,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768154926024,"env":"test","module":"auth-routes","userId":"9e754f635bb4ce845bd8c610a2a20b61","msg":"Login requires MFA verification"}
{"level":40,"time":1768154926136,"env":"test","module":"mfa-service","userId":"9e754f635bb4ce845bd8c610a2a20b61","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768154926136,"env":"test","module":"auth-routes","userId":"9e754f635bb4ce845bd8c610a2a20b61","msg":"MFA verification failed during login"}
{"level":50,"time":1768154926140,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39m[TEST UTILS] MFA Secret verified for 0b300a0bb5083aaffc607d3bc3bf5951

{"level":50,"time":1768154926405,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768154927096,"env":"test","module":"auth-routes","userId":"0b300a0bb5083aaffc607d3bc3bf5951","msg":"Login requires MFA verification"}
{"level":40,"time":1768154927203,"env":"test","module":"mfa-service","userId":"0b300a0bb5083aaffc607d3bc3bf5951","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768154927203,"env":"test","module":"auth-routes","userId":"0b300a0bb5083aaffc607d3bc3bf5951","msg":"MFA verification failed during login"}
{"level":50,"time":1768154927207,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39m[TEST UTILS] MFA Secret verified for 26e16f6f5607c01559ba4f18048b5733

{"level":50,"time":1768154927484,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768154928123,"env":"test","module":"auth-routes","userId":"26e16f6f5607c01559ba4f18048b5733","msg":"Login requires MFA verification"}
{"level":40,"time":1768154928237,"env":"test","module":"mfa-service","userId":"26e16f6f5607c01559ba4f18048b5733","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768154928237,"env":"test","module":"auth-routes","userId":"26e16f6f5607c01559ba4f18048b5733","msg":"MFA verification failed during login"}
{"level":50,"time":1768154928242,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768154928507,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768154929197,"env":"test","module":"auth-routes","userId":"e6f6971a05b2a2596a8b3a675f07f5be","msg":"Login requires MFA verification"}
{"level":40,"time":1768154929306,"env":"test","module":"mfa-service","userId":"e6f6971a05b2a2596a8b3a675f07f5be","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768154929306,"env":"test","module":"auth-routes","userId":"e6f6971a05b2a2596a8b3a675f07f5be","msg":"MFA verification failed during login"}
{"level":50,"time":1768154929310,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39m[TEST UTILS] MFA Secret verified for e6f6971a05b2a2596a8b3a675f07f5be

{"level":30,"time":1768154930186,"env":"test","module":"auth-routes","userId":"da48163d3809a72b0b075ddfe8b3b198","msg":"Login requires MFA verification"}
{"level":30,"time":1768154930295,"env":"test","module":"mfa-service","userId":"da48163d3809a72b0b075ddfe8b3b198","msg":"TOTP verification successful"}
{"level":30,"time":1768154930347,"env":"test","module":"auth-routes","userId":"da48163d3809a72b0b075ddfe8b3b198","msg":"MFA login successful"}
{"level":30,"time":1768154930507,"env":"test","module":"auth-routes","userId":"da48163d3809a72b0b075ddfe8b3b198","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39m[TEST UTILS] MFA Secret verified for da48163d3809a72b0b075ddfe8b3b198

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768154931195,"env":"test","module":"auth-routes","userId":"da48163d3809a72b0b075ddfe8b3b198","msg":"Login from trusted device - MFA skipped"}
{"level":30,"time":1768154931253,"env":"test","module":"auth-routes","userId":"da48163d3809a72b0b075ddfe8b3b198","msg":"User logged in successfully"}
{"level":30,"time":1768154931311,"env":"test","module":"audit-log-service","userId":"da48163d3809a72b0b075ddfe8b3b198","eventType":"login_success","ipAddress":"192.168.1.100","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m12 failed[39m[2m)[22m[33m 26061[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should trust current device[39m[33m 1897[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set trust expiry to 30 days[39m[33m 1827[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should update expiry if device already trusted [33m 2383[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 424[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all trusted devices[39m[33m 2785[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should mark current device[39m[33m 1579[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude revoked devices[39m[33m 1621[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude expired devices[39m[33m 1627[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific device[39m[33m 1591[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 404 for non-existent device[39m[33m 1584[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent revoking other user's device[39m[33m 2365[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should skip MFA for trusted device[39m[33m 2094[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should require MFA for untrusted device[39m[33m 2101[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update lastUsedAt on trusted device login[39m[33m 1877[2mms[22m[39m
 [31mÎ“Â¥Â»[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m11 failed[39m[2m)[22m[33m 28064[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should trust current device[39m[33m 1897[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set trust expiry to 30 days[39m[33m 1827[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should update expiry if device already trusted [33m 2383[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 424[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all trusted devices[39m[33m 2785[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should mark current device[39m[33m 1579[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude revoked devices[39m[33m 1621[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude expired devices[39m[33m 1627[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific device[39m[33m 1591[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 404 for non-existent device[39m[33m 1584[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent revoking other user's device[39m[33m 2365[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should skip MFA for trusted device[39m[33m 2094[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should require MFA for untrusted device[39m[33m 2101[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should update lastUsedAt on trusted device login [33m 2856[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 11 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should trust current device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:52:36
     50|         .set("X-Forwarded-For", "192.168.1.100");
     51| 
     52|       expect(trustResponse.status).toBe(200);
       |                                    ^
     53|       expect(trustResponse.body.message).toContain("trusted");
     54|       expect(trustResponse.body.trustedUntil).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should set trust expiry to 30 days
AssertionError: expected NaN to be 30 // Object.is equality

- Expected
+ Received

- 30
+ NaN

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:92:24
     90|       );
     91| 
     92|       expect(diffDays).toBe(30);
       |                        ^
     93|     });
     94| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:193:31
    191|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    192| 
    193|       expect(response.status).toBe(200);
       |                               ^
    194|       expect(response.body.devices).toBeDefined();
    195|       expect(response.body.devices.length).toBe(2);

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should mark current device
TypeError: Cannot read properties of undefined (reading 'find')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:236:51
    234|         .set("X-Forwarded-For", "192.168.1.100");
    235| 
    236|       const currentDevice = response.body.devices.find((d: any) => d.cÎ“Ã‡Âª
       |                                                   ^
    237|       expect(currentDevice).toBeDefined();
    238|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude revoked devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:269:36
    267|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    268| 
    269|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    270|     });
    271| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude expired devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:302:36
    300|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    301| 
    302|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    303|     });
    304|   });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:332:45
    330|         .set("Authorization", `Bearer ${token}`);
    331| 
    332|       const deviceId = devicesResponse.body.devices[0].id;
       |                                             ^
    333| 
    334|       // Revoke device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[7/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should return 404 for non-existent device
AssertionError: expected 401 to be 404 // Object.is equality

- Expected
+ Received

- 404
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:371:31
    369|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    370| 
    371|       expect(response.status).toBe(404);
       |                               ^
    372|     });
    373| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[8/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should prevent revoking other user's device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:399:43
    397|         .set("Authorization", `Bearer ${mfaLogin1.body.token}`);
    398| 
    399|       const user1DeviceId = devices1.body.devices[0].id;
       |                                           ^
    400| 
    401|       // User 2 tries to revoke user 1's device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[9/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:453:42
    451| 
    452|       // Should not require MFA
    453|       expect(secondLoginResponse.status).toBe(200);
       |                                          ^
    454|       expect(secondLoginResponse.body.requiresMfa).toBeUndefined();
    455|       expect(secondLoginResponse.body.token).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[10/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
AssertionError: expected undefined to be true // Object.is equality

- Expected: 
true

+ Received: 
undefined

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:485:51
    483| 
    484|       // Should require MFA
    485|       expect(loginFromNewDevice.body.requiresMfa).toBe(true);
       |                                                   ^
    486|     });
    487| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[11/11]Î“Ã„Â»


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m11 failed[39m[22m[2m | [22m[1m[32m3 passed[39m[22m[90m (14)[39m
[2m   Start at [22m 12:07:52
[2m   Duration [22m 60.77s[2m (transform 17.65s, setup 21.30s, import 10.63s, tests 28.06s, environment 0ms)[22m

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 11 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should trust current device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:52:36
     50|         .set("X-Forwarded-For", "192.168.1.100");
     51| 
     52|       expect(trustResponse.status).toBe(200);
       |                                    ^
     53|       expect(trustResponse.body.message).toContain("trusted");
     54|       expect(trustResponse.body.trustedUntil).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should set trust expiry to 30 days
AssertionError: expected NaN to be 30 // Object.is equality

- Expected
+ Received

- 30
+ NaN

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:92:24
     90|       );
     91| 
     92|       expect(diffDays).toBe(30);
       |                        ^
     93|     });
     94| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:193:31
    191|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    192| 
    193|       expect(response.status).toBe(200);
       |                               ^
    194|       expect(response.body.devices).toBeDefined();
    195|       expect(response.body.devices.length).toBe(2);

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should mark current device
TypeError: Cannot read properties of undefined (reading 'find')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:236:51
    234|         .set("X-Forwarded-For", "192.168.1.100");
    235| 
    236|       const currentDevice = response.body.devices.find((d: any) => d.cÎ“Ã‡Âª
       |                                                   ^
    237|       expect(currentDevice).toBeDefined();
    238|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude revoked devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:269:36
    267|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    268| 
    269|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    270|     });
    271| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude expired devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:302:36
    300|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    301| 
    302|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    303|     });
    304|   });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:332:45
    330|         .set("Authorization", `Bearer ${token}`);
    331| 
    332|       const deviceId = devicesResponse.body.devices[0].id;
       |                                             ^
    333| 
    334|       // Revoke device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[7/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should return 404 for non-existent device
AssertionError: expected 401 to be 404 // Object.is equality

- Expected
+ Received

- 404
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:371:31
    369|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    370| 
    371|       expect(response.status).toBe(404);
       |                               ^
    372|     });
    373| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[8/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should prevent revoking other user's device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:399:43
    397|         .set("Authorization", `Bearer ${mfaLogin1.body.token}`);
    398| 
    399|       const user1DeviceId = devices1.body.devices[0].id;
       |                                           ^
    400| 
    401|       // User 2 tries to revoke user 1's device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[9/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:453:42
    451| 
    452|       // Should not require MFA
    453|       expect(secondLoginResponse.status).toBe(200);
       |                                          ^
    454|       expect(secondLoginResponse.body.requiresMfa).toBeUndefined();
    455|       expect(secondLoginResponse.body.token).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[10/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
AssertionError: expected undefined to be true // Object.is equality

- Expected: 
true

+ Received: 
undefined

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:485:51
    483| 
    484|       // Should require MFA
    485|       expect(loginFromNewDevice.body.requiresMfa).toBe(true);
       |                                                   ^
    486|     });
    487| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[11/11]Î“Ã„Â»


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m11 failed[39m[22m[2m | [22m[1m[32m3 passed[39m[22m[90m (14)[39m
[2m   Start at [22m 12:07:52
[2m   Duration [22m 60.81s[2m (transform 17.65s, setup 21.30s, import 10.63s, tests 28.06s, environment 0ms)[22m

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
[1m[35m
Restarting due to config changes...[39m[22m

[1m[44m DEV [49m[22m [34mv4.0.16 [39m[90mC:/Users/scoot/poll/VaultLogic[39m

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

{"level":30,"time":1768166051723,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

{"level":50,"time":1768166053959,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768166054071,"env":"test","module":"mfa-service","userId":"96c65bb0ed009244c23a292d39d00b3a","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768166054071,"env":"test","module":"auth-routes","userId":"96c65bb0ed009244c23a292d39d00b3a","msg":"MFA verification failed during login"}
{"level":50,"time":1768166054076,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for 96c65bb0ed009244c23a292d39d00b3a

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should trust current device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39m[TEST UTILS] MFA Secret verified for c62405bfa2f9b0ca3a32d6857e709232

{"level":30,"time":1768166055734,"env":"test","module":"auth-routes","userId":"c62405bfa2f9b0ca3a32d6857e709232","msg":"Login requires MFA verification"}
{"level":30,"time":1768166055838,"env":"test","module":"mfa-service","userId":"c62405bfa2f9b0ca3a32d6857e709232","msg":"TOTP verification successful"}
{"level":30,"time":1768166055891,"env":"test","module":"auth-routes","userId":"c62405bfa2f9b0ca3a32d6857e709232","msg":"MFA login successful"}
{"level":30,"time":1768166056052,"env":"test","module":"auth-routes","userId":"c62405bfa2f9b0ca3a32d6857e709232","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for eeddebcbdbfbd888cf89d8f4a0fcea72

{"level":30,"time":1768166057845,"env":"test","module":"auth-routes","userId":"eeddebcbdbfbd888cf89d8f4a0fcea72","msg":"Login requires MFA verification"}
{"level":30,"time":1768166057964,"env":"test","module":"mfa-service","userId":"eeddebcbdbfbd888cf89d8f4a0fcea72","msg":"TOTP verification successful"}
{"level":30,"time":1768166058021,"env":"test","module":"auth-routes","userId":"eeddebcbdbfbd888cf89d8f4a0fcea72","msg":"MFA login successful"}
{"level":30,"time":1768166058189,"env":"test","module":"auth-routes","userId":"eeddebcbdbfbd888cf89d8f4a0fcea72","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768166058453,"env":"test","module":"auth-routes","userId":"eeddebcbdbfbd888cf89d8f4a0fcea72","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":50,"time":1768166058903,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39m[TEST UTILS] MFA Secret verified for e342e6da91f710726e6cf2f59caa3c0a

{"level":50,"time":1768166060449,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768166060561,"env":"test","module":"mfa-service","userId":"e342e6da91f710726e6cf2f59caa3c0a","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768166060561,"env":"test","module":"auth-routes","userId":"e342e6da91f710726e6cf2f59caa3c0a","msg":"MFA verification failed during login"}
{"level":50,"time":1768166060566,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768166060821,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768166060933,"env":"test","module":"mfa-service","userId":"e342e6da91f710726e6cf2f59caa3c0a","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768166060933,"env":"test","module":"auth-routes","userId":"e342e6da91f710726e6cf2f59caa3c0a","msg":"MFA verification failed during login"}
{"level":50,"time":1768166060938,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768166061206,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768166061320,"env":"test","module":"mfa-service","userId":"e342e6da91f710726e6cf2f59caa3c0a","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768166061320,"env":"test","module":"auth-routes","userId":"e342e6da91f710726e6cf2f59caa3c0a","msg":"MFA verification failed during login"}
{"level":50,"time":1768166061324,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for fa9cd9fab69922ce9b72ee6f1152ffd9

{"level":30,"time":1768166063071,"env":"test","module":"auth-routes","userId":"fa9cd9fab69922ce9b72ee6f1152ffd9","msg":"Login requires MFA verification"}
{"level":40,"time":1768166063178,"env":"test","module":"mfa-service","userId":"fa9cd9fab69922ce9b72ee6f1152ffd9","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768166063178,"env":"test","module":"auth-routes","userId":"fa9cd9fab69922ce9b72ee6f1152ffd9","msg":"MFA verification failed during login"}
{"level":50,"time":1768166063182,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768166063187,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39m[TEST UTILS] MFA Secret verified for 49e82666f138c98cba7064f186b39b47

{"level":30,"time":1768166064874,"env":"test","module":"auth-routes","userId":"49e82666f138c98cba7064f186b39b47","msg":"Login requires MFA verification"}
{"level":40,"time":1768166064987,"env":"test","module":"mfa-service","userId":"49e82666f138c98cba7064f186b39b47","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768166064987,"env":"test","module":"auth-routes","userId":"49e82666f138c98cba7064f186b39b47","msg":"MFA verification failed during login"}
{"level":50,"time":1768166064992,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768166065047,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for c9369bd6b28ea3f22fc9cf4e60f43693

{"level":50,"time":1768166067443,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768166067553,"env":"test","module":"mfa-service","userId":"c9369bd6b28ea3f22fc9cf4e60f43693","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768166067553,"env":"test","module":"auth-routes","userId":"c9369bd6b28ea3f22fc9cf4e60f43693","msg":"MFA verification failed during login"}
{"level":50,"time":1768166067558,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768166067563,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768166071680,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768166071801,"env":"test","module":"mfa-service","userId":"cfde2ffe2da1be17d7f7cd533d141818","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768166071801,"env":"test","module":"auth-routes","userId":"cfde2ffe2da1be17d7f7cd533d141818","msg":"MFA verification failed during login"}
{"level":50,"time":1768166071806,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768166072066,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":50,"time":1768166073481,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768166073597,"env":"test","module":"mfa-service","userId":"0d5e6a8ccd582c99776bdcde957c98cd","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768166073597,"env":"test","module":"auth-routes","userId":"0d5e6a8ccd582c99776bdcde957c98cd","msg":"MFA verification failed during login"}
{"level":50,"time":1768166073601,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39m[TEST UTILS] MFA Secret verified for cfde2ffe2da1be17d7f7cd533d141818

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39m[TEST UTILS] MFA Secret verified for 0d5e6a8ccd582c99776bdcde957c98cd

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should update lastUsedAt on trusted device login
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m11 failed[39m[2m)[22m[33m 21839[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should trust current device[39m[33m 1561[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set trust expiry to 30 days [33m 1971[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should update expiry if device already trusted [33m 2449[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 401[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all trusted devices[39m[33m 2421[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should mark current device[39m[33m 1863[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude revoked devices[39m[33m 1860[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude expired devices[39m[33m 950[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific device[39m[33m 1566[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 404 for non-existent device[39m[33m 897[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent revoking other user's device[39m[33m 903[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should skip MFA for trusted device[39m[33m 889[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should require MFA for untrusted device[39m[33m 1815[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update lastUsedAt on trusted device login[39m[33m 1586[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 11 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should trust current device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:52:36
     50|         .set("X-Forwarded-For", "192.168.1.100");
     51| 
     52|       expect(trustResponse.status).toBe(200);
       |                                    ^
     53|       expect(trustResponse.body.message).toContain("trusted");
     54|       expect(trustResponse.body.trustedUntil).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:193:31
    191|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    192| 
    193|       expect(response.status).toBe(200);
       |                               ^
    194|       expect(response.body.devices).toBeDefined();
    195|       expect(response.body.devices.length).toBe(2);

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should mark current device
TypeError: Cannot read properties of undefined (reading 'find')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:236:51
    234|         .set("X-Forwarded-For", "192.168.1.100");
    235| 
    236|       const currentDevice = response.body.devices.find((d: any) => d.cÎ“Ã‡Âª
       |                                                   ^
    237|       expect(currentDevice).toBeDefined();
    238|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude revoked devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:269:36
    267|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    268| 
    269|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    270|     });
    271| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude expired devices
Error: [TEST UTILS] MFA Secret verification failed for 3c2fb16ce11196c7f368e90e85c8432e
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:182:21
    180|     where: eq(mfaSecrets.userId, userData.userId)
    181|   });
    182|   if (!check) throw new Error(`[TEST UTILS] MFA Secret verification faÎ“Ã‡Âª
       |                     ^
    183|   if (!check.enabled) throw new Error(`[TEST UTILS] MFA Secret enabledÎ“Ã‡Âª
    184|   console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}Î“Ã‡Âª
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:273:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:332:45
    330|         .set("Authorization", `Bearer ${token}`);
    331| 
    332|       const deviceId = devicesResponse.body.devices[0].id;
       |                                             ^
    333| 
    334|       // Revoke device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should return 404 for non-existent device
Error: [TEST UTILS] MFA Secret verification failed for 65347fd06f487a7c8d2b8f0b481ad59e
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:182:21
    180|     where: eq(mfaSecrets.userId, userData.userId)
    181|   });
    182|   if (!check) throw new Error(`[TEST UTILS] MFA Secret verification faÎ“Ã‡Âª
       |                     ^
    183|   if (!check.enabled) throw new Error(`[TEST UTILS] MFA Secret enabledÎ“Ã‡Âª
    184|   console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}Î“Ã‡Âª
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:357:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[7/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should prevent revoking other user's device
Error: [TEST UTILS] MFA Secret verification failed for 60a2e152f2c82d2db7320c1f18daee48
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:182:21
    180|     where: eq(mfaSecrets.userId, userData.userId)
    181|   });
    182|   if (!check) throw new Error(`[TEST UTILS] MFA Secret verification faÎ“Ã‡Âª
       |                     ^
    183|   if (!check.enabled) throw new Error(`[TEST UTILS] MFA Secret enabledÎ“Ã‡Âª
    184|   console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}Î“Ã‡Âª
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:375:21

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[8/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
Error: [TEST UTILS] MFA Secret verification failed for ae3c263e229a6f070257b126eaa11a56
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:182:21
    180|     where: eq(mfaSecrets.userId, userData.userId)
    181|   });
    182|   if (!check) throw new Error(`[TEST UTILS] MFA Secret verification faÎ“Ã‡Âª
       |                     ^
    183|   if (!check.enabled) throw new Error(`[TEST UTILS] MFA Secret enabledÎ“Ã‡Âª
    184|   console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}Î“Ã‡Âª
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:422:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[9/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
AssertionError: expected undefined to be true // Object.is equality

- Expected: 
true

+ Received: 
undefined

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:485:51
    483| 
    484|       // Should require MFA
    485|       expect(loginFromNewDevice.body.requiresMfa).toBe(true);
       |                                                   ^
    486|     });
    487| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[10/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should update lastUsedAt on trusted device login
TypeError: Cannot read properties of undefined (reading 'lastUsedAt')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:512:38
    510|       });
    511| 
    512|       const firstLastUsed = device1!.lastUsedAt;
       |                                      ^
    513| 
    514|       // Wait a bit

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[11/11]Î“Ã„Â»


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m11 failed[39m[22m[2m | [22m[1m[32m3 passed[39m[22m[90m (14)[39m
[2m   Start at [22m 15:01:18
[2m   Duration [22m 818.11s[2m (transform 534.81s, setup 744.71s, import 6.82s, tests 21.84s, environment 0ms)[22m

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mtests/integration/workflow_versioning.test.ts [22m[34mx1 [34m[39m
       [2m Filename pattern: [22m[34mtests/integration/trusted.devices.real.test.ts[39m

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  suppress all logs with { quiet: true }

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¤ add secrets lifecycle management: https://dotenvx.com/ops

{"level":30,"time":1768167826748,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768167861070,"env":"test","module":"auth-routes","userId":"de5166e5b8afd7bfda2626983566df7a","msg":"Login requires MFA verification"}
{"level":40,"time":1768167861182,"env":"test","module":"mfa-service","userId":"de5166e5b8afd7bfda2626983566df7a","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768167861182,"env":"test","module":"auth-routes","userId":"de5166e5b8afd7bfda2626983566df7a","msg":"MFA verification failed during login"}
{"level":50,"time":1768167861188,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768167862701,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768167862823,"env":"test","module":"mfa-service","userId":"d704f1934d204b8bfdb376551271bbde","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768167862823,"env":"test","module":"auth-routes","userId":"d704f1934d204b8bfdb376551271bbde","msg":"MFA verification failed during login"}
{"level":50,"time":1768167862832,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for de5166e5b8afd7bfda2626983566df7a

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39m[TEST UTILS] MFA Secret verified for d704f1934d204b8bfdb376551271bbde

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should set trust expiry to 30 days
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768167864299,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768167865750,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768167865857,"env":"test","module":"mfa-service","userId":"8e4283064731a2474b6c3e458c7aad1e","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768167865857,"env":"test","module":"auth-routes","userId":"8e4283064731a2474b6c3e458c7aad1e","msg":"MFA verification failed during login"}
{"level":50,"time":1768167865860,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768167866128,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768167866231,"env":"test","module":"mfa-service","userId":"8e4283064731a2474b6c3e458c7aad1e","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768167866231,"env":"test","module":"auth-routes","userId":"8e4283064731a2474b6c3e458c7aad1e","msg":"MFA verification failed during login"}
{"level":50,"time":1768167866234,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768167866493,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768167866600,"env":"test","module":"mfa-service","userId":"8e4283064731a2474b6c3e458c7aad1e","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768167866601,"env":"test","module":"auth-routes","userId":"8e4283064731a2474b6c3e458c7aad1e","msg":"MFA verification failed during login"}
{"level":50,"time":1768167866605,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768167868103,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768167868207,"env":"test","module":"mfa-service","userId":"f464bb9ffd43d445edfdcc45e4c1e8e8","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768167868207,"env":"test","module":"auth-routes","userId":"f464bb9ffd43d445edfdcc45e4c1e8e8","msg":"MFA verification failed during login"}
{"level":50,"time":1768167868212,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768167868216,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768167869664,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768167869781,"env":"test","module":"mfa-service","userId":"131365318b23450ed6bad34df4abd8af","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768167869781,"env":"test","module":"auth-routes","userId":"131365318b23450ed6bad34df4abd8af","msg":"MFA verification failed during login"}
{"level":50,"time":1768167869785,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768167869848,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768167871312,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768167871421,"env":"test","module":"mfa-service","userId":"267a48c12bb02ce77407eab64ab91457","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768167871421,"env":"test","module":"auth-routes","userId":"267a48c12bb02ce77407eab64ab91457","msg":"MFA verification failed during login"}
{"level":50,"time":1768167871425,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768167871480,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768167872924,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768167873036,"env":"test","module":"mfa-service","userId":"8ab0bc4def6ea4401f2176e6108941ee","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768167873036,"env":"test","module":"auth-routes","userId":"8ab0bc4def6ea4401f2176e6108941ee","msg":"MFA verification failed during login"}
{"level":50,"time":1768167873041,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768167873045,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768167874466,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768167874572,"env":"test","module":"mfa-service","userId":"0c21434aaf39014043f09114c8b870ea","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768167874572,"env":"test","module":"auth-routes","userId":"0c21434aaf39014043f09114c8b870ea","msg":"MFA verification failed during login"}
{"level":50,"time":1768167874576,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768167876788,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768167876897,"env":"test","module":"mfa-service","userId":"21f7aab153b6c5d864aae85d6dbcb60f","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768167876897,"env":"test","module":"auth-routes","userId":"21f7aab153b6c5d864aae85d6dbcb60f","msg":"MFA verification failed during login"}
{"level":50,"time":1768167876901,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768167876905,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768167878346,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":30,"time":1768167878458,"env":"test","module":"mfa-service","userId":"4786d3f8c284805889bacaa604fc114b","msg":"TOTP verification successful"}
{"level":30,"time":1768167878522,"env":"test","module":"auth-routes","userId":"4786d3f8c284805889bacaa604fc114b","msg":"MFA login successful"}
{"level":30,"time":1768167878705,"env":"test","module":"auth-routes","userId":"4786d3f8c284805889bacaa604fc114b","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":50,"time":1768167878974,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":30,"time":1768167880626,"env":"test","module":"auth-routes","userId":"ce2e9c3eadc88fd978f5ac1a4afa11c5","msg":"Login requires MFA verification"}
{"level":40,"time":1768167880740,"env":"test","module":"mfa-service","userId":"ce2e9c3eadc88fd978f5ac1a4afa11c5","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768167880740,"env":"test","module":"auth-routes","userId":"ce2e9c3eadc88fd978f5ac1a4afa11c5","msg":"MFA verification failed during login"}
{"level":50,"time":1768167880744,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768167881015,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":50,"time":1768167882453,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768167882562,"env":"test","module":"mfa-service","userId":"85354d015868117f67ff0fda523351bd","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768167882562,"env":"test","module":"auth-routes","userId":"85354d015868117f67ff0fda523351bd","msg":"MFA verification failed during login"}
{"level":50,"time":1768167882567,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39m[TEST UTILS] MFA Secret verified for 8e4283064731a2474b6c3e458c7aad1e

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for f464bb9ffd43d445edfdcc45e4c1e8e8

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should mark current device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39m[TEST UTILS] MFA Secret verified for 131365318b23450ed6bad34df4abd8af

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude revoked devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for 267a48c12bb02ce77407eab64ab91457

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude expired devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for 8ab0bc4def6ea4401f2176e6108941ee

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39m[TEST UTILS] MFA Secret verified for 0c21434aaf39014043f09114c8b870ea

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should return 404 for non-existent device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 21f7aab153b6c5d864aae85d6dbcb60f

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 59ad66883483e92183212d59d57a9108

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should prevent revoking other user's device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39m[TEST UTILS] MFA Secret verified for 4786d3f8c284805889bacaa604fc114b

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39m[TEST UTILS] MFA Secret verified for ce2e9c3eadc88fd978f5ac1a4afa11c5

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39m[TEST UTILS] MFA Secret verified for 85354d015868117f67ff0fda523351bd

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should update lastUsedAt on trusted device login
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m13 failed[39m[2m)[22m[33m 23949[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should trust current device[39m[33m 1822[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set trust expiry to 30 days[39m[33m 1637[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update expiry if device already trusted[39m[33m 1044[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 422[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all trusted devices[39m[33m 2305[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should mark current device[39m[33m 1612[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude revoked devices[39m[33m 1631[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude expired devices[39m[33m 1632[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific device[39m[33m 1565[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 404 for non-existent device[39m[33m 1532[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent revoking other user's device[39m[33m 2328[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should skip MFA for trusted device[39m[33m 2069[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should require MFA for untrusted device[39m[33m 2041[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update lastUsedAt on trusted device login[39m[33m 1602[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 13 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should trust current device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:52:36
     50|         .set("X-Forwarded-For", "192.168.1.100");
     51| 
     52|       expect(trustResponse.status).toBe(200);
       |                                    ^
     53|       expect(trustResponse.body.message).toContain("trusted");
     54|       expect(trustResponse.body.trustedUntil).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should set trust expiry to 30 days
AssertionError: expected NaN to be 30 // Object.is equality

- Expected
+ Received

- 30
+ NaN

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:92:24
     90|       );
     91| 
     92|       expect(diffDays).toBe(30);
       |                        ^
     93|     });
     94| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should update expiry if device already trusted
Error: [TEST UTILS] MFA Secret verification failed for 11153548e68aa8aeb5a1ac28a941dd97
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:182:21
    180|     where: eq(mfaSecrets.userId, userData.userId)
    181|   });
    182|   if (!check) throw new Error(`[TEST UTILS] MFA Secret verification faÎ“Ã‡Âª
       |                     ^
    183|   if (!check.enabled) throw new Error(`[TEST UTILS] MFA Secret enabledÎ“Ã‡Âª
    184|   console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}Î“Ã‡Âª
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:96:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:193:31
    191|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    192| 
    193|       expect(response.status).toBe(200);
       |                               ^
    194|       expect(response.body.devices).toBeDefined();
    195|       expect(response.body.devices.length).toBe(2);

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should mark current device
TypeError: Cannot read properties of undefined (reading 'find')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:236:51
    234|         .set("X-Forwarded-For", "192.168.1.100");
    235| 
    236|       const currentDevice = response.body.devices.find((d: any) => d.cÎ“Ã‡Âª
       |                                                   ^
    237|       expect(currentDevice).toBeDefined();
    238|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude revoked devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:269:36
    267|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    268| 
    269|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    270|     });
    271| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude expired devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:302:36
    300|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    301| 
    302|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    303|     });
    304|   });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[7/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:332:45
    330|         .set("Authorization", `Bearer ${token}`);
    331| 
    332|       const deviceId = devicesResponse.body.devices[0].id;
       |                                             ^
    333| 
    334|       // Revoke device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[8/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should return 404 for non-existent device
AssertionError: expected 401 to be 404 // Object.is equality

- Expected
+ Received

- 404
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:371:31
    369|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    370| 
    371|       expect(response.status).toBe(404);
       |                               ^
    372|     });
    373| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[9/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should prevent revoking other user's device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:399:43
    397|         .set("Authorization", `Bearer ${mfaLogin1.body.token}`);
    398| 
    399|       const user1DeviceId = devices1.body.devices[0].id;
       |                                           ^
    400| 
    401|       // User 2 tries to revoke user 1's device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[10/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:453:42
    451| 
    452|       // Should not require MFA
    453|       expect(secondLoginResponse.status).toBe(200);
       |                                          ^
    454|       expect(secondLoginResponse.body.requiresMfa).toBeUndefined();
    455|       expect(secondLoginResponse.body.token).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[11/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
AssertionError: expected undefined to be true // Object.is equality

- Expected: 
true

+ Received: 
undefined

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:485:51
    483| 
    484|       // Should require MFA
    485|       expect(loginFromNewDevice.body.requiresMfa).toBe(true);
       |                                                   ^
    486|     });
    487| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[12/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should update lastUsedAt on trusted device login
TypeError: Cannot read properties of undefined (reading 'lastUsedAt')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:512:38
    510|       });
    511| 
    512|       const firstLastUsed = device1!.lastUsedAt;
       |                                      ^
    513| 
    514|       // Wait a bit

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[13/13]Î“Ã„Â»


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m13 failed[39m[22m[2m | [22m[1m[32m1 passed[39m[22m[90m (14)[39m
[2m   Start at [22m 15:43:20
[2m   Duration [22m 75.99s

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mtests/setup.ts [22m[34mx2 [34m[39m
       [2m Filename pattern: [22m[34mtests/integration/trusted.devices.real.test.ts[39m

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild
DB: initializing... Neon

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mDB: initialized flag set.

{"level":30,"time":1768168599251,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for 3e8bd083829d1412e0aad861eed08fbb

{"level":30,"time":1768168602878,"env":"test","module":"auth-routes","userId":"3e8bd083829d1412e0aad861eed08fbb","msg":"Login requires MFA verification"}
{"level":30,"time":1768168603003,"env":"test","module":"mfa-service","userId":"3e8bd083829d1412e0aad861eed08fbb","msg":"TOTP verification successful"}
{"level":30,"time":1768168603062,"env":"test","module":"auth-routes","userId":"3e8bd083829d1412e0aad861eed08fbb","msg":"MFA login successful"}
{"level":30,"time":1768168603249,"env":"test","module":"auth-routes","userId":"3e8bd083829d1412e0aad861eed08fbb","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39m[TEST UTILS] MFA Secret verified for ef2069d55aeb4460a518691b5f46607e

{"level":50,"time":1768168605357,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should set trust expiry to 30 days
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768168605476,"env":"test","module":"mfa-service","userId":"ef2069d55aeb4460a518691b5f46607e","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768168605477,"env":"test","module":"auth-routes","userId":"ef2069d55aeb4460a518691b5f46607e","msg":"MFA verification failed during login"}
{"level":50,"time":1768168605486,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for cfbde03702aaee1485f66029b68652af

{"level":50,"time":1768168607285,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768168607399,"env":"test","module":"mfa-service","userId":"cfbde03702aaee1485f66029b68652af","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768168607399,"env":"test","module":"auth-routes","userId":"cfbde03702aaee1485f66029b68652af","msg":"MFA verification failed during login"}
{"level":50,"time":1768168607409,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should update expiry if device already trusted
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768168607514,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768168607944,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for 167689600210d467c6ba2fca243e6df5

{"level":50,"time":1768168610632,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768168610750,"env":"test","module":"mfa-service","userId":"167689600210d467c6ba2fca243e6df5","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768168610750,"env":"test","module":"auth-routes","userId":"167689600210d467c6ba2fca243e6df5","msg":"MFA verification failed during login"}
{"level":50,"time":1768168610755,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768168610760,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should mark current device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39m[TEST UTILS] MFA Secret verified for 4cbe51c579c82aa55d48ff682566e674

{"level":50,"time":1768168612557,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768168612670,"env":"test","module":"mfa-service","userId":"4cbe51c579c82aa55d48ff682566e674","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768168612670,"env":"test","module":"auth-routes","userId":"4cbe51c579c82aa55d48ff682566e674","msg":"MFA verification failed during login"}
{"level":50,"time":1768168612675,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768168612731,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude revoked devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for d2d1b856ca0ab3178710c50c773f4e36

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude expired devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768168614820,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768168614931,"env":"test","module":"mfa-service","userId":"d2d1b856ca0ab3178710c50c773f4e36","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768168614931,"env":"test","module":"auth-routes","userId":"d2d1b856ca0ab3178710c50c773f4e36","msg":"MFA verification failed during login"}
{"level":50,"time":1768168614936,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768168614993,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for aa15680c814b4ee01b18318c1b7a3427

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768168616666,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768168616780,"env":"test","module":"mfa-service","userId":"aa15680c814b4ee01b18318c1b7a3427","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768168616780,"env":"test","module":"auth-routes","userId":"aa15680c814b4ee01b18318c1b7a3427","msg":"MFA verification failed during login"}
{"level":50,"time":1768168616785,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768168616788,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39m[TEST UTILS] MFA Secret verified for 3303975878933cb3bfe43ad6d70ba66b

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should return 404 for non-existent device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768168618649,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768168618757,"env":"test","module":"mfa-service","userId":"3303975878933cb3bfe43ad6d70ba66b","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768168618757,"env":"test","module":"auth-routes","userId":"3303975878933cb3bfe43ad6d70ba66b","msg":"MFA verification failed during login"}
{"level":50,"time":1768168618762,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39m[TEST UTILS] MFA Secret verified for 989ce7ef0d644cd85d134676d5dc227e

{"level":30,"time":1768168621548,"env":"test","module":"auth-routes","userId":"989ce7ef0d644cd85d134676d5dc227e","msg":"Login requires MFA verification"}
{"level":40,"time":1768168621675,"env":"test","module":"mfa-service","userId":"989ce7ef0d644cd85d134676d5dc227e","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768168621675,"env":"test","module":"auth-routes","userId":"989ce7ef0d644cd85d134676d5dc227e","msg":"MFA verification failed during login"}
{"level":50,"time":1768168621680,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768168621972,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39m[TEST UTILS] MFA Secret verified for cc1120b5c44759a2fe9d93041393256e

{"level":30,"time":1768168623905,"env":"test","module":"auth-routes","userId":"cc1120b5c44759a2fe9d93041393256e","msg":"Login requires MFA verification"}
{"level":30,"time":1768168624019,"env":"test","module":"mfa-service","userId":"cc1120b5c44759a2fe9d93041393256e","msg":"TOTP verification successful"}
{"level":30,"time":1768168624076,"env":"test","module":"auth-routes","userId":"cc1120b5c44759a2fe9d93041393256e","msg":"MFA login successful"}
{"level":30,"time":1768168624249,"env":"test","module":"auth-routes","userId":"cc1120b5c44759a2fe9d93041393256e","deviceFingerprint":"10fa3aea039bf6fec7b6bcb982cbed1cc6ab844dd3c0879bec32baefb2997b52","msg":"Device marked as trusted"}
{"level":30,"time":1768168624786,"env":"test","module":"auth-routes","userId":"cc1120b5c44759a2fe9d93041393256e","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39m[TEST UTILS] MFA Secret verified for 9a5b4763db529ceef3b43b59566e149b

{"level":30,"time":1768168626774,"env":"test","module":"auth-routes","userId":"9a5b4763db529ceef3b43b59566e149b","msg":"Login requires MFA verification"}
{"level":40,"time":1768168626888,"env":"test","module":"mfa-service","userId":"9a5b4763db529ceef3b43b59566e149b","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768168626888,"env":"test","module":"auth-routes","userId":"9a5b4763db529ceef3b43b59566e149b","msg":"MFA verification failed during login"}
{"level":50,"time":1768168626895,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m12 failed[39m[2m)[22m[33m 27470[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should trust current device[39m[33m 3018[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set trust expiry to 30 days[39m[33m 2167[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update expiry if device already trusted[39m[33m 2028[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 428[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all trusted devices[39m[33m 948[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should mark current device[39m[33m 1869[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude revoked devices[39m[33m 1971[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude expired devices[39m[33m 2261[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific device[39m[33m 1795[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 404 for non-existent device[39m[33m 1974[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent revoking other user's device[39m[33m 961[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should skip MFA for trusted device[39m[33m 2251[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require MFA for untrusted device [33m 2812[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update lastUsedAt on trusted device login[39m[33m 2160[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 12 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should trust current device
AssertionError: expected +0 to be 1 // Object.is equality

- Expected
+ Received

- 1
+ 0

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:64:30
     62|       });
     63| 
     64|       expect(devices.length).toBe(1);
       |                              ^
     65|       expect(devices[0].deviceName).toBeDefined();
     66|       expect(devices[0].ipAddress).toBe("192.168.1.100");

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/12]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should set trust expiry to 30 days
AssertionError: expected NaN to be 30 // Object.is equality

- Expected
+ Received

- 30
+ NaN

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:92:24
     90|       );
     91| 
     92|       expect(diffDays).toBe(30);
       |                        ^
     93|     });
     94| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/12]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should update expiry if device already trusted
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:132:42
    130| 
    131|       // Should have extended expiry
    132|       expect(secondExpiry > firstExpiry).toBe(true);
       |                                          ^
    133| 
    134|       // Should still only have 1 device record

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/12]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
Error: [TEST UTILS] MFA Secret verification failed for 724c0b31b93c5db4fd875b10a40ba464
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:182:21
    180|     where: eq(mfaSecrets.userId, userData.userId)
    181|   });
    182|   if (!check) throw new Error(`[TEST UTILS] MFA Secret verification faÎ“Ã‡Âª
       |                     ^
    183|   if (!check.enabled) throw new Error(`[TEST UTILS] MFA Secret enabledÎ“Ã‡Âª
    184|   console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}Î“Ã‡Âª
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:154:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/12]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should mark current device
TypeError: Cannot read properties of undefined (reading 'find')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:236:51
    234|         .set("X-Forwarded-For", "192.168.1.100");
    235| 
    236|       const currentDevice = response.body.devices.find((d: any) => d.cÎ“Ã‡Âª
       |                                                   ^
    237|       expect(currentDevice).toBeDefined();
    238|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/12]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude revoked devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:269:36
    267|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    268| 
    269|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    270|     });
    271| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/12]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude expired devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:302:36
    300|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    301| 
    302|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    303|     });
    304|   });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[7/12]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:332:45
    330|         .set("Authorization", `Bearer ${token}`);
    331| 
    332|       const deviceId = devicesResponse.body.devices[0].id;
       |                                             ^
    333| 
    334|       // Revoke device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[8/12]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should return 404 for non-existent device
AssertionError: expected 401 to be 404 // Object.is equality

- Expected
+ Received

- 404
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:371:31
    369|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    370| 
    371|       expect(response.status).toBe(404);
       |                               ^
    372|     });
    373| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[9/12]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should prevent revoking other user's device
Error: [TEST UTILS] MFA Secret verification failed for 930d61ab5644a3245c9b638b2c14c80c
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:182:21
    180|     where: eq(mfaSecrets.userId, userData.userId)
    181|   });
    182|   if (!check) throw new Error(`[TEST UTILS] MFA Secret verification faÎ“Ã‡Âª
       |                     ^
    183|   if (!check.enabled) throw new Error(`[TEST UTILS] MFA Secret enabledÎ“Ã‡Âª
    184|   console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}Î“Ã‡Âª
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:375:21

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[10/12]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:453:42
    451| 
    452|       // Should not require MFA
    453|       expect(secondLoginResponse.status).toBe(200);
       |                                          ^
    454|       expect(secondLoginResponse.body.requiresMfa).toBeUndefined();
    455|       expect(secondLoginResponse.body.token).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[11/12]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should update lastUsedAt on trusted device login
TypeError: Cannot read properties of undefined (reading 'lastUsedAt')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:512:38
    510|       });
    511| 
    512|       const firstLastUsed = device1!.lastUsedAt;
       |                                      ^
    513| 
    514|       // Wait a bit

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[12/12]Î“Ã„Â»


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m12 failed[39m[22m[2m | [22m[1m[32m2 passed[39m[22m[90m (14)[39m
[2m   Start at [22m 15:53:32
[2m   Duration [22m 180.55s

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mtests/setup.ts [22m[34mx3 [34m[39m
       [2m Filename pattern: [22m[34mtests/integration/trusted.devices.real.test.ts[39m

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent committing .env to code: https://dotenvx.com/precommit
DB: initializing... Neon

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mDB: initialized flag set.

{"level":30,"time":1768168636636,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

{"level":30,"time":1768168640476,"env":"test","module":"auth-routes","userId":"c5db06bd1419f5c22289c817e66084fc","msg":"Login requires MFA verification"}
{"level":40,"time":1768168640595,"env":"test","module":"mfa-service","userId":"c5db06bd1419f5c22289c817e66084fc","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768168640595,"env":"test","module":"auth-routes","userId":"c5db06bd1419f5c22289c817e66084fc","msg":"MFA verification failed during login"}
{"level":50,"time":1768168640603,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for c5db06bd1419f5c22289c817e66084fc

{"level":50,"time":1768168642076,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39m[TEST UTILS] MFA Secret verified for 6cb6ebc6b9af96a7ad3e286f16927b48

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should set trust expiry to 30 days
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768168642188,"env":"test","module":"mfa-service","userId":"6cb6ebc6b9af96a7ad3e286f16927b48","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768168642188,"env":"test","module":"auth-routes","userId":"6cb6ebc6b9af96a7ad3e286f16927b48","msg":"MFA verification failed during login"}
{"level":50,"time":1768168642196,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for 6d187fcdce75791bd631f4cf49f582eb

{"level":50,"time":1768168643692,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":30,"time":1768168643806,"env":"test","module":"mfa-service","userId":"6d187fcdce75791bd631f4cf49f582eb","msg":"TOTP verification successful"}
{"level":30,"time":1768168643858,"env":"test","module":"auth-routes","userId":"6d187fcdce75791bd631f4cf49f582eb","msg":"MFA login successful"}
{"level":30,"time":1768168644026,"env":"test","module":"auth-routes","userId":"6d187fcdce75791bd631f4cf49f582eb","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should update expiry if device already trusted
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768168644295,"env":"test","module":"auth-routes","userId":"6d187fcdce75791bd631f4cf49f582eb","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Trusted device expiry updated"}
{"level":50,"time":1768168644748,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for 9871f03cf47250b3d9b385a02d7e2595

{"level":30,"time":1768168647295,"env":"test","module":"auth-routes","userId":"9871f03cf47250b3d9b385a02d7e2595","msg":"Login requires MFA verification"}
{"level":30,"time":1768168647410,"env":"test","module":"mfa-service","userId":"9871f03cf47250b3d9b385a02d7e2595","msg":"TOTP verification successful"}
{"level":30,"time":1768168647461,"env":"test","module":"auth-routes","userId":"9871f03cf47250b3d9b385a02d7e2595","msg":"MFA login successful"}
{"level":30,"time":1768168647622,"env":"test","module":"auth-routes","userId":"9871f03cf47250b3d9b385a02d7e2595","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768168647739,"env":"test","module":"auth-routes","userId":"9871f03cf47250b3d9b385a02d7e2595","deviceCount":1,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39m[TEST UTILS] MFA Secret verified for ff9dc86ca36f44bfff45091b4883632b

{"level":30,"time":1768168649470,"env":"test","module":"auth-routes","userId":"ff9dc86ca36f44bfff45091b4883632b","msg":"Login requires MFA verification"}
{"level":40,"time":1768168649580,"env":"test","module":"mfa-service","userId":"ff9dc86ca36f44bfff45091b4883632b","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768168649580,"env":"test","module":"auth-routes","userId":"ff9dc86ca36f44bfff45091b4883632b","msg":"MFA verification failed during login"}
{"level":50,"time":1768168649588,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768168649656,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for ab9c67e5eed58f998dccb69fa02ce25d

{"level":50,"time":1768168651114,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768168651218,"env":"test","module":"mfa-service","userId":"ab9c67e5eed58f998dccb69fa02ce25d","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768168651218,"env":"test","module":"auth-routes","userId":"ab9c67e5eed58f998dccb69fa02ce25d","msg":"MFA verification failed during login"}
{"level":50,"time":1768168651222,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768168651277,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude expired devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768168652713,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768168652818,"env":"test","module":"mfa-service","userId":"e45a6c1f9a70348b5fc39b9e797dca97","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768168652819,"env":"test","module":"auth-routes","userId":"e45a6c1f9a70348b5fc39b9e797dca97","msg":"MFA verification failed during login"}
{"level":50,"time":1768168652823,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768168652826,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for e45a6c1f9a70348b5fc39b9e797dca97

{"level":50,"time":1768168654279,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768168654396,"env":"test","module":"mfa-service","userId":"14c9ab4ab488f7afc6d57bafb5823a4e","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768168654396,"env":"test","module":"auth-routes","userId":"14c9ab4ab488f7afc6d57bafb5823a4e","msg":"MFA verification failed during login"}
{"level":50,"time":1768168654401,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768168656630,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768168656735,"env":"test","module":"mfa-service","userId":"d81aafbdc1bd7abd6714d65029fe77ef","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768168656735,"env":"test","module":"auth-routes","userId":"d81aafbdc1bd7abd6714d65029fe77ef","msg":"MFA verification failed during login"}
{"level":50,"time":1768168656740,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768168656745,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39m[TEST UTILS] MFA Secret verified for 14c9ab4ab488f7afc6d57bafb5823a4e

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should return 404 for non-existent device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for d81aafbdc1bd7abd6714d65029fe77ef

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 6438c2b0c8ab3c414956f0e9d0573083

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should prevent revoking other user's device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39m[TEST UTILS] MFA Secret verified for f09fcdaeb46ec11aac9b2ead4a2fddd9

{"level":30,"time":1768168658465,"env":"test","module":"auth-routes","userId":"f09fcdaeb46ec11aac9b2ead4a2fddd9","msg":"Login requires MFA verification"}
{"level":40,"time":1768168658577,"env":"test","module":"mfa-service","userId":"f09fcdaeb46ec11aac9b2ead4a2fddd9","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768168658577,"env":"test","module":"auth-routes","userId":"f09fcdaeb46ec11aac9b2ead4a2fddd9","msg":"MFA verification failed during login"}
{"level":50,"time":1768168658581,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768168658834,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768168660490,"env":"test","module":"auth-routes","userId":"a311b900e945662ef0815fb189a28e86","msg":"Login requires MFA verification"}
{"level":40,"time":1768168660592,"env":"test","module":"mfa-service","userId":"a311b900e945662ef0815fb189a28e86","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768168660593,"env":"test","module":"auth-routes","userId":"a311b900e945662ef0815fb189a28e86","msg":"MFA verification failed during login"}
{"level":50,"time":1768168660597,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768168660858,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39m[TEST UTILS] MFA Secret verified for a311b900e945662ef0815fb189a28e86

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768168662529,"env":"test","module":"auth-routes","userId":"58fb9bdc5bf8ba09c34e66d5ce9f94c5","msg":"Login requires MFA verification"}
{"level":30,"time":1768168662640,"env":"test","module":"mfa-service","userId":"58fb9bdc5bf8ba09c34e66d5ce9f94c5","msg":"TOTP verification successful"}
{"level":30,"time":1768168662694,"env":"test","module":"auth-routes","userId":"58fb9bdc5bf8ba09c34e66d5ce9f94c5","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39m[TEST UTILS] MFA Secret verified for 58fb9bdc5bf8ba09c34e66d5ce9f94c5

{"level":30,"time":1768168662861,"env":"test","module":"auth-routes","userId":"58fb9bdc5bf8ba09c34e66d5ce9f94c5","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768168663493,"env":"test","module":"auth-routes","userId":"58fb9bdc5bf8ba09c34e66d5ce9f94c5","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m12 failed[39m[2m)[22m[33m 25489[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should trust current device[39m[33m 1842[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set trust expiry to 30 days[39m[33m 1575[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update expiry if device already trusted[39m[33m 2148[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 402[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all trusted devices[39m[33m 904[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should mark current device [33m 2086[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude revoked devices[39m[33m 1919[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude expired devices[39m[33m 1620[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific device[39m[33m 1549[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 404 for non-existent device[39m[33m 1577[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent revoking other user's device[39m[33m 2343[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should skip MFA for trusted device[39m[33m 2090[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should require MFA for untrusted device[39m[33m 2023[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update lastUsedAt on trusted device login[39m[33m 2685[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 12 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should trust current device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:52:36
     50|         .set("X-Forwarded-For", "192.168.1.100");
     51| 
     52|       expect(trustResponse.status).toBe(200);
       |                                    ^
     53|       expect(trustResponse.body.message).toContain("trusted");
     54|       expect(trustResponse.body.trustedUntil).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/12]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should set trust expiry to 30 days
AssertionError: expected NaN to be 30 // Object.is equality

- Expected
+ Received

- 30
+ NaN

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:92:24
     90|       );
     91| 
     92|       expect(diffDays).toBe(30);
       |                        ^
     93|     });
     94| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/12]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should update expiry if device already trusted
AssertionError: expected +0 to be 1 // Object.is equality

- Expected
+ Received

- 1
+ 0

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:142:30
    140|       });
    141| 
    142|       expect(devices.length).toBe(1);
       |                              ^
    143|     });
    144| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/12]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
Error: [TEST UTILS] MFA Secret verification failed for 97fbb8803a709d61af2b231685985017
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:182:21
    180|     where: eq(mfaSecrets.userId, userData.userId)
    181|   });
    182|   if (!check) throw new Error(`[TEST UTILS] MFA Secret verification faÎ“Ã‡Âª
       |                     ^
    183|   if (!check.enabled) throw new Error(`[TEST UTILS] MFA Secret enabledÎ“Ã‡Âª
    184|   console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}Î“Ã‡Âª
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:154:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/12]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude revoked devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:269:36
    267|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    268| 
    269|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    270|     });
    271| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/12]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude expired devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:302:36
    300|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    301| 
    302|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    303|     });
    304|   });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/12]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:332:45
    330|         .set("Authorization", `Bearer ${token}`);
    331| 
    332|       const deviceId = devicesResponse.body.devices[0].id;
       |                                             ^
    333| 
    334|       // Revoke device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[7/12]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should return 404 for non-existent device
AssertionError: expected 401 to be 404 // Object.is equality

- Expected
+ Received

- 404
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:371:31
    369|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    370| 
    371|       expect(response.status).toBe(404);
       |                               ^
    372|     });
    373| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[8/12]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should prevent revoking other user's device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:399:43
    397|         .set("Authorization", `Bearer ${mfaLogin1.body.token}`);
    398| 
    399|       const user1DeviceId = devices1.body.devices[0].id;
       |                                           ^
    400| 
    401|       // User 2 tries to revoke user 1's device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[9/12]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:453:42
    451| 
    452|       // Should not require MFA
    453|       expect(secondLoginResponse.status).toBe(200);
       |                                          ^
    454|       expect(secondLoginResponse.body.requiresMfa).toBeUndefined();
    455|       expect(secondLoginResponse.body.token).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[10/12]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
AssertionError: expected undefined to be true // Object.is equality

- Expected: 
true

+ Received: 
undefined

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:485:51
    483| 
    484|       // Should require MFA
    485|       expect(loginFromNewDevice.body.requiresMfa).toBe(true);
       |                                                   ^
    486|     });
    487| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[11/12]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should update lastUsedAt on trusted device login
TypeError: Cannot read properties of undefined (reading 'lastUsedAt')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:528:39
    526|       });
    527| 
    528|       const secondLastUsed = device2!.lastUsedAt;
       |                                       ^
    529| 
    530|       // lastUsedAt should be updated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[12/12]Î“Ã„Â»


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m12 failed[39m[22m[2m | [22m[1m[32m2 passed[39m[22m[90m (14)[39m
[2m   Start at [22m 15:57:07
[2m   Duration [22m 33.35s

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mtests/integration/analytics_service.test.ts [22m[34mx4 [34m[39m
       [2m Filename pattern: [22m[34mtests/integration/trusted.devices.real.test.ts[39m

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops
DB: initializing... Neon

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mDB: initialized flag set.

{"level":30,"time":1768184971302,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for 9e7dd023aa4b015604313eb857da9202

{"level":50,"time":1768184973749,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768184973876,"env":"test","module":"mfa-service","userId":"9e7dd023aa4b015604313eb857da9202","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768184973876,"env":"test","module":"auth-routes","userId":"9e7dd023aa4b015604313eb857da9202","msg":"MFA verification failed during login"}
{"level":50,"time":1768184973883,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768184975434,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768184975548,"env":"test","module":"mfa-service","userId":"7402b42b038c9922dbfc881edca30684","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768184975549,"env":"test","module":"auth-routes","userId":"7402b42b038c9922dbfc881edca30684","msg":"MFA verification failed during login"}
{"level":50,"time":1768184975554,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768184977027,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768184977140,"env":"test","module":"mfa-service","userId":"6af0c6d90d256f7220fc73d9d34d380e","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768184977140,"env":"test","module":"auth-routes","userId":"6af0c6d90d256f7220fc73d9d34d380e","msg":"MFA verification failed during login"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should trust current device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768184977144,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768184977251,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768184977661,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768184979337,"env":"test","module":"auth-routes","userId":"45b96bfbb17e2d3affd6d2a653deebc5","msg":"Login requires MFA verification"}
{"level":40,"time":1768184979443,"env":"test","module":"mfa-service","userId":"45b96bfbb17e2d3affd6d2a653deebc5","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768184979443,"env":"test","module":"auth-routes","userId":"45b96bfbb17e2d3affd6d2a653deebc5","msg":"MFA verification failed during login"}
{"level":50,"time":1768184979447,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768184979707,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768184979813,"env":"test","module":"mfa-service","userId":"45b96bfbb17e2d3affd6d2a653deebc5","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768184979813,"env":"test","module":"auth-routes","userId":"45b96bfbb17e2d3affd6d2a653deebc5","msg":"MFA verification failed during login"}
{"level":50,"time":1768184979818,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768184980081,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768184980193,"env":"test","module":"mfa-service","userId":"45b96bfbb17e2d3affd6d2a653deebc5","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768184980194,"env":"test","module":"auth-routes","userId":"45b96bfbb17e2d3affd6d2a653deebc5","msg":"MFA verification failed during login"}
{"level":50,"time":1768184980199,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768184981690,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768184981807,"env":"test","module":"mfa-service","userId":"c0918536feca91cb78ffd89148ca6e64","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768184981807,"env":"test","module":"auth-routes","userId":"c0918536feca91cb78ffd89148ca6e64","msg":"MFA verification failed during login"}
{"level":50,"time":1768184981811,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768184981816,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768184983255,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768184983369,"env":"test","module":"mfa-service","userId":"b288b0c8a6905cc80048fb912784a49e","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768184983369,"env":"test","module":"auth-routes","userId":"b288b0c8a6905cc80048fb912784a49e","msg":"MFA verification failed during login"}
{"level":50,"time":1768184983373,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768184983427,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768184985135,"env":"test","module":"auth-routes","userId":"f1e7a893d934021f4760c1b8033f1b49","msg":"Login requires MFA verification"}
{"level":40,"time":1768184985247,"env":"test","module":"mfa-service","userId":"f1e7a893d934021f4760c1b8033f1b49","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768184985247,"env":"test","module":"auth-routes","userId":"f1e7a893d934021f4760c1b8033f1b49","msg":"MFA verification failed during login"}
{"level":50,"time":1768184985252,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768184985310,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768184987058,"env":"test","module":"auth-routes","userId":"701a65aaec2fb229e20c68b3fd744a1d","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39m[TEST UTILS] MFA Secret verified for 7402b42b038c9922dbfc881edca30684

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should set trust expiry to 30 days
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for 6af0c6d90d256f7220fc73d9d34d380e

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should update expiry if device already trusted
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39m[TEST UTILS] MFA Secret verified for 45b96bfbb17e2d3affd6d2a653deebc5

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for c0918536feca91cb78ffd89148ca6e64

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should mark current device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39m[TEST UTILS] MFA Secret verified for b288b0c8a6905cc80048fb912784a49e

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude revoked devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for f1e7a893d934021f4760c1b8033f1b49

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for 701a65aaec2fb229e20c68b3fd744a1d

{"level":40,"time":1768184987173,"env":"test","module":"mfa-service","userId":"701a65aaec2fb229e20c68b3fd744a1d","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768184987173,"env":"test","module":"auth-routes","userId":"701a65aaec2fb229e20c68b3fd744a1d","msg":"MFA verification failed during login"}
{"level":50,"time":1768184987178,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768184987182,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39m[TEST UTILS] MFA Secret verified for 2c25b81d42af6180d0082102cc9d978c

{"level":30,"time":1768184989079,"env":"test","module":"auth-routes","userId":"2c25b81d42af6180d0082102cc9d978c","msg":"Login requires MFA verification"}
{"level":30,"time":1768184989195,"env":"test","module":"mfa-service","userId":"2c25b81d42af6180d0082102cc9d978c","msg":"TOTP verification successful"}
{"level":30,"time":1768184989253,"env":"test","module":"auth-routes","userId":"2c25b81d42af6180d0082102cc9d978c","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 327b4ca9bd6715be520e0146bfe3efdb

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 3fd61862da3eeaa3b56f27b963663f11

{"level":30,"time":1768184992025,"env":"test","module":"auth-routes","userId":"327b4ca9bd6715be520e0146bfe3efdb","msg":"Login requires MFA verification"}
{"level":30,"time":1768184992134,"env":"test","module":"mfa-service","userId":"327b4ca9bd6715be520e0146bfe3efdb","msg":"TOTP verification successful"}
{"level":30,"time":1768184992186,"env":"test","module":"auth-routes","userId":"327b4ca9bd6715be520e0146bfe3efdb","msg":"MFA login successful"}
{"level":30,"time":1768184992355,"env":"test","module":"auth-routes","userId":"327b4ca9bd6715be520e0146bfe3efdb","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768184992469,"env":"test","module":"auth-routes","userId":"327b4ca9bd6715be520e0146bfe3efdb","deviceCount":1,"msg":"Listed trusted devices"}
{"level":30,"time":1768184992990,"env":"test","module":"auth-routes","userId":"3fd61862da3eeaa3b56f27b963663f11","msg":"Login requires MFA verification"}
{"level":30,"time":1768184993095,"env":"test","module":"mfa-service","userId":"3fd61862da3eeaa3b56f27b963663f11","msg":"TOTP verification successful"}
{"level":30,"time":1768184993149,"env":"test","module":"auth-routes","userId":"3fd61862da3eeaa3b56f27b963663f11","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39m[TEST UTILS] MFA Secret verified for 4261184214bd0b47dac58c1a4ded26a5

{"level":50,"time":1768184994734,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768184994843,"env":"test","module":"mfa-service","userId":"4261184214bd0b47dac58c1a4ded26a5","msg":"TOTP verification successful"}
{"level":30,"time":1768184994894,"env":"test","module":"auth-routes","userId":"4261184214bd0b47dac58c1a4ded26a5","msg":"MFA login successful"}
{"level":30,"time":1768184995057,"env":"test","module":"auth-routes","userId":"4261184214bd0b47dac58c1a4ded26a5","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":50,"time":1768184995323,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39m[TEST UTILS] MFA Secret verified for f2318e64d96fc71981c816f8b755b71e

{"level":30,"time":1768184996987,"env":"test","module":"auth-routes","userId":"f2318e64d96fc71981c816f8b755b71e","msg":"Login requires MFA verification"}
{"level":30,"time":1768184997098,"env":"test","module":"mfa-service","userId":"f2318e64d96fc71981c816f8b755b71e","msg":"TOTP verification successful"}
{"level":30,"time":1768184997151,"env":"test","module":"auth-routes","userId":"f2318e64d96fc71981c816f8b755b71e","msg":"MFA login successful"}
{"level":30,"time":1768184997307,"env":"test","module":"auth-routes","userId":"f2318e64d96fc71981c816f8b755b71e","deviceFingerprint":"10fa3aea039bf6fec7b6bcb982cbed1cc6ab844dd3c0879bec32baefb2997b52","msg":"Device marked as trusted"}
{"level":30,"time":1768184997800,"env":"test","module":"auth-routes","userId":"f2318e64d96fc71981c816f8b755b71e","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m10 failed[39m[2m)[22m[33m 27352[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should trust current device[39m[33m 1711[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set trust expiry to 30 days[39m[33m 1665[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update expiry if device already trusted[39m[33m 1697[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 410[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all trusted devices[39m[33m 2538[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should mark current device[39m[33m 1616[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude revoked devices[39m[33m 1610[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude expired devices[39m[33m 1884[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific device[39m[33m 1872[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 404 for non-existent device [33m 2126[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prevent revoking other user's device [33m 3953[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should skip MFA for trusted device[39m[33m 2062[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require MFA for untrusted device [33m 2477[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update lastUsedAt on trusted device login[39m[33m 909[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 10 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should trust current device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:52:36
     50|         .set("X-Forwarded-For", "192.168.1.100");
     51| 
     52|       expect(trustResponse.status).toBe(200);
       |                                    ^
     53|       expect(trustResponse.body.message).toContain("trusted");
     54|       expect(trustResponse.body.trustedUntil).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should set trust expiry to 30 days
AssertionError: expected NaN to be 30 // Object.is equality

- Expected
+ Received

- 30
+ NaN

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:92:24
     90|       );
     91| 
     92|       expect(diffDays).toBe(30);
       |                        ^
     93|     });
     94| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should update expiry if device already trusted
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:132:42
    130| 
    131|       // Should have extended expiry
    132|       expect(secondExpiry > firstExpiry).toBe(true);
       |                                          ^
    133| 
    134|       // Should still only have 1 device record

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:193:31
    191|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    192| 
    193|       expect(response.status).toBe(200);
       |                               ^
    194|       expect(response.body.devices).toBeDefined();
    195|       expect(response.body.devices.length).toBe(2);

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should mark current device
TypeError: Cannot read properties of undefined (reading 'find')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:236:51
    234|         .set("X-Forwarded-For", "192.168.1.100");
    235| 
    236|       const currentDevice = response.body.devices.find((d: any) => d.cÎ“Ã‡Âª
       |                                                   ^
    237|       expect(currentDevice).toBeDefined();
    238|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude revoked devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:269:36
    267|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    268| 
    269|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    270|     });
    271| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude expired devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:302:36
    300|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    301| 
    302|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    303|     });
    304|   });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[7/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:332:45
    330|         .set("Authorization", `Bearer ${token}`);
    331| 
    332|       const deviceId = devicesResponse.body.devices[0].id;
       |                                             ^
    333| 
    334|       // Revoke device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[8/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:453:42
    451| 
    452|       // Should not require MFA
    453|       expect(secondLoginResponse.status).toBe(200);
       |                                          ^
    454|       expect(secondLoginResponse.body.requiresMfa).toBeUndefined();
    455|       expect(secondLoginResponse.body.token).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[9/10]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should update lastUsedAt on trusted device login
Error: [TEST UTILS] MFA Secret verification failed for 461438ad9420979f3990f134c552697f
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:182:21
    180|     where: eq(mfaSecrets.userId, userData.userId)
    181|   });
    182|   if (!check) throw new Error(`[TEST UTILS] MFA Secret verification faÎ“Ã‡Âª
       |                     ^
    183|   if (!check.enabled) throw new Error(`[TEST UTILS] MFA Secret enabledÎ“Ã‡Âª
    184|   console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}Î“Ã‡Âª
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:489:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[10/10]Î“Ã„Â»


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m10 failed[39m[22m[2m | [22m[1m[32m4 passed[39m[22m[90m (14)[39m
[2m   Start at [22m 20:28:59
[2m   Duration [22m 35.11s

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/db.ts [22m[34mx5 [34m[39m
       [2m Filename pattern: [22m[34mtests/integration/trusted.devices.real.test.ts[39m

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768234925498,"env":"test","msg":"DB: initializing... Neon"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768234925685,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768234929791,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for bbf30fda445443e0f28528b6e2250547

{"level":30,"time":1768234932914,"env":"test","module":"auth-routes","userId":"bbf30fda445443e0f28528b6e2250547","msg":"Login requires MFA verification"}
{"level":30,"time":1768234933036,"env":"test","module":"mfa-service","userId":"bbf30fda445443e0f28528b6e2250547","msg":"TOTP verification successful"}
{"level":30,"time":1768234933095,"env":"test","module":"auth-routes","userId":"bbf30fda445443e0f28528b6e2250547","msg":"MFA login successful"}
{"level":30,"time":1768234933266,"env":"test","module":"auth-routes","userId":"bbf30fda445443e0f28528b6e2250547","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768234935160,"env":"test","module":"auth-routes","userId":"545488e98ce9ea99c01085b1f3b3adf5","msg":"Login requires MFA verification"}
{"level":30,"time":1768234935271,"env":"test","module":"mfa-service","userId":"545488e98ce9ea99c01085b1f3b3adf5","msg":"TOTP verification successful"}
{"level":30,"time":1768234935328,"env":"test","module":"auth-routes","userId":"545488e98ce9ea99c01085b1f3b3adf5","msg":"MFA login successful"}
{"level":30,"time":1768234935488,"env":"test","module":"auth-routes","userId":"545488e98ce9ea99c01085b1f3b3adf5","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768234937168,"env":"test","module":"auth-routes","userId":"d72a59ca3f41d8333010e2b768ebebf3","msg":"Login requires MFA verification"}
{"level":30,"time":1768234937280,"env":"test","module":"mfa-service","userId":"d72a59ca3f41d8333010e2b768ebebf3","msg":"TOTP verification successful"}
{"level":30,"time":1768234937331,"env":"test","module":"auth-routes","userId":"d72a59ca3f41d8333010e2b768ebebf3","msg":"MFA login successful"}
{"level":30,"time":1768234937526,"env":"test","module":"auth-routes","userId":"d72a59ca3f41d8333010e2b768ebebf3","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768234937786,"env":"test","module":"auth-routes","userId":"d72a59ca3f41d8333010e2b768ebebf3","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Trusted device expiry updated"}
{"level":50,"time":1768234938234,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768234939920,"env":"test","module":"auth-routes","userId":"80103ba57b0566a58f22a6806beff06c","msg":"Login requires MFA verification"}
{"level":30,"time":1768234940026,"env":"test","module":"mfa-service","userId":"80103ba57b0566a58f22a6806beff06c","msg":"TOTP verification successful"}
{"level":30,"time":1768234940083,"env":"test","module":"auth-routes","userId":"80103ba57b0566a58f22a6806beff06c","msg":"MFA login successful"}
{"level":30,"time":1768234940242,"env":"test","module":"auth-routes","userId":"80103ba57b0566a58f22a6806beff06c","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768234940732,"env":"test","module":"auth-routes","userId":"80103ba57b0566a58f22a6806beff06c","msg":"Login requires MFA verification"}
{"level":30,"time":1768234940839,"env":"test","module":"mfa-service","userId":"80103ba57b0566a58f22a6806beff06c","msg":"TOTP verification successful"}
{"level":30,"time":1768234940893,"env":"test","module":"auth-routes","userId":"80103ba57b0566a58f22a6806beff06c","msg":"MFA login successful"}
{"level":30,"time":1768234941048,"env":"test","module":"auth-routes","userId":"80103ba57b0566a58f22a6806beff06c","deviceFingerprint":"091366faa1882b5c8dc1cba02126615a77a378274bbfd3375e821aa38bdd1b4f","msg":"Device marked as trusted"}
{"level":30,"time":1768234941545,"env":"test","module":"auth-routes","userId":"80103ba57b0566a58f22a6806beff06c","msg":"Login requires MFA verification"}
{"level":30,"time":1768234941654,"env":"test","module":"mfa-service","userId":"80103ba57b0566a58f22a6806beff06c","msg":"TOTP verification successful"}
{"level":30,"time":1768234941704,"env":"test","module":"auth-routes","userId":"80103ba57b0566a58f22a6806beff06c","msg":"MFA login successful"}
{"level":30,"time":1768234941816,"env":"test","module":"auth-routes","userId":"80103ba57b0566a58f22a6806beff06c","deviceCount":2,"msg":"Listed trusted devices"}
{"level":30,"time":1768234943547,"env":"test","module":"auth-routes","userId":"8031a2e728c272e7cfea4d4d7b22260e","msg":"Login requires MFA verification"}
{"level":30,"time":1768234943664,"env":"test","module":"mfa-service","userId":"8031a2e728c272e7cfea4d4d7b22260e","msg":"TOTP verification successful"}
{"level":30,"time":1768234943719,"env":"test","module":"auth-routes","userId":"8031a2e728c272e7cfea4d4d7b22260e","msg":"MFA login successful"}
{"level":30,"time":1768234943879,"env":"test","module":"auth-routes","userId":"8031a2e728c272e7cfea4d4d7b22260e","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39m[TEST UTILS] MFA Secret verified for 545488e98ce9ea99c01085b1f3b3adf5

{"level":30,"time":1768234943995,"env":"test","module":"auth-routes","userId":"8031a2e728c272e7cfea4d4d7b22260e","deviceCount":1,"msg":"Listed trusted devices"}
{"level":30,"time":1768234945645,"env":"test","module":"auth-routes","userId":"ca9610783210f633a5c6cfc0e76453b6","msg":"Login requires MFA verification"}
{"level":30,"time":1768234945755,"env":"test","module":"mfa-service","userId":"ca9610783210f633a5c6cfc0e76453b6","msg":"TOTP verification successful"}
{"level":30,"time":1768234945808,"env":"test","module":"auth-routes","userId":"ca9610783210f633a5c6cfc0e76453b6","msg":"MFA login successful"}
{"level":30,"time":1768234945971,"env":"test","module":"auth-routes","userId":"ca9610783210f633a5c6cfc0e76453b6","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768234946134,"env":"test","module":"auth-routes","userId":"ca9610783210f633a5c6cfc0e76453b6","deviceCount":0,"msg":"Listed trusted devices"}
{"level":30,"time":1768234947835,"env":"test","module":"auth-routes","userId":"e588cc08a47cf0158dad4cf0c35c3cf9","msg":"Login requires MFA verification"}
{"level":30,"time":1768234947950,"env":"test","module":"mfa-service","userId":"e588cc08a47cf0158dad4cf0c35c3cf9","msg":"TOTP verification successful"}
{"level":30,"time":1768234948007,"env":"test","module":"auth-routes","userId":"e588cc08a47cf0158dad4cf0c35c3cf9","msg":"MFA login successful"}
{"level":30,"time":1768234948172,"env":"test","module":"auth-routes","userId":"e588cc08a47cf0158dad4cf0c35c3cf9","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768234948330,"env":"test","module":"auth-routes","userId":"e588cc08a47cf0158dad4cf0c35c3cf9","deviceCount":0,"msg":"Listed trusted devices"}
{"level":30,"time":1768234950101,"env":"test","module":"auth-routes","userId":"90e3749694693f8071ad0dfd9f490588","msg":"Login requires MFA verification"}
{"level":30,"time":1768234950209,"env":"test","module":"mfa-service","userId":"90e3749694693f8071ad0dfd9f490588","msg":"TOTP verification successful"}
{"level":30,"time":1768234950258,"env":"test","module":"auth-routes","userId":"90e3749694693f8071ad0dfd9f490588","msg":"MFA login successful"}
{"level":30,"time":1768234950418,"env":"test","module":"auth-routes","userId":"90e3749694693f8071ad0dfd9f490588","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768234950531,"env":"test","module":"auth-routes","userId":"90e3749694693f8071ad0dfd9f490588","deviceCount":1,"msg":"Listed trusted devices"}
{"level":30,"time":1768234950698,"env":"test","module":"auth-routes","userId":"90e3749694693f8071ad0dfd9f490588","deviceId":"2bc41c8e-5338-4919-b5a5-01d888286710","msg":"Trusted device revoked"}
{"level":30,"time":1768234950868,"env":"test","module":"auth-routes","userId":"90e3749694693f8071ad0dfd9f490588","deviceCount":0,"msg":"Listed trusted devices"}
{"level":30,"time":1768234952726,"env":"test","module":"auth-routes","userId":"0ad9c09ac2309b639cb54c71d2307fb8","msg":"Login requires MFA verification"}
{"level":30,"time":1768234952830,"env":"test","module":"mfa-service","userId":"0ad9c09ac2309b639cb54c71d2307fb8","msg":"TOTP verification successful"}
{"level":30,"time":1768234952888,"env":"test","module":"auth-routes","userId":"0ad9c09ac2309b639cb54c71d2307fb8","msg":"MFA login successful"}
{"level":30,"time":1768234955775,"env":"test","module":"auth-routes","userId":"067e49658cfb245c79ac703fbef8a2fd","msg":"Login requires MFA verification"}
{"level":30,"time":1768234955887,"env":"test","module":"mfa-service","userId":"067e49658cfb245c79ac703fbef8a2fd","msg":"TOTP verification successful"}
{"level":30,"time":1768234955938,"env":"test","module":"auth-routes","userId":"067e49658cfb245c79ac703fbef8a2fd","msg":"MFA login successful"}
{"level":30,"time":1768234956109,"env":"test","module":"auth-routes","userId":"067e49658cfb245c79ac703fbef8a2fd","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768234956219,"env":"test","module":"auth-routes","userId":"067e49658cfb245c79ac703fbef8a2fd","deviceCount":1,"msg":"Listed trusted devices"}
{"level":30,"time":1768234956783,"env":"test","module":"auth-routes","userId":"1310428a8e075df135b768c5efccb85a","msg":"Login requires MFA verification"}
{"level":30,"time":1768234956898,"env":"test","module":"mfa-service","userId":"1310428a8e075df135b768c5efccb85a","msg":"TOTP verification successful"}
{"level":30,"time":1768234956954,"env":"test","module":"auth-routes","userId":"1310428a8e075df135b768c5efccb85a","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for d72a59ca3f41d8333010e2b768ebebf3

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39m[TEST UTILS] MFA Secret verified for 80103ba57b0566a58f22a6806beff06c

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for 8031a2e728c272e7cfea4d4d7b22260e

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39m[TEST UTILS] MFA Secret verified for ca9610783210f633a5c6cfc0e76453b6

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for e588cc08a47cf0158dad4cf0c35c3cf9

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for 90e3749694693f8071ad0dfd9f490588

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39m[TEST UTILS] MFA Secret verified for 0ad9c09ac2309b639cb54c71d2307fb8

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 067e49658cfb245c79ac703fbef8a2fd

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 1310428a8e075df135b768c5efccb85a

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39m[TEST UTILS] MFA Secret verified for fa88e98558a5fa31c53a71090f179561

{"level":30,"time":1768234958936,"env":"test","module":"auth-routes","userId":"fa88e98558a5fa31c53a71090f179561","msg":"Login requires MFA verification"}
{"level":30,"time":1768234959049,"env":"test","module":"mfa-service","userId":"fa88e98558a5fa31c53a71090f179561","msg":"TOTP verification successful"}
{"level":30,"time":1768234959105,"env":"test","module":"auth-routes","userId":"fa88e98558a5fa31c53a71090f179561","msg":"MFA login successful"}
{"level":30,"time":1768234959277,"env":"test","module":"auth-routes","userId":"fa88e98558a5fa31c53a71090f179561","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768234960003,"env":"test","module":"auth-routes","userId":"fa88e98558a5fa31c53a71090f179561","msg":"Login from trusted device - MFA skipped"}
{"level":30,"time":1768234960054,"env":"test","module":"auth-routes","userId":"fa88e98558a5fa31c53a71090f179561","msg":"User logged in successfully"}
{"level":30,"time":1768234960111,"env":"test","module":"audit-log-service","userId":"fa88e98558a5fa31c53a71090f179561","eventType":"login_success","ipAddress":"192.168.1.100","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39m[TEST UTILS] MFA Secret verified for 19465ebe141bff51d4dd0a5ec0bde447

{"level":30,"time":1768234962135,"env":"test","module":"auth-routes","userId":"19465ebe141bff51d4dd0a5ec0bde447","msg":"Login requires MFA verification"}
{"level":30,"time":1768234962245,"env":"test","module":"mfa-service","userId":"19465ebe141bff51d4dd0a5ec0bde447","msg":"TOTP verification successful"}
{"level":30,"time":1768234962295,"env":"test","module":"auth-routes","userId":"19465ebe141bff51d4dd0a5ec0bde447","msg":"MFA login successful"}
{"level":30,"time":1768234962459,"env":"test","module":"auth-routes","userId":"19465ebe141bff51d4dd0a5ec0bde447","deviceFingerprint":"10fa3aea039bf6fec7b6bcb982cbed1cc6ab844dd3c0879bec32baefb2997b52","msg":"Device marked as trusted"}
{"level":30,"time":1768234963028,"env":"test","module":"auth-routes","userId":"19465ebe141bff51d4dd0a5ec0bde447","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39m[TEST UTILS] MFA Secret verified for 60adba91432ab901f42a114914900177

{"level":30,"time":1768234965019,"env":"test","module":"auth-routes","userId":"60adba91432ab901f42a114914900177","msg":"Login requires MFA verification"}
{"level":30,"time":1768234965135,"env":"test","module":"mfa-service","userId":"60adba91432ab901f42a114914900177","msg":"TOTP verification successful"}
{"level":30,"time":1768234965195,"env":"test","module":"auth-routes","userId":"60adba91432ab901f42a114914900177","msg":"MFA login successful"}
{"level":30,"time":1768234965360,"env":"test","module":"auth-routes","userId":"60adba91432ab901f42a114914900177","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768234966243,"env":"test","module":"auth-routes","userId":"60adba91432ab901f42a114914900177","msg":"Login from trusted device - MFA skipped"}
{"level":30,"time":1768234966298,"env":"test","module":"auth-routes","userId":"60adba91432ab901f42a114914900177","msg":"User logged in successfully"}
{"level":30,"time":1768234966352,"env":"test","module":"audit-log-service","userId":"60adba91432ab901f42a114914900177","eventType":"login_success","ipAddress":"192.168.1.100","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 36385[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should trust current device [33m 2422[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set trust expiry to 30 days [33m 2165[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should update expiry if device already trusted [33m 2349[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 397[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should list all trusted devices [33m 3582[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should mark current device [33m 2179[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should exclude revoked devices [33m 2139[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should exclude expired devices [33m 2195[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke specific device [33m 2538[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 404 for non-existent device [33m 2079[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prevent revoking other user's device [33m 4116[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should skip MFA for trusted device [33m 3049[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require MFA for untrusted device [33m 2916[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should update lastUsedAt on trusted device login [33m 3376[2mms[22m[39m

[2m Test Files [22m [1m[32m1 passed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[32m14 passed[39m[22m[90m (14)[39m
[2m   Start at [22m 10:21:03
[2m   Duration [22m 64.08s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mpackage.json [22m[34mx6 [34m[39m
       [2m Filename pattern: [22m[34mtests/integration/trusted.devices.real.test.ts[39m

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }

{"level":30,"time":1768234969072,"env":"test","msg":"DB: initializing... Neon"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

{"level":30,"time":1768234969357,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768234972258,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for bdd0e51656d56d80ce7fc420de68c780

{"level":30,"time":1768234975006,"env":"test","module":"auth-routes","userId":"bdd0e51656d56d80ce7fc420de68c780","msg":"Login requires MFA verification"}
{"level":30,"time":1768234975129,"env":"test","module":"mfa-service","userId":"bdd0e51656d56d80ce7fc420de68c780","msg":"TOTP verification successful"}
{"level":30,"time":1768234975180,"env":"test","module":"auth-routes","userId":"bdd0e51656d56d80ce7fc420de68c780","msg":"MFA login successful"}
{"level":30,"time":1768234975352,"env":"test","module":"auth-routes","userId":"bdd0e51656d56d80ce7fc420de68c780","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39m[TEST UTILS] MFA Secret verified for 357359552f7725d1c60cc368eacd7e20

{"level":30,"time":1768234977315,"env":"test","module":"auth-routes","userId":"357359552f7725d1c60cc368eacd7e20","msg":"Login requires MFA verification"}
{"level":30,"time":1768234977421,"env":"test","module":"mfa-service","userId":"357359552f7725d1c60cc368eacd7e20","msg":"TOTP verification successful"}
{"level":30,"time":1768234977471,"env":"test","module":"auth-routes","userId":"357359552f7725d1c60cc368eacd7e20","msg":"MFA login successful"}
{"level":30,"time":1768234977644,"env":"test","module":"auth-routes","userId":"357359552f7725d1c60cc368eacd7e20","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for 9142fd8be0793630e5ac6da6cc2f52de

{"level":30,"time":1768234979513,"env":"test","module":"auth-routes","userId":"9142fd8be0793630e5ac6da6cc2f52de","msg":"Login requires MFA verification"}
{"level":30,"time":1768234979633,"env":"test","module":"mfa-service","userId":"9142fd8be0793630e5ac6da6cc2f52de","msg":"TOTP verification successful"}
{"level":30,"time":1768234979688,"env":"test","module":"auth-routes","userId":"9142fd8be0793630e5ac6da6cc2f52de","msg":"MFA login successful"}
{"level":30,"time":1768234979854,"env":"test","module":"auth-routes","userId":"9142fd8be0793630e5ac6da6cc2f52de","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768234980155,"env":"test","module":"auth-routes","userId":"9142fd8be0793630e5ac6da6cc2f52de","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Trusted device expiry updated"}
{"level":50,"time":1768234980620,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39m[TEST UTILS] MFA Secret verified for 122cd35086b0fa0a453b71d739824d68

{"level":30,"time":1768234982535,"env":"test","module":"auth-routes","userId":"122cd35086b0fa0a453b71d739824d68","msg":"Login requires MFA verification"}
{"level":30,"time":1768234982645,"env":"test","module":"mfa-service","userId":"122cd35086b0fa0a453b71d739824d68","msg":"TOTP verification successful"}
{"level":30,"time":1768234982701,"env":"test","module":"auth-routes","userId":"122cd35086b0fa0a453b71d739824d68","msg":"MFA login successful"}
{"level":30,"time":1768234983084,"env":"test","module":"auth-routes","userId":"122cd35086b0fa0a453b71d739824d68","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768234983681,"env":"test","module":"auth-routes","userId":"122cd35086b0fa0a453b71d739824d68","msg":"Login requires MFA verification"}
{"level":30,"time":1768234983791,"env":"test","module":"mfa-service","userId":"122cd35086b0fa0a453b71d739824d68","msg":"TOTP verification successful"}
{"level":30,"time":1768234983845,"env":"test","module":"auth-routes","userId":"122cd35086b0fa0a453b71d739824d68","msg":"MFA login successful"}
{"level":30,"time":1768234984007,"env":"test","module":"auth-routes","userId":"122cd35086b0fa0a453b71d739824d68","deviceFingerprint":"091366faa1882b5c8dc1cba02126615a77a378274bbfd3375e821aa38bdd1b4f","msg":"Device marked as trusted"}
{"level":30,"time":1768234984531,"env":"test","module":"auth-routes","userId":"122cd35086b0fa0a453b71d739824d68","msg":"Login requires MFA verification"}
{"level":30,"time":1768234984638,"env":"test","module":"mfa-service","userId":"122cd35086b0fa0a453b71d739824d68","msg":"TOTP verification successful"}
{"level":30,"time":1768234984689,"env":"test","module":"auth-routes","userId":"122cd35086b0fa0a453b71d739824d68","msg":"MFA login successful"}
{"level":30,"time":1768234984796,"env":"test","module":"auth-routes","userId":"122cd35086b0fa0a453b71d739824d68","deviceCount":2,"msg":"Listed trusted devices"}
{"level":30,"time":1768234986493,"env":"test","module":"auth-routes","userId":"b3c81f974ca07032f25385a51b44df9c","msg":"Login requires MFA verification"}
{"level":30,"time":1768234986599,"env":"test","module":"mfa-service","userId":"b3c81f974ca07032f25385a51b44df9c","msg":"TOTP verification successful"}
{"level":30,"time":1768234986650,"env":"test","module":"auth-routes","userId":"b3c81f974ca07032f25385a51b44df9c","msg":"MFA login successful"}
{"level":30,"time":1768234986810,"env":"test","module":"auth-routes","userId":"b3c81f974ca07032f25385a51b44df9c","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768234986914,"env":"test","module":"auth-routes","userId":"b3c81f974ca07032f25385a51b44df9c","deviceCount":1,"msg":"Listed trusted devices"}
{"level":30,"time":1768234988588,"env":"test","module":"auth-routes","userId":"3df06bf3d1d915ab71e0fc38c790ec2e","msg":"Login requires MFA verification"}
{"level":30,"time":1768234988701,"env":"test","module":"mfa-service","userId":"3df06bf3d1d915ab71e0fc38c790ec2e","msg":"TOTP verification successful"}
{"level":30,"time":1768234988750,"env":"test","module":"auth-routes","userId":"3df06bf3d1d915ab71e0fc38c790ec2e","msg":"MFA login successful"}
{"level":30,"time":1768234988903,"env":"test","module":"auth-routes","userId":"3df06bf3d1d915ab71e0fc38c790ec2e","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768234989063,"env":"test","module":"auth-routes","userId":"3df06bf3d1d915ab71e0fc38c790ec2e","deviceCount":0,"msg":"Listed trusted devices"}
{"level":30,"time":1768234990742,"env":"test","module":"auth-routes","userId":"ce1bc7b92e26d1ed7067535b021c4ba1","msg":"Login requires MFA verification"}
{"level":30,"time":1768234990843,"env":"test","module":"mfa-service","userId":"ce1bc7b92e26d1ed7067535b021c4ba1","msg":"TOTP verification successful"}
{"level":30,"time":1768234990901,"env":"test","module":"auth-routes","userId":"ce1bc7b92e26d1ed7067535b021c4ba1","msg":"MFA login successful"}
{"level":30,"time":1768234991055,"env":"test","module":"auth-routes","userId":"ce1bc7b92e26d1ed7067535b021c4ba1","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768234991215,"env":"test","module":"auth-routes","userId":"ce1bc7b92e26d1ed7067535b021c4ba1","deviceCount":0,"msg":"Listed trusted devices"}
{"level":30,"time":1768234992914,"env":"test","module":"auth-routes","userId":"e049b8d1a3fb0914d12fd3428b449c4b","msg":"Login requires MFA verification"}
{"level":30,"time":1768234993019,"env":"test","module":"mfa-service","userId":"e049b8d1a3fb0914d12fd3428b449c4b","msg":"TOTP verification successful"}
{"level":30,"time":1768234993070,"env":"test","module":"auth-routes","userId":"e049b8d1a3fb0914d12fd3428b449c4b","msg":"MFA login successful"}
{"level":30,"time":1768234993228,"env":"test","module":"auth-routes","userId":"e049b8d1a3fb0914d12fd3428b449c4b","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768234993340,"env":"test","module":"auth-routes","userId":"e049b8d1a3fb0914d12fd3428b449c4b","deviceCount":1,"msg":"Listed trusted devices"}
{"level":30,"time":1768234993495,"env":"test","module":"auth-routes","userId":"e049b8d1a3fb0914d12fd3428b449c4b","deviceId":"003e725f-9b78-4b9f-a466-92724599364b","msg":"Trusted device revoked"}
{"level":30,"time":1768234993648,"env":"test","module":"auth-routes","userId":"e049b8d1a3fb0914d12fd3428b449c4b","deviceCount":0,"msg":"Listed trusted devices"}
{"level":30,"time":1768234995342,"env":"test","module":"auth-routes","userId":"e15a39fd7f3144ea4670812939bed92d","msg":"Login requires MFA verification"}
{"level":30,"time":1768234995452,"env":"test","module":"mfa-service","userId":"e15a39fd7f3144ea4670812939bed92d","msg":"TOTP verification successful"}
{"level":30,"time":1768234995511,"env":"test","module":"auth-routes","userId":"e15a39fd7f3144ea4670812939bed92d","msg":"MFA login successful"}
{"level":30,"time":1768234998097,"env":"test","module":"auth-routes","userId":"8ef3aa430f30e7d5d7d134e4c95b9ef5","msg":"Login requires MFA verification"}
{"level":30,"time":1768234998196,"env":"test","module":"mfa-service","userId":"8ef3aa430f30e7d5d7d134e4c95b9ef5","msg":"TOTP verification successful"}
{"level":30,"time":1768234998247,"env":"test","module":"auth-routes","userId":"8ef3aa430f30e7d5d7d134e4c95b9ef5","msg":"MFA login successful"}
{"level":30,"time":1768234998406,"env":"test","module":"auth-routes","userId":"8ef3aa430f30e7d5d7d134e4c95b9ef5","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768234998517,"env":"test","module":"auth-routes","userId":"8ef3aa430f30e7d5d7d134e4c95b9ef5","deviceCount":1,"msg":"Listed trusted devices"}
{"level":30,"time":1768234999017,"env":"test","module":"auth-routes","userId":"a33ccbeea073e30876999a454e5bab42","msg":"Login requires MFA verification"}
{"level":30,"time":1768234999143,"env":"test","module":"mfa-service","userId":"a33ccbeea073e30876999a454e5bab42","msg":"TOTP verification successful"}
{"level":30,"time":1768234999197,"env":"test","module":"auth-routes","userId":"a33ccbeea073e30876999a454e5bab42","msg":"MFA login successful"}
{"level":30,"time":1768235000973,"env":"test","module":"auth-routes","userId":"c51d9df2ba9cf6a3c29feae13942c3bd","msg":"Login requires MFA verification"}
{"level":30,"time":1768235001089,"env":"test","module":"mfa-service","userId":"c51d9df2ba9cf6a3c29feae13942c3bd","msg":"TOTP verification successful"}
{"level":30,"time":1768235001144,"env":"test","module":"auth-routes","userId":"c51d9df2ba9cf6a3c29feae13942c3bd","msg":"MFA login successful"}
{"level":30,"time":1768235001316,"env":"test","module":"auth-routes","userId":"c51d9df2ba9cf6a3c29feae13942c3bd","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768235001866,"env":"test","module":"auth-routes","userId":"c51d9df2ba9cf6a3c29feae13942c3bd","msg":"Login from trusted device - MFA skipped"}
{"level":30,"time":1768235001925,"env":"test","module":"auth-routes","userId":"c51d9df2ba9cf6a3c29feae13942c3bd","msg":"User logged in successfully"}
{"level":30,"time":1768235001981,"env":"test","module":"audit-log-service","userId":"c51d9df2ba9cf6a3c29feae13942c3bd","eventType":"login_success","ipAddress":"192.168.1.100","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768235003715,"env":"test","module":"auth-routes","userId":"01da0fae087e50cb8b2b947e30526a23","msg":"Login requires MFA verification"}
{"level":30,"time":1768235003827,"env":"test","module":"mfa-service","userId":"01da0fae087e50cb8b2b947e30526a23","msg":"TOTP verification successful"}
{"level":30,"time":1768235003878,"env":"test","module":"auth-routes","userId":"01da0fae087e50cb8b2b947e30526a23","msg":"MFA login successful"}
{"level":30,"time":1768235004036,"env":"test","module":"auth-routes","userId":"01da0fae087e50cb8b2b947e30526a23","deviceFingerprint":"10fa3aea039bf6fec7b6bcb982cbed1cc6ab844dd3c0879bec32baefb2997b52","msg":"Device marked as trusted"}
{"level":30,"time":1768235004564,"env":"test","module":"auth-routes","userId":"01da0fae087e50cb8b2b947e30526a23","msg":"Login requires MFA verification"}
{"level":30,"time":1768235006223,"env":"test","module":"auth-routes","userId":"2d5042276814f02a44200a5efb13e030","msg":"Login requires MFA verification"}
{"level":30,"time":1768235006333,"env":"test","module":"mfa-service","userId":"2d5042276814f02a44200a5efb13e030","msg":"TOTP verification successful"}
{"level":30,"time":1768235006390,"env":"test","module":"auth-routes","userId":"2d5042276814f02a44200a5efb13e030","msg":"MFA login successful"}
{"level":30,"time":1768235006548,"env":"test","module":"auth-routes","userId":"2d5042276814f02a44200a5efb13e030","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768235007260,"env":"test","module":"auth-routes","userId":"2d5042276814f02a44200a5efb13e030","msg":"Login from trusted device - MFA skipped"}
{"level":30,"time":1768235007312,"env":"test","module":"auth-routes","userId":"2d5042276814f02a44200a5efb13e030","msg":"User logged in successfully"}
{"level":30,"time":1768235007365,"env":"test","module":"audit-log-service","userId":"2d5042276814f02a44200a5efb13e030","eventType":"login_success","ipAddress":"192.168.1.100","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for b3c81f974ca07032f25385a51b44df9c

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39m[TEST UTILS] MFA Secret verified for 3df06bf3d1d915ab71e0fc38c790ec2e

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for ce1bc7b92e26d1ed7067535b021c4ba1

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for e049b8d1a3fb0914d12fd3428b449c4b

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39m[TEST UTILS] MFA Secret verified for e15a39fd7f3144ea4670812939bed92d

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 8ef3aa430f30e7d5d7d134e4c95b9ef5

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for a33ccbeea073e30876999a454e5bab42

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39m[TEST UTILS] MFA Secret verified for c51d9df2ba9cf6a3c29feae13942c3bd

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39m[TEST UTILS] MFA Secret verified for 01da0fae087e50cb8b2b947e30526a23

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39m[TEST UTILS] MFA Secret verified for 2d5042276814f02a44200a5efb13e030

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 35130[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should trust current device [33m 2292[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set trust expiry to 30 days [33m 2240[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should update expiry if device already trusted [33m 2560[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 416[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should list all trusted devices [33m 4175[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should mark current device [33m 2118[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should exclude revoked devices [33m 2148[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should exclude expired devices [33m 2153[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke specific device [33m 2433[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 404 for non-existent device [33m 1923[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prevent revoking other user's device [33m 3735[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should skip MFA for trusted device [33m 2674[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require MFA for untrusted device [33m 2583[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should update lastUsedAt on trusted device login [33m 2853[2mms[22m[39m

[2m Test Files [22m [1m[32m1 passed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[32m14 passed[39m[22m[90m (14)[39m
[2m   Start at [22m 10:22:46
[2m   Duration [22m 40.17s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/repositories/WorkflowTemplateRepository.ts [22m[34mx7 [34m[39m
       [2m Filename pattern: [22m[34mtests/integration/trusted.devices.real.test.ts[39m

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

{"level":30,"time":1768235019513,"env":"test","msg":"DB: initializing... Neon"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¹Ã©âˆ©â••Ã… backup and recover secrets: https://dotenvx.com/ops

{"level":30,"time":1768235019795,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768235022648,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for 707209edd964a46902c6882bb65f164c

{"level":30,"time":1768235025568,"env":"test","module":"auth-routes","userId":"707209edd964a46902c6882bb65f164c","msg":"Login requires MFA verification"}
{"level":30,"time":1768235025686,"env":"test","module":"mfa-service","userId":"707209edd964a46902c6882bb65f164c","msg":"TOTP verification successful"}
{"level":30,"time":1768235025745,"env":"test","module":"auth-routes","userId":"707209edd964a46902c6882bb65f164c","msg":"MFA login successful"}
{"level":30,"time":1768235025922,"env":"test","module":"auth-routes","userId":"707209edd964a46902c6882bb65f164c","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39m[TEST UTILS] MFA Secret verified for b3d042c7eeaf5b86bf4a14feb2e9aa53

{"level":30,"time":1768235027875,"env":"test","module":"auth-routes","userId":"b3d042c7eeaf5b86bf4a14feb2e9aa53","msg":"Login requires MFA verification"}
{"level":30,"time":1768235027984,"env":"test","module":"mfa-service","userId":"b3d042c7eeaf5b86bf4a14feb2e9aa53","msg":"TOTP verification successful"}
{"level":30,"time":1768235028036,"env":"test","module":"auth-routes","userId":"b3d042c7eeaf5b86bf4a14feb2e9aa53","msg":"MFA login successful"}
{"level":30,"time":1768235028217,"env":"test","module":"auth-routes","userId":"b3d042c7eeaf5b86bf4a14feb2e9aa53","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for ea05734bbec28b850dd5c773c71bb9eb

{"level":30,"time":1768235030152,"env":"test","module":"auth-routes","userId":"ea05734bbec28b850dd5c773c71bb9eb","msg":"Login requires MFA verification"}
{"level":30,"time":1768235030263,"env":"test","module":"mfa-service","userId":"ea05734bbec28b850dd5c773c71bb9eb","msg":"TOTP verification successful"}
{"level":30,"time":1768235030314,"env":"test","module":"auth-routes","userId":"ea05734bbec28b850dd5c773c71bb9eb","msg":"MFA login successful"}
{"level":30,"time":1768235030476,"env":"test","module":"auth-routes","userId":"ea05734bbec28b850dd5c773c71bb9eb","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768235030749,"env":"test","module":"auth-routes","userId":"ea05734bbec28b850dd5c773c71bb9eb","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Trusted device expiry updated"}
{"level":50,"time":1768235031206,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39m[TEST UTILS] MFA Secret verified for 2324c1f78131cf7d46723f2c415e2108

{"level":30,"time":1768235033046,"env":"test","module":"auth-routes","userId":"2324c1f78131cf7d46723f2c415e2108","msg":"Login requires MFA verification"}
{"level":30,"time":1768235033150,"env":"test","module":"mfa-service","userId":"2324c1f78131cf7d46723f2c415e2108","msg":"TOTP verification successful"}
{"level":30,"time":1768235033208,"env":"test","module":"auth-routes","userId":"2324c1f78131cf7d46723f2c415e2108","msg":"MFA login successful"}
{"level":30,"time":1768235033370,"env":"test","module":"auth-routes","userId":"2324c1f78131cf7d46723f2c415e2108","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768235033922,"env":"test","module":"auth-routes","userId":"2324c1f78131cf7d46723f2c415e2108","msg":"Login requires MFA verification"}
{"level":30,"time":1768235034033,"env":"test","module":"mfa-service","userId":"2324c1f78131cf7d46723f2c415e2108","msg":"TOTP verification successful"}
{"level":30,"time":1768235034086,"env":"test","module":"auth-routes","userId":"2324c1f78131cf7d46723f2c415e2108","msg":"MFA login successful"}
{"level":30,"time":1768235034388,"env":"test","module":"auth-routes","userId":"2324c1f78131cf7d46723f2c415e2108","deviceFingerprint":"091366faa1882b5c8dc1cba02126615a77a378274bbfd3375e821aa38bdd1b4f","msg":"Device marked as trusted"}
{"level":30,"time":1768235034997,"env":"test","module":"auth-routes","userId":"2324c1f78131cf7d46723f2c415e2108","msg":"Login requires MFA verification"}
{"level":30,"time":1768235035107,"env":"test","module":"mfa-service","userId":"2324c1f78131cf7d46723f2c415e2108","msg":"TOTP verification successful"}
{"level":30,"time":1768235035159,"env":"test","module":"auth-routes","userId":"2324c1f78131cf7d46723f2c415e2108","msg":"MFA login successful"}
{"level":30,"time":1768235035274,"env":"test","module":"auth-routes","userId":"2324c1f78131cf7d46723f2c415e2108","deviceCount":2,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for 913a6d3a5881bd6e77359489d5954a65

{"level":30,"time":1768235037246,"env":"test","module":"auth-routes","userId":"913a6d3a5881bd6e77359489d5954a65","msg":"Login requires MFA verification"}
{"level":30,"time":1768235037359,"env":"test","module":"mfa-service","userId":"913a6d3a5881bd6e77359489d5954a65","msg":"TOTP verification successful"}
{"level":30,"time":1768235037413,"env":"test","module":"auth-routes","userId":"913a6d3a5881bd6e77359489d5954a65","msg":"MFA login successful"}
{"level":30,"time":1768235037576,"env":"test","module":"auth-routes","userId":"913a6d3a5881bd6e77359489d5954a65","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768235037687,"env":"test","module":"auth-routes","userId":"913a6d3a5881bd6e77359489d5954a65","deviceCount":1,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39m[TEST UTILS] MFA Secret verified for a974bf93b831a177dd8178a6c3100668

{"level":30,"time":1768235039584,"env":"test","module":"auth-routes","userId":"a974bf93b831a177dd8178a6c3100668","msg":"Login requires MFA verification"}
{"level":30,"time":1768235039693,"env":"test","module":"mfa-service","userId":"a974bf93b831a177dd8178a6c3100668","msg":"TOTP verification successful"}
{"level":30,"time":1768235039745,"env":"test","module":"auth-routes","userId":"a974bf93b831a177dd8178a6c3100668","msg":"MFA login successful"}
{"level":30,"time":1768235039906,"env":"test","module":"auth-routes","userId":"a974bf93b831a177dd8178a6c3100668","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768235040067,"env":"test","module":"auth-routes","userId":"a974bf93b831a177dd8178a6c3100668","deviceCount":0,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for 8a5158ab9675d3857c2bccebd71db1b2

{"level":30,"time":1768235041866,"env":"test","module":"auth-routes","userId":"8a5158ab9675d3857c2bccebd71db1b2","msg":"Login requires MFA verification"}
{"level":30,"time":1768235041975,"env":"test","module":"mfa-service","userId":"8a5158ab9675d3857c2bccebd71db1b2","msg":"TOTP verification successful"}
{"level":30,"time":1768235042026,"env":"test","module":"auth-routes","userId":"8a5158ab9675d3857c2bccebd71db1b2","msg":"MFA login successful"}
{"level":30,"time":1768235042189,"env":"test","module":"auth-routes","userId":"8a5158ab9675d3857c2bccebd71db1b2","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768235042357,"env":"test","module":"auth-routes","userId":"8a5158ab9675d3857c2bccebd71db1b2","deviceCount":0,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for 01446cfcae866caa010db32389040762

{"level":30,"time":1768235044200,"env":"test","module":"auth-routes","userId":"01446cfcae866caa010db32389040762","msg":"Login requires MFA verification"}
{"level":30,"time":1768235044307,"env":"test","module":"mfa-service","userId":"01446cfcae866caa010db32389040762","msg":"TOTP verification successful"}
{"level":30,"time":1768235044360,"env":"test","module":"auth-routes","userId":"01446cfcae866caa010db32389040762","msg":"MFA login successful"}
{"level":30,"time":1768235044526,"env":"test","module":"auth-routes","userId":"01446cfcae866caa010db32389040762","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768235044631,"env":"test","module":"auth-routes","userId":"01446cfcae866caa010db32389040762","deviceCount":1,"msg":"Listed trusted devices"}
{"level":30,"time":1768235044793,"env":"test","module":"auth-routes","userId":"01446cfcae866caa010db32389040762","deviceId":"3c5e62aa-c53b-42db-9980-3a38aa66d92c","msg":"Trusted device revoked"}
{"level":30,"time":1768235044956,"env":"test","module":"auth-routes","userId":"01446cfcae866caa010db32389040762","deviceCount":0,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39m[TEST UTILS] MFA Secret verified for 16767c00184dc8fc45b6ef9db6745545

{"level":30,"time":1768235046757,"env":"test","module":"auth-routes","userId":"16767c00184dc8fc45b6ef9db6745545","msg":"Login requires MFA verification"}
{"level":30,"time":1768235046867,"env":"test","module":"mfa-service","userId":"16767c00184dc8fc45b6ef9db6745545","msg":"TOTP verification successful"}
{"level":30,"time":1768235046919,"env":"test","module":"auth-routes","userId":"16767c00184dc8fc45b6ef9db6745545","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 0edaaf1b9b5465c30706418c7afcfb2d

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 8e7283880e520e9d05422dd28e7b0f74

{"level":30,"time":1768235049793,"env":"test","module":"auth-routes","userId":"0edaaf1b9b5465c30706418c7afcfb2d","msg":"Login requires MFA verification"}
{"level":30,"time":1768235049899,"env":"test","module":"mfa-service","userId":"0edaaf1b9b5465c30706418c7afcfb2d","msg":"TOTP verification successful"}
{"level":30,"time":1768235049953,"env":"test","module":"auth-routes","userId":"0edaaf1b9b5465c30706418c7afcfb2d","msg":"MFA login successful"}
{"level":30,"time":1768235050118,"env":"test","module":"auth-routes","userId":"0edaaf1b9b5465c30706418c7afcfb2d","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768235050222,"env":"test","module":"auth-routes","userId":"0edaaf1b9b5465c30706418c7afcfb2d","deviceCount":1,"msg":"Listed trusted devices"}
{"level":30,"time":1768235050759,"env":"test","module":"auth-routes","userId":"8e7283880e520e9d05422dd28e7b0f74","msg":"Login requires MFA verification"}
{"level":30,"time":1768235050869,"env":"test","module":"mfa-service","userId":"8e7283880e520e9d05422dd28e7b0f74","msg":"TOTP verification successful"}
{"level":30,"time":1768235050925,"env":"test","module":"auth-routes","userId":"8e7283880e520e9d05422dd28e7b0f74","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39m[TEST UTILS] MFA Secret verified for 5bdb446d5575449c0eec2760e4bfaa7e

{"level":30,"time":1768235052958,"env":"test","module":"auth-routes","userId":"5bdb446d5575449c0eec2760e4bfaa7e","msg":"Login requires MFA verification"}
{"level":30,"time":1768235053062,"env":"test","module":"mfa-service","userId":"5bdb446d5575449c0eec2760e4bfaa7e","msg":"TOTP verification successful"}
{"level":30,"time":1768235053112,"env":"test","module":"auth-routes","userId":"5bdb446d5575449c0eec2760e4bfaa7e","msg":"MFA login successful"}
{"level":30,"time":1768235053269,"env":"test","module":"auth-routes","userId":"5bdb446d5575449c0eec2760e4bfaa7e","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768235053867,"env":"test","module":"auth-routes","userId":"5bdb446d5575449c0eec2760e4bfaa7e","msg":"Login from trusted device - MFA skipped"}
{"level":30,"time":1768235053921,"env":"test","module":"auth-routes","userId":"5bdb446d5575449c0eec2760e4bfaa7e","msg":"User logged in successfully"}
{"level":30,"time":1768235053975,"env":"test","module":"audit-log-service","userId":"5bdb446d5575449c0eec2760e4bfaa7e","eventType":"login_success","ipAddress":"192.168.1.100","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39m[TEST UTILS] MFA Secret verified for 050587e0289bc8fef6502468b5ea2965

{"level":30,"time":1768235055812,"env":"test","module":"auth-routes","userId":"050587e0289bc8fef6502468b5ea2965","msg":"Login requires MFA verification"}
{"level":30,"time":1768235055921,"env":"test","module":"mfa-service","userId":"050587e0289bc8fef6502468b5ea2965","msg":"TOTP verification successful"}
{"level":30,"time":1768235055972,"env":"test","module":"auth-routes","userId":"050587e0289bc8fef6502468b5ea2965","msg":"MFA login successful"}
{"level":30,"time":1768235056130,"env":"test","module":"auth-routes","userId":"050587e0289bc8fef6502468b5ea2965","deviceFingerprint":"10fa3aea039bf6fec7b6bcb982cbed1cc6ab844dd3c0879bec32baefb2997b52","msg":"Device marked as trusted"}
{"level":30,"time":1768235056783,"env":"test","module":"auth-routes","userId":"050587e0289bc8fef6502468b5ea2965","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39m[TEST UTILS] MFA Secret verified for 503e0842ee3e0482e2874c7e52382ddd

{"level":30,"time":1768235058657,"env":"test","module":"auth-routes","userId":"503e0842ee3e0482e2874c7e52382ddd","msg":"Login requires MFA verification"}
{"level":30,"time":1768235058764,"env":"test","module":"mfa-service","userId":"503e0842ee3e0482e2874c7e52382ddd","msg":"TOTP verification successful"}
{"level":30,"time":1768235058819,"env":"test","module":"auth-routes","userId":"503e0842ee3e0482e2874c7e52382ddd","msg":"MFA login successful"}
{"level":30,"time":1768235058975,"env":"test","module":"auth-routes","userId":"503e0842ee3e0482e2874c7e52382ddd","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768235059700,"env":"test","module":"auth-routes","userId":"503e0842ee3e0482e2874c7e52382ddd","msg":"Login from trusted device - MFA skipped"}
{"level":30,"time":1768235059753,"env":"test","module":"auth-routes","userId":"503e0842ee3e0482e2874c7e52382ddd","msg":"User logged in successfully"}
{"level":30,"time":1768235059807,"env":"test","module":"audit-log-service","userId":"503e0842ee3e0482e2874c7e52382ddd","eventType":"login_success","ipAddress":"192.168.1.100","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [32mÎ“Â£Ã´[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m)[22m[33m 37182[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should trust current device [33m 2385[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set trust expiry to 30 days [33m 2218[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should update expiry if device already trusted [33m 2581[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 407[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should list all trusted devices [33m 4068[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should mark current device [33m 2411[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should exclude revoked devices [33m 2379[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should exclude expired devices [33m 2291[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke specific device [33m 2598[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 404 for non-existent device [33m 2023[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prevent revoking other user's device [33m 4056[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should skip MFA for trusted device [33m 2941[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require MFA for untrusted device [33m 2807[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should update lastUsedAt on trusted device login [33m 3078[2mms[22m[39m

[2m Test Files [22m [1m[32m1 passed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[32m14 passed[39m[22m[90m (14)[39m
[2m   Start at [22m 10:23:36
[2m   Duration [22m 42.07s

[1m[42m PASS [49m[22m [32mWaiting for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mpackage.json [22m[34mx8 [34m[39m
       [2m Filename pattern: [22m[34mtests/integration/trusted.devices.real.test.ts[39m

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768237865341,"env":"test","msg":"DB: initializing... Neon"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

{"level":30,"time":1768237865572,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768237869465,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for 26db35b7c3a5a71daa440358bdb9fb1a

{"level":30,"time":1768237872345,"env":"test","module":"auth-routes","userId":"26db35b7c3a5a71daa440358bdb9fb1a","msg":"Login requires MFA verification"}
{"level":30,"time":1768237872474,"env":"test","module":"mfa-service","userId":"26db35b7c3a5a71daa440358bdb9fb1a","msg":"TOTP verification successful"}
{"level":30,"time":1768237872533,"env":"test","module":"auth-routes","userId":"26db35b7c3a5a71daa440358bdb9fb1a","msg":"MFA login successful"}
{"level":30,"time":1768237872721,"env":"test","module":"auth-routes","userId":"26db35b7c3a5a71daa440358bdb9fb1a","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39m[TEST UTILS] MFA Secret verified for 73170b11c69e792a4211fcf6e6f75d37

{"level":30,"time":1768237874744,"env":"test","module":"auth-routes","userId":"73170b11c69e792a4211fcf6e6f75d37","msg":"Login requires MFA verification"}
{"level":30,"time":1768237874868,"env":"test","module":"mfa-service","userId":"73170b11c69e792a4211fcf6e6f75d37","msg":"TOTP verification successful"}
{"level":30,"time":1768237874936,"env":"test","module":"auth-routes","userId":"73170b11c69e792a4211fcf6e6f75d37","msg":"MFA login successful"}
{"level":30,"time":1768237875129,"env":"test","module":"auth-routes","userId":"73170b11c69e792a4211fcf6e6f75d37","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for d8b584db29a0b0baa6900d9bf1a2e518

{"level":30,"time":1768237877112,"env":"test","module":"auth-routes","userId":"d8b584db29a0b0baa6900d9bf1a2e518","msg":"Login requires MFA verification"}
{"level":30,"time":1768237877227,"env":"test","module":"mfa-service","userId":"d8b584db29a0b0baa6900d9bf1a2e518","msg":"TOTP verification successful"}
{"level":30,"time":1768237877284,"env":"test","module":"auth-routes","userId":"d8b584db29a0b0baa6900d9bf1a2e518","msg":"MFA login successful"}
{"level":30,"time":1768237877452,"env":"test","module":"auth-routes","userId":"d8b584db29a0b0baa6900d9bf1a2e518","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768237877772,"env":"test","module":"auth-routes","userId":"d8b584db29a0b0baa6900d9bf1a2e518","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Trusted device expiry updated"}
{"level":50,"time":1768237878263,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39m[TEST UTILS] MFA Secret verified for 90abb4a7ef3afc04171ae295f1e20857

{"level":30,"time":1768237880261,"env":"test","module":"auth-routes","userId":"90abb4a7ef3afc04171ae295f1e20857","msg":"Login requires MFA verification"}
{"level":30,"time":1768237880372,"env":"test","module":"mfa-service","userId":"90abb4a7ef3afc04171ae295f1e20857","msg":"TOTP verification successful"}
{"level":30,"time":1768237880427,"env":"test","module":"auth-routes","userId":"90abb4a7ef3afc04171ae295f1e20857","msg":"MFA login successful"}
{"level":30,"time":1768237880595,"env":"test","module":"auth-routes","userId":"90abb4a7ef3afc04171ae295f1e20857","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768237881195,"env":"test","module":"auth-routes","userId":"90abb4a7ef3afc04171ae295f1e20857","msg":"Login requires MFA verification"}
{"level":30,"time":1768237881323,"env":"test","module":"mfa-service","userId":"90abb4a7ef3afc04171ae295f1e20857","msg":"TOTP verification successful"}
{"level":30,"time":1768237881379,"env":"test","module":"auth-routes","userId":"90abb4a7ef3afc04171ae295f1e20857","msg":"MFA login successful"}
{"level":30,"time":1768237881554,"env":"test","module":"auth-routes","userId":"90abb4a7ef3afc04171ae295f1e20857","deviceFingerprint":"091366faa1882b5c8dc1cba02126615a77a378274bbfd3375e821aa38bdd1b4f","msg":"Device marked as trusted"}
{"level":30,"time":1768237882299,"env":"test","module":"auth-routes","userId":"90abb4a7ef3afc04171ae295f1e20857","msg":"Login requires MFA verification"}
{"level":30,"time":1768237882412,"env":"test","module":"mfa-service","userId":"90abb4a7ef3afc04171ae295f1e20857","msg":"TOTP verification successful"}
{"level":30,"time":1768237882466,"env":"test","module":"auth-routes","userId":"90abb4a7ef3afc04171ae295f1e20857","msg":"MFA login successful"}
{"level":30,"time":1768237882581,"env":"test","module":"auth-routes","userId":"90abb4a7ef3afc04171ae295f1e20857","deviceCount":2,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for 2239c97ba0031423332c28950cc67ee4

{"level":30,"time":1768237884672,"env":"test","module":"auth-routes","userId":"2239c97ba0031423332c28950cc67ee4","msg":"Login requires MFA verification"}
{"level":30,"time":1768237884790,"env":"test","module":"mfa-service","userId":"2239c97ba0031423332c28950cc67ee4","msg":"TOTP verification successful"}
{"level":30,"time":1768237884842,"env":"test","module":"auth-routes","userId":"2239c97ba0031423332c28950cc67ee4","msg":"MFA login successful"}
{"level":30,"time":1768237885013,"env":"test","module":"auth-routes","userId":"2239c97ba0031423332c28950cc67ee4","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768237885128,"env":"test","module":"auth-routes","userId":"2239c97ba0031423332c28950cc67ee4","deviceCount":1,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39m[TEST UTILS] MFA Secret verified for 3e286ec9e5b1fa650025a71dd06f3696

{"level":30,"time":1768237887365,"env":"test","module":"auth-routes","userId":"3e286ec9e5b1fa650025a71dd06f3696","msg":"Login requires MFA verification"}
{"level":30,"time":1768237887481,"env":"test","module":"mfa-service","userId":"3e286ec9e5b1fa650025a71dd06f3696","msg":"TOTP verification successful"}
{"level":30,"time":1768237887543,"env":"test","module":"auth-routes","userId":"3e286ec9e5b1fa650025a71dd06f3696","msg":"MFA login successful"}
{"level":30,"time":1768237887713,"env":"test","module":"auth-routes","userId":"3e286ec9e5b1fa650025a71dd06f3696","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768237887873,"env":"test","module":"auth-routes","userId":"3e286ec9e5b1fa650025a71dd06f3696","deviceCount":0,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for d85164fe4c5e52374c14b6dc0ff4a269

{"level":30,"time":1768237889844,"env":"test","module":"auth-routes","userId":"d85164fe4c5e52374c14b6dc0ff4a269","msg":"Login requires MFA verification"}
{"level":30,"time":1768237889957,"env":"test","module":"mfa-service","userId":"d85164fe4c5e52374c14b6dc0ff4a269","msg":"TOTP verification successful"}
{"level":30,"time":1768237890016,"env":"test","module":"auth-routes","userId":"d85164fe4c5e52374c14b6dc0ff4a269","msg":"MFA login successful"}
{"level":30,"time":1768237890180,"env":"test","module":"auth-routes","userId":"d85164fe4c5e52374c14b6dc0ff4a269","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768237890340,"env":"test","module":"auth-routes","userId":"d85164fe4c5e52374c14b6dc0ff4a269","deviceCount":0,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for 68af635b5b0488e5f07bf29db5a17267

{"level":50,"time":1768237892084,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768237892199,"env":"test","module":"mfa-service","userId":"68af635b5b0488e5f07bf29db5a17267","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768237892199,"env":"test","module":"auth-routes","userId":"68af635b5b0488e5f07bf29db5a17267","msg":"MFA verification failed during login"}
{"level":50,"time":1768237892204,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768237892209,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39m[TEST UTILS] MFA Secret verified for e98462c32e265990e874aa7765bedec1

{"level":30,"time":1768237894171,"env":"test","module":"auth-routes","userId":"e98462c32e265990e874aa7765bedec1","msg":"Login requires MFA verification"}
{"level":30,"time":1768237894283,"env":"test","module":"mfa-service","userId":"e98462c32e265990e874aa7765bedec1","msg":"TOTP verification successful"}
{"level":30,"time":1768237894340,"env":"test","module":"auth-routes","userId":"e98462c32e265990e874aa7765bedec1","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 303ae12dd8452d91e6b1be638124593b

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 406eb5f6356d333652998e2fd5b45954

{"level":30,"time":1768237897377,"env":"test","module":"auth-routes","userId":"303ae12dd8452d91e6b1be638124593b","msg":"Login requires MFA verification"}
{"level":30,"time":1768237897495,"env":"test","module":"mfa-service","userId":"303ae12dd8452d91e6b1be638124593b","msg":"TOTP verification successful"}
{"level":30,"time":1768237897548,"env":"test","module":"auth-routes","userId":"303ae12dd8452d91e6b1be638124593b","msg":"MFA login successful"}
{"level":30,"time":1768237897723,"env":"test","module":"auth-routes","userId":"303ae12dd8452d91e6b1be638124593b","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768237897835,"env":"test","module":"auth-routes","userId":"303ae12dd8452d91e6b1be638124593b","deviceCount":1,"msg":"Listed trusted devices"}
{"level":50,"time":1768237898098,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should prevent revoking other user's device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768237898218,"env":"test","module":"mfa-service","userId":"406eb5f6356d333652998e2fd5b45954","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768237898218,"env":"test","module":"auth-routes","userId":"406eb5f6356d333652998e2fd5b45954","msg":"MFA verification failed during login"}
{"level":50,"time":1768237898228,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39m[TEST UTILS] MFA Secret verified for fcf92bb3af9d35d56fbbbbf231fc36fd

{"level":30,"time":1768237900217,"env":"test","module":"auth-routes","userId":"fcf92bb3af9d35d56fbbbbf231fc36fd","msg":"Login requires MFA verification"}
{"level":30,"time":1768237900332,"env":"test","module":"mfa-service","userId":"fcf92bb3af9d35d56fbbbbf231fc36fd","msg":"TOTP verification successful"}
{"level":30,"time":1768237900387,"env":"test","module":"auth-routes","userId":"fcf92bb3af9d35d56fbbbbf231fc36fd","msg":"MFA login successful"}
{"level":30,"time":1768237900555,"env":"test","module":"auth-routes","userId":"fcf92bb3af9d35d56fbbbbf231fc36fd","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768237901289,"env":"test","module":"auth-routes","userId":"fcf92bb3af9d35d56fbbbbf231fc36fd","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39m[TEST UTILS] MFA Secret verified for 5d03ffe494a1e59c1b377559b35db4d6

{"level":30,"time":1768237903315,"env":"test","module":"auth-routes","userId":"5d03ffe494a1e59c1b377559b35db4d6","msg":"Login requires MFA verification"}
{"level":40,"time":1768237903444,"env":"test","module":"mfa-service","userId":"5d03ffe494a1e59c1b377559b35db4d6","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768237903444,"env":"test","module":"auth-routes","userId":"5d03ffe494a1e59c1b377559b35db4d6","msg":"MFA verification failed during login"}
{"level":50,"time":1768237903449,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768237903728,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39m[TEST UTILS] MFA Secret verified for 0bb9c740bb2c15d4dc5615f445268b03

{"level":30,"time":1768237905836,"env":"test","module":"auth-routes","userId":"0bb9c740bb2c15d4dc5615f445268b03","msg":"Login requires MFA verification"}
{"level":30,"time":1768237905951,"env":"test","module":"mfa-service","userId":"0bb9c740bb2c15d4dc5615f445268b03","msg":"TOTP verification successful"}
{"level":30,"time":1768237906003,"env":"test","module":"auth-routes","userId":"0bb9c740bb2c15d4dc5615f445268b03","msg":"MFA login successful"}
{"level":30,"time":1768237906180,"env":"test","module":"auth-routes","userId":"0bb9c740bb2c15d4dc5615f445268b03","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768237906905,"env":"test","module":"auth-routes","userId":"0bb9c740bb2c15d4dc5615f445268b03","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m5 failed[39m[2m)[22m[33m 37469[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should trust current device [33m 2491[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should set trust expiry to 30 days [33m 2346[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should update expiry if device already trusted [33m 2705[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 429[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should list all trusted devices [33m 4318[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should mark current device [33m 2545[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should exclude revoked devices [33m 2746[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should exclude expired devices [33m 2467[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific device[39m[33m 1871[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 404 for non-existent device [33m 2189[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent revoking other user's device[39m[33m 3833[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should skip MFA for trusted device[39m[33m 3057[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should require MFA for untrusted device[39m[33m 2439[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update lastUsedAt on trusted device login[39m[33m 3236[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 5 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:332:45
    330|         .set("Authorization", `Bearer ${token}`);
    331| 
    332|       const deviceId = devicesResponse.body.devices[0].id;
       |                                             ^
    333| 
    334|       // Revoke device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/5]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should prevent revoking other user's device
AssertionError: expected 401 to be 404 // Object.is equality

- Expected
+ Received

- 404
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:416:37
    414|         .set("Authorization", `Bearer ${mfaLogin2.body.token}`);
    415| 
    416|       expect(revokeResponse.status).toBe(404);
       |                                     ^
    417|     });
    418|   });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/5]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
AssertionError: expected true to be undefined

- Expected: 
undefined

+ Received: 
true

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:454:52
    452|       // Should not require MFA
    453|       expect(secondLoginResponse.status).toBe(200);
    454|       expect(secondLoginResponse.body.requiresMfa).toBeUndefined();
       |                                                    ^
    455|       expect(secondLoginResponse.body.token).toBeDefined();
    456|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/5]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
AssertionError: expected undefined to be true // Object.is equality

- Expected: 
true

+ Received: 
undefined

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:485:51
    483| 
    484|       // Should require MFA
    485|       expect(loginFromNewDevice.body.requiresMfa).toBe(true);
       |                                                   ^
    486|     });
    487| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/5]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should update lastUsedAt on trusted device login
TypeError: Cannot read properties of undefined (reading 'lastUsedAt')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:528:39
    526|       });
    527| 
    528|       const secondLastUsed = device2!.lastUsedAt;
       |                                       ^
    529| 
    530|       // lastUsedAt should be updated

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/5]Î“Ã„Â»


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m5 failed[39m[22m[2m | [22m[1m[32m9 passed[39m[22m[90m (14)[39m
[2m   Start at [22m 11:10:52
[2m   Duration [22m 46.35s

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mserver/db.ts [22m[34mx9 [34m[39m
       [2m Filename pattern: [22m[34mtests/integration/trusted.devices.real.test.ts[39m

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

{"level":30,"time":1768238206923,"env":"test","msg":"DB: initializing... Neon"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  load multiple .env files with { path: ['.env.local', '.env'] }

{"level":30,"time":1768238207220,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768238212545,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for 706a533613a8a0832eaca7f60d296be6

{"level":30,"time":1768238215414,"env":"test","module":"auth-routes","userId":"706a533613a8a0832eaca7f60d296be6","msg":"Login requires MFA verification"}
{"level":40,"time":1768238215545,"env":"test","module":"mfa-service","userId":"706a533613a8a0832eaca7f60d296be6","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768238215545,"env":"test","module":"auth-routes","userId":"706a533613a8a0832eaca7f60d296be6","msg":"MFA verification failed during login"}
{"level":50,"time":1768238215553,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39m[TEST UTILS] MFA Secret verified for fffac628947383b0223b2a26fefcdeb4

{"level":30,"time":1768238217419,"env":"test","module":"auth-routes","userId":"fffac628947383b0223b2a26fefcdeb4","msg":"Login requires MFA verification"}
{"level":40,"time":1768238217534,"env":"test","module":"mfa-service","userId":"fffac628947383b0223b2a26fefcdeb4","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768238217534,"env":"test","module":"auth-routes","userId":"fffac628947383b0223b2a26fefcdeb4","msg":"MFA verification failed during login"}
{"level":50,"time":1768238217541,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for e3e85b114a9506b93560b6c41b6037ce

{"level":50,"time":1768238219220,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should update expiry if device already trusted
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768238219337,"env":"test","module":"mfa-service","userId":"e3e85b114a9506b93560b6c41b6037ce","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768238219337,"env":"test","module":"auth-routes","userId":"e3e85b114a9506b93560b6c41b6037ce","msg":"MFA verification failed during login"}
{"level":50,"time":1768238219343,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768238219451,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768238219883,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39m[TEST UTILS] MFA Secret verified for 4c20addb09fd96aec39855eec6f73122

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768238221412,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768238221538,"env":"test","module":"mfa-service","userId":"4c20addb09fd96aec39855eec6f73122","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768238221538,"env":"test","module":"auth-routes","userId":"4c20addb09fd96aec39855eec6f73122","msg":"MFA verification failed during login"}
{"level":50,"time":1768238221544,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768238221821,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768238221936,"env":"test","module":"mfa-service","userId":"4c20addb09fd96aec39855eec6f73122","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768238221936,"env":"test","module":"auth-routes","userId":"4c20addb09fd96aec39855eec6f73122","msg":"MFA verification failed during login"}
{"level":50,"time":1768238221941,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768238222215,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768238222324,"env":"test","module":"mfa-service","userId":"4c20addb09fd96aec39855eec6f73122","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768238222324,"env":"test","module":"auth-routes","userId":"4c20addb09fd96aec39855eec6f73122","msg":"MFA verification failed during login"}
{"level":50,"time":1768238222329,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for a418f91d58d20b6fd8a349e59a6148d9

{"level":50,"time":1768238224060,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should mark current device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768238224170,"env":"test","module":"mfa-service","userId":"a418f91d58d20b6fd8a349e59a6148d9","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768238224170,"env":"test","module":"auth-routes","userId":"a418f91d58d20b6fd8a349e59a6148d9","msg":"MFA verification failed during login"}
{"level":50,"time":1768238224175,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768238224180,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39m[TEST UTILS] MFA Secret verified for 8790fb52f63ea67d5ebc19a6bddfd9d6

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude revoked devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":50,"time":1768238225876,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768238225991,"env":"test","module":"mfa-service","userId":"8790fb52f63ea67d5ebc19a6bddfd9d6","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768238225991,"env":"test","module":"auth-routes","userId":"8790fb52f63ea67d5ebc19a6bddfd9d6","msg":"MFA verification failed during login"}
{"level":50,"time":1768238225996,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768238226053,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for 17a8b652549a3367dae6733043e12540

{"level":30,"time":1768238228079,"env":"test","module":"auth-routes","userId":"17a8b652549a3367dae6733043e12540","msg":"Login requires MFA verification"}
{"level":40,"time":1768238228188,"env":"test","module":"mfa-service","userId":"17a8b652549a3367dae6733043e12540","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768238228188,"env":"test","module":"auth-routes","userId":"17a8b652549a3367dae6733043e12540","msg":"MFA verification failed during login"}
{"level":50,"time":1768238228193,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768238228250,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39m[TEST UTILS] MFA Secret verified for 20b67ca1dfdd9d41ebf6b08f4e156108

{"level":30,"time":1768238231108,"env":"test","module":"auth-routes","userId":"20b67ca1dfdd9d41ebf6b08f4e156108","msg":"Login requires MFA verification"}
{"level":30,"time":1768238231215,"env":"test","module":"mfa-service","userId":"20b67ca1dfdd9d41ebf6b08f4e156108","msg":"TOTP verification successful"}
{"level":30,"time":1768238231268,"env":"test","module":"auth-routes","userId":"20b67ca1dfdd9d41ebf6b08f4e156108","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 1004ec6f5eaae5b51016e32d375d6525

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for f8114b329802407459d9265ee7b59978

{"level":30,"time":1768238234008,"env":"test","module":"auth-routes","userId":"1004ec6f5eaae5b51016e32d375d6525","msg":"Login requires MFA verification"}
{"level":30,"time":1768238234119,"env":"test","module":"mfa-service","userId":"1004ec6f5eaae5b51016e32d375d6525","msg":"TOTP verification successful"}
{"level":30,"time":1768238234170,"env":"test","module":"auth-routes","userId":"1004ec6f5eaae5b51016e32d375d6525","msg":"MFA login successful"}
{"level":30,"time":1768238234356,"env":"test","module":"auth-routes","userId":"1004ec6f5eaae5b51016e32d375d6525","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768238234469,"env":"test","module":"auth-routes","userId":"1004ec6f5eaae5b51016e32d375d6525","deviceCount":1,"msg":"Listed trusted devices"}
{"level":30,"time":1768238234992,"env":"test","module":"auth-routes","userId":"f8114b329802407459d9265ee7b59978","msg":"Login requires MFA verification"}
{"level":30,"time":1768238235106,"env":"test","module":"mfa-service","userId":"f8114b329802407459d9265ee7b59978","msg":"TOTP verification successful"}
{"level":30,"time":1768238235163,"env":"test","module":"auth-routes","userId":"f8114b329802407459d9265ee7b59978","msg":"MFA login successful"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39m[TEST UTILS] MFA Secret verified for 42befb43a070e30a4d3382bcc845c811

{"level":30,"time":1768238237542,"env":"test","module":"auth-routes","userId":"42befb43a070e30a4d3382bcc845c811","msg":"Login requires MFA verification"}
{"level":30,"time":1768238237664,"env":"test","module":"mfa-service","userId":"42befb43a070e30a4d3382bcc845c811","msg":"TOTP verification successful"}
{"level":30,"time":1768238237722,"env":"test","module":"auth-routes","userId":"42befb43a070e30a4d3382bcc845c811","msg":"MFA login successful"}
{"level":30,"time":1768238237906,"env":"test","module":"auth-routes","userId":"42befb43a070e30a4d3382bcc845c811","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768238238456,"env":"test","module":"auth-routes","userId":"42befb43a070e30a4d3382bcc845c811","msg":"Login requires MFA verification"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39m[TEST UTILS] MFA Secret verified for 2e74cb3169d83421027acea6497ad1ed

{"level":30,"time":1768238240424,"env":"test","module":"auth-routes","userId":"2e74cb3169d83421027acea6497ad1ed","msg":"Login requires MFA verification"}
{"level":40,"time":1768238240547,"env":"test","module":"mfa-service","userId":"2e74cb3169d83421027acea6497ad1ed","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768238240547,"env":"test","module":"auth-routes","userId":"2e74cb3169d83421027acea6497ad1ed","msg":"MFA verification failed during login"}
{"level":50,"time":1768238240553,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768238240834,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39m[TEST UTILS] MFA Secret verified for a666616d36b136335133bd2d8daefd6f

{"level":50,"time":1768238242525,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should update lastUsedAt on trusted device login
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768238242633,"env":"test","module":"mfa-service","userId":"a666616d36b136335133bd2d8daefd6f","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768238242633,"env":"test","module":"auth-routes","userId":"a666616d36b136335133bd2d8daefd6f","msg":"MFA verification failed during login"}
{"level":50,"time":1768238242640,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m11 failed[39m[2m)[22m[33m 30118[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should trust current device[39m[33m 2113[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set trust expiry to 30 days[39m[33m 1978[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update expiry if device already trusted[39m[33m 1910[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 430[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all trusted devices[39m[33m 2447[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should mark current device[39m[33m 1850[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude revoked devices[39m[33m 1872[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude expired devices[39m[33m 2197[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific device[39m[33m 946[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 404 for non-existent device [33m 2131[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prevent revoking other user's device [33m 3959[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should skip MFA for trusted device[39m[33m 3171[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should require MFA for untrusted device[39m[33m 2378[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update lastUsedAt on trusted device login[39m[33m 1858[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 11 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should trust current device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:52:36
     50|         .set("X-Forwarded-For", "192.168.1.100");
     51| 
     52|       expect(trustResponse.status).toBe(200);
       |                                    ^
     53|       expect(trustResponse.body.message).toContain("trusted");
     54|       expect(trustResponse.body.trustedUntil).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should set trust expiry to 30 days
AssertionError: expected NaN to be 30 // Object.is equality

- Expected
+ Received

- 30
+ NaN

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:92:24
     90|       );
     91| 
     92|       expect(diffDays).toBe(30);
       |                        ^
     93|     });
     94| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should update expiry if device already trusted
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:132:42
    130| 
    131|       // Should have extended expiry
    132|       expect(secondExpiry > firstExpiry).toBe(true);
       |                                          ^
    133| 
    134|       // Should still only have 1 device record

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:193:31
    191|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    192| 
    193|       expect(response.status).toBe(200);
       |                               ^
    194|       expect(response.body.devices).toBeDefined();
    195|       expect(response.body.devices.length).toBe(2);

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should mark current device
TypeError: Cannot read properties of undefined (reading 'find')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:236:51
    234|         .set("X-Forwarded-For", "192.168.1.100");
    235| 
    236|       const currentDevice = response.body.devices.find((d: any) => d.cÎ“Ã‡Âª
       |                                                   ^
    237|       expect(currentDevice).toBeDefined();
    238|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude revoked devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:269:36
    267|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    268| 
    269|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    270|     });
    271| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude expired devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:302:36
    300|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    301| 
    302|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    303|     });
    304|   });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[7/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
Error: [TEST UTILS] MFA Secret verification failed for 665e7550730f3c44defb9abb9cfd9f36
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:182:21
    180|     where: eq(mfaSecrets.userId, userData.userId)
    181|   });
    182|   if (!check) throw new Error(`[TEST UTILS] MFA Secret verification faÎ“Ã‡Âª
       |                     ^
    183|   if (!check.enabled) throw new Error(`[TEST UTILS] MFA Secret enabledÎ“Ã‡Âª
    184|   console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}Î“Ã‡Âª
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:308:55

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[8/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
AssertionError: expected true to be undefined

- Expected: 
undefined

+ Received: 
true

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:454:52
    452|       // Should not require MFA
    453|       expect(secondLoginResponse.status).toBe(200);
    454|       expect(secondLoginResponse.body.requiresMfa).toBeUndefined();
       |                                                    ^
    455|       expect(secondLoginResponse.body.token).toBeDefined();
    456|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[9/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
AssertionError: expected undefined to be true // Object.is equality

- Expected: 
true

+ Received: 
undefined

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:485:51
    483| 
    484|       // Should require MFA
    485|       expect(loginFromNewDevice.body.requiresMfa).toBe(true);
       |                                                   ^
    486|     });
    487| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[10/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should update lastUsedAt on trusted device login
TypeError: Cannot read properties of undefined (reading 'lastUsedAt')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:512:38
    510|       });
    511| 
    512|       const firstLastUsed = device1!.lastUsedAt;
       |                                      ^
    513| 
    514|       // Wait a bit

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[11/11]Î“Ã„Â»


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m11 failed[39m[22m[2m | [22m[1m[32m3 passed[39m[22m[90m (14)[39m
[2m   Start at [22m 11:16:41
[2m   Duration [22m 39.62s

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
c[3J[1m[44m RERUN [49m[22m [34m[2mtests/setup.ts [22m[34mx10 [34m[39m
       [2m Filename pattern: [22m[34mtests/integration/trusted.devices.real.test.ts[39m

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

{"level":30,"time":1768239344558,"env":"test","msg":"DB: initializing... Neon"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“Â£Ã  audit secrets and track compliance: https://dotenvx.com/ops

{"level":30,"time":1768239344835,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768239347641,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for fa38c42a37177c6e29d231d59fedf5bc

{"level":30,"time":1768239350474,"env":"test","module":"auth-routes","userId":"fa38c42a37177c6e29d231d59fedf5bc","msg":"Login requires MFA verification"}
{"level":30,"time":1768239350598,"env":"test","module":"mfa-service","userId":"fa38c42a37177c6e29d231d59fedf5bc","msg":"TOTP verification successful"}
{"level":30,"time":1768239350651,"env":"test","module":"auth-routes","userId":"fa38c42a37177c6e29d231d59fedf5bc","msg":"MFA login successful"}
{"level":30,"time":1768239350827,"env":"test","module":"auth-routes","userId":"fa38c42a37177c6e29d231d59fedf5bc","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39m[TEST UTILS] MFA Secret verified for 31c04bdc6e25974d350193b548a7b867

{"level":30,"time":1768239352969,"env":"test","module":"auth-routes","userId":"31c04bdc6e25974d350193b548a7b867","msg":"Login requires MFA verification"}
{"level":40,"time":1768239353079,"env":"test","module":"mfa-service","userId":"31c04bdc6e25974d350193b548a7b867","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768239353079,"env":"test","module":"auth-routes","userId":"31c04bdc6e25974d350193b548a7b867","msg":"MFA verification failed during login"}
{"level":50,"time":1768239353087,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for ade2e69745d1ea5597f1018d18854253

{"level":50,"time":1768239354734,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should update expiry if device already trusted
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768239354849,"env":"test","module":"mfa-service","userId":"ade2e69745d1ea5597f1018d18854253","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768239354849,"env":"test","module":"auth-routes","userId":"ade2e69745d1ea5597f1018d18854253","msg":"MFA verification failed during login"}
{"level":50,"time":1768239354858,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768239354967,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768239355431,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39m[TEST UTILS] MFA Secret verified for e45b26b525cbcc598aaad11887dce734

{"level":50,"time":1768239357254,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768239357363,"env":"test","module":"mfa-service","userId":"e45b26b525cbcc598aaad11887dce734","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768239357363,"env":"test","module":"auth-routes","userId":"e45b26b525cbcc598aaad11887dce734","msg":"MFA verification failed during login"}
{"level":50,"time":1768239357369,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768239357635,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768239357742,"env":"test","module":"mfa-service","userId":"e45b26b525cbcc598aaad11887dce734","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768239357742,"env":"test","module":"auth-routes","userId":"e45b26b525cbcc598aaad11887dce734","msg":"MFA verification failed during login"}
{"level":50,"time":1768239357748,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768239358035,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768239358138,"env":"test","module":"mfa-service","userId":"e45b26b525cbcc598aaad11887dce734","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768239358138,"env":"test","module":"auth-routes","userId":"e45b26b525cbcc598aaad11887dce734","msg":"MFA verification failed during login"}
{"level":50,"time":1768239358143,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for 9b8d5b2c5e1030c5422803bda835c394

{"level":50,"time":1768239359928,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should mark current device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768239360132,"env":"test","module":"mfa-service","userId":"9b8d5b2c5e1030c5422803bda835c394","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768239360132,"env":"test","module":"auth-routes","userId":"9b8d5b2c5e1030c5422803bda835c394","msg":"MFA verification failed during login"}
{"level":50,"time":1768239360138,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768239360144,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39m[TEST UTILS] MFA Secret verified for dce2802f0693ba91fd129351d734b089

{"level":50,"time":1768239362049,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude revoked devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768239362156,"env":"test","module":"mfa-service","userId":"dce2802f0693ba91fd129351d734b089","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768239362156,"env":"test","module":"auth-routes","userId":"dce2802f0693ba91fd129351d734b089","msg":"MFA verification failed during login"}
{"level":50,"time":1768239362163,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768239362216,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for 6ffd0a6620e41ae27de9d55ff8c44871

{"level":50,"time":1768239364165,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude expired devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768239364274,"env":"test","module":"mfa-service","userId":"6ffd0a6620e41ae27de9d55ff8c44871","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768239364274,"env":"test","module":"auth-routes","userId":"6ffd0a6620e41ae27de9d55ff8c44871","msg":"MFA verification failed during login"}
{"level":50,"time":1768239364279,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768239364341,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for 83580fdedcefd90418bd5829b2d8acbf

{"level":50,"time":1768239365943,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768239366057,"env":"test","module":"mfa-service","userId":"83580fdedcefd90418bd5829b2d8acbf","msg":"TOTP verification successful"}
{"level":30,"time":1768239366110,"env":"test","module":"auth-routes","userId":"83580fdedcefd90418bd5829b2d8acbf","msg":"MFA login successful"}
{"level":30,"time":1768239366283,"env":"test","module":"auth-routes","userId":"83580fdedcefd90418bd5829b2d8acbf","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":30,"time":1768239366393,"env":"test","module":"auth-routes","userId":"83580fdedcefd90418bd5829b2d8acbf","deviceCount":1,"msg":"Listed trusted devices"}
{"level":30,"time":1768239366547,"env":"test","module":"auth-routes","userId":"83580fdedcefd90418bd5829b2d8acbf","deviceId":"a8200ffc-4498-4a15-affd-d13f9ddf4ed3","msg":"Trusted device revoked"}
{"level":30,"time":1768239366716,"env":"test","module":"auth-routes","userId":"83580fdedcefd90418bd5829b2d8acbf","deviceCount":0,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39m[TEST UTILS] MFA Secret verified for bd455209b49632f352f37b620d15f6d1

{"level":30,"time":1768239368684,"env":"test","module":"auth-routes","userId":"bd455209b49632f352f37b620d15f6d1","msg":"Login requires MFA verification"}
{"level":40,"time":1768239368797,"env":"test","module":"mfa-service","userId":"bd455209b49632f352f37b620d15f6d1","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768239368798,"env":"test","module":"auth-routes","userId":"bd455209b49632f352f37b620d15f6d1","msg":"MFA verification failed during login"}
{"level":50,"time":1768239368803,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for c9bb581430bf0592183f099ec1909894

{"level":50,"time":1768239371270,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768239371378,"env":"test","module":"mfa-service","userId":"c9bb581430bf0592183f099ec1909894","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768239371379,"env":"test","module":"auth-routes","userId":"c9bb581430bf0592183f099ec1909894","msg":"MFA verification failed during login"}
{"level":50,"time":1768239371384,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768239371388,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768239372814,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768239372925,"env":"test","module":"mfa-service","userId":"c53c92825841ad6f432a61e300569562","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768239372925,"env":"test","module":"auth-routes","userId":"c53c92825841ad6f432a61e300569562","msg":"MFA verification failed during login"}
{"level":50,"time":1768239372929,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768239373186,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":50,"time":1768239374652,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":40,"time":1768239374756,"env":"test","module":"mfa-service","userId":"e7d1a858cd3ae4b8dc4eec8d708d9c9b","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768239374756,"env":"test","module":"auth-routes","userId":"e7d1a858cd3ae4b8dc4eec8d708d9c9b","msg":"MFA verification failed during login"}
{"level":50,"time":1768239374761,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768239375022,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
{"level":30,"time":1768239376740,"env":"test","module":"auth-routes","userId":"68ff165f8fb8b04c6e20c9002f6e1312","msg":"Login requires MFA verification"}
{"level":40,"time":1768239376850,"env":"test","module":"mfa-service","userId":"68ff165f8fb8b04c6e20c9002f6e1312","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768239376850,"env":"test","module":"auth-routes","userId":"68ff165f8fb8b04c6e20c9002f6e1312","msg":"MFA verification failed during login"}
{"level":50,"time":1768239376856,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould prevent revoking other user's device
[22m[39m[TEST UTILS] MFA Secret verified for 8777c0eccfe355eafd5202e7c8b89b45

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should prevent revoking other user's device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39m[TEST UTILS] MFA Secret verified for c53c92825841ad6f432a61e300569562

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39m[TEST UTILS] MFA Secret verified for e7d1a858cd3ae4b8dc4eec8d708d9c9b

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39m[TEST UTILS] MFA Secret verified for 68ff165f8fb8b04c6e20c9002f6e1312

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m11 failed[39m[2m)[22m[33m 29239[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should trust current device [33m 2350[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set trust expiry to 30 days[39m[33m 2220[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update expiry if device already trusted[39m[33m 1870[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 463[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all trusted devices[39m[33m 2712[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should mark current device[39m[33m 2001[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude revoked devices[39m[33m 2072[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude expired devices[39m[33m 2125[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke specific device [33m 2375[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 404 for non-existent device[39m[33m 2088[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent revoking other user's device[39m[33m 2583[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should skip MFA for trusted device[39m[33m 1799[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should require MFA for untrusted device[39m[33m 1838[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update lastUsedAt on trusted device login[39m[33m 1891[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 11 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should set trust expiry to 30 days
AssertionError: expected NaN to be 30 // Object.is equality

- Expected
+ Received

- 30
+ NaN

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:92:24
     90|       );
     91| 
     92|       expect(diffDays).toBe(30);
       |                        ^
     93|     });
     94| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should update expiry if device already trusted
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:132:42
    130| 
    131|       // Should have extended expiry
    132|       expect(secondExpiry > firstExpiry).toBe(true);
       |                                          ^
    133| 
    134|       // Should still only have 1 device record

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:193:31
    191|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    192| 
    193|       expect(response.status).toBe(200);
       |                               ^
    194|       expect(response.body.devices).toBeDefined();
    195|       expect(response.body.devices.length).toBe(2);

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should mark current device
TypeError: Cannot read properties of undefined (reading 'find')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:236:51
    234|         .set("X-Forwarded-For", "192.168.1.100");
    235| 
    236|       const currentDevice = response.body.devices.find((d: any) => d.cÎ“Ã‡Âª
       |                                                   ^
    237|       expect(currentDevice).toBeDefined();
    238|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude revoked devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:269:36
    267|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    268| 
    269|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    270|     });
    271| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude expired devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:302:36
    300|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    301| 
    302|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    303|     });
    304|   });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should return 404 for non-existent device
AssertionError: expected 401 to be 404 // Object.is equality

- Expected
+ Received

- 404
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:371:31
    369|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    370| 
    371|       expect(response.status).toBe(404);
       |                               ^
    372|     });
    373| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[7/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should prevent revoking other user's device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:399:43
    397|         .set("Authorization", `Bearer ${mfaLogin1.body.token}`);
    398| 
    399|       const user1DeviceId = devices1.body.devices[0].id;
       |                                           ^
    400| 
    401|       // User 2 tries to revoke user 1's device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[8/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:453:42
    451| 
    452|       // Should not require MFA
    453|       expect(secondLoginResponse.status).toBe(200);
       |                                          ^
    454|       expect(secondLoginResponse.body.requiresMfa).toBeUndefined();
    455|       expect(secondLoginResponse.body.token).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[9/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
AssertionError: expected undefined to be true // Object.is equality

- Expected: 
true

+ Received: 
undefined

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:485:51
    483| 
    484|       // Should require MFA
    485|       expect(loginFromNewDevice.body.requiresMfa).toBe(true);
       |                                                   ^
    486|     });
    487| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[10/11]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should update lastUsedAt on trusted device login
TypeError: Cannot read properties of undefined (reading 'lastUsedAt')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:512:38
    510|       });
    511| 
    512|       const firstLastUsed = device1!.lastUsedAt;
       |                                      ^
    513| 
    514|       // Wait a bit

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[11/11]Î“Ã„Â»


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m11 failed[39m[22m[2m | [22m[1m[32m3 passed[39m[22m[90m (14)[39m
[2m   Start at [22m 11:33:06
[2m   Duration [22m 188.38s

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
[1m[35m
Restarting due to config changes...[39m[22m

[1m[44m DEV [49m[22m [34mv4.0.16 [39m[90mC:/Users/scoot/poll/VaultLogic[39m

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: â‰¡Æ’Ã¶Ã‰ encrypt with Dotenvx: https://dotenvx.com

{"level":30,"time":1768240074745,"env":"test","msg":"DB: initializing... Neon"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã¦ add access controls to secrets: https://dotenvx.com/ops

{"level":30,"time":1768240074868,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768240078593,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould trust current device
[22m[39m[TEST UTILS] MFA Secret verified for 1320275cef5764cdc9767e373315be60

{"level":50,"time":1768240081304,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should trust current device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768240081436,"env":"test","module":"mfa-service","userId":"1320275cef5764cdc9767e373315be60","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768240081437,"env":"test","module":"auth-routes","userId":"1320275cef5764cdc9767e373315be60","msg":"MFA verification failed during login"}
{"level":50,"time":1768240081445,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould set trust expiry to 30 days
[22m[39m[TEST UTILS] MFA Secret verified for 74bcd7e8818a85109c43d6af7d8ecc21

{"level":50,"time":1768240083011,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should set trust expiry to 30 days
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768240083122,"env":"test","module":"mfa-service","userId":"74bcd7e8818a85109c43d6af7d8ecc21","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768240083122,"env":"test","module":"auth-routes","userId":"74bcd7e8818a85109c43d6af7d8ecc21","msg":"MFA verification failed during login"}
{"level":50,"time":1768240083128,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mPOST /api/auth/trust-device[2m > [22m[2mshould update expiry if device already trusted
[22m[39m[TEST UTILS] MFA Secret verified for 75e988f1c86eb3f2cbd7ad04a7daa2d7

{"level":50,"time":1768240084599,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should update expiry if device already trusted
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768240084714,"env":"test","module":"mfa-service","userId":"75e988f1c86eb3f2cbd7ad04a7daa2d7","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768240084714,"env":"test","module":"auth-routes","userId":"75e988f1c86eb3f2cbd7ad04a7daa2d7","msg":"MFA verification failed during login"}
{"level":50,"time":1768240084719,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768240084824,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768240085256,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould list all trusted devices
[22m[39m[TEST UTILS] MFA Secret verified for fc424fa5b334c4dff15939d36350afc1

{"level":50,"time":1768240086739,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768240086852,"env":"test","module":"mfa-service","userId":"fc424fa5b334c4dff15939d36350afc1","msg":"TOTP verification successful"}
{"level":30,"time":1768240086907,"env":"test","module":"auth-routes","userId":"fc424fa5b334c4dff15939d36350afc1","msg":"MFA login successful"}
{"level":30,"time":1768240087101,"env":"test","module":"auth-routes","userId":"fc424fa5b334c4dff15939d36350afc1","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":50,"time":1768240087371,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768240087487,"env":"test","module":"mfa-service","userId":"fc424fa5b334c4dff15939d36350afc1","msg":"TOTP verification successful"}
{"level":30,"time":1768240087538,"env":"test","module":"auth-routes","userId":"fc424fa5b334c4dff15939d36350afc1","msg":"MFA login successful"}
{"level":30,"time":1768240087706,"env":"test","module":"auth-routes","userId":"fc424fa5b334c4dff15939d36350afc1","deviceFingerprint":"091366faa1882b5c8dc1cba02126615a77a378274bbfd3375e821aa38bdd1b4f","msg":"Device marked as trusted"}
{"level":50,"time":1768240087988,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768240088098,"env":"test","module":"mfa-service","userId":"fc424fa5b334c4dff15939d36350afc1","msg":"TOTP verification successful"}
{"level":30,"time":1768240088155,"env":"test","module":"auth-routes","userId":"fc424fa5b334c4dff15939d36350afc1","msg":"MFA login successful"}
{"level":30,"time":1768240088268,"env":"test","module":"auth-routes","userId":"fc424fa5b334c4dff15939d36350afc1","deviceCount":0,"msg":"Listed trusted devices"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould mark current device
[22m[39m[TEST UTILS] MFA Secret verified for 7dca738fa05f0194b85239e11e227964

{"level":50,"time":1768240089737,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should mark current device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768240089844,"env":"test","module":"mfa-service","userId":"7dca738fa05f0194b85239e11e227964","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768240089844,"env":"test","module":"auth-routes","userId":"7dca738fa05f0194b85239e11e227964","msg":"MFA verification failed during login"}
{"level":50,"time":1768240089847,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768240089852,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude revoked devices
[22m[39m[TEST UTILS] MFA Secret verified for 29b801771efd79787d7e72aae93ac366

{"level":50,"time":1768240091330,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude revoked devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768240091441,"env":"test","module":"mfa-service","userId":"29b801771efd79787d7e72aae93ac366","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768240091441,"env":"test","module":"auth-routes","userId":"29b801771efd79787d7e72aae93ac366","msg":"MFA verification failed during login"}
{"level":50,"time":1768240091445,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768240091499,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mGET /api/auth/trusted-devices[2m > [22m[2mshould exclude expired devices
[22m[39m[TEST UTILS] MFA Secret verified for a0b4ae4b81600bb31e508294eb2841d4

{"level":50,"time":1768240092996,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude expired devices
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768240093107,"env":"test","module":"mfa-service","userId":"a0b4ae4b81600bb31e508294eb2841d4","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768240093107,"env":"test","module":"auth-routes","userId":"a0b4ae4b81600bb31e508294eb2841d4","msg":"MFA verification failed during login"}
{"level":50,"time":1768240093111,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768240093170,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould revoke specific device
[22m[39m[TEST UTILS] MFA Secret verified for d2a31c586c075835d7d09242f79b616a

{"level":50,"time":1768240094693,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768240094808,"env":"test","module":"mfa-service","userId":"d2a31c586c075835d7d09242f79b616a","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768240094809,"env":"test","module":"auth-routes","userId":"d2a31c586c075835d7d09242f79b616a","msg":"MFA verification failed during login"}
{"level":50,"time":1768240094812,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768240094816,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDELETE /api/auth/trusted-devices/:deviceId[2m > [22m[2mshould return 404 for non-existent device
[22m[39m[TEST UTILS] MFA Secret verified for ded6463079c57a68eb7f7587dafbe6d6

{"level":50,"time":1768240096280,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should return 404 for non-existent device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768240096391,"env":"test","module":"mfa-service","userId":"ded6463079c57a68eb7f7587dafbe6d6","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768240096391,"env":"test","module":"auth-routes","userId":"ded6463079c57a68eb7f7587dafbe6d6","msg":"MFA verification failed during login"}
{"level":50,"time":1768240096396,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould skip MFA for trusted device
[22m[39m[TEST UTILS] MFA Secret verified for b27954467799342adf079fb0e8ab1401

{"level":50,"time":1768240098807,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":30,"time":1768240098917,"env":"test","module":"mfa-service","userId":"b27954467799342adf079fb0e8ab1401","msg":"TOTP verification successful"}
{"level":30,"time":1768240098967,"env":"test","module":"auth-routes","userId":"b27954467799342adf079fb0e8ab1401","msg":"MFA login successful"}
{"level":30,"time":1768240099139,"env":"test","module":"auth-routes","userId":"b27954467799342adf079fb0e8ab1401","deviceFingerprint":"18e0dd8a369af6a2dfab7c513f89e7699b63e8eb7dbfc933a8238e91b2dbc1e4","msg":"Device marked as trusted"}
{"level":50,"time":1768240099410,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould require MFA for untrusted device
[22m[39m[TEST UTILS] MFA Secret verified for afb46bdd950a0a234b379c78e8674da1

{"level":50,"time":1768240100879,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

{"level":40,"time":1768240100987,"env":"test","module":"mfa-service","userId":"afb46bdd950a0a234b379c78e8674da1","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768240100987,"env":"test","module":"auth-routes","userId":"afb46bdd950a0a234b379c78e8674da1","msg":"MFA verification failed during login"}
{"level":50,"time":1768240100991,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":50,"time":1768240101258,"env":"test","module":"auth-routes","error":{"name":"InvalidCredentialsError","code":"AUTH_004","statusCode":401,"isOperational":true},"msg":"Login failed"}
stderr | tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
Login Failed DEBUG: InvalidCredentialsError: Invalid credentials
    at validateCredentials (C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:65:11)
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at C:/Users/scoot/poll/VaultLogic/server/routes/auth.routes.ts:286:20 {
  code: 'AUTH_004',
  statusCode: 401,
  isOperational: true
}

[90mstdout[2m | tests/integration/trusted.devices.real.test.ts[2m > [22m[2mTrusted Devices Integration Tests (REAL)[2m > [22m[2mDevice Trust with MFA Login[2m > [22m[2mshould update lastUsedAt on trusted device login
[22m[39m[TEST UTILS] MFA Secret verified for 26f3b8bfd432cda79f7706db0fb3c36e

{"level":30,"time":1768240102937,"env":"test","module":"auth-routes","userId":"26f3b8bfd432cda79f7706db0fb3c36e","msg":"Login requires MFA verification"}
{"level":40,"time":1768240103047,"env":"test","module":"mfa-service","userId":"26f3b8bfd432cda79f7706db0fb3c36e","msg":"No enabled MFA secret found for user"}
{"level":40,"time":1768240103047,"env":"test","module":"auth-routes","userId":"26f3b8bfd432cda79f7706db0fb3c36e","msg":"MFA verification failed during login"}
{"level":50,"time":1768240103051,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
[90mstdout[2m | tests/integration/trusted.devices.real.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

 [31mÎ“Â¥Â»[39m tests/integration/trusted.devices.real.test.ts [2m([22m[2m14 tests[22m[2m | [22m[31m13 failed[39m[2m)[22m[33m 24335[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should trust current device[39m[33m 1889[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should set trust expiry to 30 days[39m[33m 1675[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update expiry if device already trusted[39m[33m 1696[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 432[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should list all trusted devices[39m[33m 3013[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should mark current device[39m[33m 1582[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude revoked devices[39m[33m 1647[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should exclude expired devices[39m[33m 1671[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should revoke specific device[39m[33m 1647[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should return 404 for non-existent device[39m[33m 1580[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should prevent revoking other user's device[39m[33m 938[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should skip MFA for trusted device[39m[33m 2076[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should require MFA for untrusted device[39m[33m 1848[2mms[22m[39m
[31m       [31mâ”œÃ¹[31m should update lastUsedAt on trusted device login[39m[33m 1844[2mms[22m[39m

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â» Failed Tests 13 Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should trust current device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:52:36
     50|         .set("X-Forwarded-For", "192.168.1.100");
     51| 
     52|       expect(trustResponse.status).toBe(200);
       |                                    ^
     53|       expect(trustResponse.body.message).toContain("trusted");
     54|       expect(trustResponse.body.trustedUntil).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[1/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should set trust expiry to 30 days
AssertionError: expected NaN to be 30 // Object.is equality

- Expected
+ Received

- 30
+ NaN

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:92:24
     90|       );
     91| 
     92|       expect(diffDays).toBe(30);
       |                        ^
     93|     });
     94| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[2/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > POST /api/auth/trust-device > should update expiry if device already trusted
AssertionError: expected false to be true // Object.is equality

- Expected
+ Received

- true
+ false

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:132:42
    130| 
    131|       // Should have extended expiry
    132|       expect(secondExpiry > firstExpiry).toBe(true);
       |                                          ^
    133| 
    134|       // Should still only have 1 device record

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[3/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should list all trusted devices
AssertionError: expected +0 to be 2 // Object.is equality

- Expected
+ Received

- 2
+ 0

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:195:44
    193|       expect(response.status).toBe(200);
    194|       expect(response.body.devices).toBeDefined();
    195|       expect(response.body.devices.length).toBe(2);
       |                                            ^
    196| 
    197|       // Verify device properties

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[4/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should mark current device
TypeError: Cannot read properties of undefined (reading 'find')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:236:51
    234|         .set("X-Forwarded-For", "192.168.1.100");
    235| 
    236|       const currentDevice = response.body.devices.find((d: any) => d.cÎ“Ã‡Âª
       |                                                   ^
    237|       expect(currentDevice).toBeDefined();
    238|     });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[5/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude revoked devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:269:36
    267|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    268| 
    269|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    270|     });
    271| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[6/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > GET /api/auth/trusted-devices > should exclude expired devices
TypeError: Cannot read properties of undefined (reading 'length')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:302:36
    300|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    301| 
    302|       expect(response.body.devices.length).toBe(0);
       |                                    ^
    303|     });
    304|   });

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[7/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should revoke specific device
TypeError: Cannot read properties of undefined (reading '0')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:332:45
    330|         .set("Authorization", `Bearer ${token}`);
    331| 
    332|       const deviceId = devicesResponse.body.devices[0].id;
       |                                             ^
    333| 
    334|       // Revoke device

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[8/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should return 404 for non-existent device
AssertionError: expected 401 to be 404 // Object.is equality

- Expected
+ Received

- 404
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:371:31
    369|         .set("Authorization", `Bearer ${mfaLoginResponse.body.token}`);
    370| 
    371|       expect(response.status).toBe(404);
       |                               ^
    372|     });
    373| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[9/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > DELETE /api/auth/trusted-devices/:deviceId > should prevent revoking other user's device
Error: [TEST UTILS] MFA Secret verification failed for 33777f0a476a7e2ef234330eef061608
 Î“Â¥Â» createUserWithMfa tests/helpers/testUtils.ts:182:21
    180|     where: eq(mfaSecrets.userId, userData.userId)
    181|   });
    182|   if (!check) throw new Error(`[TEST UTILS] MFA Secret verification faÎ“Ã‡Âª
       |                     ^
    183|   if (!check.enabled) throw new Error(`[TEST UTILS] MFA Secret enabledÎ“Ã‡Âª
    184|   console.log(`[TEST UTILS] MFA Secret verified for ${userData.userId}Î“Ã‡Âª
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:375:21

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[10/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should skip MFA for trusted device
AssertionError: expected 401 to be 200 // Object.is equality

- Expected
+ Received

- 200
+ 401

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:453:42
    451| 
    452|       // Should not require MFA
    453|       expect(secondLoginResponse.status).toBe(200);
       |                                          ^
    454|       expect(secondLoginResponse.body.requiresMfa).toBeUndefined();
    455|       expect(secondLoginResponse.body.token).toBeDefined();

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[11/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should require MFA for untrusted device
AssertionError: expected undefined to be true // Object.is equality

- Expected: 
true

+ Received: 
undefined

 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:485:51
    483| 
    484|       // Should require MFA
    485|       expect(loginFromNewDevice.body.requiresMfa).toBe(true);
       |                                                   ^
    486|     });
    487| 

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[12/13]Î“Ã„Â»

 FAIL  tests/integration/trusted.devices.real.test.ts > Trusted Devices Integration Tests (REAL) > Device Trust with MFA Login > should update lastUsedAt on trusted device login
TypeError: Cannot read properties of undefined (reading 'lastUsedAt')
 Î“Â¥Â» tests/integration/trusted.devices.real.test.ts:512:38
    510|       });
    511| 
    512|       const firstLastUsed = device1!.lastUsedAt;
       |                                      ^
    513| 
    514|       // Wait a bit

Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»Î“Ã„Â»[13/13]Î“Ã„Â»


[2m Test Files [22m [1m[31m1 failed[39m[22m[90m (1)[39m
[2m      Tests [22m [1m[31m13 failed[39m[22m[2m | [22m[1m[32m1 passed[39m[22m[90m (14)[39m
[2m   Start at [22m 11:39:17
[2m   Duration [22m 545.45s[2m (transform 502.95s, setup 501.42s, import 5.62s, tests 24.33s, environment 0ms)[22m

[1m[41m FAIL [49m[22m [31mTests failed. Watching for file changes...[39m
       [2mpress [22m[1mh[22m[2m to show help[22m[2m, [22m[2mpress [22m[1mq[22m[2m to quit[22m
