npm warn Unknown project config "puppeteer_skip_download". This will stop working in the next major version of npm.

[1m[46m RUN [49m[22m [36mv4.0.16 [39m[90mC:/Users/scoot/poll/VaultLogic[39m

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  write to custom object with { processEnv: myObject }

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mSETUP: Loading setup.ts...
[dotenv@17.2.3] injecting env (20) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  specify custom .env file path with { path: '/custom/path/.env' }

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: Î“ÃœÃ–âˆ©â••Ã…  enable debug logging with { debug: true }
DB: Skipping auto-init because NODE_ENV=test

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[dotenv@17.2.3] injecting env (0) from .env -- tip: â‰¡Æ’Ã¶Ã‰ prevent building .env in docker: https://dotenvx.com/prebuild
DB: Skipping auto-init because NODE_ENV=test

{"level":30,"time":1768249711924,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
{"level":30,"time":1768249711924,"env":"test","module":"metrics-service","msg":"MetricsService initialized"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w1_bfb03b2a

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[SchemaManager] Creating isolated schema: test_schema_w0_17923f56

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[SchemaManager] Detected Neon DB. Switching to Direct Connection (5432) for schema isolation.

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w1_bfb03b2a

{"level":30,"time":1768249717234,"env":"test","msg":"DB: initializing... Local"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mâ‰¡Æ’Ã¶Ã† Test Schema Isolated: test_schema_w0_17923f56

{"level":30,"time":1768249717239,"env":"test","msg":"DB: initializing... Local"}
{"level":30,"time":1768249717267,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768249717271,"env":"test","msg":"DB: initialized flag set."}
{"level":30,"time":1768249717612,"env":"test","msg":"DB: Connected to schema: test_schema_w0_17923f56"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

{"level":30,"time":1768249717612,"env":"test","msg":"DB: Connection options: Has search_path"}
{"level":30,"time":1768249717621,"env":"test","msg":"DB: Connected to schema: test_schema_w1_bfb03b2a"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mÎ“Â£Ã  Database initialized for tests
â‰¡Æ’Ã¶Ã¤ Running test migrations...

{"level":30,"time":1768249717622,"env":"test","msg":"DB: Connection options: Has search_path"}
stderr | tests/integration/auth/protected.routes.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: relation "global_recipients" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 115,
  severity: 'ERROR',
  code: '42P01',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'namespace.c',
  line: '637',
  routine: 'RangeVarGetRelidExtended'
}

{"level":30,"time":1768249725284,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768249725300,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests
[22m[39m[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768249725292,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768249725292,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768249725295,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768249725300,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768249725300,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768249725300,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768249725300,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768249725745,"env":"test","module":"user-credentials-repository","userId":"b0d01de2-550a-452f-9d41-50edaf67dc9b","msg":"User credentials created"}
{"level":30,"time":1768249725839,"env":"test","module":"email-queue","jobId":"12171dea-b25c-43c6-8605-cf481468ccd2","to":"test-InFJPi3b19n9rfS5Yi5PK@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249725890,"env":"test","module":"auth-routes","userId":"b0d01de2-550a-452f-9d41-50edaf67dc9b","email":"test-InFJPi3b19n9rfS5Yi5PK@example.com","msg":"User registered"}
{"level":30,"time":1768249726523,"env":"test","module":"user-credentials-repository","userId":"a8fd42b0-4e99-49c4-b877-eae0d2f601c7","msg":"User credentials created"}
{"level":30,"time":1768249726619,"env":"test","module":"email-queue","jobId":"81488386-f7c1-4372-be82-cb7c4ac308c7","to":"protected-test--VtnBFb1TIJ-fJmg1NDB2@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249726669,"env":"test","module":"auth-routes","userId":"a8fd42b0-4e99-49c4-b877-eae0d2f601c7","email":"protected-test--VtnBFb1TIJ-fJmg1NDB2@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould allow access with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249727278,"env":"test","module":"auth-routes","userId":"a8fd42b0-4e99-49c4-b877-eae0d2f601c7","msg":"User logged in successfully"}
{"level":30,"time":1768249727327,"env":"test","module":"audit-log-service","userId":"a8fd42b0-4e99-49c4-b877-eae0d2f601c7","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249727736,"env":"test","module":"user-credentials-repository","userId":"70b60084-dc1e-45c9-be18-705c7867880a","msg":"User credentials created"}
{"level":30,"time":1768249727843,"env":"test","module":"email-queue","jobId":"b20aeb9c-4c92-4942-9237-faa6bb74701d","to":"protected-test-IiVW5GHxsswwyUmx8vu9p@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249727892,"env":"test","module":"auth-routes","userId":"70b60084-dc1e-45c9-be18-705c7867880a","email":"protected-test-IiVW5GHxsswwyUmx8vu9p@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould reject access without Authorization header
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249728498,"env":"test","module":"auth-routes","userId":"70b60084-dc1e-45c9-be18-705c7867880a","msg":"User logged in successfully"}
{"level":30,"time":1768249728546,"env":"test","module":"audit-log-service","userId":"70b60084-dc1e-45c9-be18-705c7867880a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768249728551,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249728927,"env":"test","module":"user-credentials-repository","userId":"6abdd23e-6a2b-4c77-814e-297b21ce142c","msg":"User credentials created"}
{"level":30,"time":1768249729020,"env":"test","module":"email-queue","jobId":"cd2e39ee-b8d1-453e-9179-c78ea5ee6acf","to":"protected-test-L7FYYCTTMDUNaNhcnelKF@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249729066,"env":"test","module":"auth-routes","userId":"6abdd23e-6a2b-4c77-814e-297b21ce142c","email":"protected-test-L7FYYCTTMDUNaNhcnelKF@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould reject access with empty Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249729666,"env":"test","module":"auth-routes","userId":"6abdd23e-6a2b-4c77-814e-297b21ce142c","msg":"User logged in successfully"}
{"level":30,"time":1768249729714,"env":"test","module":"audit-log-service","userId":"6abdd23e-6a2b-4c77-814e-297b21ce142c","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768249729718,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249730080,"env":"test","module":"user-credentials-repository","userId":"24764ae9-dc35-43f5-93ac-3f76f98e7e52","msg":"User credentials created"}
{"level":30,"time":1768249730184,"env":"test","module":"email-queue","jobId":"eb75fc64-f9a2-44e4-b385-909bc3cd0a96","to":"protected-test-wFWwtGnqJAmOPhq4CtvPm@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249730232,"env":"test","module":"auth-routes","userId":"24764ae9-dc35-43f5-93ac-3f76f98e7e52","email":"protected-test-wFWwtGnqJAmOPhq4CtvPm@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould reject access with malformed Authorization header
[22m[39mDEBUG: LOGIN HANDLER HIT

stderr | tests/integration/auth/session.management.integration.test.ts
Î“ÃœÃ¡âˆ©â••Ã… Migrations failed (non-fatal if DB exists): error: relation "global_recipients" does not exist
    at C:\Users\scoot\poll\VaultLogic\node_modules\pg\lib\client.js:545:17
    at processTicksAndRejections (node:internal/process/task_queues:103:5)
    at file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:64:13
    at NodePgSession.transaction (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/session.js:142:22)
    at PgDialect.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/pg-core/dialect.js:60:5)
    at Module.migrate (file:///C:/Users/scoot/poll/VaultLogic/node_modules/drizzle-orm/node-postgres/migrator.js:4:3)
    at C:/Users/scoot/poll/VaultLogic/tests/setup.ts:143:11 {
  length: 115,
  severity: 'ERROR',
  code: '42P01',
  detail: undefined,
  hint: undefined,
  position: undefined,
  internalPosition: undefined,
  internalQuery: undefined,
  where: undefined,
  schema: undefined,
  table: undefined,
  column: undefined,
  dataType: undefined,
  constraint: undefined,
  file: 'namespace.c',
  line: '637',
  routine: 'RangeVarGetRelidExtended'
}

{"level":30,"time":1768249730587,"env":"test","module":"metrics-routes","msg":"Metrics endpoint registered at GET /metrics"}
{"level":30,"time":1768249730601,"env":"test","msg":"Real-time collaboration server initialized"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests
[22m[39m[Routes] E-Signature routes registered at /api/esign

{"level":30,"time":1768249730593,"env":"test","module":"file-routes","outputsDir":"C:\\Users\\scoot\\poll\\VaultLogic\\server\\files\\outputs","msg":"Secure file routes registered"}
{"level":30,"time":1768249730593,"env":"test","module":"ai-routes","msg":"AI workflow generation routes registered"}
{"level":30,"time":1768249730596,"env":"test","module":"documents-routes","msg":"Document routes registered"}
{"level":30,"time":1768249730601,"env":"test","module":"collab-server","msg":"Initializing WebSocket collaboration server"}
{"level":40,"time":1768249730601,"env":"test","module":"collab-persistence","msg":"REDIS_URL not configured, multi-instance collab will not work"}
{"level":30,"time":1768249730601,"env":"test","module":"collab-server","msg":"WebSocket collaboration server attached to main HTTP server path /collab"}
{"level":30,"time":1768249730601,"env":"test","module":"collab-server","msg":"WebSocket collaboration server initialized"}
{"level":30,"time":1768249730841,"env":"test","module":"auth-routes","userId":"24764ae9-dc35-43f5-93ac-3f76f98e7e52","msg":"User logged in successfully"}
{"level":30,"time":1768249730888,"env":"test","module":"audit-log-service","userId":"24764ae9-dc35-43f5-93ac-3f76f98e7e52","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768249730891,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249731040,"env":"test","module":"user-credentials-repository","userId":"27b2803f-9ddb-43d4-87f9-b657f4bdd7d2","msg":"User credentials created"}
{"level":30,"time":1768249731135,"env":"test","module":"email-queue","jobId":"010d23da-6ce4-4be4-a8cc-528f02a90157","to":"test-3YGFKm0UcADEjxdgw1vDB@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249731186,"env":"test","module":"auth-routes","userId":"27b2803f-9ddb-43d4-87f9-b657f4bdd7d2","email":"test-3YGFKm0UcADEjxdgw1vDB@example.com","msg":"User registered"}
{"level":30,"time":1768249731243,"env":"test","module":"user-credentials-repository","userId":"28e76f1e-1f60-4b0f-87b4-3cfdd3ee6277","msg":"User credentials created"}
{"level":30,"time":1768249731342,"env":"test","module":"email-queue","jobId":"865cfecf-838d-438c-8112-985f6630eb16","to":"protected-test-kuoXl7qFrFcoVoGbdVtFZ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249731390,"env":"test","module":"auth-routes","userId":"28e76f1e-1f60-4b0f-87b4-3cfdd3ee6277","email":"protected-test-kuoXl7qFrFcoVoGbdVtFZ@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mGET Protected Routes[2m > [22m[2mshould reject access with wrong token type
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249731704,"env":"test","module":"user-credentials-repository","userId":"fa5bb676-9263-4ddf-bbdc-8404a5e5c00a","msg":"User credentials created"}
{"level":30,"time":1768249731816,"env":"test","module":"email-queue","jobId":"03e566a3-41ce-4b52-b08d-78b9f6e8179a","to":"session-test-HQfHhnayBsY4M9wCdzEaA@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249731882,"env":"test","module":"auth-routes","userId":"fa5bb676-9263-4ddf-bbdc-8404a5e5c00a","email":"session-test-HQfHhnayBsY4M9wCdzEaA@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Creation and Tracking[2m > [22m[2mshould create refresh token on login
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249731991,"env":"test","module":"auth-routes","userId":"28e76f1e-1f60-4b0f-87b4-3cfdd3ee6277","msg":"User logged in successfully"}
{"level":30,"time":1768249732040,"env":"test","module":"audit-log-service","userId":"28e76f1e-1f60-4b0f-87b4-3cfdd3ee6277","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768249732046,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768249732046,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249732418,"env":"test","module":"user-credentials-repository","userId":"e242890f-5704-4021-838f-4978270e8b69","msg":"User credentials created"}
{"level":30,"time":1768249732442,"env":"test","module":"auth-routes","userId":"fa5bb676-9263-4ddf-bbdc-8404a5e5c00a","msg":"User logged in successfully"}
{"level":30,"time":1768249732492,"env":"test","module":"audit-log-service","userId":"fa5bb676-9263-4ddf-bbdc-8404a5e5c00a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249732518,"env":"test","module":"email-queue","jobId":"ad2863e3-2d8f-4fc7-b79a-8266d590a337","to":"protected-test-4M6yl01zS5vzgnWwkzS3w@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249732564,"env":"test","module":"auth-routes","userId":"e242890f-5704-4021-838f-4978270e8b69","email":"protected-test-4M6yl01zS5vzgnWwkzS3w@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPOST Protected Routes[2m > [22m[2mshould allow POST with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249732915,"env":"test","module":"user-credentials-repository","userId":"34eee4ef-6937-43ec-aca3-311af6d8be68","msg":"User credentials created"}
{"level":30,"time":1768249733014,"env":"test","module":"email-queue","jobId":"32f43395-6bd9-49f5-a520-a0fe31ad8094","to":"session-test-vh26Kod28ilg1Topnjz8E@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249733065,"env":"test","module":"auth-routes","userId":"34eee4ef-6937-43ec-aca3-311af6d8be68","email":"session-test-vh26Kod28ilg1Topnjz8E@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Creation and Tracking[2m > [22m[2mshould track device metadata in session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249733170,"env":"test","module":"auth-routes","userId":"e242890f-5704-4021-838f-4978270e8b69","msg":"User logged in successfully"}
{"level":30,"time":1768249733218,"env":"test","module":"audit-log-service","userId":"e242890f-5704-4021-838f-4978270e8b69","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249733632,"env":"test","module":"auth-routes","userId":"34eee4ef-6937-43ec-aca3-311af6d8be68","msg":"User logged in successfully"}
{"level":30,"time":1768249733646,"env":"test","module":"user-credentials-repository","userId":"314a1b00-17e0-4ae8-ad80-49d4296fa249","msg":"User credentials created"}
{"level":30,"time":1768249733679,"env":"test","module":"audit-log-service","userId":"34eee4ef-6937-43ec-aca3-311af6d8be68","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249733746,"env":"test","module":"email-queue","jobId":"19f5ef94-5b5d-4243-8556-1f83215471fe","to":"protected-test-VIv0H0IkGT_ttY8WYvl05@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249733797,"env":"test","module":"auth-routes","userId":"314a1b00-17e0-4ae8-ad80-49d4296fa249","email":"protected-test-VIv0H0IkGT_ttY8WYvl05@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPOST Protected Routes[2m > [22m[2mshould reject POST without Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249734097,"env":"test","module":"user-credentials-repository","userId":"e8dcc543-a295-4e92-b023-f56a5ca5fe97","msg":"User credentials created"}
{"level":30,"time":1768249734200,"env":"test","module":"email-queue","jobId":"582c8e2e-14b9-4d6c-80eb-5037bf3e306f","to":"session-test-HdbnrSDyEMqHZSuNeoK6c@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249734248,"env":"test","module":"auth-routes","userId":"e8dcc543-a295-4e92-b023-f56a5ca5fe97","email":"session-test-HdbnrSDyEMqHZSuNeoK6c@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Creation and Tracking[2m > [22m[2mshould create separate sessions for multiple device logins
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249734400,"env":"test","module":"auth-routes","userId":"314a1b00-17e0-4ae8-ad80-49d4296fa249","msg":"User logged in successfully"}
{"level":30,"time":1768249734447,"env":"test","module":"audit-log-service","userId":"314a1b00-17e0-4ae8-ad80-49d4296fa249","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768249734451,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249734811,"env":"test","module":"auth-routes","userId":"e8dcc543-a295-4e92-b023-f56a5ca5fe97","msg":"User logged in successfully"}
{"level":30,"time":1768249734815,"env":"test","module":"user-credentials-repository","userId":"b65f4de3-8b77-4ff0-8d4a-d8e61ad9187d","msg":"User credentials created"}
{"level":30,"time":1768249734866,"env":"test","module":"audit-log-service","userId":"e8dcc543-a295-4e92-b023-f56a5ca5fe97","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Creation and Tracking[2m > [22m[2mshould create separate sessions for multiple device logins
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249734917,"env":"test","module":"email-queue","jobId":"aba7277b-37fb-401d-b544-1f07fcde6e28","to":"protected-test-soIb1xG8qD5s9OuOKC22T@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249734975,"env":"test","module":"auth-routes","userId":"b65f4de3-8b77-4ff0-8d4a-d8e61ad9187d","email":"protected-test-soIb1xG8qD5s9OuOKC22T@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPOST Protected Routes[2m > [22m[2mshould reject POST with invalid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249735342,"env":"test","module":"auth-routes","userId":"e8dcc543-a295-4e92-b023-f56a5ca5fe97","msg":"User logged in successfully"}
{"level":30,"time":1768249735395,"env":"test","module":"audit-log-service","userId":"e8dcc543-a295-4e92-b023-f56a5ca5fe97","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Creation and Tracking[2m > [22m[2mshould create separate sessions for multiple device logins
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249735579,"env":"test","module":"auth-routes","userId":"b65f4de3-8b77-4ff0-8d4a-d8e61ad9187d","msg":"User logged in successfully"}
{"level":30,"time":1768249735628,"env":"test","module":"audit-log-service","userId":"b65f4de3-8b77-4ff0-8d4a-d8e61ad9187d","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768249735632,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249735864,"env":"test","module":"auth-routes","userId":"e8dcc543-a295-4e92-b023-f56a5ca5fe97","msg":"User logged in successfully"}
{"level":30,"time":1768249735914,"env":"test","module":"audit-log-service","userId":"e8dcc543-a295-4e92-b023-f56a5ca5fe97","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249735991,"env":"test","module":"user-credentials-repository","userId":"5e771743-9eb3-40cf-b9e8-810bb1d92737","msg":"User credentials created"}
{"level":30,"time":1768249736088,"env":"test","module":"email-queue","jobId":"522b3564-0674-4624-b291-ce0c8ca5611d","to":"protected-test-e_YPJ6QKlwJpek4Wkv6Rc@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249736135,"env":"test","module":"auth-routes","userId":"5e771743-9eb3-40cf-b9e8-810bb1d92737","email":"protected-test-e_YPJ6QKlwJpek4Wkv6Rc@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPUT Protected Routes[2m > [22m[2mshould allow PUT with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249736324,"env":"test","module":"user-credentials-repository","userId":"c959ded7-70f0-4730-8955-beb3b924b922","msg":"User credentials created"}
{"level":30,"time":1768249736426,"env":"test","module":"email-queue","jobId":"3c2d7c58-98dc-4c92-9438-954fdf4e6f77","to":"session-test-5Fc2537NZA5w9IL3DdFhd@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249736473,"env":"test","module":"auth-routes","userId":"c959ded7-70f0-4730-8955-beb3b924b922","email":"session-test-5Fc2537NZA5w9IL3DdFhd@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249736737,"env":"test","module":"auth-routes","userId":"5e771743-9eb3-40cf-b9e8-810bb1d92737","msg":"User logged in successfully"}
{"level":30,"time":1768249736783,"env":"test","module":"audit-log-service","userId":"5e771743-9eb3-40cf-b9e8-810bb1d92737","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249737053,"env":"test","module":"auth-routes","userId":"c959ded7-70f0-4730-8955-beb3b924b922","msg":"User logged in successfully"}
{"level":30,"time":1768249737101,"env":"test","module":"audit-log-service","userId":"c959ded7-70f0-4730-8955-beb3b924b922","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249737348,"env":"test","module":"user-credentials-repository","userId":"4402258b-d3f1-47f9-ac43-5b2d7a0df687","msg":"User credentials created"}
{"level":30,"time":1768249737440,"env":"test","module":"email-queue","jobId":"e497a37a-0b98-4066-8b01-501abbfbcd1f","to":"protected-test-fewOmGG9rDXNQIsWVKU9j@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249737500,"env":"test","module":"auth-routes","userId":"4402258b-d3f1-47f9-ac43-5b2d7a0df687","email":"protected-test-fewOmGG9rDXNQIsWVKU9j@example.com","msg":"User registered"}
{"level":30,"time":1768249737555,"env":"test","module":"auth-routes","userId":"c959ded7-70f0-4730-8955-beb3b924b922","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPUT Protected Routes[2m > [22m[2mshould reject PUT without Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249737604,"env":"test","module":"audit-log-service","userId":"c959ded7-70f0-4730-8955-beb3b924b922","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould list all active sessions for user
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249738069,"env":"test","module":"auth-routes","userId":"c959ded7-70f0-4730-8955-beb3b924b922","msg":"User logged in successfully"}
{"level":30,"time":1768249738103,"env":"test","module":"auth-routes","userId":"4402258b-d3f1-47f9-ac43-5b2d7a0df687","msg":"User logged in successfully"}
{"level":30,"time":1768249738126,"env":"test","module":"audit-log-service","userId":"c959ded7-70f0-4730-8955-beb3b924b922","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249738152,"env":"test","module":"audit-log-service","userId":"4402258b-d3f1-47f9-ac43-5b2d7a0df687","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768249738155,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249738232,"env":"test","module":"auth-routes","userId":"c959ded7-70f0-4730-8955-beb3b924b922","sessionCount":3,"msg":"Listed active sessions"}
{"level":30,"time":1768249738521,"env":"test","module":"user-credentials-repository","userId":"fcf2b6de-cfde-4c58-8c50-911fe02357f8","msg":"User credentials created"}
{"level":30,"time":1768249738597,"env":"test","module":"user-credentials-repository","userId":"bfb8df50-aeb8-48bd-843e-f7d6d3e582f1","msg":"User credentials created"}
{"level":30,"time":1768249738617,"env":"test","module":"email-queue","jobId":"f2900791-a24d-46b8-bc86-876bc2145fd8","to":"protected-test-7nCHAnl7rHc03QZy7elkX@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249738662,"env":"test","module":"auth-routes","userId":"fcf2b6de-cfde-4c58-8c50-911fe02357f8","email":"protected-test-7nCHAnl7rHc03QZy7elkX@example.com","msg":"User registered"}
{"level":30,"time":1768249738689,"env":"test","module":"email-queue","jobId":"b16b005c-3f3d-4671-94a8-fd45c7c04505","to":"session-test-iqVfSKiqYBK182TFIknww@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249738738,"env":"test","module":"auth-routes","userId":"bfb8df50-aeb8-48bd-843e-f7d6d3e582f1","email":"session-test-iqVfSKiqYBK182TFIknww@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mDELETE Protected Routes[2m > [22m[2mshould allow DELETE with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould mark current session correctly
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249739279,"env":"test","module":"auth-routes","userId":"fcf2b6de-cfde-4c58-8c50-911fe02357f8","msg":"User logged in successfully"}
{"level":30,"time":1768249739294,"env":"test","module":"auth-routes","userId":"bfb8df50-aeb8-48bd-843e-f7d6d3e582f1","msg":"User logged in successfully"}
{"level":30,"time":1768249739327,"env":"test","module":"audit-log-service","userId":"fcf2b6de-cfde-4c58-8c50-911fe02357f8","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249739343,"env":"test","module":"audit-log-service","userId":"bfb8df50-aeb8-48bd-843e-f7d6d3e582f1","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould mark current session correctly
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249739797,"env":"test","module":"auth-routes","userId":"bfb8df50-aeb8-48bd-843e-f7d6d3e582f1","msg":"User logged in successfully"}
{"level":30,"time":1768249739844,"env":"test","module":"audit-log-service","userId":"bfb8df50-aeb8-48bd-843e-f7d6d3e582f1","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249739849,"env":"test","module":"user-credentials-repository","userId":"0f000b60-235c-4053-abcc-0a4ea0845d0f","msg":"User credentials created"}
{"level":30,"time":1768249739950,"env":"test","module":"auth-routes","userId":"bfb8df50-aeb8-48bd-843e-f7d6d3e582f1","sessionCount":2,"msg":"Listed active sessions"}
{"level":30,"time":1768249739957,"env":"test","module":"email-queue","jobId":"c342784b-ae16-48b4-9cfd-b84a465543ec","to":"protected-test---oP9HMN6afWo5KUhMBYf@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249740009,"env":"test","module":"auth-routes","userId":"0f000b60-235c-4053-abcc-0a4ea0845d0f","email":"protected-test---oP9HMN6afWo5KUhMBYf@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mDELETE Protected Routes[2m > [22m[2mshould reject DELETE without Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249740309,"env":"test","module":"user-credentials-repository","userId":"dc5a793b-14b4-41e5-b9e0-c1d9feb4670e","msg":"User credentials created"}
{"level":30,"time":1768249740403,"env":"test","module":"email-queue","jobId":"e60f9cd3-268b-45c7-a1ce-ece5104f85ac","to":"session-test-i7GxkwzowYrHzbogx--1o@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249740453,"env":"test","module":"auth-routes","userId":"dc5a793b-14b4-41e5-b9e0-c1d9feb4670e","email":"session-test-i7GxkwzowYrHzbogx--1o@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould not include revoked sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249740614,"env":"test","module":"auth-routes","userId":"0f000b60-235c-4053-abcc-0a4ea0845d0f","msg":"User logged in successfully"}
{"level":30,"time":1768249740660,"env":"test","module":"audit-log-service","userId":"0f000b60-235c-4053-abcc-0a4ea0845d0f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768249740663,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249741006,"env":"test","module":"auth-routes","userId":"dc5a793b-14b4-41e5-b9e0-c1d9feb4670e","msg":"User logged in successfully"}
{"level":30,"time":1768249741019,"env":"test","module":"user-credentials-repository","userId":"160aa5eb-fed1-42f8-bb1f-8ee8673bc448","msg":"User credentials created"}
{"level":30,"time":1768249741054,"env":"test","module":"audit-log-service","userId":"dc5a793b-14b4-41e5-b9e0-c1d9feb4670e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould not include revoked sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249741115,"env":"test","module":"email-queue","jobId":"a4a1de7c-7b84-47f9-b6e0-e33079a4433c","to":"protected-test-Qdwg5RpvpJZLLvgYNNDBL@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249741168,"env":"test","module":"auth-routes","userId":"160aa5eb-fed1-42f8-bb1f-8ee8673bc448","email":"protected-test-Qdwg5RpvpJZLLvgYNNDBL@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPATCH Protected Routes[2m > [22m[2mshould allow PATCH with valid Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249741516,"env":"test","module":"auth-routes","userId":"dc5a793b-14b4-41e5-b9e0-c1d9feb4670e","msg":"User logged in successfully"}
{"level":30,"time":1768249741570,"env":"test","module":"audit-log-service","userId":"dc5a793b-14b4-41e5-b9e0-c1d9feb4670e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249741679,"env":"test","module":"auth-routes","userId":"dc5a793b-14b4-41e5-b9e0-c1d9feb4670e","sessionCount":2,"msg":"Listed active sessions"}
{"level":30,"time":1768249741787,"env":"test","module":"auth-routes","userId":"160aa5eb-fed1-42f8-bb1f-8ee8673bc448","msg":"User logged in successfully"}
{"level":30,"time":1768249741835,"env":"test","module":"auth-routes","userId":"dc5a793b-14b4-41e5-b9e0-c1d9feb4670e","sessionId":"c8bce6c3-e157-49db-85c6-6f2af6595aca","msg":"Session revoked"}
{"level":30,"time":1768249741842,"env":"test","module":"audit-log-service","userId":"160aa5eb-fed1-42f8-bb1f-8ee8673bc448","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249741939,"env":"test","module":"auth-routes","userId":"dc5a793b-14b4-41e5-b9e0-c1d9feb4670e","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768249742300,"env":"test","module":"user-credentials-repository","userId":"fda7be67-89b1-46ae-bc9f-09cf8761c10c","msg":"User credentials created"}
{"level":30,"time":1768249742403,"env":"test","module":"email-queue","jobId":"df6bfb2e-f571-456a-b298-fa23883efcb3","to":"session-test-PeM0CoWZTRNVaB6PCoJ2s@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249742451,"env":"test","module":"auth-routes","userId":"fda7be67-89b1-46ae-bc9f-09cf8761c10c","email":"session-test-PeM0CoWZTRNVaB6PCoJ2s@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249742850,"env":"test","module":"user-credentials-repository","userId":"905e5030-8162-4a15-a186-fc9a073b0749","msg":"User credentials created"}
{"level":30,"time":1768249742946,"env":"test","module":"email-queue","jobId":"cf8ae82a-2fef-4784-9773-7c2ddee98159","to":"protected-test-ZG8VTDuIgeL-D9u7pL0NW@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249742993,"env":"test","module":"auth-routes","userId":"905e5030-8162-4a15-a186-fc9a073b0749","email":"protected-test-ZG8VTDuIgeL-D9u7pL0NW@example.com","msg":"User registered"}
{"level":30,"time":1768249743013,"env":"test","module":"auth-routes","userId":"fda7be67-89b1-46ae-bc9f-09cf8761c10c","msg":"User logged in successfully"}
{"level":30,"time":1768249743062,"env":"test","module":"audit-log-service","userId":"fda7be67-89b1-46ae-bc9f-09cf8761c10c","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mPATCH Protected Routes[2m > [22m[2mshould reject PATCH without Bearer token
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249743594,"env":"test","module":"auth-routes","userId":"905e5030-8162-4a15-a186-fc9a073b0749","msg":"User logged in successfully"}
{"level":30,"time":1768249743618,"env":"test","module":"auth-routes","userId":"fda7be67-89b1-46ae-bc9f-09cf8761c10c","msg":"User logged in successfully"}
{"level":30,"time":1768249743640,"env":"test","module":"audit-log-service","userId":"905e5030-8162-4a15-a186-fc9a073b0749","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768249743643,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249743666,"env":"test","module":"audit-log-service","userId":"fda7be67-89b1-46ae-bc9f-09cf8761c10c","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mGET /api/auth/sessions[2m > [22m[2mshould order sessions by last used (most recent first)
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249743999,"env":"test","module":"user-credentials-repository","userId":"4bd1e4a7-3c7f-4ed2-b7f8-f0306c3be9de","msg":"User credentials created"}
{"level":30,"time":1768249744094,"env":"test","module":"email-queue","jobId":"3dfddfb5-cee0-44c5-8156-ff1a62fd6a8b","to":"protected-test-YTLf99_-w9spBMxJrvKOD@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249744143,"env":"test","module":"auth-routes","userId":"4bd1e4a7-3c7f-4ed2-b7f8-f0306c3be9de","email":"protected-test-YTLf99_-w9spBMxJrvKOD@example.com","msg":"User registered"}
{"level":30,"time":1768249744214,"env":"test","module":"auth-routes","userId":"fda7be67-89b1-46ae-bc9f-09cf8761c10c","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle Bearer token with extra spaces
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249744260,"env":"test","module":"audit-log-service","userId":"fda7be67-89b1-46ae-bc9f-09cf8761c10c","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249744356,"env":"test","module":"auth-routes","userId":"fda7be67-89b1-46ae-bc9f-09cf8761c10c","sessionCount":3,"msg":"Listed active sessions"}
{"level":30,"time":1768249744729,"env":"test","module":"user-credentials-repository","userId":"a9dd95a9-3ff8-4660-9cbd-a35b086883ac","msg":"User credentials created"}
{"level":30,"time":1768249744742,"env":"test","module":"auth-routes","userId":"4bd1e4a7-3c7f-4ed2-b7f8-f0306c3be9de","msg":"User logged in successfully"}
{"level":30,"time":1768249744793,"env":"test","module":"audit-log-service","userId":"4bd1e4a7-3c7f-4ed2-b7f8-f0306c3be9de","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768249744798,"env":"test","module":"auth-middleware","error":{"name":"InvalidTokenError","code":"AUTH_003","statusCode":401,"isOperational":true},"msg":"JWT Strategy verification failed"}
{"level":50,"time":1768249744798,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249744822,"env":"test","module":"email-queue","jobId":"d9373654-3390-4519-9424-04a6e78695b3","to":"session-test-wwSWiJM6dYAe9zSp5dHhL@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249744873,"env":"test","module":"auth-routes","userId":"a9dd95a9-3ff8-4660-9cbd-a35b086883ac","email":"session-test-wwSWiJM6dYAe9zSp5dHhL@example.com","msg":"User registered"}
{"level":50,"time":1768249744971,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249745154,"env":"test","module":"user-credentials-repository","userId":"c91109e6-045d-49f9-a660-8e6d05de4a72","msg":"User credentials created"}
{"level":30,"time":1768249745249,"env":"test","module":"email-queue","jobId":"658594e0-7068-4fc7-8772-2d2035c8d07f","to":"protected-test-l-zJCJVL9gpsx6ceoz9RN@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249745297,"env":"test","module":"auth-routes","userId":"c91109e6-045d-49f9-a660-8e6d05de4a72","email":"protected-test-l-zJCJVL9gpsx6ceoz9RN@example.com","msg":"User registered"}
{"level":30,"time":1768249745333,"env":"test","module":"user-credentials-repository","userId":"87aa4ad8-ab45-4ff9-b280-d1174b4c1dd7","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle very long invalid token
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249745433,"env":"test","module":"email-queue","jobId":"c1f4bd10-c003-4aff-acb2-ea9a5a5c5caf","to":"session-test-CVCfMmVJl99PBIxW6VdwM@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249745486,"env":"test","module":"auth-routes","userId":"87aa4ad8-ab45-4ff9-b280-d1174b4c1dd7","email":"session-test-CVCfMmVJl99PBIxW6VdwM@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249745901,"env":"test","module":"auth-routes","userId":"c91109e6-045d-49f9-a660-8e6d05de4a72","msg":"User logged in successfully"}
{"level":30,"time":1768249745949,"env":"test","module":"audit-log-service","userId":"c91109e6-045d-49f9-a660-8e6d05de4a72","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768249745952,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249746059,"env":"test","module":"auth-routes","userId":"87aa4ad8-ab45-4ff9-b280-d1174b4c1dd7","msg":"User logged in successfully"}
{"level":30,"time":1768249746107,"env":"test","module":"audit-log-service","userId":"87aa4ad8-ab45-4ff9-b280-d1174b4c1dd7","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould revoke specific session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249746309,"env":"test","module":"user-credentials-repository","userId":"b93af74b-6738-4511-b197-70a9a160afe5","msg":"User credentials created"}
{"level":30,"time":1768249746407,"env":"test","module":"email-queue","jobId":"c1d527f9-50eb-454d-9da3-c9bec4b53356","to":"protected-test-xgxVYBi4Xm4ov__L3oz0K@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249746454,"env":"test","module":"auth-routes","userId":"b93af74b-6738-4511-b197-70a9a160afe5","email":"protected-test-xgxVYBi4Xm4ov__L3oz0K@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle empty Authorization header
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249746568,"env":"test","module":"auth-routes","userId":"87aa4ad8-ab45-4ff9-b280-d1174b4c1dd7","msg":"User logged in successfully"}
{"level":30,"time":1768249746617,"env":"test","module":"audit-log-service","userId":"87aa4ad8-ab45-4ff9-b280-d1174b4c1dd7","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249746717,"env":"test","module":"auth-routes","userId":"87aa4ad8-ab45-4ff9-b280-d1174b4c1dd7","sessionCount":2,"msg":"Listed active sessions"}
{"level":30,"time":1768249746862,"env":"test","module":"auth-routes","userId":"87aa4ad8-ab45-4ff9-b280-d1174b4c1dd7","sessionId":"d5dc310a-74ad-47fe-b618-c9b3307fde59","msg":"Session revoked"}
{"level":30,"time":1768249746865,"env":"test","module":"auth-service","tokenHash":"c8437db5c21ef0e1425cbd5642c75de27979c78842b3634a80e36e044dfefec5","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768249746910,"env":"test","module":"auth-service","userId":"87aa4ad8-ab45-4ff9-b280-d1174b4c1dd7","tokenHash":"c8437db5c21ef0e1425cbd5642c75de27979c78842b3634a80e36e044dfefec5","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768249747052,"env":"test","module":"auth-routes","userId":"b93af74b-6738-4511-b197-70a9a160afe5","msg":"User logged in successfully"}
{"level":30,"time":1768249747114,"env":"test","module":"audit-log-service","userId":"b93af74b-6738-4511-b197-70a9a160afe5","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768249747118,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249747316,"env":"test","module":"user-credentials-repository","userId":"6adfdd60-8e7c-40e7-802c-adba9146b759","msg":"User credentials created"}
{"level":30,"time":1768249747410,"env":"test","module":"email-queue","jobId":"55039db0-ed17-4ad0-a97e-d2e8ad1f5f23","to":"session-test-Al_W9XEVe0C-sOZkXd9SG@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249747456,"env":"test","module":"auth-routes","userId":"6adfdd60-8e7c-40e7-802c-adba9146b759","email":"session-test-Al_W9XEVe0C-sOZkXd9SG@example.com","msg":"User registered"}
{"level":30,"time":1768249747476,"env":"test","module":"user-credentials-repository","userId":"96d67dd2-ed58-4fe2-9838-6bde243abb50","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould prevent revoking current session
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249747568,"env":"test","module":"email-queue","jobId":"86cbab4a-9d1d-4154-bd3d-7eeaafe7465d","to":"protected-test-wLqJP7RUDhqPa6fPcBBAt@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249747615,"env":"test","module":"auth-routes","userId":"96d67dd2-ed58-4fe2-9838-6bde243abb50","email":"protected-test-wLqJP7RUDhqPa6fPcBBAt@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle Authorization header with only Bearer
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249748016,"env":"test","module":"auth-routes","userId":"6adfdd60-8e7c-40e7-802c-adba9146b759","msg":"User logged in successfully"}
{"level":30,"time":1768249748065,"env":"test","module":"audit-log-service","userId":"6adfdd60-8e7c-40e7-802c-adba9146b759","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249748164,"env":"test","module":"auth-routes","userId":"6adfdd60-8e7c-40e7-802c-adba9146b759","sessionCount":1,"msg":"Listed active sessions"}
{"level":30,"time":1768249748219,"env":"test","module":"auth-routes","userId":"96d67dd2-ed58-4fe2-9838-6bde243abb50","msg":"User logged in successfully"}
{"level":30,"time":1768249748272,"env":"test","module":"audit-log-service","userId":"96d67dd2-ed58-4fe2-9838-6bde243abb50","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768249748275,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249748627,"env":"test","module":"user-credentials-repository","userId":"45eea697-20c0-44ce-b8b9-725a6d59ff9a","msg":"User credentials created"}
{"level":30,"time":1768249748641,"env":"test","module":"user-credentials-repository","userId":"c9cbfb4f-2c0a-483a-a99c-592445473552","msg":"User credentials created"}
{"level":30,"time":1768249748724,"env":"test","module":"email-queue","jobId":"cd65b4da-86d7-42ff-b504-a3a496cd6b4f","to":"session-test-Gx5PgtguBGST2HmTopOLS@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249748734,"env":"test","module":"email-queue","jobId":"075a3ff6-4783-4914-99e3-023596d5bd38","to":"protected-test-4hN-xG0Hv9vSubUP9QeVG@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249748770,"env":"test","module":"auth-routes","userId":"45eea697-20c0-44ce-b8b9-725a6d59ff9a","email":"session-test-Gx5PgtguBGST2HmTopOLS@example.com","msg":"User registered"}
{"level":30,"time":1768249748781,"env":"test","module":"auth-routes","userId":"c9cbfb4f-2c0a-483a-a99c-592445473552","email":"protected-test-4hN-xG0Hv9vSubUP9QeVG@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould handle multiple Authorization headers
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249749220,"env":"test","module":"user-credentials-repository","userId":"ac94043d-7999-4ea0-8748-63685dfeb1f2","msg":"User credentials created"}
{"level":30,"time":1768249749313,"env":"test","module":"email-queue","jobId":"95fd9399-45fa-460b-9be1-6214136c6ce6","to":"user2-VtZuy0tGvSAQBHvQyraLc@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249749361,"env":"test","module":"auth-routes","userId":"ac94043d-7999-4ea0-8748-63685dfeb1f2","email":"user2-VtZuy0tGvSAQBHvQyraLc@example.com","msg":"User registered"}
{"level":30,"time":1768249749375,"env":"test","module":"auth-routes","userId":"c9cbfb4f-2c0a-483a-a99c-592445473552","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould not allow revoking other users sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249749422,"env":"test","module":"audit-log-service","userId":"c9cbfb4f-2c0a-483a-a99c-592445473552","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768249749424,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249749789,"env":"test","module":"user-credentials-repository","userId":"db0e9dbf-f04d-4467-be58-b9658c1ab83a","msg":"User credentials created"}
{"level":30,"time":1768249749861,"env":"test","module":"auth-routes","userId":"ac94043d-7999-4ea0-8748-63685dfeb1f2","msg":"User logged in successfully"}
{"level":30,"time":1768249749889,"env":"test","module":"email-queue","jobId":"3b43189e-6822-4dd4-b57f-a9a5eebb62af","to":"protected-test-RpkkAOeyk8ijRlvp6w9ZP@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249749908,"env":"test","module":"audit-log-service","userId":"ac94043d-7999-4ea0-8748-63685dfeb1f2","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249749937,"env":"test","module":"auth-routes","userId":"db0e9dbf-f04d-4467-be58-b9658c1ab83a","email":"protected-test-RpkkAOeyk8ijRlvp6w9ZP@example.com","msg":"User registered"}
{"level":30,"time":1768249750003,"env":"test","module":"auth-routes","userId":"ac94043d-7999-4ea0-8748-63685dfeb1f2","sessionCount":2,"msg":"Listed active sessions"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould not allow revoking other users sessions
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould reject token with SQL injection attempt
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249750459,"env":"test","module":"auth-routes","userId":"45eea697-20c0-44ce-b8b9-725a6d59ff9a","msg":"User logged in successfully"}
{"level":30,"time":1768249750507,"env":"test","module":"audit-log-service","userId":"45eea697-20c0-44ce-b8b9-725a6d59ff9a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249750539,"env":"test","module":"auth-routes","userId":"db0e9dbf-f04d-4467-be58-b9658c1ab83a","msg":"User logged in successfully"}
{"level":30,"time":1768249750600,"env":"test","module":"audit-log-service","userId":"db0e9dbf-f04d-4467-be58-b9658c1ab83a","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768249750603,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249750976,"env":"test","module":"user-credentials-repository","userId":"0169ac5c-c9c4-4b98-8de0-1bb96286dc82","msg":"User credentials created"}
{"level":30,"time":1768249750986,"env":"test","module":"user-credentials-repository","userId":"17bc9fee-7857-4d04-9e05-5323c80a269c","msg":"User credentials created"}
{"level":30,"time":1768249751075,"env":"test","module":"email-queue","jobId":"8b7a5bdf-6c05-4d80-843b-d78a4af7a040","to":"session-test-Cspol9-6uBSrfL-pLXA4l@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249751087,"env":"test","module":"email-queue","jobId":"43c2116c-aa2e-44b7-bd87-02c9708e6def","to":"protected-test-BmybzoeaFNIRFRk2dzOyt@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249751122,"env":"test","module":"auth-routes","userId":"0169ac5c-c9c4-4b98-8de0-1bb96286dc82","email":"session-test-Cspol9-6uBSrfL-pLXA4l@example.com","msg":"User registered"}
{"level":30,"time":1768249751134,"env":"test","module":"auth-routes","userId":"17bc9fee-7857-4d04-9e05-5323c80a269c","email":"protected-test-BmybzoeaFNIRFRk2dzOyt@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/:sessionId[2m > [22m[2mshould return 404 for non-existent session ID
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Edge Cases[2m > [22m[2mshould reject token with XSS attempt
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249751672,"env":"test","module":"auth-routes","userId":"0169ac5c-c9c4-4b98-8de0-1bb96286dc82","msg":"User logged in successfully"}
{"level":30,"time":1768249751720,"env":"test","module":"audit-log-service","userId":"0169ac5c-c9c4-4b98-8de0-1bb96286dc82","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249751737,"env":"test","module":"auth-routes","userId":"17bc9fee-7857-4d04-9e05-5323c80a269c","msg":"User logged in successfully"}
{"level":30,"time":1768249751784,"env":"test","module":"audit-log-service","userId":"17bc9fee-7857-4d04-9e05-5323c80a269c","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":50,"time":1768249751787,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249752136,"env":"test","module":"user-credentials-repository","userId":"52394f9e-fbb7-4caa-a181-fff6b155bb70","msg":"User credentials created"}
{"level":30,"time":1768249752150,"env":"test","module":"user-credentials-repository","userId":"225b7dab-cb0f-43b0-8e0d-7416fb951dca","msg":"User credentials created"}
{"level":30,"time":1768249752238,"env":"test","module":"email-queue","jobId":"1b7f86e2-9d6f-4f93-8ca4-8de89826d91c","to":"session-test-6cJtIlYbVXnJQpRh6a54G@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249752243,"env":"test","module":"email-queue","jobId":"1c0e5631-1d71-422c-b511-21864efce4b5","to":"protected-test-t6cRMzMsAeR5QrzKWuGpc@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249752285,"env":"test","module":"auth-routes","userId":"52394f9e-fbb7-4caa-a181-fff6b155bb70","email":"session-test-6cJtIlYbVXnJQpRh6a54G@example.com","msg":"User registered"}
{"level":30,"time":1768249752291,"env":"test","module":"auth-routes","userId":"225b7dab-cb0f-43b0-8e0d-7416fb951dca","email":"protected-test-t6cRMzMsAeR5QrzKWuGpc@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all sessions except current
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Payload Validation[2m > [22m[2mshould reject token with missing userId
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249752850,"env":"test","module":"auth-routes","userId":"52394f9e-fbb7-4caa-a181-fff6b155bb70","msg":"User logged in successfully"}
{"level":30,"time":1768249752885,"env":"test","module":"auth-routes","userId":"225b7dab-cb0f-43b0-8e0d-7416fb951dca","msg":"User logged in successfully"}
{"level":30,"time":1768249752897,"env":"test","module":"audit-log-service","userId":"52394f9e-fbb7-4caa-a181-fff6b155bb70","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all sessions except current
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249752933,"env":"test","module":"audit-log-service","userId":"225b7dab-cb0f-43b0-8e0d-7416fb951dca","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249753310,"env":"test","module":"user-credentials-repository","userId":"4c374475-2823-4537-839e-e84ea2748edd","msg":"User credentials created"}
{"level":30,"time":1768249753351,"env":"test","module":"auth-routes","userId":"52394f9e-fbb7-4caa-a181-fff6b155bb70","msg":"User logged in successfully"}
{"level":30,"time":1768249753398,"env":"test","module":"audit-log-service","userId":"52394f9e-fbb7-4caa-a181-fff6b155bb70","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all sessions except current
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249753407,"env":"test","module":"email-queue","jobId":"6a0e2505-4d63-41d9-88b6-8c72296ac9d7","to":"protected-test-4HCjXCJf_assvvsQLVQyP@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249753457,"env":"test","module":"auth-routes","userId":"4c374475-2823-4537-839e-e84ea2748edd","email":"protected-test-4HCjXCJf_assvvsQLVQyP@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mToken Payload Validation[2m > [22m[2mshould reject token with non-existent userId
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249753854,"env":"test","module":"auth-routes","userId":"52394f9e-fbb7-4caa-a181-fff6b155bb70","msg":"User logged in successfully"}
{"level":30,"time":1768249753902,"env":"test","module":"audit-log-service","userId":"52394f9e-fbb7-4caa-a181-fff6b155bb70","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249754048,"env":"test","module":"auth-routes","userId":"4c374475-2823-4537-839e-e84ea2748edd","msg":"User logged in successfully"}
{"level":30,"time":1768249754061,"env":"test","module":"auth-routes","userId":"52394f9e-fbb7-4caa-a181-fff6b155bb70","msg":"All other sessions revoked"}
{"level":30,"time":1768249754094,"env":"test","module":"audit-log-service","userId":"4c374475-2823-4537-839e-e84ea2748edd","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249754107,"env":"test","module":"audit-log-service","userId":"52394f9e-fbb7-4caa-a181-fff6b155bb70","eventType":"all_sessions_revoked","ipAddress":"::1","hasMetadata":false,"msg":"Security event logged"}
{"level":30,"time":1768249754110,"env":"test","module":"auth-service","tokenHash":"ba2c19c332e3e44b809bb636f654e737bdfc318be2a4f413b50d57dc7f074215","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768249754310,"env":"test","module":"auth-service","tokenHash":"7ecb0585de391ec517667059db329b7cd512b6d201a466fd27e7b50f8fe1a2e5","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768249754360,"env":"test","module":"auth-service","userId":"52394f9e-fbb7-4caa-a181-fff6b155bb70","tokenHash":"7ecb0585de391ec517667059db329b7cd512b6d201a466fd27e7b50f8fe1a2e5","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768249754410,"env":"test","module":"auth-service","tokenHash":"9b413d82f3a82b278aa700aff5d1b3db2ff7f868ae0e5141e9cb4edf386c024b","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768249754455,"env":"test","module":"auth-service","userId":"52394f9e-fbb7-4caa-a181-fff6b155bb70","tokenHash":"9b413d82f3a82b278aa700aff5d1b3db2ff7f868ae0e5141e9cb4edf386c024b","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768249754561,"env":"test","module":"user-credentials-repository","userId":"1dab9c94-4955-459a-b5e9-4a75c67c8d86","msg":"User credentials created"}
{"level":30,"time":1768249754656,"env":"test","module":"email-queue","jobId":"c0bd4ccf-aba6-4f42-be7d-1dee018f2179","to":"protected-test-IPGwIWTewIruEsDiTk3jk@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249754702,"env":"test","module":"auth-routes","userId":"1dab9c94-4955-459a-b5e9-4a75c67c8d86","email":"protected-test-IPGwIWTewIruEsDiTk3jk@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mCross-User Authorization[2m > [22m[2mshould not allow user to access another user's resources
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249754882,"env":"test","module":"user-credentials-repository","userId":"753087a3-73da-42f7-a2a3-1b5b4fad0b43","msg":"User credentials created"}
{"level":30,"time":1768249754997,"env":"test","module":"email-queue","jobId":"b191f660-c7e4-45d0-bf55-2c5153de455e","to":"session-test-wraL81AIcNCOl3A9AtRpz@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249755044,"env":"test","module":"auth-routes","userId":"753087a3-73da-42f7-a2a3-1b5b4fad0b43","email":"session-test-wraL81AIcNCOl3A9AtRpz@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mDELETE /api/auth/sessions/all[2m > [22m[2mshould revoke all trusted devices
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249755304,"env":"test","module":"auth-routes","userId":"1dab9c94-4955-459a-b5e9-4a75c67c8d86","msg":"User logged in successfully"}
{"level":30,"time":1768249755352,"env":"test","module":"audit-log-service","userId":"1dab9c94-4955-459a-b5e9-4a75c67c8d86","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249755593,"env":"test","module":"auth-routes","userId":"753087a3-73da-42f7-a2a3-1b5b4fad0b43","msg":"User logged in successfully"}
{"level":30,"time":1768249755640,"env":"test","module":"audit-log-service","userId":"753087a3-73da-42f7-a2a3-1b5b4fad0b43","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249755718,"env":"test","module":"user-credentials-repository","userId":"eff84a14-0a45-4239-9b34-5eef2d139617","msg":"User credentials created"}
{"level":30,"time":1768249755787,"env":"test","module":"auth-routes","userId":"753087a3-73da-42f7-a2a3-1b5b4fad0b43","deviceFingerprint":"377ad01217b8c93ca52518d515505c47ab7553fab66d6fddaa60af67802c5a4c","msg":"Device marked as trusted"}
{"level":30,"time":1768249755810,"env":"test","module":"email-queue","jobId":"bb593635-6b81-41ce-97c5-d61fa9d544ce","to":"user2-xTDnRcjLHPAokv8Wr9WFA@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249755858,"env":"test","module":"auth-routes","userId":"eff84a14-0a45-4239-9b34-5eef2d139617","email":"user2-xTDnRcjLHPAokv8Wr9WFA@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mCross-User Authorization[2m > [22m[2mshould not allow user to access another user's resources
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249755928,"env":"test","module":"auth-routes","userId":"753087a3-73da-42f7-a2a3-1b5b4fad0b43","msg":"All other sessions revoked"}
{"level":30,"time":1768249755978,"env":"test","module":"audit-log-service","userId":"753087a3-73da-42f7-a2a3-1b5b4fad0b43","eventType":"all_sessions_revoked","ipAddress":"::1","hasMetadata":false,"msg":"Security event logged"}
{"level":30,"time":1768249756080,"env":"test","module":"auth-routes","userId":"753087a3-73da-42f7-a2a3-1b5b4fad0b43","deviceCount":0,"msg":"Listed trusted devices"}
{"level":30,"time":1768249756406,"env":"test","module":"auth-routes","userId":"eff84a14-0a45-4239-9b34-5eef2d139617","msg":"User logged in successfully"}
{"level":30,"time":1768249756437,"env":"test","module":"user-credentials-repository","userId":"2ce41dc1-e5d1-4bf5-9328-4310c1a4900b","msg":"User credentials created"}
{"level":30,"time":1768249756453,"env":"test","module":"audit-log-service","userId":"eff84a14-0a45-4239-9b34-5eef2d139617","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":40,"time":1768249756508,"env":"test","module":"rbac-middleware","userId":"eff84a14-0a45-4239-9b34-5eef2d139617","userRole":"viewer","permission":"project:delete","path":"/49dfef8c-a78f-4122-8084-f57ab8dc765e","msg":"Permission denied"}
{"level":30,"time":1768249756532,"env":"test","module":"email-queue","jobId":"e6763d2b-902d-4c4d-abb5-9146787b9832","to":"session-test-amDmP-tF34VU3oR_W-gvp@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249756578,"env":"test","module":"auth-routes","userId":"2ce41dc1-e5d1-4bf5-9328-4310c1a4900b","email":"session-test-amDmP-tF34VU3oR_W-gvp@example.com","msg":"User registered"}
{"level":50,"time":1768249756674,"env":"test","module":"auth-middleware","error":{"name":"UnauthorizedError","code":"AUTH_008","statusCode":401,"isOperational":true},"msg":"Hybrid auth error"}
{"level":30,"time":1768249756863,"env":"test","module":"user-credentials-repository","userId":"28ad6d2b-f6bc-4948-851f-d73e20efe65f","msg":"User credentials created"}
{"level":30,"time":1768249756960,"env":"test","module":"email-queue","jobId":"086ba891-81d4-4a7f-91a6-fe18bbc38164","to":"protected-test-eHyJX4qnFay5DU30VyH51@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249757007,"env":"test","module":"auth-routes","userId":"28ad6d2b-f6bc-4948-851f-d73e20efe65f","email":"protected-test-eHyJX4qnFay5DU30VyH51@example.com","msg":"User registered"}
{"level":30,"time":1768249757028,"env":"test","module":"user-credentials-repository","userId":"d9889ef6-1cc9-4afb-a97d-ec51288ac767","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mUser Context Injection[2m > [22m[2mshould inject userId into request context
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249757128,"env":"test","module":"email-queue","jobId":"3f76a47c-23a1-4eaa-9e87-4543a2afe7a5","to":"session-test-evqCOyQ8FHLCCAOy2NsBJ@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249757176,"env":"test","module":"auth-routes","userId":"d9889ef6-1cc9-4afb-a97d-ec51288ac767","email":"session-test-evqCOyQ8FHLCCAOy2NsBJ@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mSession Expiration[2m > [22m[2mshould reject refresh token after 30 days
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249757609,"env":"test","module":"auth-routes","userId":"28ad6d2b-f6bc-4948-851f-d73e20efe65f","msg":"User logged in successfully"}
{"level":30,"time":1768249757656,"env":"test","module":"audit-log-service","userId":"28ad6d2b-f6bc-4948-851f-d73e20efe65f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249757729,"env":"test","module":"auth-routes","userId":"d9889ef6-1cc9-4afb-a97d-ec51288ac767","msg":"User logged in successfully"}
{"level":30,"time":1768249757777,"env":"test","module":"audit-log-service","userId":"d9889ef6-1cc9-4afb-a97d-ec51288ac767","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249757875,"env":"test","module":"auth-service","tokenHash":"c9b55a57d78674c2d3d0b058b2098c79de023326db0d897fa55ca7cddf0ce3b2","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768249757922,"env":"test","module":"auth-service","userId":"d9889ef6-1cc9-4afb-a97d-ec51288ac767","msg":"Security: Expired refresh token used"}
{"level":30,"time":1768249758064,"env":"test","module":"user-credentials-repository","userId":"d0d68882-b53c-49d0-b49b-4a318fa63149","msg":"User credentials created"}
{"level":30,"time":1768249758155,"env":"test","module":"email-queue","jobId":"b028c5ba-6fd9-46ba-835f-2060ad5f1a8b","to":"protected-test-vEkBluMVHIrHlHbbzHP1B@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249758200,"env":"test","module":"auth-routes","userId":"d0d68882-b53c-49d0-b49b-4a318fa63149","email":"protected-test-vEkBluMVHIrHlHbbzHP1B@example.com","msg":"User registered"}
{"level":30,"time":1768249758284,"env":"test","module":"user-credentials-repository","userId":"73fb3624-6b31-4cd7-81a0-d22fc2d86c99","msg":"User credentials created"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mUser Context Injection[2m > [22m[2mshould inject tenantId into request context
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249758383,"env":"test","module":"email-queue","jobId":"ee88fb37-2dc2-44ac-9383-b07e36427d9f","to":"session-test-LC7Umrw0BmpbImgyRDn9N@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249758429,"env":"test","module":"auth-routes","userId":"73fb3624-6b31-4cd7-81a0-d22fc2d86c99","email":"session-test-LC7Umrw0BmpbImgyRDn9N@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mConcurrent Session Handling[2m > [22m[2mshould handle multiple concurrent logins
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mConcurrent Session Handling[2m > [22m[2mshould handle multiple concurrent logins
[22m[39mDEBUG: LOGIN HANDLER HIT

[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mConcurrent Session Handling[2m > [22m[2mshould handle multiple concurrent logins
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249758792,"env":"test","module":"auth-routes","userId":"d0d68882-b53c-49d0-b49b-4a318fa63149","msg":"User logged in successfully"}
{"level":30,"time":1768249758842,"env":"test","module":"audit-log-service","userId":"d0d68882-b53c-49d0-b49b-4a318fa63149","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249758974,"env":"test","module":"auth-routes","userId":"73fb3624-6b31-4cd7-81a0-d22fc2d86c99","msg":"User logged in successfully"}
{"level":30,"time":1768249759025,"env":"test","module":"audit-log-service","userId":"73fb3624-6b31-4cd7-81a0-d22fc2d86c99","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249759265,"env":"test","module":"user-credentials-repository","userId":"99a288fe-5ea0-455c-bc45-97edd659df9f","msg":"User credentials created"}
{"level":30,"time":1768249759295,"env":"test","module":"auth-routes","userId":"73fb3624-6b31-4cd7-81a0-d22fc2d86c99","msg":"User logged in successfully"}
{"level":30,"time":1768249759323,"env":"test","module":"auth-routes","userId":"73fb3624-6b31-4cd7-81a0-d22fc2d86c99","msg":"User logged in successfully"}
{"level":30,"time":1768249759343,"env":"test","module":"audit-log-service","userId":"73fb3624-6b31-4cd7-81a0-d22fc2d86c99","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249759358,"env":"test","module":"email-queue","jobId":"341dd72f-02e0-495b-abae-54b128198be8","to":"protected-test-tkFBNK96IA5OP7-a3Y3ln@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249759375,"env":"test","module":"audit-log-service","userId":"73fb3624-6b31-4cd7-81a0-d22fc2d86c99","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249759404,"env":"test","module":"auth-routes","userId":"99a288fe-5ea0-455c-bc45-97edd659df9f","email":"protected-test-tkFBNK96IA5OP7-a3Y3ln@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mUser Context Injection[2m > [22m[2mshould inject role into request context
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249759791,"env":"test","module":"user-credentials-repository","userId":"114eafdf-0152-4846-862b-66af30ce9fd1","msg":"User credentials created"}
{"level":30,"time":1768249759886,"env":"test","module":"email-queue","jobId":"767fcc70-208f-4a23-8d6b-bc9637d86180","to":"session-test-Y8E8SRZ6LD3sl6SMNQvo5@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249759936,"env":"test","module":"auth-routes","userId":"114eafdf-0152-4846-862b-66af30ce9fd1","email":"session-test-Y8E8SRZ6LD3sl6SMNQvo5@example.com","msg":"User registered"}
{"level":30,"time":1768249760003,"env":"test","module":"auth-routes","userId":"99a288fe-5ea0-455c-bc45-97edd659df9f","msg":"User logged in successfully"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts[2m > [22m[2mSession Management Integration Tests[2m > [22m[2mConcurrent Session Handling[2m > [22m[2mshould handle concurrent token refreshes
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249760052,"env":"test","module":"audit-log-service","userId":"99a288fe-5ea0-455c-bc45-97edd659df9f","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249760462,"env":"test","module":"user-credentials-repository","userId":"2d0a15c8-6a45-46d4-b293-37064e4d6dc8","msg":"User credentials created"}
{"level":30,"time":1768249760491,"env":"test","module":"auth-routes","userId":"114eafdf-0152-4846-862b-66af30ce9fd1","msg":"User logged in successfully"}
{"level":30,"time":1768249760544,"env":"test","module":"audit-log-service","userId":"114eafdf-0152-4846-862b-66af30ce9fd1","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249760547,"env":"test","module":"auth-service","tokenHash":"a640cf0466ba42ad9c3f4d334221b753f1cbca3aa632c0548d6dc81521da3c06","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":30,"time":1768249760555,"env":"test","module":"email-queue","jobId":"ad0eb8e6-cfab-44ac-8d62-05301b7fa327","to":"protected-test-LgZReanj1ua5Xg-hAme3t@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249760600,"env":"test","module":"auth-routes","userId":"2d0a15c8-6a45-46d4-b293-37064e4d6dc8","email":"protected-test-LgZReanj1ua5Xg-hAme3t@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mRate Limiting on Protected Routes[2m > [22m[2mshould not apply general rate limiting to authenticated requests
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249760745,"env":"test","module":"auth-service","tokenHash":"a640cf0466ba42ad9c3f4d334221b753f1cbca3aa632c0548d6dc81521da3c06","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768249760790,"env":"test","module":"auth-service","userId":"114eafdf-0152-4846-862b-66af30ce9fd1","tokenHash":"a640cf0466ba42ad9c3f4d334221b753f1cbca3aa632c0548d6dc81521da3c06","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768249760845,"env":"test","module":"auth-service","tokenHash":"7b3c1e649f264dbb5c68cff8cfcf70d64f0ce77e41ec596ea6c6320f7f959f27","plainTokenLen":80,"msg":"DEBUG: rotateRefreshToken called"}
{"level":40,"time":1768249760893,"env":"test","module":"auth-service","userId":"114eafdf-0152-4846-862b-66af30ce9fd1","tokenHash":"7b3c1e649f264dbb5c68cff8cfcf70d64f0ce77e41ec596ea6c6320f7f959f27","msg":"Security: REUSED REFRESH TOKEN DETECTED. Revoking all sessions."}
{"level":30,"time":1768249761194,"env":"test","module":"auth-routes","userId":"2d0a15c8-6a45-46d4-b293-37064e4d6dc8","msg":"User logged in successfully"}
{"level":30,"time":1768249761200,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768249761200,"env":"test","msg":"DB: pool closed."}
{"level":30,"time":1768249761240,"env":"test","module":"audit-log-service","userId":"2d0a15c8-6a45-46d4-b293-37064e4d6dc8","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/session.management.integration.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w1_bfb03b2a

 [32mÎ“Â£Ã´[39m tests/integration/auth/session.management.integration.test.ts [2m([22m[2m18 tests[22m[2m)[22m[33m 45140[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should create refresh token on login [33m 1209[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should track device metadata in session [33m 1187[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should create separate sessions for multiple device logins [33m 2229[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should list all active sessions for user [33m 2272[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should mark current session correctly [33m 1717[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not include revoked sessions [33m 1989[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should order sessions by last used (most recent first) [33m 2417[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require authentication [33m 615[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke specific session [33m 1987[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prevent revoking current session [33m 1307[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not allow revoking other users sessions [33m 2337[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should return 404 for non-existent session ID [33m 1174[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke all sessions except current [33m 2737[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should revoke all trusted devices [33m 1567[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should require active session [33m 593[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject refresh token after 30 days [33m 1249[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle multiple concurrent logins [33m 1501[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle concurrent token refreshes [33m 1516[2mms[22m[39m
{"level":30,"time":1768249762027,"env":"test","module":"user-credentials-repository","userId":"d2761124-f855-4b13-9855-c0b7e1a57398","msg":"User credentials created"}
{"level":30,"time":1768249762119,"env":"test","module":"email-queue","jobId":"7cdd8e3a-b786-41f8-be2c-7dfcf50e7a9a","to":"protected-test-Kbt5oaPqI8cFy9pHi47IY@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249762167,"env":"test","module":"auth-routes","userId":"d2761124-f855-4b13-9855-c0b7e1a57398","email":"protected-test-Kbt5oaPqI8cFy9pHi47IY@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mMixed Auth Scenarios[2m > [22m[2mshould handle request with both Bearer token and cookies
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249762765,"env":"test","module":"auth-routes","userId":"d2761124-f855-4b13-9855-c0b7e1a57398","msg":"User logged in successfully"}
{"level":30,"time":1768249762812,"env":"test","module":"audit-log-service","userId":"d2761124-f855-4b13-9855-c0b7e1a57398","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mMixed Auth Scenarios[2m > [22m[2mshould handle request with both Bearer token and cookies
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249763306,"env":"test","module":"auth-routes","userId":"d2761124-f855-4b13-9855-c0b7e1a57398","msg":"User logged in successfully"}
{"level":30,"time":1768249763355,"env":"test","module":"audit-log-service","userId":"d2761124-f855-4b13-9855-c0b7e1a57398","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249763784,"env":"test","module":"user-credentials-repository","userId":"22e8b4a7-f27d-4e90-8ee9-0378fd60a13b","msg":"User credentials created"}
{"level":30,"time":1768249763878,"env":"test","module":"email-queue","jobId":"fea93fa0-d022-4fae-9725-11a98c7cfe4f","to":"protected-test-k1Z_EmokK40JMePjfiNe1@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249763925,"env":"test","module":"auth-routes","userId":"22e8b4a7-f27d-4e90-8ee9-0378fd60a13b","email":"protected-test-k1Z_EmokK40JMePjfiNe1@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mMixed Auth Scenarios[2m > [22m[2mshould prioritize Bearer token over cookie when both present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249764512,"env":"test","module":"auth-routes","userId":"22e8b4a7-f27d-4e90-8ee9-0378fd60a13b","msg":"User logged in successfully"}
{"level":30,"time":1768249764558,"env":"test","module":"audit-log-service","userId":"22e8b4a7-f27d-4e90-8ee9-0378fd60a13b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mMixed Auth Scenarios[2m > [22m[2mshould prioritize Bearer token over cookie when both present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249765050,"env":"test","module":"auth-routes","userId":"22e8b4a7-f27d-4e90-8ee9-0378fd60a13b","msg":"User logged in successfully"}
{"level":30,"time":1768249765096,"env":"test","module":"audit-log-service","userId":"22e8b4a7-f27d-4e90-8ee9-0378fd60a13b","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249765452,"env":"test","module":"user-credentials-repository","userId":"f13d5a58-3ef6-48be-aeee-9383d79537ac","msg":"User credentials created"}
{"level":30,"time":1768249765556,"env":"test","module":"email-queue","jobId":"49cac716-51e1-4224-809e-60f0b0cdad67","to":"user2-6AZFf4SjZwvDjNvzVcTh_@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249765602,"env":"test","module":"auth-routes","userId":"f13d5a58-3ef6-48be-aeee-9383d79537ac","email":"user2-6AZFf4SjZwvDjNvzVcTh_@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mMixed Auth Scenarios[2m > [22m[2mshould prioritize Bearer token over cookie when both present
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249766087,"env":"test","module":"auth-routes","userId":"f13d5a58-3ef6-48be-aeee-9383d79537ac","msg":"User logged in successfully"}
{"level":30,"time":1768249766132,"env":"test","module":"audit-log-service","userId":"f13d5a58-3ef6-48be-aeee-9383d79537ac","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249766578,"env":"test","module":"user-credentials-repository","userId":"fb861bcd-67ee-4fb8-a25a-104e4b554d19","msg":"User credentials created"}
{"level":30,"time":1768249766673,"env":"test","module":"email-queue","jobId":"ead5cd73-f186-4c41-a715-4d33ab71b1e7","to":"protected-test-1GA2PnSoqpBEhKBzXhfpo@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249766720,"env":"test","module":"auth-routes","userId":"fb861bcd-67ee-4fb8-a25a-104e4b554d19","email":"protected-test-1GA2PnSoqpBEhKBzXhfpo@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mOptional Auth Routes[2m > [22m[2mshould allow unauthenticated access to optional auth routes
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249767335,"env":"test","module":"auth-routes","userId":"fb861bcd-67ee-4fb8-a25a-104e4b554d19","msg":"User logged in successfully"}
{"level":30,"time":1768249767380,"env":"test","module":"audit-log-service","userId":"fb861bcd-67ee-4fb8-a25a-104e4b554d19","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249767881,"env":"test","module":"intake-service","runId":"c1988d39-c638-4c16-8b90-bd68f44a68f5","slug":"public-alAfhiHPtv-_TGjQkE-Z4","msg":"Created intake run"}
{"level":30,"time":1768249768281,"env":"test","module":"user-credentials-repository","userId":"345c9572-de6a-4dd5-a186-dc1c9928f86e","msg":"User credentials created"}
{"level":30,"time":1768249768374,"env":"test","module":"email-queue","jobId":"ebc0fc82-33da-4312-b02a-d539e17a16a5","to":"protected-test-UC7oz1KOM6aRFv4znR3Pr@example.com","subject":"Verify Your Email - ezBuildr","msg":"Email added to queue"}
{"level":30,"time":1768249768419,"env":"test","module":"auth-routes","userId":"345c9572-de6a-4dd5-a186-dc1c9928f86e","email":"protected-test-UC7oz1KOM6aRFv4znR3Pr@example.com","msg":"User registered"}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts[2m > [22m[2mProtected Routes Integration Tests[2m > [22m[2mOptional Auth Routes[2m > [22m[2mshould enhance optional auth routes with user context when authenticated
[22m[39mDEBUG: LOGIN HANDLER HIT

{"level":30,"time":1768249769010,"env":"test","module":"auth-routes","userId":"345c9572-de6a-4dd5-a186-dc1c9928f86e","msg":"User logged in successfully"}
{"level":30,"time":1768249769056,"env":"test","module":"audit-log-service","userId":"345c9572-de6a-4dd5-a186-dc1c9928f86e","eventType":"login_success","ipAddress":"::1","hasMetadata":true,"msg":"Security event logged"}
{"level":30,"time":1768249769544,"env":"test","module":"intake-service","runId":"8258a259-ccb2-4573-893d-f8d3e08ee645","slug":"optional-msWXbFJdIFv14lTmSskMQ","userId":"345c9572-de6a-4dd5-a186-dc1c9928f86e","msg":"Created intake run"}
{"level":30,"time":1768249770043,"env":"test","msg":"DB: closing pool..."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39mâ‰¡Æ’Âºâ•£ Cleaning up test environment...

{"level":30,"time":1768249770043,"env":"test","msg":"DB: pool closed."}
[90mstdout[2m | tests/integration/auth/protected.routes.test.ts
[22m[39m[SchemaManager] Dropping isolated schema: test_schema_w0_17923f56

 [32mÎ“Â£Ã´[39m tests/integration/auth/protected.routes.test.ts [2m([22m[2m33 tests[22m[2m | [22m[33m1 skipped[39m[2m)[22m[33m 54158[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow access with valid Bearer token [33m 1224[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject access without Authorization header [33m 1174[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject access with empty Bearer token [33m 1166[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject access with malformed Authorization header [33m 1173[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject access with wrong token type [33m 1156[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow POST with valid Bearer token [33m 1226[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject POST without Bearer token [33m 1178[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject POST with invalid token [33m 1181[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow PUT with valid Bearer token [33m 1352[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject PUT without Bearer token [33m 1171[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow DELETE with valid Bearer token [33m 1330[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject DELETE without Bearer token [33m 1177[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow PATCH with valid Bearer token [33m 1828[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject PATCH without Bearer token [33m 1153[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle Bearer token with extra spaces [33m 1155[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle very long invalid token [33m 1154[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle empty Authorization header [33m 1166[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle Authorization header with only Bearer [33m 1157[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle multiple Authorization headers [33m 1150[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject token with SQL injection attempt [33m 1178[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject token with XSS attempt [33m 1184[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject token with missing userId [33m 1150[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should reject token with non-existent userId [33m 1260[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not allow user to access another user's resources [33m 2311[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should inject userId into request context [33m 1198[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should inject tenantId into request context [33m 1187[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should inject role into request context [33m 1209[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should not apply general rate limiting to authenticated requests [33m 1558[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should handle request with both Bearer token and cookies [33m 1746[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should prioritize Bearer token over cookie when both present [33m 2817[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should allow unauthenticated access to optional auth routes [33m 1701[2mms[22m[39m
       [33m[2mÎ“Â£Ã´[22m[39m should enhance optional auth routes with user context when authenticated [33m 1716[2mms[22m[39m

[2m Test Files [22m [1m[32m2 passed[39m[22m[90m (2)[39m
[2m      Tests [22m [1m[32m50 passed[39m[22m[2m | [22m[33m1 skipped[39m[90m (51)[39m
[2m   Start at [22m 14:28:29
[2m   Duration [22m 61.68s[2m (transform 5.99s, setup 311ms, import 13.84s, tests 99.30s, environment 0ms)[22m

