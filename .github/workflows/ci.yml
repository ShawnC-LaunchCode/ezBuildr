name: Test and Deploy

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    name: Test (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    env:
      NODE_ENV: test
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      SESSION_SECRET: ${{ secrets.SESSION_SECRET }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      # Cache node_modules for faster installs
      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-${{ matrix.node-version }}-npm-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-${{ matrix.node-version }}-npm-

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci

      - name: Verify environment variables
        run: |
          echo "üîç Checking environment variables..."
          if [ -z "$DATABASE_URL" ]; then
            echo "‚ùå ERROR: DATABASE_URL is not set"
            echo "Please configure DATABASE_URL secret in GitHub repository settings"
            exit 1
          else
            echo "‚úÖ DATABASE_URL is configured"
          fi
          echo "‚úÖ NODE_ENV: $NODE_ENV"
          echo "‚úÖ GOOGLE_CLIENT_ID: $([ -n "$GOOGLE_CLIENT_ID" ] && echo 'SET' || echo 'NOT SET')"
          echo "‚úÖ SESSION_SECRET: $([ -n "$SESSION_SECRET" ] && echo 'SET' || echo 'NOT SET')"

      - name: Run type checking
        run: npm run check

      - name: Run unit tests (parallel)
        run: npm run test:unit

      - name: Run integration tests (sequential)
        run: npm run test:integration

      - name: Build project
        run: npm run build
        env:
          # Provide minimal env vars needed for build
          NODE_ENV: production
          VITE_GOOGLE_CLIENT_ID: ${{ secrets.VITE_GOOGLE_CLIENT_ID || 'mock-client-id' }}

  test-coverage:
    name: Test Coverage
    runs-on: ubuntu-latest

    env:
      NODE_ENV: test
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      SESSION_SECRET: ${{ secrets.SESSION_SECRET }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      # Cache node_modules for faster installs
      - name: Cache node_modules
        uses: actions/cache@v4
        id: npm-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-node-20.x-npm-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-20.x-npm-

      - name: Install dependencies
        if: steps.npm-cache.outputs.cache-hit != 'true'
        run: npm ci

      - name: Verify environment variables
        run: |
          echo "üîç Checking environment variables..."
          if [ -z "$DATABASE_URL" ]; then
            echo "‚ùå ERROR: DATABASE_URL is not set"
            echo "Please configure DATABASE_URL secret in GitHub repository settings"
            exit 1
          else
            echo "‚úÖ DATABASE_URL is configured"
          fi
          echo "‚úÖ NODE_ENV: $NODE_ENV"
          echo "‚úÖ GOOGLE_CLIENT_ID: $([ -n "$GOOGLE_CLIENT_ID" ] && echo 'SET' || echo 'NOT SET')"
          echo "‚úÖ SESSION_SECRET: $([ -n "$SESSION_SECRET" ] && echo 'SET' || echo 'NOT SET')"

      - name: Run tests with coverage
        id: vitest
        continue-on-error: true
        run: |
          npm run test:coverage -- --reporter=default --reporter=json --outputFile=vitest-summary.json

      - name: Extract coverage summary
        if: always()
        run: |
          # Vitest generates coverage-summary.json automatically with v8 provider
          # Create coverage-summary.txt for artifacts
          if [ -f "coverage/coverage-summary.json" ]; then
            echo "‚úì Coverage file generated"
            cat coverage/coverage-summary.json | head -20
            # Create text summary for artifact upload
            echo "Coverage Summary" > coverage-summary.txt
            cat coverage/coverage-summary.json >> coverage-summary.txt
          else
            echo "‚ö†Ô∏è  No coverage file found"
            echo "No coverage data generated" > coverage-summary.txt
          fi

      - name: Upload coverage summary artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-summary
          path: |
            coverage-summary.txt
            coverage/coverage-summary.json
          retention-days: 1

      - name: Upload Vitest JSON summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vitest-summary
          path: vitest-summary.json
          retention-days: 1
          if-no-files-found: warn

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v4
        if: success()
        continue-on-error: true
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          verbose: true

      - name: Fail if tests failed
        if: steps.vitest.outcome == 'failure'
        run: |
          echo "Tests failed - marking job as failed"
          exit 1

  # E2E Tests (Playwright) - Disabled in CI
  # Run e2e tests locally with: npm run test:e2e
  # Uncomment this job to enable e2e tests in CI
  test-e2e:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
  #
    env:
      NODE_ENV: test
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      VITE_GOOGLE_CLIENT_ID: ${{ secrets.VITE_GOOGLE_CLIENT_ID }}
      SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
  #
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Verify environment variables
        run: |
          echo "üîç Checking environment variables..."
          echo "DATABASE_URL set: $( [ -n "$DATABASE_URL" ] && echo 'YES' || echo 'NO' )"
          echo "GOOGLE_CLIENT_ID set: $( [ -n "$GOOGLE_CLIENT_ID" ] && echo 'YES' || echo 'NO' )"
          echo "SESSION_SECRET set: $( [ -n "$SESSION_SECRET" ] && echo 'YES' || echo 'NO' )"
          echo "NODE_ENV: $NODE_ENV"

      - name: Run E2E tests
        id: playwright
        continue-on-error: true
        run: npm run test:e2e

      - name: Copy Playwright JSON results
        if: always()
        run: |
          # Playwright outputs JSON to test-results/results.json (configured in playwright.config.ts)
          echo "üìÇ Checking for Playwright results..."
          ls -la test-results/ || echo "No test-results directory"

          if [ -f "test-results/results.json" ]; then
            echo "‚úì Found test-results/results.json"
            echo "üìä Full Playwright JSON:"
            cat test-results/results.json
            echo ""

            # Check if any tests actually ran
            TEST_COUNT=$(jq -r '.stats.expected + .stats.unexpected + .stats.skipped' test-results/results.json)
            echo "üìä Tests found: $TEST_COUNT"

            cp test-results/results.json playwright-summary.json
            echo "‚úì Copied Playwright results to playwright-summary.json"

            # Fail if no tests ran (indicates webserver or other startup failure)
            if [ "$TEST_COUNT" -eq "0" ]; then
              echo "‚ùå ERROR: Playwright ran but executed 0 tests"
              echo "   This usually means the webserver failed to start"
              jq -r '.errors[]?.message // "No error details"' test-results/results.json
              exit 1
            fi
          else
            # Fallback: create empty results if tests didn't run
            echo '{"suites":[],"stats":{"expected":0,"unexpected":0,"skipped":0},"testDidNotRun":true}' > playwright-summary.json
            echo "‚ùå ERROR: No Playwright results found - tests did not run at all"
            exit 1
          fi

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Upload Playwright JSON summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-summary
          path: playwright-summary.json
          retention-days: 1

  notify-slack:
    name: Slack Notification Suite
    needs: [test, test-coverage]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      # Download test and coverage artifacts
      - name: Download Vitest JSON summary
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: vitest-summary
          path: ./

      - name: Download coverage reports
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: coverage-summary
          path: ./

      # Download previous data for delta calculation
      - name: Download previous coverage
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: coverage-for-next-run
          path: ./

      - name: Download previous test results
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: test-results-for-next-run
          path: ./

      # Parse test results
      - name: Parse test results
        if: always()
        run: |
          node scripts/ci/parse-test-results.js \
            --vitest-json vitest-summary.json \
            --output test-results-parsed.json

      # Parse coverage data
      - name: Parse coverage
        if: always()
        run: |
          node scripts/ci/parse-coverage.js \
            --coverage-json coverage/coverage-summary.json \
            --output coverage-parsed.json

      # Compute coverage delta
      - name: Compute coverage delta
        if: always()
        run: |
          node scripts/ci/compute-coverage-delta.js \
            --current coverage-parsed.json \
            --previous coverage-for-next-run.json \
            --output coverage-delta.json

      # Detect new test failures
      - name: Detect new failures
        if: always()
        run: |
          node scripts/ci/detect-new-failures.js \
            --current test-results-parsed.json \
            --previous test-results-for-next-run.json \
            --output test-failures-delta.json

      # Get file change statistics
      - name: Get file changes
        if: always()
        run: |
          node scripts/ci/get-file-changes.js \
            --output file-changes.json

      # Generate fix context for Claude Code
      - name: Generate fix context
        if: always()
        run: |
          node scripts/ci/generate-fix-context.js \
            --test-results test-results-parsed.json \
            --failure-delta test-failures-delta.json \
            --file-changes file-changes.json \
            --output fix-context.md

      # Build Slack payload
      - name: Build Slack payload
        if: always()
        run: |
          node scripts/ci/build-slack-payload.js \
            --test-results test-results-parsed.json \
            --coverage coverage-parsed.json \
            --file-changes file-changes.json \
            --coverage-delta coverage-delta.json \
            --failure-delta test-failures-delta.json \
            --output slack-payload.json

      # Save current coverage for next run
      - name: Save coverage for next run
        if: always()
        run: |
          # Copy current coverage to be used by next run for delta calculation
          if [ -f "coverage-parsed.json" ]; then
            cp coverage-parsed.json coverage-for-next-run.json
            echo "‚úì Saved coverage for next run"
          else
            echo '{"statements":{"total":0,"covered":0,"pct":0},"branches":{"total":0,"covered":0,"pct":0},"functions":{"total":0,"covered":0,"pct":0},"lines":{"total":0,"covered":0,"pct":0},"summary":{"pct":0,"color":"gray","emoji":"‚ö™"},"topFiles":{"best":[],"worst":[]}}' > coverage-for-next-run.json
            echo "‚ö†Ô∏è No coverage data, created empty placeholder"
          fi

      # Upload artifacts for next run
      - name: Upload coverage for next run
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-for-next-run
          path: coverage-for-next-run.json
          retention-days: 30

      - name: Upload test results for next run
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-for-next-run
          path: test-results-parsed.json
          retention-days: 30

      - name: Upload fix context
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: fix-context
          path: fix-context.md
          retention-days: 7

      # Post main Slack message
      - name: Post Slack main message
        if: always()
        run: |
          node scripts/ci/post-slack-main.js \
            --payload slack-payload.json \
            --output slack-message.json
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}

      # Post threaded replies
      - name: Post Slack thread replies
        if: always()
        run: |
          node scripts/ci/post-slack-threads.js \
            --payload slack-payload.json \
            --message-info slack-message.json
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
