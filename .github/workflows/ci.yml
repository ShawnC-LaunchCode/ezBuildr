name: Test and Deploy

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    name: Test (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    env:
      NODE_ENV: test
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      SESSION_SECRET: ${{ secrets.SESSION_SECRET }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run type checking
        run: npm run check

      - name: Run unit tests
        run: npm run test:unit

      - name: Run integration tests
        run: npm run test:integration

      - name: Build project
        run: npm run build
        env:
          # Provide minimal env vars needed for build
          NODE_ENV: production
          VITE_GOOGLE_CLIENT_ID: ${{ secrets.VITE_GOOGLE_CLIENT_ID || 'mock-client-id' }}

  test-coverage:
    name: Test Coverage
    runs-on: ubuntu-latest

    env:
      NODE_ENV: test
      DATABASE_URL: ${{ secrets.DATABASE_URL }}
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      SESSION_SECRET: ${{ secrets.SESSION_SECRET }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        id: vitest
        continue-on-error: true
        run: |
          npm run test:coverage -- --reporter=default --reporter=json --outputFile=vitest-summary.json

      - name: Extract coverage summary
        if: always()
        run: |
          npx c8 report --reporter=text-summary > coverage-summary.txt 2>&1 || echo "Coverage: N/A" > coverage-summary.txt
          cat coverage-summary.txt

      - name: Upload coverage summary artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-summary
          path: coverage-summary.txt
          retention-days: 1

      - name: Upload Vitest JSON summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: vitest-summary
          path: vitest-summary.json
          retention-days: 1

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: success()
        continue-on-error: true
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # E2E Tests (Playwright) - Disabled in CI
  # Run e2e tests locally with: npm run test:e2e
  # Uncomment this job to enable e2e tests in CI
  # test-e2e:
  #   name: E2E Tests (Playwright)
  #   runs-on: ubuntu-latest
  #
  #   env:
  #     NODE_ENV: test
  #     DATABASE_URL: ${{ secrets.DATABASE_URL }}
  #     GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
  #     VITE_GOOGLE_CLIENT_ID: ${{ secrets.VITE_GOOGLE_CLIENT_ID }}
  #     SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
  #
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Node.js
  #       uses: actions/setup-node@v4
  #       with:
  #         node-version: 20.x
  #         cache: 'npm'
  #
  #     - name: Install dependencies
  #       run: npm ci
  #
  #     - name: Install Playwright browsers
  #       run: npx playwright install --with-deps
  #
  #     - name: Verify environment variables
  #       run: |
  #         echo "ðŸ” Checking environment variables..."
  #         echo "DATABASE_URL set: $( [ -n "$DATABASE_URL" ] && echo 'YES' || echo 'NO' )"
  #         echo "GOOGLE_CLIENT_ID set: $( [ -n "$GOOGLE_CLIENT_ID" ] && echo 'YES' || echo 'NO' )"
  #         echo "SESSION_SECRET set: $( [ -n "$SESSION_SECRET" ] && echo 'YES' || echo 'NO' )"
  #         echo "NODE_ENV: $NODE_ENV"
  #
  #     - name: Run E2E tests
  #       id: playwright
  #       continue-on-error: true
  #       run: npm run test:e2e
  #
  #     - name: Copy Playwright JSON results
  #       if: always()
  #       run: |
  #         # Playwright outputs JSON to test-results/results.json (configured in playwright.config.ts)
  #         echo "ðŸ“‚ Checking for Playwright results..."
  #         ls -la test-results/ || echo "No test-results directory"
  #
  #         if [ -f "test-results/results.json" ]; then
  #           echo "âœ“ Found test-results/results.json"
  #           echo "ðŸ“Š Full Playwright JSON:"
  #           cat test-results/results.json
  #           echo ""
  #
  #           # Check if any tests actually ran
  #           TEST_COUNT=$(jq -r '.stats.expected + .stats.unexpected + .stats.skipped' test-results/results.json)
  #           echo "ðŸ“Š Tests found: $TEST_COUNT"
  #
  #           cp test-results/results.json playwright-summary.json
  #           echo "âœ“ Copied Playwright results to playwright-summary.json"
  #
  #           # Fail if no tests ran (indicates webserver or other startup failure)
  #           if [ "$TEST_COUNT" -eq "0" ]; then
  #             echo "âŒ ERROR: Playwright ran but executed 0 tests"
  #             echo "   This usually means the webserver failed to start"
  #             jq -r '.errors[]?.message // "No error details"' test-results/results.json
  #             exit 1
  #           fi
  #         else
  #           # Fallback: create empty results if tests didn't run
  #           echo '{"suites":[],"stats":{"expected":0,"unexpected":0,"skipped":0},"testDidNotRun":true}' > playwright-summary.json
  #           echo "âŒ ERROR: No Playwright results found - tests did not run at all"
  #           exit 1
  #         fi
  #
  #     - name: Upload Playwright report
  #       uses: actions/upload-artifact@v4
  #       if: always()
  #       with:
  #         name: playwright-report
  #         path: playwright-report/
  #         retention-days: 30
  #
  #     - name: Upload Playwright JSON summary
  #       if: always()
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: playwright-summary
  #         path: playwright-summary.json
  #         retention-days: 1

  notify-slack:
    name: Slack Notification
    needs: [test, test-coverage]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Download coverage artifact
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: coverage-summary
          path: ./

      - name: Download Vitest JSON summary
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: vitest-summary
          path: ./

      - name: Extract failed test names
        if: always()
        run: |
          # Extract failed Vitest tests
          if [ -f vitest-summary.json ]; then
            jq -r '.testResults[]?.assertionResults[]? | select(.status == "failed") | "- [Vitest] " + .ancestorTitles[0] + " â€º " + .title' vitest-summary.json > failed-tests.txt 2>/dev/null || echo "" > failed-tests.txt
          else
            echo "" > failed-tests.txt
          fi

          echo "Failed tests extracted:"
          cat failed-tests.txt || echo "No failed tests"

      - name: Send Slack notification
        run: npm run slack:test
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          SLACK_CHANNEL_ID: ${{ secrets.SLACK_CHANNEL_ID }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
          GITHUB_SERVER_URL: https://github.com
