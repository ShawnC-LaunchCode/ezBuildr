name: TypeScript Strict Mode Check

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  strict-zones:
    name: Validate Strict Zones
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check TypeScript strict zones
        run: npm run check:strict-zones

      - name: Comment on PR (on failure)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## âŒ TypeScript Strict Mode Check Failed

            Your changes have TypeScript strict mode violations in the strict zones.

            ### What to do:

            1. Run \`npm run check:strict-zones:verbose\` locally to see detailed errors
            2. Fix the type errors (see [TypeScript Strict Mode Migration Guide](../docs/TYPESCRIPT_STRICT_MODE_MIGRATION.md))
            3. Common fixes:
               - Add explicit type annotations
               - Handle null/undefined cases
               - Use type guards for unknown types

            ### Need Help?

            - Review the [migration guide](../docs/TYPESCRIPT_STRICT_MODE_MIGRATION.md)
            - Check [common issues & solutions](../docs/TYPESCRIPT_STRICT_MODE_MIGRATION.md#common-issues--solutions)
            - Ask in #typescript-strict-mode Slack channel`
            })

      - name: Full TypeScript check
        run: npm run check
        continue-on-error: true

  strict-zones-summary:
    name: Strict Zones Summary
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: List strict zones
        run: npm run check:strict-zones:list > strict-zones-summary.txt

      - name: Comment summary on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('strict-zones-summary.txt', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ“‹ TypeScript Strict Zones

            \`\`\`
            ${summary}
            \`\`\`

            All code in these zones must comply with strict TypeScript settings.
            See [TYPESCRIPT_STRICT_MODE_MIGRATION.md](../docs/TYPESCRIPT_STRICT_MODE_MIGRATION.md) for details.`
            })
